var Wf=Object.defineProperty;var Hu=c=>{throw TypeError(c)};var qf=(c,e,t)=>e in c?Wf(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t;var Z=(c,e,t)=>qf(c,typeof e!="symbol"?e+"":e,t),Hd=(c,e,t)=>e.has(c)||Hu("Cannot "+t);var r=(c,e,t)=>(Hd(c,e,"read from private field"),t?t.call(c):e.get(c)),v=(c,e,t)=>e.has(c)?Hu("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(c):e.set(c,t),x=(c,e,t,s)=>(Hd(c,e,"write to private field"),s?s.call(c,t):e.set(c,t),t),w=(c,e,t)=>(Hd(c,e,"access private method"),t);var bt=(c,e,t,s)=>({set _(n){x(c,e,n,t)},get _(){return r(c,e,s)}});import{c as xe,j as i,r as T,F as Dt,U as Yd,S as bp,C as Ja,D as oo,a as Zt,A as Es,b as Rd,d as si,I as vp,e as uu,f as wn,g as hc,h as yp,X as Io,i as wp,L as pu,T as Np,R as zi,k as sd,H as jp,B as Bu,l as Xf,m as Yf,n as Kf,Z as Qf,P as Zf,o as Jf}from"./zap-S11i9ads.js";/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const eg=xe("ArrowDownCircle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 8v8",key:"napkw2"}],["path",{d:"m8 12 4 4 4-4",key:"k98ssh"}]]);/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const tg=xe("Award",[["circle",{cx:"12",cy:"8",r:"6",key:"1vp47v"}],["path",{d:"M15.477 12.89 17 22l-5-3-5 3 1.523-9.11",key:"em7aur"}]]);/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ap=xe("Calendar",[["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",ry:"2",key:"eu3xkr"}],["line",{x1:"16",x2:"16",y1:"2",y2:"6",key:"m3sa8f"}],["line",{x1:"8",x2:"8",y1:"2",y2:"6",key:"18kwsl"}],["line",{x1:"3",x2:"21",y1:"10",y2:"10",key:"xt86sb"}]]);/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const mu=xe("ChevronLeft",[["path",{d:"m15 18-6-6 6-6",key:"1wnfg3"}]]);/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ct=xe("ChevronRight",[["path",{d:"m9 18 6-6-6-6",key:"mthhwq"}]]);/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fu=xe("Copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]);/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const sg=xe("Database",[["ellipse",{cx:"12",cy:"5",rx:"9",ry:"3",key:"msslwz"}],["path",{d:"M3 5V19A9 3 0 0 0 21 19V5",key:"1wlel7"}],["path",{d:"M3 12A9 3 0 0 0 21 12",key:"mv7ke4"}]]);/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ig=xe("EyeOff",[["path",{d:"M9.88 9.88a3 3 0 1 0 4.24 4.24",key:"1jxqfv"}],["path",{d:"M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68",key:"9wicm4"}],["path",{d:"M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61",key:"1jreej"}],["line",{x1:"2",x2:"22",y1:"2",y2:"22",key:"a6p6uj"}]]);/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _p=xe("FileCheck",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"m9 15 2 2 4-4",key:"1grp1n"}]]);/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Sp=xe("Fingerprint",[["path",{d:"M2 12C2 6.5 6.5 2 12 2a10 10 0 0 1 8 4",key:"1jc9o5"}],["path",{d:"M5 19.5C5.5 18 6 15 6 12c0-.7.12-1.37.34-2",key:"1mxgy1"}],["path",{d:"M17.29 21.02c.12-.6.43-2.3.5-3.02",key:"ptglia"}],["path",{d:"M12 10a2 2 0 0 0-2 2c0 1.02-.1 2.51-.26 4",key:"1nerag"}],["path",{d:"M8.65 22c.21-.66.45-1.32.57-2",key:"13wd9y"}],["path",{d:"M14 13.12c0 2.38 0 6.38-1 8.88",key:"o46ks0"}],["path",{d:"M2 16h.01",key:"1gqxmh"}],["path",{d:"M21.8 16c.2-2 .131-5.354 0-6",key:"drycrb"}],["path",{d:"M9 6.8a6 6 0 0 1 9 5.2c0 .47 0 1.17-.02 2",key:"1fgabc"}]]);/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ng=xe("Heart",[["path",{d:"M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z",key:"c3ymky"}]]);/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Cp=xe("Home",[["path",{d:"m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z",key:"y5dka4"}],["polyline",{points:"9 22 9 12 15 12 15 22",key:"e2us08"}]]);/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const zu=xe("ListChecks",[["path",{d:"m3 17 2 2 4-4",key:"1jhpwq"}],["path",{d:"m3 7 2 2 4-4",key:"1obspn"}],["path",{d:"M13 6h8",key:"15sg57"}],["path",{d:"M13 12h8",key:"h98zly"}],["path",{d:"M13 18h8",key:"oe0vm4"}]]);/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ne=xe("Loader2",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]]);/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ag=xe("Mail",[["rect",{width:"20",height:"16",x:"2",y:"4",rx:"2",key:"18n3k1"}],["path",{d:"m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7",key:"1ocrg3"}]]);/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Lo=xe("MessageSquare",[["path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z",key:"1lielz"}]]);/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const rg=xe("MicOff",[["line",{x1:"2",x2:"22",y1:"2",y2:"22",key:"a6p6uj"}],["path",{d:"M18.89 13.23A7.12 7.12 0 0 0 19 12v-2",key:"80xlxr"}],["path",{d:"M5 10v2a7 7 0 0 0 12 5",key:"p2k8kg"}],["path",{d:"M15 9.34V5a3 3 0 0 0-5.68-1.33",key:"1gzdoj"}],["path",{d:"M9 9v3a3 3 0 0 0 5.12 2.12",key:"r2i35w"}],["line",{x1:"12",x2:"12",y1:"19",y2:"22",key:"x3vr5v"}]]);/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const lo=xe("Mic",[["path",{d:"M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z",key:"131961"}],["path",{d:"M19 10v2a7 7 0 0 1-14 0v-2",key:"1vc78b"}],["line",{x1:"12",x2:"12",y1:"19",y2:"22",key:"x3vr5v"}]]);/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const og=xe("Phone",[["path",{d:"M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z",key:"foiqr5"}]]);/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Da=xe("Plus",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]]);/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const lg=xe("Rocket",[["path",{d:"M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z",key:"m3kijz"}],["path",{d:"m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z",key:"1fmvmk"}],["path",{d:"M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0",key:"1f8sc4"}],["path",{d:"M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5",key:"qeys4"}]]);/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const cg=xe("Save",[["path",{d:"M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z",key:"1owoqh"}],["polyline",{points:"17 21 17 13 7 13 7 21",key:"1md35c"}],["polyline",{points:"7 3 7 8 15 8",key:"8nz8an"}]]);/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ti=xe("Search",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["path",{d:"m21 21-4.3-4.3",key:"1qie3q"}]]);/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const dg=xe("Send",[["path",{d:"m22 2-7 20-4-9-9-4Z",key:"1q3vgg"}],["path",{d:"M22 2 11 13",key:"nzbqef"}]]);/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const hg=xe("Server",[["rect",{width:"20",height:"8",x:"2",y:"2",rx:"2",ry:"2",key:"ngkwjq"}],["rect",{width:"20",height:"8",x:"2",y:"14",rx:"2",ry:"2",key:"iecqi9"}],["line",{x1:"6",x2:"6.01",y1:"6",y2:"6",key:"16zg32"}],["line",{x1:"6",x2:"6.01",y1:"18",y2:"18",key:"nzw8ys"}]]);/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const id=xe("ShieldCheck",[["path",{d:"M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10",key:"1irkt0"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]]);/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ac=xe("Sparkles",[["path",{d:"m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z",key:"17u4zn"}],["path",{d:"M5 3v4",key:"bklmnn"}],["path",{d:"M19 17v4",key:"iiml17"}],["path",{d:"M3 5h4",key:"nem4j1"}],["path",{d:"M17 19h4",key:"lbex7p"}]]);/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ug=xe("Star",[["polygon",{points:"12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2",key:"8f66p6"}]]);/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Do=xe("Users",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["path",{d:"M22 21v-2a4 4 0 0 0-3-3.87",key:"kshegd"}],["path",{d:"M16 3.13a4 4 0 0 1 0 7.75",key:"1da9ce"}]]);/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ep=xe("WifiOff",[["line",{x1:"2",x2:"22",y1:"2",y2:"22",key:"a6p6uj"}],["path",{d:"M8.5 16.5a5 5 0 0 1 7 0",key:"sej527"}],["path",{d:"M2 8.82a15 15 0 0 1 4.17-2.65",key:"11utq1"}],["path",{d:"M10.66 5c4.01-.36 8.14.9 11.34 3.76",key:"hxefdu"}],["path",{d:"M16.85 11.25a10 10 0 0 1 2.22 1.68",key:"q734kn"}],["path",{d:"M5 13a10 10 0 0 1 5.24-2.76",key:"piq4yl"}],["line",{x1:"12",x2:"12.01",y1:"20",y2:"20",key:"of4bc4"}]]);/**
 * @license lucide-react v0.312.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pg=xe("Wifi",[["path",{d:"M5 13a10 10 0 0 1 14 0",key:"6v8j51"}],["path",{d:"M8.5 16.5a5 5 0 0 1 7 0",key:"sej527"}],["path",{d:"M2 8.82a15 15 0 0 1 20 0",key:"dnpr2z"}],["line",{x1:"12",x2:"12.01",y1:"20",y2:"20",key:"of4bc4"}]]);function mg(){return window.crypto.getRandomValues(new Uint32Array(1))[0]}function Uu(c,e=!1){const t=mg(),s=`_${t}`;return Object.defineProperty(window,s,{value:n=>(e&&Reflect.deleteProperty(window,s),c==null?void 0:c(n)),writable:!1,configurable:!0}),t}async function Y(c,e={}){return new Promise((t,s)=>{const n=Uu(o=>{t(o),Reflect.deleteProperty(window,`_${a}`)},!0),a=Uu(o=>{s(o),Reflect.deleteProperty(window,`_${n}`)},!0);window.__TAURI_IPC__({cmd:c,callback:n,error:a,...e})})}async function kp(c){return Y("tauri",c)}async function fg(c={}){return typeof c=="object"&&Object.freeze(c),kp({__tauriModule:"Dialog",message:{cmd:"saveDialog",options:c}})}var Gu;(function(c){c[c.Audio=1]="Audio",c[c.Cache=2]="Cache",c[c.Config=3]="Config",c[c.Data=4]="Data",c[c.LocalData=5]="LocalData",c[c.Desktop=6]="Desktop",c[c.Document=7]="Document",c[c.Download=8]="Download",c[c.Executable=9]="Executable",c[c.Font=10]="Font",c[c.Home=11]="Home",c[c.Picture=12]="Picture",c[c.Public=13]="Public",c[c.Runtime=14]="Runtime",c[c.Template=15]="Template",c[c.Video=16]="Video",c[c.Resource=17]="Resource",c[c.App=18]="App",c[c.Log=19]="Log",c[c.Temp=20]="Temp",c[c.AppConfig=21]="AppConfig",c[c.AppData=22]="AppData",c[c.AppLocalData=23]="AppLocalData",c[c.AppCache=24]="AppCache",c[c.AppLog=25]="AppLog"})(Gu||(Gu={}));async function gg(c,e,t){typeof c=="object"&&Object.freeze(c);const s={path:"",contents:[]};let n=t;return typeof c=="string"?s.path=c:(s.path=c.path,s.contents=c.contents),e&&"dir"in e?n=e:typeof c=="string"&&(s.contents=e!=null?e:[]),kp({__tauriModule:"Fs",message:{cmd:"writeFile",path:s.path,contents:Array.from(s.contents instanceof ArrayBuffer?new Uint8Array(s.contents):s.contents),options:n}})}function xg(c){var s,n,a,o,l,d,h,u,p,m,f,g,b,A,N,j,E,_,y;if(c.state===void 0){const C=c.unlocked?"unlocked":c.exists?"ready":"no_vault",R=(s=c.exists)!=null?s:!1,S=(n=c.exists)!=null?n:!1;return{state:C,db_exists:R,keychain_exists:S,dbExists:R,keychainExists:S,message:"",client_count:(o=(a=c.client_count)!=null?a:c.clientCount)!=null?o:null,note_count:(d=(l=c.note_count)!=null?l:c.noteCount)!=null?d:null,exists:(h=c.exists)!=null?h:!1,unlocked:(u=c.unlocked)!=null?u:!1}}const e=(m=(p=c.db_exists)!=null?p:c.dbExists)!=null?m:!1,t=(g=(f=c.keychain_exists)!=null?f:c.keychainExists)!=null?g:!1;return{state:c.state,db_exists:e,keychain_exists:t,dbExists:e,keychainExists:t,message:(b=c.message)!=null?b:"",client_count:(N=(A=c.client_count)!=null?A:c.clientCount)!=null?N:null,note_count:(E=(j=c.note_count)!=null?j:c.noteCount)!=null?E:null,exists:(_=c.exists)!=null?_:!1,unlocked:(y=c.unlocked)!=null?y:!1}}async function bg(c){return Y("create_vault",{passphrase:c})}async function vg(c){return Y("unlock_vault",{passphrase:c})}async function yg(){return Y("lock_vault")}async function Vu(){const c=await Y("vault_status");return xg(c)}async function wg(c){return Y("vault_clear_stale_keychain",{confirm:c})}async function Ng(c){return Y("vault_delete_db",{confirm:c})}async function jg(){return wg(!0)}async function Ag(){return Ng(!0)}async function _g(c){return Y("create_client",{displayName:c})}async function Sg(c){return Y("get_client",{id:c})}async function Cg(){return Y("list_clients")}async function Eg(c){return Y("update_client",{clientJson:JSON.stringify(c)})}async function kg(c,e,t,s){return Y("create_note",{clientId:c,sessionDate:e,noteType:t,content:s})}async function Kd(c){return Y("get_note",{id:c})}async function _c(c){return Y("list_notes",{clientId:c})}async function Tg(c,e){return Y("update_structured_note",{id:c,structuredNote:e})}async function Rg(c,e){return Y("sign_note",{id:c,attestations:e})}async function Pg(c,e){return Y("export_note",{id:c,format:e})}async function Tp(c){return Y("analyze_ethics",{content:c})}async function Mg(){return Y("check_ollama")}const Ig=Mg;async function Lg(c,e,t){return Y("structure_note_ai",{model:c,content:e,noteType:t})}async function Dg(c,e){return Y("transcribe_audio",{audioData:c,sampleRate:e})}async function Fg(c,e,t){return Y("voice_to_structured_note",{transcript:c,noteType:e,model:t})}async function Rp(c,e,t){return Y("search_notes_semantic",{query:c,limit:e,clientId:t})}async function Pp(c,e,t){return Y("rag_query_notes",{question:c,model:e,clientId:t})}async function Og(){return Y("get_search_index_stats")}async function $g(){return Y("reindex_all_notes_for_search")}async function Hg(c,e,t){return Y("validate_attestation",{detectionJson:JSON.stringify(c),response:e,responseNote:t})}async function Bg(c,e){return Y("check_attestation_completeness",{detectionsJson:JSON.stringify(c),attestationsJson:JSON.stringify(e)})}async function zg(c){return Y("get_dashboard_metrics",{days:c})}async function Ug(c){return Y("get_metrics_report",{days:c})}async function Gg(c){return Y("search_clients",{query:c})}async function Mp(c,e){return Y("update_note_content",{noteId:c,content:e})}async function Vg(c,e,t){return Y("amend_note",{noteId:c,amendmentText:e,reason:t})}async function Wg(){return Y("get_voice_status")}async function Ip(c,e,t,s,n,a,o){return Y("record_time_metrics",{noteId:c,clientId:e,startTime:t,endTime:s,method:n,wordCount:a,aiAssisted:o})}async function qg(c,e,t,s,n,a,o){return Y("upload_document",{clientId:c,filename:e,fileType:t,mimeType:s,data:n,description:a,documentDate:o})}async function Xg(c){return Y("list_documents",{clientId:c})}async function Yg(c){return Y("get_document_data",{documentId:c})}async function Kg(c){return Y("delete_document",{documentId:c})}async function Qg(){return Y("get_storage_stats")}async function Zg(){return Y("optimize_database")}async function Jg(c){return Y("process_document_ocr",{documentId:c})}async function ex(){return Y("check_ocr_available")}async function tx(c){return Y("download_whisper_model",{modelName:c})}async function sx(c){return Y("generate_prep_sheet",{clientId:c})}async function ix(c,e){return Y("check_note_completion",{noteId:c,model:e})}async function nx(c,e,t=!0){return Y("export_note_to_file",{noteId:c,format:e,includeHeader:t})}async function ax(c,e,t){return Y("create_trainee",{name:c,email:e,supervisorId:t})}async function rx(c){return Y("get_supervisor_dashboard",{supervisorId:c})}async function ox(c,e=!1){return Y("deidentify_note",{noteId:c,useAi:e})}async function lx(c,e,t=!0){return Y("export_deidentified_case",{noteId:c,format:e,includeAudit:t})}async function cx(c,e,t,s,n){return Y("create_consultation_draft",{noteId:c,title:e,clinicalQuestion:t,specialties:s,urgency:n})}async function dx(){return Y("list_consultation_drafts")}async function hx(c){return Y("delete_consultation_draft",{draftId:c})}async function ux(c){return Y("get_trainee_pending_reviews",{traineeId:c})}async function Lp(c,e,t,s){try{const n=await fg({defaultPath:e,filters:[{name:t,extensions:[s]}]});return n?(await gg(n,new Uint8Array(c)),!0):!1}catch(n){throw console.error("File save error:",n),n}}function Dp({sidebar:c,children:e,sidebarWidth:t="w-64"}){return i.jsxs("div",{className:"min-h-screen flex",children:[i.jsx("div",{className:`${t} bg-slate-800 border-r border-slate-700 flex flex-col`,children:c}),i.jsx("div",{className:"flex-1 overflow-auto",children:e})]})}function Fp({onHome:c,title:e,subtitle:t,showBack:s=!1,onBack:n,actions:a}){return i.jsxs("div",{className:"flex items-center gap-4 mb-6",children:[i.jsx("button",{onClick:c,className:"p-2 bg-slate-700/50 hover:bg-slate-700 rounded-lg transition-colors",title:"Go to Dashboard",children:i.jsx(Cp,{className:"w-5 h-5"})}),s&&n&&i.jsx("button",{onClick:n,className:"p-2 bg-slate-700/50 hover:bg-slate-700 rounded-lg transition-colors",children:i.jsx(mu,{className:"w-5 h-5"})}),e&&i.jsxs("div",{children:[i.jsx("h1",{className:"text-xl font-bold",children:e}),t&&i.jsx("p",{className:"text-sm text-slate-400",children:t})]}),a&&i.jsx("div",{className:"ml-auto flex items-center gap-2",children:a})]})}function Op({icon:c,label:e,isActive:t=!1,badge:s,onClick:n}){return i.jsxs("button",{onClick:n,className:`w-full flex items-center justify-between px-3 py-2 rounded-lg transition-colors ${t?"bg-blue-600 text-white":"text-slate-300 hover:bg-slate-700"}`,children:[i.jsxs("div",{className:"flex items-center gap-2",children:[c,i.jsx("span",{className:"text-sm",children:e})]}),s!==void 0&&i.jsx("span",{className:`px-1.5 py-0.5 rounded-full text-xs font-medium ${t?"bg-white/20":"bg-slate-600"}`,children:s})]})}function Fs({children:c,className:e="",padding:t="md"}){const s={none:"",sm:"p-4",md:"p-6",lg:"p-8"}[t];return i.jsx("div",{className:`bg-slate-800 rounded-xl ${s} ${e}`,children:c})}function Ro({icon:c,value:e,label:t,trend:s,alert:n=!1,onClick:a}){return i.jsxs("button",{onClick:a,className:`bg-slate-800 rounded-xl p-4 hover:bg-slate-700 transition-colors text-left ${n?"border border-amber-500/50":""} ${a?"cursor-pointer":"cursor-default"}`,disabled:!a,children:[i.jsx("div",{className:`mb-2 ${n?"text-amber-400":"text-slate-400"}`,children:c}),i.jsx("div",{className:"text-2xl font-bold text-white",children:e}),i.jsx("div",{className:"text-sm text-slate-400",children:t})]})}function Wu({children:c,variant:e="primary",size:t="md",icon:s,disabled:n=!1,loading:a=!1,onClick:o,className:l=""}){const d={primary:"bg-blue-600 hover:bg-blue-700 text-white",secondary:"bg-slate-700 hover:bg-slate-600 text-white",ghost:"text-slate-400 hover:text-white hover:bg-slate-700",danger:"bg-red-600 hover:bg-red-700 text-white",gradient:"bg-gradient-to-r from-blue-600/20 to-purple-600/20 hover:from-blue-600/30 hover:to-purple-600/30 border border-blue-500/30 text-blue-300"},h={sm:"px-3 py-1.5 text-sm",md:"px-4 py-2",lg:"px-6 py-3 text-lg"};return i.jsxs("button",{onClick:o,disabled:n||a,className:`
        inline-flex items-center justify-center gap-2 rounded-lg font-medium transition-all
        ${d[e]}
        ${h[t]}
        ${n||a?"opacity-50 cursor-not-allowed":""}
        ${l}
      `,children:[a?i.jsx(Ne,{className:"w-4 h-4 animate-spin"}):s,c]})}function qu({children:c,variant:e="default",size:t="sm"}){const s={default:"bg-slate-600 text-slate-300",success:"bg-green-500/20 text-green-400",warning:"bg-yellow-500/20 text-yellow-400",danger:"bg-red-500/20 text-red-400",info:"bg-blue-500/20 text-blue-400",purple:"bg-purple-500/20 text-purple-400",amber:"bg-amber-500/20 text-amber-400"},n={sm:"px-2 py-0.5 text-xs",md:"px-3 py-1 text-sm"};return i.jsx("span",{className:`rounded-full font-medium ${s[e]} ${n[t]}`,children:c})}var Po={};Po.d=(c,e)=>{for(var t in e)Po.o(e,t)&&!Po.o(c,t)&&Object.defineProperty(c,t,{enumerable:!0,get:e[t]})};Po.o=(c,e)=>Object.prototype.hasOwnProperty.call(c,e);var ee=globalThis.pdfjsLib={};Po.d(ee,{AbortException:()=>jn,AnnotationEditorLayer:()=>au,AnnotationEditorParamsType:()=>pe,AnnotationEditorType:()=>ae,AnnotationEditorUIManager:()=>Oa,AnnotationLayer:()=>ob,AnnotationMode:()=>Ui,ColorPicker:()=>cd,DOMSVGFactory:()=>Au,DrawLayer:()=>lu,FeatureTest:()=>At,GlobalWorkerOptions:()=>Ii,ImageKind:()=>Sc,InvalidPDFException:()=>Zd,MissingPDFException:()=>Fo,OPS:()=>fs,OutputScale:()=>eh,PDFDataRangeTransport:()=>Hm,PDFDateString:()=>yu,PDFWorker:()=>tr,PasswordResponses:()=>gx,PermissionFlag:()=>fx,PixelsPerInch:()=>An,RenderingCancelledException:()=>bu,TextLayer:()=>Oo,TouchManager:()=>od,UnexpectedResponseException:()=>nd,Util:()=>X,VerbosityLevel:()=>Pd,XfaLayer:()=>zm,build:()=>B0,createValidAbsoluteUrl:()=>yx,fetchData:()=>Dd,getDocument:()=>P0,getFilenameFromUrl:()=>kx,getPdfFilenameFromUrl:()=>Tx,getXfaPageViewport:()=>Rx,isDataScheme:()=>Fd,isPdfFile:()=>vu,noContextMenu:()=>Ts,normalizeUnicode:()=>Sx,setLayerDimensions:()=>Fa,shadow:()=>de,stopEvent:()=>Qt,version:()=>H0});const ft=typeof process=="object"&&process+""=="[object process]"&&!process.versions.nw&&!(process.versions.electron&&process.type&&process.type!=="browser"),$p=[1,0,0,1,0,0],Qd=[.001,0,0,.001,0,0],px=1e7,Bd=1.35,Yt={ANY:1,DISPLAY:2,PRINT:4,ANNOTATIONS_FORMS:16,ANNOTATIONS_STORAGE:32,ANNOTATIONS_DISABLE:64,IS_EDITING:128,OPLIST:256},Ui={DISABLE:0,ENABLE:1,ENABLE_FORMS:2,ENABLE_STORAGE:3},mx="pdfjs_internal_editor_",ae={DISABLE:-1,NONE:0,FREETEXT:3,HIGHLIGHT:9,STAMP:13,INK:15},pe={RESIZE:1,CREATE:2,FREETEXT_SIZE:11,FREETEXT_COLOR:12,FREETEXT_OPACITY:13,INK_COLOR:21,INK_THICKNESS:22,INK_OPACITY:23,HIGHLIGHT_COLOR:31,HIGHLIGHT_DEFAULT_COLOR:32,HIGHLIGHT_THICKNESS:33,HIGHLIGHT_FREE:34,HIGHLIGHT_SHOW_ALL:35,DRAW_STEP:41},fx={PRINT:4,MODIFY_CONTENTS:8,COPY:16,MODIFY_ANNOTATIONS:32,FILL_INTERACTIVE_FORMS:256,COPY_FOR_ACCESSIBILITY:512,ASSEMBLE:1024,PRINT_HIGH_QUALITY:2048},ot={FILL:0,STROKE:1,FILL_STROKE:2,INVISIBLE:3,FILL_STROKE_MASK:3,ADD_TO_PATH_FLAG:4},Sc={GRAYSCALE_1BPP:1,RGB_24BPP:2,RGBA_32BPP:3},Ge={TEXT:1,LINK:2,FREETEXT:3,LINE:4,SQUARE:5,CIRCLE:6,POLYGON:7,POLYLINE:8,HIGHLIGHT:9,UNDERLINE:10,SQUIGGLY:11,STRIKEOUT:12,STAMP:13,CARET:14,INK:15,POPUP:16,FILEATTACHMENT:17,WIDGET:20},ho={SOLID:1,DASHED:2,BEVELED:3,INSET:4,UNDERLINE:5},Pd={ERRORS:0,WARNINGS:1,INFOS:5},fs={dependency:1,setLineWidth:2,setLineCap:3,setLineJoin:4,setMiterLimit:5,setDash:6,setRenderingIntent:7,setFlatness:8,setGState:9,save:10,restore:11,transform:12,moveTo:13,lineTo:14,curveTo:15,curveTo2:16,curveTo3:17,closePath:18,rectangle:19,stroke:20,closeStroke:21,fill:22,eoFill:23,fillStroke:24,eoFillStroke:25,closeFillStroke:26,closeEOFillStroke:27,endPath:28,clip:29,eoClip:30,beginText:31,endText:32,setCharSpacing:33,setWordSpacing:34,setHScale:35,setLeading:36,setFont:37,setTextRenderingMode:38,setTextRise:39,moveText:40,setLeadingMoveText:41,setTextMatrix:42,nextLine:43,showText:44,showSpacedText:45,nextLineShowText:46,nextLineSetSpacingShowText:47,setCharWidth:48,setCharWidthAndBounds:49,setStrokeColorSpace:50,setFillColorSpace:51,setStrokeColor:52,setStrokeColorN:53,setFillColor:54,setFillColorN:55,setStrokeGray:56,setFillGray:57,setStrokeRGBColor:58,setFillRGBColor:59,setStrokeCMYKColor:60,setFillCMYKColor:61,shadingFill:62,beginInlineImage:63,beginImageData:64,endInlineImage:65,paintXObject:66,markPoint:67,markPointProps:68,beginMarkedContent:69,beginMarkedContentProps:70,endMarkedContent:71,beginCompat:72,endCompat:73,paintFormXObjectBegin:74,paintFormXObjectEnd:75,beginGroup:76,endGroup:77,beginAnnotation:80,endAnnotation:81,paintImageMaskXObject:83,paintImageMaskXObjectGroup:84,paintImageXObject:85,paintInlineImageXObject:86,paintInlineImageXObjectGroup:87,paintImageXObjectRepeat:88,paintImageMaskXObjectRepeat:89,paintSolidColorImageMask:90,constructPath:91,setStrokeTransparent:92,setFillTransparent:93},gx={NEED_PASSWORD:1,INCORRECT_PASSWORD:2};let Md=Pd.WARNINGS;function xx(c){Number.isInteger(c)&&(Md=c)}function bx(){return Md}function Id(c){Md>=Pd.INFOS&&console.log(`Info: ${c}`)}function re(c){Md>=Pd.WARNINGS&&console.log(`Warning: ${c}`)}function Ae(c){throw new Error(c)}function ze(c,e){c||Ae(e)}function vx(c){switch(c==null?void 0:c.protocol){case"http:":case"https:":case"ftp:":case"mailto:":case"tel:":return!0;default:return!1}}function yx(c,e=null,t=null){if(!c)return null;try{if(t&&typeof c=="string"){if(t.addDefaultProtocol&&c.startsWith("www.")){const n=c.match(/\./g);(n==null?void 0:n.length)>=2&&(c=`http://${c}`)}if(t.tryConvertEncoding)try{c=_x(c)}catch{}}const s=e?new URL(c,e):new URL(c);if(vx(s))return s}catch{}return null}function de(c,e,t,s=!1){return Object.defineProperty(c,e,{value:t,enumerable:!s,configurable:!0,writable:!1}),t}const Sn=function(){function e(t,s){this.message=t,this.name=s}return e.prototype=new Error,e.constructor=e,e}();class Xu extends Sn{constructor(e,t){super(e,"PasswordException"),this.code=t}}class zd extends Sn{constructor(e,t){super(e,"UnknownErrorException"),this.details=t}}class Zd extends Sn{constructor(e){super(e,"InvalidPDFException")}}class Fo extends Sn{constructor(e){super(e,"MissingPDFException")}}class nd extends Sn{constructor(e,t){super(e,"UnexpectedResponseException"),this.status=t}}class wx extends Sn{constructor(e){super(e,"FormatError")}}class jn extends Sn{constructor(e){super(e,"AbortException")}}function Hp(c){(typeof c!="object"||(c==null?void 0:c.length)===void 0)&&Ae("Invalid argument for bytesToString");const e=c.length,t=8192;if(e<t)return String.fromCharCode.apply(null,c);const s=[];for(let n=0;n<e;n+=t){const a=Math.min(n+t,e),o=c.subarray(n,a);s.push(String.fromCharCode.apply(null,o))}return s.join("")}function Ld(c){typeof c!="string"&&Ae("Invalid argument for stringToBytes");const e=c.length,t=new Uint8Array(e);for(let s=0;s<e;++s)t[s]=c.charCodeAt(s)&255;return t}function Nx(c){return String.fromCharCode(c>>24&255,c>>16&255,c>>8&255,c&255)}function gu(c){const e=Object.create(null);for(const[t,s]of c)e[t]=s;return e}function jx(){const c=new Uint8Array(4);return c[0]=1,new Uint32Array(c.buffer,0,1)[0]===1}function Ax(){try{return new Function(""),!0}catch{return!1}}class At{static get isLittleEndian(){return de(this,"isLittleEndian",jx())}static get isEvalSupported(){return de(this,"isEvalSupported",Ax())}static get isOffscreenCanvasSupported(){return de(this,"isOffscreenCanvasSupported",typeof OffscreenCanvas<"u")}static get isImageDecoderSupported(){return de(this,"isImageDecoderSupported",typeof ImageDecoder<"u")}static get platform(){return typeof navigator<"u"&&typeof(navigator==null?void 0:navigator.platform)=="string"?de(this,"platform",{isMac:navigator.platform.includes("Mac"),isWindows:navigator.platform.includes("Win"),isFirefox:typeof(navigator==null?void 0:navigator.userAgent)=="string"&&navigator.userAgent.includes("Firefox")}):de(this,"platform",{isMac:!1,isWindows:!1,isFirefox:!1})}static get isCSSRoundSupported(){var e,t;return de(this,"isCSSRoundSupported",(t=(e=globalThis.CSS)==null?void 0:e.supports)==null?void 0:t.call(e,"width: round(1.5px, 1px)"))}}const Ud=Array.from(Array(256).keys(),c=>c.toString(16).padStart(2,"0"));var Li,Cc,Jd;class X{static makeHexColor(e,t,s){return`#${Ud[e]}${Ud[t]}${Ud[s]}`}static scaleMinMax(e,t){let s;e[0]?(e[0]<0&&(s=t[0],t[0]=t[2],t[2]=s),t[0]*=e[0],t[2]*=e[0],e[3]<0&&(s=t[1],t[1]=t[3],t[3]=s),t[1]*=e[3],t[3]*=e[3]):(s=t[0],t[0]=t[1],t[1]=s,s=t[2],t[2]=t[3],t[3]=s,e[1]<0&&(s=t[1],t[1]=t[3],t[3]=s),t[1]*=e[1],t[3]*=e[1],e[2]<0&&(s=t[0],t[0]=t[2],t[2]=s),t[0]*=e[2],t[2]*=e[2]),t[0]+=e[4],t[1]+=e[5],t[2]+=e[4],t[3]+=e[5]}static transform(e,t){return[e[0]*t[0]+e[2]*t[1],e[1]*t[0]+e[3]*t[1],e[0]*t[2]+e[2]*t[3],e[1]*t[2]+e[3]*t[3],e[0]*t[4]+e[2]*t[5]+e[4],e[1]*t[4]+e[3]*t[5]+e[5]]}static applyTransform(e,t){const s=e[0]*t[0]+e[1]*t[2]+t[4],n=e[0]*t[1]+e[1]*t[3]+t[5];return[s,n]}static applyInverseTransform(e,t){const s=t[0]*t[3]-t[1]*t[2],n=(e[0]*t[3]-e[1]*t[2]+t[2]*t[5]-t[4]*t[3])/s,a=(-e[0]*t[1]+e[1]*t[0]+t[4]*t[1]-t[5]*t[0])/s;return[n,a]}static getAxialAlignedBoundingBox(e,t){const s=this.applyTransform(e,t),n=this.applyTransform(e.slice(2,4),t),a=this.applyTransform([e[0],e[3]],t),o=this.applyTransform([e[2],e[1]],t);return[Math.min(s[0],n[0],a[0],o[0]),Math.min(s[1],n[1],a[1],o[1]),Math.max(s[0],n[0],a[0],o[0]),Math.max(s[1],n[1],a[1],o[1])]}static inverseTransform(e){const t=e[0]*e[3]-e[1]*e[2];return[e[3]/t,-e[1]/t,-e[2]/t,e[0]/t,(e[2]*e[5]-e[4]*e[3])/t,(e[4]*e[1]-e[5]*e[0])/t]}static singularValueDecompose2dScale(e){const t=[e[0],e[2],e[1],e[3]],s=e[0]*t[0]+e[1]*t[2],n=e[0]*t[1]+e[1]*t[3],a=e[2]*t[0]+e[3]*t[2],o=e[2]*t[1]+e[3]*t[3],l=(s+o)/2,d=Math.sqrt((s+o)**2-4*(s*o-a*n))/2,h=l+d||1,u=l-d||1;return[Math.sqrt(h),Math.sqrt(u)]}static normalizeRect(e){const t=e.slice(0);return e[0]>e[2]&&(t[0]=e[2],t[2]=e[0]),e[1]>e[3]&&(t[1]=e[3],t[3]=e[1]),t}static intersect(e,t){const s=Math.max(Math.min(e[0],e[2]),Math.min(t[0],t[2])),n=Math.min(Math.max(e[0],e[2]),Math.max(t[0],t[2]));if(s>n)return null;const a=Math.max(Math.min(e[1],e[3]),Math.min(t[1],t[3])),o=Math.min(Math.max(e[1],e[3]),Math.max(t[1],t[3]));return a>o?null:[s,a,n,o]}static bezierBoundingBox(e,t,s,n,a,o,l,d,h){return h?(h[0]=Math.min(h[0],e,l),h[1]=Math.min(h[1],t,d),h[2]=Math.max(h[2],e,l),h[3]=Math.max(h[3],t,d)):h=[Math.min(e,l),Math.min(t,d),Math.max(e,l),Math.max(t,d)],w(this,Li,Jd).call(this,e,s,a,l,t,n,o,d,3*(-e+3*(s-a)+l),6*(e-2*s+a),3*(s-e),h),w(this,Li,Jd).call(this,e,s,a,l,t,n,o,d,3*(-t+3*(n-o)+d),6*(t-2*n+o),3*(n-t),h),h}}Li=new WeakSet,Cc=function(e,t,s,n,a,o,l,d,h,u){if(h<=0||h>=1)return;const p=1-h,m=h*h,f=m*h,g=p*(p*(p*e+3*h*t)+3*m*s)+f*n,b=p*(p*(p*a+3*h*o)+3*m*l)+f*d;u[0]=Math.min(u[0],g),u[1]=Math.min(u[1],b),u[2]=Math.max(u[2],g),u[3]=Math.max(u[3],b)},Jd=function(e,t,s,n,a,o,l,d,h,u,p,m){if(Math.abs(h)<1e-12){Math.abs(u)>=1e-12&&w(this,Li,Cc).call(this,e,t,s,n,a,o,l,d,-p/u,m);return}const f=u**2-4*p*h;if(f<0)return;const g=Math.sqrt(f),b=2*h;w(this,Li,Cc).call(this,e,t,s,n,a,o,l,d,(-u+g)/b,m),w(this,Li,Cc).call(this,e,t,s,n,a,o,l,d,(-u-g)/b,m)},v(X,Li);function _x(c){return decodeURIComponent(escape(c))}let Gd=null,Yu=null;function Sx(c){return Gd||(Gd=/([\u00a0\u00b5\u037e\u0eb3\u2000-\u200a\u202f\u2126\ufb00-\ufb04\ufb06\ufb20-\ufb36\ufb38-\ufb3c\ufb3e\ufb40-\ufb41\ufb43-\ufb44\ufb46-\ufba1\ufba4-\ufba9\ufbae-\ufbb1\ufbd3-\ufbdc\ufbde-\ufbe7\ufbea-\ufbf8\ufbfc-\ufbfd\ufc00-\ufc5d\ufc64-\ufcf1\ufcf5-\ufd3d\ufd88\ufdf4\ufdfa-\ufdfb\ufe71\ufe77\ufe79\ufe7b\ufe7d]+)|(\ufb05+)/gu,Yu=new Map([["ﬅ","ſt"]])),c.replaceAll(Gd,(e,t,s)=>t?t.normalize("NFKC"):Yu.get(s))}function Cx(){if(typeof crypto.randomUUID=="function")return crypto.randomUUID();const c=new Uint8Array(32);return crypto.getRandomValues(c),Hp(c)}const xu="pdfjs_internal_id_";function Ex(c){return Uint8Array.prototype.toBase64?c.toBase64():btoa(Hp(c))}typeof Promise.try!="function"&&(Promise.try=function(c,...e){return new Promise(t=>{t(c(...e))})});const ni="http://www.w3.org/2000/svg",Tn=class Tn{};Z(Tn,"CSS",96),Z(Tn,"PDF",72),Z(Tn,"PDF_TO_CSS_UNITS",Tn.CSS/Tn.PDF);let An=Tn;async function Dd(c,e="text"){if(fo(c,document.baseURI)){const t=await fetch(c);if(!t.ok)throw new Error(t.statusText);switch(e){case"arraybuffer":return t.arrayBuffer();case"blob":return t.blob();case"json":return t.json()}return t.text()}return new Promise((t,s)=>{const n=new XMLHttpRequest;n.open("GET",c,!0),n.responseType=e,n.onreadystatechange=()=>{if(n.readyState===XMLHttpRequest.DONE){if(n.status===200||n.status===0){switch(e){case"arraybuffer":case"blob":case"json":t(n.response);return}t(n.responseText);return}s(new Error(n.statusText))}},n.send(null)})}class uc{constructor({viewBox:e,userUnit:t,scale:s,rotation:n,offsetX:a=0,offsetY:o=0,dontFlip:l=!1}){this.viewBox=e,this.userUnit=t,this.scale=s,this.rotation=n,this.offsetX=a,this.offsetY=o,s*=t;const d=(e[2]+e[0])/2,h=(e[3]+e[1])/2;let u,p,m,f;switch(n%=360,n<0&&(n+=360),n){case 180:u=-1,p=0,m=0,f=1;break;case 90:u=0,p=1,m=1,f=0;break;case 270:u=0,p=-1,m=-1,f=0;break;case 0:u=1,p=0,m=0,f=-1;break;default:throw new Error("PageViewport: Invalid rotation, must be a multiple of 90 degrees.")}l&&(m=-m,f=-f);let g,b,A,N;u===0?(g=Math.abs(h-e[1])*s+a,b=Math.abs(d-e[0])*s+o,A=(e[3]-e[1])*s,N=(e[2]-e[0])*s):(g=Math.abs(d-e[0])*s+a,b=Math.abs(h-e[1])*s+o,A=(e[2]-e[0])*s,N=(e[3]-e[1])*s),this.transform=[u*s,p*s,m*s,f*s,g-u*s*d-m*s*h,b-p*s*d-f*s*h],this.width=A,this.height=N}get rawDims(){const{userUnit:e,viewBox:t}=this,s=t.map(n=>n*e);return de(this,"rawDims",{pageWidth:s[2]-s[0],pageHeight:s[3]-s[1],pageX:s[0],pageY:s[1]})}clone({scale:e=this.scale,rotation:t=this.rotation,offsetX:s=this.offsetX,offsetY:n=this.offsetY,dontFlip:a=!1}={}){return new uc({viewBox:this.viewBox.slice(),userUnit:this.userUnit,scale:e,rotation:t,offsetX:s,offsetY:n,dontFlip:a})}convertToViewportPoint(e,t){return X.applyTransform([e,t],this.transform)}convertToViewportRectangle(e){const t=X.applyTransform([e[0],e[1]],this.transform),s=X.applyTransform([e[2],e[3]],this.transform);return[t[0],t[1],s[0],s[1]]}convertToPdfPoint(e,t){return X.applyInverseTransform([e,t],this.transform)}}class bu extends Sn{constructor(e,t=0){super(e,"RenderingCancelledException"),this.extraDelay=t}}function Fd(c){const e=c.length;let t=0;for(;t<e&&c[t].trim()==="";)t++;return c.substring(t,t+5).toLowerCase()==="data:"}function vu(c){return typeof c=="string"&&/\.pdf$/i.test(c)}function kx(c){return[c]=c.split(/[#?]/,1),c.substring(c.lastIndexOf("/")+1)}function Tx(c,e="document.pdf"){if(typeof c!="string")return e;if(Fd(c))return re('getPdfFilenameFromUrl: ignore "data:"-URL for performance reasons.'),e;const t=/^(?:(?:[^:]+:)?\/\/[^/]+)?([^?#]*)(\?[^#]*)?(#.*)?$/,s=/[^/?#=]+\.pdf\b(?!.*\.pdf\b)/i,n=t.exec(c);let a=s.exec(n[1])||s.exec(n[2])||s.exec(n[3]);if(a&&(a=a[0],a.includes("%")))try{a=s.exec(decodeURIComponent(a))[0]}catch{}return a||e}class Ku{constructor(){Z(this,"started",Object.create(null));Z(this,"times",[])}time(e){e in this.started&&re(`Timer is already running for ${e}`),this.started[e]=Date.now()}timeEnd(e){e in this.started||re(`Timer has not been started for ${e}`),this.times.push({name:e,start:this.started[e],end:Date.now()}),delete this.started[e]}toString(){const e=[];let t=0;for(const{name:s}of this.times)t=Math.max(s.length,t);for(const{name:s,start:n,end:a}of this.times)e.push(`${s.padEnd(t)} ${a-n}ms
`);return e.join("")}}function fo(c,e){try{const{protocol:t}=e?new URL(c,e):new URL(c);return t==="http:"||t==="https:"}catch{return!1}}function Ts(c){c.preventDefault()}function Qt(c){c.preventDefault(),c.stopPropagation()}var Ho;class yu{static toDateObject(e){if(!e||typeof e!="string")return null;r(this,Ho)||x(this,Ho,new RegExp("^D:(\\d{4})(\\d{2})?(\\d{2})?(\\d{2})?(\\d{2})?(\\d{2})?([Z|+|-])?(\\d{2})?'?(\\d{2})?'?"));const t=r(this,Ho).exec(e);if(!t)return null;const s=parseInt(t[1],10);let n=parseInt(t[2],10);n=n>=1&&n<=12?n-1:0;let a=parseInt(t[3],10);a=a>=1&&a<=31?a:1;let o=parseInt(t[4],10);o=o>=0&&o<=23?o:0;let l=parseInt(t[5],10);l=l>=0&&l<=59?l:0;let d=parseInt(t[6],10);d=d>=0&&d<=59?d:0;const h=t[7]||"Z";let u=parseInt(t[8],10);u=u>=0&&u<=23?u:0;let p=parseInt(t[9],10)||0;return p=p>=0&&p<=59?p:0,h==="-"?(o+=u,l+=p):h==="+"&&(o-=u,l-=p),new Date(Date.UTC(s,n,a,o,l,d))}}Ho=new WeakMap,v(yu,Ho);function Rx(c,{scale:e=1,rotation:t=0}){const{width:s,height:n}=c.attributes.style,a=[0,0,parseInt(s),parseInt(n)];return new uc({viewBox:a,userUnit:1,scale:e,rotation:t})}function wu(c){if(c.startsWith("#")){const e=parseInt(c.slice(1),16);return[(e&16711680)>>16,(e&65280)>>8,e&255]}return c.startsWith("rgb(")?c.slice(4,-1).split(",").map(e=>parseInt(e)):c.startsWith("rgba(")?c.slice(5,-1).split(",").map(e=>parseInt(e)).slice(0,3):(re(`Not a valid color format: "${c}"`),[0,0,0])}function Px(c){const e=document.createElement("span");e.style.visibility="hidden",document.body.append(e);for(const t of c.keys()){e.style.color=t;const s=window.getComputedStyle(e).color;c.set(t,wu(s))}e.remove()}function Re(c){const{a:e,b:t,c:s,d:n,e:a,f:o}=c.getTransform();return[e,t,s,n,a,o]}function Is(c){const{a:e,b:t,c:s,d:n,e:a,f:o}=c.getTransform().invertSelf();return[e,t,s,n,a,o]}function Fa(c,e,t=!1,s=!0){if(e instanceof uc){const{pageWidth:n,pageHeight:a}=e.rawDims,{style:o}=c,l=At.isCSSRoundSupported,d=`var(--scale-factor) * ${n}px`,h=`var(--scale-factor) * ${a}px`,u=l?`round(down, ${d}, var(--scale-round-x, 1px))`:`calc(${d})`,p=l?`round(down, ${h}, var(--scale-round-y, 1px))`:`calc(${h})`;!t||e.rotation%180===0?(o.width=u,o.height=p):(o.width=p,o.height=u)}s&&c.setAttribute("data-main-rotation",e.rotation)}class eh{constructor(){const e=window.devicePixelRatio||1;this.sx=e,this.sy=e}get scaled(){return this.sx!==1||this.sy!==1}get symmetric(){return this.sx===this.sy}}var Gi,Pn,gs,Mn,Bo,zo,ud,Bp,_t,zp,Up,Ec,Gp,sh;const oi=class oi{constructor(e){v(this,_t);v(this,Gi,null);v(this,Pn,null);v(this,gs);v(this,Mn,null);v(this,Bo,null);x(this,gs,e),r(oi,zo)||x(oi,zo,Object.freeze({freetext:"pdfjs-editor-remove-freetext-button",highlight:"pdfjs-editor-remove-highlight-button",ink:"pdfjs-editor-remove-ink-button",stamp:"pdfjs-editor-remove-stamp-button"}))}render(){const e=x(this,Gi,document.createElement("div"));e.classList.add("editToolbar","hidden"),e.setAttribute("role","toolbar");const t=r(this,gs)._uiManager._signal;e.addEventListener("contextmenu",Ts,{signal:t}),e.addEventListener("pointerdown",w(oi,ud,Bp),{signal:t});const s=x(this,Mn,document.createElement("div"));s.className="buttons",e.append(s);const n=r(this,gs).toolbarPosition;if(n){const{style:a}=e,o=r(this,gs)._uiManager.direction==="ltr"?1-n[0]:n[0];a.insetInlineEnd=`${100*o}%`,a.top=`calc(${100*n[1]}% + var(--editor-toolbar-vert-offset))`}return w(this,_t,Gp).call(this),e}get div(){return r(this,Gi)}hide(){var e;r(this,Gi).classList.add("hidden"),(e=r(this,Pn))==null||e.hideDropdown()}show(){var e;r(this,Gi).classList.remove("hidden"),(e=r(this,Bo))==null||e.shown()}async addAltText(e){const t=await e.render();w(this,_t,Ec).call(this,t),r(this,Mn).prepend(t,r(this,_t,sh)),x(this,Bo,e)}addColorPicker(e){x(this,Pn,e);const t=e.renderButton();w(this,_t,Ec).call(this,t),r(this,Mn).prepend(t,r(this,_t,sh))}remove(){var e;r(this,Gi).remove(),(e=r(this,Pn))==null||e.destroy(),x(this,Pn,null)}};Gi=new WeakMap,Pn=new WeakMap,gs=new WeakMap,Mn=new WeakMap,Bo=new WeakMap,zo=new WeakMap,ud=new WeakSet,Bp=function(e){e.stopPropagation()},_t=new WeakSet,zp=function(e){r(this,gs)._focusEventsAllowed=!1,Qt(e)},Up=function(e){r(this,gs)._focusEventsAllowed=!0,Qt(e)},Ec=function(e){const t=r(this,gs)._uiManager._signal;e.addEventListener("focusin",w(this,_t,zp).bind(this),{capture:!0,signal:t}),e.addEventListener("focusout",w(this,_t,Up).bind(this),{capture:!0,signal:t}),e.addEventListener("contextmenu",Ts,{signal:t})},Gp=function(){const{editorType:e,_uiManager:t}=r(this,gs),s=document.createElement("button");s.className="delete",s.tabIndex=0,s.setAttribute("data-l10n-id",r(oi,zo)[e]),w(this,_t,Ec).call(this,s),s.addEventListener("click",n=>{t.delete()},{signal:t._signal}),r(this,Mn).append(s)},sh=function(){const e=document.createElement("div");return e.className="divider",e},v(oi,ud),v(oi,zo,null);let th=oi;var Uo,In,Ln,_n,Vp,Wp,qp;class Mx{constructor(e){v(this,_n);v(this,Uo,null);v(this,In,null);v(this,Ln);x(this,Ln,e)}show(e,t,s){const[n,a]=w(this,_n,Wp).call(this,t,s),{style:o}=r(this,In)||x(this,In,w(this,_n,Vp).call(this));e.append(r(this,In)),o.insetInlineEnd=`${100*n}%`,o.top=`calc(${100*a}% + var(--editor-toolbar-vert-offset))`}hide(){r(this,In).remove()}}Uo=new WeakMap,In=new WeakMap,Ln=new WeakMap,_n=new WeakSet,Vp=function(){const e=x(this,In,document.createElement("div"));e.className="editToolbar",e.setAttribute("role","toolbar"),e.addEventListener("contextmenu",Ts,{signal:r(this,Ln)._signal});const t=x(this,Uo,document.createElement("div"));return t.className="buttons",e.append(t),w(this,_n,qp).call(this),e},Wp=function(e,t){let s=0,n=0;for(const a of e){const o=a.y+a.height;if(o<s)continue;const l=a.x+(t?a.width:0);if(o>s){n=l,s=o;continue}t?l>n&&(n=l):l<n&&(n=l)}return[t?1-n:n,s]},qp=function(){const e=document.createElement("button");e.className="highlightButton",e.tabIndex=0,e.setAttribute("data-l10n-id","pdfjs-highlight-floating-button1");const t=document.createElement("span");e.append(t),t.className="visuallyHidden",t.setAttribute("data-l10n-id","pdfjs-highlight-floating-button-label");const s=r(this,Ln)._signal;e.addEventListener("contextmenu",Ts,{signal:s}),e.addEventListener("click",()=>{r(this,Ln).highlightSelection("floating_button")},{signal:s}),r(this,Uo).append(e)};function ad(c,e,t){for(const s of t)e.addEventListener(s,c[s].bind(c))}var pd;class Ix{constructor(){v(this,pd,0)}get id(){return`${mx}${bt(this,pd)._++}`}}pd=new WeakMap;var sr,Go,dt,ir,kc;const Cu=class Cu{constructor(){v(this,ir);v(this,sr,Cx());v(this,Go,0);v(this,dt,null)}static get _isSVGFittingCanvas(){const e='data:image/svg+xml;charset=UTF-8,<svg viewBox="0 0 1 1" width="1" height="1" xmlns="http://www.w3.org/2000/svg"><rect width="1" height="1" style="fill:red;"/></svg>',s=new OffscreenCanvas(1,3).getContext("2d",{willReadFrequently:!0}),n=new Image;n.src=e;const a=n.decode().then(()=>(s.drawImage(n,0,0,1,1,0,0,1,3),new Uint32Array(s.getImageData(0,0,1,1).data.buffer)[0]===0));return de(this,"_isSVGFittingCanvas",a)}async getFromFile(e){const{lastModified:t,name:s,size:n,type:a}=e;return w(this,ir,kc).call(this,`${t}_${s}_${n}_${a}`,e)}async getFromUrl(e){return w(this,ir,kc).call(this,e,e)}async getFromBlob(e,t){const s=await t;return w(this,ir,kc).call(this,e,s)}async getFromId(e){r(this,dt)||x(this,dt,new Map);const t=r(this,dt).get(e);if(!t)return null;if(t.bitmap)return t.refCounter+=1,t;if(t.file)return this.getFromFile(t.file);if(t.blobPromise){const{blobPromise:s}=t;return delete t.blobPromise,this.getFromBlob(t.id,s)}return this.getFromUrl(t.url)}getFromCanvas(e,t){r(this,dt)||x(this,dt,new Map);let s=r(this,dt).get(e);if(s!=null&&s.bitmap)return s.refCounter+=1,s;const n=new OffscreenCanvas(t.width,t.height);return n.getContext("2d").drawImage(t,0,0),s={bitmap:n.transferToImageBitmap(),id:`image_${r(this,sr)}_${bt(this,Go)._++}`,refCounter:1,isSvg:!1},r(this,dt).set(e,s),r(this,dt).set(s.id,s),s}getSvgUrl(e){const t=r(this,dt).get(e);return t!=null&&t.isSvg?t.svgUrl:null}deleteId(e){var n;r(this,dt)||x(this,dt,new Map);const t=r(this,dt).get(e);if(!t||(t.refCounter-=1,t.refCounter!==0))return;const{bitmap:s}=t;if(!t.url&&!t.file){const a=new OffscreenCanvas(s.width,s.height);a.getContext("bitmaprenderer").transferFromImageBitmap(s),t.blobPromise=a.convertToBlob()}(n=s.close)==null||n.call(s),t.bitmap=null}isValidId(e){return e.startsWith(`image_${r(this,sr)}_`)}};sr=new WeakMap,Go=new WeakMap,dt=new WeakMap,ir=new WeakSet,kc=async function(e,t){r(this,dt)||x(this,dt,new Map);let s=r(this,dt).get(e);if(s===null)return null;if(s!=null&&s.bitmap)return s.refCounter+=1,s;try{s||(s={bitmap:null,id:`image_${r(this,sr)}_${bt(this,Go)._++}`,refCounter:0,isSvg:!1});let n;if(typeof t=="string"?(s.url=t,n=await Dd(t,"blob")):t instanceof File?n=s.file=t:t instanceof Blob&&(n=t),n.type==="image/svg+xml"){const a=Cu._isSVGFittingCanvas,o=new FileReader,l=new Image,d=new Promise((h,u)=>{l.onload=()=>{s.bitmap=l,s.isSvg=!0,h()},o.onload=async()=>{const p=s.svgUrl=o.result;l.src=await a?`${p}#svgView(preserveAspectRatio(none))`:p},l.onerror=o.onerror=u});o.readAsDataURL(n),await d}else s.bitmap=await createImageBitmap(n);s.refCounter=1}catch(n){re(n),s=null}return r(this,dt).set(e,s),s&&r(this,dt).set(s.id,s),s};let ih=Cu;var Fe,Vi,Vo,Me;class Lx{constructor(e=128){v(this,Fe,[]);v(this,Vi,!1);v(this,Vo);v(this,Me,-1);x(this,Vo,e)}add({cmd:e,undo:t,post:s,mustExec:n,type:a=NaN,overwriteIfSameType:o=!1,keepUndo:l=!1}){if(n&&e(),r(this,Vi))return;const d={cmd:e,undo:t,post:s,type:a};if(r(this,Me)===-1){r(this,Fe).length>0&&(r(this,Fe).length=0),x(this,Me,0),r(this,Fe).push(d);return}if(o&&r(this,Fe)[r(this,Me)].type===a){l&&(d.undo=r(this,Fe)[r(this,Me)].undo),r(this,Fe)[r(this,Me)]=d;return}const h=r(this,Me)+1;h===r(this,Vo)?r(this,Fe).splice(0,1):(x(this,Me,h),h<r(this,Fe).length&&r(this,Fe).splice(h)),r(this,Fe).push(d)}undo(){if(r(this,Me)===-1)return;x(this,Vi,!0);const{undo:e,post:t}=r(this,Fe)[r(this,Me)];e(),t==null||t(),x(this,Vi,!1),x(this,Me,r(this,Me)-1)}redo(){if(r(this,Me)<r(this,Fe).length-1){x(this,Me,r(this,Me)+1),x(this,Vi,!0);const{cmd:e,post:t}=r(this,Fe)[r(this,Me)];e(),t==null||t(),x(this,Vi,!1)}}hasSomethingToUndo(){return r(this,Me)!==-1}hasSomethingToRedo(){return r(this,Me)<r(this,Fe).length-1}cleanType(e){if(r(this,Me)!==-1){for(let t=r(this,Me);t>=0;t--)if(r(this,Fe)[t].type!==e){r(this,Fe).splice(t+1,r(this,Me)-t),x(this,Me,t);return}r(this,Fe).length=0,x(this,Me,-1)}}destroy(){x(this,Fe,null)}}Fe=new WeakMap,Vi=new WeakMap,Vo=new WeakMap,Me=new WeakMap;var md,Xp;class pc{constructor(e){v(this,md);this.buffer=[],this.callbacks=new Map,this.allKeys=new Set;const{isMac:t}=At.platform;for(const[s,n,a={}]of e)for(const o of s){const l=o.startsWith("mac+");t&&l?(this.callbacks.set(o.slice(4),{callback:n,options:a}),this.allKeys.add(o.split("+").at(-1))):!t&&!l&&(this.callbacks.set(o,{callback:n,options:a}),this.allKeys.add(o.split("+").at(-1)))}}exec(e,t){if(!this.allKeys.has(t.key))return;const s=this.callbacks.get(w(this,md,Xp).call(this,t));if(!s)return;const{callback:n,options:{bubbles:a=!1,args:o=[],checker:l=null}}=s;l&&!l(e,t)||(n.bind(e,...o,t)(),a||Qt(t))}}md=new WeakSet,Xp=function(e){e.altKey&&this.buffer.push("alt"),e.ctrlKey&&this.buffer.push("ctrl"),e.metaKey&&this.buffer.push("meta"),e.shiftKey&&this.buffer.push("shift"),this.buffer.push(e.key);const t=this.buffer.join("+");return this.buffer.length=0,t};const fd=class fd{get _colors(){const e=new Map([["CanvasText",null],["Canvas",null]]);return Px(e),de(this,"_colors",e)}convert(e){const t=wu(e);if(!window.matchMedia("(forced-colors: active)").matches)return t;for(const[s,n]of this._colors)if(n.every((a,o)=>a===t[o]))return fd._colorsMapping.get(s);return t}getHexCode(e){const t=this._colors.get(e);return t?X.makeHexColor(...t):e}};Z(fd,"_colorsMapping",new Map([["CanvasText",[0,0,0]],["Canvas",[255,255,255]]]));let nh=fd;var nr,Ft,We,tt,ar,ci,rr,ts,Wi,Dn,or,Fn,Os,xs,On,Wo,qo,lr,Xo,$s,qi,cr,Xi,Hs,gd,Yi,Yo,Ki,$n,Ko,Qo,Ye,be,di,Hn,Zo,Jo,Qi,Bs,hi,el,ss,H,Tc,ah,Yp,Kp,Rc,Qp,Zp,Jp,rh,em,oh,lh,tm,vt,ai,sm,im,ch,nm,go,dh;const Qa=class Qa{constructor(e,t,s,n,a,o,l,d,h,u,p,m,f){v(this,H);v(this,nr,new AbortController);v(this,Ft,null);v(this,We,new Map);v(this,tt,new Map);v(this,ar,null);v(this,ci,null);v(this,rr,null);v(this,ts,new Lx);v(this,Wi,null);v(this,Dn,null);v(this,or,0);v(this,Fn,new Set);v(this,Os,null);v(this,xs,null);v(this,On,new Set);Z(this,"_editorUndoBar",null);v(this,Wo,!1);v(this,qo,!1);v(this,lr,!1);v(this,Xo,null);v(this,$s,null);v(this,qi,null);v(this,cr,null);v(this,Xi,!1);v(this,Hs,null);v(this,gd,new Ix);v(this,Yi,!1);v(this,Yo,!1);v(this,Ki,null);v(this,$n,null);v(this,Ko,null);v(this,Qo,null);v(this,Ye,ae.NONE);v(this,be,new Set);v(this,di,null);v(this,Hn,null);v(this,Zo,null);v(this,Jo,{isEditing:!1,isEmpty:!0,hasSomethingToUndo:!1,hasSomethingToRedo:!1,hasSelectedEditor:!1,hasSelectedText:!1});v(this,Qi,[0,0]);v(this,Bs,null);v(this,hi,null);v(this,el,null);v(this,ss,null);const g=this._signal=r(this,nr).signal;x(this,hi,e),x(this,el,t),x(this,ar,s),this._eventBus=n,n._on("editingaction",this.onEditingAction.bind(this),{signal:g}),n._on("pagechanging",this.onPageChanging.bind(this),{signal:g}),n._on("scalechanging",this.onScaleChanging.bind(this),{signal:g}),n._on("rotationchanging",this.onRotationChanging.bind(this),{signal:g}),n._on("setpreference",this.onSetPreference.bind(this),{signal:g}),n._on("switchannotationeditorparams",b=>this.updateParams(b.type,b.value),{signal:g}),w(this,H,Qp).call(this),w(this,H,tm).call(this),w(this,H,rh).call(this),x(this,ci,a.annotationStorage),x(this,Xo,a.filterFactory),x(this,Hn,o),x(this,cr,l||null),x(this,Wo,d),x(this,qo,h),x(this,lr,u),x(this,Qo,p||null),this.viewParameters={realScale:An.PDF_TO_CSS_UNITS,rotation:0},this.isShiftKeyDown=!1,this._editorUndoBar=m||null,this._supportsPinchToZoom=f!==!1}static get _keyboardManager(){const e=Qa.prototype,t=o=>r(o,hi).contains(document.activeElement)&&document.activeElement.tagName!=="BUTTON"&&o.hasSomethingToControl(),s=(o,{target:l})=>{if(l instanceof HTMLInputElement){const{type:d}=l;return d!=="text"&&d!=="number"}return!0},n=this.TRANSLATE_SMALL,a=this.TRANSLATE_BIG;return de(this,"_keyboardManager",new pc([[["ctrl+a","mac+meta+a"],e.selectAll,{checker:s}],[["ctrl+z","mac+meta+z"],e.undo,{checker:s}],[["ctrl+y","ctrl+shift+z","mac+meta+shift+z","ctrl+shift+Z","mac+meta+shift+Z"],e.redo,{checker:s}],[["Backspace","alt+Backspace","ctrl+Backspace","shift+Backspace","mac+Backspace","mac+alt+Backspace","mac+ctrl+Backspace","Delete","ctrl+Delete","shift+Delete","mac+Delete"],e.delete,{checker:s}],[["Enter","mac+Enter"],e.addNewEditorFromKeyboard,{checker:(o,{target:l})=>!(l instanceof HTMLButtonElement)&&r(o,hi).contains(l)&&!o.isEnterHandled}],[[" ","mac+ "],e.addNewEditorFromKeyboard,{checker:(o,{target:l})=>!(l instanceof HTMLButtonElement)&&r(o,hi).contains(document.activeElement)}],[["Escape","mac+Escape"],e.unselectAll],[["ArrowLeft","mac+ArrowLeft"],e.translateSelectedEditors,{args:[-n,0],checker:t}],[["ctrl+ArrowLeft","mac+shift+ArrowLeft"],e.translateSelectedEditors,{args:[-a,0],checker:t}],[["ArrowRight","mac+ArrowRight"],e.translateSelectedEditors,{args:[n,0],checker:t}],[["ctrl+ArrowRight","mac+shift+ArrowRight"],e.translateSelectedEditors,{args:[a,0],checker:t}],[["ArrowUp","mac+ArrowUp"],e.translateSelectedEditors,{args:[0,-n],checker:t}],[["ctrl+ArrowUp","mac+shift+ArrowUp"],e.translateSelectedEditors,{args:[0,-a],checker:t}],[["ArrowDown","mac+ArrowDown"],e.translateSelectedEditors,{args:[0,n],checker:t}],[["ctrl+ArrowDown","mac+shift+ArrowDown"],e.translateSelectedEditors,{args:[0,a],checker:t}]]))}destroy(){var e,t,s,n,a;(e=r(this,ss))==null||e.resolve(),x(this,ss,null),(t=r(this,nr))==null||t.abort(),x(this,nr,null),this._signal=null;for(const o of r(this,tt).values())o.destroy();r(this,tt).clear(),r(this,We).clear(),r(this,On).clear(),x(this,Ft,null),r(this,be).clear(),r(this,ts).destroy(),(s=r(this,ar))==null||s.destroy(),(n=r(this,Hs))==null||n.hide(),x(this,Hs,null),r(this,$s)&&(clearTimeout(r(this,$s)),x(this,$s,null)),r(this,Bs)&&(clearTimeout(r(this,Bs)),x(this,Bs,null)),(a=this._editorUndoBar)==null||a.destroy()}combinedSignal(e){return AbortSignal.any([this._signal,e.signal])}get mlManager(){return r(this,Qo)}get useNewAltTextFlow(){return r(this,qo)}get useNewAltTextWhenAddingImage(){return r(this,lr)}get hcmFilter(){return de(this,"hcmFilter",r(this,Hn)?r(this,Xo).addHCMFilter(r(this,Hn).foreground,r(this,Hn).background):"none")}get direction(){return de(this,"direction",getComputedStyle(r(this,hi)).direction)}get highlightColors(){return de(this,"highlightColors",r(this,cr)?new Map(r(this,cr).split(",").map(e=>e.split("=").map(t=>t.trim()))):null)}get highlightColorNames(){return de(this,"highlightColorNames",this.highlightColors?new Map(Array.from(this.highlightColors,e=>e.reverse())):null)}setCurrentDrawingSession(e){e?(this.unselectAll(),this.disableUserSelect(!0)):this.disableUserSelect(!1),x(this,Dn,e)}setMainHighlightColorPicker(e){x(this,Ko,e)}editAltText(e,t=!1){var s;(s=r(this,ar))==null||s.editAltText(this,e,t)}switchToMode(e,t){this._eventBus.on("annotationeditormodechanged",t,{once:!0,signal:this._signal}),this._eventBus.dispatch("showannotationeditorui",{source:this,mode:e})}setPreference(e,t){this._eventBus.dispatch("setpreference",{source:this,name:e,value:t})}onSetPreference({name:e,value:t}){switch(e){case"enableNewAltTextWhenAddingImage":x(this,lr,t);break}}onPageChanging({pageNumber:e}){x(this,or,e-1)}focusMainContainer(){r(this,hi).focus()}findParent(e,t){for(const s of r(this,tt).values()){const{x:n,y:a,width:o,height:l}=s.div.getBoundingClientRect();if(e>=n&&e<=n+o&&t>=a&&t<=a+l)return s}return null}disableUserSelect(e=!1){r(this,el).classList.toggle("noUserSelect",e)}addShouldRescale(e){r(this,On).add(e)}removeShouldRescale(e){r(this,On).delete(e)}onScaleChanging({scale:e}){var t;this.commitOrRemove(),this.viewParameters.realScale=e*An.PDF_TO_CSS_UNITS;for(const s of r(this,On))s.onScaleChanging();(t=r(this,Dn))==null||t.onScaleChanging()}onRotationChanging({pagesRotation:e}){this.commitOrRemove(),this.viewParameters.rotation=e}highlightSelection(e=""){const t=document.getSelection();if(!t||t.isCollapsed)return;const{anchorNode:s,anchorOffset:n,focusNode:a,focusOffset:o}=t,l=t.toString(),h=w(this,H,Tc).call(this,t).closest(".textLayer"),u=this.getSelectionBoxes(h);if(!u)return;t.empty();const p=w(this,H,ah).call(this,h),m=r(this,Ye)===ae.NONE,f=()=>{p==null||p.createAndAddNewEditor({x:0,y:0},!1,{methodOfCreation:e,boxes:u,anchorNode:s,anchorOffset:n,focusNode:a,focusOffset:o,text:l}),m&&this.showAllEditors("highlight",!0,!0)};if(m){this.switchToMode(ae.HIGHLIGHT,f);return}f()}addToAnnotationStorage(e){!e.isEmpty()&&r(this,ci)&&!r(this,ci).has(e.id)&&r(this,ci).setValue(e.id,e)}blur(){if(this.isShiftKeyDown=!1,r(this,Xi)&&(x(this,Xi,!1),w(this,H,Rc).call(this,"main_toolbar")),!this.hasSelection)return;const{activeElement:e}=document;for(const t of r(this,be))if(t.div.contains(e)){x(this,$n,[t,e]),t._focusEventsAllowed=!1;break}}focus(){if(!r(this,$n))return;const[e,t]=r(this,$n);x(this,$n,null),t.addEventListener("focusin",()=>{e._focusEventsAllowed=!0},{once:!0,signal:this._signal}),t.focus()}addEditListeners(){w(this,H,rh).call(this),w(this,H,oh).call(this)}removeEditListeners(){w(this,H,em).call(this),w(this,H,lh).call(this)}dragOver(e){for(const{type:t}of e.dataTransfer.items)for(const s of r(this,xs))if(s.isHandlingMimeForPasting(t)){e.dataTransfer.dropEffect="copy",e.preventDefault();return}}drop(e){for(const t of e.dataTransfer.items)for(const s of r(this,xs))if(s.isHandlingMimeForPasting(t.type)){s.paste(t,this.currentLayer),e.preventDefault();return}}copy(e){var s;if(e.preventDefault(),(s=r(this,Ft))==null||s.commitOrRemove(),!this.hasSelection)return;const t=[];for(const n of r(this,be)){const a=n.serialize(!0);a&&t.push(a)}t.length!==0&&e.clipboardData.setData("application/pdfjs",JSON.stringify(t))}cut(e){this.copy(e),this.delete()}async paste(e){e.preventDefault();const{clipboardData:t}=e;for(const a of t.items)for(const o of r(this,xs))if(o.isHandlingMimeForPasting(a.type)){o.paste(a,this.currentLayer);return}let s=t.getData("application/pdfjs");if(!s)return;try{s=JSON.parse(s)}catch(a){re(`paste: "${a.message}".`);return}if(!Array.isArray(s))return;this.unselectAll();const n=this.currentLayer;try{const a=[];for(const d of s){const h=await n.deserialize(d);if(!h)return;a.push(h)}const o=()=>{for(const d of a)w(this,H,ch).call(this,d);w(this,H,dh).call(this,a)},l=()=>{for(const d of a)d.remove()};this.addCommands({cmd:o,undo:l,mustExec:!0})}catch(a){re(`paste: "${a.message}".`)}}keydown(e){!this.isShiftKeyDown&&e.key==="Shift"&&(this.isShiftKeyDown=!0),r(this,Ye)!==ae.NONE&&!this.isEditorHandlingKeyboard&&Qa._keyboardManager.exec(this,e)}keyup(e){this.isShiftKeyDown&&e.key==="Shift"&&(this.isShiftKeyDown=!1,r(this,Xi)&&(x(this,Xi,!1),w(this,H,Rc).call(this,"main_toolbar")))}onEditingAction({name:e}){switch(e){case"undo":case"redo":case"delete":case"selectAll":this[e]();break;case"highlightSelection":this.highlightSelection("context_menu");break}}setEditingState(e){e?(w(this,H,Zp).call(this),w(this,H,oh).call(this),w(this,H,vt).call(this,{isEditing:r(this,Ye)!==ae.NONE,isEmpty:w(this,H,go).call(this),hasSomethingToUndo:r(this,ts).hasSomethingToUndo(),hasSomethingToRedo:r(this,ts).hasSomethingToRedo(),hasSelectedEditor:!1})):(w(this,H,Jp).call(this),w(this,H,lh).call(this),w(this,H,vt).call(this,{isEditing:!1}),this.disableUserSelect(!1))}registerEditorTypes(e){if(!r(this,xs)){x(this,xs,e);for(const t of r(this,xs))w(this,H,ai).call(this,t.defaultPropertiesToUpdate)}}getId(){return r(this,gd).id}get currentLayer(){return r(this,tt).get(r(this,or))}getLayer(e){return r(this,tt).get(e)}get currentPageIndex(){return r(this,or)}addLayer(e){r(this,tt).set(e.pageIndex,e),r(this,Yi)?e.enable():e.disable()}removeLayer(e){r(this,tt).delete(e.pageIndex)}async updateMode(e,t=null,s=!1){var n;if(r(this,Ye)!==e&&!(r(this,ss)&&(await r(this,ss).promise,!r(this,ss)))){if(x(this,ss,Promise.withResolvers()),x(this,Ye,e),e===ae.NONE){this.setEditingState(!1),w(this,H,im).call(this),(n=this._editorUndoBar)==null||n.hide(),r(this,ss).resolve();return}this.setEditingState(!0),await w(this,H,sm).call(this),this.unselectAll();for(const a of r(this,tt).values())a.updateMode(e);if(!t){s&&this.addNewEditorFromKeyboard(),r(this,ss).resolve();return}for(const a of r(this,We).values())a.annotationElementId===t?(this.setSelected(a),a.enterInEditMode()):a.unselect();r(this,ss).resolve()}}addNewEditorFromKeyboard(){this.currentLayer.canCreateNewEmptyEditor()&&this.currentLayer.addNewEditor()}updateToolbar(e){e!==r(this,Ye)&&this._eventBus.dispatch("switchannotationeditormode",{source:this,mode:e})}updateParams(e,t){var s;if(r(this,xs)){switch(e){case pe.CREATE:this.currentLayer.addNewEditor();return;case pe.HIGHLIGHT_DEFAULT_COLOR:(s=r(this,Ko))==null||s.updateColor(t);break;case pe.HIGHLIGHT_SHOW_ALL:this._eventBus.dispatch("reporttelemetry",{source:this,details:{type:"editing",data:{type:"highlight",action:"toggle_visibility"}}}),(r(this,Zo)||x(this,Zo,new Map)).set(e,t),this.showAllEditors("highlight",t);break}for(const n of r(this,be))n.updateParams(e,t);for(const n of r(this,xs))n.updateDefaultParams(e,t)}}showAllEditors(e,t,s=!1){var a,o;for(const l of r(this,We).values())l.editorType===e&&l.show(t);((o=(a=r(this,Zo))==null?void 0:a.get(pe.HIGHLIGHT_SHOW_ALL))!=null?o:!0)!==t&&w(this,H,ai).call(this,[[pe.HIGHLIGHT_SHOW_ALL,t]])}enableWaiting(e=!1){if(r(this,Yo)!==e){x(this,Yo,e);for(const t of r(this,tt).values())e?t.disableClick():t.enableClick(),t.div.classList.toggle("waiting",e)}}getEditors(e){const t=[];for(const s of r(this,We).values())s.pageIndex===e&&t.push(s);return t}getEditor(e){return r(this,We).get(e)}addEditor(e){r(this,We).set(e.id,e)}removeEditor(e){var t;e.div.contains(document.activeElement)&&(r(this,$s)&&clearTimeout(r(this,$s)),x(this,$s,setTimeout(()=>{this.focusMainContainer(),x(this,$s,null)},0))),r(this,We).delete(e.id),this.unselect(e),(!e.annotationElementId||!r(this,Fn).has(e.annotationElementId))&&((t=r(this,ci))==null||t.remove(e.id))}addDeletedAnnotationElement(e){r(this,Fn).add(e.annotationElementId),this.addChangedExistingAnnotation(e),e.deleted=!0}isDeletedAnnotationElement(e){return r(this,Fn).has(e)}removeDeletedAnnotationElement(e){r(this,Fn).delete(e.annotationElementId),this.removeChangedExistingAnnotation(e),e.deleted=!1}setActiveEditor(e){r(this,Ft)!==e&&(x(this,Ft,e),e&&w(this,H,ai).call(this,e.propertiesToUpdate))}updateUI(e){r(this,H,nm)===e&&w(this,H,ai).call(this,e.propertiesToUpdate)}updateUIForDefaultProperties(e){w(this,H,ai).call(this,e.defaultPropertiesToUpdate)}toggleSelected(e){if(r(this,be).has(e)){r(this,be).delete(e),e.unselect(),w(this,H,vt).call(this,{hasSelectedEditor:this.hasSelection});return}r(this,be).add(e),e.select(),w(this,H,ai).call(this,e.propertiesToUpdate),w(this,H,vt).call(this,{hasSelectedEditor:!0})}setSelected(e){var t;(t=r(this,Dn))==null||t.commitOrRemove();for(const s of r(this,be))s!==e&&s.unselect();r(this,be).clear(),r(this,be).add(e),e.select(),w(this,H,ai).call(this,e.propertiesToUpdate),w(this,H,vt).call(this,{hasSelectedEditor:!0})}isSelected(e){return r(this,be).has(e)}get firstSelectedEditor(){return r(this,be).values().next().value}unselect(e){e.unselect(),r(this,be).delete(e),w(this,H,vt).call(this,{hasSelectedEditor:this.hasSelection})}get hasSelection(){return r(this,be).size!==0}get isEnterHandled(){return r(this,be).size===1&&this.firstSelectedEditor.isEnterHandled}undo(){var e;r(this,ts).undo(),w(this,H,vt).call(this,{hasSomethingToUndo:r(this,ts).hasSomethingToUndo(),hasSomethingToRedo:!0,isEmpty:w(this,H,go).call(this)}),(e=this._editorUndoBar)==null||e.hide()}redo(){r(this,ts).redo(),w(this,H,vt).call(this,{hasSomethingToUndo:!0,hasSomethingToRedo:r(this,ts).hasSomethingToRedo(),isEmpty:w(this,H,go).call(this)})}addCommands(e){r(this,ts).add(e),w(this,H,vt).call(this,{hasSomethingToUndo:!0,hasSomethingToRedo:!1,isEmpty:w(this,H,go).call(this)})}cleanUndoStack(e){r(this,ts).cleanType(e)}delete(){var a;this.commitOrRemove();const e=(a=this.currentLayer)==null?void 0:a.endDrawingSession(!0);if(!this.hasSelection&&!e)return;const t=e?[e]:[...r(this,be)],s=()=>{var o;(o=this._editorUndoBar)==null||o.show(n,t.length===1?t[0].editorType:t.length);for(const l of t)l.remove()},n=()=>{for(const o of t)w(this,H,ch).call(this,o)};this.addCommands({cmd:s,undo:n,mustExec:!0})}commitOrRemove(){var e;(e=r(this,Ft))==null||e.commitOrRemove()}hasSomethingToControl(){return r(this,Ft)||this.hasSelection}selectAll(){for(const e of r(this,be))e.commit();w(this,H,dh).call(this,r(this,We).values())}unselectAll(){var e;if(!(r(this,Ft)&&(r(this,Ft).commitOrRemove(),r(this,Ye)!==ae.NONE))&&!((e=r(this,Dn))!=null&&e.commitOrRemove())&&this.hasSelection){for(const t of r(this,be))t.unselect();r(this,be).clear(),w(this,H,vt).call(this,{hasSelectedEditor:!1})}}translateSelectedEditors(e,t,s=!1){if(s||this.commitOrRemove(),!this.hasSelection)return;r(this,Qi)[0]+=e,r(this,Qi)[1]+=t;const[n,a]=r(this,Qi),o=[...r(this,be)],l=1e3;r(this,Bs)&&clearTimeout(r(this,Bs)),x(this,Bs,setTimeout(()=>{x(this,Bs,null),r(this,Qi)[0]=r(this,Qi)[1]=0,this.addCommands({cmd:()=>{for(const d of o)r(this,We).has(d.id)&&d.translateInPage(n,a)},undo:()=>{for(const d of o)r(this,We).has(d.id)&&d.translateInPage(-n,-a)},mustExec:!1})},l));for(const d of o)d.translateInPage(e,t)}setUpDragSession(){if(this.hasSelection){this.disableUserSelect(!0),x(this,Os,new Map);for(const e of r(this,be))r(this,Os).set(e,{savedX:e.x,savedY:e.y,savedPageIndex:e.pageIndex,newX:0,newY:0,newPageIndex:-1})}}endDragSession(){if(!r(this,Os))return!1;this.disableUserSelect(!1);const e=r(this,Os);x(this,Os,null);let t=!1;for(const[{x:n,y:a,pageIndex:o},l]of e)l.newX=n,l.newY=a,l.newPageIndex=o,t||(t=n!==l.savedX||a!==l.savedY||o!==l.savedPageIndex);if(!t)return!1;const s=(n,a,o,l)=>{if(r(this,We).has(n.id)){const d=r(this,tt).get(l);d?n._setParentAndPosition(d,a,o):(n.pageIndex=l,n.x=a,n.y=o)}};return this.addCommands({cmd:()=>{for(const[n,{newX:a,newY:o,newPageIndex:l}]of e)s(n,a,o,l)},undo:()=>{for(const[n,{savedX:a,savedY:o,savedPageIndex:l}]of e)s(n,a,o,l)},mustExec:!0}),!0}dragSelectedEditors(e,t){if(r(this,Os))for(const s of r(this,Os).keys())s.drag(e,t)}rebuild(e){if(e.parent===null){const t=this.getLayer(e.pageIndex);t?(t.changeParent(e),t.addOrRebuild(e)):(this.addEditor(e),this.addToAnnotationStorage(e),e.rebuild())}else e.parent.addOrRebuild(e)}get isEditorHandlingKeyboard(){var e;return((e=this.getActive())==null?void 0:e.shouldGetKeyboardEvents())||r(this,be).size===1&&this.firstSelectedEditor.shouldGetKeyboardEvents()}isActive(e){return r(this,Ft)===e}getActive(){return r(this,Ft)}getMode(){return r(this,Ye)}get imageManager(){return de(this,"imageManager",new ih)}getSelectionBoxes(e){if(!e)return null;const t=document.getSelection();for(let h=0,u=t.rangeCount;h<u;h++)if(!e.contains(t.getRangeAt(h).commonAncestorContainer))return null;const{x:s,y:n,width:a,height:o}=e.getBoundingClientRect();let l;switch(e.getAttribute("data-main-rotation")){case"90":l=(h,u,p,m)=>({x:(u-n)/o,y:1-(h+p-s)/a,width:m/o,height:p/a});break;case"180":l=(h,u,p,m)=>({x:1-(h+p-s)/a,y:1-(u+m-n)/o,width:p/a,height:m/o});break;case"270":l=(h,u,p,m)=>({x:1-(u+m-n)/o,y:(h-s)/a,width:m/o,height:p/a});break;default:l=(h,u,p,m)=>({x:(h-s)/a,y:(u-n)/o,width:p/a,height:m/o});break}const d=[];for(let h=0,u=t.rangeCount;h<u;h++){const p=t.getRangeAt(h);if(!p.collapsed)for(const{x:m,y:f,width:g,height:b}of p.getClientRects())g===0||b===0||d.push(l(m,f,g,b))}return d.length===0?null:d}addChangedExistingAnnotation({annotationElementId:e,id:t}){(r(this,rr)||x(this,rr,new Map)).set(e,t)}removeChangedExistingAnnotation({annotationElementId:e}){var t;(t=r(this,rr))==null||t.delete(e)}renderAnnotationElement(e){var n;const t=(n=r(this,rr))==null?void 0:n.get(e.data.id);if(!t)return;const s=r(this,ci).getRawValue(t);s&&(r(this,Ye)===ae.NONE&&!s.hasBeenModified||s.renderAnnotationElement(e))}};nr=new WeakMap,Ft=new WeakMap,We=new WeakMap,tt=new WeakMap,ar=new WeakMap,ci=new WeakMap,rr=new WeakMap,ts=new WeakMap,Wi=new WeakMap,Dn=new WeakMap,or=new WeakMap,Fn=new WeakMap,Os=new WeakMap,xs=new WeakMap,On=new WeakMap,Wo=new WeakMap,qo=new WeakMap,lr=new WeakMap,Xo=new WeakMap,$s=new WeakMap,qi=new WeakMap,cr=new WeakMap,Xi=new WeakMap,Hs=new WeakMap,gd=new WeakMap,Yi=new WeakMap,Yo=new WeakMap,Ki=new WeakMap,$n=new WeakMap,Ko=new WeakMap,Qo=new WeakMap,Ye=new WeakMap,be=new WeakMap,di=new WeakMap,Hn=new WeakMap,Zo=new WeakMap,Jo=new WeakMap,Qi=new WeakMap,Bs=new WeakMap,hi=new WeakMap,el=new WeakMap,ss=new WeakMap,H=new WeakSet,Tc=function({anchorNode:e}){return e.nodeType===Node.TEXT_NODE?e.parentElement:e},ah=function(e){const{currentLayer:t}=this;if(t.hasTextLayer(e))return t;for(const s of r(this,tt).values())if(s.hasTextLayer(e))return s;return null},Yp=function(){const e=document.getSelection();if(!e||e.isCollapsed)return;const s=w(this,H,Tc).call(this,e).closest(".textLayer"),n=this.getSelectionBoxes(s);n&&(r(this,Hs)||x(this,Hs,new Mx(this)),r(this,Hs).show(s,n,this.direction==="ltr"))},Kp=function(){var a,o,l;const e=document.getSelection();if(!e||e.isCollapsed){r(this,di)&&((a=r(this,Hs))==null||a.hide(),x(this,di,null),w(this,H,vt).call(this,{hasSelectedText:!1}));return}const{anchorNode:t}=e;if(t===r(this,di))return;const n=w(this,H,Tc).call(this,e).closest(".textLayer");if(!n){r(this,di)&&((o=r(this,Hs))==null||o.hide(),x(this,di,null),w(this,H,vt).call(this,{hasSelectedText:!1}));return}if((l=r(this,Hs))==null||l.hide(),x(this,di,t),w(this,H,vt).call(this,{hasSelectedText:!0}),!(r(this,Ye)!==ae.HIGHLIGHT&&r(this,Ye)!==ae.NONE)&&(r(this,Ye)===ae.HIGHLIGHT&&this.showAllEditors("highlight",!0,!0),x(this,Xi,this.isShiftKeyDown),!this.isShiftKeyDown)){const d=r(this,Ye)===ae.HIGHLIGHT?w(this,H,ah).call(this,n):null;d==null||d.toggleDrawing();const h=new AbortController,u=this.combinedSignal(h),p=m=>{m.type==="pointerup"&&m.button!==0||(h.abort(),d==null||d.toggleDrawing(!0),m.type==="pointerup"&&w(this,H,Rc).call(this,"main_toolbar"))};window.addEventListener("pointerup",p,{signal:u}),window.addEventListener("blur",p,{signal:u})}},Rc=function(e=""){r(this,Ye)===ae.HIGHLIGHT?this.highlightSelection(e):r(this,Wo)&&w(this,H,Yp).call(this)},Qp=function(){document.addEventListener("selectionchange",w(this,H,Kp).bind(this),{signal:this._signal})},Zp=function(){if(r(this,qi))return;x(this,qi,new AbortController);const e=this.combinedSignal(r(this,qi));window.addEventListener("focus",this.focus.bind(this),{signal:e}),window.addEventListener("blur",this.blur.bind(this),{signal:e})},Jp=function(){var e;(e=r(this,qi))==null||e.abort(),x(this,qi,null)},rh=function(){if(r(this,Ki))return;x(this,Ki,new AbortController);const e=this.combinedSignal(r(this,Ki));window.addEventListener("keydown",this.keydown.bind(this),{signal:e}),window.addEventListener("keyup",this.keyup.bind(this),{signal:e})},em=function(){var e;(e=r(this,Ki))==null||e.abort(),x(this,Ki,null)},oh=function(){if(r(this,Wi))return;x(this,Wi,new AbortController);const e=this.combinedSignal(r(this,Wi));document.addEventListener("copy",this.copy.bind(this),{signal:e}),document.addEventListener("cut",this.cut.bind(this),{signal:e}),document.addEventListener("paste",this.paste.bind(this),{signal:e})},lh=function(){var e;(e=r(this,Wi))==null||e.abort(),x(this,Wi,null)},tm=function(){const e=this._signal;document.addEventListener("dragover",this.dragOver.bind(this),{signal:e}),document.addEventListener("drop",this.drop.bind(this),{signal:e})},vt=function(e){Object.entries(e).some(([s,n])=>r(this,Jo)[s]!==n)&&(this._eventBus.dispatch("annotationeditorstateschanged",{source:this,details:Object.assign(r(this,Jo),e)}),r(this,Ye)===ae.HIGHLIGHT&&e.hasSelectedEditor===!1&&w(this,H,ai).call(this,[[pe.HIGHLIGHT_FREE,!0]]))},ai=function(e){this._eventBus.dispatch("annotationeditorparamschanged",{source:this,details:e})},sm=async function(){if(!r(this,Yi)){x(this,Yi,!0);const e=[];for(const t of r(this,tt).values())e.push(t.enable());await Promise.all(e);for(const t of r(this,We).values())t.enable()}},im=function(){if(this.unselectAll(),r(this,Yi)){x(this,Yi,!1);for(const e of r(this,tt).values())e.disable();for(const e of r(this,We).values())e.disable()}},ch=function(e){const t=r(this,tt).get(e.pageIndex);t?t.addOrRebuild(e):(this.addEditor(e),this.addToAnnotationStorage(e))},nm=function(){let e=null;for(e of r(this,be));return e},go=function(){if(r(this,We).size===0)return!0;if(r(this,We).size===1)for(const e of r(this,We).values())return e.isEmpty();return!1},dh=function(e){for(const t of r(this,be))t.unselect();r(this,be).clear();for(const t of e)t.isEmpty()||(r(this,be).add(t),t.select());w(this,H,vt).call(this,{hasSelectedEditor:this.hasSelection})},Z(Qa,"TRANSLATE_SMALL",1),Z(Qa,"TRANSLATE_BIG",10);let Oa=Qa;var Ke,zs,bs,dr,Us,Ot,hr,Gs,Pt,ui,Bn,Vs,Zi,ks,xo,Pc;const yt=class yt{constructor(e){v(this,ks);v(this,Ke,null);v(this,zs,!1);v(this,bs,null);v(this,dr,null);v(this,Us,null);v(this,Ot,null);v(this,hr,!1);v(this,Gs,null);v(this,Pt,null);v(this,ui,null);v(this,Bn,null);v(this,Vs,!1);x(this,Pt,e),x(this,Vs,e._uiManager.useNewAltTextFlow),r(yt,Zi)||x(yt,Zi,Object.freeze({added:"pdfjs-editor-new-alt-text-added-button","added-label":"pdfjs-editor-new-alt-text-added-button-label",missing:"pdfjs-editor-new-alt-text-missing-button","missing-label":"pdfjs-editor-new-alt-text-missing-button-label",review:"pdfjs-editor-new-alt-text-to-review-button","review-label":"pdfjs-editor-new-alt-text-to-review-button-label"}))}static initialize(e){var t;(t=yt._l10n)!=null||(yt._l10n=e)}async render(){const e=x(this,bs,document.createElement("button"));e.className="altText",e.tabIndex="0";const t=x(this,dr,document.createElement("span"));e.append(t),r(this,Vs)?(e.classList.add("new"),e.setAttribute("data-l10n-id",r(yt,Zi).missing),t.setAttribute("data-l10n-id",r(yt,Zi)["missing-label"])):(e.setAttribute("data-l10n-id","pdfjs-editor-alt-text-button"),t.setAttribute("data-l10n-id","pdfjs-editor-alt-text-button-label"));const s=r(this,Pt)._uiManager._signal;e.addEventListener("contextmenu",Ts,{signal:s}),e.addEventListener("pointerdown",a=>a.stopPropagation(),{signal:s});const n=a=>{a.preventDefault(),r(this,Pt)._uiManager.editAltText(r(this,Pt)),r(this,Vs)&&r(this,Pt)._reportTelemetry({action:"pdfjs.image.alt_text.image_status_label_clicked",data:{label:r(this,ks,xo)}})};return e.addEventListener("click",n,{capture:!0,signal:s}),e.addEventListener("keydown",a=>{a.target===e&&a.key==="Enter"&&(x(this,hr,!0),n(a))},{signal:s}),await w(this,ks,Pc).call(this),e}finish(){r(this,bs)&&(r(this,bs).focus({focusVisible:r(this,hr)}),x(this,hr,!1))}isEmpty(){return r(this,Vs)?r(this,Ke)===null:!r(this,Ke)&&!r(this,zs)}hasData(){return r(this,Vs)?r(this,Ke)!==null||!!r(this,ui):this.isEmpty()}get guessedText(){return r(this,ui)}async setGuessedText(e){r(this,Ke)===null&&(x(this,ui,e),x(this,Bn,await yt._l10n.get("pdfjs-editor-new-alt-text-generated-alt-text-with-disclaimer",{generatedAltText:e})),w(this,ks,Pc).call(this))}toggleAltTextBadge(e=!1){var t;if(!r(this,Vs)||r(this,Ke)){(t=r(this,Gs))==null||t.remove(),x(this,Gs,null);return}if(!r(this,Gs)){const s=x(this,Gs,document.createElement("div"));s.className="noAltTextBadge",r(this,Pt).div.append(s)}r(this,Gs).classList.toggle("hidden",!e)}serialize(e){let t=r(this,Ke);return!e&&r(this,ui)===t&&(t=r(this,Bn)),{altText:t,decorative:r(this,zs),guessedText:r(this,ui),textWithDisclaimer:r(this,Bn)}}get data(){return{altText:r(this,Ke),decorative:r(this,zs)}}set data({altText:e,decorative:t,guessedText:s,textWithDisclaimer:n,cancel:a=!1}){s&&(x(this,ui,s),x(this,Bn,n)),!(r(this,Ke)===e&&r(this,zs)===t)&&(a||(x(this,Ke,e),x(this,zs,t)),w(this,ks,Pc).call(this))}toggle(e=!1){r(this,bs)&&(!e&&r(this,Ot)&&(clearTimeout(r(this,Ot)),x(this,Ot,null)),r(this,bs).disabled=!e)}shown(){r(this,Pt)._reportTelemetry({action:"pdfjs.image.alt_text.image_status_label_displayed",data:{label:r(this,ks,xo)}})}destroy(){var e,t;(e=r(this,bs))==null||e.remove(),x(this,bs,null),x(this,dr,null),x(this,Us,null),(t=r(this,Gs))==null||t.remove(),x(this,Gs,null)}};Ke=new WeakMap,zs=new WeakMap,bs=new WeakMap,dr=new WeakMap,Us=new WeakMap,Ot=new WeakMap,hr=new WeakMap,Gs=new WeakMap,Pt=new WeakMap,ui=new WeakMap,Bn=new WeakMap,Vs=new WeakMap,Zi=new WeakMap,ks=new WeakSet,xo=function(){return r(this,Ke)&&"added"||r(this,Ke)===null&&this.guessedText&&"review"||"missing"},Pc=async function(){var n,a,o;const e=r(this,bs);if(!e)return;if(r(this,Vs)){if(e.classList.toggle("done",!!r(this,Ke)),e.setAttribute("data-l10n-id",r(yt,Zi)[r(this,ks,xo)]),(n=r(this,dr))==null||n.setAttribute("data-l10n-id",r(yt,Zi)[`${r(this,ks,xo)}-label`]),!r(this,Ke)){(a=r(this,Us))==null||a.remove();return}}else{if(!r(this,Ke)&&!r(this,zs)){e.classList.remove("done"),(o=r(this,Us))==null||o.remove();return}e.classList.add("done"),e.setAttribute("data-l10n-id","pdfjs-editor-alt-text-edit-button")}let t=r(this,Us);if(!t){x(this,Us,t=document.createElement("span")),t.className="tooltip",t.setAttribute("role","tooltip"),t.id=`alt-text-tooltip-${r(this,Pt).id}`;const l=100,d=r(this,Pt)._uiManager._signal;d.addEventListener("abort",()=>{clearTimeout(r(this,Ot)),x(this,Ot,null)},{once:!0}),e.addEventListener("mouseenter",()=>{x(this,Ot,setTimeout(()=>{x(this,Ot,null),r(this,Us).classList.add("show"),r(this,Pt)._reportTelemetry({action:"alt_text_tooltip"})},l))},{signal:d}),e.addEventListener("mouseleave",()=>{var h;r(this,Ot)&&(clearTimeout(r(this,Ot)),x(this,Ot,null)),(h=r(this,Us))==null||h.classList.remove("show")},{signal:d})}r(this,zs)?t.setAttribute("data-l10n-id","pdfjs-editor-alt-text-decorative-tooltip"):(t.removeAttribute("data-l10n-id"),t.textContent=r(this,Ke)),t.parentNode||e.append(t);const s=r(this,Pt).getImageForAltText();s==null||s.setAttribute("aria-describedby",t.id)},v(yt,Zi,null),Z(yt,"_l10n",null);let rd=yt;var tl,zn,sl,il,nl,al,rl,ur,pi,Un,Ji,Fi,am,rm,hh;const Eu=class Eu{constructor({container:e,isPinchingDisabled:t=null,isPinchingStopped:s=null,onPinchStart:n=null,onPinching:a=null,onPinchEnd:o=null,signal:l}){v(this,Fi);v(this,tl);v(this,zn,!1);v(this,sl,null);v(this,il);v(this,nl);v(this,al);v(this,rl);v(this,ur);v(this,pi,null);v(this,Un);v(this,Ji,null);x(this,tl,e),x(this,sl,s),x(this,il,t),x(this,nl,n),x(this,al,a),x(this,rl,o),x(this,Un,new AbortController),x(this,ur,AbortSignal.any([l,r(this,Un).signal])),e.addEventListener("touchstart",w(this,Fi,am).bind(this),{passive:!1,signal:r(this,ur)})}get MIN_TOUCH_DISTANCE_TO_PINCH(){return de(this,"MIN_TOUCH_DISTANCE_TO_PINCH",35/(window.devicePixelRatio||1))}destroy(){var e;(e=r(this,Un))==null||e.abort(),x(this,Un,null)}};tl=new WeakMap,zn=new WeakMap,sl=new WeakMap,il=new WeakMap,nl=new WeakMap,al=new WeakMap,rl=new WeakMap,ur=new WeakMap,pi=new WeakMap,Un=new WeakMap,Ji=new WeakMap,Fi=new WeakSet,am=function(e){var n,a,o;if((n=r(this,il))!=null&&n.call(this)||e.touches.length<2)return;if(!r(this,Ji)){x(this,Ji,new AbortController);const l=AbortSignal.any([r(this,ur),r(this,Ji).signal]),d=r(this,tl),h={signal:l,passive:!1};d.addEventListener("touchmove",w(this,Fi,rm).bind(this),h),d.addEventListener("touchend",w(this,Fi,hh).bind(this),h),d.addEventListener("touchcancel",w(this,Fi,hh).bind(this),h),(a=r(this,nl))==null||a.call(this)}if(Qt(e),e.touches.length!==2||(o=r(this,sl))!=null&&o.call(this)){x(this,pi,null);return}let[t,s]=e.touches;t.identifier>s.identifier&&([t,s]=[s,t]),x(this,pi,{touch0X:t.screenX,touch0Y:t.screenY,touch1X:s.screenX,touch1Y:s.screenY})},rm=function(e){var _;if(!r(this,pi)||e.touches.length!==2)return;let[t,s]=e.touches;t.identifier>s.identifier&&([t,s]=[s,t]);const{screenX:n,screenY:a}=t,{screenX:o,screenY:l}=s,d=r(this,pi),{touch0X:h,touch0Y:u,touch1X:p,touch1Y:m}=d,f=p-h,g=m-u,b=o-n,A=l-a,N=Math.hypot(b,A)||1,j=Math.hypot(f,g)||1;if(!r(this,zn)&&Math.abs(j-N)<=Eu.MIN_TOUCH_DISTANCE_TO_PINCH)return;if(d.touch0X=n,d.touch0Y=a,d.touch1X=o,d.touch1Y=l,e.preventDefault(),!r(this,zn)){x(this,zn,!0);return}const E=[(n+o)/2,(a+l)/2];(_=r(this,al))==null||_.call(this,E,j,N)},hh=function(e){var t;r(this,Ji).abort(),x(this,Ji,null),(t=r(this,rl))==null||t.call(this),r(this,pi)&&(e.preventDefault(),x(this,pi,null),x(this,zn,!1))};let od=Eu;var Gn,vs,Ee,pr,en,ol,Vn,st,Wn,mi,tn,ll,qn,$t,cl,Xn,fi,Ws,mr,fr,is,Yn,dl,xd,J,uh,hl,ph,Mc,om,lm,mh,Ic,fh,cm,dm,hm,gh,um,xh,pm,mm,fm,bh,bo;const oe=class oe{constructor(e){v(this,J);v(this,Gn,null);v(this,vs,null);v(this,Ee,null);v(this,pr,!1);v(this,en,null);v(this,ol,"");v(this,Vn,!1);v(this,st,null);v(this,Wn,null);v(this,mi,null);v(this,tn,null);v(this,ll,"");v(this,qn,!1);v(this,$t,null);v(this,cl,!1);v(this,Xn,!1);v(this,fi,!1);v(this,Ws,null);v(this,mr,0);v(this,fr,0);v(this,is,null);v(this,Yn,null);Z(this,"_editToolbar",null);Z(this,"_initialOptions",Object.create(null));Z(this,"_initialData",null);Z(this,"_isVisible",!0);Z(this,"_uiManager",null);Z(this,"_focusEventsAllowed",!0);v(this,dl,!1);v(this,xd,oe._zIndex++);this.parent=e.parent,this.id=e.id,this.width=this.height=null,this.pageIndex=e.parent.pageIndex,this.name=e.name,this.div=null,this._uiManager=e.uiManager,this.annotationElementId=null,this._willKeepAspectRatio=!1,this._initialOptions.isCentered=e.isCentered,this._structTreeParentId=null;const{rotation:t,rawDims:{pageWidth:s,pageHeight:n,pageX:a,pageY:o}}=this.parent.viewport;this.rotation=t,this.pageRotation=(360+t-this._uiManager.viewParameters.rotation)%360,this.pageDimensions=[s,n],this.pageTranslation=[a,o];const[l,d]=this.parentDimensions;this.x=e.x/l,this.y=e.y/d,this.isAttachedToDOM=!1,this.deleted=!1}static get _resizerKeyboardManager(){const e=oe.prototype._resizeWithKeyboard,t=Oa.TRANSLATE_SMALL,s=Oa.TRANSLATE_BIG;return de(this,"_resizerKeyboardManager",new pc([[["ArrowLeft","mac+ArrowLeft"],e,{args:[-t,0]}],[["ctrl+ArrowLeft","mac+shift+ArrowLeft"],e,{args:[-s,0]}],[["ArrowRight","mac+ArrowRight"],e,{args:[t,0]}],[["ctrl+ArrowRight","mac+shift+ArrowRight"],e,{args:[s,0]}],[["ArrowUp","mac+ArrowUp"],e,{args:[0,-t]}],[["ctrl+ArrowUp","mac+shift+ArrowUp"],e,{args:[0,-s]}],[["ArrowDown","mac+ArrowDown"],e,{args:[0,t]}],[["ctrl+ArrowDown","mac+shift+ArrowDown"],e,{args:[0,s]}],[["Escape","mac+Escape"],oe.prototype._stopResizingWithKeyboard]]))}get editorType(){return Object.getPrototypeOf(this).constructor._type}static get isDrawer(){return!1}static get _defaultLineColor(){return de(this,"_defaultLineColor",this._colorManager.getHexCode("CanvasText"))}static deleteAnnotationElement(e){const t=new Dx({id:e.parent.getNextId(),parent:e.parent,uiManager:e._uiManager});t.annotationElementId=e.annotationElementId,t.deleted=!0,t._uiManager.addToAnnotationStorage(t)}static initialize(e,t){var n;if((n=oe._l10n)!=null||(oe._l10n=e),oe._l10nResizer||(oe._l10nResizer=Object.freeze({topLeft:"pdfjs-editor-resizer-top-left",topMiddle:"pdfjs-editor-resizer-top-middle",topRight:"pdfjs-editor-resizer-top-right",middleRight:"pdfjs-editor-resizer-middle-right",bottomRight:"pdfjs-editor-resizer-bottom-right",bottomMiddle:"pdfjs-editor-resizer-bottom-middle",bottomLeft:"pdfjs-editor-resizer-bottom-left",middleLeft:"pdfjs-editor-resizer-middle-left"})),oe._borderLineWidth!==-1)return;const s=getComputedStyle(document.documentElement);oe._borderLineWidth=parseFloat(s.getPropertyValue("--outline-width"))||0}static updateDefaultParams(e,t){}static get defaultPropertiesToUpdate(){return[]}static isHandlingMimeForPasting(e){return!1}static paste(e,t){Ae("Not implemented")}get propertiesToUpdate(){return[]}get _isDraggable(){return r(this,dl)}set _isDraggable(e){var t;x(this,dl,e),(t=this.div)==null||t.classList.toggle("draggable",e)}get isEnterHandled(){return!0}center(){const[e,t]=this.pageDimensions;switch(this.parentRotation){case 90:this.x-=this.height*t/(e*2),this.y+=this.width*e/(t*2);break;case 180:this.x+=this.width/2,this.y+=this.height/2;break;case 270:this.x+=this.height*t/(e*2),this.y-=this.width*e/(t*2);break;default:this.x-=this.width/2,this.y-=this.height/2;break}this.fixAndSetPosition()}addCommands(e){this._uiManager.addCommands(e)}get currentLayer(){return this._uiManager.currentLayer}setInBackground(){this.div.style.zIndex=0}setInForeground(){this.div.style.zIndex=r(this,xd)}setParent(e){e!==null?(this.pageIndex=e.pageIndex,this.pageDimensions=e.pageDimensions):w(this,J,bo).call(this),this.parent=e}focusin(e){this._focusEventsAllowed&&(r(this,qn)?x(this,qn,!1):this.parent.setSelected(this))}focusout(e){var s;if(!this._focusEventsAllowed||!this.isAttachedToDOM)return;const t=e.relatedTarget;t!=null&&t.closest(`#${this.id}`)||(e.preventDefault(),(s=this.parent)!=null&&s.isMultipleSelection||this.commitOrRemove())}commitOrRemove(){this.isEmpty()?this.remove():this.commit()}commit(){this.addToAnnotationStorage()}addToAnnotationStorage(){this._uiManager.addToAnnotationStorage(this)}setAt(e,t,s,n){const[a,o]=this.parentDimensions;[s,n]=this.screenToPageTranslation(s,n),this.x=(e+s)/a,this.y=(t+n)/o,this.fixAndSetPosition()}translate(e,t){w(this,J,uh).call(this,this.parentDimensions,e,t)}translateInPage(e,t){r(this,$t)||x(this,$t,[this.x,this.y,this.width,this.height]),w(this,J,uh).call(this,this.pageDimensions,e,t),this.div.scrollIntoView({block:"nearest"})}drag(e,t){r(this,$t)||x(this,$t,[this.x,this.y,this.width,this.height]);const{div:s,parentDimensions:[n,a]}=this;if(this.x+=e/n,this.y+=t/a,this.parent&&(this.x<0||this.x>1||this.y<0||this.y>1)){const{x:p,y:m}=this.div.getBoundingClientRect();this.parent.findNewParent(this,p,m)&&(this.x-=Math.floor(this.x),this.y-=Math.floor(this.y))}let{x:o,y:l}=this;const[d,h]=this.getBaseTranslation();o+=d,l+=h;const{style:u}=s;u.left=`${(100*o).toFixed(2)}%`,u.top=`${(100*l).toFixed(2)}%`,this._onTranslating(o,l),s.scrollIntoView({block:"nearest"})}_onTranslating(e,t){}_onTranslated(e,t){}get _hasBeenMoved(){return!!r(this,$t)&&(r(this,$t)[0]!==this.x||r(this,$t)[1]!==this.y)}get _hasBeenResized(){return!!r(this,$t)&&(r(this,$t)[2]!==this.width||r(this,$t)[3]!==this.height)}getBaseTranslation(){const[e,t]=this.parentDimensions,{_borderLineWidth:s}=oe,n=s/e,a=s/t;switch(this.rotation){case 90:return[-n,a];case 180:return[n,a];case 270:return[n,-a];default:return[-n,-a]}}get _mustFixPosition(){return!0}fixAndSetPosition(e=this.rotation){const{div:{style:t},pageDimensions:[s,n]}=this;let{x:a,y:o,width:l,height:d}=this;if(l*=s,d*=n,a*=s,o*=n,this._mustFixPosition)switch(e){case 0:a=Math.max(0,Math.min(s-l,a)),o=Math.max(0,Math.min(n-d,o));break;case 90:a=Math.max(0,Math.min(s-d,a)),o=Math.min(n,Math.max(l,o));break;case 180:a=Math.min(s,Math.max(l,a)),o=Math.min(n,Math.max(d,o));break;case 270:a=Math.min(s,Math.max(d,a)),o=Math.max(0,Math.min(n-l,o));break}this.x=a/=s,this.y=o/=n;const[h,u]=this.getBaseTranslation();a+=h,o+=u,t.left=`${(100*a).toFixed(2)}%`,t.top=`${(100*o).toFixed(2)}%`,this.moveInDOM()}screenToPageTranslation(e,t){var s;return w(s=oe,hl,ph).call(s,e,t,this.parentRotation)}pageTranslationToScreen(e,t){var s;return w(s=oe,hl,ph).call(s,e,t,360-this.parentRotation)}get parentScale(){return this._uiManager.viewParameters.realScale}get parentRotation(){return(this._uiManager.viewParameters.rotation+this.pageRotation)%360}get parentDimensions(){const{parentScale:e,pageDimensions:[t,s]}=this;return[t*e,s*e]}setDims(e,t){const[s,n]=this.parentDimensions,{style:a}=this.div;a.width=`${(100*e/s).toFixed(2)}%`,r(this,Vn)||(a.height=`${(100*t/n).toFixed(2)}%`)}fixDims(){const{style:e}=this.div,{height:t,width:s}=e,n=s.endsWith("%"),a=!r(this,Vn)&&t.endsWith("%");if(n&&a)return;const[o,l]=this.parentDimensions;n||(e.width=`${(100*parseFloat(s)/o).toFixed(2)}%`),!r(this,Vn)&&!a&&(e.height=`${(100*parseFloat(t)/l).toFixed(2)}%`)}getInitialTranslation(){return[0,0]}_onResized(){}static _round(e){return Math.round(e*1e4)/1e4}_onResizing(){}altTextFinish(){var e;(e=r(this,Ee))==null||e.finish()}async addEditToolbar(){return this._editToolbar||r(this,Xn)?this._editToolbar:(this._editToolbar=new th(this),this.div.append(this._editToolbar.render()),r(this,Ee)&&await this._editToolbar.addAltText(r(this,Ee)),this._editToolbar)}removeEditToolbar(){var e;this._editToolbar&&(this._editToolbar.remove(),this._editToolbar=null,(e=r(this,Ee))==null||e.destroy())}addContainer(e){var s;const t=(s=this._editToolbar)==null?void 0:s.div;t?t.before(e):this.div.append(e)}getClientDimensions(){return this.div.getBoundingClientRect()}async addAltTextButton(){r(this,Ee)||(rd.initialize(oe._l10n),x(this,Ee,new rd(this)),r(this,Gn)&&(r(this,Ee).data=r(this,Gn),x(this,Gn,null)),await this.addEditToolbar())}get altTextData(){var e;return(e=r(this,Ee))==null?void 0:e.data}set altTextData(e){r(this,Ee)&&(r(this,Ee).data=e)}get guessedAltText(){var e;return(e=r(this,Ee))==null?void 0:e.guessedText}async setGuessedAltText(e){var t;await((t=r(this,Ee))==null?void 0:t.setGuessedText(e))}serializeAltText(e){var t;return(t=r(this,Ee))==null?void 0:t.serialize(e)}hasAltText(){return!!r(this,Ee)&&!r(this,Ee).isEmpty()}hasAltTextData(){var e,t;return(t=(e=r(this,Ee))==null?void 0:e.hasData())!=null?t:!1}render(){var a;this.div=document.createElement("div"),this.div.setAttribute("data-editor-rotation",(360-this.rotation)%360),this.div.className=this.name,this.div.setAttribute("id",this.id),this.div.tabIndex=r(this,pr)?-1:0,this._isVisible||this.div.classList.add("hidden"),this.setInForeground(),w(this,J,xh).call(this);const[e,t]=this.parentDimensions;this.parentRotation%180!==0&&(this.div.style.maxWidth=`${(100*t/e).toFixed(2)}%`,this.div.style.maxHeight=`${(100*e/t).toFixed(2)}%`);const[s,n]=this.getInitialTranslation();return this.translate(s,n),ad(this,this.div,["pointerdown"]),this.isResizable&&this._uiManager._supportsPinchToZoom&&(r(this,Yn)||x(this,Yn,new od({container:this.div,isPinchingDisabled:()=>!this.isSelected,onPinchStart:w(this,J,cm).bind(this),onPinching:w(this,J,dm).bind(this),onPinchEnd:w(this,J,hm).bind(this),signal:this._uiManager._signal}))),(a=this._uiManager._editorUndoBar)==null||a.hide(),this.div}pointerdown(e){const{isMac:t}=At.platform;if(e.button!==0||e.ctrlKey&&t){e.preventDefault();return}if(x(this,qn,!0),this._isDraggable){w(this,J,um).call(this,e);return}w(this,J,gh).call(this,e)}get isSelected(){return this._uiManager.isSelected(this)}_onStartDragging(){}_onStopDragging(){}moveInDOM(){r(this,Ws)&&clearTimeout(r(this,Ws)),x(this,Ws,setTimeout(()=>{var e;x(this,Ws,null),(e=this.parent)==null||e.moveEditorInDOM(this)},0))}_setParentAndPosition(e,t,s){e.changeParent(this),this.x=t,this.y=s,this.fixAndSetPosition(),this._onTranslated()}getRect(e,t,s=this.rotation){const n=this.parentScale,[a,o]=this.pageDimensions,[l,d]=this.pageTranslation,h=e/n,u=t/n,p=this.x*a,m=this.y*o,f=this.width*a,g=this.height*o;switch(s){case 0:return[p+h+l,o-m-u-g+d,p+h+f+l,o-m-u+d];case 90:return[p+u+l,o-m+h+d,p+u+g+l,o-m+h+f+d];case 180:return[p-h-f+l,o-m+u+d,p-h+l,o-m+u+g+d];case 270:return[p-u-g+l,o-m-h-f+d,p-u+l,o-m-h+d];default:throw new Error("Invalid rotation")}}getRectInCurrentCoords(e,t){const[s,n,a,o]=e,l=a-s,d=o-n;switch(this.rotation){case 0:return[s,t-o,l,d];case 90:return[s,t-n,d,l];case 180:return[a,t-n,l,d];case 270:return[a,t-o,d,l];default:throw new Error("Invalid rotation")}}onceAdded(e){}isEmpty(){return!1}enableEditMode(){x(this,Xn,!0)}disableEditMode(){x(this,Xn,!1)}isInEditMode(){return r(this,Xn)}shouldGetKeyboardEvents(){return r(this,fi)}needsToBeRebuilt(){return this.div&&!this.isAttachedToDOM}get isOnScreen(){const{top:e,left:t,bottom:s,right:n}=this.getClientDimensions(),{innerHeight:a,innerWidth:o}=window;return t<o&&n>0&&e<a&&s>0}rebuild(){w(this,J,xh).call(this)}rotate(e){}resize(){}serializeDeleted(){var e;return{id:this.annotationElementId,deleted:!0,pageIndex:this.pageIndex,popupRef:((e=this._initialData)==null?void 0:e.popupRef)||""}}serialize(e=!1,t=null){Ae("An editor must be serializable")}static async deserialize(e,t,s){const n=new this.prototype.constructor({parent:t,id:t.getNextId(),uiManager:s});n.rotation=e.rotation,x(n,Gn,e.accessibilityData);const[a,o]=n.pageDimensions,[l,d,h,u]=n.getRectInCurrentCoords(e.rect,o);return n.x=l/a,n.y=d/o,n.width=h/a,n.height=u/o,n}get hasBeenModified(){return!!this.annotationElementId&&(this.deleted||this.serialize()!==null)}remove(){var e,t;if((e=r(this,tn))==null||e.abort(),x(this,tn,null),this.isEmpty()||this.commit(),this.parent?this.parent.remove(this):this._uiManager.removeEditor(this),r(this,Ws)&&(clearTimeout(r(this,Ws)),x(this,Ws,null)),w(this,J,bo).call(this),this.removeEditToolbar(),r(this,is)){for(const s of r(this,is).values())clearTimeout(s);x(this,is,null)}this.parent=null,(t=r(this,Yn))==null||t.destroy(),x(this,Yn,null)}get isResizable(){return!1}makeResizable(){this.isResizable&&(w(this,J,om).call(this),r(this,st).classList.remove("hidden"),ad(this,this.div,["keydown"]))}get toolbarPosition(){return null}keydown(e){if(!this.isResizable||e.target!==this.div||e.key!=="Enter")return;this._uiManager.setSelected(this),x(this,mi,{savedX:this.x,savedY:this.y,savedWidth:this.width,savedHeight:this.height});const t=r(this,st).children;if(!r(this,vs)){x(this,vs,Array.from(t));const o=w(this,J,pm).bind(this),l=w(this,J,mm).bind(this),d=this._uiManager._signal;for(const h of r(this,vs)){const u=h.getAttribute("data-resizer-name");h.setAttribute("role","spinbutton"),h.addEventListener("keydown",o,{signal:d}),h.addEventListener("blur",l,{signal:d}),h.addEventListener("focus",w(this,J,fm).bind(this,u),{signal:d}),h.setAttribute("data-l10n-id",oe._l10nResizer[u])}}const s=r(this,vs)[0];let n=0;for(const o of t){if(o===s)break;n++}const a=(360-this.rotation+this.parentRotation)%360/90*(r(this,vs).length/4);if(a!==n){if(a<n)for(let l=0;l<n-a;l++)r(this,st).append(r(this,st).firstChild);else if(a>n)for(let l=0;l<a-n;l++)r(this,st).firstChild.before(r(this,st).lastChild);let o=0;for(const l of t){const h=r(this,vs)[o++].getAttribute("data-resizer-name");l.setAttribute("data-l10n-id",oe._l10nResizer[h])}}w(this,J,bh).call(this,0),x(this,fi,!0),r(this,st).firstChild.focus({focusVisible:!0}),e.preventDefault(),e.stopImmediatePropagation()}_resizeWithKeyboard(e,t){r(this,fi)&&w(this,J,fh).call(this,r(this,ll),{deltaX:e,deltaY:t,fromKeyboard:!0})}_stopResizingWithKeyboard(){w(this,J,bo).call(this),this.div.focus()}select(){var e,t,s;if(this.makeResizable(),(e=this.div)==null||e.classList.add("selectedEditor"),!this._editToolbar){this.addEditToolbar().then(()=>{var n,a;(n=this.div)!=null&&n.classList.contains("selectedEditor")&&((a=this._editToolbar)==null||a.show())});return}(t=this._editToolbar)==null||t.show(),(s=r(this,Ee))==null||s.toggleAltTextBadge(!1)}unselect(){var e,t,s,n,a;(e=r(this,st))==null||e.classList.add("hidden"),(t=this.div)==null||t.classList.remove("selectedEditor"),(s=this.div)!=null&&s.contains(document.activeElement)&&this._uiManager.currentLayer.div.focus({preventScroll:!0}),(n=this._editToolbar)==null||n.hide(),(a=r(this,Ee))==null||a.toggleAltTextBadge(!0)}updateParams(e,t){}disableEditing(){}enableEditing(){}enterInEditMode(){}getImageForAltText(){return null}get contentDiv(){return this.div}get isEditing(){return r(this,cl)}set isEditing(e){x(this,cl,e),this.parent&&(e?(this.parent.setSelected(this),this.parent.setActiveEditor(this)):this.parent.setActiveEditor(null))}setAspectRatio(e,t){x(this,Vn,!0);const s=e/t,{style:n}=this.div;n.aspectRatio=s,n.height="auto"}static get MIN_SIZE(){return 16}static canCreateNewEmptyEditor(){return!0}get telemetryInitialData(){return{action:"added"}}get telemetryFinalData(){return null}_reportTelemetry(e,t=!1){if(t){r(this,is)||x(this,is,new Map);const{action:s}=e;let n=r(this,is).get(s);n&&clearTimeout(n),n=setTimeout(()=>{this._reportTelemetry(e),r(this,is).delete(s),r(this,is).size===0&&x(this,is,null)},oe._telemetryTimeout),r(this,is).set(s,n);return}e.type||(e.type=this.editorType),this._uiManager._eventBus.dispatch("reporttelemetry",{source:this,details:{type:"editing",data:e}})}show(e=this._isVisible){this.div.classList.toggle("hidden",!e),this._isVisible=e}enable(){this.div&&(this.div.tabIndex=0),x(this,pr,!1)}disable(){this.div&&(this.div.tabIndex=-1),x(this,pr,!0)}renderAnnotationElement(e){let t=e.container.querySelector(".annotationContent");if(!t)t=document.createElement("div"),t.classList.add("annotationContent",this.editorType),e.container.prepend(t);else if(t.nodeName==="CANVAS"){const s=t;t=document.createElement("div"),t.classList.add("annotationContent",this.editorType),s.before(t)}return t}resetAnnotationElement(e){const{firstChild:t}=e.container;(t==null?void 0:t.nodeName)==="DIV"&&t.classList.contains("annotationContent")&&t.remove()}};Gn=new WeakMap,vs=new WeakMap,Ee=new WeakMap,pr=new WeakMap,en=new WeakMap,ol=new WeakMap,Vn=new WeakMap,st=new WeakMap,Wn=new WeakMap,mi=new WeakMap,tn=new WeakMap,ll=new WeakMap,qn=new WeakMap,$t=new WeakMap,cl=new WeakMap,Xn=new WeakMap,fi=new WeakMap,Ws=new WeakMap,mr=new WeakMap,fr=new WeakMap,is=new WeakMap,Yn=new WeakMap,dl=new WeakMap,xd=new WeakMap,J=new WeakSet,uh=function([e,t],s,n){[s,n]=this.screenToPageTranslation(s,n),this.x+=s/e,this.y+=n/t,this._onTranslating(this.x,this.y),this.fixAndSetPosition()},hl=new WeakSet,ph=function(e,t,s){switch(s){case 90:return[t,-e];case 180:return[-e,-t];case 270:return[-t,e];default:return[e,t]}},Mc=function(e){switch(e){case 90:{const[t,s]=this.pageDimensions;return[0,-t/s,s/t,0]}case 180:return[-1,0,0,-1];case 270:{const[t,s]=this.pageDimensions;return[0,t/s,-s/t,0]}default:return[1,0,0,1]}},om=function(){if(r(this,st))return;x(this,st,document.createElement("div")),r(this,st).classList.add("resizers");const e=this._willKeepAspectRatio?["topLeft","topRight","bottomRight","bottomLeft"]:["topLeft","topMiddle","topRight","middleRight","bottomRight","bottomMiddle","bottomLeft","middleLeft"],t=this._uiManager._signal;for(const s of e){const n=document.createElement("div");r(this,st).append(n),n.classList.add("resizer",s),n.setAttribute("data-resizer-name",s),n.addEventListener("pointerdown",w(this,J,lm).bind(this,s),{signal:t}),n.addEventListener("contextmenu",Ts,{signal:t}),n.tabIndex=-1}this.div.prepend(r(this,st))},lm=function(e,t){var u;t.preventDefault();const{isMac:s}=At.platform;if(t.button!==0||t.ctrlKey&&s)return;(u=r(this,Ee))==null||u.toggle(!1);const n=this._isDraggable;this._isDraggable=!1,x(this,Wn,[t.screenX,t.screenY]);const a=new AbortController,o=this._uiManager.combinedSignal(a);this.parent.togglePointerEvents(!1),window.addEventListener("pointermove",w(this,J,fh).bind(this,e),{passive:!0,capture:!0,signal:o}),window.addEventListener("touchmove",Qt,{passive:!1,signal:o}),window.addEventListener("contextmenu",Ts,{signal:o}),x(this,mi,{savedX:this.x,savedY:this.y,savedWidth:this.width,savedHeight:this.height});const l=this.parent.div.style.cursor,d=this.div.style.cursor;this.div.style.cursor=this.parent.div.style.cursor=window.getComputedStyle(t.target).cursor;const h=()=>{var p;a.abort(),this.parent.togglePointerEvents(!0),(p=r(this,Ee))==null||p.toggle(!0),this._isDraggable=n,this.parent.div.style.cursor=l,this.div.style.cursor=d,w(this,J,Ic).call(this)};window.addEventListener("pointerup",h,{signal:o}),window.addEventListener("blur",h,{signal:o})},mh=function(e,t,s,n){this.width=s,this.height=n,this.x=e,this.y=t;const[a,o]=this.parentDimensions;this.setDims(a*s,o*n),this.fixAndSetPosition(),this._onResized()},Ic=function(){if(!r(this,mi))return;const{savedX:e,savedY:t,savedWidth:s,savedHeight:n}=r(this,mi);x(this,mi,null);const a=this.x,o=this.y,l=this.width,d=this.height;a===e&&o===t&&l===s&&d===n||this.addCommands({cmd:w(this,J,mh).bind(this,a,o,l,d),undo:w(this,J,mh).bind(this,e,t,s,n),mustExec:!0})},fh=function(e,t){const[s,n]=this.parentDimensions,a=this.x,o=this.y,l=this.width,d=this.height,h=oe.MIN_SIZE/s,u=oe.MIN_SIZE/n,p=w(this,J,Mc).call(this,this.rotation),m=(P,I)=>[p[0]*P+p[2]*I,p[1]*P+p[3]*I],f=w(this,J,Mc).call(this,360-this.rotation),g=(P,I)=>[f[0]*P+f[2]*I,f[1]*P+f[3]*I];let b,A,N=!1,j=!1;switch(e){case"topLeft":N=!0,b=(P,I)=>[0,0],A=(P,I)=>[P,I];break;case"topMiddle":b=(P,I)=>[P/2,0],A=(P,I)=>[P/2,I];break;case"topRight":N=!0,b=(P,I)=>[P,0],A=(P,I)=>[0,I];break;case"middleRight":j=!0,b=(P,I)=>[P,I/2],A=(P,I)=>[0,I/2];break;case"bottomRight":N=!0,b=(P,I)=>[P,I],A=(P,I)=>[0,0];break;case"bottomMiddle":b=(P,I)=>[P/2,I],A=(P,I)=>[P/2,0];break;case"bottomLeft":N=!0,b=(P,I)=>[0,I],A=(P,I)=>[P,0];break;case"middleLeft":j=!0,b=(P,I)=>[0,I/2],A=(P,I)=>[P,I/2];break}const E=b(l,d),_=A(l,d);let y=m(..._);const C=oe._round(a+y[0]),R=oe._round(o+y[1]);let S=1,k=1,M,L;if(t.fromKeyboard)({deltaX:M,deltaY:L}=t);else{const{screenX:P,screenY:I}=t,[K,ie]=r(this,Wn);[M,L]=this.screenToPageTranslation(P-K,I-ie),r(this,Wn)[0]=P,r(this,Wn)[1]=I}if([M,L]=g(M/s,L/n),N){const P=Math.hypot(l,d);S=k=Math.max(Math.min(Math.hypot(_[0]-E[0]-M,_[1]-E[1]-L)/P,1/l,1/d),h/l,u/d)}else j?S=Math.max(h,Math.min(1,Math.abs(_[0]-E[0]-M)))/l:k=Math.max(u,Math.min(1,Math.abs(_[1]-E[1]-L)))/d;const O=oe._round(l*S),$=oe._round(d*k);y=m(...A(O,$));const q=C-y[0],F=R-y[1];r(this,$t)||x(this,$t,[this.x,this.y,this.width,this.height]),this.width=O,this.height=$,this.x=q,this.y=F,this.setDims(s*O,n*$),this.fixAndSetPosition(),this._onResizing()},cm=function(){var e;x(this,mi,{savedX:this.x,savedY:this.y,savedWidth:this.width,savedHeight:this.height}),(e=r(this,Ee))==null||e.toggle(!1),this.parent.togglePointerEvents(!1)},dm=function(e,t,s){let a=.7*(s/t)+1-.7;if(a===1)return;const o=w(this,J,Mc).call(this,this.rotation),l=(C,R)=>[o[0]*C+o[2]*R,o[1]*C+o[3]*R],[d,h]=this.parentDimensions,u=this.x,p=this.y,m=this.width,f=this.height,g=oe.MIN_SIZE/d,b=oe.MIN_SIZE/h;a=Math.max(Math.min(a,1/m,1/f),g/m,b/f);const A=oe._round(m*a),N=oe._round(f*a);if(A===m&&N===f)return;r(this,$t)||x(this,$t,[u,p,m,f]);const j=l(m/2,f/2),E=oe._round(u+j[0]),_=oe._round(p+j[1]),y=l(A/2,N/2);this.x=E-y[0],this.y=_-y[1],this.width=A,this.height=N,this.setDims(d*A,h*N),this.fixAndSetPosition(),this._onResizing()},hm=function(){var e;(e=r(this,Ee))==null||e.toggle(!0),this.parent.togglePointerEvents(!0),w(this,J,Ic).call(this)},gh=function(e){const{isMac:t}=At.platform;e.ctrlKey&&!t||e.shiftKey||e.metaKey&&t?this.parent.toggleSelected(this):this.parent.setSelected(this)},um=function(e){const{isSelected:t}=this;this._uiManager.setUpDragSession();let s=!1;const n=new AbortController,a=this._uiManager.combinedSignal(n),o={capture:!0,passive:!1,signal:a},l=h=>{n.abort(),x(this,en,null),x(this,qn,!1),this._uiManager.endDragSession()||w(this,J,gh).call(this,h),s&&this._onStopDragging()};t&&(x(this,mr,e.clientX),x(this,fr,e.clientY),x(this,en,e.pointerId),x(this,ol,e.pointerType),window.addEventListener("pointermove",h=>{s||(s=!0,this._onStartDragging());const{clientX:u,clientY:p,pointerId:m}=h;if(m!==r(this,en)){Qt(h);return}const[f,g]=this.screenToPageTranslation(u-r(this,mr),p-r(this,fr));x(this,mr,u),x(this,fr,p),this._uiManager.dragSelectedEditors(f,g)},o),window.addEventListener("touchmove",Qt,o),window.addEventListener("pointerdown",h=>{h.pointerType===r(this,ol)&&(r(this,Yn)||h.isPrimary)&&l(h),Qt(h)},o));const d=h=>{if(!r(this,en)||r(this,en)===h.pointerId){l(h);return}Qt(h)};window.addEventListener("pointerup",d,{signal:a}),window.addEventListener("blur",d,{signal:a})},xh=function(){if(r(this,tn)||!this.div)return;x(this,tn,new AbortController);const e=this._uiManager.combinedSignal(r(this,tn));this.div.addEventListener("focusin",this.focusin.bind(this),{signal:e}),this.div.addEventListener("focusout",this.focusout.bind(this),{signal:e})},pm=function(e){oe._resizerKeyboardManager.exec(this,e)},mm=function(e){var t;r(this,fi)&&((t=e.relatedTarget)==null?void 0:t.parentNode)!==r(this,st)&&w(this,J,bo).call(this)},fm=function(e){x(this,ll,r(this,fi)?e:"")},bh=function(e){if(r(this,vs))for(const t of r(this,vs))t.tabIndex=e},bo=function(){x(this,fi,!1),w(this,J,bh).call(this,-1),w(this,J,Ic).call(this)},v(oe,hl),Z(oe,"_l10n",null),Z(oe,"_l10nResizer",null),Z(oe,"_borderLineWidth",-1),Z(oe,"_colorManager",new nh),Z(oe,"_zIndex",1),Z(oe,"_telemetryTimeout",1e3);let Le=oe;class Dx extends Le{constructor(e){super(e),this.annotationElementId=e.annotationElementId,this.deleted=!0}serialize(){return this.serializeDeleted()}}const Qu=3285377520,es=4294901760,Ls=65535;class gm{constructor(e){this.h1=e?e&4294967295:Qu,this.h2=e?e&4294967295:Qu}update(e){let t,s;if(typeof e=="string"){t=new Uint8Array(e.length*2),s=0;for(let b=0,A=e.length;b<A;b++){const N=e.charCodeAt(b);N<=255?t[s++]=N:(t[s++]=N>>>8,t[s++]=N&255)}}else if(ArrayBuffer.isView(e))t=e.slice(),s=t.byteLength;else throw new Error("Invalid data format, must be a string or TypedArray.");const n=s>>2,a=s-n*4,o=new Uint32Array(t.buffer,0,n);let l=0,d=0,h=this.h1,u=this.h2;const p=3432918353,m=461845907,f=p&Ls,g=m&Ls;for(let b=0;b<n;b++)b&1?(l=o[b],l=l*p&es|l*f&Ls,l=l<<15|l>>>17,l=l*m&es|l*g&Ls,h^=l,h=h<<13|h>>>19,h=h*5+3864292196):(d=o[b],d=d*p&es|d*f&Ls,d=d<<15|d>>>17,d=d*m&es|d*g&Ls,u^=d,u=u<<13|u>>>19,u=u*5+3864292196);switch(l=0,a){case 3:l^=t[n*4+2]<<16;case 2:l^=t[n*4+1]<<8;case 1:l^=t[n*4],l=l*p&es|l*f&Ls,l=l<<15|l>>>17,l=l*m&es|l*g&Ls,n&1?h^=l:u^=l}this.h1=h,this.h2=u}hexdigest(){let e=this.h1,t=this.h2;return e^=t>>>1,e=e*3981806797&es|e*36045&Ls,t=t*4283543511&es|((t<<16|e>>>16)*2950163797&es)>>>16,e^=t>>>1,e=e*444984403&es|e*60499&Ls,t=t*3301882366&es|((t<<16|e>>>16)*3120437893&es)>>>16,e^=t>>>1,(e>>>0).toString(16).padStart(8,"0")+(t>>>0).toString(16).padStart(8,"0")}}const vh=Object.freeze({map:null,hash:"",transfer:void 0});var Kn,Qn,Qe,bd,xm;class Nu{constructor(){v(this,bd);v(this,Kn,!1);v(this,Qn,null);v(this,Qe,new Map);this.onSetModified=null,this.onResetModified=null,this.onAnnotationEditor=null}getValue(e,t){const s=r(this,Qe).get(e);return s===void 0?t:Object.assign(t,s)}getRawValue(e){return r(this,Qe).get(e)}remove(e){if(r(this,Qe).delete(e),r(this,Qe).size===0&&this.resetModified(),typeof this.onAnnotationEditor=="function"){for(const t of r(this,Qe).values())if(t instanceof Le)return;this.onAnnotationEditor(null)}}setValue(e,t){const s=r(this,Qe).get(e);let n=!1;if(s!==void 0)for(const[a,o]of Object.entries(t))s[a]!==o&&(n=!0,s[a]=o);else n=!0,r(this,Qe).set(e,t);n&&w(this,bd,xm).call(this),t instanceof Le&&typeof this.onAnnotationEditor=="function"&&this.onAnnotationEditor(t.constructor._type)}has(e){return r(this,Qe).has(e)}getAll(){return r(this,Qe).size>0?gu(r(this,Qe)):null}setAll(e){for(const[t,s]of Object.entries(e))this.setValue(t,s)}get size(){return r(this,Qe).size}resetModified(){r(this,Kn)&&(x(this,Kn,!1),typeof this.onResetModified=="function"&&this.onResetModified())}get print(){return new bm(this)}get serializable(){if(r(this,Qe).size===0)return vh;const e=new Map,t=new gm,s=[],n=Object.create(null);let a=!1;for(const[o,l]of r(this,Qe)){const d=l instanceof Le?l.serialize(!1,n):l;d&&(e.set(o,d),t.update(`${o}:${JSON.stringify(d)}`),a||(a=!!d.bitmap))}if(a)for(const o of e.values())o.bitmap&&s.push(o.bitmap);return e.size>0?{map:e,hash:t.hexdigest(),transfer:s}:vh}get editorStats(){var s;let e=null;const t=new Map;for(const n of r(this,Qe).values()){if(!(n instanceof Le))continue;const a=n.telemetryFinalData;if(!a)continue;const{type:o}=a;t.has(o)||t.set(o,Object.getPrototypeOf(n).constructor),e||(e=Object.create(null));const l=e[o]||(e[o]=new Map);for(const[d,h]of Object.entries(a)){if(d==="type")continue;let u=l.get(d);u||(u=new Map,l.set(d,u));const p=(s=u.get(h))!=null?s:0;u.set(h,p+1)}}for(const[n,a]of t)e[n]=a.computeTelemetryFinalData(e[n]);return e}resetModifiedIds(){x(this,Qn,null)}get modifiedIds(){if(r(this,Qn))return r(this,Qn);const e=[];for(const t of r(this,Qe).values())!(t instanceof Le)||!t.annotationElementId||!t.serialize()||e.push(t.annotationElementId);return x(this,Qn,{ids:new Set(e),hash:e.join(",")})}}Kn=new WeakMap,Qn=new WeakMap,Qe=new WeakMap,bd=new WeakSet,xm=function(){r(this,Kn)||(x(this,Kn,!0),typeof this.onSetModified=="function"&&this.onSetModified())};var ul;class bm extends Nu{constructor(t){super();v(this,ul);const{map:s,hash:n,transfer:a}=t.serializable,o=structuredClone(s,a?{transfer:a}:null);x(this,ul,{map:o,hash:n,transfer:a})}get print(){Ae("Should not call PrintAnnotationStorage.print")}get serializable(){return r(this,ul)}get modifiedIds(){return de(this,"modifiedIds",{ids:new Set,hash:""})}}ul=new WeakMap;var gr;class Fx{constructor({ownerDocument:e=globalThis.document,styleElement:t=null}){v(this,gr,new Set);this._document=e,this.nativeFontFaces=new Set,this.styleElement=null,this.loadingRequests=[],this.loadTestFontId=0}addNativeFontFace(e){this.nativeFontFaces.add(e),this._document.fonts.add(e)}removeNativeFontFace(e){this.nativeFontFaces.delete(e),this._document.fonts.delete(e)}insertRule(e){this.styleElement||(this.styleElement=this._document.createElement("style"),this._document.documentElement.getElementsByTagName("head")[0].append(this.styleElement));const t=this.styleElement.sheet;t.insertRule(e,t.cssRules.length)}clear(){for(const e of this.nativeFontFaces)this._document.fonts.delete(e);this.nativeFontFaces.clear(),r(this,gr).clear(),this.styleElement&&(this.styleElement.remove(),this.styleElement=null)}async loadSystemFont({systemFontInfo:e,_inspectFont:t}){if(!(!e||r(this,gr).has(e.loadedName))){if(ze(!this.disableFontFace,"loadSystemFont shouldn't be called when `disableFontFace` is set."),this.isFontLoadingAPISupported){const{loadedName:s,src:n,style:a}=e,o=new FontFace(s,n,a);this.addNativeFontFace(o);try{await o.load(),r(this,gr).add(s),t==null||t(e)}catch{re(`Cannot load system font: ${e.baseFontName}, installing it could help to improve PDF rendering.`),this.removeNativeFontFace(o)}return}Ae("Not implemented: loadSystemFont without the Font Loading API.")}}async bind(e){if(e.attached||e.missingFile&&!e.systemFontInfo)return;if(e.attached=!0,e.systemFontInfo){await this.loadSystemFont(e);return}if(this.isFontLoadingAPISupported){const s=e.createNativeFontFace();if(s){this.addNativeFontFace(s);try{await s.loaded}catch(n){throw re(`Failed to load font '${s.family}': '${n}'.`),e.disableFontFace=!0,n}}return}const t=e.createFontFaceRule();if(t){if(this.insertRule(t),this.isSyncFontLoadingSupported)return;await new Promise(s=>{const n=this._queueLoadingCallback(s);this._prepareFontLoadEvent(e,n)})}}get isFontLoadingAPISupported(){var t;const e=!!((t=this._document)!=null&&t.fonts);return de(this,"isFontLoadingAPISupported",e)}get isSyncFontLoadingSupported(){let e=!1;return(ft||typeof navigator<"u"&&typeof(navigator==null?void 0:navigator.userAgent)=="string"&&/Mozilla\/5.0.*?rv:\d+.*? Gecko/.test(navigator.userAgent))&&(e=!0),de(this,"isSyncFontLoadingSupported",e)}_queueLoadingCallback(e){function t(){for(ze(!n.done,"completeRequest() cannot be called twice."),n.done=!0;s.length>0&&s[0].done;){const a=s.shift();setTimeout(a.callback,0)}}const{loadingRequests:s}=this,n={done:!1,complete:t,callback:e};return s.push(n),n}get _loadTestFont(){const e=atob("T1RUTwALAIAAAwAwQ0ZGIDHtZg4AAAOYAAAAgUZGVE1lkzZwAAAEHAAAABxHREVGABQAFQAABDgAAAAeT1MvMlYNYwkAAAEgAAAAYGNtYXABDQLUAAACNAAAAUJoZWFk/xVFDQAAALwAAAA2aGhlYQdkA+oAAAD0AAAAJGhtdHgD6AAAAAAEWAAAAAZtYXhwAAJQAAAAARgAAAAGbmFtZVjmdH4AAAGAAAAAsXBvc3T/hgAzAAADeAAAACAAAQAAAAEAALZRFsRfDzz1AAsD6AAAAADOBOTLAAAAAM4KHDwAAAAAA+gDIQAAAAgAAgAAAAAAAAABAAADIQAAAFoD6AAAAAAD6AABAAAAAAAAAAAAAAAAAAAAAQAAUAAAAgAAAAQD6AH0AAUAAAKKArwAAACMAooCvAAAAeAAMQECAAACAAYJAAAAAAAAAAAAAQAAAAAAAAAAAAAAAFBmRWQAwAAuAC4DIP84AFoDIQAAAAAAAQAAAAAAAAAAACAAIAABAAAADgCuAAEAAAAAAAAAAQAAAAEAAAAAAAEAAQAAAAEAAAAAAAIAAQAAAAEAAAAAAAMAAQAAAAEAAAAAAAQAAQAAAAEAAAAAAAUAAQAAAAEAAAAAAAYAAQAAAAMAAQQJAAAAAgABAAMAAQQJAAEAAgABAAMAAQQJAAIAAgABAAMAAQQJAAMAAgABAAMAAQQJAAQAAgABAAMAAQQJAAUAAgABAAMAAQQJAAYAAgABWABYAAAAAAAAAwAAAAMAAAAcAAEAAAAAADwAAwABAAAAHAAEACAAAAAEAAQAAQAAAC7//wAAAC7////TAAEAAAAAAAABBgAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMAAAAAAAD/gwAyAAAAAQAAAAAAAAAAAAAAAAAAAAABAAQEAAEBAQJYAAEBASH4DwD4GwHEAvgcA/gXBIwMAYuL+nz5tQXkD5j3CBLnEQACAQEBIVhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYAAABAQAADwACAQEEE/t3Dov6fAH6fAT+fPp8+nwHDosMCvm1Cvm1DAz6fBQAAAAAAAABAAAAAMmJbzEAAAAAzgTjFQAAAADOBOQpAAEAAAAAAAAADAAUAAQAAAABAAAAAgABAAAAAAAAAAAD6AAAAAAAAA==");return de(this,"_loadTestFont",e)}_prepareFontLoadEvent(e,t){function s(_,y){return _.charCodeAt(y)<<24|_.charCodeAt(y+1)<<16|_.charCodeAt(y+2)<<8|_.charCodeAt(y+3)&255}function n(_,y,C,R){const S=_.substring(0,y),k=_.substring(y+C);return S+R+k}let a,o;const l=this._document.createElement("canvas");l.width=1,l.height=1;const d=l.getContext("2d");let h=0;function u(_,y){if(++h>30){re("Load test font never loaded."),y();return}if(d.font="30px "+_,d.fillText(".",0,20),d.getImageData(0,0,1,1).data[3]>0){y();return}setTimeout(u.bind(null,_,y))}const p=`lt${Date.now()}${this.loadTestFontId++}`;let m=this._loadTestFont;m=n(m,976,p.length,p);const g=16,b=1482184792;let A=s(m,g);for(a=0,o=p.length-3;a<o;a+=4)A=A-b+s(p,a)|0;a<p.length&&(A=A-b+s(p+"XXX",a)|0),m=n(m,g,4,Nx(A));const N=`url(data:font/opentype;base64,${btoa(m)});`,j=`@font-face {font-family:"${p}";src:${N}}`;this.insertRule(j);const E=this._document.createElement("div");E.style.visibility="hidden",E.style.width=E.style.height="10px",E.style.position="absolute",E.style.top=E.style.left="0px";for(const _ of[e.loadedName,p]){const y=this._document.createElement("span");y.textContent="Hi",y.style.fontFamily=_,E.append(y)}this._document.body.append(E),u(p,()=>{E.remove(),t.complete()})}}gr=new WeakMap;class Ox{constructor(e,{disableFontFace:t=!1,fontExtraProperties:s=!1,inspectFont:n=null}){this.compiledGlyphs=Object.create(null);for(const a in e)this[a]=e[a];this.disableFontFace=t===!0,this.fontExtraProperties=s===!0,this._inspectFont=n}createNativeFontFace(){var t;if(!this.data||this.disableFontFace)return null;let e;if(!this.cssFontInfo)e=new FontFace(this.loadedName,this.data,{});else{const s={weight:this.cssFontInfo.fontWeight};this.cssFontInfo.italicAngle&&(s.style=`oblique ${this.cssFontInfo.italicAngle}deg`),e=new FontFace(this.cssFontInfo.fontFamily,this.data,s)}return(t=this._inspectFont)==null||t.call(this,this),e}createFontFaceRule(){var s;if(!this.data||this.disableFontFace)return null;const e=`url(data:${this.mimetype};base64,${Ex(this.data)});`;let t;if(!this.cssFontInfo)t=`@font-face {font-family:"${this.loadedName}";src:${e}}`;else{let n=`font-weight: ${this.cssFontInfo.fontWeight};`;this.cssFontInfo.italicAngle&&(n+=`font-style: oblique ${this.cssFontInfo.italicAngle}deg;`),t=`@font-face {font-family:"${this.cssFontInfo.fontFamily}";${n}src:${e}}`}return(s=this._inspectFont)==null||s.call(this,this,e),t}getPathGenerator(e,t){if(this.compiledGlyphs[t]!==void 0)return this.compiledGlyphs[t];const s=this.loadedName+"_path_"+t;let n;try{n=e.get(s)}catch(o){re(`getPathGenerator - ignoring character: "${o}".`)}const a=new Path2D(n||"");return this.fontExtraProperties||e.delete(s),this.compiledGlyphs[t]=a}}const gc={DATA:1,ERROR:2},Be={CANCEL:1,CANCEL_COMPLETE:2,CLOSE:3,ENQUEUE:4,ERROR:5,PULL:6,PULL_COMPLETE:7,START_COMPLETE:8};function Zu(){}function Tt(c){if(c instanceof jn||c instanceof Zd||c instanceof Fo||c instanceof Xu||c instanceof nd||c instanceof zd)return c;switch(c instanceof Error||typeof c=="object"&&c!==null||Ae('wrapReason: Expected "reason" to be a (possibly cloned) Error.'),c.name){case"AbortException":return new jn(c.message);case"InvalidPDFException":return new Zd(c.message);case"MissingPDFException":return new Fo(c.message);case"PasswordException":return new Xu(c.message,c.code);case"UnexpectedResponseException":return new nd(c.message,c.status);case"UnknownErrorException":return new zd(c.message,c.details)}return new zd(c.message,c.toString())}var xr,ds,vm,ym,wm,Lc;class vo{constructor(e,t,s){v(this,ds);v(this,xr,new AbortController);this.sourceName=e,this.targetName=t,this.comObj=s,this.callbackId=1,this.streamId=1,this.streamSinks=Object.create(null),this.streamControllers=Object.create(null),this.callbackCapabilities=Object.create(null),this.actionHandler=Object.create(null),s.addEventListener("message",w(this,ds,vm).bind(this),{signal:r(this,xr).signal})}on(e,t){const s=this.actionHandler;if(s[e])throw new Error(`There is already an actionName called "${e}"`);s[e]=t}send(e,t,s){this.comObj.postMessage({sourceName:this.sourceName,targetName:this.targetName,action:e,data:t},s)}sendWithPromise(e,t,s){const n=this.callbackId++,a=Promise.withResolvers();this.callbackCapabilities[n]=a;try{this.comObj.postMessage({sourceName:this.sourceName,targetName:this.targetName,action:e,callbackId:n,data:t},s)}catch(o){a.reject(o)}return a.promise}sendWithStream(e,t,s,n){const a=this.streamId++,o=this.sourceName,l=this.targetName,d=this.comObj;return new ReadableStream({start:h=>{const u=Promise.withResolvers();return this.streamControllers[a]={controller:h,startCall:u,pullCall:null,cancelCall:null,isClosed:!1},d.postMessage({sourceName:o,targetName:l,action:e,streamId:a,data:t,desiredSize:h.desiredSize},n),u.promise},pull:h=>{const u=Promise.withResolvers();return this.streamControllers[a].pullCall=u,d.postMessage({sourceName:o,targetName:l,stream:Be.PULL,streamId:a,desiredSize:h.desiredSize}),u.promise},cancel:h=>{ze(h instanceof Error,"cancel must have a valid reason");const u=Promise.withResolvers();return this.streamControllers[a].cancelCall=u,this.streamControllers[a].isClosed=!0,d.postMessage({sourceName:o,targetName:l,stream:Be.CANCEL,streamId:a,reason:Tt(h)}),u.promise}},s)}destroy(){var e;(e=r(this,xr))==null||e.abort(),x(this,xr,null)}}xr=new WeakMap,ds=new WeakSet,vm=function({data:e}){if(e.targetName!==this.sourceName)return;if(e.stream){w(this,ds,wm).call(this,e);return}if(e.callback){const s=e.callbackId,n=this.callbackCapabilities[s];if(!n)throw new Error(`Cannot resolve callback ${s}`);if(delete this.callbackCapabilities[s],e.callback===gc.DATA)n.resolve(e.data);else if(e.callback===gc.ERROR)n.reject(Tt(e.reason));else throw new Error("Unexpected callback case");return}const t=this.actionHandler[e.action];if(!t)throw new Error(`Unknown action from worker: ${e.action}`);if(e.callbackId){const s=this.sourceName,n=e.sourceName,a=this.comObj;Promise.try(t,e.data).then(function(o){a.postMessage({sourceName:s,targetName:n,callback:gc.DATA,callbackId:e.callbackId,data:o})},function(o){a.postMessage({sourceName:s,targetName:n,callback:gc.ERROR,callbackId:e.callbackId,reason:Tt(o)})});return}if(e.streamId){w(this,ds,ym).call(this,e);return}t(e.data)},ym=function(e){const t=e.streamId,s=this.sourceName,n=e.sourceName,a=this.comObj,o=this,l=this.actionHandler[e.action],d={enqueue(h,u=1,p){if(this.isCancelled)return;const m=this.desiredSize;this.desiredSize-=u,m>0&&this.desiredSize<=0&&(this.sinkCapability=Promise.withResolvers(),this.ready=this.sinkCapability.promise),a.postMessage({sourceName:s,targetName:n,stream:Be.ENQUEUE,streamId:t,chunk:h},p)},close(){this.isCancelled||(this.isCancelled=!0,a.postMessage({sourceName:s,targetName:n,stream:Be.CLOSE,streamId:t}),delete o.streamSinks[t])},error(h){ze(h instanceof Error,"error must have a valid reason"),!this.isCancelled&&(this.isCancelled=!0,a.postMessage({sourceName:s,targetName:n,stream:Be.ERROR,streamId:t,reason:Tt(h)}))},sinkCapability:Promise.withResolvers(),onPull:null,onCancel:null,isCancelled:!1,desiredSize:e.desiredSize,ready:null};d.sinkCapability.resolve(),d.ready=d.sinkCapability.promise,this.streamSinks[t]=d,Promise.try(l,e.data,d).then(function(){a.postMessage({sourceName:s,targetName:n,stream:Be.START_COMPLETE,streamId:t,success:!0})},function(h){a.postMessage({sourceName:s,targetName:n,stream:Be.START_COMPLETE,streamId:t,reason:Tt(h)})})},wm=function(e){const t=e.streamId,s=this.sourceName,n=e.sourceName,a=this.comObj,o=this.streamControllers[t],l=this.streamSinks[t];switch(e.stream){case Be.START_COMPLETE:e.success?o.startCall.resolve():o.startCall.reject(Tt(e.reason));break;case Be.PULL_COMPLETE:e.success?o.pullCall.resolve():o.pullCall.reject(Tt(e.reason));break;case Be.PULL:if(!l){a.postMessage({sourceName:s,targetName:n,stream:Be.PULL_COMPLETE,streamId:t,success:!0});break}l.desiredSize<=0&&e.desiredSize>0&&l.sinkCapability.resolve(),l.desiredSize=e.desiredSize,Promise.try(l.onPull||Zu).then(function(){a.postMessage({sourceName:s,targetName:n,stream:Be.PULL_COMPLETE,streamId:t,success:!0})},function(h){a.postMessage({sourceName:s,targetName:n,stream:Be.PULL_COMPLETE,streamId:t,reason:Tt(h)})});break;case Be.ENQUEUE:if(ze(o,"enqueue should have stream controller"),o.isClosed)break;o.controller.enqueue(e.chunk);break;case Be.CLOSE:if(ze(o,"close should have stream controller"),o.isClosed)break;o.isClosed=!0,o.controller.close(),w(this,ds,Lc).call(this,o,t);break;case Be.ERROR:ze(o,"error should have stream controller"),o.controller.error(Tt(e.reason)),w(this,ds,Lc).call(this,o,t);break;case Be.CANCEL_COMPLETE:e.success?o.cancelCall.resolve():o.cancelCall.reject(Tt(e.reason)),w(this,ds,Lc).call(this,o,t);break;case Be.CANCEL:if(!l)break;const d=Tt(e.reason);Promise.try(l.onCancel||Zu,d).then(function(){a.postMessage({sourceName:s,targetName:n,stream:Be.CANCEL_COMPLETE,streamId:t,success:!0})},function(h){a.postMessage({sourceName:s,targetName:n,stream:Be.CANCEL_COMPLETE,streamId:t,reason:Tt(h)})}),l.sinkCapability.reject(d),l.isCancelled=!0,delete this.streamSinks[t];break;default:throw new Error("Unexpected stream case")}},Lc=async function(e,t){var s,n,a;await Promise.allSettled([(s=e.startCall)==null?void 0:s.promise,(n=e.pullCall)==null?void 0:n.promise,(a=e.cancelCall)==null?void 0:a.promise]),delete this.streamControllers[t]};var pl;class Nm{constructor({enableHWA:e=!1}){v(this,pl,!1);x(this,pl,e)}create(e,t){if(e<=0||t<=0)throw new Error("Invalid canvas size");const s=this._createCanvas(e,t);return{canvas:s,context:s.getContext("2d",{willReadFrequently:!r(this,pl)})}}reset(e,t,s){if(!e.canvas)throw new Error("Canvas is not specified");if(t<=0||s<=0)throw new Error("Invalid canvas size");e.canvas.width=t,e.canvas.height=s}destroy(e){if(!e.canvas)throw new Error("Canvas is not specified");e.canvas.width=0,e.canvas.height=0,e.canvas=null,e.context=null}_createCanvas(e,t){Ae("Abstract method `_createCanvas` called.")}}pl=new WeakMap;class $x extends Nm{constructor({ownerDocument:e=globalThis.document,enableHWA:t=!1}){super({enableHWA:t}),this._document=e}_createCanvas(e,t){const s=this._document.createElement("canvas");return s.width=e,s.height=t,s}}class jm{constructor({baseUrl:e=null,isCompressed:t=!0}){this.baseUrl=e,this.isCompressed=t}async fetch({name:e}){if(!this.baseUrl)throw new Error("Ensure that the `cMapUrl` and `cMapPacked` API parameters are provided.");if(!e)throw new Error("CMap name must be specified.");const t=this.baseUrl+e+(this.isCompressed?".bcmap":"");return this._fetch(t).then(s=>({cMapData:s,isCompressed:this.isCompressed})).catch(s=>{throw new Error(`Unable to load ${this.isCompressed?"binary ":""}CMap at: ${t}`)})}async _fetch(e){Ae("Abstract method `_fetch` called.")}}class Am extends jm{async _fetch(e){const t=await Dd(e,this.isCompressed?"arraybuffer":"text");return t instanceof ArrayBuffer?new Uint8Array(t):Ld(t)}}class _m{addFilter(e){return"none"}addHCMFilter(e,t){return"none"}addAlphaFilter(e){return"none"}addLuminosityFilter(e){return"none"}addHighlightHCMFilter(e,t,s,n,a){return"none"}destroy(e=!1){}}var Zn,br,gi,xi,ht,Jn,ea,B,lt,yo,Ga,Dc,Va,Sm,yh,Wa,wo,No,wh,jo;class Hx extends _m{constructor({docId:t,ownerDocument:s=globalThis.document}){super();v(this,B);v(this,Zn);v(this,br);v(this,gi);v(this,xi);v(this,ht);v(this,Jn);v(this,ea,0);x(this,xi,t),x(this,ht,s)}addFilter(t){if(!t)return"none";let s=r(this,B,lt).get(t);if(s)return s;const[n,a,o]=w(this,B,Dc).call(this,t),l=t.length===1?n:`${n}${a}${o}`;if(s=r(this,B,lt).get(l),s)return r(this,B,lt).set(t,s),s;const d=`g_${r(this,xi)}_transfer_map_${bt(this,ea)._++}`,h=w(this,B,Va).call(this,d);r(this,B,lt).set(t,h),r(this,B,lt).set(l,h);const u=w(this,B,Wa).call(this,d);return w(this,B,No).call(this,n,a,o,u),h}addHCMFilter(t,s){var g;const n=`${t}-${s}`,a="base";let o=r(this,B,yo).get(a);if((o==null?void 0:o.key)===n||(o?((g=o.filter)==null||g.remove(),o.key=n,o.url="none",o.filter=null):(o={key:n,url:"none",filter:null},r(this,B,yo).set(a,o)),!t||!s))return o.url;const l=w(this,B,jo).call(this,t);t=X.makeHexColor(...l);const d=w(this,B,jo).call(this,s);if(s=X.makeHexColor(...d),r(this,B,Ga).style.color="",t==="#000000"&&s==="#ffffff"||t===s)return o.url;const h=new Array(256);for(let b=0;b<=255;b++){const A=b/255;h[b]=A<=.03928?A/12.92:((A+.055)/1.055)**2.4}const u=h.join(","),p=`g_${r(this,xi)}_hcm_filter`,m=o.filter=w(this,B,Wa).call(this,p);w(this,B,No).call(this,u,u,u,m),w(this,B,yh).call(this,m);const f=(b,A)=>{const N=l[b]/255,j=d[b]/255,E=new Array(A+1);for(let _=0;_<=A;_++)E[_]=N+_/A*(j-N);return E.join(",")};return w(this,B,No).call(this,f(0,5),f(1,5),f(2,5),m),o.url=w(this,B,Va).call(this,p),o.url}addAlphaFilter(t){let s=r(this,B,lt).get(t);if(s)return s;const[n]=w(this,B,Dc).call(this,[t]),a=`alpha_${n}`;if(s=r(this,B,lt).get(a),s)return r(this,B,lt).set(t,s),s;const o=`g_${r(this,xi)}_alpha_map_${bt(this,ea)._++}`,l=w(this,B,Va).call(this,o);r(this,B,lt).set(t,l),r(this,B,lt).set(a,l);const d=w(this,B,Wa).call(this,o);return w(this,B,wh).call(this,n,d),l}addLuminosityFilter(t){let s=r(this,B,lt).get(t||"luminosity");if(s)return s;let n,a;if(t?([n]=w(this,B,Dc).call(this,[t]),a=`luminosity_${n}`):a="luminosity",s=r(this,B,lt).get(a),s)return r(this,B,lt).set(t,s),s;const o=`g_${r(this,xi)}_luminosity_map_${bt(this,ea)._++}`,l=w(this,B,Va).call(this,o);r(this,B,lt).set(t,l),r(this,B,lt).set(a,l);const d=w(this,B,Wa).call(this,o);return w(this,B,Sm).call(this,d),t&&w(this,B,wh).call(this,n,d),l}addHighlightHCMFilter(t,s,n,a,o){var j;const l=`${s}-${n}-${a}-${o}`;let d=r(this,B,yo).get(t);if((d==null?void 0:d.key)===l||(d?((j=d.filter)==null||j.remove(),d.key=l,d.url="none",d.filter=null):(d={key:l,url:"none",filter:null},r(this,B,yo).set(t,d)),!s||!n))return d.url;const[h,u]=[s,n].map(w(this,B,jo).bind(this));let p=Math.round(.2126*h[0]+.7152*h[1]+.0722*h[2]),m=Math.round(.2126*u[0]+.7152*u[1]+.0722*u[2]),[f,g]=[a,o].map(w(this,B,jo).bind(this));m<p&&([p,m,f,g]=[m,p,g,f]),r(this,B,Ga).style.color="";const b=(E,_,y)=>{const C=new Array(256),R=(m-p)/y,S=E/255,k=(_-E)/(255*y);let M=0;for(let L=0;L<=y;L++){const O=Math.round(p+L*R),$=S+L*k;for(let q=M;q<=O;q++)C[q]=$;M=O+1}for(let L=M;L<256;L++)C[L]=C[M-1];return C.join(",")},A=`g_${r(this,xi)}_hcm_${t}_filter`,N=d.filter=w(this,B,Wa).call(this,A);return w(this,B,yh).call(this,N),w(this,B,No).call(this,b(f[0],g[0],5),b(f[1],g[1],5),b(f[2],g[2],5),N),d.url=w(this,B,Va).call(this,A),d.url}destroy(t=!1){var s,n,a,o;t&&((s=r(this,Jn))!=null&&s.size)||((n=r(this,gi))==null||n.parentNode.parentNode.remove(),x(this,gi,null),(a=r(this,br))==null||a.clear(),x(this,br,null),(o=r(this,Jn))==null||o.clear(),x(this,Jn,null),x(this,ea,0))}}Zn=new WeakMap,br=new WeakMap,gi=new WeakMap,xi=new WeakMap,ht=new WeakMap,Jn=new WeakMap,ea=new WeakMap,B=new WeakSet,lt=function(){return r(this,br)||x(this,br,new Map)},yo=function(){return r(this,Jn)||x(this,Jn,new Map)},Ga=function(){if(!r(this,gi)){const t=r(this,ht).createElement("div"),{style:s}=t;s.visibility="hidden",s.contain="strict",s.width=s.height=0,s.position="absolute",s.top=s.left=0,s.zIndex=-1;const n=r(this,ht).createElementNS(ni,"svg");n.setAttribute("width",0),n.setAttribute("height",0),x(this,gi,r(this,ht).createElementNS(ni,"defs")),t.append(n),n.append(r(this,gi)),r(this,ht).body.append(t)}return r(this,gi)},Dc=function(t){if(t.length===1){const h=t[0],u=new Array(256);for(let m=0;m<256;m++)u[m]=h[m]/255;const p=u.join(",");return[p,p,p]}const[s,n,a]=t,o=new Array(256),l=new Array(256),d=new Array(256);for(let h=0;h<256;h++)o[h]=s[h]/255,l[h]=n[h]/255,d[h]=a[h]/255;return[o.join(","),l.join(","),d.join(",")]},Va=function(t){if(r(this,Zn)===void 0){x(this,Zn,"");const s=r(this,ht).URL;s!==r(this,ht).baseURI&&(Fd(s)?re('#createUrl: ignore "data:"-URL for performance reasons.'):x(this,Zn,s.split("#",1)[0]))}return`url(${r(this,Zn)}#${t})`},Sm=function(t){const s=r(this,ht).createElementNS(ni,"feColorMatrix");s.setAttribute("type","matrix"),s.setAttribute("values","0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.3 0.59 0.11 0 0"),t.append(s)},yh=function(t){const s=r(this,ht).createElementNS(ni,"feColorMatrix");s.setAttribute("type","matrix"),s.setAttribute("values","0.2126 0.7152 0.0722 0 0 0.2126 0.7152 0.0722 0 0 0.2126 0.7152 0.0722 0 0 0 0 0 1 0"),t.append(s)},Wa=function(t){const s=r(this,ht).createElementNS(ni,"filter");return s.setAttribute("color-interpolation-filters","sRGB"),s.setAttribute("id",t),r(this,B,Ga).append(s),s},wo=function(t,s,n){const a=r(this,ht).createElementNS(ni,s);a.setAttribute("type","discrete"),a.setAttribute("tableValues",n),t.append(a)},No=function(t,s,n,a){const o=r(this,ht).createElementNS(ni,"feComponentTransfer");a.append(o),w(this,B,wo).call(this,o,"feFuncR",t),w(this,B,wo).call(this,o,"feFuncG",s),w(this,B,wo).call(this,o,"feFuncB",n)},wh=function(t,s){const n=r(this,ht).createElementNS(ni,"feComponentTransfer");s.append(n),w(this,B,wo).call(this,n,"feFuncA",t)},jo=function(t){return r(this,B,Ga).style.color=t,wu(getComputedStyle(r(this,B,Ga)).getPropertyValue("color"))};class Cm{constructor({baseUrl:e=null}){this.baseUrl=e}async fetch({filename:e}){if(!this.baseUrl)throw new Error("Ensure that the `standardFontDataUrl` API parameter is provided.");if(!e)throw new Error("Font filename must be specified.");const t=`${this.baseUrl}${e}`;return this._fetch(t).catch(s=>{throw new Error(`Unable to load font data at: ${t}`)})}async _fetch(e){Ae("Abstract method `_fetch` called.")}}class Em extends Cm{async _fetch(e){const t=await Dd(e,"arraybuffer");return new Uint8Array(t)}}ft&&re("Please use the `legacy` build in Node.js environments.");async function km(c){const t=await process.getBuiltinModule("fs").promises.readFile(c);return new Uint8Array(t)}class Bx extends _m{}class zx extends Nm{_createCanvas(e,t){return process.getBuiltinModule("module").createRequire(import.meta.url)("@napi-rs/canvas").createCanvas(e,t)}}class Ux extends jm{async _fetch(e){return km(e)}}class Gx extends Cm{async _fetch(e){return km(e)}}const mt={FILL:"Fill",STROKE:"Stroke",SHADING:"Shading"};function Nh(c,e){if(!e)return;const t=e[2]-e[0],s=e[3]-e[1],n=new Path2D;n.rect(e[0],e[1],t,s),c.clip(n)}class ju{getPattern(){Ae("Abstract method `getPattern` called.")}}class Vx extends ju{constructor(e){super(),this._type=e[1],this._bbox=e[2],this._colorStops=e[3],this._p0=e[4],this._p1=e[5],this._r0=e[6],this._r1=e[7],this.matrix=null}_createGradient(e){let t;this._type==="axial"?t=e.createLinearGradient(this._p0[0],this._p0[1],this._p1[0],this._p1[1]):this._type==="radial"&&(t=e.createRadialGradient(this._p0[0],this._p0[1],this._r0,this._p1[0],this._p1[1],this._r1));for(const s of this._colorStops)t.addColorStop(s[0],s[1]);return t}getPattern(e,t,s,n){let a;if(n===mt.STROKE||n===mt.FILL){const o=t.current.getClippedPathBoundingBox(n,Re(e))||[0,0,0,0],l=Math.ceil(o[2]-o[0])||1,d=Math.ceil(o[3]-o[1])||1,h=t.cachedCanvases.getCanvas("pattern",l,d),u=h.context;u.clearRect(0,0,u.canvas.width,u.canvas.height),u.beginPath(),u.rect(0,0,u.canvas.width,u.canvas.height),u.translate(-o[0],-o[1]),s=X.transform(s,[1,0,0,1,o[0],o[1]]),u.transform(...t.baseTransform),this.matrix&&u.transform(...this.matrix),Nh(u,this._bbox),u.fillStyle=this._createGradient(u),u.fill(),a=e.createPattern(h.canvas,"no-repeat");const p=new DOMMatrix(s);a.setTransform(p)}else Nh(e,this._bbox),a=this._createGradient(e);return a}}function Vd(c,e,t,s,n,a,o,l){const d=e.coords,h=e.colors,u=c.data,p=c.width*4;let m;d[t+1]>d[s+1]&&(m=t,t=s,s=m,m=a,a=o,o=m),d[s+1]>d[n+1]&&(m=s,s=n,n=m,m=o,o=l,l=m),d[t+1]>d[s+1]&&(m=t,t=s,s=m,m=a,a=o,o=m);const f=(d[t]+e.offsetX)*e.scaleX,g=(d[t+1]+e.offsetY)*e.scaleY,b=(d[s]+e.offsetX)*e.scaleX,A=(d[s+1]+e.offsetY)*e.scaleY,N=(d[n]+e.offsetX)*e.scaleX,j=(d[n+1]+e.offsetY)*e.scaleY;if(g>=j)return;const E=h[a],_=h[a+1],y=h[a+2],C=h[o],R=h[o+1],S=h[o+2],k=h[l],M=h[l+1],L=h[l+2],O=Math.round(g),$=Math.round(j);let q,F,P,I,K,ie,ue,te;for(let V=O;V<=$;V++){if(V<A){const he=V<g?0:(g-V)/(g-A);q=f-(f-b)*he,F=E-(E-C)*he,P=_-(_-R)*he,I=y-(y-S)*he}else{let he;V>j?he=1:A===j?he=0:he=(A-V)/(A-j),q=b-(b-N)*he,F=C-(C-k)*he,P=R-(R-M)*he,I=S-(S-L)*he}let le;V<g?le=0:V>j?le=1:le=(g-V)/(g-j),K=f-(f-N)*le,ie=E-(E-k)*le,ue=_-(_-M)*le,te=y-(y-L)*le;const ye=Math.round(Math.min(q,K)),z=Math.round(Math.max(q,K));let Se=p*V+ye*4;for(let he=ye;he<=z;he++)le=(q-he)/(q-K),le<0?le=0:le>1&&(le=1),u[Se++]=F-(F-ie)*le|0,u[Se++]=P-(P-ue)*le|0,u[Se++]=I-(I-te)*le|0,u[Se++]=255}}function Wx(c,e,t){const s=e.coords,n=e.colors;let a,o;switch(e.type){case"lattice":const l=e.verticesPerRow,d=Math.floor(s.length/l)-1,h=l-1;for(a=0;a<d;a++){let u=a*l;for(let p=0;p<h;p++,u++)Vd(c,t,s[u],s[u+1],s[u+l],n[u],n[u+1],n[u+l]),Vd(c,t,s[u+l+1],s[u+1],s[u+l],n[u+l+1],n[u+1],n[u+l])}break;case"triangles":for(a=0,o=s.length;a<o;a+=3)Vd(c,t,s[a],s[a+1],s[a+2],n[a],n[a+1],n[a+2]);break;default:throw new Error("illegal figure")}}class qx extends ju{constructor(e){super(),this._coords=e[2],this._colors=e[3],this._figures=e[4],this._bounds=e[5],this._bbox=e[7],this._background=e[8],this.matrix=null}_createMeshCanvas(e,t,s){const l=Math.floor(this._bounds[0]),d=Math.floor(this._bounds[1]),h=Math.ceil(this._bounds[2])-l,u=Math.ceil(this._bounds[3])-d,p=Math.min(Math.ceil(Math.abs(h*e[0]*1.1)),3e3),m=Math.min(Math.ceil(Math.abs(u*e[1]*1.1)),3e3),f=h/p,g=u/m,b={coords:this._coords,colors:this._colors,offsetX:-l,offsetY:-d,scaleX:1/f,scaleY:1/g},A=p+2*2,N=m+2*2,j=s.getCanvas("mesh",A,N),E=j.context,_=E.createImageData(p,m);if(t){const C=_.data;for(let R=0,S=C.length;R<S;R+=4)C[R]=t[0],C[R+1]=t[1],C[R+2]=t[2],C[R+3]=255}for(const C of this._figures)Wx(_,C,b);return E.putImageData(_,2,2),{canvas:j.canvas,offsetX:l-2*f,offsetY:d-2*g,scaleX:f,scaleY:g}}getPattern(e,t,s,n){Nh(e,this._bbox);let a;if(n===mt.SHADING)a=X.singularValueDecompose2dScale(Re(e));else if(a=X.singularValueDecompose2dScale(t.baseTransform),this.matrix){const l=X.singularValueDecompose2dScale(this.matrix);a=[a[0]*l[0],a[1]*l[1]]}const o=this._createMeshCanvas(a,n===mt.SHADING?null:this._background,t.cachedCanvases);return n!==mt.SHADING&&(e.setTransform(...t.baseTransform),this.matrix&&e.transform(...this.matrix)),e.translate(o.offsetX,o.offsetY),e.scale(o.scaleX,o.scaleY),e.createPattern(o.canvas,"no-repeat")}}class Xx extends ju{getPattern(){return"hotpink"}}function Yx(c){switch(c[0]){case"RadialAxial":return new Vx(c);case"Mesh":return new qx(c);case"Dummy":return new Xx}throw new Error(`Unknown IR type: ${c[0]}`)}const Ju={COLORED:1,UNCOLORED:2},vd=class vd{constructor(e,t,s,n,a){this.operatorList=e[2],this.matrix=e[3],this.bbox=e[4],this.xstep=e[5],this.ystep=e[6],this.paintType=e[7],this.tilingType=e[8],this.color=t,this.ctx=s,this.canvasGraphicsFactory=n,this.baseTransform=a}createPatternCanvas(e){const{bbox:t,operatorList:s,paintType:n,tilingType:a,color:o,canvasGraphicsFactory:l}=this;let{xstep:d,ystep:h}=this;d=Math.abs(d),h=Math.abs(h),Id("TilingType: "+a);const u=t[0],p=t[1],m=t[2],f=t[3],g=m-u,b=f-p,A=X.singularValueDecompose2dScale(this.matrix),N=X.singularValueDecompose2dScale(this.baseTransform),j=A[0]*N[0],E=A[1]*N[1];let _=g,y=b,C=!1,R=!1;const S=Math.ceil(d*j),k=Math.ceil(h*E),M=Math.ceil(g*j),L=Math.ceil(b*E);S>=M?_=d:C=!0,k>=L?y=h:R=!0;const O=this.getSizeAndScale(_,this.ctx.canvas.width,j),$=this.getSizeAndScale(y,this.ctx.canvas.height,E),q=e.cachedCanvases.getCanvas("pattern",O.size,$.size),F=q.context,P=l.createCanvasGraphics(F);if(P.groupLevel=e.groupLevel,this.setFillAndStrokeStyleToContext(P,n,o),F.translate(-O.scale*u,-$.scale*p),P.transform(O.scale,0,0,$.scale,0,0),F.save(),this.clipBbox(P,u,p,m,f),P.baseTransform=Re(P.ctx),P.executeOperatorList(s),P.endDrawing(),F.restore(),C||R){const I=q.canvas;C&&(_=d),R&&(y=h);const K=this.getSizeAndScale(_,this.ctx.canvas.width,j),ie=this.getSizeAndScale(y,this.ctx.canvas.height,E),ue=K.size,te=ie.size,V=e.cachedCanvases.getCanvas("pattern-workaround",ue,te),le=V.context,ye=C?Math.floor(g/d):0,z=R?Math.floor(b/h):0;for(let Se=0;Se<=ye;Se++)for(let he=0;he<=z;he++)le.drawImage(I,ue*Se,te*he,ue,te,0,0,ue,te);return{canvas:V.canvas,scaleX:K.scale,scaleY:ie.scale,offsetX:u,offsetY:p}}return{canvas:q.canvas,scaleX:O.scale,scaleY:$.scale,offsetX:u,offsetY:p}}getSizeAndScale(e,t,s){const n=Math.max(vd.MAX_PATTERN_SIZE,t);let a=Math.ceil(e*s);return a>=n?a=n:s=a/e,{scale:s,size:a}}clipBbox(e,t,s,n,a){const o=n-t,l=a-s;e.ctx.rect(t,s,o,l),e.current.updateRectMinMax(Re(e.ctx),[t,s,n,a]),e.clip(),e.endPath()}setFillAndStrokeStyleToContext(e,t,s){const n=e.ctx,a=e.current;switch(t){case Ju.COLORED:const o=this.ctx;n.fillStyle=o.fillStyle,n.strokeStyle=o.strokeStyle,a.fillColor=o.fillStyle,a.strokeColor=o.strokeStyle;break;case Ju.UNCOLORED:const l=X.makeHexColor(s[0],s[1],s[2]);n.fillStyle=l,n.strokeStyle=l,a.fillColor=l,a.strokeColor=l;break;default:throw new wx(`Unsupported paint type: ${t}`)}}getPattern(e,t,s,n){let a=s;n!==mt.SHADING&&(a=X.transform(a,t.baseTransform),this.matrix&&(a=X.transform(a,this.matrix)));const o=this.createPatternCanvas(t);let l=new DOMMatrix(a);l=l.translate(o.offsetX,o.offsetY),l=l.scale(1/o.scaleX,1/o.scaleY);const d=e.createPattern(o.canvas,"repeat");return d.setTransform(l),d}};Z(vd,"MAX_PATTERN_SIZE",3e3);let jh=vd;function Kx({src:c,srcPos:e=0,dest:t,width:s,height:n,nonBlackColor:a=4294967295,inverseDecode:o=!1}){const l=At.isLittleEndian?4278190080:255,[d,h]=o?[a,l]:[l,a],u=s>>3,p=s&7,m=c.length;t=new Uint32Array(t.buffer);let f=0;for(let g=0;g<n;g++){for(const A=e+u;e<A;e++){const N=e<m?c[e]:255;t[f++]=N&128?h:d,t[f++]=N&64?h:d,t[f++]=N&32?h:d,t[f++]=N&16?h:d,t[f++]=N&8?h:d,t[f++]=N&4?h:d,t[f++]=N&2?h:d,t[f++]=N&1?h:d}if(p===0)continue;const b=e<m?c[e++]:255;for(let A=0;A<p;A++)t[f++]=b&1<<7-A?h:d}return{srcPos:e,destPos:f}}const ep=16,tp=100,Qx=15,sp=10,ip=1e3,Lt=16;function Zx(c,e){if(c._removeMirroring)throw new Error("Context is already forwarding operations.");c.__originalSave=c.save,c.__originalRestore=c.restore,c.__originalRotate=c.rotate,c.__originalScale=c.scale,c.__originalTranslate=c.translate,c.__originalTransform=c.transform,c.__originalSetTransform=c.setTransform,c.__originalResetTransform=c.resetTransform,c.__originalClip=c.clip,c.__originalMoveTo=c.moveTo,c.__originalLineTo=c.lineTo,c.__originalBezierCurveTo=c.bezierCurveTo,c.__originalRect=c.rect,c.__originalClosePath=c.closePath,c.__originalBeginPath=c.beginPath,c._removeMirroring=()=>{c.save=c.__originalSave,c.restore=c.__originalRestore,c.rotate=c.__originalRotate,c.scale=c.__originalScale,c.translate=c.__originalTranslate,c.transform=c.__originalTransform,c.setTransform=c.__originalSetTransform,c.resetTransform=c.__originalResetTransform,c.clip=c.__originalClip,c.moveTo=c.__originalMoveTo,c.lineTo=c.__originalLineTo,c.bezierCurveTo=c.__originalBezierCurveTo,c.rect=c.__originalRect,c.closePath=c.__originalClosePath,c.beginPath=c.__originalBeginPath,delete c._removeMirroring},c.save=function(){e.save(),this.__originalSave()},c.restore=function(){e.restore(),this.__originalRestore()},c.translate=function(s,n){e.translate(s,n),this.__originalTranslate(s,n)},c.scale=function(s,n){e.scale(s,n),this.__originalScale(s,n)},c.transform=function(s,n,a,o,l,d){e.transform(s,n,a,o,l,d),this.__originalTransform(s,n,a,o,l,d)},c.setTransform=function(s,n,a,o,l,d){e.setTransform(s,n,a,o,l,d),this.__originalSetTransform(s,n,a,o,l,d)},c.resetTransform=function(){e.resetTransform(),this.__originalResetTransform()},c.rotate=function(s){e.rotate(s),this.__originalRotate(s)},c.clip=function(s){e.clip(s),this.__originalClip(s)},c.moveTo=function(t,s){e.moveTo(t,s),this.__originalMoveTo(t,s)},c.lineTo=function(t,s){e.lineTo(t,s),this.__originalLineTo(t,s)},c.bezierCurveTo=function(t,s,n,a,o,l){e.bezierCurveTo(t,s,n,a,o,l),this.__originalBezierCurveTo(t,s,n,a,o,l)},c.rect=function(t,s,n,a){e.rect(t,s,n,a),this.__originalRect(t,s,n,a)},c.closePath=function(){e.closePath(),this.__originalClosePath()},c.beginPath=function(){e.beginPath(),this.__originalBeginPath()}}class Jx{constructor(e){this.canvasFactory=e,this.cache=Object.create(null)}getCanvas(e,t,s){let n;return this.cache[e]!==void 0?(n=this.cache[e],this.canvasFactory.reset(n,t,s)):(n=this.canvasFactory.create(t,s),this.cache[e]=n),n}delete(e){delete this.cache[e]}clear(){for(const e in this.cache){const t=this.cache[e];this.canvasFactory.destroy(t),delete this.cache[e]}}}function xc(c,e,t,s,n,a,o,l,d,h){const[u,p,m,f,g,b]=Re(c);if(p===0&&m===0){const j=o*u+g,E=Math.round(j),_=l*f+b,y=Math.round(_),C=(o+d)*u+g,R=Math.abs(Math.round(C)-E)||1,S=(l+h)*f+b,k=Math.abs(Math.round(S)-y)||1;return c.setTransform(Math.sign(u),0,0,Math.sign(f),E,y),c.drawImage(e,t,s,n,a,0,0,R,k),c.setTransform(u,p,m,f,g,b),[R,k]}if(u===0&&f===0){const j=l*m+g,E=Math.round(j),_=o*p+b,y=Math.round(_),C=(l+h)*m+g,R=Math.abs(Math.round(C)-E)||1,S=(o+d)*p+b,k=Math.abs(Math.round(S)-y)||1;return c.setTransform(0,Math.sign(p),Math.sign(m),0,E,y),c.drawImage(e,t,s,n,a,0,0,k,R),c.setTransform(u,p,m,f,g,b),[k,R]}c.drawImage(e,t,s,n,a,o,l,d,h);const A=Math.hypot(u,p),N=Math.hypot(m,f);return[A*d,N*h]}function e0(c){const{width:e,height:t}=c;if(e>ip||t>ip)return null;const s=1e3,n=new Uint8Array([0,2,4,0,1,0,5,4,8,10,0,8,0,2,1,0]),a=e+1;let o=new Uint8Array(a*(t+1)),l,d,h;const u=e+7&-8;let p=new Uint8Array(u*t),m=0;for(const N of c.data){let j=128;for(;j>0;)p[m++]=N&j?0:255,j>>=1}let f=0;for(m=0,p[m]!==0&&(o[0]=1,++f),d=1;d<e;d++)p[m]!==p[m+1]&&(o[d]=p[m]?2:1,++f),m++;for(p[m]!==0&&(o[d]=2,++f),l=1;l<t;l++){m=l*u,h=l*a,p[m-u]!==p[m]&&(o[h]=p[m]?1:8,++f);let N=(p[m]?4:0)+(p[m-u]?8:0);for(d=1;d<e;d++)N=(N>>2)+(p[m+1]?4:0)+(p[m-u+1]?8:0),n[N]&&(o[h+d]=n[N],++f),m++;if(p[m-u]!==p[m]&&(o[h+d]=p[m]?2:4,++f),f>s)return null}for(m=u*(t-1),h=l*a,p[m]!==0&&(o[h]=8,++f),d=1;d<e;d++)p[m]!==p[m+1]&&(o[h+d]=p[m]?4:8,++f),m++;if(p[m]!==0&&(o[h+d]=4,++f),f>s)return null;const g=new Int32Array([0,a,-1,0,-a,0,0,0,1]),b=new Path2D;for(l=0;f&&l<=t;l++){let N=l*a;const j=N+e;for(;N<j&&!o[N];)N++;if(N===j)continue;b.moveTo(N%a,l);const E=N;let _=o[N];do{const y=g[_];do N+=y;while(!o[N]);const C=o[N];C!==5&&C!==10?(_=C,o[N]=0):(_=C&51*_>>4,o[N]&=_>>2|_<<2),b.lineTo(N%a,N/a|0),o[N]||--f}while(E!==N);--l}return p=null,o=null,function(N){N.save(),N.scale(1/e,-1/t),N.translate(0,-t),N.fill(b),N.beginPath(),N.restore()}}class np{constructor(e,t){this.alphaIsShape=!1,this.fontSize=0,this.fontSizeScale=1,this.textMatrix=$p,this.textMatrixScale=1,this.fontMatrix=Qd,this.leading=0,this.x=0,this.y=0,this.lineX=0,this.lineY=0,this.charSpacing=0,this.wordSpacing=0,this.textHScale=1,this.textRenderingMode=ot.FILL,this.textRise=0,this.fillColor="#000000",this.strokeColor="#000000",this.patternFill=!1,this.patternStroke=!1,this.fillAlpha=1,this.strokeAlpha=1,this.lineWidth=1,this.activeSMask=null,this.transferMaps="none",this.startNewPathAndClipBox([0,0,e,t])}clone(){const e=Object.create(this);return e.clipBox=this.clipBox.slice(),e}setCurrentPoint(e,t){this.x=e,this.y=t}updatePathMinMax(e,t,s){[t,s]=X.applyTransform([t,s],e),this.minX=Math.min(this.minX,t),this.minY=Math.min(this.minY,s),this.maxX=Math.max(this.maxX,t),this.maxY=Math.max(this.maxY,s)}updateRectMinMax(e,t){const s=X.applyTransform(t,e),n=X.applyTransform(t.slice(2),e),a=X.applyTransform([t[0],t[3]],e),o=X.applyTransform([t[2],t[1]],e);this.minX=Math.min(this.minX,s[0],n[0],a[0],o[0]),this.minY=Math.min(this.minY,s[1],n[1],a[1],o[1]),this.maxX=Math.max(this.maxX,s[0],n[0],a[0],o[0]),this.maxY=Math.max(this.maxY,s[1],n[1],a[1],o[1])}updateScalingPathMinMax(e,t){X.scaleMinMax(e,t),this.minX=Math.min(this.minX,t[0]),this.minY=Math.min(this.minY,t[1]),this.maxX=Math.max(this.maxX,t[2]),this.maxY=Math.max(this.maxY,t[3])}updateCurvePathMinMax(e,t,s,n,a,o,l,d,h,u){const p=X.bezierBoundingBox(t,s,n,a,o,l,d,h,u);u||this.updateRectMinMax(e,p)}getPathBoundingBox(e=mt.FILL,t=null){const s=[this.minX,this.minY,this.maxX,this.maxY];if(e===mt.STROKE){t||Ae("Stroke bounding box must include transform.");const n=X.singularValueDecompose2dScale(t),a=n[0]*this.lineWidth/2,o=n[1]*this.lineWidth/2;s[0]-=a,s[1]-=o,s[2]+=a,s[3]+=o}return s}updateClipFromPath(){const e=X.intersect(this.clipBox,this.getPathBoundingBox());this.startNewPathAndClipBox(e||[0,0,0,0])}isEmptyClip(){return this.minX===1/0}startNewPathAndClipBox(e){this.clipBox=e,this.minX=1/0,this.minY=1/0,this.maxX=0,this.maxY=0}getClippedPathBoundingBox(e=mt.FILL,t=null){return X.intersect(this.clipBox,this.getPathBoundingBox(e,t))}}function ap(c,e){if(e instanceof ImageData){c.putImageData(e,0,0);return}const t=e.height,s=e.width,n=t%Lt,a=(t-n)/Lt,o=n===0?a:a+1,l=c.createImageData(s,Lt);let d=0,h;const u=e.data,p=l.data;let m,f,g,b;if(e.kind===Sc.GRAYSCALE_1BPP){const A=u.byteLength,N=new Uint32Array(p.buffer,0,p.byteLength>>2),j=N.length,E=s+7>>3,_=4294967295,y=At.isLittleEndian?4278190080:255;for(m=0;m<o;m++){for(g=m<a?Lt:n,h=0,f=0;f<g;f++){const C=A-d;let R=0;const S=C>E?s:C*8-7,k=S&-8;let M=0,L=0;for(;R<k;R+=8)L=u[d++],N[h++]=L&128?_:y,N[h++]=L&64?_:y,N[h++]=L&32?_:y,N[h++]=L&16?_:y,N[h++]=L&8?_:y,N[h++]=L&4?_:y,N[h++]=L&2?_:y,N[h++]=L&1?_:y;for(;R<S;R++)M===0&&(L=u[d++],M=128),N[h++]=L&M?_:y,M>>=1}for(;h<j;)N[h++]=0;c.putImageData(l,0,m*Lt)}}else if(e.kind===Sc.RGBA_32BPP){for(f=0,b=s*Lt*4,m=0;m<a;m++)p.set(u.subarray(d,d+b)),d+=b,c.putImageData(l,0,f),f+=Lt;m<o&&(b=s*n*4,p.set(u.subarray(d,d+b)),c.putImageData(l,0,f))}else if(e.kind===Sc.RGB_24BPP)for(g=Lt,b=s*g,m=0;m<o;m++){for(m>=a&&(g=n,b=s*g),h=0,f=b;f--;)p[h++]=u[d++],p[h++]=u[d++],p[h++]=u[d++],p[h++]=255;c.putImageData(l,0,m*Lt)}else throw new Error(`bad image kind: ${e.kind}`)}function rp(c,e){if(e.bitmap){c.drawImage(e.bitmap,0,0);return}const t=e.height,s=e.width,n=t%Lt,a=(t-n)/Lt,o=n===0?a:a+1,l=c.createImageData(s,Lt);let d=0;const h=e.data,u=l.data;for(let p=0;p<o;p++){const m=p<a?Lt:n;({srcPos:d}=Kx({src:h,srcPos:d,dest:u,width:s,height:m,nonBlackColor:0})),c.putImageData(l,0,p*Lt)}}function uo(c,e){const t=["strokeStyle","fillStyle","fillRule","globalAlpha","lineWidth","lineCap","lineJoin","miterLimit","globalCompositeOperation","font","filter"];for(const s of t)c[s]!==void 0&&(e[s]=c[s]);c.setLineDash!==void 0&&(e.setLineDash(c.getLineDash()),e.lineDashOffset=c.lineDashOffset)}function bc(c){if(c.strokeStyle=c.fillStyle="#000000",c.fillRule="nonzero",c.globalAlpha=1,c.lineWidth=1,c.lineCap="butt",c.lineJoin="miter",c.miterLimit=10,c.globalCompositeOperation="source-over",c.font="10px sans-serif",c.setLineDash!==void 0&&(c.setLineDash([]),c.lineDashOffset=0),!ft){const{filter:e}=c;e!=="none"&&e!==""&&(c.filter="none")}}function op(c,e){if(e)return!0;const t=X.singularValueDecompose2dScale(c);t[0]=Math.fround(t[0]),t[1]=Math.fround(t[1]);const s=Math.fround((globalThis.devicePixelRatio||1)*An.PDF_TO_CSS_UNITS);return t[0]<=s&&t[1]<=s}const t0=["butt","round","square"],s0=["miter","round","bevel"],i0={},lp={};var Rs,Ah,_h,Sh;const ku=class ku{constructor(e,t,s,n,a,{optionalContentConfig:o,markedContentStack:l=null},d,h){v(this,Rs);this.ctx=e,this.current=new np(this.ctx.canvas.width,this.ctx.canvas.height),this.stateStack=[],this.pendingClip=null,this.pendingEOFill=!1,this.res=null,this.xobjs=null,this.commonObjs=t,this.objs=s,this.canvasFactory=n,this.filterFactory=a,this.groupStack=[],this.processingType3=null,this.baseTransform=null,this.baseTransformStack=[],this.groupLevel=0,this.smaskStack=[],this.smaskCounter=0,this.tempSMask=null,this.suspendedCtx=null,this.contentVisible=!0,this.markedContentStack=l||[],this.optionalContentConfig=o,this.cachedCanvases=new Jx(this.canvasFactory),this.cachedPatterns=new Map,this.annotationCanvasMap=d,this.viewportScale=1,this.outputScaleX=1,this.outputScaleY=1,this.pageColors=h,this._cachedScaleForStroking=[-1,0],this._cachedGetSinglePixelWidth=null,this._cachedBitmapsMap=new Map}getObject(e,t=null){return typeof e=="string"?e.startsWith("g_")?this.commonObjs.get(e):this.objs.get(e):t}beginDrawing({transform:e,viewport:t,transparency:s=!1,background:n=null}){const a=this.ctx.canvas.width,o=this.ctx.canvas.height,l=this.ctx.fillStyle;if(this.ctx.fillStyle=n||"#ffffff",this.ctx.fillRect(0,0,a,o),this.ctx.fillStyle=l,s){const d=this.cachedCanvases.getCanvas("transparent",a,o);this.compositeCtx=this.ctx,this.transparentCanvas=d.canvas,this.ctx=d.context,this.ctx.save(),this.ctx.transform(...Re(this.compositeCtx))}this.ctx.save(),bc(this.ctx),e&&(this.ctx.transform(...e),this.outputScaleX=e[0],this.outputScaleY=e[0]),this.ctx.transform(...t.transform),this.viewportScale=t.scale,this.baseTransform=Re(this.ctx)}executeOperatorList(e,t,s,n){const a=e.argsArray,o=e.fnArray;let l=t||0;const d=a.length;if(d===l)return l;const h=d-l>sp&&typeof s=="function",u=h?Date.now()+Qx:0;let p=0;const m=this.commonObjs,f=this.objs;let g;for(;;){if(n!==void 0&&l===n.nextBreakPoint)return n.breakIt(l,s),l;if(g=o[l],g!==fs.dependency)this[g].apply(this,a[l]);else for(const b of a[l]){const A=b.startsWith("g_")?m:f;if(!A.has(b))return A.get(b,s),l}if(l++,l===d)return l;if(h&&++p>sp){if(Date.now()>u)return s(),l;p=0}}}endDrawing(){w(this,Rs,Ah).call(this),this.cachedCanvases.clear(),this.cachedPatterns.clear();for(const e of this._cachedBitmapsMap.values()){for(const t of e.values())typeof HTMLCanvasElement<"u"&&t instanceof HTMLCanvasElement&&(t.width=t.height=0);e.clear()}this._cachedBitmapsMap.clear(),w(this,Rs,_h).call(this)}_scaleImage(e,t){var m,f;const s=(m=e.width)!=null?m:e.displayWidth,n=(f=e.height)!=null?f:e.displayHeight;let a=Math.max(Math.hypot(t[0],t[1]),1),o=Math.max(Math.hypot(t[2],t[3]),1),l=s,d=n,h="prescale1",u,p;for(;a>2&&l>1||o>2&&d>1;){let g=l,b=d;a>2&&l>1&&(g=l>=16384?Math.floor(l/2)-1||1:Math.ceil(l/2),a/=l/g),o>2&&d>1&&(b=d>=16384?Math.floor(d/2)-1||1:Math.ceil(d)/2,o/=d/b),u=this.cachedCanvases.getCanvas(h,g,b),p=u.context,p.clearRect(0,0,g,b),p.drawImage(e,0,0,l,d,0,0,g,b),e=u.canvas,l=g,d=b,h=h==="prescale1"?"prescale2":"prescale1"}return{img:e,paintWidth:l,paintHeight:d}}_createMaskCanvas(e){const t=this.ctx,{width:s,height:n}=e,a=this.current.fillColor,o=this.current.patternFill,l=Re(t);let d,h,u,p;if((e.bitmap||e.data)&&e.count>1){const S=e.bitmap||e.data.buffer;h=JSON.stringify(o?l:[l.slice(0,4),a]),d=this._cachedBitmapsMap.get(S),d||(d=new Map,this._cachedBitmapsMap.set(S,d));const k=d.get(h);if(k&&!o){const M=Math.round(Math.min(l[0],l[2])+l[4]),L=Math.round(Math.min(l[1],l[3])+l[5]);return{canvas:k,offsetX:M,offsetY:L}}u=k}u||(p=this.cachedCanvases.getCanvas("maskCanvas",s,n),rp(p.context,e));let m=X.transform(l,[1/s,0,0,-1/n,0,0]);m=X.transform(m,[1,0,0,1,0,-n]);const[f,g,b,A]=X.getAxialAlignedBoundingBox([0,0,s,n],m),N=Math.round(b-f)||1,j=Math.round(A-g)||1,E=this.cachedCanvases.getCanvas("fillCanvas",N,j),_=E.context,y=f,C=g;_.translate(-y,-C),_.transform(...m),u||(u=this._scaleImage(p.canvas,Is(_)),u=u.img,d&&o&&d.set(h,u)),_.imageSmoothingEnabled=op(Re(_),e.interpolate),xc(_,u,0,0,u.width,u.height,0,0,s,n),_.globalCompositeOperation="source-in";const R=X.transform(Is(_),[1,0,0,1,-y,-C]);return _.fillStyle=o?a.getPattern(t,this,R,mt.FILL):a,_.fillRect(0,0,s,n),d&&!o&&(this.cachedCanvases.delete("fillCanvas"),d.set(h,E.canvas)),{canvas:E.canvas,offsetX:Math.round(y),offsetY:Math.round(C)}}setLineWidth(e){e!==this.current.lineWidth&&(this._cachedScaleForStroking[0]=-1),this.current.lineWidth=e,this.ctx.lineWidth=e}setLineCap(e){this.ctx.lineCap=t0[e]}setLineJoin(e){this.ctx.lineJoin=s0[e]}setMiterLimit(e){this.ctx.miterLimit=e}setDash(e,t){const s=this.ctx;s.setLineDash!==void 0&&(s.setLineDash(e),s.lineDashOffset=t)}setRenderingIntent(e){}setFlatness(e){}setGState(e){for(const[t,s]of e)switch(t){case"LW":this.setLineWidth(s);break;case"LC":this.setLineCap(s);break;case"LJ":this.setLineJoin(s);break;case"ML":this.setMiterLimit(s);break;case"D":this.setDash(s[0],s[1]);break;case"RI":this.setRenderingIntent(s);break;case"FL":this.setFlatness(s);break;case"Font":this.setFont(s[0],s[1]);break;case"CA":this.current.strokeAlpha=s;break;case"ca":this.current.fillAlpha=s,this.ctx.globalAlpha=s;break;case"BM":this.ctx.globalCompositeOperation=s;break;case"SMask":this.current.activeSMask=s?this.tempSMask:null,this.tempSMask=null,this.checkSMaskState();break;case"TR":this.ctx.filter=this.current.transferMaps=this.filterFactory.addFilter(s);break}}get inSMaskMode(){return!!this.suspendedCtx}checkSMaskState(){const e=this.inSMaskMode;this.current.activeSMask&&!e?this.beginSMaskMode():!this.current.activeSMask&&e&&this.endSMaskMode()}beginSMaskMode(){if(this.inSMaskMode)throw new Error("beginSMaskMode called while already in smask mode");const e=this.ctx.canvas.width,t=this.ctx.canvas.height,s="smaskGroupAt"+this.groupLevel,n=this.cachedCanvases.getCanvas(s,e,t);this.suspendedCtx=this.ctx,this.ctx=n.context;const a=this.ctx;a.setTransform(...Re(this.suspendedCtx)),uo(this.suspendedCtx,a),Zx(a,this.suspendedCtx),this.setGState([["BM","source-over"],["ca",1],["CA",1]])}endSMaskMode(){if(!this.inSMaskMode)throw new Error("endSMaskMode called while not in smask mode");this.ctx._removeMirroring(),uo(this.ctx,this.suspendedCtx),this.ctx=this.suspendedCtx,this.suspendedCtx=null}compose(e){if(!this.current.activeSMask)return;e?(e[0]=Math.floor(e[0]),e[1]=Math.floor(e[1]),e[2]=Math.ceil(e[2]),e[3]=Math.ceil(e[3])):e=[0,0,this.ctx.canvas.width,this.ctx.canvas.height];const t=this.current.activeSMask,s=this.suspendedCtx;this.composeSMask(s,t,this.ctx,e),this.ctx.save(),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.restore()}composeSMask(e,t,s,n){const a=n[0],o=n[1],l=n[2]-a,d=n[3]-o;l===0||d===0||(this.genericComposeSMask(t.context,s,l,d,t.subtype,t.backdrop,t.transferMap,a,o,t.offsetX,t.offsetY),e.save(),e.globalAlpha=1,e.globalCompositeOperation="source-over",e.setTransform(1,0,0,1,0,0),e.drawImage(s.canvas,0,0),e.restore())}genericComposeSMask(e,t,s,n,a,o,l,d,h,u,p){let m=e.canvas,f=d-u,g=h-p;if(o){const A=X.makeHexColor(...o);if(f<0||g<0||f+s>m.width||g+n>m.height){const N=this.cachedCanvases.getCanvas("maskExtension",s,n),j=N.context;j.drawImage(m,-f,-g),j.globalCompositeOperation="destination-atop",j.fillStyle=A,j.fillRect(0,0,s,n),j.globalCompositeOperation="source-over",m=N.canvas,f=g=0}else{e.save(),e.globalAlpha=1,e.setTransform(1,0,0,1,0,0);const N=new Path2D;N.rect(f,g,s,n),e.clip(N),e.globalCompositeOperation="destination-atop",e.fillStyle=A,e.fillRect(f,g,s,n),e.restore()}}t.save(),t.globalAlpha=1,t.setTransform(1,0,0,1,0,0),a==="Alpha"&&l?t.filter=this.filterFactory.addAlphaFilter(l):a==="Luminosity"&&(t.filter=this.filterFactory.addLuminosityFilter(l));const b=new Path2D;b.rect(d,h,s,n),t.clip(b),t.globalCompositeOperation="destination-in",t.drawImage(m,f,g,s,n,d,h,s,n),t.restore()}save(){this.inSMaskMode?(uo(this.ctx,this.suspendedCtx),this.suspendedCtx.save()):this.ctx.save();const e=this.current;this.stateStack.push(e),this.current=e.clone()}restore(){this.stateStack.length===0&&this.inSMaskMode&&this.endSMaskMode(),this.stateStack.length!==0&&(this.current=this.stateStack.pop(),this.inSMaskMode?(this.suspendedCtx.restore(),uo(this.suspendedCtx,this.ctx)):this.ctx.restore(),this.checkSMaskState(),this.pendingClip=null,this._cachedScaleForStroking[0]=-1,this._cachedGetSinglePixelWidth=null)}transform(e,t,s,n,a,o){this.ctx.transform(e,t,s,n,a,o),this._cachedScaleForStroking[0]=-1,this._cachedGetSinglePixelWidth=null}constructPath(e,t,s){const n=this.ctx,a=this.current;let o=a.x,l=a.y,d,h;const u=Re(n),p=u[0]===0&&u[3]===0||u[1]===0&&u[2]===0,m=p?s.slice(0):null;for(let f=0,g=0,b=e.length;f<b;f++)switch(e[f]|0){case fs.rectangle:o=t[g++],l=t[g++];const A=t[g++],N=t[g++],j=o+A,E=l+N;n.moveTo(o,l),A===0||N===0?n.lineTo(j,E):(n.lineTo(j,l),n.lineTo(j,E),n.lineTo(o,E)),p||a.updateRectMinMax(u,[o,l,j,E]),n.closePath();break;case fs.moveTo:o=t[g++],l=t[g++],n.moveTo(o,l),p||a.updatePathMinMax(u,o,l);break;case fs.lineTo:o=t[g++],l=t[g++],n.lineTo(o,l),p||a.updatePathMinMax(u,o,l);break;case fs.curveTo:d=o,h=l,o=t[g+4],l=t[g+5],n.bezierCurveTo(t[g],t[g+1],t[g+2],t[g+3],o,l),a.updateCurvePathMinMax(u,d,h,t[g],t[g+1],t[g+2],t[g+3],o,l,m),g+=6;break;case fs.curveTo2:d=o,h=l,n.bezierCurveTo(o,l,t[g],t[g+1],t[g+2],t[g+3]),a.updateCurvePathMinMax(u,d,h,o,l,t[g],t[g+1],t[g+2],t[g+3],m),o=t[g+2],l=t[g+3],g+=4;break;case fs.curveTo3:d=o,h=l,o=t[g+2],l=t[g+3],n.bezierCurveTo(t[g],t[g+1],o,l,o,l),a.updateCurvePathMinMax(u,d,h,t[g],t[g+1],o,l,o,l,m),g+=4;break;case fs.closePath:n.closePath();break}p&&a.updateScalingPathMinMax(u,m),a.setCurrentPoint(o,l)}closePath(){this.ctx.closePath()}stroke(e=!0){const t=this.ctx,s=this.current.strokeColor;t.globalAlpha=this.current.strokeAlpha,this.contentVisible&&(typeof s=="object"&&(s!=null&&s.getPattern)?(t.save(),t.strokeStyle=s.getPattern(t,this,Is(t),mt.STROKE),this.rescaleAndStroke(!1),t.restore()):this.rescaleAndStroke(!0)),e&&this.consumePath(this.current.getClippedPathBoundingBox()),t.globalAlpha=this.current.fillAlpha}closeStroke(){this.closePath(),this.stroke()}fill(e=!0){const t=this.ctx,s=this.current.fillColor,n=this.current.patternFill;let a=!1;n&&(t.save(),t.fillStyle=s.getPattern(t,this,Is(t),mt.FILL),a=!0);const o=this.current.getClippedPathBoundingBox();this.contentVisible&&o!==null&&(this.pendingEOFill?(t.fill("evenodd"),this.pendingEOFill=!1):t.fill()),a&&t.restore(),e&&this.consumePath(o)}eoFill(){this.pendingEOFill=!0,this.fill()}fillStroke(){this.fill(!1),this.stroke(!1),this.consumePath()}eoFillStroke(){this.pendingEOFill=!0,this.fillStroke()}closeFillStroke(){this.closePath(),this.fillStroke()}closeEOFillStroke(){this.pendingEOFill=!0,this.closePath(),this.fillStroke()}endPath(){this.consumePath()}clip(){this.pendingClip=i0}eoClip(){this.pendingClip=lp}beginText(){this.current.textMatrix=$p,this.current.textMatrixScale=1,this.current.x=this.current.lineX=0,this.current.y=this.current.lineY=0}endText(){const e=this.pendingTextPaths,t=this.ctx;if(e===void 0){t.beginPath();return}const s=new Path2D,n=t.getTransform().invertSelf();for(const{transform:a,x:o,y:l,fontSize:d,path:h}of e)s.addPath(h,new DOMMatrix(a).preMultiplySelf(n).translate(o,l).scale(d,-d));t.clip(s),t.beginPath(),delete this.pendingTextPaths}setCharSpacing(e){this.current.charSpacing=e}setWordSpacing(e){this.current.wordSpacing=e}setHScale(e){this.current.textHScale=e/100}setLeading(e){this.current.leading=-e}setFont(e,t){var u;const s=this.commonObjs.get(e),n=this.current;if(!s)throw new Error(`Can't find font for ${e}`);if(n.fontMatrix=s.fontMatrix||Qd,(n.fontMatrix[0]===0||n.fontMatrix[3]===0)&&re("Invalid font matrix for font "+e),t<0?(t=-t,n.fontDirection=-1):n.fontDirection=1,this.current.font=s,this.current.fontSize=t,s.isType3Font)return;const a=s.loadedName||"sans-serif",o=((u=s.systemFontInfo)==null?void 0:u.css)||`"${a}", ${s.fallbackName}`;let l="normal";s.black?l="900":s.bold&&(l="bold");const d=s.italic?"italic":"normal";let h=t;t<ep?h=ep:t>tp&&(h=tp),this.current.fontSizeScale=t/h,this.ctx.font=`${d} ${l} ${h}px ${o}`}setTextRenderingMode(e){this.current.textRenderingMode=e}setTextRise(e){this.current.textRise=e}moveText(e,t){this.current.x=this.current.lineX+=e,this.current.y=this.current.lineY+=t}setLeadingMoveText(e,t){this.setLeading(-t),this.moveText(e,t)}setTextMatrix(e,t,s,n,a,o){this.current.textMatrix=[e,t,s,n,a,o],this.current.textMatrixScale=Math.hypot(e,t),this.current.x=this.current.lineX=0,this.current.y=this.current.lineY=0}nextLine(){this.moveText(0,this.current.leading)}paintChar(e,t,s,n,a){const o=this.ctx,l=this.current,d=l.font,h=l.textRenderingMode,u=l.fontSize/l.fontSizeScale,p=h&ot.FILL_STROKE_MASK,m=!!(h&ot.ADD_TO_PATH_FLAG),f=l.patternFill&&!d.missingFile,g=l.patternStroke&&!d.missingFile;let b;if((d.disableFontFace||m||f||g)&&(b=d.getPathGenerator(this.commonObjs,e)),d.disableFontFace||f||g){if(o.save(),o.translate(t,s),o.scale(u,-u),p===ot.FILL||p===ot.FILL_STROKE)if(n){const A=o.getTransform();o.setTransform(...n),o.fill(w(this,Rs,Sh).call(this,b,A,n))}else o.fill(b);if(p===ot.STROKE||p===ot.FILL_STROKE)if(a){const A=o.getTransform();o.setTransform(...a),o.stroke(w(this,Rs,Sh).call(this,b,A,a))}else o.lineWidth/=u,o.stroke(b);o.restore()}else(p===ot.FILL||p===ot.FILL_STROKE)&&o.fillText(e,t,s),(p===ot.STROKE||p===ot.FILL_STROKE)&&o.strokeText(e,t,s);m&&(this.pendingTextPaths||(this.pendingTextPaths=[])).push({transform:Re(o),x:t,y:s,fontSize:u,path:b})}get isFontSubpixelAAEnabled(){const{context:e}=this.cachedCanvases.getCanvas("isFontSubpixelAAEnabled",10,10);e.scale(1.5,1),e.fillText("I",0,10);const t=e.getImageData(0,0,10,10).data;let s=!1;for(let n=3;n<t.length;n+=4)if(t[n]>0&&t[n]<255){s=!0;break}return de(this,"isFontSubpixelAAEnabled",s)}showText(e){const t=this.current,s=t.font;if(s.isType3Font)return this.showType3Text(e);const n=t.fontSize;if(n===0)return;const a=this.ctx,o=t.fontSizeScale,l=t.charSpacing,d=t.wordSpacing,h=t.fontDirection,u=t.textHScale*h,p=e.length,m=s.vertical,f=m?1:-1,g=s.defaultVMetrics,b=n*t.fontMatrix[0],A=t.textRenderingMode===ot.FILL&&!s.disableFontFace&&!t.patternFill;a.save(),a.transform(...t.textMatrix),a.translate(t.x,t.y+t.textRise),h>0?a.scale(u,-1):a.scale(u,1);let N,j;if(t.patternFill){a.save();const R=t.fillColor.getPattern(a,this,Is(a),mt.FILL);N=Re(a),a.restore(),a.fillStyle=R}if(t.patternStroke){a.save();const R=t.strokeColor.getPattern(a,this,Is(a),mt.STROKE);j=Re(a),a.restore(),a.strokeStyle=R}let E=t.lineWidth;const _=t.textMatrixScale;if(_===0||E===0){const R=t.textRenderingMode&ot.FILL_STROKE_MASK;(R===ot.STROKE||R===ot.FILL_STROKE)&&(E=this.getSinglePixelWidth())}else E/=_;if(o!==1&&(a.scale(o,o),E/=o),a.lineWidth=E,s.isInvalidPDFjsFont){const R=[];let S=0;for(const k of e)R.push(k.unicode),S+=k.width;a.fillText(R.join(""),0,0),t.x+=S*b*u,a.restore(),this.compose();return}let y=0,C;for(C=0;C<p;++C){const R=e[C];if(typeof R=="number"){y+=f*R*n/1e3;continue}let S=!1;const k=(R.isSpace?d:0)+l,M=R.fontChar,L=R.accent;let O,$,q=R.width;if(m){const P=R.vmetric||g,I=-(R.vmetric?P[1]:q*.5)*b,K=P[2]*b;q=P?-P[0]:q,O=I/o,$=(y+K)/o}else O=y/o,$=0;if(s.remeasure&&q>0){const P=a.measureText(M).width*1e3/n*o;if(q<P&&this.isFontSubpixelAAEnabled){const I=q/P;S=!0,a.save(),a.scale(I,1),O/=I}else q!==P&&(O+=(q-P)/2e3*n/o)}if(this.contentVisible&&(R.isInFont||s.missingFile)){if(A&&!L)a.fillText(M,O,$);else if(this.paintChar(M,O,$,N,j),L){const P=O+n*L.offset.x/o,I=$-n*L.offset.y/o;this.paintChar(L.fontChar,P,I,N,j)}}const F=m?q*b-k*h:q*b+k*h;y+=F,S&&a.restore()}m?t.y-=y:t.x+=y*u,a.restore(),this.compose()}showType3Text(e){const t=this.ctx,s=this.current,n=s.font,a=s.fontSize,o=s.fontDirection,l=n.vertical?1:-1,d=s.charSpacing,h=s.wordSpacing,u=s.textHScale*o,p=s.fontMatrix||Qd,m=e.length,f=s.textRenderingMode===ot.INVISIBLE;let g,b,A,N;if(!(f||a===0)){for(this._cachedScaleForStroking[0]=-1,this._cachedGetSinglePixelWidth=null,t.save(),t.transform(...s.textMatrix),t.translate(s.x,s.y),t.scale(u,o),g=0;g<m;++g){if(b=e[g],typeof b=="number"){N=l*b*a/1e3,this.ctx.translate(N,0),s.x+=N*u;continue}const j=(b.isSpace?h:0)+d,E=n.charProcOperatorList[b.operatorListId];if(!E){re(`Type3 character "${b.operatorListId}" is not available.`);continue}this.contentVisible&&(this.processingType3=b,this.save(),t.scale(a,a),t.transform(...p),this.executeOperatorList(E),this.restore()),A=X.applyTransform([b.width,0],p)[0]*a+j,t.translate(A,0),s.x+=A*u}t.restore(),this.processingType3=null}}setCharWidth(e,t){}setCharWidthAndBounds(e,t,s,n,a,o){this.ctx.rect(s,n,a-s,o-n),this.ctx.clip(),this.endPath()}getColorN_Pattern(e){let t;if(e[0]==="TilingPattern"){const s=e[1],n=this.baseTransform||Re(this.ctx),a={createCanvasGraphics:o=>new ku(o,this.commonObjs,this.objs,this.canvasFactory,this.filterFactory,{optionalContentConfig:this.optionalContentConfig,markedContentStack:this.markedContentStack})};t=new jh(e,s,this.ctx,a,n)}else t=this._getPattern(e[1],e[2]);return t}setStrokeColorN(){this.current.strokeColor=this.getColorN_Pattern(arguments),this.current.patternStroke=!0}setFillColorN(){this.current.fillColor=this.getColorN_Pattern(arguments),this.current.patternFill=!0}setStrokeRGBColor(e,t,s){this.ctx.strokeStyle=this.current.strokeColor=X.makeHexColor(e,t,s),this.current.patternStroke=!1}setStrokeTransparent(){this.ctx.strokeStyle=this.current.strokeColor="transparent",this.current.patternStroke=!1}setFillRGBColor(e,t,s){this.ctx.fillStyle=this.current.fillColor=X.makeHexColor(e,t,s),this.current.patternFill=!1}setFillTransparent(){this.ctx.fillStyle=this.current.fillColor="transparent",this.current.patternFill=!1}_getPattern(e,t=null){let s;return this.cachedPatterns.has(e)?s=this.cachedPatterns.get(e):(s=Yx(this.getObject(e)),this.cachedPatterns.set(e,s)),t&&(s.matrix=t),s}shadingFill(e){if(!this.contentVisible)return;const t=this.ctx;this.save();const s=this._getPattern(e);t.fillStyle=s.getPattern(t,this,Is(t),mt.SHADING);const n=Is(t);if(n){const{width:a,height:o}=t.canvas,[l,d,h,u]=X.getAxialAlignedBoundingBox([0,0,a,o],n);this.ctx.fillRect(l,d,h-l,u-d)}else this.ctx.fillRect(-1e10,-1e10,2e10,2e10);this.compose(this.current.getClippedPathBoundingBox()),this.restore()}beginInlineImage(){Ae("Should not call beginInlineImage")}beginImageData(){Ae("Should not call beginImageData")}paintFormXObjectBegin(e,t){if(this.contentVisible&&(this.save(),this.baseTransformStack.push(this.baseTransform),e&&this.transform(...e),this.baseTransform=Re(this.ctx),t)){const s=t[2]-t[0],n=t[3]-t[1];this.ctx.rect(t[0],t[1],s,n),this.current.updateRectMinMax(Re(this.ctx),t),this.clip(),this.endPath()}}paintFormXObjectEnd(){this.contentVisible&&(this.restore(),this.baseTransform=this.baseTransformStack.pop())}beginGroup(e){if(!this.contentVisible)return;this.save(),this.inSMaskMode&&(this.endSMaskMode(),this.current.activeSMask=null);const t=this.ctx;e.isolated||Id("TODO: Support non-isolated groups."),e.knockout&&re("Knockout groups not supported.");const s=Re(t);if(e.matrix&&t.transform(...e.matrix),!e.bbox)throw new Error("Bounding box is required.");let n=X.getAxialAlignedBoundingBox(e.bbox,Re(t));const a=[0,0,t.canvas.width,t.canvas.height];n=X.intersect(n,a)||[0,0,0,0];const o=Math.floor(n[0]),l=Math.floor(n[1]),d=Math.max(Math.ceil(n[2])-o,1),h=Math.max(Math.ceil(n[3])-l,1);this.current.startNewPathAndClipBox([0,0,d,h]);let u="groupAt"+this.groupLevel;e.smask&&(u+="_smask_"+this.smaskCounter++%2);const p=this.cachedCanvases.getCanvas(u,d,h),m=p.context;m.translate(-o,-l),m.transform(...s),e.smask?this.smaskStack.push({canvas:p.canvas,context:m,offsetX:o,offsetY:l,subtype:e.smask.subtype,backdrop:e.smask.backdrop,transferMap:e.smask.transferMap||null,startTransformInverse:null}):(t.setTransform(1,0,0,1,0,0),t.translate(o,l),t.save()),uo(t,m),this.ctx=m,this.setGState([["BM","source-over"],["ca",1],["CA",1]]),this.groupStack.push(t),this.groupLevel++}endGroup(e){if(!this.contentVisible)return;this.groupLevel--;const t=this.ctx,s=this.groupStack.pop();if(this.ctx=s,this.ctx.imageSmoothingEnabled=!1,e.smask)this.tempSMask=this.smaskStack.pop(),this.restore();else{this.ctx.restore();const n=Re(this.ctx);this.restore(),this.ctx.save(),this.ctx.setTransform(...n);const a=X.getAxialAlignedBoundingBox([0,0,t.canvas.width,t.canvas.height],n);this.ctx.drawImage(t.canvas,0,0),this.ctx.restore(),this.compose(a)}}beginAnnotation(e,t,s,n,a){if(w(this,Rs,Ah).call(this),bc(this.ctx),this.ctx.save(),this.save(),this.baseTransform&&this.ctx.setTransform(...this.baseTransform),t){const o=t[2]-t[0],l=t[3]-t[1];if(a&&this.annotationCanvasMap){s=s.slice(),s[4]-=t[0],s[5]-=t[1],t=t.slice(),t[0]=t[1]=0,t[2]=o,t[3]=l;const[d,h]=X.singularValueDecompose2dScale(Re(this.ctx)),{viewportScale:u}=this,p=Math.ceil(o*this.outputScaleX*u),m=Math.ceil(l*this.outputScaleY*u);this.annotationCanvas=this.canvasFactory.create(p,m);const{canvas:f,context:g}=this.annotationCanvas;this.annotationCanvasMap.set(e,f),this.annotationCanvas.savedCtx=this.ctx,this.ctx=g,this.ctx.save(),this.ctx.setTransform(d,0,0,-h,0,l*h),bc(this.ctx)}else bc(this.ctx),this.endPath(),this.ctx.rect(t[0],t[1],o,l),this.ctx.clip(),this.ctx.beginPath()}this.current=new np(this.ctx.canvas.width,this.ctx.canvas.height),this.transform(...s),this.transform(...n)}endAnnotation(){this.annotationCanvas&&(this.ctx.restore(),w(this,Rs,_h).call(this),this.ctx=this.annotationCanvas.savedCtx,delete this.annotationCanvas.savedCtx,delete this.annotationCanvas)}paintImageMaskXObject(e){if(!this.contentVisible)return;const t=e.count;e=this.getObject(e.data,e),e.count=t;const s=this.ctx,n=this.processingType3;if(n&&(n.compiled===void 0&&(n.compiled=e0(e)),n.compiled)){n.compiled(s);return}const a=this._createMaskCanvas(e),o=a.canvas;s.save(),s.setTransform(1,0,0,1,0,0),s.drawImage(o,a.offsetX,a.offsetY),s.restore(),this.compose()}paintImageMaskXObjectRepeat(e,t,s=0,n=0,a,o){if(!this.contentVisible)return;e=this.getObject(e.data,e);const l=this.ctx;l.save();const d=Re(l);l.transform(t,s,n,a,0,0);const h=this._createMaskCanvas(e);l.setTransform(1,0,0,1,h.offsetX-d[4],h.offsetY-d[5]);for(let u=0,p=o.length;u<p;u+=2){const m=X.transform(d,[t,s,n,a,o[u],o[u+1]]),[f,g]=X.applyTransform([0,0],m);l.drawImage(h.canvas,f,g)}l.restore(),this.compose()}paintImageMaskXObjectGroup(e){if(!this.contentVisible)return;const t=this.ctx,s=this.current.fillColor,n=this.current.patternFill;for(const a of e){const{data:o,width:l,height:d,transform:h}=a,u=this.cachedCanvases.getCanvas("maskCanvas",l,d),p=u.context;p.save();const m=this.getObject(o,a);rp(p,m),p.globalCompositeOperation="source-in",p.fillStyle=n?s.getPattern(p,this,Is(t),mt.FILL):s,p.fillRect(0,0,l,d),p.restore(),t.save(),t.transform(...h),t.scale(1,-1),xc(t,u.canvas,0,0,l,d,0,-1,1,1),t.restore()}this.compose()}paintImageXObject(e){if(!this.contentVisible)return;const t=this.getObject(e);if(!t){re("Dependent image isn't ready yet");return}this.paintInlineImageXObject(t)}paintImageXObjectRepeat(e,t,s,n){if(!this.contentVisible)return;const a=this.getObject(e);if(!a){re("Dependent image isn't ready yet");return}const o=a.width,l=a.height,d=[];for(let h=0,u=n.length;h<u;h+=2)d.push({transform:[t,0,0,s,n[h],n[h+1]],x:0,y:0,w:o,h:l});this.paintInlineImageXObjectGroup(a,d)}applyTransferMapsToCanvas(e){return this.current.transferMaps!=="none"&&(e.filter=this.current.transferMaps,e.drawImage(e.canvas,0,0),e.filter="none"),e.canvas}applyTransferMapsToBitmap(e){if(this.current.transferMaps==="none")return e.bitmap;const{bitmap:t,width:s,height:n}=e,a=this.cachedCanvases.getCanvas("inlineImage",s,n),o=a.context;return o.filter=this.current.transferMaps,o.drawImage(t,0,0),o.filter="none",a.canvas}paintInlineImageXObject(e){if(!this.contentVisible)return;const t=e.width,s=e.height,n=this.ctx;if(this.save(),!ft){const{filter:l}=n;l!=="none"&&l!==""&&(n.filter="none")}n.scale(1/t,-1/s);let a;if(e.bitmap)a=this.applyTransferMapsToBitmap(e);else if(typeof HTMLElement=="function"&&e instanceof HTMLElement||!e.data)a=e;else{const d=this.cachedCanvases.getCanvas("inlineImage",t,s).context;ap(d,e),a=this.applyTransferMapsToCanvas(d)}const o=this._scaleImage(a,Is(n));n.imageSmoothingEnabled=op(Re(n),e.interpolate),xc(n,o.img,0,0,o.paintWidth,o.paintHeight,0,-s,t,s),this.compose(),this.restore()}paintInlineImageXObjectGroup(e,t){if(!this.contentVisible)return;const s=this.ctx;let n;if(e.bitmap)n=e.bitmap;else{const a=e.width,o=e.height,d=this.cachedCanvases.getCanvas("inlineImage",a,o).context;ap(d,e),n=this.applyTransferMapsToCanvas(d)}for(const a of t)s.save(),s.transform(...a.transform),s.scale(1,-1),xc(s,n,a.x,a.y,a.w,a.h,0,-1,1,1),s.restore();this.compose()}paintSolidColorImageMask(){this.contentVisible&&(this.ctx.fillRect(0,0,1,1),this.compose())}markPoint(e){}markPointProps(e,t){}beginMarkedContent(e){this.markedContentStack.push({visible:!0})}beginMarkedContentProps(e,t){e==="OC"?this.markedContentStack.push({visible:this.optionalContentConfig.isVisible(t)}):this.markedContentStack.push({visible:!0}),this.contentVisible=this.isContentVisible()}endMarkedContent(){this.markedContentStack.pop(),this.contentVisible=this.isContentVisible()}beginCompat(){}endCompat(){}consumePath(e){const t=this.current.isEmptyClip();this.pendingClip&&this.current.updateClipFromPath(),this.pendingClip||this.compose(e);const s=this.ctx;this.pendingClip&&(t||(this.pendingClip===lp?s.clip("evenodd"):s.clip()),this.pendingClip=null),this.current.startNewPathAndClipBox(this.current.clipBox),s.beginPath()}getSinglePixelWidth(){if(!this._cachedGetSinglePixelWidth){const e=Re(this.ctx);if(e[1]===0&&e[2]===0)this._cachedGetSinglePixelWidth=1/Math.min(Math.abs(e[0]),Math.abs(e[3]));else{const t=Math.abs(e[0]*e[3]-e[2]*e[1]),s=Math.hypot(e[0],e[2]),n=Math.hypot(e[1],e[3]);this._cachedGetSinglePixelWidth=Math.max(s,n)/t}}return this._cachedGetSinglePixelWidth}getScaleForStroking(){if(this._cachedScaleForStroking[0]===-1){const{lineWidth:e}=this.current,{a:t,b:s,c:n,d:a}=this.ctx.getTransform();let o,l;if(s===0&&n===0){const d=Math.abs(t),h=Math.abs(a);if(d===h)if(e===0)o=l=1/d;else{const u=d*e;o=l=u<1?1/u:1}else if(e===0)o=1/d,l=1/h;else{const u=d*e,p=h*e;o=u<1?1/u:1,l=p<1?1/p:1}}else{const d=Math.abs(t*a-s*n),h=Math.hypot(t,s),u=Math.hypot(n,a);if(e===0)o=u/d,l=h/d;else{const p=e*d;o=u>p?u/p:1,l=h>p?h/p:1}}this._cachedScaleForStroking[0]=o,this._cachedScaleForStroking[1]=l}return this._cachedScaleForStroking}rescaleAndStroke(e){const{ctx:t}=this,{lineWidth:s}=this.current,[n,a]=this.getScaleForStroking();if(t.lineWidth=s||1,n===1&&a===1){t.stroke();return}const o=t.getLineDash();if(e&&t.save(),t.scale(n,a),o.length>0){const l=Math.max(n,a);t.setLineDash(o.map(d=>d/l)),t.lineDashOffset/=l}t.stroke(),e&&t.restore()}isContentVisible(){for(let e=this.markedContentStack.length-1;e>=0;e--)if(!this.markedContentStack[e].visible)return!1;return!0}};Rs=new WeakSet,Ah=function(){for(;this.stateStack.length||this.inSMaskMode;)this.restore();this.current.activeSMask=null,this.ctx.restore(),this.transparentCanvas&&(this.ctx=this.compositeCtx,this.ctx.save(),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.drawImage(this.transparentCanvas,0,0),this.ctx.restore(),this.transparentCanvas=null)},_h=function(){if(this.pageColors){const e=this.filterFactory.addHCMFilter(this.pageColors.foreground,this.pageColors.background);if(e!=="none"){const t=this.ctx.filter;this.ctx.filter=e,this.ctx.drawImage(this.ctx.canvas,0,0),this.ctx.filter=t}}},Sh=function(e,t,s){const n=new Path2D;return n.addPath(e,new DOMMatrix(s).invertSelf().multiplySelf(t)),n};let er=ku;for(const c in fs)er.prototype[c]!==void 0&&(er.prototype[fs[c]]=er.prototype[c]);var ml,fl;class Ii{static get workerPort(){return r(this,ml)}static set workerPort(e){if(!(typeof Worker<"u"&&e instanceof Worker)&&e!==null)throw new Error("Invalid `workerPort` type.");x(this,ml,e)}static get workerSrc(){return r(this,fl)}static set workerSrc(e){if(typeof e!="string")throw new Error("Invalid `workerSrc` type.");x(this,fl,e)}}ml=new WeakMap,fl=new WeakMap,v(Ii,ml,null),v(Ii,fl,"");var ta,gl;class n0{constructor({parsedData:e,rawData:t}){v(this,ta);v(this,gl);x(this,ta,e),x(this,gl,t)}getRaw(){return r(this,gl)}get(e){var t;return(t=r(this,ta).get(e))!=null?t:null}getAll(){return gu(r(this,ta))}has(e){return r(this,ta).has(e)}}ta=new WeakMap,gl=new WeakMap;const qa=Symbol("INTERNAL");var xl,bl,vl,vr;class a0{constructor(e,{name:t,intent:s,usage:n,rbGroups:a}){v(this,xl,!1);v(this,bl,!1);v(this,vl,!1);v(this,vr,!0);x(this,xl,!!(e&Yt.DISPLAY)),x(this,bl,!!(e&Yt.PRINT)),this.name=t,this.intent=s,this.usage=n,this.rbGroups=a}get visible(){if(r(this,vl))return r(this,vr);if(!r(this,vr))return!1;const{print:e,view:t}=this.usage;return r(this,xl)?(t==null?void 0:t.viewState)!=="OFF":r(this,bl)?(e==null?void 0:e.printState)!=="OFF":!0}_setVisible(e,t,s=!1){e!==qa&&Ae("Internal method `_setVisible` called."),x(this,vl,s),x(this,vr,t)}}xl=new WeakMap,bl=new WeakMap,vl=new WeakMap,vr=new WeakMap;var sn,ve,yr,wr,yl,Ch;class r0{constructor(e,t=Yt.DISPLAY){v(this,yl);v(this,sn,null);v(this,ve,new Map);v(this,yr,null);v(this,wr,null);if(this.renderingIntent=t,this.name=null,this.creator=null,e!==null){this.name=e.name,this.creator=e.creator,x(this,wr,e.order);for(const s of e.groups)r(this,ve).set(s.id,new a0(t,s));if(e.baseState==="OFF")for(const s of r(this,ve).values())s._setVisible(qa,!1);for(const s of e.on)r(this,ve).get(s)._setVisible(qa,!0);for(const s of e.off)r(this,ve).get(s)._setVisible(qa,!1);x(this,yr,this.getHash())}}isVisible(e){if(r(this,ve).size===0)return!0;if(!e)return Id("Optional content group not defined."),!0;if(e.type==="OCG")return r(this,ve).has(e.id)?r(this,ve).get(e.id).visible:(re(`Optional content group not found: ${e.id}`),!0);if(e.type==="OCMD"){if(e.expression)return w(this,yl,Ch).call(this,e.expression);if(!e.policy||e.policy==="AnyOn"){for(const t of e.ids){if(!r(this,ve).has(t))return re(`Optional content group not found: ${t}`),!0;if(r(this,ve).get(t).visible)return!0}return!1}else if(e.policy==="AllOn"){for(const t of e.ids){if(!r(this,ve).has(t))return re(`Optional content group not found: ${t}`),!0;if(!r(this,ve).get(t).visible)return!1}return!0}else if(e.policy==="AnyOff"){for(const t of e.ids){if(!r(this,ve).has(t))return re(`Optional content group not found: ${t}`),!0;if(!r(this,ve).get(t).visible)return!0}return!1}else if(e.policy==="AllOff"){for(const t of e.ids){if(!r(this,ve).has(t))return re(`Optional content group not found: ${t}`),!0;if(r(this,ve).get(t).visible)return!1}return!0}return re(`Unknown optional content policy ${e.policy}.`),!0}return re(`Unknown group type ${e.type}.`),!0}setVisibility(e,t=!0,s=!0){var a;const n=r(this,ve).get(e);if(!n){re(`Optional content group not found: ${e}`);return}if(s&&t&&n.rbGroups.length)for(const o of n.rbGroups)for(const l of o)l!==e&&((a=r(this,ve).get(l))==null||a._setVisible(qa,!1,!0));n._setVisible(qa,!!t,!0),x(this,sn,null)}setOCGState({state:e,preserveRB:t}){let s;for(const n of e){switch(n){case"ON":case"OFF":case"Toggle":s=n;continue}const a=r(this,ve).get(n);if(a)switch(s){case"ON":this.setVisibility(n,!0,t);break;case"OFF":this.setVisibility(n,!1,t);break;case"Toggle":this.setVisibility(n,!a.visible,t);break}}x(this,sn,null)}get hasInitialVisibility(){return r(this,yr)===null||this.getHash()===r(this,yr)}getOrder(){return r(this,ve).size?r(this,wr)?r(this,wr).slice():[...r(this,ve).keys()]:null}getGroups(){return r(this,ve).size>0?gu(r(this,ve)):null}getGroup(e){return r(this,ve).get(e)||null}getHash(){if(r(this,sn)!==null)return r(this,sn);const e=new gm;for(const[t,s]of r(this,ve))e.update(`${t}:${s.visible}`);return x(this,sn,e.hexdigest())}}sn=new WeakMap,ve=new WeakMap,yr=new WeakMap,wr=new WeakMap,yl=new WeakSet,Ch=function(e){const t=e.length;if(t<2)return!0;const s=e[0];for(let n=1;n<t;n++){const a=e[n];let o;if(Array.isArray(a))o=w(this,yl,Ch).call(this,a);else if(r(this,ve).has(a))o=r(this,ve).get(a).visible;else return re(`Optional content group not found: ${a}`),!0;switch(s){case"And":if(!o)return!1;break;case"Or":if(o)return!0;break;case"Not":return!o;default:return!0}}return s==="And"};class o0{constructor(e,{disableRange:t=!1,disableStream:s=!1}){ze(e,'PDFDataTransportStream - missing required "pdfDataRangeTransport" argument.');const{length:n,initialData:a,progressiveDone:o,contentDispositionFilename:l}=e;if(this._queuedChunks=[],this._progressiveDone=o,this._contentDispositionFilename=l,(a==null?void 0:a.length)>0){const d=a instanceof Uint8Array&&a.byteLength===a.buffer.byteLength?a.buffer:new Uint8Array(a).buffer;this._queuedChunks.push(d)}this._pdfDataRangeTransport=e,this._isStreamingSupported=!s,this._isRangeSupported=!t,this._contentLength=n,this._fullRequestReader=null,this._rangeReaders=[],e.addRangeListener((d,h)=>{this._onReceiveData({begin:d,chunk:h})}),e.addProgressListener((d,h)=>{this._onProgress({loaded:d,total:h})}),e.addProgressiveReadListener(d=>{this._onReceiveData({chunk:d})}),e.addProgressiveDoneListener(()=>{this._onProgressiveDone()}),e.transportReady()}_onReceiveData({begin:e,chunk:t}){const s=t instanceof Uint8Array&&t.byteLength===t.buffer.byteLength?t.buffer:new Uint8Array(t).buffer;if(e===void 0)this._fullRequestReader?this._fullRequestReader._enqueue(s):this._queuedChunks.push(s);else{const n=this._rangeReaders.some(function(a){return a._begin!==e?!1:(a._enqueue(s),!0)});ze(n,"_onReceiveData - no `PDFDataTransportStreamRangeReader` instance found.")}}get _progressiveDataLength(){var e,t;return(t=(e=this._fullRequestReader)==null?void 0:e._loaded)!=null?t:0}_onProgress(e){var t,s,n,a;e.total===void 0?(s=(t=this._rangeReaders[0])==null?void 0:t.onProgress)==null||s.call(t,{loaded:e.loaded}):(a=(n=this._fullRequestReader)==null?void 0:n.onProgress)==null||a.call(n,{loaded:e.loaded,total:e.total})}_onProgressiveDone(){var e;(e=this._fullRequestReader)==null||e.progressiveDone(),this._progressiveDone=!0}_removeRangeReader(e){const t=this._rangeReaders.indexOf(e);t>=0&&this._rangeReaders.splice(t,1)}getFullReader(){ze(!this._fullRequestReader,"PDFDataTransportStream.getFullReader can only be called once.");const e=this._queuedChunks;return this._queuedChunks=null,new l0(this,e,this._progressiveDone,this._contentDispositionFilename)}getRangeReader(e,t){if(t<=this._progressiveDataLength)return null;const s=new c0(this,e,t);return this._pdfDataRangeTransport.requestDataRange(e,t),this._rangeReaders.push(s),s}cancelAllRequests(e){var t;(t=this._fullRequestReader)==null||t.cancel(e);for(const s of this._rangeReaders.slice(0))s.cancel(e);this._pdfDataRangeTransport.abort()}}class l0{constructor(e,t,s=!1,n=null){this._stream=e,this._done=s||!1,this._filename=vu(n)?n:null,this._queuedChunks=t||[],this._loaded=0;for(const a of this._queuedChunks)this._loaded+=a.byteLength;this._requests=[],this._headersReady=Promise.resolve(),e._fullRequestReader=this,this.onProgress=null}_enqueue(e){this._done||(this._requests.length>0?this._requests.shift().resolve({value:e,done:!1}):this._queuedChunks.push(e),this._loaded+=e.byteLength)}get headersReady(){return this._headersReady}get filename(){return this._filename}get isRangeSupported(){return this._stream._isRangeSupported}get isStreamingSupported(){return this._stream._isStreamingSupported}get contentLength(){return this._stream._contentLength}async read(){if(this._queuedChunks.length>0)return{value:this._queuedChunks.shift(),done:!1};if(this._done)return{value:void 0,done:!0};const e=Promise.withResolvers();return this._requests.push(e),e.promise}cancel(e){this._done=!0;for(const t of this._requests)t.resolve({value:void 0,done:!0});this._requests.length=0}progressiveDone(){this._done||(this._done=!0)}}class c0{constructor(e,t,s){this._stream=e,this._begin=t,this._end=s,this._queuedChunk=null,this._requests=[],this._done=!1,this.onProgress=null}_enqueue(e){if(!this._done){if(this._requests.length===0)this._queuedChunk=e;else{this._requests.shift().resolve({value:e,done:!1});for(const s of this._requests)s.resolve({value:void 0,done:!0});this._requests.length=0}this._done=!0,this._stream._removeRangeReader(this)}}get isStreamingSupported(){return!1}async read(){if(this._queuedChunk){const t=this._queuedChunk;return this._queuedChunk=null,{value:t,done:!1}}if(this._done)return{value:void 0,done:!0};const e=Promise.withResolvers();return this._requests.push(e),e.promise}cancel(e){this._done=!0;for(const t of this._requests)t.resolve({value:void 0,done:!0});this._requests.length=0,this._stream._removeRangeReader(this)}}function d0(c){let e=!0,t=s("filename\\*","i").exec(c);if(t){t=t[1];let u=l(t);return u=unescape(u),u=d(u),u=h(u),a(u)}if(t=o(c),t){const u=h(t);return a(u)}if(t=s("filename","i").exec(c),t){t=t[1];let u=l(t);return u=h(u),a(u)}function s(u,p){return new RegExp("(?:^|;)\\s*"+u+'\\s*=\\s*([^";\\s][^;\\s]*|"(?:[^"\\\\]|\\\\"?)+"?)',p)}function n(u,p){if(u){if(!/^[\x00-\xFF]+$/.test(p))return p;try{const m=new TextDecoder(u,{fatal:!0}),f=Ld(p);p=m.decode(f),e=!1}catch{}}return p}function a(u){return e&&/[\x80-\xff]/.test(u)&&(u=n("utf-8",u),e&&(u=n("iso-8859-1",u))),u}function o(u){const p=[];let m;const f=s("filename\\*((?!0\\d)\\d+)(\\*?)","ig");for(;(m=f.exec(u))!==null;){let[,b,A,N]=m;if(b=parseInt(b,10),b in p){if(b===0)break;continue}p[b]=[A,N]}const g=[];for(let b=0;b<p.length&&b in p;++b){let[A,N]=p[b];N=l(N),A&&(N=unescape(N),b===0&&(N=d(N))),g.push(N)}return g.join("")}function l(u){if(u.startsWith('"')){const p=u.slice(1).split('\\"');for(let m=0;m<p.length;++m){const f=p[m].indexOf('"');f!==-1&&(p[m]=p[m].slice(0,f),p.length=m+1),p[m]=p[m].replaceAll(/\\(.)/g,"$1")}u=p.join('"')}return u}function d(u){const p=u.indexOf("'");if(p===-1)return u;const m=u.slice(0,p),g=u.slice(p+1).replace(/^[^']*'/,"");return n(m,g)}function h(u){return!u.startsWith("=?")||/[\x00-\x19\x80-\xff]/.test(u)?u:u.replaceAll(/=\?([\w-]*)\?([QqBb])\?((?:[^?]|\?(?!=))*)\?=/g,function(p,m,f,g){if(f==="q"||f==="Q")return g=g.replaceAll("_"," "),g=g.replaceAll(/=([0-9a-fA-F]{2})/g,function(b,A){return String.fromCharCode(parseInt(A,16))}),n(m,g);try{g=atob(g)}catch{}return n(m,g)})}return""}function Tm(c,e){const t=new Headers;if(!c||!e||typeof e!="object")return t;for(const s in e){const n=e[s];n!==void 0&&t.append(s,n)}return t}function Od(c){try{return new URL(c).origin}catch{}return null}function Rm({responseHeaders:c,isHttp:e,rangeChunkSize:t,disableRange:s}){const n={allowRangeRequests:!1,suggestedLength:void 0},a=parseInt(c.get("Content-Length"),10);return!Number.isInteger(a)||(n.suggestedLength=a,a<=2*t)||s||!e||c.get("Accept-Ranges")!=="bytes"||(c.get("Content-Encoding")||"identity")!=="identity"||(n.allowRangeRequests=!0),n}function Pm(c){const e=c.get("Content-Disposition");if(e){let t=d0(e);if(t.includes("%"))try{t=decodeURIComponent(t)}catch{}if(vu(t))return t}return null}function $d(c,e){return c===404||c===0&&e.startsWith("file:")?new Fo('Missing PDF "'+e+'".'):new nd(`Unexpected server response (${c}) while retrieving PDF "${e}".`,c)}function Mm(c){return c===200||c===206}function Im(c,e,t){return{method:"GET",headers:c,signal:t.signal,mode:"cors",credentials:e?"include":"same-origin",redirect:"follow"}}function Lm(c){return c instanceof Uint8Array?c.buffer:c instanceof ArrayBuffer?c:(re(`getArrayBuffer - unexpected data format: ${c}`),new Uint8Array(c).buffer)}class cp{constructor(e){Z(this,"_responseOrigin",null);this.source=e,this.isHttp=/^https?:/i.test(e.url),this.headers=Tm(this.isHttp,e.httpHeaders),this._fullRequestReader=null,this._rangeRequestReaders=[]}get _progressiveDataLength(){var e,t;return(t=(e=this._fullRequestReader)==null?void 0:e._loaded)!=null?t:0}getFullReader(){return ze(!this._fullRequestReader,"PDFFetchStream.getFullReader can only be called once."),this._fullRequestReader=new h0(this),this._fullRequestReader}getRangeReader(e,t){if(t<=this._progressiveDataLength)return null;const s=new u0(this,e,t);return this._rangeRequestReaders.push(s),s}cancelAllRequests(e){var t;(t=this._fullRequestReader)==null||t.cancel(e);for(const s of this._rangeRequestReaders.slice(0))s.cancel(e)}}class h0{constructor(e){this._stream=e,this._reader=null,this._loaded=0,this._filename=null;const t=e.source;this._withCredentials=t.withCredentials||!1,this._contentLength=t.length,this._headersCapability=Promise.withResolvers(),this._disableRange=t.disableRange||!1,this._rangeChunkSize=t.rangeChunkSize,!this._rangeChunkSize&&!this._disableRange&&(this._disableRange=!0),this._abortController=new AbortController,this._isStreamingSupported=!t.disableStream,this._isRangeSupported=!t.disableRange;const s=new Headers(e.headers),n=t.url;fetch(n,Im(s,this._withCredentials,this._abortController)).then(a=>{if(e._responseOrigin=Od(a.url),!Mm(a.status))throw $d(a.status,n);this._reader=a.body.getReader(),this._headersCapability.resolve();const o=a.headers,{allowRangeRequests:l,suggestedLength:d}=Rm({responseHeaders:o,isHttp:e.isHttp,rangeChunkSize:this._rangeChunkSize,disableRange:this._disableRange});this._isRangeSupported=l,this._contentLength=d||this._contentLength,this._filename=Pm(o),!this._isStreamingSupported&&this._isRangeSupported&&this.cancel(new jn("Streaming is disabled."))}).catch(this._headersCapability.reject),this.onProgress=null}get headersReady(){return this._headersCapability.promise}get filename(){return this._filename}get contentLength(){return this._contentLength}get isRangeSupported(){return this._isRangeSupported}get isStreamingSupported(){return this._isStreamingSupported}async read(){var s;await this._headersCapability.promise;const{value:e,done:t}=await this._reader.read();return t?{value:e,done:t}:(this._loaded+=e.byteLength,(s=this.onProgress)==null||s.call(this,{loaded:this._loaded,total:this._contentLength}),{value:Lm(e),done:!1})}cancel(e){var t;(t=this._reader)==null||t.cancel(e),this._abortController.abort()}}class u0{constructor(e,t,s){this._stream=e,this._reader=null,this._loaded=0;const n=e.source;this._withCredentials=n.withCredentials||!1,this._readCapability=Promise.withResolvers(),this._isStreamingSupported=!n.disableStream,this._abortController=new AbortController;const a=new Headers(e.headers);a.append("Range",`bytes=${t}-${s-1}`);const o=n.url;fetch(o,Im(a,this._withCredentials,this._abortController)).then(l=>{const d=Od(l.url);if(d!==e._responseOrigin)throw new Error(`Expected range response-origin "${d}" to match "${e._responseOrigin}".`);if(!Mm(l.status))throw $d(l.status,o);this._readCapability.resolve(),this._reader=l.body.getReader()}).catch(this._readCapability.reject),this.onProgress=null}get isStreamingSupported(){return this._isStreamingSupported}async read(){var s;await this._readCapability.promise;const{value:e,done:t}=await this._reader.read();return t?{value:e,done:t}:(this._loaded+=e.byteLength,(s=this.onProgress)==null||s.call(this,{loaded:this._loaded}),{value:Lm(e),done:!1})}cancel(e){var t;(t=this._reader)==null||t.cancel(e),this._abortController.abort()}}const Wd=200,qd=206;function p0(c){const e=c.response;return typeof e!="string"?e:Ld(e).buffer}class m0{constructor({url:e,httpHeaders:t,withCredentials:s}){Z(this,"_responseOrigin",null);this.url=e,this.isHttp=/^https?:/i.test(e),this.headers=Tm(this.isHttp,t),this.withCredentials=s||!1,this.currXhrId=0,this.pendingRequests=Object.create(null)}request(e){const t=new XMLHttpRequest,s=this.currXhrId++,n=this.pendingRequests[s]={xhr:t};t.open("GET",this.url),t.withCredentials=this.withCredentials;for(const[a,o]of this.headers)t.setRequestHeader(a,o);return this.isHttp&&"begin"in e&&"end"in e?(t.setRequestHeader("Range",`bytes=${e.begin}-${e.end-1}`),n.expectedStatus=qd):n.expectedStatus=Wd,t.responseType="arraybuffer",ze(e.onError,"Expected `onError` callback to be provided."),t.onerror=()=>{e.onError(t.status)},t.onreadystatechange=this.onStateChange.bind(this,s),t.onprogress=this.onProgress.bind(this,s),n.onHeadersReceived=e.onHeadersReceived,n.onDone=e.onDone,n.onError=e.onError,n.onProgress=e.onProgress,t.send(null),s}onProgress(e,t){var n;const s=this.pendingRequests[e];s&&((n=s.onProgress)==null||n.call(s,t))}onStateChange(e,t){const s=this.pendingRequests[e];if(!s)return;const n=s.xhr;if(n.readyState>=2&&s.onHeadersReceived&&(s.onHeadersReceived(),delete s.onHeadersReceived),n.readyState!==4||!(e in this.pendingRequests))return;if(delete this.pendingRequests[e],n.status===0&&this.isHttp){s.onError(n.status);return}const a=n.status||Wd;if(!(a===Wd&&s.expectedStatus===qd)&&a!==s.expectedStatus){s.onError(n.status);return}const l=p0(n);if(a===qd){const d=n.getResponseHeader("Content-Range"),h=/bytes (\d+)-(\d+)\/(\d+)/.exec(d);h?s.onDone({begin:parseInt(h[1],10),chunk:l}):(re('Missing or invalid "Content-Range" header.'),s.onError(0))}else l?s.onDone({begin:0,chunk:l}):s.onError(n.status)}getRequestXhr(e){return this.pendingRequests[e].xhr}isPendingRequest(e){return e in this.pendingRequests}abortRequest(e){const t=this.pendingRequests[e].xhr;delete this.pendingRequests[e],t.abort()}}class f0{constructor(e){this._source=e,this._manager=new m0(e),this._rangeChunkSize=e.rangeChunkSize,this._fullRequestReader=null,this._rangeRequestReaders=[]}_onRangeRequestReaderClosed(e){const t=this._rangeRequestReaders.indexOf(e);t>=0&&this._rangeRequestReaders.splice(t,1)}getFullReader(){return ze(!this._fullRequestReader,"PDFNetworkStream.getFullReader can only be called once."),this._fullRequestReader=new g0(this._manager,this._source),this._fullRequestReader}getRangeReader(e,t){const s=new x0(this._manager,e,t);return s.onClosed=this._onRangeRequestReaderClosed.bind(this),this._rangeRequestReaders.push(s),s}cancelAllRequests(e){var t;(t=this._fullRequestReader)==null||t.cancel(e);for(const s of this._rangeRequestReaders.slice(0))s.cancel(e)}}class g0{constructor(e,t){this._manager=e,this._url=t.url,this._fullRequestId=e.request({onHeadersReceived:this._onHeadersReceived.bind(this),onDone:this._onDone.bind(this),onError:this._onError.bind(this),onProgress:this._onProgress.bind(this)}),this._headersCapability=Promise.withResolvers(),this._disableRange=t.disableRange||!1,this._contentLength=t.length,this._rangeChunkSize=t.rangeChunkSize,!this._rangeChunkSize&&!this._disableRange&&(this._disableRange=!0),this._isStreamingSupported=!1,this._isRangeSupported=!1,this._cachedChunks=[],this._requests=[],this._done=!1,this._storedError=void 0,this._filename=null,this.onProgress=null}_onHeadersReceived(){const e=this._fullRequestId,t=this._manager.getRequestXhr(e);this._manager._responseOrigin=Od(t.responseURL);const s=t.getAllResponseHeaders(),n=new Headers(s?s.trimStart().replace(/[^\S ]+$/,"").split(/[\r\n]+/).map(l=>{const[d,...h]=l.split(": ");return[d,h.join(": ")]}):[]),{allowRangeRequests:a,suggestedLength:o}=Rm({responseHeaders:n,isHttp:this._manager.isHttp,rangeChunkSize:this._rangeChunkSize,disableRange:this._disableRange});a&&(this._isRangeSupported=!0),this._contentLength=o||this._contentLength,this._filename=Pm(n),this._isRangeSupported&&this._manager.abortRequest(e),this._headersCapability.resolve()}_onDone(e){if(e&&(this._requests.length>0?this._requests.shift().resolve({value:e.chunk,done:!1}):this._cachedChunks.push(e.chunk)),this._done=!0,!(this._cachedChunks.length>0)){for(const t of this._requests)t.resolve({value:void 0,done:!0});this._requests.length=0}}_onError(e){this._storedError=$d(e,this._url),this._headersCapability.reject(this._storedError);for(const t of this._requests)t.reject(this._storedError);this._requests.length=0,this._cachedChunks.length=0}_onProgress(e){var t;(t=this.onProgress)==null||t.call(this,{loaded:e.loaded,total:e.lengthComputable?e.total:this._contentLength})}get filename(){return this._filename}get isRangeSupported(){return this._isRangeSupported}get isStreamingSupported(){return this._isStreamingSupported}get contentLength(){return this._contentLength}get headersReady(){return this._headersCapability.promise}async read(){if(await this._headersCapability.promise,this._storedError)throw this._storedError;if(this._cachedChunks.length>0)return{value:this._cachedChunks.shift(),done:!1};if(this._done)return{value:void 0,done:!0};const e=Promise.withResolvers();return this._requests.push(e),e.promise}cancel(e){this._done=!0,this._headersCapability.reject(e);for(const t of this._requests)t.resolve({value:void 0,done:!0});this._requests.length=0,this._manager.isPendingRequest(this._fullRequestId)&&this._manager.abortRequest(this._fullRequestId),this._fullRequestReader=null}}class x0{constructor(e,t,s){this._manager=e,this._url=e.url,this._requestId=e.request({begin:t,end:s,onHeadersReceived:this._onHeadersReceived.bind(this),onDone:this._onDone.bind(this),onError:this._onError.bind(this),onProgress:this._onProgress.bind(this)}),this._requests=[],this._queuedChunk=null,this._done=!1,this._storedError=void 0,this.onProgress=null,this.onClosed=null}_onHeadersReceived(){var t;const e=Od((t=this._manager.getRequestXhr(this._requestId))==null?void 0:t.responseURL);e!==this._manager._responseOrigin&&(this._storedError=new Error(`Expected range response-origin "${e}" to match "${this._manager._responseOrigin}".`),this._onError(0))}_close(){var e;(e=this.onClosed)==null||e.call(this,this)}_onDone(e){const t=e.chunk;this._requests.length>0?this._requests.shift().resolve({value:t,done:!1}):this._queuedChunk=t,this._done=!0;for(const s of this._requests)s.resolve({value:void 0,done:!0});this._requests.length=0,this._close()}_onError(e){var t;(t=this._storedError)!=null||(this._storedError=$d(e,this._url));for(const s of this._requests)s.reject(this._storedError);this._requests.length=0,this._queuedChunk=null}_onProgress(e){var t;this.isStreamingSupported||(t=this.onProgress)==null||t.call(this,{loaded:e.loaded})}get isStreamingSupported(){return!1}async read(){if(this._storedError)throw this._storedError;if(this._queuedChunk!==null){const t=this._queuedChunk;return this._queuedChunk=null,{value:t,done:!1}}if(this._done)return{value:void 0,done:!0};const e=Promise.withResolvers();return this._requests.push(e),e.promise}cancel(e){this._done=!0;for(const t of this._requests)t.resolve({value:void 0,done:!0});this._requests.length=0,this._manager.isPendingRequest(this._requestId)&&this._manager.abortRequest(this._requestId),this._close()}}const b0=/^[a-z][a-z0-9\-+.]+:/i;function v0(c){if(b0.test(c))return new URL(c);const e=process.getBuiltinModule("url");return new URL(e.pathToFileURL(c))}class y0{constructor(e){this.source=e,this.url=v0(e.url),ze(this.url.protocol==="file:","PDFNodeStream only supports file:// URLs."),this._fullRequestReader=null,this._rangeRequestReaders=[]}get _progressiveDataLength(){var e,t;return(t=(e=this._fullRequestReader)==null?void 0:e._loaded)!=null?t:0}getFullReader(){return ze(!this._fullRequestReader,"PDFNodeStream.getFullReader can only be called once."),this._fullRequestReader=new w0(this),this._fullRequestReader}getRangeReader(e,t){if(t<=this._progressiveDataLength)return null;const s=new N0(this,e,t);return this._rangeRequestReaders.push(s),s}cancelAllRequests(e){var t;(t=this._fullRequestReader)==null||t.cancel(e);for(const s of this._rangeRequestReaders.slice(0))s.cancel(e)}}class w0{constructor(e){this._url=e.url,this._done=!1,this._storedError=null,this.onProgress=null;const t=e.source;this._contentLength=t.length,this._loaded=0,this._filename=null,this._disableRange=t.disableRange||!1,this._rangeChunkSize=t.rangeChunkSize,!this._rangeChunkSize&&!this._disableRange&&(this._disableRange=!0),this._isStreamingSupported=!t.disableStream,this._isRangeSupported=!t.disableRange,this._readableStream=null,this._readCapability=Promise.withResolvers(),this._headersCapability=Promise.withResolvers();const s=process.getBuiltinModule("fs");s.promises.lstat(this._url).then(n=>{this._contentLength=n.size,this._setReadableStream(s.createReadStream(this._url)),this._headersCapability.resolve()},n=>{n.code==="ENOENT"&&(n=new Fo(`Missing PDF "${this._url}".`)),this._storedError=n,this._headersCapability.reject(n)})}get headersReady(){return this._headersCapability.promise}get filename(){return this._filename}get contentLength(){return this._contentLength}get isRangeSupported(){return this._isRangeSupported}get isStreamingSupported(){return this._isStreamingSupported}async read(){var s;if(await this._readCapability.promise,this._done)return{value:void 0,done:!0};if(this._storedError)throw this._storedError;const e=this._readableStream.read();return e===null?(this._readCapability=Promise.withResolvers(),this.read()):(this._loaded+=e.length,(s=this.onProgress)==null||s.call(this,{loaded:this._loaded,total:this._contentLength}),{value:new Uint8Array(e).buffer,done:!1})}cancel(e){if(!this._readableStream){this._error(e);return}this._readableStream.destroy(e)}_error(e){this._storedError=e,this._readCapability.resolve()}_setReadableStream(e){this._readableStream=e,e.on("readable",()=>{this._readCapability.resolve()}),e.on("end",()=>{e.destroy(),this._done=!0,this._readCapability.resolve()}),e.on("error",t=>{this._error(t)}),!this._isStreamingSupported&&this._isRangeSupported&&this._error(new jn("streaming is disabled")),this._storedError&&this._readableStream.destroy(this._storedError)}}class N0{constructor(e,t,s){this._url=e.url,this._done=!1,this._storedError=null,this.onProgress=null,this._loaded=0,this._readableStream=null,this._readCapability=Promise.withResolvers();const n=e.source;this._isStreamingSupported=!n.disableStream;const a=process.getBuiltinModule("fs");this._setReadableStream(a.createReadStream(this._url,{start:t,end:s-1}))}get isStreamingSupported(){return this._isStreamingSupported}async read(){var s;if(await this._readCapability.promise,this._done)return{value:void 0,done:!0};if(this._storedError)throw this._storedError;const e=this._readableStream.read();return e===null?(this._readCapability=Promise.withResolvers(),this.read()):(this._loaded+=e.length,(s=this.onProgress)==null||s.call(this,{loaded:this._loaded}),{value:new Uint8Array(e).buffer,done:!1})}cancel(e){if(!this._readableStream){this._error(e);return}this._readableStream.destroy(e)}_error(e){this._storedError=e,this._readCapability.resolve()}_setReadableStream(e){this._readableStream=e,e.on("readable",()=>{this._readCapability.resolve()}),e.on("end",()=>{e.destroy(),this._done=!0,this._readCapability.resolve()}),e.on("error",t=>{this._error(t)}),this._storedError&&this._readableStream.destroy(this._storedError)}}const j0=1e5,kt=30,A0=.8;var xp,nn,Mt,wl,Nl,sa,bi,jl,Al,ia,Nr,jr,an,Ar,_l,_r,na,Sl,Cl,aa,ra,El,rn,Sr,Oi,Dm,Fm,Eh,Jt,Fc,kh,Om,$m;const Ve=class Ve{constructor({textContentSource:e,container:t,viewport:s}){v(this,Oi);v(this,nn,Promise.withResolvers());v(this,Mt,null);v(this,wl,!1);v(this,Nl,!!((xp=globalThis.FontInspector)!=null&&xp.enabled));v(this,sa,null);v(this,bi,null);v(this,jl,0);v(this,Al,0);v(this,ia,null);v(this,Nr,null);v(this,jr,0);v(this,an,0);v(this,Ar,Object.create(null));v(this,_l,[]);v(this,_r,null);v(this,na,[]);v(this,Sl,new WeakMap);v(this,Cl,null);var d;if(e instanceof ReadableStream)x(this,_r,e);else if(typeof e=="object")x(this,_r,new ReadableStream({start(h){h.enqueue(e),h.close()}}));else throw new Error('No "textContentSource" parameter specified.');x(this,Mt,x(this,Nr,t)),x(this,an,s.scale*(globalThis.devicePixelRatio||1)),x(this,jr,s.rotation),x(this,bi,{div:null,properties:null,ctx:null});const{pageWidth:n,pageHeight:a,pageX:o,pageY:l}=s.rawDims;x(this,Cl,[1,0,0,-1,-o,l+a]),x(this,Al,n),x(this,jl,a),w(d=Ve,Jt,Om).call(d),Fa(t,s),r(this,nn).promise.finally(()=>{r(Ve,Sr).delete(this),x(this,bi,null),x(this,Ar,null)}).catch(()=>{})}static get fontFamilyMap(){const{isWindows:e,isFirefox:t}=At.platform;return de(this,"fontFamilyMap",new Map([["sans-serif",`${e&&t?"Calibri, ":""}sans-serif`],["monospace",`${e&&t?"Lucida Console, ":""}monospace`]]))}render(){const e=()=>{r(this,ia).read().then(({value:t,done:s})=>{var n;if(s){r(this,nn).resolve();return}(n=r(this,sa))!=null||x(this,sa,t.lang),Object.assign(r(this,Ar),t.styles),w(this,Oi,Dm).call(this,t.items),e()},r(this,nn).reject)};return x(this,ia,r(this,_r).getReader()),r(Ve,Sr).add(this),e(),r(this,nn).promise}update({viewport:e,onBefore:t=null}){var a;const s=e.scale*(globalThis.devicePixelRatio||1),n=e.rotation;if(n!==r(this,jr)&&(t==null||t(),x(this,jr,n),Fa(r(this,Nr),{rotation:n})),s!==r(this,an)){t==null||t(),x(this,an,s);const o={div:null,properties:null,ctx:w(a=Ve,Jt,Fc).call(a,r(this,sa))};for(const l of r(this,na))o.properties=r(this,Sl).get(l),o.div=l,w(this,Oi,Eh).call(this,o)}}cancel(){var t;const e=new jn("TextLayer task cancelled.");(t=r(this,ia))==null||t.cancel(e).catch(()=>{}),x(this,ia,null),r(this,nn).reject(e)}get textDivs(){return r(this,na)}get textContentItemsStr(){return r(this,_l)}static cleanup(){if(!(r(this,Sr).size>0)){r(this,aa).clear();for(const{canvas:e}of r(this,ra).values())e.remove();r(this,ra).clear()}}};nn=new WeakMap,Mt=new WeakMap,wl=new WeakMap,Nl=new WeakMap,sa=new WeakMap,bi=new WeakMap,jl=new WeakMap,Al=new WeakMap,ia=new WeakMap,Nr=new WeakMap,jr=new WeakMap,an=new WeakMap,Ar=new WeakMap,_l=new WeakMap,_r=new WeakMap,na=new WeakMap,Sl=new WeakMap,Cl=new WeakMap,aa=new WeakMap,ra=new WeakMap,El=new WeakMap,rn=new WeakMap,Sr=new WeakMap,Oi=new WeakSet,Dm=function(e){var n,a,o;if(r(this,wl))return;(o=(a=r(this,bi)).ctx)!=null||(a.ctx=w(n=Ve,Jt,Fc).call(n,r(this,sa)));const t=r(this,na),s=r(this,_l);for(const l of e){if(t.length>j0){re("Ignoring additional textDivs for performance reasons."),x(this,wl,!0);return}if(l.str===void 0){if(l.type==="beginMarkedContentProps"||l.type==="beginMarkedContent"){const d=r(this,Mt);x(this,Mt,document.createElement("span")),r(this,Mt).classList.add("markedContent"),l.id!==null&&r(this,Mt).setAttribute("id",`${l.id}`),d.append(r(this,Mt))}else l.type==="endMarkedContent"&&x(this,Mt,r(this,Mt).parentNode);continue}s.push(l.str),w(this,Oi,Fm).call(this,l)}},Fm=function(e){var b;const t=document.createElement("span"),s={angle:0,canvasWidth:0,hasText:e.str!=="",hasEOL:e.hasEOL,fontSize:0};r(this,na).push(t);const n=X.transform(r(this,Cl),e.transform);let a=Math.atan2(n[1],n[0]);const o=r(this,Ar)[e.fontName];o.vertical&&(a+=Math.PI/2);let l=r(this,Nl)&&o.fontSubstitution||o.fontFamily;l=Ve.fontFamilyMap.get(l)||l;const d=Math.hypot(n[2],n[3]),h=d*w(b=Ve,Jt,$m).call(b,l,r(this,sa));let u,p;a===0?(u=n[4],p=n[5]-h):(u=n[4]+h*Math.sin(a),p=n[5]-h*Math.cos(a));const m="calc(var(--scale-factor)*",f=t.style;r(this,Mt)===r(this,Nr)?(f.left=`${(100*u/r(this,Al)).toFixed(2)}%`,f.top=`${(100*p/r(this,jl)).toFixed(2)}%`):(f.left=`${m}${u.toFixed(2)}px)`,f.top=`${m}${p.toFixed(2)}px)`),f.fontSize=`${m}${(r(Ve,rn)*d).toFixed(2)}px)`,f.fontFamily=l,s.fontSize=d,t.setAttribute("role","presentation"),t.textContent=e.str,t.dir=e.dir,r(this,Nl)&&(t.dataset.fontName=o.fontSubstitutionLoadedName||e.fontName),a!==0&&(s.angle=a*(180/Math.PI));let g=!1;if(e.str.length>1)g=!0;else if(e.str!==" "&&e.transform[0]!==e.transform[3]){const A=Math.abs(e.transform[0]),N=Math.abs(e.transform[3]);A!==N&&Math.max(A,N)/Math.min(A,N)>1.5&&(g=!0)}if(g&&(s.canvasWidth=o.vertical?e.height:e.width),r(this,Sl).set(t,s),r(this,bi).div=t,r(this,bi).properties=s,w(this,Oi,Eh).call(this,r(this,bi)),s.hasText&&r(this,Mt).append(t),s.hasEOL){const A=document.createElement("br");A.setAttribute("role","presentation"),r(this,Mt).append(A)}},Eh=function(e){var l;const{div:t,properties:s,ctx:n}=e,{style:a}=t;let o="";if(r(Ve,rn)>1&&(o=`scale(${1/r(Ve,rn)})`),s.canvasWidth!==0&&s.hasText){const{fontFamily:d}=a,{canvasWidth:h,fontSize:u}=s;w(l=Ve,Jt,kh).call(l,n,u*r(this,an),d);const{width:p}=n.measureText(t.textContent);p>0&&(o=`scaleX(${h*r(this,an)/p}) ${o}`)}s.angle!==0&&(o=`rotate(${s.angle}deg) ${o}`),o.length>0&&(a.transform=o)},Jt=new WeakSet,Fc=function(e=null){let t=r(this,ra).get(e||(e=""));if(!t){const s=document.createElement("canvas");s.className="hiddenCanvasElement",s.lang=e,document.body.append(s),t=s.getContext("2d",{alpha:!1,willReadFrequently:!0}),r(this,ra).set(e,t),r(this,El).set(t,{size:0,family:""})}return t},kh=function(e,t,s){const n=r(this,El).get(e);t===n.size&&s===n.family||(e.font=`${t}px ${s}`,n.size=t,n.family=s)},Om=function(){if(r(this,rn)!==null)return;const e=document.createElement("div");e.style.opacity=0,e.style.lineHeight=1,e.style.fontSize="1px",e.style.position="absolute",e.textContent="X",document.body.append(e),x(this,rn,e.getBoundingClientRect().height),e.remove()},$m=function(e,t){const s=r(this,aa).get(e);if(s)return s;const n=w(this,Jt,Fc).call(this,t);n.canvas.width=n.canvas.height=kt,w(this,Jt,kh).call(this,n,kt,e);const a=n.measureText("");let o=a.fontBoundingBoxAscent,l=Math.abs(a.fontBoundingBoxDescent);if(o){const u=o/(o+l);return r(this,aa).set(e,u),n.canvas.width=n.canvas.height=0,u}n.strokeStyle="red",n.clearRect(0,0,kt,kt),n.strokeText("g",0,0);let d=n.getImageData(0,0,kt,kt).data;l=0;for(let u=d.length-1-3;u>=0;u-=4)if(d[u]>0){l=Math.ceil(u/4/kt);break}n.clearRect(0,0,kt,kt),n.strokeText("A",0,kt),d=n.getImageData(0,0,kt,kt).data,o=0;for(let u=0,p=d.length;u<p;u+=4)if(d[u]>0){o=kt-Math.floor(u/4/kt);break}n.canvas.width=n.canvas.height=0;const h=o?o/(o+l):A0;return r(this,aa).set(e,h),h},v(Ve,Jt),v(Ve,aa,new Map),v(Ve,ra,new Map),v(Ve,El,new WeakMap),v(Ve,rn,null),v(Ve,Sr,new Set);let Oo=Ve;class $o{static textContent(e){const t=[],s={items:t,styles:Object.create(null)};function n(a){var d;if(!a)return;let o=null;const l=a.name;if(l==="#text")o=a.value;else if($o.shouldBuildText(l))(d=a==null?void 0:a.attributes)!=null&&d.textContent?o=a.attributes.textContent:a.value&&(o=a.value);else return;if(o!==null&&t.push({str:o}),!!a.children)for(const h of a.children)n(h)}return n(e),s}static shouldBuildText(e){return!(e==="textarea"||e==="input"||e==="option"||e==="select")}}const _0=65536,S0=100,C0=5e3,E0=ft?zx:$x,k0=ft?Ux:Am,T0=ft?Bx:Hx,R0=ft?Gx:Em;function P0(c={}){var Se,he;typeof c=="string"||c instanceof URL?c={url:c}:(c instanceof ArrayBuffer||ArrayBuffer.isView(c))&&(c={data:c});const e=new Th,{docId:t}=e,s=c.url?M0(c.url):null,n=c.data?I0(c.data):null,a=c.httpHeaders||null,o=c.withCredentials===!0,l=(Se=c.password)!=null?Se:null,d=c.range instanceof Hm?c.range:null,h=Number.isInteger(c.rangeChunkSize)&&c.rangeChunkSize>0?c.rangeChunkSize:_0;let u=c.worker instanceof tr?c.worker:null;const p=c.verbosity,m=typeof c.docBaseUrl=="string"&&!Fd(c.docBaseUrl)?c.docBaseUrl:null,f=typeof c.cMapUrl=="string"?c.cMapUrl:null,g=c.cMapPacked!==!1,b=c.CMapReaderFactory||k0,A=typeof c.standardFontDataUrl=="string"?c.standardFontDataUrl:null,N=c.StandardFontDataFactory||R0,j=c.stopAtErrors!==!0,E=Number.isInteger(c.maxImageSize)&&c.maxImageSize>-1?c.maxImageSize:-1,_=c.isEvalSupported!==!1,y=typeof c.isOffscreenCanvasSupported=="boolean"?c.isOffscreenCanvasSupported:!ft,C=typeof c.isImageDecoderSupported=="boolean"?c.isImageDecoderSupported:!ft&&(At.platform.isFirefox||!globalThis.chrome),R=Number.isInteger(c.canvasMaxAreaInBytes)?c.canvasMaxAreaInBytes:-1,S=typeof c.disableFontFace=="boolean"?c.disableFontFace:ft,k=c.fontExtraProperties===!0,M=c.enableXfa===!0,L=c.ownerDocument||globalThis.document,O=c.disableRange===!0,$=c.disableStream===!0,q=c.disableAutoFetch===!0,F=c.pdfBug===!0,P=c.CanvasFactory||E0,I=c.FilterFactory||T0,K=c.enableHWA===!0,ie=d?d.length:(he=c.length)!=null?he:NaN,ue=typeof c.useSystemFonts=="boolean"?c.useSystemFonts:!ft&&!S,te=typeof c.useWorkerFetch=="boolean"?c.useWorkerFetch:b===Am&&N===Em&&f&&A&&fo(f,document.baseURI)&&fo(A,document.baseURI),V=null;xx(p);const le={canvasFactory:new P({ownerDocument:L,enableHWA:K}),filterFactory:new I({docId:t,ownerDocument:L}),cMapReaderFactory:te?null:new b({baseUrl:f,isCompressed:g}),standardFontDataFactory:te?null:new N({baseUrl:A})};if(!u){const hs={verbosity:p,port:Ii.workerPort};u=hs.port?tr.fromPort(hs):new tr(hs),e._worker=u}const ye={docId:t,apiVersion:"4.10.38",data:n,password:l,disableAutoFetch:q,rangeChunkSize:h,length:ie,docBaseUrl:m,enableXfa:M,evaluatorOptions:{maxImageSize:E,disableFontFace:S,ignoreErrors:j,isEvalSupported:_,isOffscreenCanvasSupported:y,isImageDecoderSupported:C,canvasMaxAreaInBytes:R,fontExtraProperties:k,useSystemFonts:ue,cMapUrl:te?f:null,standardFontDataUrl:te?A:null}},z={disableFontFace:S,fontExtraProperties:k,ownerDocument:L,pdfBug:F,styleElement:V,loadingParams:{disableAutoFetch:q,enableXfa:M}};return u.promise.then(function(){if(e.destroyed)throw new Error("Loading aborted");if(u.destroyed)throw new Error("Worker was destroyed");const hs=u.messageHandler.sendWithPromise("GetDocRequest",ye,n?[n.buffer]:null);let Ps;if(d)Ps=new o0(d,{disableRange:O,disableStream:$});else if(!n){if(!s)throw new Error("getDocument - no `url` parameter provided.");let us;if(ft)if(fo(s)){if(typeof fetch>"u"||typeof Response>"u"||!("body"in Response.prototype))throw new Error("getDocument - the Fetch API was disabled in Node.js, see `--no-experimental-fetch`.");us=cp}else us=y0;else us=fo(s)?cp:f0;Ps=new us({url:s,length:ie,httpHeaders:a,withCredentials:o,rangeChunkSize:h,disableRange:O,disableStream:$})}return hs.then(us=>{if(e.destroyed)throw new Error("Loading aborted");if(u.destroyed)throw new Error("Worker was destroyed");const Q=new vo(t,us,u.port),Ms=new O0(Q,e,Ps,z,le);e._transport=Ms,Q.send("Ready",null)})}).catch(e._capability.reject),e}function M0(c){if(c instanceof URL)return c.href;try{return new URL(c,window.location).href}catch{if(ft&&typeof c=="string")return c}throw new Error("Invalid PDF url data: either string or URL-object is expected in the url property.")}function I0(c){if(ft&&typeof Buffer<"u"&&c instanceof Buffer)throw new Error("Please provide binary data as `Uint8Array`, rather than `Buffer`.");if(c instanceof Uint8Array&&c.byteLength===c.buffer.byteLength)return c;if(typeof c=="string")return Ld(c);if(c instanceof ArrayBuffer||ArrayBuffer.isView(c)||typeof c=="object"&&!isNaN(c==null?void 0:c.length))return new Uint8Array(c);throw new Error("Invalid PDF binary data: either TypedArray, string, or array-like object is expected in the data property.")}function dp(c){return typeof c=="object"&&Number.isInteger(c==null?void 0:c.num)&&c.num>=0&&Number.isInteger(c==null?void 0:c.gen)&&c.gen>=0}var yd;const wd=class wd{constructor(){this._capability=Promise.withResolvers(),this._transport=null,this._worker=null,this.docId=`d${bt(wd,yd)._++}`,this.destroyed=!1,this.onPassword=null,this.onProgress=null}get promise(){return this._capability.promise}async destroy(){var e,t,s,n;this.destroyed=!0;try{(e=this._worker)!=null&&e.port&&(this._worker._pendingDestroy=!0),await((t=this._transport)==null?void 0:t.destroy())}catch(a){throw(s=this._worker)!=null&&s.port&&delete this._worker._pendingDestroy,a}this._transport=null,(n=this._worker)==null||n.destroy(),this._worker=null}};yd=new WeakMap,v(wd,yd,0);let Th=wd;class Hm{constructor(e,t,s=!1,n=null){this.length=e,this.initialData=t,this.progressiveDone=s,this.contentDispositionFilename=n,this._rangeListeners=[],this._progressListeners=[],this._progressiveReadListeners=[],this._progressiveDoneListeners=[],this._readyCapability=Promise.withResolvers()}addRangeListener(e){this._rangeListeners.push(e)}addProgressListener(e){this._progressListeners.push(e)}addProgressiveReadListener(e){this._progressiveReadListeners.push(e)}addProgressiveDoneListener(e){this._progressiveDoneListeners.push(e)}onDataRange(e,t){for(const s of this._rangeListeners)s(e,t)}onDataProgress(e,t){this._readyCapability.promise.then(()=>{for(const s of this._progressListeners)s(e,t)})}onDataProgressiveRead(e){this._readyCapability.promise.then(()=>{for(const t of this._progressiveReadListeners)t(e)})}onDataProgressiveDone(){this._readyCapability.promise.then(()=>{for(const e of this._progressiveDoneListeners)e()})}transportReady(){this._readyCapability.resolve()}requestDataRange(e,t){Ae("Abstract method PDFDataRangeTransport.requestDataRange")}abort(){}}class L0{constructor(e,t){this._pdfInfo=e,this._transport=t}get annotationStorage(){return this._transport.annotationStorage}get canvasFactory(){return this._transport.canvasFactory}get filterFactory(){return this._transport.filterFactory}get numPages(){return this._pdfInfo.numPages}get fingerprints(){return this._pdfInfo.fingerprints}get isPureXfa(){return de(this,"isPureXfa",!!this._transport._htmlForXfa)}get allXfaHtml(){return this._transport._htmlForXfa}getPage(e){return this._transport.getPage(e)}getPageIndex(e){return this._transport.getPageIndex(e)}getDestinations(){return this._transport.getDestinations()}getDestination(e){return this._transport.getDestination(e)}getPageLabels(){return this._transport.getPageLabels()}getPageLayout(){return this._transport.getPageLayout()}getPageMode(){return this._transport.getPageMode()}getViewerPreferences(){return this._transport.getViewerPreferences()}getOpenAction(){return this._transport.getOpenAction()}getAttachments(){return this._transport.getAttachments()}getJSActions(){return this._transport.getDocJSActions()}getOutline(){return this._transport.getOutline()}getOptionalContentConfig({intent:e="display"}={}){const{renderingIntent:t}=this._transport.getRenderingIntent(e);return this._transport.getOptionalContentConfig(t)}getPermissions(){return this._transport.getPermissions()}getMetadata(){return this._transport.getMetadata()}getMarkInfo(){return this._transport.getMarkInfo()}getData(){return this._transport.getData()}saveDocument(){return this._transport.saveDocument()}getDownloadInfo(){return this._transport.downloadInfoCapability.promise}cleanup(e=!1){return this._transport.startCleanup(e||this.isPureXfa)}destroy(){return this.loadingTask.destroy()}cachedPageNumber(e){return this._transport.cachedPageNumber(e)}get loadingParams(){return this._transport.loadingParams}get loadingTask(){return this._transport.loadingTask}getFieldObjects(){return this._transport.getFieldObjects()}hasJSActions(){return this._transport.hasJSActions()}getCalculationOrderIds(){return this._transport.getCalculationOrderIds()}}var on,vi,ls,Xa,Oc;class D0{constructor(e,t,s,n=!1){v(this,ls);v(this,on,null);v(this,vi,!1);this._pageIndex=e,this._pageInfo=t,this._transport=s,this._stats=n?new Ku:null,this._pdfBug=n,this.commonObjs=s.commonObjs,this.objs=new Bm,this._maybeCleanupAfterRender=!1,this._intentStates=new Map,this.destroyed=!1}get pageNumber(){return this._pageIndex+1}get rotate(){return this._pageInfo.rotate}get ref(){return this._pageInfo.ref}get userUnit(){return this._pageInfo.userUnit}get view(){return this._pageInfo.view}getViewport({scale:e,rotation:t=this.rotate,offsetX:s=0,offsetY:n=0,dontFlip:a=!1}={}){return new uc({viewBox:this.view,userUnit:this.userUnit,scale:e,rotation:t,offsetX:s,offsetY:n,dontFlip:a})}getAnnotations({intent:e="display"}={}){const{renderingIntent:t}=this._transport.getRenderingIntent(e);return this._transport.getAnnotations(this._pageIndex,t)}getJSActions(){return this._transport.getPageJSActions(this._pageIndex)}get filterFactory(){return this._transport.filterFactory}get isPureXfa(){return de(this,"isPureXfa",!!this._transport._htmlForXfa)}async getXfa(){var e;return((e=this._transport._htmlForXfa)==null?void 0:e.children[this._pageIndex])||null}render({canvasContext:e,viewport:t,intent:s="display",annotationMode:n=Ui.ENABLE,transform:a=null,background:o=null,optionalContentConfigPromise:l=null,annotationCanvasMap:d=null,pageColors:h=null,printAnnotationStorage:u=null,isEditing:p=!1}){var _,y;(_=this._stats)==null||_.time("Overall");const m=this._transport.getRenderingIntent(s,n,u,p),{renderingIntent:f,cacheKey:g}=m;x(this,vi,!1),w(this,ls,Oc).call(this),l||(l=this._transport.getOptionalContentConfig(f));let b=this._intentStates.get(g);b||(b=Object.create(null),this._intentStates.set(g,b)),b.streamReaderCancelTimeout&&(clearTimeout(b.streamReaderCancelTimeout),b.streamReaderCancelTimeout=null);const A=!!(f&Yt.PRINT);b.displayReadyCapability||(b.displayReadyCapability=Promise.withResolvers(),b.operatorList={fnArray:[],argsArray:[],lastChunk:!1,separateAnnots:null},(y=this._stats)==null||y.time("Page Request"),this._pumpOperatorList(m));const N=C=>{var R;b.renderTasks.delete(j),(this._maybeCleanupAfterRender||A)&&x(this,vi,!0),w(this,ls,Xa).call(this,!A),C?(j.capability.reject(C),this._abortOperatorList({intentState:b,reason:C instanceof Error?C:new Error(C)})):j.capability.resolve(),this._stats&&(this._stats.timeEnd("Rendering"),this._stats.timeEnd("Overall"),(R=globalThis.Stats)!=null&&R.enabled&&globalThis.Stats.add(this.pageNumber,this._stats))},j=new Ph({callback:N,params:{canvasContext:e,viewport:t,transform:a,background:o},objs:this.objs,commonObjs:this.commonObjs,annotationCanvasMap:d,operatorList:b.operatorList,pageIndex:this._pageIndex,canvasFactory:this._transport.canvasFactory,filterFactory:this._transport.filterFactory,useRequestAnimationFrame:!A,pdfBug:this._pdfBug,pageColors:h});(b.renderTasks||(b.renderTasks=new Set)).add(j);const E=j.task;return Promise.all([b.displayReadyCapability.promise,l]).then(([C,R])=>{var S;if(this.destroyed){N();return}if((S=this._stats)==null||S.time("Rendering"),!(R.renderingIntent&f))throw new Error("Must use the same `intent`-argument when calling the `PDFPageProxy.render` and `PDFDocumentProxy.getOptionalContentConfig` methods.");j.initializeGraphics({transparency:C,optionalContentConfig:R}),j.operatorListChanged()}).catch(N),E}getOperatorList({intent:e="display",annotationMode:t=Ui.ENABLE,printAnnotationStorage:s=null,isEditing:n=!1}={}){var h;function a(){l.operatorList.lastChunk&&(l.opListReadCapability.resolve(l.operatorList),l.renderTasks.delete(d))}const o=this._transport.getRenderingIntent(e,t,s,n,!0);let l=this._intentStates.get(o.cacheKey);l||(l=Object.create(null),this._intentStates.set(o.cacheKey,l));let d;return l.opListReadCapability||(d=Object.create(null),d.operatorListChanged=a,l.opListReadCapability=Promise.withResolvers(),(l.renderTasks||(l.renderTasks=new Set)).add(d),l.operatorList={fnArray:[],argsArray:[],lastChunk:!1,separateAnnots:null},(h=this._stats)==null||h.time("Page Request"),this._pumpOperatorList(o)),l.opListReadCapability.promise}streamTextContent({includeMarkedContent:e=!1,disableNormalization:t=!1}={}){return this._transport.messageHandler.sendWithStream("GetTextContent",{pageIndex:this._pageIndex,includeMarkedContent:e===!0,disableNormalization:t===!0},{highWaterMark:100,size(n){return n.items.length}})}getTextContent(e={}){if(this._transport._htmlForXfa)return this.getXfa().then(s=>$o.textContent(s));const t=this.streamTextContent(e);return new Promise(function(s,n){function a(){o.read().then(function({value:d,done:h}){var u;if(h){s(l);return}(u=l.lang)!=null||(l.lang=d.lang),Object.assign(l.styles,d.styles),l.items.push(...d.items),a()},n)}const o=t.getReader(),l={items:[],styles:Object.create(null),lang:null};a()})}getStructTree(){return this._transport.getStructTree(this._pageIndex)}_destroy(){this.destroyed=!0;const e=[];for(const t of this._intentStates.values())if(this._abortOperatorList({intentState:t,reason:new Error("Page was destroyed."),force:!0}),!t.opListReadCapability)for(const s of t.renderTasks)e.push(s.completed),s.cancel();return this.objs.clear(),x(this,vi,!1),w(this,ls,Oc).call(this),Promise.all(e)}cleanup(e=!1){x(this,vi,!0);const t=w(this,ls,Xa).call(this,!1);return e&&t&&this._stats&&(this._stats=new Ku),t}_startRenderPage(e,t){var n,a;const s=this._intentStates.get(t);s&&((n=this._stats)==null||n.timeEnd("Page Request"),(a=s.displayReadyCapability)==null||a.resolve(e))}_renderPageChunk(e,t){for(let s=0,n=e.length;s<n;s++)t.operatorList.fnArray.push(e.fnArray[s]),t.operatorList.argsArray.push(e.argsArray[s]);t.operatorList.lastChunk=e.lastChunk,t.operatorList.separateAnnots=e.separateAnnots;for(const s of t.renderTasks)s.operatorListChanged();e.lastChunk&&w(this,ls,Xa).call(this,!0)}_pumpOperatorList({renderingIntent:e,cacheKey:t,annotationStorageSerializable:s,modifiedIds:n}){const{map:a,transfer:o}=s,d=this._transport.messageHandler.sendWithStream("GetOperatorList",{pageIndex:this._pageIndex,intent:e,cacheKey:t,annotationStorage:a,modifiedIds:n},o).getReader(),h=this._intentStates.get(t);h.streamReader=d;const u=()=>{d.read().then(({value:p,done:m})=>{if(m){h.streamReader=null;return}this._transport.destroyed||(this._renderPageChunk(p,h),u())},p=>{if(h.streamReader=null,!this._transport.destroyed){if(h.operatorList){h.operatorList.lastChunk=!0;for(const m of h.renderTasks)m.operatorListChanged();w(this,ls,Xa).call(this,!0)}if(h.displayReadyCapability)h.displayReadyCapability.reject(p);else if(h.opListReadCapability)h.opListReadCapability.reject(p);else throw p}})};u()}_abortOperatorList({intentState:e,reason:t,force:s=!1}){if(e.streamReader){if(e.streamReaderCancelTimeout&&(clearTimeout(e.streamReaderCancelTimeout),e.streamReaderCancelTimeout=null),!s){if(e.renderTasks.size>0)return;if(t instanceof bu){let n=S0;t.extraDelay>0&&t.extraDelay<1e3&&(n+=t.extraDelay),e.streamReaderCancelTimeout=setTimeout(()=>{e.streamReaderCancelTimeout=null,this._abortOperatorList({intentState:e,reason:t,force:!0})},n);return}}if(e.streamReader.cancel(new jn(t.message)).catch(()=>{}),e.streamReader=null,!this._transport.destroyed){for(const[n,a]of this._intentStates)if(a===e){this._intentStates.delete(n);break}this.cleanup()}}}get stats(){return this._stats}}on=new WeakMap,vi=new WeakMap,ls=new WeakSet,Xa=function(e=!1){if(w(this,ls,Oc).call(this),!r(this,vi)||this.destroyed)return!1;if(e)return x(this,on,setTimeout(()=>{x(this,on,null),w(this,ls,Xa).call(this,!1)},C0)),!1;for(const{renderTasks:t,operatorList:s}of this._intentStates.values())if(t.size>0||!s.lastChunk)return!1;return this._intentStates.clear(),this.objs.clear(),x(this,vi,!1),!0},Oc=function(){r(this,on)&&(clearTimeout(r(this,on)),x(this,on,null))};var yi,Nd;class F0{constructor(){v(this,yi,new Map);v(this,Nd,Promise.resolve())}postMessage(e,t){const s={data:structuredClone(e,t?{transfer:t}:null)};r(this,Nd).then(()=>{for(const[n]of r(this,yi))n.call(this,s)})}addEventListener(e,t,s=null){let n=null;if((s==null?void 0:s.signal)instanceof AbortSignal){const{signal:a}=s;if(a.aborted){re("LoopbackPort - cannot use an `aborted` signal.");return}const o=()=>this.removeEventListener(e,t);n=()=>a.removeEventListener("abort",o),a.addEventListener("abort",o)}r(this,yi).set(t,n)}removeEventListener(e,t){const s=r(this,yi).get(t);s==null||s(),r(this,yi).delete(t)}terminate(){for(const[,e]of r(this,yi))e==null||e();r(this,yi).clear()}}yi=new WeakMap,Nd=new WeakMap;var jd,oa,la,Cr,$c,Er,Hc;const Te=class Te{constructor({name:e=null,port:t=null,verbosity:s=bx()}={}){v(this,Cr);var n;if(this.name=e,this.destroyed=!1,this.verbosity=s,this._readyCapability=Promise.withResolvers(),this._port=null,this._webWorker=null,this._messageHandler=null,t){if((n=r(Te,la))!=null&&n.has(t))throw new Error("Cannot use more than one PDFWorker per port.");(r(Te,la)||x(Te,la,new WeakMap)).set(t,this),this._initializeFromPort(t);return}this._initialize()}get promise(){return this._readyCapability.promise}get port(){return this._port}get messageHandler(){return this._messageHandler}_initializeFromPort(e){this._port=e,this._messageHandler=new vo("main","worker",e),this._messageHandler.on("ready",function(){}),w(this,Cr,$c).call(this)}_initialize(){if(r(Te,oa)||r(Te,Er,Hc)){this._setupFakeWorker();return}let{workerSrc:e}=Te;try{Te._isSameOrigin(window.location.href,e)||(e=Te._createCDNWrapper(new URL(e,window.location).href));const t=new Worker(e,{type:"module"}),s=new vo("main","worker",t),n=()=>{a.abort(),s.destroy(),t.terminate(),this.destroyed?this._readyCapability.reject(new Error("Worker was destroyed")):this._setupFakeWorker()},a=new AbortController;t.addEventListener("error",()=>{this._webWorker||n()},{signal:a.signal}),s.on("test",l=>{if(a.abort(),this.destroyed||!l){n();return}this._messageHandler=s,this._port=t,this._webWorker=t,w(this,Cr,$c).call(this)}),s.on("ready",l=>{if(a.abort(),this.destroyed){n();return}try{o()}catch{this._setupFakeWorker()}});const o=()=>{const l=new Uint8Array;s.send("test",l,[l.buffer])};o();return}catch{Id("The worker has been disabled.")}this._setupFakeWorker()}_setupFakeWorker(){r(Te,oa)||(re("Setting up fake worker."),x(Te,oa,!0)),Te._setupFakeWorkerGlobal.then(e=>{if(this.destroyed){this._readyCapability.reject(new Error("Worker was destroyed"));return}const t=new F0;this._port=t;const s=`fake${bt(Te,jd)._++}`,n=new vo(s+"_worker",s,t);e.setup(n,t),this._messageHandler=new vo(s,s+"_worker",t),w(this,Cr,$c).call(this)}).catch(e=>{this._readyCapability.reject(new Error(`Setting up fake worker failed: "${e.message}".`))})}destroy(){var e,t,s;this.destroyed=!0,(e=this._webWorker)==null||e.terminate(),this._webWorker=null,(t=r(Te,la))==null||t.delete(this._port),this._port=null,(s=this._messageHandler)==null||s.destroy(),this._messageHandler=null}static fromPort(e){var s;if(!(e!=null&&e.port))throw new Error("PDFWorker.fromPort - invalid method signature.");const t=(s=r(this,la))==null?void 0:s.get(e.port);if(t){if(t._pendingDestroy)throw new Error("PDFWorker.fromPort - the worker is being destroyed.\nPlease remember to await `PDFDocumentLoadingTask.destroy()`-calls.");return t}return new Te(e)}static get workerSrc(){if(Ii.workerSrc)return Ii.workerSrc;throw new Error('No "GlobalWorkerOptions.workerSrc" specified.')}static get _setupFakeWorkerGlobal(){return de(this,"_setupFakeWorkerGlobal",(async()=>r(this,Er,Hc)?r(this,Er,Hc):(await import(this.workerSrc)).WorkerMessageHandler)())}};jd=new WeakMap,oa=new WeakMap,la=new WeakMap,Cr=new WeakSet,$c=function(){this._readyCapability.resolve(),this._messageHandler.send("configure",{verbosity:this.verbosity})},Er=new WeakSet,Hc=function(){var e;try{return((e=globalThis.pdfjsWorker)==null?void 0:e.WorkerMessageHandler)||null}catch{return null}},v(Te,Er),v(Te,jd,0),v(Te,oa,!1),v(Te,la),ft&&(x(Te,oa,!0),Ii.workerSrc||(Ii.workerSrc="./pdf.worker.mjs")),Te._isSameOrigin=(e,t)=>{let s;try{if(s=new URL(e),!s.origin||s.origin==="null")return!1}catch{return!1}const n=new URL(t,s);return s.origin===n.origin},Te._createCDNWrapper=e=>{const t=`await import("${e}");`;return URL.createObjectURL(new Blob([t],{type:"text/javascript"}))};let tr=Te;var wi,qs,kr,Tr,Ni,ca,Ao;class O0{constructor(e,t,s,n,a){v(this,ca);v(this,wi,new Map);v(this,qs,new Map);v(this,kr,new Map);v(this,Tr,new Map);v(this,Ni,null);this.messageHandler=e,this.loadingTask=t,this.commonObjs=new Bm,this.fontLoader=new Fx({ownerDocument:n.ownerDocument,styleElement:n.styleElement}),this.loadingParams=n.loadingParams,this._params=n,this.canvasFactory=a.canvasFactory,this.filterFactory=a.filterFactory,this.cMapReaderFactory=a.cMapReaderFactory,this.standardFontDataFactory=a.standardFontDataFactory,this.destroyed=!1,this.destroyCapability=null,this._networkStream=s,this._fullReader=null,this._lastProgress=null,this.downloadInfoCapability=Promise.withResolvers(),this.setupMessageHandler()}get annotationStorage(){return de(this,"annotationStorage",new Nu)}getRenderingIntent(e,t=Ui.ENABLE,s=null,n=!1,a=!1){let o=Yt.DISPLAY,l=vh;switch(e){case"any":o=Yt.ANY;break;case"display":break;case"print":o=Yt.PRINT;break;default:re(`getRenderingIntent - invalid intent: ${e}`)}const d=o&Yt.PRINT&&s instanceof bm?s:this.annotationStorage;switch(t){case Ui.DISABLE:o+=Yt.ANNOTATIONS_DISABLE;break;case Ui.ENABLE:break;case Ui.ENABLE_FORMS:o+=Yt.ANNOTATIONS_FORMS;break;case Ui.ENABLE_STORAGE:o+=Yt.ANNOTATIONS_STORAGE,l=d.serializable;break;default:re(`getRenderingIntent - invalid annotationMode: ${t}`)}n&&(o+=Yt.IS_EDITING),a&&(o+=Yt.OPLIST);const{ids:h,hash:u}=d.modifiedIds,p=[o,l.hash,u];return{renderingIntent:o,cacheKey:p.join("_"),annotationStorageSerializable:l,modifiedIds:h}}destroy(){var s;if(this.destroyCapability)return this.destroyCapability.promise;this.destroyed=!0,this.destroyCapability=Promise.withResolvers(),(s=r(this,Ni))==null||s.reject(new Error("Worker was destroyed during onPassword callback"));const e=[];for(const n of r(this,qs).values())e.push(n._destroy());r(this,qs).clear(),r(this,kr).clear(),r(this,Tr).clear(),this.hasOwnProperty("annotationStorage")&&this.annotationStorage.resetModified();const t=this.messageHandler.sendWithPromise("Terminate",null);return e.push(t),Promise.all(e).then(()=>{var n,a;this.commonObjs.clear(),this.fontLoader.clear(),r(this,wi).clear(),this.filterFactory.destroy(),Oo.cleanup(),(n=this._networkStream)==null||n.cancelAllRequests(new jn("Worker was terminated.")),(a=this.messageHandler)==null||a.destroy(),this.messageHandler=null,this.destroyCapability.resolve()},this.destroyCapability.reject),this.destroyCapability.promise}setupMessageHandler(){const{messageHandler:e,loadingTask:t}=this;e.on("GetReader",(s,n)=>{ze(this._networkStream,"GetReader - no `IPDFStream` instance available."),this._fullReader=this._networkStream.getFullReader(),this._fullReader.onProgress=a=>{this._lastProgress={loaded:a.loaded,total:a.total}},n.onPull=()=>{this._fullReader.read().then(function({value:a,done:o}){if(o){n.close();return}ze(a instanceof ArrayBuffer,"GetReader - expected an ArrayBuffer."),n.enqueue(new Uint8Array(a),1,[a])}).catch(a=>{n.error(a)})},n.onCancel=a=>{this._fullReader.cancel(a),n.ready.catch(o=>{if(!this.destroyed)throw o})}}),e.on("ReaderHeadersReady",async s=>{var l;await this._fullReader.headersReady;const{isStreamingSupported:n,isRangeSupported:a,contentLength:o}=this._fullReader;return(!n||!a)&&(this._lastProgress&&((l=t.onProgress)==null||l.call(t,this._lastProgress)),this._fullReader.onProgress=d=>{var h;(h=t.onProgress)==null||h.call(t,{loaded:d.loaded,total:d.total})}),{isStreamingSupported:n,isRangeSupported:a,contentLength:o}}),e.on("GetRangeReader",(s,n)=>{ze(this._networkStream,"GetRangeReader - no `IPDFStream` instance available.");const a=this._networkStream.getRangeReader(s.begin,s.end);if(!a){n.close();return}n.onPull=()=>{a.read().then(function({value:o,done:l}){if(l){n.close();return}ze(o instanceof ArrayBuffer,"GetRangeReader - expected an ArrayBuffer."),n.enqueue(new Uint8Array(o),1,[o])}).catch(o=>{n.error(o)})},n.onCancel=o=>{a.cancel(o),n.ready.catch(l=>{if(!this.destroyed)throw l})}}),e.on("GetDoc",({pdfInfo:s})=>{this._numPages=s.numPages,this._htmlForXfa=s.htmlForXfa,delete s.htmlForXfa,t._capability.resolve(new L0(s,this))}),e.on("DocException",s=>{t._capability.reject(Tt(s))}),e.on("PasswordRequest",s=>{x(this,Ni,Promise.withResolvers());try{if(!t.onPassword)throw Tt(s);const n=a=>{a instanceof Error?r(this,Ni).reject(a):r(this,Ni).resolve({password:a})};t.onPassword(n,s.code)}catch(n){r(this,Ni).reject(n)}return r(this,Ni).promise}),e.on("DataLoaded",s=>{var n;(n=t.onProgress)==null||n.call(t,{loaded:s.length,total:s.length}),this.downloadInfoCapability.resolve(s)}),e.on("StartRenderPage",s=>{if(this.destroyed)return;r(this,qs).get(s.pageIndex)._startRenderPage(s.transparency,s.cacheKey)}),e.on("commonobj",([s,n,a])=>{var o;if(this.destroyed||this.commonObjs.has(s))return null;switch(n){case"Font":const{disableFontFace:l,fontExtraProperties:d,pdfBug:h}=this._params;if("error"in a){const f=a.error;re(`Error during font loading: ${f}`),this.commonObjs.resolve(s,f);break}const u=h&&((o=globalThis.FontInspector)!=null&&o.enabled)?(f,g)=>globalThis.FontInspector.fontAdded(f,g):null,p=new Ox(a,{disableFontFace:l,fontExtraProperties:d,inspectFont:u});this.fontLoader.bind(p).catch(()=>e.sendWithPromise("FontFallback",{id:s})).finally(()=>{!d&&p.data&&(p.data=null),this.commonObjs.resolve(s,p)});break;case"CopyLocalImage":const{imageRef:m}=a;ze(m,"The imageRef must be defined.");for(const f of r(this,qs).values())for(const[,g]of f.objs)if((g==null?void 0:g.ref)===m)return g.dataLen?(this.commonObjs.resolve(s,structuredClone(g)),g.dataLen):null;break;case"FontPath":case"Image":case"Pattern":this.commonObjs.resolve(s,a);break;default:throw new Error(`Got unknown common object type ${n}`)}return null}),e.on("obj",([s,n,a,o])=>{var d;if(this.destroyed)return;const l=r(this,qs).get(n);if(!l.objs.has(s)){if(l._intentStates.size===0){(d=o==null?void 0:o.bitmap)==null||d.close();return}switch(a){case"Image":l.objs.resolve(s,o),(o==null?void 0:o.dataLen)>px&&(l._maybeCleanupAfterRender=!0);break;case"Pattern":l.objs.resolve(s,o);break;default:throw new Error(`Got unknown object type ${a}`)}}}),e.on("DocProgress",s=>{var n;this.destroyed||(n=t.onProgress)==null||n.call(t,{loaded:s.loaded,total:s.total})}),e.on("FetchBuiltInCMap",async s=>{if(this.destroyed)throw new Error("Worker was destroyed.");if(!this.cMapReaderFactory)throw new Error("CMapReaderFactory not initialized, see the `useWorkerFetch` parameter.");return this.cMapReaderFactory.fetch(s)}),e.on("FetchStandardFontData",async s=>{if(this.destroyed)throw new Error("Worker was destroyed.");if(!this.standardFontDataFactory)throw new Error("StandardFontDataFactory not initialized, see the `useWorkerFetch` parameter.");return this.standardFontDataFactory.fetch(s)})}getData(){return this.messageHandler.sendWithPromise("GetData",null)}saveDocument(){var s,n;this.annotationStorage.size<=0&&re("saveDocument called while `annotationStorage` is empty, please use the getData-method instead.");const{map:e,transfer:t}=this.annotationStorage.serializable;return this.messageHandler.sendWithPromise("SaveDocument",{isPureXfa:!!this._htmlForXfa,numPages:this._numPages,annotationStorage:e,filename:(n=(s=this._fullReader)==null?void 0:s.filename)!=null?n:null},t).finally(()=>{this.annotationStorage.resetModified()})}getPage(e){if(!Number.isInteger(e)||e<=0||e>this._numPages)return Promise.reject(new Error("Invalid page request."));const t=e-1,s=r(this,kr).get(t);if(s)return s;const n=this.messageHandler.sendWithPromise("GetPage",{pageIndex:t}).then(a=>{if(this.destroyed)throw new Error("Transport destroyed");a.refStr&&r(this,Tr).set(a.refStr,e);const o=new D0(t,a,this,this._params.pdfBug);return r(this,qs).set(t,o),o});return r(this,kr).set(t,n),n}getPageIndex(e){return dp(e)?this.messageHandler.sendWithPromise("GetPageIndex",{num:e.num,gen:e.gen}):Promise.reject(new Error("Invalid pageIndex request."))}getAnnotations(e,t){return this.messageHandler.sendWithPromise("GetAnnotations",{pageIndex:e,intent:t})}getFieldObjects(){return w(this,ca,Ao).call(this,"GetFieldObjects")}hasJSActions(){return w(this,ca,Ao).call(this,"HasJSActions")}getCalculationOrderIds(){return this.messageHandler.sendWithPromise("GetCalculationOrderIds",null)}getDestinations(){return this.messageHandler.sendWithPromise("GetDestinations",null)}getDestination(e){return typeof e!="string"?Promise.reject(new Error("Invalid destination request.")):this.messageHandler.sendWithPromise("GetDestination",{id:e})}getPageLabels(){return this.messageHandler.sendWithPromise("GetPageLabels",null)}getPageLayout(){return this.messageHandler.sendWithPromise("GetPageLayout",null)}getPageMode(){return this.messageHandler.sendWithPromise("GetPageMode",null)}getViewerPreferences(){return this.messageHandler.sendWithPromise("GetViewerPreferences",null)}getOpenAction(){return this.messageHandler.sendWithPromise("GetOpenAction",null)}getAttachments(){return this.messageHandler.sendWithPromise("GetAttachments",null)}getDocJSActions(){return w(this,ca,Ao).call(this,"GetDocJSActions")}getPageJSActions(e){return this.messageHandler.sendWithPromise("GetPageJSActions",{pageIndex:e})}getStructTree(e){return this.messageHandler.sendWithPromise("GetStructTree",{pageIndex:e})}getOutline(){return this.messageHandler.sendWithPromise("GetOutline",null)}getOptionalContentConfig(e){return w(this,ca,Ao).call(this,"GetOptionalContentConfig").then(t=>new r0(t,e))}getPermissions(){return this.messageHandler.sendWithPromise("GetPermissions",null)}getMetadata(){const e="GetMetadata",t=r(this,wi).get(e);if(t)return t;const s=this.messageHandler.sendWithPromise(e,null).then(n=>{var a,o,l,d;return{info:n[0],metadata:n[1]?new n0(n[1]):null,contentDispositionFilename:(o=(a=this._fullReader)==null?void 0:a.filename)!=null?o:null,contentLength:(d=(l=this._fullReader)==null?void 0:l.contentLength)!=null?d:null}});return r(this,wi).set(e,s),s}getMarkInfo(){return this.messageHandler.sendWithPromise("GetMarkInfo",null)}async startCleanup(e=!1){if(!this.destroyed){await this.messageHandler.sendWithPromise("Cleanup",null);for(const t of r(this,qs).values())if(!t.cleanup())throw new Error(`startCleanup: Page ${t.pageNumber} is currently rendering.`);this.commonObjs.clear(),e||this.fontLoader.clear(),r(this,wi).clear(),this.filterFactory.destroy(!0),Oo.cleanup()}}cachedPageNumber(e){var s;if(!dp(e))return null;const t=e.gen===0?`${e.num}R`:`${e.num}R${e.gen}`;return(s=r(this,Tr).get(t))!=null?s:null}}wi=new WeakMap,qs=new WeakMap,kr=new WeakMap,Tr=new WeakMap,Ni=new WeakMap,ca=new WeakSet,Ao=function(e,t=null){const s=r(this,wi).get(e);if(s)return s;const n=this.messageHandler.sendWithPromise(e,t);return r(this,wi).set(e,n),n};const po=Symbol("INITIAL_DATA");var Ht,kl,Rh;class Bm{constructor(){v(this,kl);v(this,Ht,Object.create(null))}get(e,t=null){if(t){const n=w(this,kl,Rh).call(this,e);return n.promise.then(()=>t(n.data)),null}const s=r(this,Ht)[e];if(!s||s.data===po)throw new Error(`Requesting object that isn't resolved yet ${e}.`);return s.data}has(e){const t=r(this,Ht)[e];return!!t&&t.data!==po}delete(e){const t=r(this,Ht)[e];return!t||t.data===po?!1:(delete r(this,Ht)[e],!0)}resolve(e,t=null){const s=w(this,kl,Rh).call(this,e);s.data=t,s.resolve()}clear(){var e;for(const t in r(this,Ht)){const{data:s}=r(this,Ht)[t];(e=s==null?void 0:s.bitmap)==null||e.close()}x(this,Ht,Object.create(null))}*[Symbol.iterator](){for(const e in r(this,Ht)){const{data:t}=r(this,Ht)[e];t!==po&&(yield[e,t])}}}Ht=new WeakMap,kl=new WeakSet,Rh=function(e){var t;return(t=r(this,Ht))[e]||(t[e]={...Promise.withResolvers(),data:po})};var ln;class $0{constructor(e){v(this,ln,null);x(this,ln,e),this.onContinue=null}get promise(){return r(this,ln).capability.promise}cancel(e=0){r(this,ln).cancel(null,e)}get separateAnnots(){const{separateAnnots:e}=r(this,ln).operatorList;if(!e)return!1;const{annotationCanvasMap:t}=r(this,ln);return e.form||e.canvas&&(t==null?void 0:t.size)>0}}ln=new WeakMap;var cn,da;const Rn=class Rn{constructor({callback:e,params:t,objs:s,commonObjs:n,annotationCanvasMap:a,operatorList:o,pageIndex:l,canvasFactory:d,filterFactory:h,useRequestAnimationFrame:u=!1,pdfBug:p=!1,pageColors:m=null}){v(this,cn,null);this.callback=e,this.params=t,this.objs=s,this.commonObjs=n,this.annotationCanvasMap=a,this.operatorListIdx=null,this.operatorList=o,this._pageIndex=l,this.canvasFactory=d,this.filterFactory=h,this._pdfBug=p,this.pageColors=m,this.running=!1,this.graphicsReadyCallback=null,this.graphicsReady=!1,this._useRequestAnimationFrame=u===!0&&typeof window<"u",this.cancelled=!1,this.capability=Promise.withResolvers(),this.task=new $0(this),this._cancelBound=this.cancel.bind(this),this._continueBound=this._continue.bind(this),this._scheduleNextBound=this._scheduleNext.bind(this),this._nextBound=this._next.bind(this),this._canvas=t.canvasContext.canvas}get completed(){return this.capability.promise.catch(function(){})}initializeGraphics({transparency:e=!1,optionalContentConfig:t}){var l,d;if(this.cancelled)return;if(this._canvas){if(r(Rn,da).has(this._canvas))throw new Error("Cannot use the same canvas during multiple render() operations. Use different canvas or ensure previous operations were cancelled or completed.");r(Rn,da).add(this._canvas)}this._pdfBug&&((l=globalThis.StepperManager)!=null&&l.enabled)&&(this.stepper=globalThis.StepperManager.create(this._pageIndex),this.stepper.init(this.operatorList),this.stepper.nextBreakPoint=this.stepper.getNextBreakPoint());const{canvasContext:s,viewport:n,transform:a,background:o}=this.params;this.gfx=new er(s,this.commonObjs,this.objs,this.canvasFactory,this.filterFactory,{optionalContentConfig:t},this.annotationCanvasMap,this.pageColors),this.gfx.beginDrawing({transform:a,viewport:n,transparency:e,background:o}),this.operatorListIdx=0,this.graphicsReady=!0,(d=this.graphicsReadyCallback)==null||d.call(this)}cancel(e=null,t=0){var s;this.running=!1,this.cancelled=!0,(s=this.gfx)==null||s.endDrawing(),r(this,cn)&&(window.cancelAnimationFrame(r(this,cn)),x(this,cn,null)),r(Rn,da).delete(this._canvas),this.callback(e||new bu(`Rendering cancelled, page ${this._pageIndex+1}`,t))}operatorListChanged(){var e;if(!this.graphicsReady){this.graphicsReadyCallback||(this.graphicsReadyCallback=this._continueBound);return}(e=this.stepper)==null||e.updateOperatorList(this.operatorList),!this.running&&this._continue()}_continue(){this.running=!0,!this.cancelled&&(this.task.onContinue?this.task.onContinue(this._scheduleNextBound):this._scheduleNext())}_scheduleNext(){this._useRequestAnimationFrame?x(this,cn,window.requestAnimationFrame(()=>{x(this,cn,null),this._nextBound().catch(this._cancelBound)})):Promise.resolve().then(this._nextBound).catch(this._cancelBound)}async _next(){this.cancelled||(this.operatorListIdx=this.gfx.executeOperatorList(this.operatorList,this.operatorListIdx,this._continueBound,this.stepper),this.operatorListIdx===this.operatorList.argsArray.length&&(this.running=!1,this.operatorList.lastChunk&&(this.gfx.endDrawing(),r(Rn,da).delete(this._canvas),this.callback())))}};cn=new WeakMap,da=new WeakMap,v(Rn,da,new WeakSet);let Ph=Rn;const H0="4.10.38",B0="f9bea397f";function hp(c){return Math.floor(Math.max(0,Math.min(1,c))*255).toString(16).padStart(2,"0")}function mo(c){return Math.max(0,Math.min(255,255*c))}class up{static CMYK_G([e,t,s,n]){return["G",1-Math.min(1,.3*e+.59*s+.11*t+n)]}static G_CMYK([e]){return["CMYK",0,0,0,1-e]}static G_RGB([e]){return["RGB",e,e,e]}static G_rgb([e]){return e=mo(e),[e,e,e]}static G_HTML([e]){const t=hp(e);return`#${t}${t}${t}`}static RGB_G([e,t,s]){return["G",.3*e+.59*t+.11*s]}static RGB_rgb(e){return e.map(mo)}static RGB_HTML(e){return`#${e.map(hp).join("")}`}static T_HTML(){return"#00000000"}static T_rgb(){return[null]}static CMYK_RGB([e,t,s,n]){return["RGB",1-Math.min(1,e+n),1-Math.min(1,s+n),1-Math.min(1,t+n)]}static CMYK_rgb([e,t,s,n]){return[mo(1-Math.min(1,e+n)),mo(1-Math.min(1,s+n)),mo(1-Math.min(1,t+n))]}static CMYK_HTML(e){const t=this.CMYK_RGB(e).slice(1);return this.RGB_HTML(t)}static RGB_CMYK([e,t,s]){const n=1-e,a=1-t,o=1-s,l=Math.min(n,a,o);return["CMYK",n,a,o,l]}}class z0{create(e,t,s=!1){if(e<=0||t<=0)throw new Error("Invalid SVG dimensions");const n=this._createSVG("svg:svg");return n.setAttribute("version","1.1"),s||(n.setAttribute("width",`${e}px`),n.setAttribute("height",`${t}px`)),n.setAttribute("preserveAspectRatio","none"),n.setAttribute("viewBox",`0 0 ${e} ${t}`),n}createElement(e){if(typeof e!="string")throw new Error("Invalid SVG element type");return this._createSVG(e)}_createSVG(e){Ae("Abstract method `_createSVG` called.")}}class Au extends z0{_createSVG(e){return document.createElementNS(ni,e)}}class zm{static setupStorage(e,t,s,n,a){const o=n.getValue(t,{value:null});switch(s.name){case"textarea":if(o.value!==null&&(e.textContent=o.value),a==="print")break;e.addEventListener("input",l=>{n.setValue(t,{value:l.target.value})});break;case"input":if(s.attributes.type==="radio"||s.attributes.type==="checkbox"){if(o.value===s.attributes.xfaOn?e.setAttribute("checked",!0):o.value===s.attributes.xfaOff&&e.removeAttribute("checked"),a==="print")break;e.addEventListener("change",l=>{n.setValue(t,{value:l.target.checked?l.target.getAttribute("xfaOn"):l.target.getAttribute("xfaOff")})})}else{if(o.value!==null&&e.setAttribute("value",o.value),a==="print")break;e.addEventListener("input",l=>{n.setValue(t,{value:l.target.value})})}break;case"select":if(o.value!==null){e.setAttribute("value",o.value);for(const l of s.children)l.attributes.value===o.value?l.attributes.selected=!0:l.attributes.hasOwnProperty("selected")&&delete l.attributes.selected}e.addEventListener("input",l=>{const d=l.target.options,h=d.selectedIndex===-1?"":d[d.selectedIndex].value;n.setValue(t,{value:h})});break}}static setAttributes({html:e,element:t,storage:s=null,intent:n,linkService:a}){const{attributes:o}=t,l=e instanceof HTMLAnchorElement;o.type==="radio"&&(o.name=`${o.name}-${n}`);for(const[d,h]of Object.entries(o))if(h!=null)switch(d){case"class":h.length&&e.setAttribute(d,h.join(" "));break;case"dataId":break;case"id":e.setAttribute("data-element-id",h);break;case"style":Object.assign(e.style,h);break;case"textContent":e.textContent=h;break;default:(!l||d!=="href"&&d!=="newWindow")&&e.setAttribute(d,h)}l&&a.addLinkAttributes(e,o.href,o.newWindow),s&&o.dataId&&this.setupStorage(e,o.dataId,t,s)}static render(e){var p,m;const t=e.annotationStorage,s=e.linkService,n=e.xfaHtml,a=e.intent||"display",o=document.createElement(n.name);n.attributes&&this.setAttributes({html:o,element:n,intent:a,linkService:s});const l=a!=="richText",d=e.div;if(d.append(o),e.viewport){const f=`matrix(${e.viewport.transform.join(",")})`;d.style.transform=f}l&&d.setAttribute("class","xfaLayer xfaFont");const h=[];if(n.children.length===0){if(n.value){const f=document.createTextNode(n.value);o.append(f),l&&$o.shouldBuildText(n.name)&&h.push(f)}return{textDivs:h}}const u=[[n,-1,o]];for(;u.length>0;){const[f,g,b]=u.at(-1);if(g+1===f.children.length){u.pop();continue}const A=f.children[++u.at(-1)[1]];if(A===null)continue;const{name:N}=A;if(N==="#text"){const E=document.createTextNode(A.value);h.push(E),b.append(E);continue}const j=(p=A==null?void 0:A.attributes)!=null&&p.xmlns?document.createElementNS(A.attributes.xmlns,N):document.createElement(N);if(b.append(j),A.attributes&&this.setAttributes({html:j,element:A,storage:t,intent:a,linkService:s}),((m=A.children)==null?void 0:m.length)>0)u.push([A,-1,j]);else if(A.value){const E=document.createTextNode(A.value);l&&$o.shouldBuildText(N)&&h.push(E),j.append(E)}}for(const f of d.querySelectorAll(".xfaNonInteractive input, .xfaNonInteractive textarea"))f.setAttribute("readOnly",!0);return{textDivs:h}}static update(e){const t=`matrix(${e.viewport.transform.join(",")})`;e.div.style.transform=t,e.div.hidden=!1}}const mc=1e3,U0=9,$a=new WeakSet;function Nn(c){return{width:c[2]-c[0],height:c[3]-c[1]}}class G0{static create(e){switch(e.data.annotationType){case Ge.LINK:return new Um(e);case Ge.TEXT:return new V0(e);case Ge.WIDGET:switch(e.data.fieldType){case"Tx":return new W0(e);case"Btn":return e.data.radioButton?new Wm(e):e.data.checkBox?new X0(e):new Y0(e);case"Ch":return new K0(e);case"Sig":return new q0(e)}return new Ba(e);case Ge.POPUP:return new Ih(e);case Ge.FREETEXT:return new Qm(e);case Ge.LINE:return new Z0(e);case Ge.SQUARE:return new J0(e);case Ge.CIRCLE:return new eb(e);case Ge.POLYLINE:return new Zm(e);case Ge.CARET:return new sb(e);case Ge.INK:return new _u(e);case Ge.POLYGON:return new tb(e);case Ge.HIGHLIGHT:return new Jm(e);case Ge.UNDERLINE:return new ib(e);case Ge.SQUIGGLY:return new nb(e);case Ge.STRIKEOUT:return new ab(e);case Ge.STAMP:return new ef(e);case Ge.FILEATTACHMENT:return new rb(e);default:return new $e(e)}}}var ha,Rr,Pr,Tl,Mh;const Tu=class Tu{constructor(e,{isRenderable:t=!1,ignoreBorder:s=!1,createQuadrilaterals:n=!1}={}){v(this,Tl);v(this,ha,null);v(this,Rr,!1);v(this,Pr,null);this.isRenderable=t,this.data=e.data,this.layer=e.layer,this.linkService=e.linkService,this.downloadManager=e.downloadManager,this.imageResourcesPath=e.imageResourcesPath,this.renderForms=e.renderForms,this.svgFactory=e.svgFactory,this.annotationStorage=e.annotationStorage,this.enableScripting=e.enableScripting,this.hasJSActions=e.hasJSActions,this._fieldObjects=e.fieldObjects,this.parent=e.parent,t&&(this.container=this._createContainer(s)),n&&this._createQuadrilaterals()}static _hasPopupData({titleObj:e,contentsObj:t,richText:s}){return!!(e!=null&&e.str||t!=null&&t.str||s!=null&&s.str)}get _isEditable(){return this.data.isEditable}get hasPopupData(){return Tu._hasPopupData(this.data)}updateEdited(e){var s;if(!this.container)return;r(this,ha)||x(this,ha,{rect:this.data.rect.slice(0)});const{rect:t}=e;t&&w(this,Tl,Mh).call(this,t),(s=r(this,Pr))==null||s.popup.updateEdited(e)}resetEdited(){var e;r(this,ha)&&(w(this,Tl,Mh).call(this,r(this,ha).rect),(e=r(this,Pr))==null||e.popup.resetEdited(),x(this,ha,null))}_createContainer(e){const{data:t,parent:{page:s,viewport:n}}=this,a=document.createElement("section");a.setAttribute("data-annotation-id",t.id),this instanceof Ba||(a.tabIndex=mc);const{style:o}=a;if(o.zIndex=this.parent.zIndex++,t.alternativeText&&(a.title=t.alternativeText),t.noRotate&&a.classList.add("norotate"),!t.rect||this instanceof Ih){const{rotation:b}=t;return!t.hasOwnCanvas&&b!==0&&this.setRotation(b,a),a}const{width:l,height:d}=Nn(t.rect);if(!e&&t.borderStyle.width>0){o.borderWidth=`${t.borderStyle.width}px`;const b=t.borderStyle.horizontalCornerRadius,A=t.borderStyle.verticalCornerRadius;if(b>0||A>0){const j=`calc(${b}px * var(--scale-factor)) / calc(${A}px * var(--scale-factor))`;o.borderRadius=j}else if(this instanceof Wm){const j=`calc(${l}px * var(--scale-factor)) / calc(${d}px * var(--scale-factor))`;o.borderRadius=j}switch(t.borderStyle.style){case ho.SOLID:o.borderStyle="solid";break;case ho.DASHED:o.borderStyle="dashed";break;case ho.BEVELED:re("Unimplemented border style: beveled");break;case ho.INSET:re("Unimplemented border style: inset");break;case ho.UNDERLINE:o.borderBottomStyle="solid";break}const N=t.borderColor||null;N?(x(this,Rr,!0),o.borderColor=X.makeHexColor(N[0]|0,N[1]|0,N[2]|0)):o.borderWidth=0}const h=X.normalizeRect([t.rect[0],s.view[3]-t.rect[1]+s.view[1],t.rect[2],s.view[3]-t.rect[3]+s.view[1]]),{pageWidth:u,pageHeight:p,pageX:m,pageY:f}=n.rawDims;o.left=`${100*(h[0]-m)/u}%`,o.top=`${100*(h[1]-f)/p}%`;const{rotation:g}=t;return t.hasOwnCanvas||g===0?(o.width=`${100*l/u}%`,o.height=`${100*d/p}%`):this.setRotation(g,a),a}setRotation(e,t=this.container){if(!this.data.rect)return;const{pageWidth:s,pageHeight:n}=this.parent.viewport.rawDims,{width:a,height:o}=Nn(this.data.rect);let l,d;e%180===0?(l=100*a/s,d=100*o/n):(l=100*o/s,d=100*a/n),t.style.width=`${l}%`,t.style.height=`${d}%`,t.setAttribute("data-main-rotation",(360-e)%360)}get _commonActions(){const e=(t,s,n)=>{const a=n.detail[t],o=a[0],l=a.slice(1);n.target.style[s]=up[`${o}_HTML`](l),this.annotationStorage.setValue(this.data.id,{[s]:up[`${o}_rgb`](l)})};return de(this,"_commonActions",{display:t=>{const{display:s}=t.detail,n=s%2===1;this.container.style.visibility=n?"hidden":"visible",this.annotationStorage.setValue(this.data.id,{noView:n,noPrint:s===1||s===2})},print:t=>{this.annotationStorage.setValue(this.data.id,{noPrint:!t.detail.print})},hidden:t=>{const{hidden:s}=t.detail;this.container.style.visibility=s?"hidden":"visible",this.annotationStorage.setValue(this.data.id,{noPrint:s,noView:s})},focus:t=>{setTimeout(()=>t.target.focus({preventScroll:!1}),0)},userName:t=>{t.target.title=t.detail.userName},readonly:t=>{t.target.disabled=t.detail.readonly},required:t=>{this._setRequired(t.target,t.detail.required)},bgColor:t=>{e("bgColor","backgroundColor",t)},fillColor:t=>{e("fillColor","backgroundColor",t)},fgColor:t=>{e("fgColor","color",t)},textColor:t=>{e("textColor","color",t)},borderColor:t=>{e("borderColor","borderColor",t)},strokeColor:t=>{e("strokeColor","borderColor",t)},rotation:t=>{const s=t.detail.rotation;this.setRotation(s),this.annotationStorage.setValue(this.data.id,{rotation:s})}})}_dispatchEventFromSandbox(e,t){const s=this._commonActions;for(const n of Object.keys(t.detail)){const a=e[n]||s[n];a==null||a(t)}}_setDefaultPropertiesFromJS(e){if(!this.enableScripting)return;const t=this.annotationStorage.getRawValue(this.data.id);if(!t)return;const s=this._commonActions;for(const[n,a]of Object.entries(t)){const o=s[n];if(o){const l={detail:{[n]:a},target:e};o(l),delete t[n]}}}_createQuadrilaterals(){if(!this.container)return;const{quadPoints:e}=this.data;if(!e)return;const[t,s,n,a]=this.data.rect.map(b=>Math.fround(b));if(e.length===8){const[b,A,N,j]=e.subarray(2,6);if(n===b&&a===A&&t===N&&s===j)return}const{style:o}=this.container;let l;if(r(this,Rr)){const{borderColor:b,borderWidth:A}=o;o.borderWidth=0,l=["url('data:image/svg+xml;utf8,",'<svg xmlns="http://www.w3.org/2000/svg"',' preserveAspectRatio="none" viewBox="0 0 1 1">',`<g fill="transparent" stroke="${b}" stroke-width="${A}">`],this.container.classList.add("hasBorder")}const d=n-t,h=a-s,{svgFactory:u}=this,p=u.createElement("svg");p.classList.add("quadrilateralsContainer"),p.setAttribute("width",0),p.setAttribute("height",0);const m=u.createElement("defs");p.append(m);const f=u.createElement("clipPath"),g=`clippath_${this.data.id}`;f.setAttribute("id",g),f.setAttribute("clipPathUnits","objectBoundingBox"),m.append(f);for(let b=2,A=e.length;b<A;b+=8){const N=e[b],j=e[b+1],E=e[b+2],_=e[b+3],y=u.createElement("rect"),C=(E-t)/d,R=(a-j)/h,S=(N-E)/d,k=(j-_)/h;y.setAttribute("x",C),y.setAttribute("y",R),y.setAttribute("width",S),y.setAttribute("height",k),f.append(y),l==null||l.push(`<rect vector-effect="non-scaling-stroke" x="${C}" y="${R}" width="${S}" height="${k}"/>`)}r(this,Rr)&&(l.push("</g></svg>')"),o.backgroundImage=l.join("")),this.container.append(p),this.container.style.clipPath=`url(#${g})`}_createPopup(){const{data:e}=this,t=x(this,Pr,new Ih({data:{color:e.color,titleObj:e.titleObj,modificationDate:e.modificationDate,contentsObj:e.contentsObj,richText:e.richText,parentRect:e.rect,borderStyle:0,id:`popup_${e.id}`,rotation:e.rotation},parent:this.parent,elements:[this]}));this.parent.div.append(t.render())}render(){Ae("Abstract method `AnnotationElement.render` called")}_getElementsByName(e,t=null){const s=[];if(this._fieldObjects){const n=this._fieldObjects[e];if(n)for(const{page:a,id:o,exportValues:l}of n){if(a===-1||o===t)continue;const d=typeof l=="string"?l:null,h=document.querySelector(`[data-element-id="${o}"]`);if(h&&!$a.has(h)){re(`_getElementsByName - element not allowed: ${o}`);continue}s.push({id:o,exportValue:d,domElement:h})}return s}for(const n of document.getElementsByName(e)){const{exportValue:a}=n,o=n.getAttribute("data-element-id");o!==t&&$a.has(n)&&s.push({id:o,exportValue:a,domElement:n})}return s}show(){var e;this.container&&(this.container.hidden=!1),(e=this.popup)==null||e.maybeShow()}hide(){var e;this.container&&(this.container.hidden=!0),(e=this.popup)==null||e.forceHide()}getElementsToTriggerPopup(){return this.container}addHighlightArea(){const e=this.getElementsToTriggerPopup();if(Array.isArray(e))for(const t of e)t.classList.add("highlightArea");else e.classList.add("highlightArea")}_editOnDoubleClick(){if(!this._isEditable)return;const{annotationEditorType:e,data:{id:t}}=this;this.container.addEventListener("dblclick",()=>{var s;(s=this.linkService.eventBus)==null||s.dispatch("switchannotationeditormode",{source:this,mode:e,editId:t})})}};ha=new WeakMap,Rr=new WeakMap,Pr=new WeakMap,Tl=new WeakSet,Mh=function(e){const{container:{style:t},data:{rect:s,rotation:n},parent:{viewport:{rawDims:{pageWidth:a,pageHeight:o,pageX:l,pageY:d}}}}=this;s==null||s.splice(0,4,...e);const{width:h,height:u}=Nn(e);t.left=`${100*(e[0]-l)/a}%`,t.top=`${100*(o-e[3]+d)/o}%`,n===0?(t.width=`${100*h/a}%`,t.height=`${100*u/o}%`):this.setRotation(n)};let $e=Tu;var Kt,Cn,Gm,Vm;class Um extends $e{constructor(t,s=null){super(t,{isRenderable:!0,ignoreBorder:!!(s!=null&&s.ignoreBorder),createQuadrilaterals:!0});v(this,Kt);this.isTooltipOnly=t.data.isTooltipOnly}render(){const{data:t,linkService:s}=this,n=document.createElement("a");n.setAttribute("data-element-id",t.id);let a=!1;return t.url?(s.addLinkAttributes(n,t.url,t.newWindow),a=!0):t.action?(this._bindNamedAction(n,t.action),a=!0):t.attachment?(w(this,Kt,Gm).call(this,n,t.attachment,t.attachmentDest),a=!0):t.setOCGState?(w(this,Kt,Vm).call(this,n,t.setOCGState),a=!0):t.dest?(this._bindLink(n,t.dest),a=!0):(t.actions&&(t.actions.Action||t.actions["Mouse Up"]||t.actions["Mouse Down"])&&this.enableScripting&&this.hasJSActions&&(this._bindJSAction(n,t),a=!0),t.resetForm?(this._bindResetFormAction(n,t.resetForm),a=!0):this.isTooltipOnly&&!a&&(this._bindLink(n,""),a=!0)),this.container.classList.add("linkAnnotation"),a&&this.container.append(n),this.container}_bindLink(t,s){t.href=this.linkService.getDestinationHash(s),t.onclick=()=>(s&&this.linkService.goToDestination(s),!1),(s||s==="")&&w(this,Kt,Cn).call(this)}_bindNamedAction(t,s){t.href=this.linkService.getAnchorUrl(""),t.onclick=()=>(this.linkService.executeNamedAction(s),!1),w(this,Kt,Cn).call(this)}_bindJSAction(t,s){t.href=this.linkService.getAnchorUrl("");const n=new Map([["Action","onclick"],["Mouse Up","onmouseup"],["Mouse Down","onmousedown"]]);for(const a of Object.keys(s.actions)){const o=n.get(a);o&&(t[o]=()=>{var l;return(l=this.linkService.eventBus)==null||l.dispatch("dispatcheventinsandbox",{source:this,detail:{id:s.id,name:a}}),!1})}t.onclick||(t.onclick=()=>!1),w(this,Kt,Cn).call(this)}_bindResetFormAction(t,s){const n=t.onclick;if(n||(t.href=this.linkService.getAnchorUrl("")),w(this,Kt,Cn).call(this),!this._fieldObjects){re('_bindResetFormAction - "resetForm" action not supported, ensure that the `fieldObjects` parameter is provided.'),n||(t.onclick=()=>!1);return}t.onclick=()=>{var p;n==null||n();const{fields:a,refs:o,include:l}=s,d=[];if(a.length!==0||o.length!==0){const m=new Set(o);for(const f of a){const g=this._fieldObjects[f]||[];for(const{id:b}of g)m.add(b)}for(const f of Object.values(this._fieldObjects))for(const g of f)m.has(g.id)===l&&d.push(g)}else for(const m of Object.values(this._fieldObjects))d.push(...m);const h=this.annotationStorage,u=[];for(const m of d){const{id:f}=m;switch(u.push(f),m.type){case"text":{const b=m.defaultValue||"";h.setValue(f,{value:b});break}case"checkbox":case"radiobutton":{const b=m.defaultValue===m.exportValues;h.setValue(f,{value:b});break}case"combobox":case"listbox":{const b=m.defaultValue||"";h.setValue(f,{value:b});break}default:continue}const g=document.querySelector(`[data-element-id="${f}"]`);if(g){if(!$a.has(g)){re(`_bindResetFormAction - element not allowed: ${f}`);continue}}else continue;g.dispatchEvent(new Event("resetform"))}return this.enableScripting&&((p=this.linkService.eventBus)==null||p.dispatch("dispatcheventinsandbox",{source:this,detail:{id:"app",ids:u,name:"ResetForm"}})),!1}}}Kt=new WeakSet,Cn=function(){this.container.setAttribute("data-internal-link","")},Gm=function(t,s,n=null){t.href=this.linkService.getAnchorUrl(""),s.description&&(t.title=s.description),t.onclick=()=>{var a;return(a=this.downloadManager)==null||a.openOrDownloadData(s.content,s.filename,n),!1},w(this,Kt,Cn).call(this)},Vm=function(t,s){t.href=this.linkService.getAnchorUrl(""),t.onclick=()=>(this.linkService.executeSetOCGState(s),!1),w(this,Kt,Cn).call(this)};class V0 extends $e{constructor(e){super(e,{isRenderable:!0})}render(){this.container.classList.add("textAnnotation");const e=document.createElement("img");return e.src=this.imageResourcesPath+"annotation-"+this.data.name.toLowerCase()+".svg",e.setAttribute("data-l10n-id","pdfjs-text-annotation-type"),e.setAttribute("data-l10n-args",JSON.stringify({type:this.data.name})),!this.data.popupRef&&this.hasPopupData&&this._createPopup(),this.container.append(e),this.container}}class Ba extends $e{render(){return this.container}showElementAndHideCanvas(e){var t;this.data.hasOwnCanvas&&(((t=e.previousSibling)==null?void 0:t.nodeName)==="CANVAS"&&(e.previousSibling.hidden=!0),e.hidden=!1)}_getKeyModifier(e){return At.platform.isMac?e.metaKey:e.ctrlKey}_setEventListener(e,t,s,n,a){s.includes("mouse")?e.addEventListener(s,o=>{var l;(l=this.linkService.eventBus)==null||l.dispatch("dispatcheventinsandbox",{source:this,detail:{id:this.data.id,name:n,value:a(o),shift:o.shiftKey,modifier:this._getKeyModifier(o)}})}):e.addEventListener(s,o=>{var l;if(s==="blur"){if(!t.focused||!o.relatedTarget)return;t.focused=!1}else if(s==="focus"){if(t.focused)return;t.focused=!0}a&&((l=this.linkService.eventBus)==null||l.dispatch("dispatcheventinsandbox",{source:this,detail:{id:this.data.id,name:n,value:a(o)}}))})}_setEventListeners(e,t,s,n){var a,o,l;for(const[d,h]of s)(h==="Action"||(a=this.data.actions)!=null&&a[h])&&((h==="Focus"||h==="Blur")&&(t||(t={focused:!1})),this._setEventListener(e,t,d,h,n),h==="Focus"&&!((o=this.data.actions)!=null&&o.Blur)?this._setEventListener(e,t,"blur","Blur",null):h==="Blur"&&!((l=this.data.actions)!=null&&l.Focus)&&this._setEventListener(e,t,"focus","Focus",null))}_setBackgroundColor(e){const t=this.data.backgroundColor||null;e.style.backgroundColor=t===null?"transparent":X.makeHexColor(t[0],t[1],t[2])}_setTextStyle(e){const t=["left","center","right"],{fontColor:s}=this.data.defaultAppearanceData,n=this.data.defaultAppearanceData.fontSize||U0,a=e.style;let o;const l=2,d=h=>Math.round(10*h)/10;if(this.data.multiLine){const h=Math.abs(this.data.rect[3]-this.data.rect[1]-l),u=Math.round(h/(Bd*n))||1,p=h/u;o=Math.min(n,d(p/Bd))}else{const h=Math.abs(this.data.rect[3]-this.data.rect[1]-l);o=Math.min(n,d(h/Bd))}a.fontSize=`calc(${o}px * var(--scale-factor))`,a.color=X.makeHexColor(s[0],s[1],s[2]),this.data.textAlignment!==null&&(a.textAlign=t[this.data.textAlignment])}_setRequired(e,t){t?e.setAttribute("required",!0):e.removeAttribute("required"),e.setAttribute("aria-required",t)}}class W0 extends Ba{constructor(e){const t=e.renderForms||e.data.hasOwnCanvas||!e.data.hasAppearance&&!!e.data.fieldValue;super(e,{isRenderable:t})}setPropertyOnSiblings(e,t,s,n){const a=this.annotationStorage;for(const o of this._getElementsByName(e.name,e.id))o.domElement&&(o.domElement[t]=s),a.setValue(o.id,{[n]:s})}render(){var n,a;const e=this.annotationStorage,t=this.data.id;this.container.classList.add("textWidgetAnnotation");let s=null;if(this.renderForms){const o=e.getValue(t,{value:this.data.fieldValue});let l=o.value||"";const d=e.getValue(t,{charLimit:this.data.maxLen}).charLimit;d&&l.length>d&&(l=l.slice(0,d));let h=o.formattedValue||((n=this.data.textContent)==null?void 0:n.join(`
`))||null;h&&this.data.comb&&(h=h.replaceAll(/\s+/g,""));const u={userValue:l,formattedValue:h,lastCommittedValue:null,commitKey:1,focused:!1};this.data.multiLine?(s=document.createElement("textarea"),s.textContent=h!=null?h:l,this.data.doNotScroll&&(s.style.overflowY="hidden")):(s=document.createElement("input"),s.type="text",s.setAttribute("value",h!=null?h:l),this.data.doNotScroll&&(s.style.overflowX="hidden")),this.data.hasOwnCanvas&&(s.hidden=!0),$a.add(s),s.setAttribute("data-element-id",t),s.disabled=this.data.readOnly,s.name=this.data.fieldName,s.tabIndex=mc,this._setRequired(s,this.data.required),d&&(s.maxLength=d),s.addEventListener("input",m=>{e.setValue(t,{value:m.target.value}),this.setPropertyOnSiblings(s,"value",m.target.value,"value"),u.formattedValue=null}),s.addEventListener("resetform",m=>{var g;const f=(g=this.data.defaultFieldValue)!=null?g:"";s.value=u.userValue=f,u.formattedValue=null});let p=m=>{const{formattedValue:f}=u;f!=null&&(m.target.value=f),m.target.scrollLeft=0};if(this.enableScripting&&this.hasJSActions){s.addEventListener("focus",f=>{var b;if(u.focused)return;const{target:g}=f;u.userValue&&(g.value=u.userValue),u.lastCommittedValue=g.value,u.commitKey=1,(b=this.data.actions)!=null&&b.Focus||(u.focused=!0)}),s.addEventListener("updatefromsandbox",f=>{this.showElementAndHideCanvas(f.target);const g={value(b){var A;u.userValue=(A=b.detail.value)!=null?A:"",e.setValue(t,{value:u.userValue.toString()}),b.target.value=u.userValue},formattedValue(b){const{formattedValue:A}=b.detail;u.formattedValue=A,A!=null&&b.target!==document.activeElement&&(b.target.value=A),e.setValue(t,{formattedValue:A})},selRange(b){b.target.setSelectionRange(...b.detail.selRange)},charLimit:b=>{var E;const{charLimit:A}=b.detail,{target:N}=b;if(A===0){N.removeAttribute("maxLength");return}N.setAttribute("maxLength",A);let j=u.userValue;!j||j.length<=A||(j=j.slice(0,A),N.value=u.userValue=j,e.setValue(t,{value:j}),(E=this.linkService.eventBus)==null||E.dispatch("dispatcheventinsandbox",{source:this,detail:{id:t,name:"Keystroke",value:j,willCommit:!0,commitKey:1,selStart:N.selectionStart,selEnd:N.selectionEnd}}))}};this._dispatchEventFromSandbox(g,f)}),s.addEventListener("keydown",f=>{var A;u.commitKey=1;let g=-1;if(f.key==="Escape"?g=0:f.key==="Enter"&&!this.data.multiLine?g=2:f.key==="Tab"&&(u.commitKey=3),g===-1)return;const{value:b}=f.target;u.lastCommittedValue!==b&&(u.lastCommittedValue=b,u.userValue=b,(A=this.linkService.eventBus)==null||A.dispatch("dispatcheventinsandbox",{source:this,detail:{id:t,name:"Keystroke",value:b,willCommit:!0,commitKey:g,selStart:f.target.selectionStart,selEnd:f.target.selectionEnd}}))});const m=p;p=null,s.addEventListener("blur",f=>{var b,A;if(!u.focused||!f.relatedTarget)return;(b=this.data.actions)!=null&&b.Blur||(u.focused=!1);const{value:g}=f.target;u.userValue=g,u.lastCommittedValue!==g&&((A=this.linkService.eventBus)==null||A.dispatch("dispatcheventinsandbox",{source:this,detail:{id:t,name:"Keystroke",value:g,willCommit:!0,commitKey:u.commitKey,selStart:f.target.selectionStart,selEnd:f.target.selectionEnd}})),m(f)}),(a=this.data.actions)!=null&&a.Keystroke&&s.addEventListener("beforeinput",f=>{var y;u.lastCommittedValue=null;const{data:g,target:b}=f,{value:A,selectionStart:N,selectionEnd:j}=b;let E=N,_=j;switch(f.inputType){case"deleteWordBackward":{const C=A.substring(0,N).match(/\w*[^\w]*$/);C&&(E-=C[0].length);break}case"deleteWordForward":{const C=A.substring(N).match(/^[^\w]*\w*/);C&&(_+=C[0].length);break}case"deleteContentBackward":N===j&&(E-=1);break;case"deleteContentForward":N===j&&(_+=1);break}f.preventDefault(),(y=this.linkService.eventBus)==null||y.dispatch("dispatcheventinsandbox",{source:this,detail:{id:t,name:"Keystroke",value:A,change:g||"",willCommit:!1,selStart:E,selEnd:_}})}),this._setEventListeners(s,u,[["focus","Focus"],["blur","Blur"],["mousedown","Mouse Down"],["mouseenter","Mouse Enter"],["mouseleave","Mouse Exit"],["mouseup","Mouse Up"]],f=>f.target.value)}if(p&&s.addEventListener("blur",p),this.data.comb){const f=(this.data.rect[2]-this.data.rect[0])/d;s.classList.add("comb"),s.style.letterSpacing=`calc(${f}px * var(--scale-factor) - 1ch)`}}else s=document.createElement("div"),s.textContent=this.data.fieldValue,s.style.verticalAlign="middle",s.style.display="table-cell",this.data.hasOwnCanvas&&(s.hidden=!0);return this._setTextStyle(s),this._setBackgroundColor(s),this._setDefaultPropertiesFromJS(s),this.container.append(s),this.container}}class q0 extends Ba{constructor(e){super(e,{isRenderable:!!e.data.hasOwnCanvas})}}class X0 extends Ba{constructor(e){super(e,{isRenderable:e.renderForms})}render(){const e=this.annotationStorage,t=this.data,s=t.id;let n=e.getValue(s,{value:t.exportValue===t.fieldValue}).value;typeof n=="string"&&(n=n!=="Off",e.setValue(s,{value:n})),this.container.classList.add("buttonWidgetAnnotation","checkBox");const a=document.createElement("input");return $a.add(a),a.setAttribute("data-element-id",s),a.disabled=t.readOnly,this._setRequired(a,this.data.required),a.type="checkbox",a.name=t.fieldName,n&&a.setAttribute("checked",!0),a.setAttribute("exportValue",t.exportValue),a.tabIndex=mc,a.addEventListener("change",o=>{const{name:l,checked:d}=o.target;for(const h of this._getElementsByName(l,s)){const u=d&&h.exportValue===t.exportValue;h.domElement&&(h.domElement.checked=u),e.setValue(h.id,{value:u})}e.setValue(s,{value:d})}),a.addEventListener("resetform",o=>{const l=t.defaultFieldValue||"Off";o.target.checked=l===t.exportValue}),this.enableScripting&&this.hasJSActions&&(a.addEventListener("updatefromsandbox",o=>{const l={value(d){d.target.checked=d.detail.value!=="Off",e.setValue(s,{value:d.target.checked})}};this._dispatchEventFromSandbox(l,o)}),this._setEventListeners(a,null,[["change","Validate"],["change","Action"],["focus","Focus"],["blur","Blur"],["mousedown","Mouse Down"],["mouseenter","Mouse Enter"],["mouseleave","Mouse Exit"],["mouseup","Mouse Up"]],o=>o.target.checked)),this._setBackgroundColor(a),this._setDefaultPropertiesFromJS(a),this.container.append(a),this.container}}class Wm extends Ba{constructor(e){super(e,{isRenderable:e.renderForms})}render(){this.container.classList.add("buttonWidgetAnnotation","radioButton");const e=this.annotationStorage,t=this.data,s=t.id;let n=e.getValue(s,{value:t.fieldValue===t.buttonValue}).value;if(typeof n=="string"&&(n=n!==t.buttonValue,e.setValue(s,{value:n})),n)for(const o of this._getElementsByName(t.fieldName,s))e.setValue(o.id,{value:!1});const a=document.createElement("input");if($a.add(a),a.setAttribute("data-element-id",s),a.disabled=t.readOnly,this._setRequired(a,this.data.required),a.type="radio",a.name=t.fieldName,n&&a.setAttribute("checked",!0),a.tabIndex=mc,a.addEventListener("change",o=>{const{name:l,checked:d}=o.target;for(const h of this._getElementsByName(l,s))e.setValue(h.id,{value:!1});e.setValue(s,{value:d})}),a.addEventListener("resetform",o=>{const l=t.defaultFieldValue;o.target.checked=l!=null&&l===t.buttonValue}),this.enableScripting&&this.hasJSActions){const o=t.buttonValue;a.addEventListener("updatefromsandbox",l=>{const d={value:h=>{const u=o===h.detail.value;for(const p of this._getElementsByName(h.target.name)){const m=u&&p.id===s;p.domElement&&(p.domElement.checked=m),e.setValue(p.id,{value:m})}}};this._dispatchEventFromSandbox(d,l)}),this._setEventListeners(a,null,[["change","Validate"],["change","Action"],["focus","Focus"],["blur","Blur"],["mousedown","Mouse Down"],["mouseenter","Mouse Enter"],["mouseleave","Mouse Exit"],["mouseup","Mouse Up"]],l=>l.target.checked)}return this._setBackgroundColor(a),this._setDefaultPropertiesFromJS(a),this.container.append(a),this.container}}class Y0 extends Um{constructor(e){super(e,{ignoreBorder:e.data.hasAppearance})}render(){const e=super.render();e.classList.add("buttonWidgetAnnotation","pushButton");const t=e.lastChild;return this.enableScripting&&this.hasJSActions&&t&&(this._setDefaultPropertiesFromJS(t),t.addEventListener("updatefromsandbox",s=>{this._dispatchEventFromSandbox({},s)})),e}}class K0 extends Ba{constructor(e){super(e,{isRenderable:e.renderForms})}render(){this.container.classList.add("choiceWidgetAnnotation");const e=this.annotationStorage,t=this.data.id,s=e.getValue(t,{value:this.data.fieldValue}),n=document.createElement("select");$a.add(n),n.setAttribute("data-element-id",t),n.disabled=this.data.readOnly,this._setRequired(n,this.data.required),n.name=this.data.fieldName,n.tabIndex=mc;let a=this.data.combo&&this.data.options.length>0;this.data.combo||(n.size=this.data.options.length,this.data.multiSelect&&(n.multiple=!0)),n.addEventListener("resetform",u=>{const p=this.data.defaultFieldValue;for(const m of n.options)m.selected=m.value===p});for(const u of this.data.options){const p=document.createElement("option");p.textContent=u.displayValue,p.value=u.exportValue,s.value.includes(u.exportValue)&&(p.setAttribute("selected",!0),a=!1),n.append(p)}let o=null;if(a){const u=document.createElement("option");u.value=" ",u.setAttribute("hidden",!0),u.setAttribute("selected",!0),n.prepend(u),o=()=>{u.remove(),n.removeEventListener("input",o),o=null},n.addEventListener("input",o)}const l=u=>{const p=u?"value":"textContent",{options:m,multiple:f}=n;return f?Array.prototype.filter.call(m,g=>g.selected).map(g=>g[p]):m.selectedIndex===-1?null:m[m.selectedIndex][p]};let d=l(!1);const h=u=>{const p=u.target.options;return Array.prototype.map.call(p,m=>({displayValue:m.textContent,exportValue:m.value}))};return this.enableScripting&&this.hasJSActions?(n.addEventListener("updatefromsandbox",u=>{const p={value(m){o==null||o();const f=m.detail.value,g=new Set(Array.isArray(f)?f:[f]);for(const b of n.options)b.selected=g.has(b.value);e.setValue(t,{value:l(!0)}),d=l(!1)},multipleSelection(m){n.multiple=!0},remove(m){const f=n.options,g=m.detail.remove;f[g].selected=!1,n.remove(g),f.length>0&&Array.prototype.findIndex.call(f,A=>A.selected)===-1&&(f[0].selected=!0),e.setValue(t,{value:l(!0),items:h(m)}),d=l(!1)},clear(m){for(;n.length!==0;)n.remove(0);e.setValue(t,{value:null,items:[]}),d=l(!1)},insert(m){const{index:f,displayValue:g,exportValue:b}=m.detail.insert,A=n.children[f],N=document.createElement("option");N.textContent=g,N.value=b,A?A.before(N):n.append(N),e.setValue(t,{value:l(!0),items:h(m)}),d=l(!1)},items(m){const{items:f}=m.detail;for(;n.length!==0;)n.remove(0);for(const g of f){const{displayValue:b,exportValue:A}=g,N=document.createElement("option");N.textContent=b,N.value=A,n.append(N)}n.options.length>0&&(n.options[0].selected=!0),e.setValue(t,{value:l(!0),items:h(m)}),d=l(!1)},indices(m){const f=new Set(m.detail.indices);for(const g of m.target.options)g.selected=f.has(g.index);e.setValue(t,{value:l(!0)}),d=l(!1)},editable(m){m.target.disabled=!m.detail.editable}};this._dispatchEventFromSandbox(p,u)}),n.addEventListener("input",u=>{var f;const p=l(!0),m=l(!1);e.setValue(t,{value:p}),u.preventDefault(),(f=this.linkService.eventBus)==null||f.dispatch("dispatcheventinsandbox",{source:this,detail:{id:t,name:"Keystroke",value:d,change:m,changeEx:p,willCommit:!1,commitKey:1,keyDown:!1}})}),this._setEventListeners(n,null,[["focus","Focus"],["blur","Blur"],["mousedown","Mouse Down"],["mouseenter","Mouse Enter"],["mouseleave","Mouse Exit"],["mouseup","Mouse Up"],["input","Action"],["input","Validate"]],u=>u.target.value)):n.addEventListener("input",function(u){e.setValue(t,{value:l(!0)})}),this.data.combo&&this._setTextStyle(n),this._setBackgroundColor(n),this._setDefaultPropertiesFromJS(n),this.container.append(n),this.container}}class Ih extends $e{constructor(e){const{data:t,elements:s}=e;super(e,{isRenderable:$e._hasPopupData(t)}),this.elements=s,this.popup=null}render(){this.container.classList.add("popupAnnotation");const e=this.popup=new Q0({container:this.container,color:this.data.color,titleObj:this.data.titleObj,modificationDate:this.data.modificationDate,contentsObj:this.data.contentsObj,richText:this.data.richText,rect:this.data.rect,parentRect:this.data.parentRect||null,parent:this.parent,elements:this.elements,open:this.data.open}),t=[];for(const s of this.elements)s.popup=e,s.container.ariaHasPopup="dialog",t.push(s.data.id),s.addHighlightArea();return this.container.setAttribute("aria-controls",t.map(s=>`${xu}${s}`).join(",")),this.container}}var Mr,Ad,_d,Ir,ua,De,ji,Lr,Rl,Pl,Dr,Ai,ys,_i,Ml,Si,Il,pa,ma,je,Bc,Lh,qm,Xm,Ym,Km,zc,Uc,Dh;class Q0{constructor({container:e,color:t,elements:s,titleObj:n,modificationDate:a,contentsObj:o,richText:l,parent:d,rect:h,parentRect:u,open:p}){v(this,je);v(this,Mr,w(this,je,Ym).bind(this));v(this,Ad,w(this,je,Dh).bind(this));v(this,_d,w(this,je,Uc).bind(this));v(this,Ir,w(this,je,zc).bind(this));v(this,ua,null);v(this,De,null);v(this,ji,null);v(this,Lr,null);v(this,Rl,null);v(this,Pl,null);v(this,Dr,null);v(this,Ai,!1);v(this,ys,null);v(this,_i,null);v(this,Ml,null);v(this,Si,null);v(this,Il,null);v(this,pa,null);v(this,ma,!1);var m;x(this,De,e),x(this,Il,n),x(this,ji,o),x(this,Si,l),x(this,Pl,d),x(this,ua,t),x(this,Ml,h),x(this,Dr,u),x(this,Rl,s),x(this,Lr,yu.toDateObject(a)),this.trigger=s.flatMap(f=>f.getElementsToTriggerPopup());for(const f of this.trigger)f.addEventListener("click",r(this,Ir)),f.addEventListener("mouseenter",r(this,_d)),f.addEventListener("mouseleave",r(this,Ad)),f.classList.add("popupTriggerArea");for(const f of s)(m=f.container)==null||m.addEventListener("keydown",r(this,Mr));r(this,De).hidden=!0,p&&w(this,je,zc).call(this)}render(){if(r(this,ys))return;const e=x(this,ys,document.createElement("div"));if(e.className="popup",r(this,ua)){const a=e.style.outlineColor=X.makeHexColor(...r(this,ua));CSS.supports("background-color","color-mix(in srgb, red 30%, white)")?e.style.backgroundColor=`color-mix(in srgb, ${a} 30%, white)`:e.style.backgroundColor=X.makeHexColor(...r(this,ua).map(l=>Math.floor(.7*(255-l)+l)))}const t=document.createElement("span");t.className="header";const s=document.createElement("h1");if(t.append(s),{dir:s.dir,str:s.textContent}=r(this,Il),e.append(t),r(this,Lr)){const a=document.createElement("span");a.classList.add("popupDate"),a.setAttribute("data-l10n-id","pdfjs-annotation-date-time-string"),a.setAttribute("data-l10n-args",JSON.stringify({dateObj:r(this,Lr).valueOf()})),t.append(a)}const n=r(this,je,Bc);if(n)zm.render({xfaHtml:n,intent:"richText",div:e}),e.lastChild.classList.add("richText","popupContent");else{const a=this._formatContents(r(this,ji));e.append(a)}r(this,De).append(e)}_formatContents({str:e,dir:t}){const s=document.createElement("p");s.classList.add("popupContent"),s.dir=t;const n=e.split(/(?:\r\n?|\n)/);for(let a=0,o=n.length;a<o;++a){const l=n[a];s.append(document.createTextNode(l)),a<o-1&&s.append(document.createElement("br"))}return s}updateEdited({rect:e,popupContent:t}){var s;r(this,pa)||x(this,pa,{contentsObj:r(this,ji),richText:r(this,Si)}),e&&x(this,_i,null),t&&(x(this,Si,w(this,je,Xm).call(this,t)),x(this,ji,null)),(s=r(this,ys))==null||s.remove(),x(this,ys,null)}resetEdited(){var e;r(this,pa)&&({contentsObj:bt(this,ji)._,richText:bt(this,Si)._}=r(this,pa),x(this,pa,null),(e=r(this,ys))==null||e.remove(),x(this,ys,null),x(this,_i,null))}forceHide(){x(this,ma,this.isVisible),r(this,ma)&&(r(this,De).hidden=!0)}maybeShow(){r(this,ma)&&(r(this,ys)||w(this,je,Uc).call(this),x(this,ma,!1),r(this,De).hidden=!1)}get isVisible(){return r(this,De).hidden===!1}}Mr=new WeakMap,Ad=new WeakMap,_d=new WeakMap,Ir=new WeakMap,ua=new WeakMap,De=new WeakMap,ji=new WeakMap,Lr=new WeakMap,Rl=new WeakMap,Pl=new WeakMap,Dr=new WeakMap,Ai=new WeakMap,ys=new WeakMap,_i=new WeakMap,Ml=new WeakMap,Si=new WeakMap,Il=new WeakMap,pa=new WeakMap,ma=new WeakMap,je=new WeakSet,Bc=function(){const e=r(this,Si),t=r(this,ji);return e!=null&&e.str&&(!(t!=null&&t.str)||t.str===e.str)&&r(this,Si).html||null},Lh=function(){var e,t,s;return((s=(t=(e=r(this,je,Bc))==null?void 0:e.attributes)==null?void 0:t.style)==null?void 0:s.fontSize)||0},qm=function(){var e,t,s;return((s=(t=(e=r(this,je,Bc))==null?void 0:e.attributes)==null?void 0:t.style)==null?void 0:s.color)||null},Xm=function(e){const t=[],s={str:e,html:{name:"div",attributes:{dir:"auto"},children:[{name:"p",children:t}]}},n={style:{color:r(this,je,qm),fontSize:r(this,je,Lh)?`calc(${r(this,je,Lh)}px * var(--scale-factor))`:""}};for(const a of e.split(`
`))t.push({name:"span",value:a,attributes:n});return s},Ym=function(e){e.altKey||e.shiftKey||e.ctrlKey||e.metaKey||(e.key==="Enter"||e.key==="Escape"&&r(this,Ai))&&w(this,je,zc).call(this)},Km=function(){if(r(this,_i)!==null)return;const{page:{view:e},viewport:{rawDims:{pageWidth:t,pageHeight:s,pageX:n,pageY:a}}}=r(this,Pl);let o=!!r(this,Dr),l=o?r(this,Dr):r(this,Ml);for(const g of r(this,Rl))if(!l||X.intersect(g.data.rect,l)!==null){l=g.data.rect,o=!0;break}const d=X.normalizeRect([l[0],e[3]-l[1]+e[1],l[2],e[3]-l[3]+e[1]]),u=o?l[2]-l[0]+5:0,p=d[0]+u,m=d[1];x(this,_i,[100*(p-n)/t,100*(m-a)/s]);const{style:f}=r(this,De);f.left=`${r(this,_i)[0]}%`,f.top=`${r(this,_i)[1]}%`},zc=function(){x(this,Ai,!r(this,Ai)),r(this,Ai)?(w(this,je,Uc).call(this),r(this,De).addEventListener("click",r(this,Ir)),r(this,De).addEventListener("keydown",r(this,Mr))):(w(this,je,Dh).call(this),r(this,De).removeEventListener("click",r(this,Ir)),r(this,De).removeEventListener("keydown",r(this,Mr)))},Uc=function(){r(this,ys)||this.render(),this.isVisible?r(this,Ai)&&r(this,De).classList.add("focused"):(w(this,je,Km).call(this),r(this,De).hidden=!1,r(this,De).style.zIndex=parseInt(r(this,De).style.zIndex)+1e3)},Dh=function(){r(this,De).classList.remove("focused"),!(r(this,Ai)||!this.isVisible)&&(r(this,De).hidden=!0,r(this,De).style.zIndex=parseInt(r(this,De).style.zIndex)-1e3)};class Qm extends $e{constructor(e){super(e,{isRenderable:!0,ignoreBorder:!0}),this.textContent=e.data.textContent,this.textPosition=e.data.textPosition,this.annotationEditorType=ae.FREETEXT}render(){if(this.container.classList.add("freeTextAnnotation"),this.textContent){const e=document.createElement("div");e.classList.add("annotationTextContent"),e.setAttribute("role","comment");for(const t of this.textContent){const s=document.createElement("span");s.textContent=t,e.append(s)}this.container.append(e)}return!this.data.popupRef&&this.hasPopupData&&this._createPopup(),this._editOnDoubleClick(),this.container}}var Ll;class Z0 extends $e{constructor(t){super(t,{isRenderable:!0,ignoreBorder:!0});v(this,Ll,null)}render(){this.container.classList.add("lineAnnotation");const t=this.data,{width:s,height:n}=Nn(t.rect),a=this.svgFactory.create(s,n,!0),o=x(this,Ll,this.svgFactory.createElement("svg:line"));return o.setAttribute("x1",t.rect[2]-t.lineCoordinates[0]),o.setAttribute("y1",t.rect[3]-t.lineCoordinates[1]),o.setAttribute("x2",t.rect[2]-t.lineCoordinates[2]),o.setAttribute("y2",t.rect[3]-t.lineCoordinates[3]),o.setAttribute("stroke-width",t.borderStyle.width||1),o.setAttribute("stroke","transparent"),o.setAttribute("fill","transparent"),a.append(o),this.container.append(a),!t.popupRef&&this.hasPopupData&&this._createPopup(),this.container}getElementsToTriggerPopup(){return r(this,Ll)}addHighlightArea(){this.container.classList.add("highlightArea")}}Ll=new WeakMap;var Dl;class J0 extends $e{constructor(t){super(t,{isRenderable:!0,ignoreBorder:!0});v(this,Dl,null)}render(){this.container.classList.add("squareAnnotation");const t=this.data,{width:s,height:n}=Nn(t.rect),a=this.svgFactory.create(s,n,!0),o=t.borderStyle.width,l=x(this,Dl,this.svgFactory.createElement("svg:rect"));return l.setAttribute("x",o/2),l.setAttribute("y",o/2),l.setAttribute("width",s-o),l.setAttribute("height",n-o),l.setAttribute("stroke-width",o||1),l.setAttribute("stroke","transparent"),l.setAttribute("fill","transparent"),a.append(l),this.container.append(a),!t.popupRef&&this.hasPopupData&&this._createPopup(),this.container}getElementsToTriggerPopup(){return r(this,Dl)}addHighlightArea(){this.container.classList.add("highlightArea")}}Dl=new WeakMap;var Fl;class eb extends $e{constructor(t){super(t,{isRenderable:!0,ignoreBorder:!0});v(this,Fl,null)}render(){this.container.classList.add("circleAnnotation");const t=this.data,{width:s,height:n}=Nn(t.rect),a=this.svgFactory.create(s,n,!0),o=t.borderStyle.width,l=x(this,Fl,this.svgFactory.createElement("svg:ellipse"));return l.setAttribute("cx",s/2),l.setAttribute("cy",n/2),l.setAttribute("rx",s/2-o/2),l.setAttribute("ry",n/2-o/2),l.setAttribute("stroke-width",o||1),l.setAttribute("stroke","transparent"),l.setAttribute("fill","transparent"),a.append(l),this.container.append(a),!t.popupRef&&this.hasPopupData&&this._createPopup(),this.container}getElementsToTriggerPopup(){return r(this,Fl)}addHighlightArea(){this.container.classList.add("highlightArea")}}Fl=new WeakMap;var Ol;class Zm extends $e{constructor(t){super(t,{isRenderable:!0,ignoreBorder:!0});v(this,Ol,null);this.containerClassName="polylineAnnotation",this.svgElementName="svg:polyline"}render(){this.container.classList.add(this.containerClassName);const{data:{rect:t,vertices:s,borderStyle:n,popupRef:a}}=this;if(!s)return this.container;const{width:o,height:l}=Nn(t),d=this.svgFactory.create(o,l,!0);let h=[];for(let p=0,m=s.length;p<m;p+=2){const f=s[p]-t[0],g=t[3]-s[p+1];h.push(`${f},${g}`)}h=h.join(" ");const u=x(this,Ol,this.svgFactory.createElement(this.svgElementName));return u.setAttribute("points",h),u.setAttribute("stroke-width",n.width||1),u.setAttribute("stroke","transparent"),u.setAttribute("fill","transparent"),d.append(u),this.container.append(d),!a&&this.hasPopupData&&this._createPopup(),this.container}getElementsToTriggerPopup(){return r(this,Ol)}addHighlightArea(){this.container.classList.add("highlightArea")}}Ol=new WeakMap;class tb extends Zm{constructor(e){super(e),this.containerClassName="polygonAnnotation",this.svgElementName="svg:polygon"}}class sb extends $e{constructor(e){super(e,{isRenderable:!0,ignoreBorder:!0})}render(){return this.container.classList.add("caretAnnotation"),!this.data.popupRef&&this.hasPopupData&&this._createPopup(),this.container}}var $l,fa,Hl,Fh;class _u extends $e{constructor(t){super(t,{isRenderable:!0,ignoreBorder:!0});v(this,Hl);v(this,$l,null);v(this,fa,[]);this.containerClassName="inkAnnotation",this.svgElementName="svg:polyline",this.annotationEditorType=this.data.it==="InkHighlight"?ae.HIGHLIGHT:ae.INK}render(){this.container.classList.add(this.containerClassName);const{data:{rect:t,rotation:s,inkLists:n,borderStyle:a,popupRef:o}}=this,{transform:l,width:d,height:h}=w(this,Hl,Fh).call(this,s,t),u=this.svgFactory.create(d,h,!0),p=x(this,$l,this.svgFactory.createElement("svg:g"));u.append(p),p.setAttribute("stroke-width",a.width||1),p.setAttribute("stroke-linecap","round"),p.setAttribute("stroke-linejoin","round"),p.setAttribute("stroke-miterlimit",10),p.setAttribute("stroke","transparent"),p.setAttribute("fill","transparent"),p.setAttribute("transform",l);for(let m=0,f=n.length;m<f;m++){const g=this.svgFactory.createElement(this.svgElementName);r(this,fa).push(g),g.setAttribute("points",n[m].join(",")),p.append(g)}return!o&&this.hasPopupData&&this._createPopup(),this.container.append(u),this._editOnDoubleClick(),this.container}updateEdited(t){super.updateEdited(t);const{thickness:s,points:n,rect:a}=t,o=r(this,$l);if(s>=0&&o.setAttribute("stroke-width",s||1),n)for(let l=0,d=r(this,fa).length;l<d;l++)r(this,fa)[l].setAttribute("points",n[l].join(","));if(a){const{transform:l,width:d,height:h}=w(this,Hl,Fh).call(this,this.data.rotation,a);o.parentElement.setAttribute("viewBox",`0 0 ${d} ${h}`),o.setAttribute("transform",l)}}getElementsToTriggerPopup(){return r(this,fa)}addHighlightArea(){this.container.classList.add("highlightArea")}}$l=new WeakMap,fa=new WeakMap,Hl=new WeakSet,Fh=function(t,s){switch(t){case 90:return{transform:`rotate(90) translate(${-s[0]},${s[1]}) scale(1,-1)`,width:s[3]-s[1],height:s[2]-s[0]};case 180:return{transform:`rotate(180) translate(${-s[2]},${s[1]}) scale(1,-1)`,width:s[2]-s[0],height:s[3]-s[1]};case 270:return{transform:`rotate(270) translate(${-s[2]},${s[3]}) scale(1,-1)`,width:s[3]-s[1],height:s[2]-s[0]};default:return{transform:`translate(${-s[0]},${s[3]}) scale(1,-1)`,width:s[2]-s[0],height:s[3]-s[1]}}};class Jm extends $e{constructor(e){super(e,{isRenderable:!0,ignoreBorder:!0,createQuadrilaterals:!0}),this.annotationEditorType=ae.HIGHLIGHT}render(){return!this.data.popupRef&&this.hasPopupData&&this._createPopup(),this.container.classList.add("highlightAnnotation"),this._editOnDoubleClick(),this.container}}class ib extends $e{constructor(e){super(e,{isRenderable:!0,ignoreBorder:!0,createQuadrilaterals:!0})}render(){return!this.data.popupRef&&this.hasPopupData&&this._createPopup(),this.container.classList.add("underlineAnnotation"),this.container}}class nb extends $e{constructor(e){super(e,{isRenderable:!0,ignoreBorder:!0,createQuadrilaterals:!0})}render(){return!this.data.popupRef&&this.hasPopupData&&this._createPopup(),this.container.classList.add("squigglyAnnotation"),this.container}}class ab extends $e{constructor(e){super(e,{isRenderable:!0,ignoreBorder:!0,createQuadrilaterals:!0})}render(){return!this.data.popupRef&&this.hasPopupData&&this._createPopup(),this.container.classList.add("strikeoutAnnotation"),this.container}}class ef extends $e{constructor(e){super(e,{isRenderable:!0,ignoreBorder:!0}),this.annotationEditorType=ae.STAMP}render(){return this.container.classList.add("stampAnnotation"),this.container.setAttribute("role","img"),!this.data.popupRef&&this.hasPopupData&&this._createPopup(),this._editOnDoubleClick(),this.container}}var Bl,zl,Oh;class rb extends $e{constructor(t){var n;super(t,{isRenderable:!0});v(this,zl);v(this,Bl,null);const{file:s}=this.data;this.filename=s.filename,this.content=s.content,(n=this.linkService.eventBus)==null||n.dispatch("fileattachmentannotation",{source:this,...s})}render(){this.container.classList.add("fileAttachmentAnnotation");const{container:t,data:s}=this;let n;s.hasAppearance||s.fillAlpha===0?n=document.createElement("div"):(n=document.createElement("img"),n.src=`${this.imageResourcesPath}annotation-${/paperclip/i.test(s.name)?"paperclip":"pushpin"}.svg`,s.fillAlpha&&s.fillAlpha<1&&(n.style=`filter: opacity(${Math.round(s.fillAlpha*100)}%);`)),n.addEventListener("dblclick",w(this,zl,Oh).bind(this)),x(this,Bl,n);const{isMac:a}=At.platform;return t.addEventListener("keydown",o=>{o.key==="Enter"&&(a?o.metaKey:o.ctrlKey)&&w(this,zl,Oh).call(this)}),!s.popupRef&&this.hasPopupData?this._createPopup():n.classList.add("popupTriggerArea"),t.append(n),t}getElementsToTriggerPopup(){return r(this,Bl)}addHighlightArea(){this.container.classList.add("highlightArea")}}Bl=new WeakMap,zl=new WeakSet,Oh=function(){var t;(t=this.downloadManager)==null||t.openOrDownloadData(this.content,this.filename)};var Ul,ga,xa,Gl,Ha,tf,$h;class ob{constructor({div:e,accessibilityManager:t,annotationCanvasMap:s,annotationEditorUIManager:n,page:a,viewport:o,structTreeLayer:l}){v(this,Ha);v(this,Ul,null);v(this,ga,null);v(this,xa,new Map);v(this,Gl,null);this.div=e,x(this,Ul,t),x(this,ga,s),x(this,Gl,l||null),this.page=a,this.viewport=o,this.zIndex=0,this._annotationEditorUIManager=n}hasEditableAnnotations(){return r(this,xa).size>0}async render(e){var o;const{annotations:t}=e,s=this.div;Fa(s,this.viewport);const n=new Map,a={data:null,layer:s,linkService:e.linkService,downloadManager:e.downloadManager,imageResourcesPath:e.imageResourcesPath||"",renderForms:e.renderForms!==!1,svgFactory:new Au,annotationStorage:e.annotationStorage||new Nu,enableScripting:e.enableScripting===!0,hasJSActions:e.hasJSActions,fieldObjects:e.fieldObjects,parent:this,elements:null};for(const l of t){if(l.noHTML)continue;const d=l.annotationType===Ge.POPUP;if(d){const p=n.get(l.id);if(!p)continue;a.elements=p}else{const{width:p,height:m}=Nn(l.rect);if(p<=0||m<=0)continue}a.data=l;const h=G0.create(a);if(!h.isRenderable)continue;if(!d&&l.popupRef){const p=n.get(l.popupRef);p?p.push(h):n.set(l.popupRef,[h])}const u=h.render();l.hidden&&(u.style.visibility="hidden"),await w(this,Ha,tf).call(this,u,l.id),h._isEditable&&(r(this,xa).set(h.data.id,h),(o=this._annotationEditorUIManager)==null||o.renderAnnotationElement(h))}w(this,Ha,$h).call(this)}update({viewport:e}){const t=this.div;this.viewport=e,Fa(t,{rotation:e.rotation}),w(this,Ha,$h).call(this),t.hidden=!1}getEditableAnnotations(){return Array.from(r(this,xa).values())}getEditableAnnotation(e){return r(this,xa).get(e)}}Ul=new WeakMap,ga=new WeakMap,xa=new WeakMap,Gl=new WeakMap,Ha=new WeakSet,tf=async function(e,t){var o,l;const s=e.firstChild||e,n=s.id=`${xu}${t}`,a=await((o=r(this,Gl))==null?void 0:o.getAriaAttributes(n));if(a)for(const[d,h]of a)s.setAttribute(d,h);this.div.append(e),(l=r(this,Ul))==null||l.moveElementInDOM(this.div,e,s,!1)},$h=function(){if(!r(this,ga))return;const e=this.div;for(const[t,s]of r(this,ga)){const n=e.querySelector(`[data-annotation-id="${t}"]`);if(!n)continue;s.className="annotationContent";const{firstChild:a}=n;a?a.nodeName==="CANVAS"?a.replaceWith(s):a.classList.contains("annotationContent")?a.after(s):a.before(s):n.append(s)}r(this,ga).clear()};const vc=/\r\n?|\n/g;var ws,Bt,Vl,ba,zt,Ue,sf,nf,af,Gc,Di,Vc,Wc,rf,Bh,of;const _e=class _e extends Le{constructor(t){super({...t,name:"freeTextEditor"});v(this,Ue);v(this,ws);v(this,Bt,"");v(this,Vl,`${this.id}-editor`);v(this,ba,null);v(this,zt);x(this,ws,t.color||_e._defaultColor||Le._defaultLineColor),x(this,zt,t.fontSize||_e._defaultFontSize)}static get _keyboardManager(){const t=_e.prototype,s=o=>o.isEmpty(),n=Oa.TRANSLATE_SMALL,a=Oa.TRANSLATE_BIG;return de(this,"_keyboardManager",new pc([[["ctrl+s","mac+meta+s","ctrl+p","mac+meta+p"],t.commitOrRemove,{bubbles:!0}],[["ctrl+Enter","mac+meta+Enter","Escape","mac+Escape"],t.commitOrRemove],[["ArrowLeft","mac+ArrowLeft"],t._translateEmpty,{args:[-n,0],checker:s}],[["ctrl+ArrowLeft","mac+shift+ArrowLeft"],t._translateEmpty,{args:[-a,0],checker:s}],[["ArrowRight","mac+ArrowRight"],t._translateEmpty,{args:[n,0],checker:s}],[["ctrl+ArrowRight","mac+shift+ArrowRight"],t._translateEmpty,{args:[a,0],checker:s}],[["ArrowUp","mac+ArrowUp"],t._translateEmpty,{args:[0,-n],checker:s}],[["ctrl+ArrowUp","mac+shift+ArrowUp"],t._translateEmpty,{args:[0,-a],checker:s}],[["ArrowDown","mac+ArrowDown"],t._translateEmpty,{args:[0,n],checker:s}],[["ctrl+ArrowDown","mac+shift+ArrowDown"],t._translateEmpty,{args:[0,a],checker:s}]]))}static initialize(t,s){Le.initialize(t,s);const n=getComputedStyle(document.documentElement);this._internalPadding=parseFloat(n.getPropertyValue("--freetext-padding"))}static updateDefaultParams(t,s){switch(t){case pe.FREETEXT_SIZE:_e._defaultFontSize=s;break;case pe.FREETEXT_COLOR:_e._defaultColor=s;break}}updateParams(t,s){switch(t){case pe.FREETEXT_SIZE:w(this,Ue,sf).call(this,s);break;case pe.FREETEXT_COLOR:w(this,Ue,nf).call(this,s);break}}static get defaultPropertiesToUpdate(){return[[pe.FREETEXT_SIZE,_e._defaultFontSize],[pe.FREETEXT_COLOR,_e._defaultColor||Le._defaultLineColor]]}get propertiesToUpdate(){return[[pe.FREETEXT_SIZE,r(this,zt)],[pe.FREETEXT_COLOR,r(this,ws)]]}_translateEmpty(t,s){this._uiManager.translateSelectedEditors(t,s,!0)}getInitialTranslation(){const t=this.parentScale;return[-_e._internalPadding*t,-(_e._internalPadding+r(this,zt))*t]}rebuild(){this.parent&&(super.rebuild(),this.div!==null&&(this.isAttachedToDOM||this.parent.add(this)))}enableEditMode(){if(this.isInEditMode())return;this.parent.setEditingState(!1),this.parent.updateToolbar(ae.FREETEXT),super.enableEditMode(),this.overlayDiv.classList.remove("enabled"),this.editorDiv.contentEditable=!0,this._isDraggable=!1,this.div.removeAttribute("aria-activedescendant"),x(this,ba,new AbortController);const t=this._uiManager.combinedSignal(r(this,ba));this.editorDiv.addEventListener("keydown",this.editorDivKeydown.bind(this),{signal:t}),this.editorDiv.addEventListener("focus",this.editorDivFocus.bind(this),{signal:t}),this.editorDiv.addEventListener("blur",this.editorDivBlur.bind(this),{signal:t}),this.editorDiv.addEventListener("input",this.editorDivInput.bind(this),{signal:t}),this.editorDiv.addEventListener("paste",this.editorDivPaste.bind(this),{signal:t})}disableEditMode(){var t;this.isInEditMode()&&(this.parent.setEditingState(!0),super.disableEditMode(),this.overlayDiv.classList.add("enabled"),this.editorDiv.contentEditable=!1,this.div.setAttribute("aria-activedescendant",r(this,Vl)),this._isDraggable=!0,(t=r(this,ba))==null||t.abort(),x(this,ba,null),this.div.focus({preventScroll:!0}),this.isEditing=!1,this.parent.div.classList.add("freetextEditing"))}focusin(t){this._focusEventsAllowed&&(super.focusin(t),t.target!==this.editorDiv&&this.editorDiv.focus())}onceAdded(t){var s;this.width||(this.enableEditMode(),t&&this.editorDiv.focus(),(s=this._initialOptions)!=null&&s.isCentered&&this.center(),this._initialOptions=null)}isEmpty(){return!this.editorDiv||this.editorDiv.innerText.trim()===""}remove(){this.isEditing=!1,this.parent&&(this.parent.setEditingState(!0),this.parent.div.classList.add("freetextEditing")),super.remove()}commit(){if(!this.isInEditMode())return;super.commit(),this.disableEditMode();const t=r(this,Bt),s=x(this,Bt,w(this,Ue,af).call(this).trimEnd());if(t===s)return;const n=a=>{if(x(this,Bt,a),!a){this.remove();return}w(this,Ue,Wc).call(this),this._uiManager.rebuild(this),w(this,Ue,Gc).call(this)};this.addCommands({cmd:()=>{n(s)},undo:()=>{n(t)},mustExec:!1}),w(this,Ue,Gc).call(this)}shouldGetKeyboardEvents(){return this.isInEditMode()}enterInEditMode(){this.enableEditMode(),this.editorDiv.focus()}dblclick(t){this.enterInEditMode()}keydown(t){t.target===this.div&&t.key==="Enter"&&(this.enterInEditMode(),t.preventDefault())}editorDivKeydown(t){_e._keyboardManager.exec(this,t)}editorDivFocus(t){this.isEditing=!0}editorDivBlur(t){this.isEditing=!1}editorDivInput(t){this.parent.div.classList.toggle("freetextEditing",this.isEmpty())}disableEditing(){this.editorDiv.setAttribute("role","comment"),this.editorDiv.removeAttribute("aria-multiline")}enableEditing(){this.editorDiv.setAttribute("role","textbox"),this.editorDiv.setAttribute("aria-multiline",!0)}render(){if(this.div)return this.div;let t,s;this.width&&(t=this.x,s=this.y),super.render(),this.editorDiv=document.createElement("div"),this.editorDiv.className="internal",this.editorDiv.setAttribute("id",r(this,Vl)),this.editorDiv.setAttribute("data-l10n-id","pdfjs-free-text2"),this.editorDiv.setAttribute("data-l10n-attrs","default-content"),this.enableEditing(),this.editorDiv.contentEditable=!0;const{style:n}=this.editorDiv;if(n.fontSize=`calc(${r(this,zt)}px * var(--scale-factor))`,n.color=r(this,ws),this.div.append(this.editorDiv),this.overlayDiv=document.createElement("div"),this.overlayDiv.classList.add("overlay","enabled"),this.div.append(this.overlayDiv),ad(this,this.div,["dblclick","keydown"]),this.width){const[a,o]=this.parentDimensions;if(this.annotationElementId){const{position:l}=this._initialData;let[d,h]=this.getInitialTranslation();[d,h]=this.pageTranslationToScreen(d,h);const[u,p]=this.pageDimensions,[m,f]=this.pageTranslation;let g,b;switch(this.rotation){case 0:g=t+(l[0]-m)/u,b=s+this.height-(l[1]-f)/p;break;case 90:g=t+(l[0]-m)/u,b=s-(l[1]-f)/p,[d,h]=[h,-d];break;case 180:g=t-this.width+(l[0]-m)/u,b=s-(l[1]-f)/p,[d,h]=[-d,-h];break;case 270:g=t+(l[0]-m-this.height*p)/u,b=s+(l[1]-f-this.width*u)/p,[d,h]=[-h,d];break}this.setAt(g*a,b*o,d,h)}else this.setAt(t*a,s*o,this.width*a,this.height*o);w(this,Ue,Wc).call(this),this._isDraggable=!0,this.editorDiv.contentEditable=!1}else this._isDraggable=!1,this.editorDiv.contentEditable=!0;return this.div}editorDivPaste(t){var g,b,A;const s=t.clipboardData||window.clipboardData,{types:n}=s;if(n.length===1&&n[0]==="text/plain")return;t.preventDefault();const a=w(g=_e,Di,Bh).call(g,s.getData("text")||"").replaceAll(vc,`
`);if(!a)return;const o=window.getSelection();if(!o.rangeCount)return;this.editorDiv.normalize(),o.deleteFromDocument();const l=o.getRangeAt(0);if(!a.includes(`
`)){l.insertNode(document.createTextNode(a)),this.editorDiv.normalize(),o.collapseToStart();return}const{startContainer:d,startOffset:h}=l,u=[],p=[];if(d.nodeType===Node.TEXT_NODE){const N=d.parentElement;if(p.push(d.nodeValue.slice(h).replaceAll(vc,"")),N!==this.editorDiv){let j=u;for(const E of this.editorDiv.childNodes){if(E===N){j=p;continue}j.push(w(b=_e,Di,Vc).call(b,E))}}u.push(d.nodeValue.slice(0,h).replaceAll(vc,""))}else if(d===this.editorDiv){let N=u,j=0;for(const E of this.editorDiv.childNodes)j++===h&&(N=p),N.push(w(A=_e,Di,Vc).call(A,E))}x(this,Bt,`${u.join(`
`)}${a}${p.join(`
`)}`),w(this,Ue,Wc).call(this);const m=new Range;let f=u.reduce((N,j)=>N+j.length,0);for(const{firstChild:N}of this.editorDiv.childNodes)if(N.nodeType===Node.TEXT_NODE){const j=N.nodeValue.length;if(f<=j){m.setStart(N,f),m.setEnd(N,f);break}f-=j}o.removeAllRanges(),o.addRange(m)}get contentDiv(){return this.editorDiv}static async deserialize(t,s,n){var l;let a=null;if(t instanceof Qm){const{data:{defaultAppearanceData:{fontSize:d,fontColor:h},rect:u,rotation:p,id:m,popupRef:f},textContent:g,textPosition:b,parent:{page:{pageNumber:A}}}=t;if(!g||g.length===0)return null;a=t={annotationType:ae.FREETEXT,color:Array.from(h),fontSize:d,value:g.join(`
`),position:b,pageIndex:A-1,rect:u.slice(0),rotation:p,id:m,deleted:!1,popupRef:f}}const o=await super.deserialize(t,s,n);return x(o,zt,t.fontSize),x(o,ws,X.makeHexColor(...t.color)),x(o,Bt,w(l=_e,Di,Bh).call(l,t.value)),o.annotationElementId=t.id||null,o._initialData=a,o}serialize(t=!1){if(this.isEmpty())return null;if(this.deleted)return this.serializeDeleted();const s=_e._internalPadding*this.parentScale,n=this.getRect(s,s),a=Le._colorManager.convert(this.isAttachedToDOM?getComputedStyle(this.editorDiv).color:r(this,ws)),o={annotationType:ae.FREETEXT,color:a,fontSize:r(this,zt),value:w(this,Ue,rf).call(this),pageIndex:this.pageIndex,rect:n,rotation:this.rotation,structTreeParentId:this._structTreeParentId};return t?o:this.annotationElementId&&!w(this,Ue,of).call(this,o)?null:(o.id=this.annotationElementId,o)}renderAnnotationElement(t){const s=super.renderAnnotationElement(t);if(this.deleted)return s;const{style:n}=s;n.fontSize=`calc(${r(this,zt)}px * var(--scale-factor))`,n.color=r(this,ws),s.replaceChildren();for(const o of r(this,Bt).split(`
`)){const l=document.createElement("div");l.append(o?document.createTextNode(o):document.createElement("br")),s.append(l)}const a=_e._internalPadding*this.parentScale;return t.updateEdited({rect:this.getRect(a,a),popupContent:r(this,Bt)}),s}resetAnnotationElement(t){super.resetAnnotationElement(t),t.resetEdited()}};ws=new WeakMap,Bt=new WeakMap,Vl=new WeakMap,ba=new WeakMap,zt=new WeakMap,Ue=new WeakSet,sf=function(t){const s=a=>{this.editorDiv.style.fontSize=`calc(${a}px * var(--scale-factor))`,this.translate(0,-(a-r(this,zt))*this.parentScale),x(this,zt,a),w(this,Ue,Gc).call(this)},n=r(this,zt);this.addCommands({cmd:s.bind(this,t),undo:s.bind(this,n),post:this._uiManager.updateUI.bind(this._uiManager,this),mustExec:!0,type:pe.FREETEXT_SIZE,overwriteIfSameType:!0,keepUndo:!0})},nf=function(t){const s=a=>{x(this,ws,this.editorDiv.style.color=a)},n=r(this,ws);this.addCommands({cmd:s.bind(this,t),undo:s.bind(this,n),post:this._uiManager.updateUI.bind(this._uiManager,this),mustExec:!0,type:pe.FREETEXT_COLOR,overwriteIfSameType:!0,keepUndo:!0})},af=function(){var n;const t=[];this.editorDiv.normalize();let s=null;for(const a of this.editorDiv.childNodes)(s==null?void 0:s.nodeType)===Node.TEXT_NODE&&a.nodeName==="BR"||(t.push(w(n=_e,Di,Vc).call(n,a)),s=a);return t.join(`
`)},Gc=function(){const[t,s]=this.parentDimensions;let n;if(this.isAttachedToDOM)n=this.div.getBoundingClientRect();else{const{currentLayer:a,div:o}=this,l=o.style.display,d=o.classList.contains("hidden");o.classList.remove("hidden"),o.style.display="hidden",a.div.append(this.div),n=o.getBoundingClientRect(),o.remove(),o.style.display=l,o.classList.toggle("hidden",d)}this.rotation%180===this.parentRotation%180?(this.width=n.width/t,this.height=n.height/s):(this.width=n.height/t,this.height=n.width/s),this.fixAndSetPosition()},Di=new WeakSet,Vc=function(t){return(t.nodeType===Node.TEXT_NODE?t.nodeValue:t.innerText).replaceAll(vc,"")},Wc=function(){if(this.editorDiv.replaceChildren(),!!r(this,Bt))for(const t of r(this,Bt).split(`
`)){const s=document.createElement("div");s.append(t?document.createTextNode(t):document.createElement("br")),this.editorDiv.append(s)}},rf=function(){return r(this,Bt).replaceAll(" "," ")},Bh=function(t){return t.replaceAll(" "," ")},of=function(t){const{value:s,fontSize:n,color:a,pageIndex:o}=this._initialData;return this._hasBeenMoved||t.value!==s||t.fontSize!==n||t.color.some((l,d)=>l!==a[d])||t.pageIndex!==o},v(_e,Di),Z(_e,"_freeTextDefaultContent",""),Z(_e,"_internalPadding",0),Z(_e,"_defaultColor",null),Z(_e,"_defaultFontSize",10),Z(_e,"_type","freetext"),Z(_e,"_editorType",ae.FREETEXT);let Hh=_e;class U{toSVGPath(){Ae("Abstract method `toSVGPath` must be implemented.")}get box(){Ae("Abstract getter `box` must be implemented.")}serialize(e,t){Ae("Abstract method `serialize` must be implemented.")}static _rescale(e,t,s,n,a,o){o||(o=new Float32Array(e.length));for(let l=0,d=e.length;l<d;l+=2)o[l]=t+e[l]*n,o[l+1]=s+e[l+1]*a;return o}static _rescaleAndSwap(e,t,s,n,a,o){o||(o=new Float32Array(e.length));for(let l=0,d=e.length;l<d;l+=2)o[l]=t+e[l+1]*n,o[l+1]=s+e[l]*a;return o}static _translate(e,t,s,n){n||(n=new Float32Array(e.length));for(let a=0,o=e.length;a<o;a+=2)n[a]=t+e[a],n[a+1]=s+e[a+1];return n}static svgRound(e){return Math.round(e*1e4)}static _normalizePoint(e,t,s,n,a){switch(a){case 90:return[1-t/s,e/n];case 180:return[1-e/s,1-t/n];case 270:return[t/s,1-e/n];default:return[e/s,t/n]}}static _normalizePagePoint(e,t,s){switch(s){case 90:return[1-t,e];case 180:return[1-e,1-t];case 270:return[t,1-e];default:return[e,t]}}static createBezierPoints(e,t,s,n,a,o){return[(e+5*s)/6,(t+5*n)/6,(5*s+a)/6,(5*n+o)/6,(s+a)/2,(n+o)/2]}}Z(U,"PRECISION",1e-4);var Ut,Ns,Fr,Or,Xs,ce,va,ya,Wl,ql,$r,Hr,dn,Xl,Sd,Cd,Xe,_o,lf,cf,df,hf,uf,pf;const li=class li{constructor({x:e,y:t},s,n,a,o,l=0){v(this,Xe);v(this,Ut);v(this,Ns,[]);v(this,Fr);v(this,Or);v(this,Xs,[]);v(this,ce,new Float32Array(18));v(this,va);v(this,ya);v(this,Wl);v(this,ql);v(this,$r);v(this,Hr);v(this,dn,[]);x(this,Ut,s),x(this,Hr,a*n),x(this,Or,o),r(this,ce).set([NaN,NaN,NaN,NaN,e,t],6),x(this,Fr,l),x(this,ql,r(li,Xl)*n),x(this,Wl,r(li,Cd)*n),x(this,$r,n),r(this,dn).push(e,t)}isEmpty(){return isNaN(r(this,ce)[8])}add({x:e,y:t}){var k;x(this,va,e),x(this,ya,t);const[s,n,a,o]=r(this,Ut);let[l,d,h,u]=r(this,ce).subarray(8,12);const p=e-h,m=t-u,f=Math.hypot(p,m);if(f<r(this,Wl))return!1;const g=f-r(this,ql),b=g/f,A=b*p,N=b*m;let j=l,E=d;l=h,d=u,h+=A,u+=N,(k=r(this,dn))==null||k.push(e,t);const _=-N/g,y=A/g,C=_*r(this,Hr),R=y*r(this,Hr);return r(this,ce).set(r(this,ce).subarray(2,8),0),r(this,ce).set([h+C,u+R],4),r(this,ce).set(r(this,ce).subarray(14,18),12),r(this,ce).set([h-C,u-R],16),isNaN(r(this,ce)[6])?(r(this,Xs).length===0&&(r(this,ce).set([l+C,d+R],2),r(this,Xs).push(NaN,NaN,NaN,NaN,(l+C-s)/a,(d+R-n)/o),r(this,ce).set([l-C,d-R],14),r(this,Ns).push(NaN,NaN,NaN,NaN,(l-C-s)/a,(d-R-n)/o)),r(this,ce).set([j,E,l,d,h,u],6),!this.isEmpty()):(r(this,ce).set([j,E,l,d,h,u],6),Math.abs(Math.atan2(E-d,j-l)-Math.atan2(N,A))<Math.PI/2?([l,d,h,u]=r(this,ce).subarray(2,6),r(this,Xs).push(NaN,NaN,NaN,NaN,((l+h)/2-s)/a,((d+u)/2-n)/o),[l,d,j,E]=r(this,ce).subarray(14,18),r(this,Ns).push(NaN,NaN,NaN,NaN,((j+l)/2-s)/a,((E+d)/2-n)/o),!0):([j,E,l,d,h,u]=r(this,ce).subarray(0,6),r(this,Xs).push(((j+5*l)/6-s)/a,((E+5*d)/6-n)/o,((5*l+h)/6-s)/a,((5*d+u)/6-n)/o,((l+h)/2-s)/a,((d+u)/2-n)/o),[h,u,l,d,j,E]=r(this,ce).subarray(12,18),r(this,Ns).push(((j+5*l)/6-s)/a,((E+5*d)/6-n)/o,((5*l+h)/6-s)/a,((5*d+u)/6-n)/o,((l+h)/2-s)/a,((d+u)/2-n)/o),!0))}toSVGPath(){if(this.isEmpty())return"";const e=r(this,Xs),t=r(this,Ns);if(isNaN(r(this,ce)[6])&&!this.isEmpty())return w(this,Xe,lf).call(this);const s=[];s.push(`M${e[4]} ${e[5]}`);for(let n=6;n<e.length;n+=6)isNaN(e[n])?s.push(`L${e[n+4]} ${e[n+5]}`):s.push(`C${e[n]} ${e[n+1]} ${e[n+2]} ${e[n+3]} ${e[n+4]} ${e[n+5]}`);w(this,Xe,df).call(this,s);for(let n=t.length-6;n>=6;n-=6)isNaN(t[n])?s.push(`L${t[n+4]} ${t[n+5]}`):s.push(`C${t[n]} ${t[n+1]} ${t[n+2]} ${t[n+3]} ${t[n+4]} ${t[n+5]}`);return w(this,Xe,cf).call(this,s),s.join(" ")}newFreeDrawOutline(e,t,s,n,a,o){return new mf(e,t,s,n,a,o)}getOutlines(){var p,m;const e=r(this,Xs),t=r(this,Ns),s=r(this,ce),[n,a,o,l]=r(this,Ut),d=new Float32Array(((m=(p=r(this,dn))==null?void 0:p.length)!=null?m:0)+2);for(let f=0,g=d.length-2;f<g;f+=2)d[f]=(r(this,dn)[f]-n)/o,d[f+1]=(r(this,dn)[f+1]-a)/l;if(d[d.length-2]=(r(this,va)-n)/o,d[d.length-1]=(r(this,ya)-a)/l,isNaN(s[6])&&!this.isEmpty())return w(this,Xe,hf).call(this,d);const h=new Float32Array(r(this,Xs).length+24+r(this,Ns).length);let u=e.length;for(let f=0;f<u;f+=2){if(isNaN(e[f])){h[f]=h[f+1]=NaN;continue}h[f]=e[f],h[f+1]=e[f+1]}u=w(this,Xe,pf).call(this,h,u);for(let f=t.length-6;f>=6;f-=6)for(let g=0;g<6;g+=2){if(isNaN(t[f+g])){h[u]=h[u+1]=NaN,u+=2;continue}h[u]=t[f+g],h[u+1]=t[f+g+1],u+=2}return w(this,Xe,uf).call(this,h,u),this.newFreeDrawOutline(h,d,r(this,Ut),r(this,$r),r(this,Fr),r(this,Or))}};Ut=new WeakMap,Ns=new WeakMap,Fr=new WeakMap,Or=new WeakMap,Xs=new WeakMap,ce=new WeakMap,va=new WeakMap,ya=new WeakMap,Wl=new WeakMap,ql=new WeakMap,$r=new WeakMap,Hr=new WeakMap,dn=new WeakMap,Xl=new WeakMap,Sd=new WeakMap,Cd=new WeakMap,Xe=new WeakSet,_o=function(){const e=r(this,ce).subarray(4,6),t=r(this,ce).subarray(16,18),[s,n,a,o]=r(this,Ut);return[(r(this,va)+(e[0]-t[0])/2-s)/a,(r(this,ya)+(e[1]-t[1])/2-n)/o,(r(this,va)+(t[0]-e[0])/2-s)/a,(r(this,ya)+(t[1]-e[1])/2-n)/o]},lf=function(){const[e,t,s,n]=r(this,Ut),[a,o,l,d]=w(this,Xe,_o).call(this);return`M${(r(this,ce)[2]-e)/s} ${(r(this,ce)[3]-t)/n} L${(r(this,ce)[4]-e)/s} ${(r(this,ce)[5]-t)/n} L${a} ${o} L${l} ${d} L${(r(this,ce)[16]-e)/s} ${(r(this,ce)[17]-t)/n} L${(r(this,ce)[14]-e)/s} ${(r(this,ce)[15]-t)/n} Z`},cf=function(e){const t=r(this,Ns);e.push(`L${t[4]} ${t[5]} Z`)},df=function(e){const[t,s,n,a]=r(this,Ut),o=r(this,ce).subarray(4,6),l=r(this,ce).subarray(16,18),[d,h,u,p]=w(this,Xe,_o).call(this);e.push(`L${(o[0]-t)/n} ${(o[1]-s)/a} L${d} ${h} L${u} ${p} L${(l[0]-t)/n} ${(l[1]-s)/a}`)},hf=function(e){const t=r(this,ce),[s,n,a,o]=r(this,Ut),[l,d,h,u]=w(this,Xe,_o).call(this),p=new Float32Array(36);return p.set([NaN,NaN,NaN,NaN,(t[2]-s)/a,(t[3]-n)/o,NaN,NaN,NaN,NaN,(t[4]-s)/a,(t[5]-n)/o,NaN,NaN,NaN,NaN,l,d,NaN,NaN,NaN,NaN,h,u,NaN,NaN,NaN,NaN,(t[16]-s)/a,(t[17]-n)/o,NaN,NaN,NaN,NaN,(t[14]-s)/a,(t[15]-n)/o],0),this.newFreeDrawOutline(p,e,r(this,Ut),r(this,$r),r(this,Fr),r(this,Or))},uf=function(e,t){const s=r(this,Ns);return e.set([NaN,NaN,NaN,NaN,s[4],s[5]],t),t+=6},pf=function(e,t){const s=r(this,ce).subarray(4,6),n=r(this,ce).subarray(16,18),[a,o,l,d]=r(this,Ut),[h,u,p,m]=w(this,Xe,_o).call(this);return e.set([NaN,NaN,NaN,NaN,(s[0]-a)/l,(s[1]-o)/d,NaN,NaN,NaN,NaN,h,u,NaN,NaN,NaN,NaN,p,m,NaN,NaN,NaN,NaN,(n[0]-a)/l,(n[1]-o)/d],t),t+=24},v(li,Xl,8),v(li,Sd,2),v(li,Cd,r(li,Xl)+r(li,Sd));let ld=li;var Br,wa,Ci,Yl,Gt,Kl,Oe,Ed,ff;class mf extends U{constructor(t,s,n,a,o,l){super();v(this,Ed);v(this,Br);v(this,wa,new Float32Array(4));v(this,Ci);v(this,Yl);v(this,Gt);v(this,Kl);v(this,Oe);x(this,Oe,t),x(this,Gt,s),x(this,Br,n),x(this,Kl,a),x(this,Ci,o),x(this,Yl,l),this.lastPoint=[NaN,NaN],w(this,Ed,ff).call(this,l);const[d,h,u,p]=r(this,wa);for(let m=0,f=t.length;m<f;m+=2)t[m]=(t[m]-d)/u,t[m+1]=(t[m+1]-h)/p;for(let m=0,f=s.length;m<f;m+=2)s[m]=(s[m]-d)/u,s[m+1]=(s[m+1]-h)/p}toSVGPath(){const t=[`M${r(this,Oe)[4]} ${r(this,Oe)[5]}`];for(let s=6,n=r(this,Oe).length;s<n;s+=6){if(isNaN(r(this,Oe)[s])){t.push(`L${r(this,Oe)[s+4]} ${r(this,Oe)[s+5]}`);continue}t.push(`C${r(this,Oe)[s]} ${r(this,Oe)[s+1]} ${r(this,Oe)[s+2]} ${r(this,Oe)[s+3]} ${r(this,Oe)[s+4]} ${r(this,Oe)[s+5]}`)}return t.push("Z"),t.join(" ")}serialize([t,s,n,a],o){const l=n-t,d=a-s;let h,u;switch(o){case 0:h=U._rescale(r(this,Oe),t,a,l,-d),u=U._rescale(r(this,Gt),t,a,l,-d);break;case 90:h=U._rescaleAndSwap(r(this,Oe),t,s,l,d),u=U._rescaleAndSwap(r(this,Gt),t,s,l,d);break;case 180:h=U._rescale(r(this,Oe),n,s,-l,d),u=U._rescale(r(this,Gt),n,s,-l,d);break;case 270:h=U._rescaleAndSwap(r(this,Oe),n,a,-l,-d),u=U._rescaleAndSwap(r(this,Gt),n,a,-l,-d);break}return{outline:Array.from(h),points:[Array.from(u)]}}get box(){return r(this,wa)}newOutliner(t,s,n,a,o,l=0){return new ld(t,s,n,a,o,l)}getNewOutline(t,s){const[n,a,o,l]=r(this,wa),[d,h,u,p]=r(this,Br),m=o*u,f=l*p,g=n*u+d,b=a*p+h,A=this.newOutliner({x:r(this,Gt)[0]*m+g,y:r(this,Gt)[1]*f+b},r(this,Br),r(this,Kl),t,r(this,Yl),s!=null?s:r(this,Ci));for(let N=2;N<r(this,Gt).length;N+=2)A.add({x:r(this,Gt)[N]*m+g,y:r(this,Gt)[N+1]*f+b});return A.getOutlines()}}Br=new WeakMap,wa=new WeakMap,Ci=new WeakMap,Yl=new WeakMap,Gt=new WeakMap,Kl=new WeakMap,Oe=new WeakMap,Ed=new WeakSet,ff=function(t){const s=r(this,Oe);let n=s[4],a=s[5],o=n,l=a,d=n,h=a,u=n,p=a;const m=t?Math.max:Math.min;for(let g=6,b=s.length;g<b;g+=6){if(isNaN(s[g]))o=Math.min(o,s[g+4]),l=Math.min(l,s[g+5]),d=Math.max(d,s[g+4]),h=Math.max(h,s[g+5]),p<s[g+5]?(u=s[g+4],p=s[g+5]):p===s[g+5]&&(u=m(u,s[g+4]));else{const A=X.bezierBoundingBox(n,a,...s.slice(g,g+6));o=Math.min(o,A[0]),l=Math.min(l,A[1]),d=Math.max(d,A[2]),h=Math.max(h,A[3]),p<A[3]?(u=A[2],p=A[3]):p===A[3]&&(u=m(u,A[2]))}n=s[g+4],a=s[g+5]}const f=r(this,wa);f[0]=o-r(this,Ci),f[1]=l-r(this,Ci),f[2]=d-o+2*r(this,Ci),f[3]=h-l+2*r(this,Ci),this.lastPoint=[u,p]};var Ql,Zl,hn,js,St,gf,qc,xf,bf,Uh;class zh{constructor(e,t=0,s=0,n=!0){v(this,St);v(this,Ql);v(this,Zl);v(this,hn,[]);v(this,js,[]);let a=1/0,o=-1/0,l=1/0,d=-1/0;const h=10**-4;for(const{x:A,y:N,width:j,height:E}of e){const _=Math.floor((A-t)/h)*h,y=Math.ceil((A+j+t)/h)*h,C=Math.floor((N-t)/h)*h,R=Math.ceil((N+E+t)/h)*h,S=[_,C,R,!0],k=[y,C,R,!1];r(this,hn).push(S,k),a=Math.min(a,_),o=Math.max(o,y),l=Math.min(l,C),d=Math.max(d,R)}const u=o-a+2*s,p=d-l+2*s,m=a-s,f=l-s,g=r(this,hn).at(n?-1:-2),b=[g[0],g[2]];for(const A of r(this,hn)){const[N,j,E]=A;A[0]=(N-m)/u,A[1]=(j-f)/p,A[2]=(E-f)/p}x(this,Ql,new Float32Array([m,f,u,p])),x(this,Zl,b)}getOutlines(){r(this,hn).sort((t,s)=>t[0]-s[0]||t[1]-s[1]||t[2]-s[2]);const e=[];for(const t of r(this,hn))t[3]?(e.push(...w(this,St,Uh).call(this,t)),w(this,St,xf).call(this,t)):(w(this,St,bf).call(this,t),e.push(...w(this,St,Uh).call(this,t)));return w(this,St,gf).call(this,e)}}Ql=new WeakMap,Zl=new WeakMap,hn=new WeakMap,js=new WeakMap,St=new WeakSet,gf=function(e){const t=[],s=new Set;for(const o of e){const[l,d,h]=o;t.push([l,d,o],[l,h,o])}t.sort((o,l)=>o[1]-l[1]||o[0]-l[0]);for(let o=0,l=t.length;o<l;o+=2){const d=t[o][2],h=t[o+1][2];d.push(h),h.push(d),s.add(d),s.add(h)}const n=[];let a;for(;s.size>0;){const o=s.values().next().value;let[l,d,h,u,p]=o;s.delete(o);let m=l,f=d;for(a=[l,h],n.push(a);;){let g;if(s.has(u))g=u;else if(s.has(p))g=p;else break;s.delete(g),[l,d,h,u,p]=g,m!==l&&(a.push(m,f,l,f===d?d:h),m=l),f=f===d?h:d}a.push(m,f)}return new lb(n,r(this,Ql),r(this,Zl))},qc=function(e){const t=r(this,js);let s=0,n=t.length-1;for(;s<=n;){const a=s+n>>1,o=t[a][0];if(o===e)return a;o<e?s=a+1:n=a-1}return n+1},xf=function([,e,t]){const s=w(this,St,qc).call(this,e);r(this,js).splice(s,0,[e,t])},bf=function([,e,t]){const s=w(this,St,qc).call(this,e);for(let n=s;n<r(this,js).length;n++){const[a,o]=r(this,js)[n];if(a!==e)break;if(a===e&&o===t){r(this,js).splice(n,1);return}}for(let n=s-1;n>=0;n--){const[a,o]=r(this,js)[n];if(a!==e)break;if(a===e&&o===t){r(this,js).splice(n,1);return}}},Uh=function(e){const[t,s,n]=e,a=[[t,s,n]],o=w(this,St,qc).call(this,n);for(let l=0;l<o;l++){const[d,h]=r(this,js)[l];for(let u=0,p=a.length;u<p;u++){const[,m,f]=a[u];if(!(h<=m||f<=d)){if(m>=d){if(f>h)a[u][1]=h;else{if(p===1)return[];a.splice(u,1),u--,p--}continue}a[u][2]=d,f>h&&a.push([t,h,f])}}}return a};var Jl,zr;class lb extends U{constructor(t,s,n){super();v(this,Jl);v(this,zr);x(this,zr,t),x(this,Jl,s),this.lastPoint=n}toSVGPath(){const t=[];for(const s of r(this,zr)){let[n,a]=s;t.push(`M${n} ${a}`);for(let o=2;o<s.length;o+=2){const l=s[o],d=s[o+1];l===n?(t.push(`V${d}`),a=d):d===a&&(t.push(`H${l}`),n=l)}t.push("Z")}return t.join(" ")}serialize([t,s,n,a],o){const l=[],d=n-t,h=a-s;for(const u of r(this,zr)){const p=new Array(u.length);for(let m=0;m<u.length;m+=2)p[m]=t+u[m]*d,p[m+1]=a-u[m+1]*h;l.push(p)}return l}get box(){return r(this,Jl)}get classNamesForOutlining(){return["highlightOutline"]}}Jl=new WeakMap,zr=new WeakMap;class Gh extends ld{newFreeDrawOutline(e,t,s,n,a,o){return new cb(e,t,s,n,a,o)}}class cb extends mf{newOutliner(e,t,s,n,a,o=0){return new Gh(e,t,s,n,a,o)}}var As,Na,Ur,qe,ec,Gr,tc,sc,un,_s,Vr,ic,we,Vh,Wh,qh,En,vf,Bi;const Rt=class Rt{constructor({editor:e=null,uiManager:t=null}){v(this,we);v(this,As,null);v(this,Na,null);v(this,Ur);v(this,qe,null);v(this,ec,!1);v(this,Gr,!1);v(this,tc,null);v(this,sc);v(this,un,null);v(this,_s,null);v(this,Vr);var s;e?(x(this,Gr,!1),x(this,Vr,pe.HIGHLIGHT_COLOR),x(this,tc,e)):(x(this,Gr,!0),x(this,Vr,pe.HIGHLIGHT_DEFAULT_COLOR)),x(this,_s,(e==null?void 0:e._uiManager)||t),x(this,sc,r(this,_s)._eventBus),x(this,Ur,(e==null?void 0:e.color)||((s=r(this,_s))==null?void 0:s.highlightColors.values().next().value)||"#FFFF98"),r(Rt,ic)||x(Rt,ic,Object.freeze({blue:"pdfjs-editor-colorpicker-blue",green:"pdfjs-editor-colorpicker-green",pink:"pdfjs-editor-colorpicker-pink",red:"pdfjs-editor-colorpicker-red",yellow:"pdfjs-editor-colorpicker-yellow"}))}static get _keyboardManager(){return de(this,"_keyboardManager",new pc([[["Escape","mac+Escape"],Rt.prototype._hideDropdownFromKeyboard],[[" ","mac+ "],Rt.prototype._colorSelectFromKeyboard],[["ArrowDown","ArrowRight","mac+ArrowDown","mac+ArrowRight"],Rt.prototype._moveToNext],[["ArrowUp","ArrowLeft","mac+ArrowUp","mac+ArrowLeft"],Rt.prototype._moveToPrevious],[["Home","mac+Home"],Rt.prototype._moveToBeginning],[["End","mac+End"],Rt.prototype._moveToEnd]]))}renderButton(){const e=x(this,As,document.createElement("button"));e.className="colorPicker",e.tabIndex="0",e.setAttribute("data-l10n-id","pdfjs-editor-colorpicker-button"),e.setAttribute("aria-haspopup",!0);const t=r(this,_s)._signal;e.addEventListener("click",w(this,we,En).bind(this),{signal:t}),e.addEventListener("keydown",w(this,we,qh).bind(this),{signal:t});const s=x(this,Na,document.createElement("span"));return s.className="swatch",s.setAttribute("aria-hidden",!0),s.style.backgroundColor=r(this,Ur),e.append(s),e}renderMainDropdown(){const e=x(this,qe,w(this,we,Vh).call(this));return e.setAttribute("aria-orientation","horizontal"),e.setAttribute("aria-labelledby","highlightColorPickerLabel"),e}_colorSelectFromKeyboard(e){if(e.target===r(this,As)){w(this,we,En).call(this,e);return}const t=e.target.getAttribute("data-color");t&&w(this,we,Wh).call(this,t,e)}_moveToNext(e){var t,s;if(!r(this,we,Bi)){w(this,we,En).call(this,e);return}if(e.target===r(this,As)){(t=r(this,qe).firstChild)==null||t.focus();return}(s=e.target.nextSibling)==null||s.focus()}_moveToPrevious(e){var t,s;if(e.target===((t=r(this,qe))==null?void 0:t.firstChild)||e.target===r(this,As)){r(this,we,Bi)&&this._hideDropdownFromKeyboard();return}r(this,we,Bi)||w(this,we,En).call(this,e),(s=e.target.previousSibling)==null||s.focus()}_moveToBeginning(e){var t;if(!r(this,we,Bi)){w(this,we,En).call(this,e);return}(t=r(this,qe).firstChild)==null||t.focus()}_moveToEnd(e){var t;if(!r(this,we,Bi)){w(this,we,En).call(this,e);return}(t=r(this,qe).lastChild)==null||t.focus()}hideDropdown(){var e,t;(e=r(this,qe))==null||e.classList.add("hidden"),(t=r(this,un))==null||t.abort(),x(this,un,null)}_hideDropdownFromKeyboard(){var e;if(!r(this,Gr)){if(!r(this,we,Bi)){(e=r(this,tc))==null||e.unselect();return}this.hideDropdown(),r(this,As).focus({preventScroll:!0,focusVisible:r(this,ec)})}}updateColor(e){if(r(this,Na)&&(r(this,Na).style.backgroundColor=e),!r(this,qe))return;const t=r(this,_s).highlightColors.values();for(const s of r(this,qe).children)s.setAttribute("aria-selected",t.next().value===e)}destroy(){var e,t;(e=r(this,As))==null||e.remove(),x(this,As,null),x(this,Na,null),(t=r(this,qe))==null||t.remove(),x(this,qe,null)}};As=new WeakMap,Na=new WeakMap,Ur=new WeakMap,qe=new WeakMap,ec=new WeakMap,Gr=new WeakMap,tc=new WeakMap,sc=new WeakMap,un=new WeakMap,_s=new WeakMap,Vr=new WeakMap,ic=new WeakMap,we=new WeakSet,Vh=function(){const e=document.createElement("div"),t=r(this,_s)._signal;e.addEventListener("contextmenu",Ts,{signal:t}),e.className="dropdown",e.role="listbox",e.setAttribute("aria-multiselectable",!1),e.setAttribute("aria-orientation","vertical"),e.setAttribute("data-l10n-id","pdfjs-editor-colorpicker-dropdown");for(const[s,n]of r(this,_s).highlightColors){const a=document.createElement("button");a.tabIndex="0",a.role="option",a.setAttribute("data-color",n),a.title=s,a.setAttribute("data-l10n-id",r(Rt,ic)[s]);const o=document.createElement("span");a.append(o),o.className="swatch",o.style.backgroundColor=n,a.setAttribute("aria-selected",n===r(this,Ur)),a.addEventListener("click",w(this,we,Wh).bind(this,n),{signal:t}),e.append(a)}return e.addEventListener("keydown",w(this,we,qh).bind(this),{signal:t}),e},Wh=function(e,t){t.stopPropagation(),r(this,sc).dispatch("switchannotationeditorparams",{source:this,type:r(this,Vr),value:e})},qh=function(e){Rt._keyboardManager.exec(this,e)},En=function(e){if(r(this,we,Bi)){this.hideDropdown();return}if(x(this,ec,e.detail===0),r(this,un)||(x(this,un,new AbortController),window.addEventListener("pointerdown",w(this,we,vf).bind(this),{signal:r(this,_s).combinedSignal(r(this,un))})),r(this,qe)){r(this,qe).classList.remove("hidden");return}const t=x(this,qe,w(this,we,Vh).call(this));r(this,As).append(t)},vf=function(e){var t;(t=r(this,qe))!=null&&t.contains(e.target)||this.hideDropdown()},Bi=function(){return r(this,qe)&&!r(this,qe).classList.contains("hidden")},v(Rt,ic,null);let cd=Rt;var Wr,nc,Ei,ja,qr,It,ac,rc,Aa,ns,Vt,it,Xr,ki,ut,Yr,as,oc,ne,Xh,Xc,yf,wf,Nf,Yh,kn,cs,Ya,jf,Yc,So,Af,_f,Sf,Cf,Ef;const ge=class ge extends Le{constructor(t){super({...t,name:"highlightEditor"});v(this,ne);v(this,Wr,null);v(this,nc,0);v(this,Ei);v(this,ja,null);v(this,qr,null);v(this,It,null);v(this,ac,null);v(this,rc,0);v(this,Aa,null);v(this,ns,null);v(this,Vt,null);v(this,it,!1);v(this,Xr,null);v(this,ki);v(this,ut,null);v(this,Yr,"");v(this,as);v(this,oc,"");this.color=t.color||ge._defaultColor,x(this,as,t.thickness||ge._defaultThickness),x(this,ki,t.opacity||ge._defaultOpacity),x(this,Ei,t.boxes||null),x(this,oc,t.methodOfCreation||""),x(this,Yr,t.text||""),this._isDraggable=!1,t.highlightId>-1?(x(this,it,!0),w(this,ne,Xc).call(this,t),w(this,ne,kn).call(this)):r(this,Ei)&&(x(this,Wr,t.anchorNode),x(this,nc,t.anchorOffset),x(this,ac,t.focusNode),x(this,rc,t.focusOffset),w(this,ne,Xh).call(this),w(this,ne,kn).call(this),this.rotate(this.rotation))}static get _keyboardManager(){const t=ge.prototype;return de(this,"_keyboardManager",new pc([[["ArrowLeft","mac+ArrowLeft"],t._moveCaret,{args:[0]}],[["ArrowRight","mac+ArrowRight"],t._moveCaret,{args:[1]}],[["ArrowUp","mac+ArrowUp"],t._moveCaret,{args:[2]}],[["ArrowDown","mac+ArrowDown"],t._moveCaret,{args:[3]}]]))}get telemetryInitialData(){return{action:"added",type:r(this,it)?"free_highlight":"highlight",color:this._uiManager.highlightColorNames.get(this.color),thickness:r(this,as),methodOfCreation:r(this,oc)}}get telemetryFinalData(){return{type:"highlight",color:this._uiManager.highlightColorNames.get(this.color)}}static computeTelemetryFinalData(t){return{numberOfColors:t.get("color").size}}static initialize(t,s){var n;Le.initialize(t,s),ge._defaultColor||(ge._defaultColor=((n=s.highlightColors)==null?void 0:n.values().next().value)||"#fff066")}static updateDefaultParams(t,s){switch(t){case pe.HIGHLIGHT_DEFAULT_COLOR:ge._defaultColor=s;break;case pe.HIGHLIGHT_THICKNESS:ge._defaultThickness=s;break}}translateInPage(t,s){}get toolbarPosition(){return r(this,Xr)}updateParams(t,s){switch(t){case pe.HIGHLIGHT_COLOR:w(this,ne,yf).call(this,s);break;case pe.HIGHLIGHT_THICKNESS:w(this,ne,wf).call(this,s);break}}static get defaultPropertiesToUpdate(){return[[pe.HIGHLIGHT_DEFAULT_COLOR,ge._defaultColor],[pe.HIGHLIGHT_THICKNESS,ge._defaultThickness]]}get propertiesToUpdate(){return[[pe.HIGHLIGHT_COLOR,this.color||ge._defaultColor],[pe.HIGHLIGHT_THICKNESS,r(this,as)||ge._defaultThickness],[pe.HIGHLIGHT_FREE,r(this,it)]]}async addEditToolbar(){const t=await super.addEditToolbar();return t?(this._uiManager.highlightColors&&(x(this,qr,new cd({editor:this})),t.addColorPicker(r(this,qr))),t):null}disableEditing(){super.disableEditing(),this.div.classList.toggle("disabled",!0)}enableEditing(){super.enableEditing(),this.div.classList.toggle("disabled",!1)}fixAndSetPosition(){return super.fixAndSetPosition(w(this,ne,So).call(this))}getBaseTranslation(){return[0,0]}getRect(t,s){return super.getRect(t,s,w(this,ne,So).call(this))}onceAdded(t){this.annotationElementId||this.parent.addUndoableEditor(this),t&&this.div.focus()}remove(){w(this,ne,Yh).call(this),this._reportTelemetry({action:"deleted"}),super.remove()}rebuild(){this.parent&&(super.rebuild(),this.div!==null&&(w(this,ne,kn).call(this),this.isAttachedToDOM||this.parent.add(this)))}setParent(t){var n;let s=!1;this.parent&&!t?w(this,ne,Yh).call(this):t&&(w(this,ne,kn).call(this,t),s=!this.parent&&((n=this.div)==null?void 0:n.classList.contains("selectedEditor"))),super.setParent(t),this.show(this._isVisible),s&&this.select()}rotate(t){var a,o,l;const{drawLayer:s}=this.parent;let n;r(this,it)?(t=(t-this.rotation+360)%360,n=w(a=ge,cs,Ya).call(a,r(this,ns).box,t)):n=w(o=ge,cs,Ya).call(o,[this.x,this.y,this.width,this.height],t),s.updateProperties(r(this,Vt),{bbox:n,root:{"data-main-rotation":t}}),s.updateProperties(r(this,ut),{bbox:w(l=ge,cs,Ya).call(l,r(this,It).box,t),root:{"data-main-rotation":t}})}render(){if(this.div)return this.div;const t=super.render();r(this,Yr)&&(t.setAttribute("aria-label",r(this,Yr)),t.setAttribute("role","mark")),r(this,it)?t.classList.add("free"):this.div.addEventListener("keydown",w(this,ne,jf).bind(this),{signal:this._uiManager._signal});const s=x(this,Aa,document.createElement("div"));t.append(s),s.setAttribute("aria-hidden","true"),s.className="internal",s.style.clipPath=r(this,ja);const[n,a]=this.parentDimensions;return this.setDims(this.width*n,this.height*a),ad(this,r(this,Aa),["pointerover","pointerleave"]),this.enableEditing(),t}pointerover(){var t;this.isSelected||(t=this.parent)==null||t.drawLayer.updateProperties(r(this,ut),{rootClass:{hovered:!0}})}pointerleave(){var t;this.isSelected||(t=this.parent)==null||t.drawLayer.updateProperties(r(this,ut),{rootClass:{hovered:!1}})}_moveCaret(t){switch(this.parent.unselect(this),t){case 0:case 2:w(this,ne,Yc).call(this,!0);break;case 1:case 3:w(this,ne,Yc).call(this,!1);break}}select(){var t;super.select(),r(this,ut)&&((t=this.parent)==null||t.drawLayer.updateProperties(r(this,ut),{rootClass:{hovered:!1,selected:!0}}))}unselect(){var t;super.unselect(),r(this,ut)&&((t=this.parent)==null||t.drawLayer.updateProperties(r(this,ut),{rootClass:{selected:!1}}),r(this,it)||w(this,ne,Yc).call(this,!1))}get _mustFixPosition(){return!r(this,it)}show(t=this._isVisible){super.show(t),this.parent&&(this.parent.drawLayer.updateProperties(r(this,Vt),{rootClass:{hidden:!t}}),this.parent.drawLayer.updateProperties(r(this,ut),{rootClass:{hidden:!t}}))}static startHighlighting(t,s,{target:n,x:a,y:o}){const{x:l,y:d,width:h,height:u}=n.getBoundingClientRect(),p=new AbortController,m=t.combinedSignal(p),f=g=>{p.abort(),w(this,cs,Cf).call(this,t,g)};window.addEventListener("blur",f,{signal:m}),window.addEventListener("pointerup",f,{signal:m}),window.addEventListener("pointerdown",Qt,{capture:!0,passive:!1,signal:m}),window.addEventListener("contextmenu",Ts,{signal:m}),n.addEventListener("pointermove",w(this,cs,Sf).bind(this,t),{signal:m}),this._freeHighlight=new Gh({x:a,y:o},[l,d,h,u],t.scale,this._defaultThickness/2,s,.001),{id:this._freeHighlightId,clipPathId:this._freeHighlightClipId}=t.drawLayer.draw({bbox:[0,0,1,1],root:{viewBox:"0 0 1 1",fill:this._defaultColor,"fill-opacity":this._defaultOpacity},rootClass:{highlight:!0,free:!0},path:{d:this._freeHighlight.toSVGPath()}},!0,!0)}static async deserialize(t,s,n){var b,A,N,j;let a=null;if(t instanceof Jm){const{data:{quadPoints:E,rect:_,rotation:y,id:C,color:R,opacity:S,popupRef:k},parent:{page:{pageNumber:M}}}=t;a=t={annotationType:ae.HIGHLIGHT,color:Array.from(R),opacity:S,quadPoints:E,boxes:null,pageIndex:M-1,rect:_.slice(0),rotation:y,id:C,deleted:!1,popupRef:k}}else if(t instanceof _u){const{data:{inkLists:E,rect:_,rotation:y,id:C,color:R,borderStyle:{rawWidth:S},popupRef:k},parent:{page:{pageNumber:M}}}=t;a=t={annotationType:ae.HIGHLIGHT,color:Array.from(R),thickness:S,inkLists:E,boxes:null,pageIndex:M-1,rect:_.slice(0),rotation:y,id:C,deleted:!1,popupRef:k}}const{color:o,quadPoints:l,inkLists:d,opacity:h}=t,u=await super.deserialize(t,s,n);u.color=X.makeHexColor(...o),x(u,ki,h||1),d&&x(u,as,t.thickness),u.annotationElementId=t.id||null,u._initialData=a;const[p,m]=u.pageDimensions,[f,g]=u.pageTranslation;if(l){const E=x(u,Ei,[]);for(let _=0;_<l.length;_+=8)E.push({x:(l[_]-f)/p,y:1-(l[_+1]-g)/m,width:(l[_+2]-l[_])/p,height:(l[_+1]-l[_+5])/m});w(b=u,ne,Xh).call(b),w(A=u,ne,kn).call(A),u.rotate(u.rotation)}else if(d){x(u,it,!0);const E=d[0],_={x:E[0]-f,y:m-(E[1]-g)},y=new Gh(_,[0,0,p,m],1,r(u,as)/2,!0,.001);for(let S=0,k=E.length;S<k;S+=2)_.x=E[S]-f,_.y=m-(E[S+1]-g),y.add(_);const{id:C,clipPathId:R}=s.drawLayer.draw({bbox:[0,0,1,1],root:{viewBox:"0 0 1 1",fill:u.color,"fill-opacity":u._defaultOpacity},rootClass:{highlight:!0,free:!0},path:{d:y.toSVGPath()}},!0,!0);w(N=u,ne,Xc).call(N,{highlightOutlines:y.getOutlines(),highlightId:C,clipPathId:R}),w(j=u,ne,kn).call(j)}return u}serialize(t=!1){if(this.isEmpty()||t)return null;if(this.deleted)return this.serializeDeleted();const s=this.getRect(0,0),n=Le._colorManager.convert(this.color),a={annotationType:ae.HIGHLIGHT,color:n,opacity:r(this,ki),thickness:r(this,as),quadPoints:w(this,ne,Af).call(this),outlines:w(this,ne,_f).call(this,s),pageIndex:this.pageIndex,rect:s,rotation:w(this,ne,So).call(this),structTreeParentId:this._structTreeParentId};return this.annotationElementId&&!w(this,ne,Ef).call(this,a)?null:(a.id=this.annotationElementId,a)}renderAnnotationElement(t){return t.updateEdited({rect:this.getRect(0,0)}),null}static canCreateNewEmptyEditor(){return!1}};Wr=new WeakMap,nc=new WeakMap,Ei=new WeakMap,ja=new WeakMap,qr=new WeakMap,It=new WeakMap,ac=new WeakMap,rc=new WeakMap,Aa=new WeakMap,ns=new WeakMap,Vt=new WeakMap,it=new WeakMap,Xr=new WeakMap,ki=new WeakMap,ut=new WeakMap,Yr=new WeakMap,as=new WeakMap,oc=new WeakMap,ne=new WeakSet,Xh=function(){const t=new zh(r(this,Ei),.001);x(this,ns,t.getOutlines()),[this.x,this.y,this.width,this.height]=r(this,ns).box;const s=new zh(r(this,Ei),.0025,.001,this._uiManager.direction==="ltr");x(this,It,s.getOutlines());const{lastPoint:n}=r(this,It);x(this,Xr,[(n[0]-this.x)/this.width,(n[1]-this.y)/this.height])},Xc=function({highlightOutlines:t,highlightId:s,clipPathId:n}){var p,m;if(x(this,ns,t),x(this,It,t.getNewOutline(r(this,as)/2+1.5,.0025)),s>=0)x(this,Vt,s),x(this,ja,n),this.parent.drawLayer.finalizeDraw(s,{bbox:t.box,path:{d:t.toSVGPath()}}),x(this,ut,this.parent.drawLayer.drawOutline({rootClass:{highlightOutline:!0,free:!0},bbox:r(this,It).box,path:{d:r(this,It).toSVGPath()}},!0));else if(this.parent){const f=this.parent.viewport.rotation;this.parent.drawLayer.updateProperties(r(this,Vt),{bbox:w(p=ge,cs,Ya).call(p,r(this,ns).box,(f-this.rotation+360)%360),path:{d:t.toSVGPath()}}),this.parent.drawLayer.updateProperties(r(this,ut),{bbox:w(m=ge,cs,Ya).call(m,r(this,It).box,f),path:{d:r(this,It).toSVGPath()}})}const[o,l,d,h]=t.box;switch(this.rotation){case 0:this.x=o,this.y=l,this.width=d,this.height=h;break;case 90:{const[f,g]=this.parentDimensions;this.x=l,this.y=1-o,this.width=d*g/f,this.height=h*f/g;break}case 180:this.x=1-o,this.y=1-l,this.width=d,this.height=h;break;case 270:{const[f,g]=this.parentDimensions;this.x=1-l,this.y=o,this.width=d*g/f,this.height=h*f/g;break}}const{lastPoint:u}=r(this,It);x(this,Xr,[(u[0]-o)/d,(u[1]-l)/h])},yf=function(t){const s=(o,l)=>{var d,h;this.color=o,x(this,ki,l),(d=this.parent)==null||d.drawLayer.updateProperties(r(this,Vt),{root:{fill:o,"fill-opacity":l}}),(h=r(this,qr))==null||h.updateColor(o)},n=this.color,a=r(this,ki);this.addCommands({cmd:s.bind(this,t,ge._defaultOpacity),undo:s.bind(this,n,a),post:this._uiManager.updateUI.bind(this._uiManager,this),mustExec:!0,type:pe.HIGHLIGHT_COLOR,overwriteIfSameType:!0,keepUndo:!0}),this._reportTelemetry({action:"color_changed",color:this._uiManager.highlightColorNames.get(t)},!0)},wf=function(t){const s=r(this,as),n=a=>{x(this,as,a),w(this,ne,Nf).call(this,a)};this.addCommands({cmd:n.bind(this,t),undo:n.bind(this,s),post:this._uiManager.updateUI.bind(this._uiManager,this),mustExec:!0,type:pe.INK_THICKNESS,overwriteIfSameType:!0,keepUndo:!0}),this._reportTelemetry({action:"thickness_changed",thickness:t},!0)},Nf=function(t){if(!r(this,it))return;w(this,ne,Xc).call(this,{highlightOutlines:r(this,ns).getNewOutline(t/2)}),this.fixAndSetPosition();const[s,n]=this.parentDimensions;this.setDims(this.width*s,this.height*n)},Yh=function(){r(this,Vt)===null||!this.parent||(this.parent.drawLayer.remove(r(this,Vt)),x(this,Vt,null),this.parent.drawLayer.remove(r(this,ut)),x(this,ut,null))},kn=function(t=this.parent){r(this,Vt)===null&&({id:bt(this,Vt)._,clipPathId:bt(this,ja)._}=t.drawLayer.draw({bbox:r(this,ns).box,root:{viewBox:"0 0 1 1",fill:this.color,"fill-opacity":r(this,ki)},rootClass:{highlight:!0,free:r(this,it)},path:{d:r(this,ns).toSVGPath()}},!1,!0),x(this,ut,t.drawLayer.drawOutline({rootClass:{highlightOutline:!0,free:r(this,it)},bbox:r(this,It).box,path:{d:r(this,It).toSVGPath()}},r(this,it))),r(this,Aa)&&(r(this,Aa).style.clipPath=r(this,ja)))},cs=new WeakSet,Ya=function([t,s,n,a],o){switch(o){case 90:return[1-s-a,t,a,n];case 180:return[1-t-n,1-s-a,n,a];case 270:return[s,1-t-n,a,n]}return[t,s,n,a]},jf=function(t){ge._keyboardManager.exec(this,t)},Yc=function(t){if(!r(this,Wr))return;const s=window.getSelection();t?s.setPosition(r(this,Wr),r(this,nc)):s.setPosition(r(this,ac),r(this,rc))},So=function(){return r(this,it)?this.rotation:0},Af=function(){if(r(this,it))return null;const[t,s]=this.pageDimensions,[n,a]=this.pageTranslation,o=r(this,Ei),l=new Float32Array(o.length*8);let d=0;for(const{x:h,y:u,width:p,height:m}of o){const f=h*t+n,g=(1-u)*s+a;l[d]=l[d+4]=f,l[d+1]=l[d+3]=g,l[d+2]=l[d+6]=f+p*t,l[d+5]=l[d+7]=g-m*s,d+=8}return l},_f=function(t){return r(this,ns).serialize(t,w(this,ne,So).call(this))},Sf=function(t,s){this._freeHighlight.add(s)&&t.drawLayer.updateProperties(this._freeHighlightId,{path:{d:this._freeHighlight.toSVGPath()}})},Cf=function(t,s){this._freeHighlight.isEmpty()?t.drawLayer.remove(this._freeHighlightId):t.createAndAddNewEditor(s,!1,{highlightId:this._freeHighlightId,highlightOutlines:this._freeHighlight.getOutlines(),clipPathId:this._freeHighlightClipId,methodOfCreation:"main_toolbar"}),this._freeHighlightId=-1,this._freeHighlight=null,this._freeHighlightClipId=""},Ef=function(t){const{color:s}=this._initialData;return t.color.some((n,a)=>n!==s[a])},v(ge,cs),Z(ge,"_defaultColor",null),Z(ge,"_defaultOpacity",1),Z(ge,"_defaultThickness",12),Z(ge,"_type","highlight"),Z(ge,"_editorType",ae.HIGHLIGHT),Z(ge,"_freeHighlightId",-1),Z(ge,"_freeHighlight",null),Z(ge,"_freeHighlightClipId","");let dd=ge;var _a;class db{constructor(){v(this,_a,Object.create(null))}updateProperty(e,t){this[e]=t,this.updateSVGProperty(e,t)}updateProperties(e){if(e)for(const[t,s]of Object.entries(e))this.updateProperty(t,s)}updateSVGProperty(e,t){r(this,_a)[e]=t}toSVGProperties(){const e=r(this,_a);return x(this,_a,Object.create(null)),{root:e}}reset(){x(this,_a,Object.create(null))}updateAll(e=this){this.updateProperties(e)}clone(){Ae("Not implemented")}}_a=new WeakMap;var Wt,Kr,Ze,Sa,Ca,pn,mn,fn,Ea,me,Qh,Zh,Jh,Co,kf,Kc,Eo,Ka;const G=class G extends Le{constructor(t){super(t);v(this,me);v(this,Wt,null);v(this,Kr);Z(this,"_drawId",null);x(this,Kr,t.mustBeCommitted||!1),t.drawOutlines&&(w(this,me,Qh).call(this,t),w(this,me,Co).call(this))}static _mergeSVGProperties(t,s){const n=new Set(Object.keys(t));for(const[a,o]of Object.entries(s))n.has(a)?Object.assign(t[a],o):t[a]=o;return t}static getDefaultDrawingOptions(t){Ae("Not implemented")}static get typesMap(){Ae("Not implemented")}static get isDrawer(){return!0}static get supportMultipleDrawings(){return!1}static updateDefaultParams(t,s){const n=this.typesMap.get(t);n&&this._defaultDrawingOptions.updateProperty(n,s),this._currentParent&&(r(G,Ze).updateProperty(n,s),this._currentParent.drawLayer.updateProperties(this._currentDrawId,this._defaultDrawingOptions.toSVGProperties()))}updateParams(t,s){const n=this.constructor.typesMap.get(t);n&&this._updateProperty(t,n,s)}static get defaultPropertiesToUpdate(){const t=[],s=this._defaultDrawingOptions;for(const[n,a]of this.typesMap)t.push([n,s[a]]);return t}get propertiesToUpdate(){const t=[],{_drawingOptions:s}=this;for(const[n,a]of this.constructor.typesMap)t.push([n,s[a]]);return t}_updateProperty(t,s,n){const a=this._drawingOptions,o=a[s],l=d=>{var u;a.updateProperty(s,d);const h=r(this,Wt).updateProperty(s,d);h&&w(this,me,Eo).call(this,h),(u=this.parent)==null||u.drawLayer.updateProperties(this._drawId,a.toSVGProperties())};this.addCommands({cmd:l.bind(this,n),undo:l.bind(this,o),post:this._uiManager.updateUI.bind(this._uiManager,this),mustExec:!0,type:t,overwriteIfSameType:!0,keepUndo:!0})}_onResizing(){var t;(t=this.parent)==null||t.drawLayer.updateProperties(this._drawId,G._mergeSVGProperties(r(this,Wt).getPathResizingSVGProperties(w(this,me,Kc).call(this)),{bbox:w(this,me,Ka).call(this)}))}_onResized(){var t;(t=this.parent)==null||t.drawLayer.updateProperties(this._drawId,G._mergeSVGProperties(r(this,Wt).getPathResizedSVGProperties(w(this,me,Kc).call(this)),{bbox:w(this,me,Ka).call(this)}))}_onTranslating(t,s){var n;(n=this.parent)==null||n.drawLayer.updateProperties(this._drawId,{bbox:w(this,me,Ka).call(this,t,s)})}_onTranslated(){var t;(t=this.parent)==null||t.drawLayer.updateProperties(this._drawId,G._mergeSVGProperties(r(this,Wt).getPathTranslatedSVGProperties(w(this,me,Kc).call(this),this.parentDimensions),{bbox:w(this,me,Ka).call(this)}))}_onStartDragging(){var t;(t=this.parent)==null||t.drawLayer.updateProperties(this._drawId,{rootClass:{moving:!0}})}_onStopDragging(){var t;(t=this.parent)==null||t.drawLayer.updateProperties(this._drawId,{rootClass:{moving:!1}})}commit(){super.commit(),this.disableEditMode(),this.disableEditing()}disableEditing(){super.disableEditing(),this.div.classList.toggle("disabled",!0)}enableEditing(){super.enableEditing(),this.div.classList.toggle("disabled",!1)}getBaseTranslation(){return[0,0]}get isResizable(){return!0}onceAdded(t){this.annotationElementId||this.parent.addUndoableEditor(this),this._isDraggable=!0,r(this,Kr)&&(x(this,Kr,!1),this.commit(),this.parent.setSelected(this),t&&this.isOnScreen&&this.div.focus())}remove(){w(this,me,Jh).call(this),super.remove()}rebuild(){this.parent&&(super.rebuild(),this.div!==null&&(w(this,me,Co).call(this),w(this,me,Eo).call(this,r(this,Wt).box),this.isAttachedToDOM||this.parent.add(this)))}setParent(t){var n;let s=!1;this.parent&&!t?(this._uiManager.removeShouldRescale(this),w(this,me,Jh).call(this)):t&&(this._uiManager.addShouldRescale(this),w(this,me,Co).call(this,t),s=!this.parent&&((n=this.div)==null?void 0:n.classList.contains("selectedEditor"))),super.setParent(t),s&&this.select()}rotate(){this.parent&&this.parent.drawLayer.updateProperties(this._drawId,G._mergeSVGProperties({bbox:w(this,me,Ka).call(this)},r(this,Wt).updateRotation((this.parentRotation-this.rotation+360)%360)))}onScaleChanging(){this.parent&&w(this,me,Eo).call(this,r(this,Wt).updateParentDimensions(this.parentDimensions,this.parent.scale))}static onScaleChangingWhenDrawing(){}render(){if(this.div)return this.div;const t=super.render();t.classList.add("draw");const s=document.createElement("div");t.append(s),s.setAttribute("aria-hidden","true"),s.className="internal";const[n,a]=this.parentDimensions;return this.setDims(this.width*n,this.height*a),this._uiManager.addShouldRescale(this),this.disableEditing(),t}static createDrawerInstance(t,s,n,a,o){Ae("Not implemented")}static startDrawing(t,s,n,a){var A,N;const{target:o,offsetX:l,offsetY:d,pointerId:h,pointerType:u}=a;if(r(G,mn)&&r(G,mn)!==u)return;const{viewport:{rotation:p}}=t,{width:m,height:f}=o.getBoundingClientRect(),g=x(G,Sa,new AbortController),b=t.combinedSignal(g);if(r(G,pn)||x(G,pn,h),(A=r(G,mn))!=null||x(G,mn,u),window.addEventListener("pointerup",j=>{var E;r(G,pn)===j.pointerId?this._endDraw(j):(E=r(G,fn))==null||E.delete(j.pointerId)},{signal:b}),window.addEventListener("pointercancel",j=>{var E;r(G,pn)===j.pointerId?this._currentParent.endDrawingSession():(E=r(G,fn))==null||E.delete(j.pointerId)},{signal:b}),window.addEventListener("pointerdown",j=>{r(G,mn)===j.pointerType&&((r(G,fn)||x(G,fn,new Set)).add(j.pointerId),r(G,Ze).isCancellable()&&(r(G,Ze).removeLastElement(),r(G,Ze).isEmpty()?this._currentParent.endDrawingSession(!0):this._endDraw(null)))},{capture:!0,passive:!1,signal:b}),window.addEventListener("contextmenu",Ts,{signal:b}),o.addEventListener("pointermove",this._drawMove.bind(this),{signal:b}),o.addEventListener("touchmove",j=>{j.timeStamp===r(G,Ea)&&Qt(j)},{signal:b}),t.toggleDrawing(),(N=s._editorUndoBar)==null||N.hide(),r(G,Ze)){t.drawLayer.updateProperties(this._currentDrawId,r(G,Ze).startNew(l,d,m,f,p));return}s.updateUIForDefaultProperties(this),x(G,Ze,this.createDrawerInstance(l,d,m,f,p)),x(G,Ca,this.getDefaultDrawingOptions()),this._currentParent=t,{id:this._currentDrawId}=t.drawLayer.draw(this._mergeSVGProperties(r(G,Ca).toSVGProperties(),r(G,Ze).defaultSVGProperties),!0,!1)}static _drawMove(t){var o;if(x(G,Ea,-1),!r(G,Ze))return;const{offsetX:s,offsetY:n,pointerId:a}=t;if(r(G,pn)===a){if(((o=r(G,fn))==null?void 0:o.size)>=1){this._endDraw(t);return}this._currentParent.drawLayer.updateProperties(this._currentDrawId,r(G,Ze).add(s,n)),x(G,Ea,t.timeStamp),Qt(t)}}static _cleanup(t){t&&(this._currentDrawId=-1,this._currentParent=null,x(G,Ze,null),x(G,Ca,null),x(G,mn,null),x(G,Ea,NaN)),r(G,Sa)&&(r(G,Sa).abort(),x(G,Sa,null),x(G,pn,NaN),x(G,fn,null))}static _endDraw(t){const s=this._currentParent;if(s){if(s.toggleDrawing(!0),this._cleanup(!1),t&&s.drawLayer.updateProperties(this._currentDrawId,r(G,Ze).end(t.offsetX,t.offsetY)),this.supportMultipleDrawings){const n=r(G,Ze),a=this._currentDrawId,o=n.getLastElement();s.addCommands({cmd:()=>{s.drawLayer.updateProperties(a,n.setLastElement(o))},undo:()=>{s.drawLayer.updateProperties(a,n.removeLastElement())},mustExec:!1,type:pe.DRAW_STEP});return}this.endDrawing(!1)}}static endDrawing(t){const s=this._currentParent;if(!s)return null;if(s.toggleDrawing(!0),s.cleanUndoStack(pe.DRAW_STEP),!r(G,Ze).isEmpty()){const{pageDimensions:[n,a],scale:o}=s,l=s.createAndAddNewEditor({offsetX:0,offsetY:0},!1,{drawId:this._currentDrawId,drawOutlines:r(G,Ze).getOutlines(n*o,a*o,o,this._INNER_MARGIN),drawingOptions:r(G,Ca),mustBeCommitted:!t});return this._cleanup(!0),l}return s.drawLayer.remove(this._currentDrawId),this._cleanup(!0),null}createDrawingOptions(t){}static deserializeDraw(t,s,n,a,o,l){Ae("Not implemented")}static async deserialize(t,s,n){var p,m;const{rawDims:{pageWidth:a,pageHeight:o,pageX:l,pageY:d}}=s.viewport,h=this.deserializeDraw(l,d,a,o,this._INNER_MARGIN,t),u=await super.deserialize(t,s,n);return u.createDrawingOptions(t),w(p=u,me,Qh).call(p,{drawOutlines:h}),w(m=u,me,Co).call(m),u.onScaleChanging(),u.rotate(),u}serializeDraw(t){const[s,n]=this.pageTranslation,[a,o]=this.pageDimensions;return r(this,Wt).serialize([s,n,a,o],t)}renderAnnotationElement(t){return t.updateEdited({rect:this.getRect(0,0)}),null}static canCreateNewEmptyEditor(){return!1}};Wt=new WeakMap,Kr=new WeakMap,Ze=new WeakMap,Sa=new WeakMap,Ca=new WeakMap,pn=new WeakMap,mn=new WeakMap,fn=new WeakMap,Ea=new WeakMap,me=new WeakSet,Qh=function({drawOutlines:t,drawId:s,drawingOptions:n}){x(this,Wt,t),this._drawingOptions||(this._drawingOptions=n),s>=0?(this._drawId=s,this.parent.drawLayer.finalizeDraw(s,t.defaultProperties)):this._drawId=w(this,me,Zh).call(this,t,this.parent),w(this,me,Eo).call(this,t.box)},Zh=function(t,s){const{id:n}=s.drawLayer.draw(G._mergeSVGProperties(this._drawingOptions.toSVGProperties(),t.defaultSVGProperties),!1,!1);return n},Jh=function(){this._drawId===null||!this.parent||(this.parent.drawLayer.remove(this._drawId),this._drawId=null,this._drawingOptions.reset())},Co=function(t=this.parent){if(!(this._drawId!==null&&this.parent===t)){if(this._drawId!==null){this.parent.drawLayer.updateParent(this._drawId,t.drawLayer);return}this._drawingOptions.updateAll(),this._drawId=w(this,me,Zh).call(this,r(this,Wt),t)}},kf=function([t,s,n,a]){const{parentDimensions:[o,l],rotation:d}=this;switch(d){case 90:return[s,1-t,n*(l/o),a*(o/l)];case 180:return[1-t,1-s,n,a];case 270:return[1-s,t,n*(l/o),a*(o/l)];default:return[t,s,n,a]}},Kc=function(){const{x:t,y:s,width:n,height:a,parentDimensions:[o,l],rotation:d}=this;switch(d){case 90:return[1-s,t,n*(o/l),a*(l/o)];case 180:return[1-t,1-s,n,a];case 270:return[s,1-t,n*(o/l),a*(l/o)];default:return[t,s,n,a]}},Eo=function(t){if([this.x,this.y,this.width,this.height]=w(this,me,kf).call(this,t),this.div){this.fixAndSetPosition();const[s,n]=this.parentDimensions;this.setDims(this.width*s,this.height*n)}this._onResized()},Ka=function(){const{x:t,y:s,width:n,height:a,rotation:o,parentRotation:l,parentDimensions:[d,h]}=this;switch((o*4+l)/90){case 1:return[1-s-a,t,a,n];case 2:return[1-t-n,1-s-a,n,a];case 3:return[s,1-t-n,a,n];case 4:return[t,s-n*(d/h),a*(h/d),n*(d/h)];case 5:return[1-s,t,n*(d/h),a*(h/d)];case 6:return[1-t-a*(h/d),1-s,a*(h/d),n*(d/h)];case 7:return[s-n*(d/h),1-t-a*(h/d),n*(d/h),a*(h/d)];case 8:return[t-n,s-a,n,a];case 9:return[1-s,t-n,a,n];case 10:return[1-t,1-s,n,a];case 11:return[s-a,1-t,a,n];case 12:return[t-a*(h/d),s,a*(h/d),n*(d/h)];case 13:return[1-s-n*(d/h),t-a*(h/d),n*(d/h),a*(h/d)];case 14:return[1-t,1-s-n*(d/h),a*(h/d),n*(d/h)];case 15:return[s,1-t,n*(d/h),a*(h/d)];default:return[t,s,n,a]}},Z(G,"_currentDrawId",-1),Z(G,"_currentParent",null),v(G,Ze,null),v(G,Sa,null),v(G,Ca,null),v(G,pn,NaN),v(G,mn,null),v(G,fn,null),v(G,Ea,NaN),Z(G,"_INNER_MARGIN",3);let Kh=G;var Ys,Je,et,ka,Qr,wt,nt,rs,Ta,Ra,Pa,Zr,Qc;class hb{constructor(e,t,s,n,a,o){v(this,Zr);v(this,Ys,new Float64Array(6));v(this,Je);v(this,et);v(this,ka);v(this,Qr);v(this,wt);v(this,nt,"");v(this,rs,0);v(this,Ta,new hd);v(this,Ra);v(this,Pa);x(this,Ra,s),x(this,Pa,n),x(this,ka,a),x(this,Qr,o),[e,t]=w(this,Zr,Qc).call(this,e,t);const l=x(this,Je,[NaN,NaN,NaN,NaN,e,t]);x(this,wt,[e,t]),x(this,et,[{line:l,points:r(this,wt)}]),r(this,Ys).set(l,0)}updateProperty(e,t){e==="stroke-width"&&x(this,Qr,t)}isEmpty(){return!r(this,et)||r(this,et).length===0}isCancellable(){return r(this,wt).length<=10}add(e,t){[e,t]=w(this,Zr,Qc).call(this,e,t);const[s,n,a,o]=r(this,Ys).subarray(2,6),l=e-a,d=t-o;return Math.hypot(r(this,Ra)*l,r(this,Pa)*d)<=2?null:(r(this,wt).push(e,t),isNaN(s)?(r(this,Ys).set([a,o,e,t],2),r(this,Je).push(NaN,NaN,NaN,NaN,e,t),{path:{d:this.toSVGPath()}}):(isNaN(r(this,Ys)[0])&&r(this,Je).splice(6,6),r(this,Ys).set([s,n,a,o,e,t],0),r(this,Je).push(...U.createBezierPoints(s,n,a,o,e,t)),{path:{d:this.toSVGPath()}}))}end(e,t){const s=this.add(e,t);return s||(r(this,wt).length===2?{path:{d:this.toSVGPath()}}:null)}startNew(e,t,s,n,a){x(this,Ra,s),x(this,Pa,n),x(this,ka,a),[e,t]=w(this,Zr,Qc).call(this,e,t);const o=x(this,Je,[NaN,NaN,NaN,NaN,e,t]);x(this,wt,[e,t]);const l=r(this,et).at(-1);return l&&(l.line=new Float32Array(l.line),l.points=new Float32Array(l.points)),r(this,et).push({line:o,points:r(this,wt)}),r(this,Ys).set(o,0),x(this,rs,0),this.toSVGPath(),null}getLastElement(){return r(this,et).at(-1)}setLastElement(e){return r(this,et)?(r(this,et).push(e),x(this,Je,e.line),x(this,wt,e.points),x(this,rs,0),{path:{d:this.toSVGPath()}}):r(this,Ta).setLastElement(e)}removeLastElement(){if(!r(this,et))return r(this,Ta).removeLastElement();r(this,et).pop(),x(this,nt,"");for(let e=0,t=r(this,et).length;e<t;e++){const{line:s,points:n}=r(this,et)[e];x(this,Je,s),x(this,wt,n),x(this,rs,0),this.toSVGPath()}return{path:{d:r(this,nt)}}}toSVGPath(){const e=U.svgRound(r(this,Je)[4]),t=U.svgRound(r(this,Je)[5]);if(r(this,wt).length===2)return x(this,nt,`${r(this,nt)} M ${e} ${t} Z`),r(this,nt);if(r(this,wt).length<=6){const n=r(this,nt).lastIndexOf("M");x(this,nt,`${r(this,nt).slice(0,n)} M ${e} ${t}`),x(this,rs,6)}if(r(this,wt).length===4){const n=U.svgRound(r(this,Je)[10]),a=U.svgRound(r(this,Je)[11]);return x(this,nt,`${r(this,nt)} L ${n} ${a}`),x(this,rs,12),r(this,nt)}const s=[];r(this,rs)===0&&(s.push(`M ${e} ${t}`),x(this,rs,6));for(let n=r(this,rs),a=r(this,Je).length;n<a;n+=6){const[o,l,d,h,u,p]=r(this,Je).slice(n,n+6).map(U.svgRound);s.push(`C${o} ${l} ${d} ${h} ${u} ${p}`)}return x(this,nt,r(this,nt)+s.join(" ")),x(this,rs,r(this,Je).length),r(this,nt)}getOutlines(e,t,s,n){const a=r(this,et).at(-1);return a.line=new Float32Array(a.line),a.points=new Float32Array(a.points),r(this,Ta).build(r(this,et),e,t,s,r(this,ka),r(this,Qr),n),x(this,Ys,null),x(this,Je,null),x(this,et,null),x(this,nt,null),r(this,Ta)}get defaultSVGProperties(){return{root:{viewBox:"0 0 10000 10000"},rootClass:{draw:!0},bbox:[0,0,1,1]}}}Ys=new WeakMap,Je=new WeakMap,et=new WeakMap,ka=new WeakMap,Qr=new WeakMap,wt=new WeakMap,nt=new WeakMap,rs=new WeakMap,Ta=new WeakMap,Ra=new WeakMap,Pa=new WeakMap,Zr=new WeakSet,Qc=function(e,t){return U._normalizePoint(e,t,r(this,Ra),r(this,Pa),r(this,ka))};var Nt,lc,cc,qt,Ks,Qs,Jr,eo,to,rt,ri,Tf,Rf,Pf;const Ru=class Ru extends U{constructor(){super(...arguments);v(this,rt);v(this,Nt);v(this,lc,0);v(this,cc);v(this,qt);v(this,Ks);v(this,Qs);v(this,Jr);v(this,eo);v(this,to)}build(t,s,n,a,o,l,d){x(this,Ks,s),x(this,Qs,n),x(this,Jr,a),x(this,eo,o),x(this,to,l),x(this,cc,d!=null?d:0),x(this,qt,t),w(this,rt,Rf).call(this)}setLastElement(t){return r(this,qt).push(t),{path:{d:this.toSVGPath()}}}removeLastElement(){return r(this,qt).pop(),{path:{d:this.toSVGPath()}}}toSVGPath(){const t=[];for(const{line:s}of r(this,qt)){if(t.push(`M${U.svgRound(s[4])} ${U.svgRound(s[5])}`),s.length===6){t.push("Z");continue}if(s.length===12){t.push(`L${U.svgRound(s[10])} ${U.svgRound(s[11])}`);continue}for(let n=6,a=s.length;n<a;n+=6){const[o,l,d,h,u,p]=s.subarray(n,n+6).map(U.svgRound);t.push(`C${o} ${l} ${d} ${h} ${u} ${p}`)}}return t.join("")}serialize([t,s,n,a],o){const l=[],d=[],[h,u,p,m]=w(this,rt,Tf).call(this);let f,g,b,A,N,j,E,_,y;switch(r(this,eo)){case 0:y=U._rescale,f=t,g=s+a,b=n,A=-a,N=t+h*n,j=s+(1-u-m)*a,E=t+(h+p)*n,_=s+(1-u)*a;break;case 90:y=U._rescaleAndSwap,f=t,g=s,b=n,A=a,N=t+u*n,j=s+h*a,E=t+(u+m)*n,_=s+(h+p)*a;break;case 180:y=U._rescale,f=t+n,g=s,b=-n,A=a,N=t+(1-h-p)*n,j=s+u*a,E=t+(1-h)*n,_=s+(u+m)*a;break;case 270:y=U._rescaleAndSwap,f=t+n,g=s+a,b=-n,A=-a,N=t+(1-u-m)*n,j=s+(1-h-p)*a,E=t+(1-u)*n,_=s+(1-h)*a;break}for(const{line:C,points:R}of r(this,qt))l.push(y(C,f,g,b,A,o?new Array(C.length):null)),d.push(y(R,f,g,b,A,o?new Array(R.length):null));return{lines:l,points:d,rect:[N,j,E,_]}}static deserialize(t,s,n,a,o,{paths:{lines:l,points:d},rotation:h,thickness:u}){const p=[];let m,f,g,b,A;switch(h){case 0:A=U._rescale,m=-t/n,f=s/a+1,g=1/n,b=-1/a;break;case 90:A=U._rescaleAndSwap,m=-s/a,f=-t/n,g=1/a,b=1/n;break;case 180:A=U._rescale,m=t/n+1,f=-s/a,g=-1/n,b=1/a;break;case 270:A=U._rescaleAndSwap,m=s/a+1,f=t/n+1,g=-1/a,b=-1/n;break}if(!l){l=[];for(const j of d){const E=j.length;if(E===2){l.push(new Float32Array([NaN,NaN,NaN,NaN,j[0],j[1]]));continue}if(E===4){l.push(new Float32Array([NaN,NaN,NaN,NaN,j[0],j[1],NaN,NaN,NaN,NaN,j[2],j[3]]));continue}const _=new Float32Array(3*(E-2));l.push(_);let[y,C,R,S]=j.subarray(0,4);_.set([NaN,NaN,NaN,NaN,y,C],0);for(let k=4;k<E;k+=2){const M=j[k],L=j[k+1];_.set(U.createBezierPoints(y,C,R,S,M,L),(k-2)*3),[y,C,R,S]=[R,S,M,L]}}}for(let j=0,E=l.length;j<E;j++)p.push({line:A(l[j].map(_=>_!=null?_:NaN),m,f,g,b),points:A(d[j].map(_=>_!=null?_:NaN),m,f,g,b)});const N=new Ru;return N.build(p,n,a,1,h,u,o),N}get box(){return r(this,Nt)}updateProperty(t,s){return t==="stroke-width"?w(this,rt,Pf).call(this,s):null}updateParentDimensions([t,s],n){const[a,o]=w(this,rt,ri).call(this);x(this,Ks,t),x(this,Qs,s),x(this,Jr,n);const[l,d]=w(this,rt,ri).call(this),h=l-a,u=d-o,p=r(this,Nt);return p[0]-=h,p[1]-=u,p[2]+=2*h,p[3]+=2*u,p}updateRotation(t){return x(this,lc,t),{path:{transform:this.rotationTransform}}}get viewBox(){return r(this,Nt).map(U.svgRound).join(" ")}get defaultProperties(){const[t,s]=r(this,Nt);return{root:{viewBox:this.viewBox},path:{"transform-origin":`${U.svgRound(t)} ${U.svgRound(s)}`}}}get rotationTransform(){const[,,t,s]=r(this,Nt);let n=0,a=0,o=0,l=0,d=0,h=0;switch(r(this,lc)){case 90:a=s/t,o=-t/s,d=t;break;case 180:n=-1,l=-1,d=t,h=s;break;case 270:a=-s/t,o=t/s,h=s;break;default:return""}return`matrix(${n} ${a} ${o} ${l} ${U.svgRound(d)} ${U.svgRound(h)})`}getPathResizingSVGProperties([t,s,n,a]){const[o,l]=w(this,rt,ri).call(this),[d,h,u,p]=r(this,Nt);if(Math.abs(u-o)<=U.PRECISION||Math.abs(p-l)<=U.PRECISION){const A=t+n/2-(d+u/2),N=s+a/2-(h+p/2);return{path:{"transform-origin":`${U.svgRound(t)} ${U.svgRound(s)}`,transform:`${this.rotationTransform} translate(${A} ${N})`}}}const m=(n-2*o)/(u-2*o),f=(a-2*l)/(p-2*l),g=u/n,b=p/a;return{path:{"transform-origin":`${U.svgRound(d)} ${U.svgRound(h)}`,transform:`${this.rotationTransform} scale(${g} ${b}) translate(${U.svgRound(o)} ${U.svgRound(l)}) scale(${m} ${f}) translate(${U.svgRound(-o)} ${U.svgRound(-l)})`}}}getPathResizedSVGProperties([t,s,n,a]){const[o,l]=w(this,rt,ri).call(this),d=r(this,Nt),[h,u,p,m]=d;if(d[0]=t,d[1]=s,d[2]=n,d[3]=a,Math.abs(p-o)<=U.PRECISION||Math.abs(m-l)<=U.PRECISION){const N=t+n/2-(h+p/2),j=s+a/2-(u+m/2);for(const{line:E,points:_}of r(this,qt))U._translate(E,N,j,E),U._translate(_,N,j,_);return{root:{viewBox:this.viewBox},path:{"transform-origin":`${U.svgRound(t)} ${U.svgRound(s)}`,transform:this.rotationTransform||null,d:this.toSVGPath()}}}const f=(n-2*o)/(p-2*o),g=(a-2*l)/(m-2*l),b=-f*(h+o)+t+o,A=-g*(u+l)+s+l;if(f!==1||g!==1||b!==0||A!==0)for(const{line:N,points:j}of r(this,qt))U._rescale(N,b,A,f,g,N),U._rescale(j,b,A,f,g,j);return{root:{viewBox:this.viewBox},path:{"transform-origin":`${U.svgRound(t)} ${U.svgRound(s)}`,transform:this.rotationTransform||null,d:this.toSVGPath()}}}getPathTranslatedSVGProperties([t,s],n){const[a,o]=n,l=r(this,Nt),d=t-l[0],h=s-l[1];if(r(this,Ks)===a&&r(this,Qs)===o)for(const{line:u,points:p}of r(this,qt))U._translate(u,d,h,u),U._translate(p,d,h,p);else{const u=r(this,Ks)/a,p=r(this,Qs)/o;x(this,Ks,a),x(this,Qs,o);for(const{line:m,points:f}of r(this,qt))U._rescale(m,d,h,u,p,m),U._rescale(f,d,h,u,p,f);l[2]*=u,l[3]*=p}return l[0]=t,l[1]=s,{root:{viewBox:this.viewBox},path:{d:this.toSVGPath(),"transform-origin":`${U.svgRound(t)} ${U.svgRound(s)}`}}}get defaultSVGProperties(){const t=r(this,Nt);return{root:{viewBox:this.viewBox},rootClass:{draw:!0},path:{d:this.toSVGPath(),"transform-origin":`${U.svgRound(t[0])} ${U.svgRound(t[1])}`,transform:this.rotationTransform||null},bbox:t}}};Nt=new WeakMap,lc=new WeakMap,cc=new WeakMap,qt=new WeakMap,Ks=new WeakMap,Qs=new WeakMap,Jr=new WeakMap,eo=new WeakMap,to=new WeakMap,rt=new WeakSet,ri=function(t=r(this,to)){const s=r(this,cc)+t/2*r(this,Jr);return r(this,eo)%180===0?[s/r(this,Ks),s/r(this,Qs)]:[s/r(this,Qs),s/r(this,Ks)]},Tf=function(){const[t,s,n,a]=r(this,Nt),[o,l]=w(this,rt,ri).call(this,0);return[t+o,s+l,n-2*o,a-2*l]},Rf=function(){const t=x(this,Nt,new Float32Array([1/0,1/0,-1/0,-1/0]));for(const{line:a}of r(this,qt)){if(a.length<=12){for(let d=4,h=a.length;d<h;d+=6){const[u,p]=a.subarray(d,d+2);t[0]=Math.min(t[0],u),t[1]=Math.min(t[1],p),t[2]=Math.max(t[2],u),t[3]=Math.max(t[3],p)}continue}let o=a[4],l=a[5];for(let d=6,h=a.length;d<h;d+=6){const[u,p,m,f,g,b]=a.subarray(d,d+6);X.bezierBoundingBox(o,l,u,p,m,f,g,b,t),o=g,l=b}}const[s,n]=w(this,rt,ri).call(this);t[0]=Math.min(1,Math.max(0,t[0]-s)),t[1]=Math.min(1,Math.max(0,t[1]-n)),t[2]=Math.min(1,Math.max(0,t[2]+s)),t[3]=Math.min(1,Math.max(0,t[3]+n)),t[2]-=t[0],t[3]-=t[1]},Pf=function(t){const[s,n]=w(this,rt,ri).call(this);x(this,to,t);const[a,o]=w(this,rt,ri).call(this),[l,d]=[a-s,o-n],h=r(this,Nt);return h[0]-=l,h[1]-=d,h[2]+=2*l,h[3]+=2*d,h};let hd=Ru;var so;const Pu=class Pu extends db{constructor(t){super();v(this,so);x(this,so,t),super.updateProperties({fill:"none",stroke:Le._defaultLineColor,"stroke-opacity":1,"stroke-width":1,"stroke-linecap":"round","stroke-linejoin":"round","stroke-miterlimit":10})}updateSVGProperty(t,s){t==="stroke-width"&&(s!=null||(s=this["stroke-width"]),s*=r(this,so).realScale),super.updateSVGProperty(t,s)}clone(){const t=new Pu(r(this,so));return t.updateAll(this),t}};so=new WeakMap;let eu=Pu;var kd,Mf;const Za=class Za extends Kh{constructor(t){super({...t,name:"inkEditor"});v(this,kd);this._willKeepAspectRatio=!0}static initialize(t,s){Le.initialize(t,s),this._defaultDrawingOptions=new eu(s.viewParameters)}static getDefaultDrawingOptions(t){const s=this._defaultDrawingOptions.clone();return s.updateProperties(t),s}static get supportMultipleDrawings(){return!0}static get typesMap(){return de(this,"typesMap",new Map([[pe.INK_THICKNESS,"stroke-width"],[pe.INK_COLOR,"stroke"],[pe.INK_OPACITY,"stroke-opacity"]]))}static createDrawerInstance(t,s,n,a,o){return new hb(t,s,n,a,o,this._defaultDrawingOptions["stroke-width"])}static deserializeDraw(t,s,n,a,o,l){return hd.deserialize(t,s,n,a,o,l)}static async deserialize(t,s,n){let a=null;if(t instanceof _u){const{data:{inkLists:l,rect:d,rotation:h,id:u,color:p,opacity:m,borderStyle:{rawWidth:f},popupRef:g},parent:{page:{pageNumber:b}}}=t;a=t={annotationType:ae.INK,color:Array.from(p),thickness:f,opacity:m,paths:{points:l},boxes:null,pageIndex:b-1,rect:d.slice(0),rotation:h,id:u,deleted:!1,popupRef:g}}const o=await super.deserialize(t,s,n);return o.annotationElementId=t.id||null,o._initialData=a,o}onScaleChanging(){if(!this.parent)return;super.onScaleChanging();const{_drawId:t,_drawingOptions:s,parent:n}=this;s.updateSVGProperty("stroke-width"),n.drawLayer.updateProperties(t,s.toSVGProperties())}static onScaleChangingWhenDrawing(){const t=this._currentParent;t&&(super.onScaleChangingWhenDrawing(),this._defaultDrawingOptions.updateSVGProperty("stroke-width"),t.drawLayer.updateProperties(this._currentDrawId,this._defaultDrawingOptions.toSVGProperties()))}createDrawingOptions({color:t,thickness:s,opacity:n}){this._drawingOptions=Za.getDefaultDrawingOptions({stroke:X.makeHexColor(...t),"stroke-width":s,"stroke-opacity":n})}serialize(t=!1){if(this.isEmpty())return null;if(this.deleted)return this.serializeDeleted();const{lines:s,points:n,rect:a}=this.serializeDraw(t),{_drawingOptions:{stroke:o,"stroke-opacity":l,"stroke-width":d}}=this,h={annotationType:ae.INK,color:Le._colorManager.convert(o),opacity:l,thickness:d,paths:{lines:s,points:n},pageIndex:this.pageIndex,rect:a,rotation:this.rotation,structTreeParentId:this._structTreeParentId};return t?h:this.annotationElementId&&!w(this,kd,Mf).call(this,h)?null:(h.id=this.annotationElementId,h)}renderAnnotationElement(t){const{points:s,rect:n}=this.serializeDraw(!1);return t.updateEdited({rect:n,thickness:this._drawingOptions["stroke-width"],points:s}),null}};kd=new WeakSet,Mf=function(t){const{color:s,thickness:n,opacity:a,pageIndex:o}=this._initialData;return this._hasBeenMoved||this._hasBeenResized||t.color.some((l,d)=>l!==s[d])||t.thickness!==n||t.opacity!==a||t.pageIndex!==o},Z(Za,"_type","ink"),Z(Za,"_editorType",ae.INK),Z(Za,"_defaultDrawingOptions",null);let tu=Za;var Ie,at,gn,Ti,xn,io,Zs,Js,Xt,no,fe,ko,To,Zc,iu,Jc,nu,ed,If;const Mo=class Mo extends Le{constructor(t){super({...t,name:"stampEditor"});v(this,fe);v(this,Ie,null);v(this,at,null);v(this,gn,null);v(this,Ti,null);v(this,xn,null);v(this,io,"");v(this,Zs,null);v(this,Js,null);v(this,Xt,!1);v(this,no,!1);x(this,Ti,t.bitmapUrl),x(this,xn,t.bitmapFile)}static initialize(t,s){Le.initialize(t,s)}static get supportedTypes(){return de(this,"supportedTypes",["apng","avif","bmp","gif","jpeg","png","svg+xml","webp","x-icon"].map(s=>`image/${s}`))}static get supportedTypesStr(){return de(this,"supportedTypesStr",this.supportedTypes.join(","))}static isHandlingMimeForPasting(t){return this.supportedTypes.includes(t)}static paste(t,s){s.pasteEditor(ae.STAMP,{bitmapFile:t.getAsFile()})}altTextFinish(){this._uiManager.useNewAltTextFlow&&(this.div.hidden=!1),super.altTextFinish()}get telemetryFinalData(){var t;return{type:"stamp",hasAltText:!!((t=this.altTextData)!=null&&t.altText)}}static computeTelemetryFinalData(t){var n,a;const s=t.get("hasAltText");return{hasAltText:(n=s.get(!0))!=null?n:0,hasNoAltText:(a=s.get(!1))!=null?a:0}}async mlGuessAltText(t=null,s=!0){if(this.hasAltTextData())return null;const{mlManager:n}=this._uiManager;if(!n)throw new Error("No ML.");if(!await n.isEnabledFor("altText"))throw new Error("ML isn't enabled for alt text.");const{data:a,width:o,height:l}=t||this.copyCanvas(null,null,!0).imageData,d=await n.guess({name:"altText",request:{data:a,width:o,height:l,channels:a.length/(o*l)}});if(!d)throw new Error("No response from the AI service.");if(d.error)throw new Error("Error from the AI service.");if(d.cancel)return null;if(!d.output)throw new Error("No valid response from the AI service.");const h=d.output;return await this.setGuessedAltText(h),s&&!this.hasAltTextData()&&(this.altTextData={alt:h,decorative:!1}),h}remove(){var t;r(this,at)&&(x(this,Ie,null),this._uiManager.imageManager.deleteId(r(this,at)),(t=r(this,Zs))==null||t.remove(),x(this,Zs,null),r(this,Js)&&(clearTimeout(r(this,Js)),x(this,Js,null))),super.remove()}rebuild(){if(!this.parent){r(this,at)&&w(this,fe,Zc).call(this);return}super.rebuild(),this.div!==null&&(r(this,at)&&r(this,Zs)===null&&w(this,fe,Zc).call(this),this.isAttachedToDOM||this.parent.add(this))}onceAdded(t){this._isDraggable=!0,t&&this.div.focus()}isEmpty(){return!(r(this,gn)||r(this,Ie)||r(this,Ti)||r(this,xn)||r(this,at))}get isResizable(){return!0}render(){if(this.div)return this.div;let t,s;if(this.width&&(t=this.x,s=this.y),super.render(),this.div.hidden=!0,this.div.setAttribute("role","figure"),this.addAltTextButton(),r(this,Ie)?w(this,fe,iu).call(this):w(this,fe,Zc).call(this),this.width&&!this.annotationElementId){const[n,a]=this.parentDimensions;this.setAt(t*n,s*a,this.width*n,this.height*a)}return this._uiManager.addShouldRescale(this),this.div}_onResized(){this.onScaleChanging()}onScaleChanging(){if(!this.parent)return;r(this,Js)!==null&&clearTimeout(r(this,Js)),x(this,Js,setTimeout(()=>{x(this,Js,null),w(this,fe,nu).call(this)},200))}copyCanvas(t,s,n=!1){var f;t||(t=224);const{width:a,height:o}=r(this,Ie),l=new eh;let d=r(this,Ie),h=a,u=o,p=null;if(s){if(a>s||o>s){const S=Math.min(s/a,s/o);h=Math.floor(a*S),u=Math.floor(o*S)}p=document.createElement("canvas");const g=p.width=Math.ceil(h*l.sx),b=p.height=Math.ceil(u*l.sy);r(this,Xt)||(d=w(this,fe,Jc).call(this,g,b));const A=p.getContext("2d");A.filter=this._uiManager.hcmFilter;let N="white",j="#cfcfd8";this._uiManager.hcmFilter!=="none"?j="black":(f=window.matchMedia)!=null&&f.call(window,"(prefers-color-scheme: dark)").matches&&(N="#8f8f9d",j="#42414d");const E=15,_=E*l.sx,y=E*l.sy,C=new OffscreenCanvas(_*2,y*2),R=C.getContext("2d");R.fillStyle=N,R.fillRect(0,0,_*2,y*2),R.fillStyle=j,R.fillRect(0,0,_,y),R.fillRect(_,y,_,y),A.fillStyle=A.createPattern(C,"repeat"),A.fillRect(0,0,g,b),A.drawImage(d,0,0,d.width,d.height,0,0,g,b)}let m=null;if(n){let g,b;if(l.symmetric&&d.width<t&&d.height<t)g=d.width,b=d.height;else if(d=r(this,Ie),a>t||o>t){const j=Math.min(t/a,t/o);g=Math.floor(a*j),b=Math.floor(o*j),r(this,Xt)||(d=w(this,fe,Jc).call(this,g,b))}const N=new OffscreenCanvas(g,b).getContext("2d",{willReadFrequently:!0});N.drawImage(d,0,0,d.width,d.height,0,0,g,b),m={width:g,height:b,data:N.getImageData(0,0,g,b).data}}return{canvas:p,width:h,height:u,imageData:m}}getImageForAltText(){return r(this,Zs)}static async deserialize(t,s,n){var b;let a=null;if(t instanceof ef){const{data:{rect:A,rotation:N,id:j,structParent:E,popupRef:_},container:y,parent:{page:{pageNumber:C}}}=t,R=y.querySelector("canvas"),S=n.imageManager.getFromCanvas(y.id,R);R.remove();const k=((b=await s._structTree.getAriaAttributes(`${xu}${j}`))==null?void 0:b.get("aria-label"))||"";a=t={annotationType:ae.STAMP,bitmapId:S.id,bitmap:S.bitmap,pageIndex:C-1,rect:A.slice(0),rotation:N,id:j,deleted:!1,accessibilityData:{decorative:!1,altText:k},isSvg:!1,structParent:E,popupRef:_}}const o=await super.deserialize(t,s,n),{rect:l,bitmap:d,bitmapUrl:h,bitmapId:u,isSvg:p,accessibilityData:m}=t;u&&n.imageManager.isValidId(u)?(x(o,at,u),d&&x(o,Ie,d)):x(o,Ti,h),x(o,Xt,p);const[f,g]=o.pageDimensions;return o.width=(l[2]-l[0])/f,o.height=(l[3]-l[1])/g,o.annotationElementId=t.id||null,m&&(o.altTextData=m),o._initialData=a,x(o,no,!!a),o}serialize(t=!1,s=null){var d;if(this.isEmpty())return null;if(this.deleted)return this.serializeDeleted();const n={annotationType:ae.STAMP,bitmapId:r(this,at),pageIndex:this.pageIndex,rect:this.getRect(0,0),rotation:this.rotation,isSvg:r(this,Xt),structTreeParentId:this._structTreeParentId};if(t)return n.bitmapUrl=w(this,fe,ed).call(this,!0),n.accessibilityData=this.serializeAltText(!0),n;const{decorative:a,altText:o}=this.serializeAltText(!1);if(!a&&o&&(n.accessibilityData={type:"Figure",alt:o}),this.annotationElementId){const h=w(this,fe,If).call(this,n);if(h.isSame)return null;h.isSameAltText?delete n.accessibilityData:n.accessibilityData.structParent=(d=this._initialData.structParent)!=null?d:-1}if(n.id=this.annotationElementId,s===null)return n;s.stamps||(s.stamps=new Map);const l=r(this,Xt)?(n.rect[2]-n.rect[0])*(n.rect[3]-n.rect[1]):null;if(!s.stamps.has(r(this,at)))s.stamps.set(r(this,at),{area:l,serialized:n}),n.bitmap=w(this,fe,ed).call(this,!1);else if(r(this,Xt)){const h=s.stamps.get(r(this,at));l>h.area&&(h.area=l,h.serialized.bitmap.close(),h.serialized.bitmap=w(this,fe,ed).call(this,!1))}return n}renderAnnotationElement(t){return t.updateEdited({rect:this.getRect(0,0)}),null}};Ie=new WeakMap,at=new WeakMap,gn=new WeakMap,Ti=new WeakMap,xn=new WeakMap,io=new WeakMap,Zs=new WeakMap,Js=new WeakMap,Xt=new WeakMap,no=new WeakMap,fe=new WeakSet,ko=function(t,s=!1){if(!t){this.remove();return}x(this,Ie,t.bitmap),s||(x(this,at,t.id),x(this,Xt,t.isSvg)),t.file&&x(this,io,t.file.name),w(this,fe,iu).call(this)},To=function(){if(x(this,gn,null),this._uiManager.enableWaiting(!1),!!r(this,Zs)){if(this._uiManager.useNewAltTextWhenAddingImage&&this._uiManager.useNewAltTextFlow&&r(this,Ie)){this._editToolbar.hide(),this._uiManager.editAltText(this,!0);return}if(!this._uiManager.useNewAltTextWhenAddingImage&&this._uiManager.useNewAltTextFlow&&r(this,Ie)){this._reportTelemetry({action:"pdfjs.image.image_added",data:{alt_text_modal:!1,alt_text_type:"empty"}});try{this.mlGuessAltText()}catch{}}this.div.focus()}},Zc=function(){if(r(this,at)){this._uiManager.enableWaiting(!0),this._uiManager.imageManager.getFromId(r(this,at)).then(n=>w(this,fe,ko).call(this,n,!0)).finally(()=>w(this,fe,To).call(this));return}if(r(this,Ti)){const n=r(this,Ti);x(this,Ti,null),this._uiManager.enableWaiting(!0),x(this,gn,this._uiManager.imageManager.getFromUrl(n).then(a=>w(this,fe,ko).call(this,a)).finally(()=>w(this,fe,To).call(this)));return}if(r(this,xn)){const n=r(this,xn);x(this,xn,null),this._uiManager.enableWaiting(!0),x(this,gn,this._uiManager.imageManager.getFromFile(n).then(a=>w(this,fe,ko).call(this,a)).finally(()=>w(this,fe,To).call(this)));return}const t=document.createElement("input");t.type="file",t.accept=Mo.supportedTypesStr;const s=this._uiManager._signal;x(this,gn,new Promise(n=>{t.addEventListener("change",async()=>{if(!t.files||t.files.length===0)this.remove();else{this._uiManager.enableWaiting(!0);const a=await this._uiManager.imageManager.getFromFile(t.files[0]);this._reportTelemetry({action:"pdfjs.image.image_selected",data:{alt_text_modal:this._uiManager.useNewAltTextFlow}}),w(this,fe,ko).call(this,a)}n()},{signal:s}),t.addEventListener("cancel",()=>{this.remove(),n()},{signal:s})}).finally(()=>w(this,fe,To).call(this))),t.click()},iu=function(){var p;const{div:t}=this;let{width:s,height:n}=r(this,Ie);const[a,o]=this.pageDimensions,l=.75;if(this.width)s=this.width*a,n=this.height*o;else if(s>l*a||n>l*o){const m=Math.min(l*a/s,l*o/n);s*=m,n*=m}const[d,h]=this.parentDimensions;this.setDims(s*d/a,n*h/o),this._uiManager.enableWaiting(!1);const u=x(this,Zs,document.createElement("canvas"));u.setAttribute("role","img"),this.addContainer(u),this.width=s/a,this.height=n/o,(p=this._initialOptions)!=null&&p.isCentered?this.center():this.fixAndSetPosition(),this._initialOptions=null,(!this._uiManager.useNewAltTextWhenAddingImage||!this._uiManager.useNewAltTextFlow||this.annotationElementId)&&(t.hidden=!1),w(this,fe,nu).call(this),r(this,no)||(this.parent.addUndoableEditor(this),x(this,no,!0)),this._reportTelemetry({action:"inserted_image"}),r(this,io)&&u.setAttribute("aria-label",r(this,io))},Jc=function(t,s){const{width:n,height:a}=r(this,Ie);let o=n,l=a,d=r(this,Ie);for(;o>2*t||l>2*s;){const h=o,u=l;o>2*t&&(o=o>=16384?Math.floor(o/2)-1:Math.ceil(o/2)),l>2*s&&(l=l>=16384?Math.floor(l/2)-1:Math.ceil(l/2));const p=new OffscreenCanvas(o,l);p.getContext("2d").drawImage(d,0,0,h,u,0,0,o,l),d=p.transferToImageBitmap()}return d},nu=function(){const[t,s]=this.parentDimensions,{width:n,height:a}=this,o=new eh,l=Math.ceil(n*t*o.sx),d=Math.ceil(a*s*o.sy),h=r(this,Zs);if(!h||h.width===l&&h.height===d)return;h.width=l,h.height=d;const u=r(this,Xt)?r(this,Ie):w(this,fe,Jc).call(this,l,d),p=h.getContext("2d");p.filter=this._uiManager.hcmFilter,p.drawImage(u,0,0,u.width,u.height,0,0,l,d)},ed=function(t){if(t){if(r(this,Xt)){const a=this._uiManager.imageManager.getSvgUrl(r(this,at));if(a)return a}const s=document.createElement("canvas");return{width:s.width,height:s.height}=r(this,Ie),s.getContext("2d").drawImage(r(this,Ie),0,0),s.toDataURL()}if(r(this,Xt)){const[s,n]=this.pageDimensions,a=Math.round(this.width*s*An.PDF_TO_CSS_UNITS),o=Math.round(this.height*n*An.PDF_TO_CSS_UNITS),l=new OffscreenCanvas(a,o);return l.getContext("2d").drawImage(r(this,Ie),0,0,r(this,Ie).width,r(this,Ie).height,0,0,a,o),l.transferToImageBitmap()}return structuredClone(r(this,Ie))},If=function(t){var l;const{pageIndex:s,accessibilityData:{altText:n}}=this._initialData,a=t.pageIndex===s,o=(((l=t.accessibilityData)==null?void 0:l.alt)||"")===n;return{isSame:!this._hasBeenMoved&&!this._hasBeenResized&&a&&o,isSameAltText:o}},Z(Mo,"_type","stamp"),Z(Mo,"_editorType",ae.STAMP);let su=Mo;var Ma,ao,ei,bn,Ri,os,vn,ro,Ia,Ss,Pi,pt,Mi,W,yn,Pe,Lf,Ds,ru,ou,td;const ms=class ms{constructor({uiManager:e,pageIndex:t,div:s,structTreeLayer:n,accessibilityManager:a,annotationLayer:o,drawLayer:l,textLayer:d,viewport:h,l10n:u}){v(this,Pe);v(this,Ma);v(this,ao,!1);v(this,ei,null);v(this,bn,null);v(this,Ri,null);v(this,os,new Map);v(this,vn,!1);v(this,ro,!1);v(this,Ia,!1);v(this,Ss,null);v(this,Pi,null);v(this,pt,null);v(this,Mi,null);v(this,W);const p=[...r(ms,yn).values()];if(!ms._initialized){ms._initialized=!0;for(const m of p)m.initialize(u,e)}e.registerEditorTypes(p),x(this,W,e),this.pageIndex=t,this.div=s,x(this,Ma,a),x(this,ei,o),this.viewport=h,x(this,pt,d),this.drawLayer=l,this._structTree=n,r(this,W).addLayer(this)}get isEmpty(){return r(this,os).size===0}get isInvisible(){return this.isEmpty&&r(this,W).getMode()===ae.NONE}updateToolbar(e){r(this,W).updateToolbar(e)}updateMode(e=r(this,W).getMode()){switch(w(this,Pe,td).call(this),e){case ae.NONE:this.disableTextSelection(),this.togglePointerEvents(!1),this.toggleAnnotationLayerPointerEvents(!0),this.disableClick();return;case ae.INK:this.disableTextSelection(),this.togglePointerEvents(!0),this.enableClick();break;case ae.HIGHLIGHT:this.enableTextSelection(),this.togglePointerEvents(!1),this.disableClick();break;default:this.disableTextSelection(),this.togglePointerEvents(!0),this.enableClick()}this.toggleAnnotationLayerPointerEvents(!1);const{classList:t}=this.div;for(const s of r(ms,yn).values())t.toggle(`${s._type}Editing`,e===s._editorType);this.div.hidden=!1}hasTextLayer(e){var t;return e===((t=r(this,pt))==null?void 0:t.div)}setEditingState(e){r(this,W).setEditingState(e)}addCommands(e){r(this,W).addCommands(e)}cleanUndoStack(e){r(this,W).cleanUndoStack(e)}toggleDrawing(e=!1){this.div.classList.toggle("drawing",!e)}togglePointerEvents(e=!1){this.div.classList.toggle("disabled",!e)}toggleAnnotationLayerPointerEvents(e=!1){var t;(t=r(this,ei))==null||t.div.classList.toggle("disabled",!e)}async enable(){x(this,Ia,!0),this.div.tabIndex=0,this.togglePointerEvents(!0);const e=new Set;for(const s of r(this,os).values())s.enableEditing(),s.show(!0),s.annotationElementId&&(r(this,W).removeChangedExistingAnnotation(s),e.add(s.annotationElementId));if(!r(this,ei)){x(this,Ia,!1);return}const t=r(this,ei).getEditableAnnotations();for(const s of t){if(s.hide(),r(this,W).isDeletedAnnotationElement(s.data.id)||e.has(s.data.id))continue;const n=await this.deserialize(s);n&&(this.addOrRebuild(n),n.enableEditing())}x(this,Ia,!1)}disable(){var n;x(this,ro,!0),this.div.tabIndex=-1,this.togglePointerEvents(!1);const e=new Map,t=new Map;for(const a of r(this,os).values())if(a.disableEditing(),!!a.annotationElementId){if(a.serialize()!==null){e.set(a.annotationElementId,a);continue}else t.set(a.annotationElementId,a);(n=this.getEditableAnnotation(a.annotationElementId))==null||n.show(),a.remove()}if(r(this,ei)){const a=r(this,ei).getEditableAnnotations();for(const o of a){const{id:l}=o.data;if(r(this,W).isDeletedAnnotationElement(l))continue;let d=t.get(l);if(d){d.resetAnnotationElement(o),d.show(!1),o.show();continue}d=e.get(l),d&&(r(this,W).addChangedExistingAnnotation(d),d.renderAnnotationElement(o)&&d.show(!1)),o.show()}}w(this,Pe,td).call(this),this.isEmpty&&(this.div.hidden=!0);const{classList:s}=this.div;for(const a of r(ms,yn).values())s.remove(`${a._type}Editing`);this.disableTextSelection(),this.toggleAnnotationLayerPointerEvents(!0),x(this,ro,!1)}getEditableAnnotation(e){var t;return((t=r(this,ei))==null?void 0:t.getEditableAnnotation(e))||null}setActiveEditor(e){r(this,W).getActive()!==e&&r(this,W).setActiveEditor(e)}enableTextSelection(){var e;if(this.div.tabIndex=-1,(e=r(this,pt))!=null&&e.div&&!r(this,Mi)){x(this,Mi,new AbortController);const t=r(this,W).combinedSignal(r(this,Mi));r(this,pt).div.addEventListener("pointerdown",w(this,Pe,Lf).bind(this),{signal:t}),r(this,pt).div.classList.add("highlighting")}}disableTextSelection(){var e;this.div.tabIndex=0,(e=r(this,pt))!=null&&e.div&&r(this,Mi)&&(r(this,Mi).abort(),x(this,Mi,null),r(this,pt).div.classList.remove("highlighting"))}enableClick(){if(r(this,bn))return;x(this,bn,new AbortController);const e=r(this,W).combinedSignal(r(this,bn));this.div.addEventListener("pointerdown",this.pointerdown.bind(this),{signal:e});const t=this.pointerup.bind(this);this.div.addEventListener("pointerup",t,{signal:e}),this.div.addEventListener("pointercancel",t,{signal:e})}disableClick(){var e;(e=r(this,bn))==null||e.abort(),x(this,bn,null)}attach(e){r(this,os).set(e.id,e);const{annotationElementId:t}=e;t&&r(this,W).isDeletedAnnotationElement(t)&&r(this,W).removeDeletedAnnotationElement(e)}detach(e){var t;r(this,os).delete(e.id),(t=r(this,Ma))==null||t.removePointerInTextLayer(e.contentDiv),!r(this,ro)&&e.annotationElementId&&r(this,W).addDeletedAnnotationElement(e)}remove(e){this.detach(e),r(this,W).removeEditor(e),e.div.remove(),e.isAttachedToDOM=!1}changeParent(e){var t;e.parent!==this&&(e.parent&&e.annotationElementId&&(r(this,W).addDeletedAnnotationElement(e.annotationElementId),Le.deleteAnnotationElement(e),e.annotationElementId=null),this.attach(e),(t=e.parent)==null||t.detach(e),e.setParent(this),e.div&&e.isAttachedToDOM&&(e.div.remove(),this.div.append(e.div)))}add(e){if(!(e.parent===this&&e.isAttachedToDOM)){if(this.changeParent(e),r(this,W).addEditor(e),this.attach(e),!e.isAttachedToDOM){const t=e.render();this.div.append(t),e.isAttachedToDOM=!0}e.fixAndSetPosition(),e.onceAdded(!r(this,Ia)),r(this,W).addToAnnotationStorage(e),e._reportTelemetry(e.telemetryInitialData)}}moveEditorInDOM(e){var s;if(!e.isAttachedToDOM)return;const{activeElement:t}=document;e.div.contains(t)&&!r(this,Ri)&&(e._focusEventsAllowed=!1,x(this,Ri,setTimeout(()=>{x(this,Ri,null),e.div.contains(document.activeElement)?e._focusEventsAllowed=!0:(e.div.addEventListener("focusin",()=>{e._focusEventsAllowed=!0},{once:!0,signal:r(this,W)._signal}),t.focus())},0))),e._structTreeParentId=(s=r(this,Ma))==null?void 0:s.moveElementInDOM(this.div,e.div,e.contentDiv,!0)}addOrRebuild(e){e.needsToBeRebuilt()?(e.parent||(e.parent=this),e.rebuild(),e.show()):this.add(e)}addUndoableEditor(e){const t=()=>e._uiManager.rebuild(e),s=()=>{e.remove()};this.addCommands({cmd:t,undo:s,mustExec:!1})}getNextId(){return r(this,W).getId()}combinedSignal(e){return r(this,W).combinedSignal(e)}canCreateNewEmptyEditor(){var e;return(e=r(this,Pe,Ds))==null?void 0:e.canCreateNewEmptyEditor()}pasteEditor(e,t){r(this,W).updateToolbar(e),r(this,W).updateMode(e);const{offsetX:s,offsetY:n}=w(this,Pe,ou).call(this),a=this.getNextId(),o=w(this,Pe,ru).call(this,{parent:this,id:a,x:s,y:n,uiManager:r(this,W),isCentered:!0,...t});o&&this.add(o)}async deserialize(e){var t,s;return await((s=r(ms,yn).get((t=e.annotationType)!=null?t:e.annotationEditorType))==null?void 0:s.deserialize(e,this,r(this,W)))||null}createAndAddNewEditor(e,t,s={}){const n=this.getNextId(),a=w(this,Pe,ru).call(this,{parent:this,id:n,x:e.offsetX,y:e.offsetY,uiManager:r(this,W),isCentered:t,...s});return a&&this.add(a),a}addNewEditor(){this.createAndAddNewEditor(w(this,Pe,ou).call(this),!0)}setSelected(e){r(this,W).setSelected(e)}toggleSelected(e){r(this,W).toggleSelected(e)}unselect(e){r(this,W).unselect(e)}pointerup(e){var s;const{isMac:t}=At.platform;if(!(e.button!==0||e.ctrlKey&&t)&&e.target===this.div&&r(this,vn)&&(x(this,vn,!1),!((s=r(this,Pe,Ds))!=null&&s.isDrawer&&r(this,Pe,Ds).supportMultipleDrawings))){if(!r(this,ao)){x(this,ao,!0);return}if(r(this,W).getMode()===ae.STAMP){r(this,W).unselectAll();return}this.createAndAddNewEditor(e,!1)}}pointerdown(e){var n;if(r(this,W).getMode()===ae.HIGHLIGHT&&this.enableTextSelection(),r(this,vn)){x(this,vn,!1);return}const{isMac:t}=At.platform;if(e.button!==0||e.ctrlKey&&t||e.target!==this.div)return;if(x(this,vn,!0),(n=r(this,Pe,Ds))!=null&&n.isDrawer){this.startDrawingSession(e);return}const s=r(this,W).getActive();x(this,ao,!s||s.isEmpty())}startDrawingSession(e){if(this.div.focus(),r(this,Ss)){r(this,Pe,Ds).startDrawing(this,r(this,W),!1,e);return}r(this,W).setCurrentDrawingSession(this),x(this,Ss,new AbortController);const t=r(this,W).combinedSignal(r(this,Ss));this.div.addEventListener("blur",({relatedTarget:s})=>{s&&!this.div.contains(s)&&(x(this,Pi,null),this.commitOrRemove())},{signal:t}),r(this,Pe,Ds).startDrawing(this,r(this,W),!1,e)}pause(e){if(e){const{activeElement:t}=document;this.div.contains(t)&&x(this,Pi,t);return}r(this,Pi)&&setTimeout(()=>{var t;(t=r(this,Pi))==null||t.focus(),x(this,Pi,null)},0)}endDrawingSession(e=!1){return r(this,Ss)?(r(this,W).setCurrentDrawingSession(null),r(this,Ss).abort(),x(this,Ss,null),x(this,Pi,null),r(this,Pe,Ds).endDrawing(e)):null}findNewParent(e,t,s){const n=r(this,W).findParent(t,s);return n===null||n===this?!1:(n.changeParent(e),!0)}commitOrRemove(){return r(this,Ss)?(this.endDrawingSession(),!0):!1}onScaleChanging(){r(this,Ss)&&r(this,Pe,Ds).onScaleChangingWhenDrawing(this)}destroy(){var e,t;this.commitOrRemove(),((e=r(this,W).getActive())==null?void 0:e.parent)===this&&(r(this,W).commitOrRemove(),r(this,W).setActiveEditor(null)),r(this,Ri)&&(clearTimeout(r(this,Ri)),x(this,Ri,null));for(const s of r(this,os).values())(t=r(this,Ma))==null||t.removePointerInTextLayer(s.contentDiv),s.setParent(null),s.isAttachedToDOM=!1,s.div.remove();this.div=null,r(this,os).clear(),r(this,W).removeLayer(this)}render({viewport:e}){this.viewport=e,Fa(this.div,e);for(const t of r(this,W).getEditors(this.pageIndex))this.add(t),t.rebuild();this.updateMode()}update({viewport:e}){r(this,W).commitOrRemove(),w(this,Pe,td).call(this);const t=this.viewport.rotation,s=e.rotation;if(this.viewport=e,Fa(this.div,{rotation:s}),t!==s)for(const n of r(this,os).values())n.rotate(s)}get pageDimensions(){const{pageWidth:e,pageHeight:t}=this.viewport.rawDims;return[e,t]}get scale(){return r(this,W).viewParameters.realScale}};Ma=new WeakMap,ao=new WeakMap,ei=new WeakMap,bn=new WeakMap,Ri=new WeakMap,os=new WeakMap,vn=new WeakMap,ro=new WeakMap,Ia=new WeakMap,Ss=new WeakMap,Pi=new WeakMap,pt=new WeakMap,Mi=new WeakMap,W=new WeakMap,yn=new WeakMap,Pe=new WeakSet,Lf=function(e){r(this,W).unselectAll();const{target:t}=e;if(t===r(this,pt).div||(t.getAttribute("role")==="img"||t.classList.contains("endOfContent"))&&r(this,pt).div.contains(t)){const{isMac:s}=At.platform;if(e.button!==0||e.ctrlKey&&s)return;r(this,W).showAllEditors("highlight",!0,!0),r(this,pt).div.classList.add("free"),this.toggleDrawing(),dd.startHighlighting(this,r(this,W).direction==="ltr",{target:r(this,pt).div,x:e.x,y:e.y}),r(this,pt).div.addEventListener("pointerup",()=>{r(this,pt).div.classList.remove("free"),this.toggleDrawing(!0)},{once:!0,signal:r(this,W)._signal}),e.preventDefault()}},Ds=function(){return r(ms,yn).get(r(this,W).getMode())},ru=function(e){const t=r(this,Pe,Ds);return t?new t.prototype.constructor(e):null},ou=function(){const{x:e,y:t,width:s,height:n}=this.div.getBoundingClientRect(),a=Math.max(0,e),o=Math.max(0,t),l=Math.min(window.innerWidth,e+s),d=Math.min(window.innerHeight,t+n),h=(a+l)/2-e,u=(o+d)/2-t,[p,m]=this.viewport.rotation%180===0?[h,u]:[u,h];return{offsetX:p,offsetY:m}},td=function(){for(const e of r(this,os).values())e.isEmpty()&&e.remove()},Z(ms,"_initialized",!1),v(ms,yn,new Map([Hh,tu,su,dd].map(e=>[e._editorType,e])));let au=ms;var Cs,dc,jt,La,Td,Df,ii,cu,Ff,du;const ct=class ct{constructor({pageIndex:e}){v(this,ii);v(this,Cs,null);v(this,dc,0);v(this,jt,new Map);v(this,La,new Map);this.pageIndex=e}setParent(e){if(!r(this,Cs)){x(this,Cs,e);return}if(r(this,Cs)!==e){if(r(this,jt).size>0)for(const t of r(this,jt).values())t.remove(),e.append(t);x(this,Cs,e)}}static get _svgFactory(){return de(this,"_svgFactory",new Au)}draw(e,t=!1,s=!1){const n=bt(this,dc)._++,a=w(this,ii,cu).call(this),o=ct._svgFactory.createElement("defs");a.append(o);const l=ct._svgFactory.createElement("path");o.append(l);const d=`path_p${this.pageIndex}_${n}`;l.setAttribute("id",d),l.setAttribute("vector-effect","non-scaling-stroke"),t&&r(this,La).set(n,l);const h=s?w(this,ii,Ff).call(this,o,d):null,u=ct._svgFactory.createElement("use");return a.append(u),u.setAttribute("href",`#${d}`),this.updateProperties(a,e),r(this,jt).set(n,a),{id:n,clipPathId:`url(#${h})`}}drawOutline(e,t){const s=bt(this,dc)._++,n=w(this,ii,cu).call(this),a=ct._svgFactory.createElement("defs");n.append(a);const o=ct._svgFactory.createElement("path");a.append(o);const l=`path_p${this.pageIndex}_${s}`;o.setAttribute("id",l),o.setAttribute("vector-effect","non-scaling-stroke");let d;if(t){const p=ct._svgFactory.createElement("mask");a.append(p),d=`mask_p${this.pageIndex}_${s}`,p.setAttribute("id",d),p.setAttribute("maskUnits","objectBoundingBox");const m=ct._svgFactory.createElement("rect");p.append(m),m.setAttribute("width","1"),m.setAttribute("height","1"),m.setAttribute("fill","white");const f=ct._svgFactory.createElement("use");p.append(f),f.setAttribute("href",`#${l}`),f.setAttribute("stroke","none"),f.setAttribute("fill","black"),f.setAttribute("fill-rule","nonzero"),f.classList.add("mask")}const h=ct._svgFactory.createElement("use");n.append(h),h.setAttribute("href",`#${l}`),d&&h.setAttribute("mask",`url(#${d})`);const u=h.cloneNode();return n.append(u),h.classList.add("mainOutline"),u.classList.add("secondaryOutline"),this.updateProperties(n,e),r(this,jt).set(s,n),s}finalizeDraw(e,t){r(this,La).delete(e),this.updateProperties(e,t)}updateProperties(e,t){var d;if(!t)return;const{root:s,bbox:n,rootClass:a,path:o}=t,l=typeof e=="number"?r(this,jt).get(e):e;if(l){if(s&&w(this,ii,du).call(this,l,s),n&&w(d=ct,Td,Df).call(d,l,n),a){const{classList:h}=l;for(const[u,p]of Object.entries(a))h.toggle(u,p)}if(o){const u=l.firstChild.firstChild;w(this,ii,du).call(this,u,o)}}}updateParent(e,t){if(t===this)return;const s=r(this,jt).get(e);s&&(r(t,Cs).append(s),r(this,jt).delete(e),r(t,jt).set(e,s))}remove(e){r(this,La).delete(e),r(this,Cs)!==null&&(r(this,jt).get(e).remove(),r(this,jt).delete(e))}destroy(){x(this,Cs,null);for(const e of r(this,jt).values())e.remove();r(this,jt).clear(),r(this,La).clear()}};Cs=new WeakMap,dc=new WeakMap,jt=new WeakMap,La=new WeakMap,Td=new WeakSet,Df=function(e,[t,s,n,a]){const{style:o}=e;o.top=`${100*s}%`,o.left=`${100*t}%`,o.width=`${100*n}%`,o.height=`${100*a}%`},ii=new WeakSet,cu=function(){const e=ct._svgFactory.create(1,1,!0);return r(this,Cs).append(e),e.setAttribute("aria-hidden",!0),e},Ff=function(e,t){const s=ct._svgFactory.createElement("clipPath");e.append(s);const n=`clip_${t}`;s.setAttribute("id",n),s.setAttribute("clipPathUnits","objectBoundingBox");const a=ct._svgFactory.createElement("use");return s.append(a),a.setAttribute("href",`#${t}`),a.classList.add("clip"),n},du=function(e,t){for(const[s,n]of Object.entries(t))n===null?e.removeAttribute(s):e.setAttribute(s,n)},v(ct,Td);let lu=ct;globalThis.pdfjsTestingUtils={HighlightOutliner:zh};ee.AbortException;ee.AnnotationEditorLayer;ee.AnnotationEditorParamsType;ee.AnnotationEditorType;ee.AnnotationEditorUIManager;ee.AnnotationLayer;ee.AnnotationMode;ee.ColorPicker;ee.DOMSVGFactory;ee.DrawLayer;ee.FeatureTest;var ub=ee.GlobalWorkerOptions;ee.ImageKind;ee.InvalidPDFException;ee.MissingPDFException;ee.OPS;ee.OutputScale;ee.PDFDataRangeTransport;ee.PDFDateString;ee.PDFWorker;ee.PasswordResponses;ee.PermissionFlag;ee.PixelsPerInch;ee.RenderingCancelledException;ee.TextLayer;ee.TouchManager;ee.UnexpectedResponseException;ee.Util;ee.VerbosityLevel;ee.XfaLayer;ee.build;ee.createValidAbsoluteUrl;ee.fetchData;var pb=ee.getDocument;ee.getFilenameFromUrl;ee.getPdfFilenameFromUrl;ee.getXfaPageViewport;ee.isDataScheme;ee.isPdfFile;ee.noContextMenu;ee.normalizeUnicode;ee.setLayerDimensions;ee.shadow;ee.stopEvent;ee.version;ub.workerSrc="/pdf.worker.min.mjs";const hu=c=>{if(!c)return"Unknown";if(typeof c=="string")return c.replace(/_/g," ");if(typeof c=="object"){const e=Object.keys(c);if(e.length>0)return e[0].replace(/([A-Z])/g," $1").trim()}return"Unknown"},mb=c=>{if(!c)return"other";if(typeof c=="string")return c.toLowerCase().replace(/[_\s]/g,"");if(typeof c=="object"){const e=Object.keys(c);if(e.length>0)return e[0].toLowerCase().replace(/[_\s]/g,"")}return"other"},Of=c=>{if(!c)return"pending";if(typeof c=="string")return c;if(typeof c=="object"){const e=Object.keys(c);if(e.length>0)return e[0].toLowerCase()}return"pending"},za=[{id:"key_fact",label:"Key Fact",icon:"Key",color:"bg-blue-100 border-blue-500"},{id:"test_result",label:"Test Result",icon:"Test",color:"bg-purple-100 border-purple-500"},{id:"collateral_statement",label:"Collateral Statement",icon:"Note",color:"bg-green-100 border-green-500"},{id:"self_report",label:"Self Report",icon:"Report",color:"bg-teal-100 border-teal-500"},{id:"timeline_event",label:"Timeline Event",icon:"Timeline",color:"bg-orange-100 border-orange-500"},{id:"contradiction",label:"Contradiction",icon:"Warning",color:"bg-red-100 border-red-500"},{id:"limitation",label:"Limitation",icon:"Limit",color:"bg-yellow-100 border-yellow-500"},{id:"methodology_concern",label:"Methodology Concern",icon:"Method",color:"bg-amber-100 border-amber-500"},{id:"hearsay_flag",label:"Hearsay",icon:"Hearsay",color:"bg-rose-100 border-rose-500"},{id:"highlight",label:"Highlight",icon:"Highlight",color:"bg-gray-100 border-gray-500"}],fb=[{id:"record_fact",label:"Record Fact"},{id:"behavioral_observation",label:"Behavioral Observation"},{id:"test_result",label:"Test Result"},{id:"collateral_statement",label:"Collateral Statement"},{id:"self_report",label:"Self Report"},{id:"clinical_inference",label:"Clinical Inference"},{id:"diagnostic_conclusion",label:"Diagnostic Conclusion"},{id:"forensic_opinion",label:"Forensic Opinion"}],gb=c=>{const e=c.filename.toLowerCase(),t=mb(c.evidence_type);return t==="clinicalinterview"||t.includes("interview")||e.includes("interview")?`CLINICAL INTERVIEW SUMMARY

Patient/Evaluee: [Name Redacted]
Date of Interview: [Date]
Evaluator: [Clinician Name], Ph.D.

PRESENTING CONCERNS:

The evaluee was referred for psychological evaluation to assess current functioning and diagnostic considerations. During the clinical interview, the evaluee presented as cooperative and engaged throughout the assessment process.

The evaluee reported experiencing persistent anxiety symptoms for approximately six months, describing worry that occurs "nearly every day" and interferes with occupational functioning. Specific concerns include difficulty concentrating at work, sleep disturbance with approximately 5 hours of sleep per night, and somatic symptoms including tension headaches.

BEHAVIORAL OBSERVATIONS:

The evaluee arrived on time for the appointment and was appropriately groomed. Eye contact was maintained throughout the interview. Speech was clear and coherent with normal rate and volume. Mood was described as "tense" with congruent affect. No psychomotor agitation or retardation was observed.

The evaluee demonstrated good insight into presenting concerns and acknowledged the need for intervention. Judgment appeared intact based on responses to hypothetical scenarios. No evidence of thought disorder, delusions, or perceptual disturbances was noted.

RELEVANT HISTORY:

The evaluee reported a supportive upbringing with no significant trauma history. Educational history includes completion of a bachelor's degree. Current employment is stable with reported job satisfaction despite anxiety-related challenges.

The evaluee denied any history of substance use, legal involvement, or domestic violence. Family psychiatric history is notable for anxiety in a first-degree relative.

DIAGNOSTIC IMPRESSIONS:

Based on the clinical interview, behavioral observations, and reported symptom presentation, the evaluee's presentation is consistent with Generalized Anxiety Disorder as characterized by excessive worry, sleep disturbance, and functional impairment.`:t==="medicalrecord"||t==="medicalrecords"||e.includes("medical")?`MEDICAL RECORD SUMMARY

Patient: [Name Redacted]
Date of Birth: [DOB]
Medical Record Number: [MRN]
Primary Care Provider: [Provider Name], MD

CHIEF COMPLAINT:
Routine physical examination and management of chronic conditions.

HISTORY OF PRESENT ILLNESS:
Patient presents for annual wellness visit. Reports generally good health with well-controlled asthma. Denies chest pain, shortness of breath at rest, or recent exacerbations. Seasonal allergies managed with over-the-counter antihistamines.

Patient reports history of depression diagnosed in early adulthood, treated with cognitive behavioral therapy. Currently not taking psychotropic medications. Denies current depressive symptoms.

MEDICATIONS:
1. Albuterol inhaler 90 mcg - 2 puffs as needed for wheezing
2. Cetirizine 10 mg - once daily during allergy season

VITAL SIGNS:
Blood Pressure: 118/72 mmHg
Heart Rate: 68 bpm
Respiratory Rate: 14 breaths/minute
Temperature: 98.4°F
Oxygen Saturation: 98% on room air

PHYSICAL EXAMINATION:
General: Well-appearing, alert and oriented, in no acute distress
HEENT: Normocephalic, pupils equal and reactive, oropharynx clear
Cardiovascular: Regular rate and rhythm, no murmurs
Respiratory: Clear to auscultation bilaterally, no wheezes or crackles
Neurological: Grossly intact

ASSESSMENT:
1. Mild intermittent asthma - stable, continue current management
2. Seasonal allergic rhinitis - controlled
3. History of depression - in remission

PLAN:
Continue current medications. Annual flu vaccination recommended. Follow up in one year or sooner if symptoms worsen.`:t==="legaldocument"||t==="legaldocuments"||e.includes("legal")||e.includes("court")||e.includes("custody")?`COURT ORDER: TEMPORARY CUSTODY ARRANGEMENT

SUPERIOR COURT OF [STATE], FAMILY DIVISION
Case Number: [CASE-NUMBER]
Date of Order: [DATE]

IN THE MATTER OF:
Petitioner: [Parent A]
Respondent: [Parent B]
Minor Child: [Child Initials], age [X]

FINDINGS OF FACT:

After reviewing the petition, responses, and the report submitted by the court-appointed evaluator, and considering the best interests of the child, the Court makes the following findings:

1. Both parents have been actively involved in the minor child's life and demonstrate a genuine interest in the child's welfare.

2. The evaluator's report indicates that the child has a strong emotional bond with both parents and benefits from regular contact with each.

3. The primary residence is located within the child's school district, promoting educational stability.

4. There are no findings of abuse, neglect, or domestic violence by either party.

5. Both parents are capable of providing appropriate care and supervision.

ORDER:

IT IS HEREBY ORDERED that the following temporary custody arrangement shall be in effect pending final adjudication:

1. LEGAL CUSTODY: The parties shall share joint legal custody, with both parents responsible for major decisions regarding education, healthcare, and religious upbringing.

2. PHYSICAL CUSTODY: The minor child shall reside primarily with [Parent A]. [Parent B] shall have parenting time as follows:
   - Weekday: Every Wednesday from 3:00 PM until 8:00 PM
   - Weekend: First and third weekends of each month, Friday 3:00 PM to Sunday 6:00 PM

3. HOLIDAYS: The parties shall alternate major holidays according to the standard schedule.

4. COMMUNICATION: Both parties shall facilitate reasonable communication between the child and the other parent.

This order shall remain in effect until the final custody hearing scheduled for [DATE].

IT IS SO ORDERED.

[Judge Name]
Superior Court Judge`:t==="collateralcontact"||t==="collateralstatement"||e.includes("collateral")?`COLLATERAL CONTACT SUMMARY

Contact Type: Telephone Interview
Date: [DATE]
Collateral Source: [Relationship to Evaluee]
Interviewer: [Clinician Name], Ph.D.

PURPOSE OF CONTACT:
To obtain collateral information regarding the evaluee's functioning, behavior, and relevant history from an independent source.

INFORMATION PROVIDED:

The collateral source has known the evaluee for approximately [X] years in the capacity of [relationship]. The source described the evaluee as generally responsible and caring.

Regarding current functioning, the source noted that the evaluee appears to manage daily responsibilities appropriately. The source has observed the evaluee interacting with others and described these interactions as appropriate and positive.

The source reported no concerns regarding substance use, safety issues, or significant behavioral problems. The source described the evaluee's mood as generally stable, though noted occasional stress related to current circumstances.

When asked about specific observations, the source provided the following information:
- The evaluee maintains regular contact and follows through on commitments
- No history of aggressive or concerning behavior has been observed
- The evaluee demonstrates appropriate judgment in decision-making

RELIABILITY ASSESSMENT:
The collateral source appeared forthcoming and consistent in responses. Information provided was generally consistent with other available data.`:`EVIDENCE DOCUMENT

Document Type: ${hu(c.evidence_type)}
Filename: ${c.filename}
Status: ${Of(c.review_status)}

DOCUMENT CONTENT:

This document has been ingested into the case file for review. The content below represents the extracted text from the original document.

[Document content would appear here with full text extraction in production. For testing purposes, this placeholder demonstrates the annotation workflow.]

The evaluator reviewed this document as part of the comprehensive evaluation process. Relevant information has been noted and incorporated into the overall assessment.

Key points from this document include observations, findings, or statements that may be relevant to the referral questions. The evaluator will indicate which portions of this document were relied upon in forming opinions.

ANNOTATION INSTRUCTIONS:
Select any text above to create an annotation. Annotations can then be promoted to claims with automatic citation anchoring.`};function xb({evidence:c,pdfData:e,reportId:t,sections:s,onClose:n,onClaimCreated:a}){var Lu,Du,Fu;const[o,l]=T.useState(null),[d,h]=T.useState(1),[u,p]=T.useState(0),[m,f]=T.useState(1.2),[g,b]=T.useState(""),[A,N]=T.useState(null),[j,E]=T.useState(!1),[_,y]=T.useState({x:0,y:0}),[C,R]=T.useState([]),[S,k]=T.useState(null),[M,L]=T.useState(!1),[O,$]=T.useState(null),[q,F]=T.useState(""),[P,I]=T.useState("record_fact"),[K,ie]=T.useState(!1),[ue,te]=T.useState(null),[V,le]=T.useState(!0),ye=T.useRef(null),z=T.useRef(null),Se=T.useRef(null);T.useEffect(()=>{e&&he(e),hs()},[e,c.id]);const he=async D=>{try{ie(!0);const se=await pb({data:D}).promise;l(se),p(se.numPages),h(1)}catch(se){te(`Failed to load PDF: ${se}`)}finally{ie(!1)}},hs=async()=>{try{const D=await Y("forensic_list_annotations",{evidenceId:c.id});D.status==="success"&&D.data&&R(D.data)}catch(D){console.error("Failed to load annotations:",D)}};T.useEffect(()=>{o&&ye.current&&Ps(d)},[o,d,m]);const Ps=async D=>{if(!(!o||!ye.current))try{const se=await o.getPage(D),He=se.getViewport({scale:m}),Ce=ye.current,gt=Ce.getContext("2d");if(!gt)return;Ce.height=He.height,Ce.width=He.width,await se.render({canvasContext:gt,viewport:He}).promise;const $i=(await se.getTextContent()).items;b($i.map(xt=>xt.str).join(" ")),z.current&&(z.current.innerHTML="",z.current.style.width=`${He.width}px`,z.current.style.height=`${He.height}px`,$i.forEach((xt,fc)=>{if(!xt.str.trim())return;const Hi=xt.transform,Ou=Math.sqrt(Hi[0]*Hi[0]+Hi[1]*Hi[1])*m,Gf=Hi[4]*m,Vf=He.height-Hi[5]*m-Ou,Et=document.createElement("span");Et.textContent=xt.str,Et.style.position="absolute",Et.style.left=`${Gf}px`,Et.style.top=`${Vf}px`,Et.style.fontSize=`${Ou}px`,Et.style.fontFamily="sans-serif",Et.style.color="transparent",Et.style.whiteSpace="pre",Et.style.pointerEvents="auto",Et.dataset.textIndex=String(fc);const $u=xt.width*m;Et.style.width=`${$u}px`,Et.style.letterSpacing=`${($u-Et.offsetWidth)/xt.str.length}px`,z.current.appendChild(Et)})),us(D,He)}catch(se){te(`Failed to render page: ${se}`)}},us=(D,se)=>{const He=C.filter(Ce=>Ce.page===D);!z.current||He.length===0||He.forEach(Ce=>{var fc;const gt=za.find(Hi=>Hi.id===Ce.annotation_type),co=((fc=gt==null?void 0:gt.color)==null?void 0:fc.replace("bg-","").replace("-100",""))||"yellow",$i=document.createElement("div");$i.className="absolute opacity-30 pointer-events-none",$i.style.backgroundColor=Q(co),$i.dataset.annotationId=Ce.id;const xt=document.createElement("div");xt.className="absolute right-0 top-0 bg-purple-600 text-white text-xs px-1 rounded-bl",xt.textContent=(gt==null?void 0:gt.icon)||"Note",xt.style.fontSize="10px",z.current.appendChild(xt)})},Q=D=>{const se={blue:"rgba(59, 130, 246, 0.3)",purple:"rgba(147, 51, 234, 0.3)",green:"rgba(34, 197, 94, 0.3)",teal:"rgba(20, 184, 166, 0.3)",orange:"rgba(249, 115, 22, 0.3)",red:"rgba(239, 68, 68, 0.3)",yellow:"rgba(234, 179, 8, 0.3)",amber:"rgba(245, 158, 11, 0.3)",rose:"rgba(244, 63, 94, 0.3)",gray:"rgba(156, 163, 175, 0.3)"};return se[D]||se.yellow},Ms=T.useCallback(()=>{var xt;const D=window.getSelection();if(!D||D.isCollapsed||!D.toString().trim()){N(null),E(!1);return}const se=D.toString().trim();if(se.length<3){N(null);return}const Ce=D.getRangeAt(0).getBoundingClientRect(),gt=(xt=Se.current)==null?void 0:xt.getBoundingClientRect();gt&&y({x:Ce.left-gt.left+Ce.width/2,y:Ce.top-gt.top-10});const co=g.indexOf(se),$i=co+se.length;N({text:se,page:d,startOffset:Math.max(0,co),endOffset:$i,rects:[Ce]}),E(!0)},[d,g]),ps=async D=>{var se,He;if(A){ie(!0),E(!1);try{const Ce=await Y("forensic_create_annotation",{req:{evidence_id:c.id,annotation_type:D,page:A.page,start_offset:A.startOffset,end_offset:A.endOffset,excerpt:A.text,note:null}});Ce.status==="success"&&Ce.data?(R(gt=>[...gt,Ce.data]),k(Ce.data),N(null),(se=window.getSelection())==null||se.removeAllRanges()):te(((He=Ce.error)==null?void 0:He.message)||"Failed to create annotation")}catch(Ce){te(`Failed to create annotation: ${Ce}`)}finally{ie(!1)}}},Bf=D=>{$(D),L(!0)},zf=async()=>{var D;if(O){if(!t){te("No active report. Create a report first from the Draft tab.");return}ie(!0);try{const se=await Y("forensic_promote_to_claim",{input:{annotation_id:O,report_id:t,section_id:q||"default-section",claim_type:P,claim_text:null},userId:"clinician-1"});se.status==="success"&&se.data?(R(He=>He.map(Ce=>Ce.id===O?{...Ce,linked_claim_id:se.data.claim_id}:Ce)),L(!1),$(null),a==null||a(se.data.claim_id),alert(`Claim created.

Citation: ${se.data.citation_anchor.citation_string}
Hash: ${se.data.citation_anchor.excerpt_hash}`)):te(((D=se.error)==null?void 0:D.message)||"Failed to promote to claim")}catch(se){te(`Failed to promote to claim: ${se}`)}finally{ie(!1)}}},Mu=D=>{D>=1&&D<=u&&h(D)},Uf=D=>{h(D.page),k(D)},Iu=C.filter(D=>D.page===d);return i.jsxs("div",{className:"fixed inset-0 bg-black/80 z-50 flex",children:[i.jsxs("div",{className:"flex-1 flex flex-col bg-slate-900",children:[i.jsxs("div",{className:"bg-slate-800 px-4 py-2 flex items-center justify-between",children:[i.jsxs("div",{className:"flex items-center gap-4",children:[i.jsx("button",{onClick:n,className:"text-white hover:text-gray-300",children:"← Back"}),i.jsxs("div",{children:[i.jsx("h2",{className:"text-white font-medium",children:c.filename}),i.jsxs("p",{className:"text-slate-400 text-sm",children:[hu(c.evidence_type)," • ",c.bates_start||"No Bates"]})]})]}),i.jsxs("div",{className:"flex items-center gap-4",children:[i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx("button",{onClick:()=>f(D=>Math.max(.5,D-.2)),className:"text-white hover:text-gray-300 px-2",children:"−"}),i.jsxs("span",{className:"text-white text-sm",children:[Math.round(m*100),"%"]}),i.jsx("button",{onClick:()=>f(D=>Math.min(3,D+.2)),className:"text-white hover:text-gray-300 px-2",children:"+"})]}),i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx("button",{onClick:()=>Mu(d-1),disabled:d<=1,className:"text-white hover:text-gray-300 disabled:text-gray-600 px-2",children:"‹"}),i.jsxs("span",{className:"text-white text-sm",children:["Page ",d," of ",u]}),i.jsx("button",{onClick:()=>Mu(d+1),disabled:d>=u,className:"text-white hover:text-gray-300 disabled:text-gray-600 px-2",children:"›"})]}),i.jsxs("button",{onClick:()=>le(!V),className:`px-3 py-1 rounded text-sm ${V?"bg-purple-600 text-white":"bg-slate-700 text-slate-300"}`,children:["Annotations (",C.length,")"]})]})]}),i.jsxs("div",{ref:Se,className:"flex-1 overflow-auto flex justify-center p-4 relative",onMouseUp:Ms,children:[K&&i.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black/50",children:i.jsx("span",{className:"text-white",children:"Loading..."})}),e?i.jsxs("div",{className:"relative",children:[i.jsx("canvas",{ref:ye,className:"shadow-lg"}),i.jsx("div",{ref:z,className:"pdf-text-layer absolute top-0 left-0",style:{opacity:1}}),j&&A&&i.jsxs("div",{className:"absolute bg-white rounded-lg shadow-xl border p-2 z-10",style:{left:_.x,top:_.y,transform:"translate(-50%, -100%)"},children:[i.jsx("div",{className:"text-xs text-gray-500 mb-2 px-2",children:"Create Annotation"}),i.jsx("div",{className:"grid grid-cols-5 gap-1",children:za.slice(0,5).map(D=>i.jsx("button",{onClick:()=>ps(D.id),className:"p-2 hover:bg-gray-100 rounded flex flex-col items-center text-xs",title:D.label,children:i.jsx("span",{className:"text-lg",children:D.icon})},D.id))}),i.jsx("div",{className:"grid grid-cols-5 gap-1 mt-1",children:za.slice(5).map(D=>i.jsx("button",{onClick:()=>ps(D.id),className:"p-2 hover:bg-gray-100 rounded flex flex-col items-center text-xs",title:D.label,children:i.jsx("span",{className:"text-lg",children:D.icon})},D.id))})]}),Iu.length>0&&i.jsxs("div",{className:"absolute top-2 right-2 bg-purple-600 text-white px-2 py-1 rounded text-xs",children:[Iu.length," annotation(s) on this page"]})]}):i.jsxs("div",{className:"w-full max-w-4xl bg-white rounded-lg shadow-lg p-8 select-text",children:[i.jsxs("div",{className:"mb-6 pb-4 border-b",children:[i.jsx("h2",{className:"text-xl font-semibold text-slate-800",children:c.filename}),i.jsxs("div",{className:"flex gap-4 mt-2 text-sm text-slate-500",children:[i.jsx("span",{className:"px-2 py-0.5 bg-slate-100 rounded",children:hu(c.evidence_type)}),i.jsxs("span",{children:["Status: ",Of(c.review_status)]}),c.relied_upon&&i.jsx("span",{className:"text-purple-600",children:"Relied Upon"})]})]}),i.jsxs("div",{className:"prose prose-slate max-w-none",children:[i.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4 mb-6",children:[i.jsx("p",{className:"text-green-800 text-sm font-medium mb-2",children:"Ready for Annotation"}),i.jsxs("p",{className:"text-green-700 text-sm",children:[i.jsx("strong",{children:"Select any text below"})," to create an annotation, then promote it to a claim with automatic citation."]})]}),i.jsx("div",{className:"text-slate-700 leading-relaxed whitespace-pre-wrap font-serif",style:{minHeight:"400px"},onMouseUp:Ms,children:g||gb(c)})]}),j&&A&&i.jsxs("div",{className:"fixed bg-white rounded-lg shadow-xl border p-2 z-50",style:{left:_.x+(((Lu=Se.current)==null?void 0:Lu.getBoundingClientRect().left)||0),top:_.y+(((Du=Se.current)==null?void 0:Du.getBoundingClientRect().top)||0),transform:"translate(-50%, -100%)"},children:[i.jsx("div",{className:"text-xs text-gray-500 mb-2 px-2",children:"Create Annotation"}),i.jsx("div",{className:"grid grid-cols-5 gap-1",children:za.slice(0,5).map(D=>i.jsx("button",{onClick:()=>ps(D.id),className:"p-2 hover:bg-gray-100 rounded flex flex-col items-center text-xs",title:D.label,children:i.jsx("span",{className:"text-lg",children:D.icon})},D.id))}),i.jsx("div",{className:"grid grid-cols-5 gap-1 mt-1",children:za.slice(5).map(D=>i.jsx("button",{onClick:()=>ps(D.id),className:"p-2 hover:bg-gray-100 rounded flex flex-col items-center text-xs",title:D.label,children:i.jsx("span",{className:"text-lg",children:D.icon})},D.id))})]})]})]})]}),V&&i.jsxs("div",{className:"w-96 bg-white border-l flex flex-col",children:[i.jsxs("div",{className:"p-4 border-b",children:[i.jsx("h3",{className:"font-semibold text-slate-700",children:"Annotations"}),i.jsx("p",{className:"text-xs text-slate-500",children:"Select text in the document to create annotations"})]}),i.jsx("div",{className:"flex-1 overflow-y-auto p-4 space-y-3",children:C.length===0?i.jsxs("p",{className:"text-slate-400 text-center py-8",children:["No annotations yet.",i.jsx("br",{}),i.jsx("span",{className:"text-sm",children:"Select text to annotate."})]}):C.map(D=>{const se=za.find(He=>He.id===D.annotation_type);return i.jsxs("div",{onClick:()=>Uf(D),className:`p-3 rounded-lg border-l-4 cursor-pointer transition-all ${(S==null?void 0:S.id)===D.id?"ring-2 ring-purple-500 "+((se==null?void 0:se.color)||"bg-gray-100 border-gray-500"):(se==null?void 0:se.color)||"bg-gray-100 border-gray-500"}`,children:[i.jsxs("div",{className:"flex items-start justify-between mb-2",children:[i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx("span",{children:(se==null?void 0:se.icon)||"Note"}),i.jsx("span",{className:"text-xs font-medium text-slate-600",children:(se==null?void 0:se.label)||D.annotation_type})]}),i.jsxs("span",{className:"text-xs text-slate-400",children:["p. ",D.page]})]}),i.jsxs("p",{className:"text-sm text-slate-700 mb-2 line-clamp-3",children:['"',D.excerpt,'"']}),i.jsxs("div",{className:"flex items-center justify-between",children:[i.jsxs("span",{className:"text-xs text-slate-400 font-mono",children:["#",D.excerpt_hash.slice(0,8)]}),D.linked_claim_id?i.jsx("span",{className:"text-xs px-2 py-0.5 bg-green-100 text-green-700 rounded",children:"Claim linked"}):i.jsx("button",{onClick:He=>{He.stopPropagation(),Bf(D.id)},className:"text-xs px-2 py-0.5 bg-purple-100 text-purple-700 rounded hover:bg-purple-200",children:"→ Promote to Claim"})]})]},D.id)})}),i.jsx("div",{className:"p-4 border-t bg-slate-50",children:i.jsxs("div",{className:"grid grid-cols-3 gap-2 text-center text-xs",children:[i.jsxs("div",{children:[i.jsx("div",{className:"text-lg font-bold text-slate-700",children:C.length}),i.jsx("div",{className:"text-slate-500",children:"Total"})]}),i.jsxs("div",{children:[i.jsx("div",{className:"text-lg font-bold text-green-600",children:C.filter(D=>D.linked_claim_id).length}),i.jsx("div",{className:"text-slate-500",children:"Claimed"})]}),i.jsxs("div",{children:[i.jsx("div",{className:"text-lg font-bold text-amber-600",children:C.filter(D=>!D.linked_claim_id).length}),i.jsx("div",{className:"text-slate-500",children:"Pending"})]})]})})]}),M&&i.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:i.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-[400px] p-6",children:[i.jsx("h3",{className:"text-lg font-semibold text-slate-800 mb-4",children:"Promote to Claim"}),t?i.jsxs(i.Fragment,{children:[i.jsxs("div",{className:"space-y-4",children:[i.jsxs("div",{children:[i.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:"Claim Type"}),i.jsx("select",{value:P,onChange:D=>I(D.target.value),className:"w-full border rounded-lg px-3 py-2",children:fb.map(D=>i.jsx("option",{value:D.id,children:D.label},D.id))})]}),i.jsxs("div",{children:[i.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:"Target Section"}),s&&s.length>0?i.jsxs("select",{value:q,onChange:D=>F(D.target.value),className:"w-full border rounded-lg px-3 py-2",children:[i.jsx("option",{value:"",children:"Select a section..."}),s.map(D=>i.jsx("option",{value:D.id,children:D.title},D.id))]}):i.jsx("p",{className:"text-sm text-slate-500 italic",children:"No sections available. Add sections in the Draft tab."})]}),i.jsxs("div",{className:"bg-slate-50 rounded-lg p-3",children:[i.jsx("p",{className:"text-xs text-slate-500 mb-1",children:"Excerpt"}),i.jsxs("p",{className:"text-sm text-slate-700",children:['"',(Fu=C.find(D=>D.id===O))==null?void 0:Fu.excerpt.slice(0,100),'..."']})]})]}),i.jsxs("div",{className:"flex justify-end gap-3 mt-6",children:[i.jsx("button",{onClick:()=>L(!1),className:"px-4 py-2 text-slate-600 hover:text-slate-800",children:"Cancel"}),i.jsx("button",{onClick:zf,disabled:K||!q,className:"px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:bg-slate-300",children:K?"Creating...":"Create Claim with Citation"})]})]}):i.jsxs("div",{className:"text-center py-6",children:[i.jsx("p",{className:"text-amber-600 mb-2",children:"No active report"}),i.jsx("p",{className:"text-sm text-slate-500",children:"Create a report from the Draft tab first, then come back to promote this annotation."}),i.jsx("button",{onClick:()=>L(!1),className:"mt-4 px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300",children:"Close"})]})]})}),ue&&i.jsx("div",{className:"fixed bottom-4 right-4 bg-red-100 border border-red-200 text-red-700 px-4 py-3 rounded-lg shadow-lg",children:i.jsxs("div",{className:"flex items-center justify-between",children:[i.jsx("span",{children:ue}),i.jsx("button",{onClick:()=>te(null),className:"ml-4 text-red-500",children:"Close"})]})})]})}const pp={record_fact:{label:"Record Fact",icon:"Doc",color:"bg-blue-100 text-blue-700 border-blue-200"},self_report:{label:"Self-Report",icon:"Quote",color:"bg-amber-100 text-amber-700 border-amber-200"},collateral:{label:"Collateral",icon:"Group",color:"bg-purple-100 text-purple-700 border-purple-200"},observation:{label:"Observation",icon:"Obs",color:"bg-teal-100 text-teal-700 border-teal-200"},test_result:{label:"Test Result",icon:"Test",color:"bg-indigo-100 text-indigo-700 border-indigo-200"},inference:{label:"Inference",icon:"Inference",color:"bg-orange-100 text-orange-700 border-orange-200"},forensic_opinion:{label:"Opinion",icon:"Opinion",color:"bg-red-100 text-red-700 border-red-200"},limitation:{label:"Limitation",icon:"Limit",color:"bg-gray-100 text-gray-700 border-gray-200"},method:{label:"Method",icon:"Method",color:"bg-cyan-100 text-cyan-700 border-cyan-200"}};function bb({claims:c,evidence:e,sections:t,contradictions:s=[],onClaimClick:n,onAddCitation:a}){const[o,l]=T.useState("all"),[d,h]=T.useState("all"),[u,p]=T.useState("section"),[m,f]=T.useState(new Set),g=S=>(S.claim_text||S.text||"").toString(),b=S=>S.citations&&S.citations.length||0,A=S=>!S.citations||b(S)===0?[]:typeof S.citations[0]=="string"?S.citations.map(k=>({evidence_id:k,excerpt:""})):S.citations,N=S=>{var k;return((k=e.find(M=>M.id===S))==null?void 0:k.filename)||"Unknown"},j=S=>{var k;return((k=t.find(M=>M.id===S))==null?void 0:k.title)||"Unassigned"},E=S=>s.filter(k=>k.claim_a_id===S||k.claim_b_id===S),_=T.useMemo(()=>{let S=[...c];switch(o){case"cited":S=S.filter(k=>k.citations.length>0);break;case"uncited":S=S.filter(k=>k.citations.length===0);break;case"contradicted":S=S.filter(k=>E(k.id).length>0);break}switch(d!=="all"&&(S=S.filter(k=>k.claim_type===d)),u){case"type":S.sort((k,M)=>k.claim_type.localeCompare(M.claim_type));break;case"section":S.sort((k,M)=>j(k.section_id).localeCompare(j(M.section_id)));break;case"citations":S.sort((k,M)=>M.citations.length-k.citations.length);break}return S},[c,o,d,u,s]),y=T.useMemo(()=>({total:c.length,cited:c.filter(S=>S.citations.length>0).length,uncited:c.filter(S=>S.citations.length===0).length,contradicted:c.filter(S=>E(S.id).length>0).length,opinions:c.filter(S=>S.claim_type==="forensic_opinion").length}),[c,s]),C=T.useMemo(()=>{const S=new Set(c.map(k=>k.claim_type));return Array.from(S).sort()},[c]),R=S=>{const k=new Set(m);k.has(S)?k.delete(S):k.add(S),f(k)};return i.jsxs("div",{className:"bg-white rounded-xl border shadow-sm overflow-hidden",children:[i.jsxs("div",{className:"p-4 border-b bg-gradient-to-r from-slate-50 to-white",children:[i.jsx("div",{className:"flex items-center justify-between mb-3",children:i.jsxs("h2",{className:"font-semibold text-slate-800 flex items-center gap-2",children:["Claim Ledger",i.jsxs("span",{className:"text-sm font-normal text-slate-500",children:["(",y.total," claims)"]})]})}),i.jsxs("div",{className:"flex flex-wrap gap-2 mb-3",children:[i.jsxs("button",{onClick:()=>l("all"),className:`px-3 py-1 rounded-full text-xs font-medium transition-colors ${o==="all"?"bg-slate-700 text-white":"bg-slate-100 text-slate-600 hover:bg-slate-200"}`,children:["All (",y.total,")"]}),i.jsxs("button",{onClick:()=>l("cited"),className:`px-3 py-1 rounded-full text-xs font-medium transition-colors ${o==="cited"?"bg-green-600 text-white":"bg-green-100 text-green-700 hover:bg-green-200"}`,children:["Cited (",y.cited,")"]}),i.jsxs("button",{onClick:()=>l("uncited"),className:`px-3 py-1 rounded-full text-xs font-medium transition-colors ${o==="uncited"?"bg-red-600 text-white":"bg-red-100 text-red-700 hover:bg-red-200"}`,children:["Uncited (",y.uncited,")"]}),i.jsxs("button",{onClick:()=>l("contradicted"),className:`px-3 py-1 rounded-full text-xs font-medium transition-colors ${o==="contradicted"?"bg-amber-600 text-white":"bg-amber-100 text-amber-700 hover:bg-amber-200"}`,children:["Contradicted (",y.contradicted,")"]})]}),i.jsxs("div",{className:"flex gap-3 text-sm",children:[i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx("label",{className:"text-slate-500",children:"Type:"}),i.jsxs("select",{value:d,onChange:S=>h(S.target.value),className:"border rounded px-2 py-1 text-xs",children:[i.jsx("option",{value:"all",children:"All Types"}),C.map(S=>{var k;return i.jsx("option",{value:S,children:((k=pp[S])==null?void 0:k.label)||S},S)})]})]}),i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx("label",{className:"text-slate-500",children:"Sort:"}),i.jsxs("select",{value:u,onChange:S=>p(S.target.value),className:"border rounded px-2 py-1 text-xs",children:[i.jsx("option",{value:"section",children:"By Section"}),i.jsx("option",{value:"type",children:"By Type"}),i.jsx("option",{value:"citations",children:"By Citations"})]})]})]})]}),i.jsx("div",{className:"max-h-[600px] overflow-y-auto",children:_.length===0?i.jsxs("div",{className:"p-8 text-center text-slate-500",children:[i.jsx("p",{className:"text-lg mb-2",children:"No claims match your filters"}),i.jsx("p",{className:"text-sm",children:"Try adjusting your filter criteria"})]}):i.jsxs("table",{className:"w-full",children:[i.jsx("thead",{className:"bg-slate-50 sticky top-0",children:i.jsxs("tr",{className:"text-left text-xs text-slate-500 uppercase",children:[i.jsx("th",{className:"px-4 py-2 font-medium",children:"Type"}),i.jsx("th",{className:"px-4 py-2 font-medium",children:"Claim"}),i.jsx("th",{className:"px-4 py-2 font-medium",children:"Section"}),i.jsx("th",{className:"px-4 py-2 font-medium text-center",children:"Citations"}),i.jsx("th",{className:"px-4 py-2 font-medium text-center",children:"Status"}),i.jsx("th",{className:"px-4 py-2 font-medium"})]})}),i.jsx("tbody",{className:"divide-y",children:_.map(S=>{const k=E(S.id),M=pp[S.claim_type]||{label:S.claim_type,icon:"Note",color:"bg-gray-100 text-gray-700 border-gray-200"},L=m.has(S.id);return i.jsxs("tr",{className:`hover:bg-slate-50 cursor-pointer ${b(S)===0?"bg-red-50/30":""} ${k.length>0?"bg-amber-50/30":""}`,onClick:()=>R(S.id),children:[i.jsx("td",{className:"px-4 py-3",children:i.jsxs("span",{className:`inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs border ${M.color}`,children:[i.jsx("span",{children:M.icon}),i.jsx("span",{className:"hidden sm:inline",children:M.label})]})}),i.jsxs("td",{className:"px-4 py-3",children:[i.jsx("p",{className:`text-sm text-slate-700 ${L?"":"line-clamp-2"}`,children:g(S)}),L&&i.jsxs("div",{className:"mt-3 space-y-2",children:[b(S)>0&&i.jsxs("div",{className:"bg-green-50 rounded p-2",children:[i.jsxs("p",{className:"text-xs font-medium text-green-700 mb-1",children:["Citations (",b(S),")"]}),A(S).map((O,$)=>i.jsxs("div",{className:"text-xs text-green-600 ml-2",children:["• ",N(O.evidence_id),O.page&&` (p. ${O.page})`,O.excerpt&&i.jsxs("span",{className:"text-green-500 italic ml-1",children:['"',O.excerpt.slice(0,50),'..."']})]},$))]}),k.length>0&&i.jsxs("div",{className:"bg-amber-50 rounded p-2",children:[i.jsxs("p",{className:"text-xs font-medium text-amber-700 mb-1",children:["Contradictions (",k.length,")"]}),k.map(O=>i.jsxs("div",{className:"text-xs text-amber-600 ml-2",children:["• ",O.type," (",O.resolution_status,")",O.description&&`: ${O.description}`]},O.id))]}),S.confidence&&i.jsxs("div",{className:"text-xs",children:[i.jsx("span",{className:"text-slate-500",children:"Confidence:"})," ",i.jsx("span",{className:`font-medium ${S.confidence==="high"?"text-green-600":S.confidence==="medium"?"text-amber-600":"text-red-600"}`,children:S.confidence.charAt(0).toUpperCase()+S.confidence.slice(1)})]})]})]}),i.jsx("td",{className:"px-4 py-3",children:i.jsx("span",{className:"text-xs text-slate-500",children:j(S.section_id)})}),i.jsx("td",{className:"px-4 py-3 text-center",children:i.jsx("span",{className:`inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-medium ${b(S)>0?"bg-green-100 text-green-700":"bg-red-100 text-red-700"}`,children:b(S)})}),i.jsx("td",{className:"px-4 py-3 text-center",children:i.jsxs("div",{className:"flex items-center justify-center gap-1",children:[b(S)===0&&i.jsx("span",{className:"text-red-500",title:"Uncited - needs citation",children:"Warning"}),k.length>0&&i.jsx("span",{className:"text-amber-500",title:"Has contradictions",children:"Conflict"}),b(S)>0&&k.length===0&&i.jsx("span",{className:"text-green-500",title:"Cited and clear",children:"OK"})]})}),i.jsx("td",{className:"px-4 py-3",children:i.jsxs("div",{className:"flex gap-1",children:[b(S)===0&&a&&i.jsx("button",{onClick:O=>{O.stopPropagation(),a(S.id)},className:"text-xs text-purple-600 hover:text-purple-800 hover:underline",children:"+ Add Citation"}),i.jsx("button",{onClick:O=>{O.stopPropagation(),n==null||n(S)},className:"text-xs text-slate-500 hover:text-slate-700",children:L?"▲":"▼"})]})})]},S.id)})})]})}),y.uncited>0&&i.jsx("div",{className:"p-3 bg-red-50 border-t",children:i.jsxs("p",{className:"text-xs text-red-700",children:["Warning: ",i.jsxs("strong",{children:[y.uncited," claim",y.uncited>1?"s":""]})," without citations. Factual claims require citation anchors for court defensibility."]})})]})}const yc={direct:{label:"Direct Contradiction",icon:"Conflict",description:"Explicit factual conflict between two sources",example:'"Miranda was read" vs "Miranda was not read"',crossExamRisk:"Attorney will highlight the exact conflict and demand explanation"},omission:{label:"Omission Contradiction",icon:"Issue",description:"Key detail absent from contemporaneous records but appears later",example:"Trauma not mentioned in ER records but claimed in later interview",crossExamRisk:`"Why wasn't this documented at the time?"`},temporal_drift:{label:"Temporal Drift",icon:"Timeline",description:"Account changes across different time points",example:"Initial statement differs from deposition differs from trial testimony",crossExamRisk:'"Your story has changed three times. Which version is true?"'},contextual_drift:{label:"Contextual Drift",icon:"Witness",description:"Presentation differs based on setting or audience",example:"Presents differently in jail intake vs court interview vs family visit",crossExamRisk:'"Why did symptoms appear only when being evaluated?"'},method_result:{label:"Method-Result Conflict",icon:"Metrics",description:"Test results conflict with self-report or clinical observation",example:"Claims severe impairment but validity indices suggest overreporting",crossExamRisk:`"The tests don't support what the evaluee claims"`},document_chain:{label:"Document Chain Conflict",icon:"Document",description:"Later document contradicts contemporaneous note",example:"Attorney letter contradicts original police report",crossExamRisk:'"This letter was written after litigation began"'}};function vb({contradictions:c,claims:e,sections:t,onAddContradiction:s,onResolveContradiction:n,onUpdateContradiction:a}){const[o,l]=T.useState("all"),[d,h]=T.useState("all"),[u,p]=T.useState(null),[m,f]=T.useState(!1),g=j=>{const E=e.find(_=>_.id===j);return(E==null?void 0:E.claim_text)||(E==null?void 0:E.text)||"Unknown claim"},b=T.useMemo(()=>c.filter(j=>!(o!=="all"&&j.type!==o||d==="unresolved"&&j.resolution_status!=="unresolved"||d==="resolved"&&j.resolution_status==="unresolved")),[c,o,d]),A=T.useMemo(()=>{const j={direct:[],omission:[],temporal_drift:[],contextual_drift:[],method_result:[],document_chain:[]};return c.forEach(E=>{j[E.type]&&j[E.type].push(E)}),j},[c]),N=T.useMemo(()=>({total:c.length,unresolved:c.filter(j=>j.resolution_status==="unresolved").length,impactingOpinions:c.filter(j=>j.impacts_opinion&&j.resolution_status==="unresolved").length,critical:c.filter(j=>j.severity==="critical").length}),[c]);return i.jsxs("div",{className:"bg-white rounded-xl border shadow-sm overflow-hidden",children:[i.jsxs("div",{className:"p-4 border-b bg-gradient-to-r from-red-50 to-white",children:[i.jsxs("div",{className:"flex items-center justify-between mb-3",children:[i.jsx("div",{children:i.jsxs("h2",{className:"font-bold text-slate-800 text-lg flex items-center gap-2",children:["Contradiction Intelligence",i.jsx("span",{className:"text-sm font-normal text-slate-500",children:"Cross-Exam Radar"})]})}),i.jsx("button",{onClick:s,className:"px-3 py-1.5 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700",children:"+ Add Contradiction"})]}),i.jsxs("div",{className:"flex gap-4 text-sm",children:[i.jsxs("div",{className:`px-3 py-1 rounded-full ${N.unresolved>0?"bg-red-100 text-red-700":"bg-green-100 text-green-700"}`,children:[N.unresolved," unresolved"]}),N.impactingOpinions>0&&i.jsxs("div",{className:"px-3 py-1 rounded-full bg-red-200 text-red-800",children:["Warning: ",N.impactingOpinions," affecting opinions"]}),N.critical>0&&i.jsxs("div",{className:"px-3 py-1 rounded-full bg-red-300 text-red-900",children:[N.critical," critical"]})]})]}),i.jsxs("div",{className:"p-3 border-b bg-slate-50",children:[i.jsxs("div",{className:"flex flex-wrap gap-2",children:[i.jsxs("button",{onClick:()=>l("all"),className:`px-2 py-1 rounded text-xs font-medium transition-colors ${o==="all"?"bg-slate-700 text-white":"bg-white text-slate-600 border hover:bg-slate-100"}`,children:["All (",N.total,")"]}),Object.keys(yc).map(j=>{const E=A[j].length;return E===0?null:i.jsxs("button",{onClick:()=>l(j),className:`px-2 py-1 rounded text-xs font-medium transition-colors ${o===j?"bg-red-600 text-white":"bg-white text-slate-600 border hover:bg-slate-100"}`,children:[yc[j].icon," ",yc[j].label.split(" ")[0]," (",E,")"]},j)})]}),i.jsxs("div",{className:"flex gap-2 mt-2",children:[i.jsx("button",{onClick:()=>h("all"),className:`px-2 py-0.5 rounded text-xs ${d==="all"?"bg-slate-200":""}`,children:"All Status"}),i.jsx("button",{onClick:()=>h("unresolved"),className:`px-2 py-0.5 rounded text-xs ${d==="unresolved"?"bg-red-200 text-red-700":""}`,children:"Unresolved Only"}),i.jsx("button",{onClick:()=>h("resolved"),className:`px-2 py-0.5 rounded text-xs ${d==="resolved"?"bg-green-200 text-green-700":""}`,children:"Resolved"})]})]}),i.jsx("div",{className:"max-h-[500px] overflow-y-auto divide-y",children:b.length===0?i.jsx("div",{className:"p-8 text-center",children:c.length===0?i.jsxs(i.Fragment,{children:[i.jsx("p",{className:"text-slate-500 mb-2",children:"No contradictions detected"}),i.jsx("p",{className:"text-xs text-slate-400",children:"Contradictions are identified during evidence review and claim extraction"})]}):i.jsx("p",{className:"text-slate-500",children:"No contradictions match your filters"})}):b.map(j=>{const E=yc[j.type],_=u===j.id;return i.jsxs("div",{className:`p-4 hover:bg-slate-50 ${j.resolution_status==="unresolved"&&j.impacts_opinion?"bg-red-50/50":""}`,children:[i.jsxs("div",{className:"flex items-start gap-3 cursor-pointer",onClick:()=>p(_?null:j.id),children:[i.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center text-lg ${j.severity==="critical"?"bg-red-200":j.severity==="high"?"bg-amber-200":"bg-slate-200"}`,children:E.icon}),i.jsxs("div",{className:"flex-1 min-w-0",children:[i.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[i.jsx("span",{className:"font-medium text-slate-700",children:E.label}),i.jsx("span",{className:`px-1.5 py-0.5 rounded text-xs ${j.resolution_status==="unresolved"?"bg-red-100 text-red-700":j.resolution_status==="partially_resolved"?"bg-amber-100 text-amber-700":"bg-green-100 text-green-700"}`,children:j.resolution_status}),j.impacts_opinion&&j.resolution_status==="unresolved"&&i.jsx("span",{className:"px-1.5 py-0.5 rounded text-xs bg-red-200 text-red-800",children:"Affects Opinion"})]}),i.jsxs("div",{className:"text-sm text-slate-600 space-y-1",children:[i.jsxs("div",{className:"flex gap-2",children:[i.jsx("span",{className:"text-red-500 font-mono",children:"A:"}),i.jsx("span",{className:"line-clamp-1",children:j.claim_a_text||g(j.claim_a_id)})]}),i.jsxs("div",{className:"flex gap-2",children:[i.jsx("span",{className:"text-blue-500 font-mono",children:"B:"}),i.jsx("span",{className:"line-clamp-1",children:j.claim_b_text||g(j.claim_b_id)})]})]})]}),i.jsx("span",{className:"text-slate-400",children:_?"▲":"▼"})]}),_&&i.jsxs("div",{className:"mt-4 ml-11 space-y-4",children:[j.description&&i.jsxs("div",{className:"text-sm text-slate-600",children:[i.jsx("span",{className:"font-medium",children:"Description: "}),j.description]}),i.jsxs("div",{className:"bg-slate-50 rounded-lg p-3 space-y-2",children:[i.jsx("p",{className:"text-sm text-slate-600",children:E.description}),i.jsxs("p",{className:"text-xs text-slate-500",children:[i.jsx("span",{className:"font-medium",children:"Example: "}),E.example]}),i.jsxs("p",{className:"text-xs text-red-600",children:[i.jsx("span",{className:"font-medium",children:"Cross-exam risk: "}),E.crossExamRisk]})]}),i.jsxs("div",{className:"bg-purple-50 rounded-lg p-3 space-y-2",children:[i.jsx("p",{className:"text-sm font-medium text-purple-700",children:"Resolution Questions:"}),i.jsxs("ul",{className:"text-sm text-purple-600 space-y-1",children:[i.jsx("li",{children:"• What would resolve this contradiction?"}),i.jsx("li",{children:"• Does this lower confidence in your opinions?"}),i.jsx("li",{children:"• Should this appear in Limitations?"})]}),j.what_would_resolve&&i.jsxs("div",{className:"mt-2 p-2 bg-white rounded border",children:[i.jsx("p",{className:"text-xs font-medium text-slate-500",children:"What would resolve:"}),i.jsx("p",{className:"text-sm text-slate-700",children:j.what_would_resolve})]})]}),j.resolution_note&&i.jsxs("div",{className:"bg-green-50 rounded-lg p-3",children:[i.jsx("p",{className:"text-sm font-medium text-green-700",children:"Resolution Note:"}),i.jsx("p",{className:"text-sm text-green-600",children:j.resolution_note})]}),i.jsxs("div",{className:"flex gap-2",children:[j.resolution_status==="unresolved"&&i.jsxs(i.Fragment,{children:[i.jsx("button",{onClick:()=>n==null?void 0:n(j.id,"resolved"),className:"px-3 py-1.5 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700",children:"Mark Resolved"}),i.jsx("button",{onClick:()=>n==null?void 0:n(j.id,"addressed_in_limitations"),className:"px-3 py-1.5 bg-amber-600 text-white text-sm rounded-lg hover:bg-amber-700",children:"Add to Limitations"})]}),i.jsx("button",{className:"px-3 py-1.5 border text-slate-600 text-sm rounded-lg hover:bg-slate-50",children:"Edit Details"})]})]})]},j.id)})}),N.unresolved>0&&i.jsx("div",{className:"p-3 border-t bg-red-50",children:i.jsxs("p",{className:"text-xs text-red-700",children:["Warning: ",N.unresolved," unresolved contradiction(s) require attention before finalizing.",N.impactingOpinions>0&&i.jsxs("span",{className:"font-medium",children:[" ",N.impactingOpinions," affect your opinions."]})]})})]})}const yb={default:["Evaluation procedures","Sources of information","Methods and measures","Limitations"]},wb=["record_fact","test_result","observation"],Nb=["self_report","collateral"],jb=["forensic_opinion","opinion","ultimate_opinion","inference"];function Ab({claims:c,evidence:e,contradictions:t,validation:s,sections:n,referralQuestions:a,onBlockerClick:o}){const l=T.useMemo(()=>{var us;const u=[],p=[],m=[],f=c.filter(Q=>wb.includes(Q.claim_type)),g=f.filter(Q=>Q.citations&&Q.citations.length>0),b=f.length>0?Math.round(g.length/f.length*100):100;if(b<100&&f.length>0){const Q=f.length-g.length;u.push(`${Q} factual claim(s) without citation anchors`)}const A=t.filter(Q=>Q.resolution_status==="unresolved"),N=A.filter(Q=>Q.impacts_opinion!==!1),j=t.length>0?Math.round((t.length-A.length)/t.length*100):100;N.length>0?u.push(`${N.length} unresolved contradiction(s) affecting opinions`):A.length>0&&p.push(`${A.length} unresolved contradiction(s) (not affecting opinions)`);const E=c.filter(Q=>Nb.includes(Q.claim_type)),_=E,y=E.length>0?Math.round(_.length/E.length*100):100,C=c.filter(Q=>{var Ms;return Q.claim_type==="record_fact"&&((Ms=Q.citations)==null?void 0:Ms.some(ps=>typeof ps=="object"&&ps.source_type==="self_report"))});C.length>0&&u.push(`${C.length} claim(s) treating hearsay as fact`);const R=(s==null?void 0:s.issues.filter(Q=>Q.issue_type.includes("validity")||Q.issue_type.includes("response_style")))||[],S=n.find(Q=>Q.section_type==="limitations"||Q.title.toLowerCase().includes("limitation")),k=((us=S==null?void 0:S.content)==null?void 0:us.toLowerCase().includes("validity"))||!1,M=R.length>0?k?100:0:100;R.length>0&&!k&&u.push("Validity concerns present but not addressed in Limitations");const L=n.filter(Q=>Q.section_type==="methods"||Q.section_type==="procedures"||Q.title.toLowerCase().includes("method")||Q.title.toLowerCase().includes("procedure")),O=L.length>0&&L.some(Q=>Q.content&&Q.content.length>100),$=yb.default,q=n.map(Q=>Q.title.toLowerCase()),F=$.filter(Q=>!q.some(Ms=>Ms.includes(Q.toLowerCase()))),P=O?Math.round(($.length-F.length)/$.length*100):0;O?F.length>0&&p.push(`Methodology may be missing: ${F.join(", ")}`):u.push("No methodology/procedures section");const I=e.length>0,K=c.length>0,ue=[I,K,!0],te=Math.round(ue.filter(Boolean).length/ue.length*100);I||p.push("No evidence inventory for verification");const V=c.filter(Q=>jb.includes(Q.claim_type)),le=V.filter(Q=>!Q.citations||Q.citations.length===0);le.length>0&&u.push(`${le.length} opinion(s) without supporting claims/citations`);const ye=V.map(Q=>(Q.claim_text||Q.text||"").toLowerCase()).join(" "),z=a.filter(Q=>!Q.toLowerCase().split(" ").filter(ps=>ps.length>4).some(ps=>ye.includes(ps)));z.length>0&&u.push(`${z.length} referral question(s) not addressed in opinions`);const Se=e.filter(Q=>Q.authenticity_status==="unconfirmed"||!Q.authenticity_status);Se.length>e.length*.5&&p.push(`${Se.length} evidence item(s) without confirmed authenticity`);const he={citationCoverage:.25,contradictionResolution:.25,hearsayLabeling:.15,validityConcernsHandled:.15,methodologyCompleteness:.1,exportVerifiability:.1},hs=Math.round(b*he.citationCoverage+j*he.contradictionResolution+y*he.hearsayLabeling+M*he.validityConcernsHandled+P*he.methodologyCompleteness+te*he.exportVerifiability);let Ps;return u.length===0&&hs>=85?Ps="stable":u.length<=2&&hs>=60?Ps="needs_work":Ps="dangerous",b<100&&m.push("Add citation anchors to all factual claims"),j<100&&m.push("Resolve contradictions or document in Limitations"),P<80&&m.push("Complete methodology/procedures section"),V.length===0&&m.push("Add forensic opinions addressing referral questions"),{citationCoverage:b,contradictionResolution:j,hearsayLabeling:y,validityConcernsHandled:M,methodologyCompleteness:P,exportVerifiability:te,overallScore:hs,status:Ps,details:{totalFactualClaims:f.length,citedFactualClaims:g.length,totalContradictions:t.length,unresolvedContradictions:A.length,contradictionsImpactingOpinions:N.length,selfReportClaims:E.length,labeledSelfReportClaims:_.length,validityConcerns:R.length,addressedValidityConcerns:k?R.length:0,methodologySections:L.map(Q=>Q.title),missingMethodologySections:F},blockers:u,warnings:p,recommendations:m}},[c,e,t,s,n,a]),h={stable:{bg:"bg-green-500",text:"text-green-700",bgLight:"bg-green-50",border:"border-green-200",label:"Stable Under Hostile Review",description:"Report is defensible and ready for cross-examination"},needs_work:{bg:"bg-amber-500",text:"text-amber-700",bgLight:"bg-amber-50",border:"border-amber-200",label:"Needs Work",description:"Address blockers before finalizing"},dangerous:{bg:"bg-red-500",text:"text-red-700",bgLight:"bg-red-50",border:"border-red-200",label:"High Risk to File",description:"Critical issues that could result in impeachment"}}[l.status];return i.jsxs("div",{className:`bg-white rounded-xl border shadow-sm overflow-hidden ${h.border}`,children:[i.jsxs("div",{className:`p-4 ${h.bgLight}`,children:[i.jsxs("div",{className:"flex items-center justify-between mb-3",children:[i.jsxs("div",{children:[i.jsx("h2",{className:"font-bold text-slate-800 text-lg",children:"Cross-Exam Readiness"}),i.jsx("p",{className:`text-sm ${h.text}`,children:h.label})]}),i.jsxs("div",{className:"text-right",children:[i.jsxs("div",{className:`text-4xl font-bold ${h.text}`,children:[l.overallScore,"%"]}),i.jsx("div",{className:"text-xs text-slate-500",children:"Defensibility Score"})]})]}),i.jsx("div",{className:"h-4 bg-slate-200 rounded-full overflow-hidden",children:i.jsx("div",{className:`h-full ${h.bg} transition-all duration-500`,style:{width:`${l.overallScore}%`}})}),i.jsx("p",{className:"text-xs text-slate-500 mt-2",children:h.description})]}),i.jsxs("div",{className:"p-4 border-t",children:[i.jsx("h3",{className:"text-sm font-semibold text-slate-700 mb-3",children:"Metric Breakdown"}),i.jsxs("div",{className:"space-y-3",children:[i.jsx(Ua,{label:"Citation Coverage",value:l.citationCoverage,detail:`${l.details.citedFactualClaims}/${l.details.totalFactualClaims} factual claims cited`}),i.jsx(Ua,{label:"Contradiction Resolution",value:l.contradictionResolution,detail:`${l.details.unresolvedContradictions} unresolved of ${l.details.totalContradictions}`}),i.jsx(Ua,{label:"Hearsay Labeling",value:l.hearsayLabeling,detail:`${l.details.selfReportClaims} self-report/collateral claims`}),i.jsx(Ua,{label:"Validity Concerns",value:l.validityConcernsHandled,detail:`${l.details.addressedValidityConcerns}/${l.details.validityConcerns} addressed`}),i.jsx(Ua,{label:"Methodology",value:l.methodologyCompleteness,detail:l.details.missingMethodologySections.length>0?`Missing: ${l.details.missingMethodologySections.slice(0,2).join(", ")}`:"Complete"}),i.jsx(Ua,{label:"Export Verifiability",value:l.exportVerifiability,detail:"Evidence inventory + claim ledger + audit"})]})]}),l.blockers.length>0&&i.jsxs("div",{className:"p-4 border-t bg-red-50",children:[i.jsxs("h3",{className:"text-sm font-semibold text-red-700 mb-2 flex items-center gap-2",children:[i.jsx("span",{children:"Blocker"})," Blockers (",l.blockers.length,")"]}),i.jsx("ul",{className:"space-y-1",children:l.blockers.map((u,p)=>i.jsxs("li",{className:"text-sm text-red-600 flex items-start gap-2 cursor-pointer hover:text-red-800",onClick:()=>o==null?void 0:o(u),children:[i.jsx("span",{className:"text-red-400",children:"•"}),u]},p))})]}),l.warnings.length>0&&i.jsxs("div",{className:"p-4 border-t bg-amber-50",children:[i.jsxs("h3",{className:"text-sm font-semibold text-amber-700 mb-2 flex items-center gap-2",children:[i.jsx("span",{children:"Warning"})," Warnings (",l.warnings.length,")"]}),i.jsx("ul",{className:"space-y-1",children:l.warnings.map((u,p)=>i.jsxs("li",{className:"text-sm text-amber-600 flex items-start gap-2",children:[i.jsx("span",{className:"text-amber-400",children:"•"}),u]},p))})]}),l.recommendations.length>0&&l.status!=="stable"&&i.jsxs("div",{className:"p-4 border-t",children:[i.jsx("h3",{className:"text-sm font-semibold text-slate-700 mb-2",children:"Next Steps"}),i.jsx("ul",{className:"space-y-1",children:l.recommendations.slice(0,3).map((u,p)=>i.jsxs("li",{className:"text-sm text-slate-600 flex items-start gap-2",children:[i.jsxs("span",{className:"text-purple-500",children:[p+1,"."]}),u]},p))})]}),i.jsx("div",{className:"p-3 border-t bg-slate-50 text-center",children:i.jsx("p",{className:"text-xs text-slate-500",children:"Metrics are mechanically grounded • Not vibes"})})]})}function Ua({label:c,value:e,detail:t}){const s=e>=90?"bg-green-500":e>=70?"bg-amber-500":e>=50?"bg-orange-500":"bg-red-500";return i.jsxs("div",{children:[i.jsxs("div",{className:"flex justify-between text-xs mb-1",children:[i.jsx("span",{className:"font-medium text-slate-700",children:c}),i.jsxs("span",{className:e>=70?"text-green-600":"text-amber-600",children:[e,"%"]})]}),i.jsx("div",{className:"h-2 bg-slate-200 rounded-full overflow-hidden",children:i.jsx("div",{className:`h-full ${s} transition-all`,style:{width:`${e}%`}})}),i.jsx("p",{className:"text-xs text-slate-400 mt-0.5",children:t})]})}const mp={child_custody:{requiredSections:["Evaluation Procedures","Sources of Information","Psychological Testing","Parent Interviews","Child Interviews","Collateral Contacts","Behavioral Observations","Limitations"],standardMethods:["Clinical interviews with each parent","Clinical interview(s) with the child(ren)","Parent-child interaction observations","Review of relevant records","Psychological testing of parents","Collateral contacts"],commonLimitations:["This evaluation represents a snapshot in time","Collateral information was obtained from potentially biased sources","Children's statements may be influenced by situational factors","Custody recommendations are based on current circumstances"],standardTests:["Validity indicators (standardized response consistency scales)","PAI","Parenting Stress Index","CBCL (Child Behavior Checklist)","Parent-Child Relationship Inventory"]},competency:{requiredSections:["Evaluation Procedures","Sources of Information","Competency Assessment Methods","Mental Status Examination","Relevant History","Limitations"],standardMethods:["Clinical interview focused on competency-related abilities","Structured competency assessment instrument","Mental status examination","Review of legal records and charges","Review of psychiatric/medical records"],commonLimitations:["Competency is situation-specific and may change over time","Defendant's presentation may differ in actual court proceedings","Assessment reflects current functioning only"],standardTests:["MacCAT-CA","ECST-R","CAST-MR (if intellectual disability suspected)","Cognitive screening"]},criminal_responsibility:{requiredSections:["Evaluation Procedures","Sources of Information","Mental State at Time of Offense Assessment","Psychological Testing","Relevant History","Limitations"],standardMethods:["Detailed clinical interview about the offense","Timeline reconstruction of the offense period","Review of police reports and witness statements","Psychiatric history review","Substance use assessment"],commonLimitations:["Retrospective assessment of mental state is inherently limited","Self-report of mental state at time of offense cannot be independently verified","Time elapsed since offense affects accuracy of recollection"],standardTests:["R-CRAS","MSE-3R","Validity indicators / PAI","Structured malingering measures"]},disability:{requiredSections:["Evaluation Procedures","Sources of Information","Functional Assessment","Psychological Testing","Work History","Limitations"],standardMethods:["Clinical interview focusing on functional limitations","Detailed work history review","Activities of daily living assessment","Symptom validity testing","Review of medical records"],commonLimitations:["Functional capacity may vary day to day","Assessment represents a single point in time","Self-reported limitations require corroboration"],standardTests:["Validity indicators / PAI","Cognitive testing (as indicated)","Symptom validity tests","Functional capacity measures"]},default:{requiredSections:["Evaluation Procedures","Sources of Information","Methods and Measures","Limitations"],standardMethods:["Clinical interview","Review of relevant records","Psychological testing (as indicated)","Collateral contacts (as appropriate)"],commonLimitations:["This evaluation represents a snapshot in time","Conclusions are based on available information"],standardTests:[]}};function _b({evidence:c,evaluationType:e,onGenerate:t,existingContent:s}){const n=mp[e]||mp.default,[a,o]=T.useState({evaluationType:e,evaluationDates:[],evaluationSetting:"in_person",testsAdministered:[],interviews:[],recordsReviewed:c,methodsUsed:n.standardMethods,limitationsNoted:n.commonLimitations,whatWasNotDone:[]}),[l,d]=T.useState(!1),[h,u]=T.useState(""),p=T.useMemo(()=>{const m=[];return m.push(`## METHODOLOGY AND PROCEDURES
`),m.push(`### Evaluation Setting and Procedures
`),m.push(`This evaluation was conducted ${a.evaluationSetting==="telehealth"?"via telehealth":"in person"}${a.evaluationLocation?` at ${a.evaluationLocation}`:""}.`),a.evaluationDates.length>0&&m.push(` Evaluation session(s) occurred on: ${a.evaluationDates.join(", ")}.`),a.totalDuration&&m.push(` Total evaluation time was approximately ${a.totalDuration}.`),a.language&&a.language!=="English"&&m.push(` The evaluation was conducted in ${a.language}${a.interpreter?" with interpreter assistance":""}.`),m.push(`
`),m.push(`### Methods Employed
`),m.push(`The following methods were used in this evaluation:
`),a.methodsUsed.forEach(f=>{m.push(`- ${f}`)}),m.push(`
`),m.push(`### Sources of Information
`),m.push(`A total of ${a.recordsReviewed.length} documents/records were reviewed:
`),a.recordsReviewed.slice(0,15).forEach(f=>{const g=typeof f.evidence_type=="string"?f.evidence_type:"document";m.push(`- ${f.filename} (${g})`)}),a.recordsReviewed.length>15&&m.push(`- ... and ${a.recordsReviewed.length-15} additional documents (see Evidence Inventory)`),m.push(`
`),a.interviews.length>0&&(m.push(`### Interviews Conducted
`),a.interviews.forEach(f=>{m.push(`- ${f.subject} (${f.role}): ${f.date}, ${f.mode}${f.duration?`, approximately ${f.duration}`:""}`)}),m.push(`
`)),a.testsAdministered.length>0&&(m.push(`### Psychological Testing
`),m.push(`The following measures were administered:
`),a.testsAdministered.forEach(f=>{let g=`- ${f.name} (${f.date}, ${f.mode})`;f.validityConsidered&&(g+=" - validity indices reviewed"),m.push(g)}),m.push(`
`)),a.evaluationSetting==="telehealth"&&(m.push(`### Telehealth Considerations
`),m.push(`This evaluation was conducted via telehealth technology. The following considerations apply:
`),m.push("- Visual and audio connection quality was monitored throughout"),m.push("- The evaluee confirmed they were in a private location"),m.push("- Certain observational data (e.g., full range of psychomotor behavior) may be limited"),m.push("- Test administration followed telehealth-adapted protocols where available"),m.push(`
`)),a.whatWasNotDone.length>0&&(m.push(`### Procedures Not Performed
`),m.push(`The following procedures were not performed in this evaluation:
`),a.whatWasNotDone.forEach(f=>{m.push(`- ${f}`)}),m.push(`
`)),m.push(`### Limitations
`),m.push(`The following limitations apply to this evaluation:
`),a.limitationsNoted.forEach(f=>{m.push(`- ${f}`)}),m.push(`
`),m.push(`### Error Mitigation
`),m.push(`To mitigate potential sources of error, this evaluation employed:
`),m.push("- Multi-method assessment approach"),m.push("- Corroboration of self-report with records and collateral information"),a.testsAdministered.some(f=>f.validityConsidered)&&m.push("- Review of validity indices on psychological measures"),m.push("- Consideration of alternative explanations"),m.push(`
`),m.join(`
`)},[a]);return i.jsxs("div",{className:"bg-white rounded-xl border shadow-sm overflow-hidden",children:[i.jsxs("div",{className:"p-4 border-b bg-gradient-to-r from-blue-50 to-white",children:[i.jsx("h2",{className:"font-bold text-slate-800 text-lg flex items-center gap-2",children:"Methodology Appendix Generator"}),i.jsx("p",{className:"text-sm text-slate-500",children:"Auto-generates Daubert/Frye ready methodology section"})]}),i.jsxs("div",{className:"p-4 border-b space-y-4",children:[i.jsxs("div",{children:[i.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:"Evaluation Setting"}),i.jsx("div",{className:"flex gap-2",children:["in_person","telehealth","mixed"].map(m=>i.jsx("button",{onClick:()=>o(f=>({...f,evaluationSetting:m})),className:`px-3 py-1.5 rounded-lg text-sm ${a.evaluationSetting===m?"bg-blue-600 text-white":"bg-slate-100 text-slate-600 hover:bg-slate-200"}`,children:m==="in_person"?"In Person":m==="telehealth"?"Telehealth":"Mixed"},m))})]}),i.jsxs("div",{children:[i.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:"Methods Used"}),i.jsx("div",{className:"space-y-1",children:n.standardMethods.map((m,f)=>i.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[i.jsx("input",{type:"checkbox",checked:a.methodsUsed.includes(m),onChange:g=>{g.target.checked?o(b=>({...b,methodsUsed:[...b.methodsUsed,m]})):o(b=>({...b,methodsUsed:b.methodsUsed.filter(A=>A!==m)}))},className:"rounded"}),m]},f))})]}),n.standardTests.length>0&&i.jsxs("div",{children:[i.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:"Tests Administered"}),i.jsx("div",{className:"space-y-1",children:n.standardTests.map((m,f)=>i.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[i.jsx("input",{type:"checkbox",checked:a.testsAdministered.some(g=>g.name===m),onChange:g=>{g.target.checked?o(b=>({...b,testsAdministered:[...b.testsAdministered,{name:m,date:"",mode:b.evaluationSetting==="telehealth"?"telehealth":"in_person",validityConsidered:!0}]})):o(b=>({...b,testsAdministered:b.testsAdministered.filter(A=>A.name!==m)}))},className:"rounded"}),m]},f))})]}),i.jsxs("div",{children:[i.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:"Limitations to Include"}),i.jsx("div",{className:"space-y-1",children:n.commonLimitations.map((m,f)=>i.jsxs("label",{className:"flex items-start gap-2 text-sm",children:[i.jsx("input",{type:"checkbox",checked:a.limitationsNoted.includes(m),onChange:g=>{g.target.checked?o(b=>({...b,limitationsNoted:[...b.limitationsNoted,m]})):o(b=>({...b,limitationsNoted:b.limitationsNoted.filter(A=>A!==m)}))},className:"rounded mt-0.5"}),i.jsx("span",{className:"text-slate-600",children:m})]},f))}),i.jsxs("div",{className:"mt-2 flex gap-2",children:[i.jsx("input",{type:"text",value:h,onChange:m=>u(m.target.value),placeholder:"Add custom limitation...",className:"flex-1 px-3 py-1.5 text-sm border rounded-lg"}),i.jsx("button",{onClick:()=>{h.trim()&&(o(m=>({...m,limitationsNoted:[...m.limitationsNoted,h.trim()]})),u(""))},className:"px-3 py-1.5 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700",children:"Add"})]})]}),i.jsx("button",{onClick:()=>d(!l),className:"text-sm text-blue-600 hover:text-blue-800",children:l?"▼ Hide Advanced Options":"▶ Show Advanced Options"}),l&&i.jsxs("div",{className:"space-y-3 pt-2 border-t",children:[i.jsxs("div",{children:[i.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:"What Was NOT Done (and Why)"}),i.jsx("textarea",{value:a.whatWasNotDone.join(`
`),onChange:m=>o(f=>({...f,whatWasNotDone:m.target.value.split(`
`).filter(Boolean)})),placeholder:"e.g., Neuropsychological testing was not performed due to time constraints...",className:"w-full px-3 py-2 text-sm border rounded-lg",rows:3})]}),i.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[i.jsxs("div",{children:[i.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:"Total Duration"}),i.jsx("input",{type:"text",value:a.totalDuration||"",onChange:m=>o(f=>({...f,totalDuration:m.target.value})),placeholder:"e.g., 6 hours",className:"w-full px-3 py-1.5 text-sm border rounded-lg"})]}),i.jsxs("div",{children:[i.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:"Language"}),i.jsx("input",{type:"text",value:a.language||"",onChange:m=>o(f=>({...f,language:m.target.value})),placeholder:"English",className:"w-full px-3 py-1.5 text-sm border rounded-lg"})]})]})]})]}),i.jsxs("div",{className:"p-4 border-t bg-slate-50",children:[i.jsxs("div",{className:"flex items-center justify-between mb-2",children:[i.jsx("h3",{className:"text-sm font-medium text-slate-700",children:"Preview"}),i.jsx("button",{onClick:()=>t(p),className:"px-4 py-1.5 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700",children:"Use This Content"})]}),i.jsx("div",{className:"bg-white border rounded-lg p-4 max-h-64 overflow-y-auto",children:i.jsx("pre",{className:"text-xs text-slate-600 whitespace-pre-wrap font-mono",children:p})})]})]})}const Xd=[{id:"legal",label:"Legal/Court",icon:"Legal",color:"blue"},{id:"medical",label:"Medical/Treatment",icon:"Medical",color:"green"},{id:"psychiatric",label:"Psychiatric",icon:"Psych",color:"purple"},{id:"incident",label:"Incident/Event",icon:"Incident",color:"red"},{id:"contact",label:"Contact/Interview",icon:"Contact",color:"amber"},{id:"document",label:"Document Created",icon:"Document",color:"slate"},{id:"other",label:"Other",icon:"Other",color:"gray"}];function Sb({evidence:c,events:e,conflicts:t,onAddEvent:s,onUpdateEvent:n,onResolveConflict:a}){const[o,l]=T.useState("timeline"),[d,h]=T.useState("all"),[u,p]=T.useState("all"),[m,f]=T.useState(null),[g,b]=T.useState(!1),A=T.useMemo(()=>[...e].sort((y,C)=>{const R=new Date(y.date),S=new Date(C.date);return R.getTime()-S.getTime()}),[e]),N=T.useMemo(()=>A.filter(y=>!(d!=="all"&&y.category!==d||u!=="all"&&y.status!==u)),[A,d,u]),j=T.useMemo(()=>({total:e.length,corroborated:e.filter(y=>y.status==="corroborated").length,contradicted:e.filter(y=>y.status==="contradicted").length,unsupported:e.filter(y=>y.status==="unsupported").length,unresolvedConflicts:t.filter(y=>y.resolution_status==="unresolved").length}),[e,t]),E=y=>{const C=c.find(R=>R.id===y);return(C==null?void 0:C.filename)||"Unknown Source"},_=y=>{switch(y){case"corroborated":return{bg:"bg-green-100",border:"border-green-400",text:"text-green-700",icon:"Pass"};case"contradicted":return{bg:"bg-red-100",border:"border-red-400",text:"text-red-700",icon:"Conflict"};case"unsupported":return{bg:"bg-amber-100",border:"border-amber-400",text:"text-amber-700",icon:"?"};case"missing_context":return{bg:"bg-slate-100",border:"border-slate-400",text:"text-slate-700",icon:"…"}}};return i.jsxs("div",{className:"bg-white rounded-xl border shadow-sm overflow-hidden",children:[i.jsxs("div",{className:"p-4 border-b bg-gradient-to-r from-blue-50 to-white",children:[i.jsxs("div",{className:"flex items-center justify-between mb-3",children:[i.jsxs("div",{children:[i.jsx("h2",{className:"font-bold text-slate-800 text-lg flex items-center gap-2",children:"Timeline Builder"}),i.jsx("p",{className:"text-sm text-slate-500",children:"Multi-source chronology with reconciliation"})]}),i.jsx("button",{onClick:()=>b(!0),className:"px-3 py-1.5 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700",children:"+ Add Event"})]}),i.jsxs("div",{className:"flex gap-3 text-sm",children:[i.jsxs("span",{className:"px-2 py-1 bg-slate-100 rounded",children:[j.total," events"]}),i.jsxs("span",{className:"px-2 py-1 bg-green-100 text-green-700 rounded",children:[j.corroborated," corroborated"]}),i.jsxs("span",{className:"px-2 py-1 bg-red-100 text-red-700 rounded",children:[j.contradicted," contradicted"]}),i.jsxs("span",{className:"px-2 py-1 bg-amber-100 text-amber-700 rounded",children:["? ",j.unsupported," unsupported"]}),j.unresolvedConflicts>0&&i.jsxs("span",{className:"px-2 py-1 bg-red-200 text-red-800 rounded",children:[j.unresolvedConflicts," conflicts"]})]})]}),i.jsxs("div",{className:"p-3 border-b bg-slate-50 flex items-center justify-between",children:[i.jsx("div",{className:"flex gap-2",children:["timeline","table","conflicts"].map(y=>i.jsx("button",{onClick:()=>l(y),className:`px-3 py-1 rounded text-sm ${o===y?"bg-blue-600 text-white":"bg-white border hover:bg-slate-100"}`,children:y==="timeline"?"Timeline":y==="table"?"Table":"Conflicts"},y))}),i.jsxs("div",{className:"flex gap-2",children:[i.jsxs("select",{value:d,onChange:y=>h(y.target.value),className:"text-sm border rounded px-2 py-1",children:[i.jsx("option",{value:"all",children:"All Categories"}),Xd.map(y=>i.jsx("option",{value:y.id,children:y.label},y.id))]}),i.jsxs("select",{value:u,onChange:y=>p(y.target.value),className:"text-sm border rounded px-2 py-1",children:[i.jsx("option",{value:"all",children:"All Status"}),i.jsx("option",{value:"corroborated",children:"Corroborated"}),i.jsx("option",{value:"contradicted",children:"Contradicted"}),i.jsx("option",{value:"unsupported",children:"Unsupported"}),i.jsx("option",{value:"missing_context",children:"Missing Context"})]})]})]}),i.jsxs("div",{className:"max-h-[500px] overflow-y-auto",children:[o==="timeline"&&i.jsx("div",{className:"p-4",children:N.length===0?i.jsxs("div",{className:"text-center py-8 text-slate-500",children:[i.jsx("p",{children:"No events match your filters"}),i.jsx("p",{className:"text-sm mt-1",children:"Add events or adjust filters"})]}):i.jsxs("div",{className:"relative",children:[i.jsx("div",{className:"absolute left-4 top-0 bottom-0 w-0.5 bg-slate-200"}),i.jsx("div",{className:"space-y-4",children:N.map((y,C)=>{const R=_(y.status),S=Xd.find(M=>M.id===y.category),k=m===y.id;return i.jsxs("div",{className:"relative pl-10",children:[i.jsx("div",{className:`absolute left-2 w-5 h-5 rounded-full ${R.bg} ${R.border} border-2 flex items-center justify-center text-xs ${R.text}`,children:R.icon}),i.jsxs("div",{className:`p-3 rounded-lg border ${R.border} ${R.bg} cursor-pointer`,onClick:()=>f(k?null:y.id),children:[i.jsxs("div",{className:"flex items-start justify-between mb-1",children:[i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsxs("span",{className:"font-medium text-slate-700",children:[new Date(y.date).toLocaleDateString(),y.time&&` ${y.time}`]}),S&&i.jsx("span",{className:"text-sm",children:S.icon}),i.jsx("span",{className:`text-xs px-1.5 py-0.5 rounded ${R.bg} ${R.text}`,children:y.status.replace("_"," ")})]}),i.jsx("span",{className:"text-slate-400 text-sm",children:k?"▲":"▼"})]}),i.jsx("p",{className:"text-sm text-slate-700 mb-2",children:y.description}),i.jsxs("div",{className:"flex flex-wrap gap-1",children:[y.source_ids.slice(0,3).map((M,L)=>i.jsxs("span",{className:"text-xs px-1.5 py-0.5 bg-white rounded border",children:[y.source_types[L]==="record"?"Record":y.source_types[L]==="self_report"?"Report":y.source_types[L]==="collateral"?"Collateral":"Observation",E(M)]},M)),y.source_ids.length>3&&i.jsxs("span",{className:"text-xs text-slate-500",children:["+",y.source_ids.length-3," more"]})]}),k&&i.jsxs("div",{className:"mt-3 pt-3 border-t space-y-2",children:[i.jsxs("div",{children:[i.jsx("p",{className:"text-xs font-medium text-slate-500 mb-1",children:"Sources:"}),i.jsx("div",{className:"space-y-1",children:y.source_ids.map((M,L)=>i.jsxs("div",{className:"text-sm text-slate-600 flex items-center gap-2",children:[i.jsx("span",{className:`w-2 h-2 rounded-full ${y.source_types[L]==="record"?"bg-blue-500":y.source_types[L]==="self_report"?"bg-amber-500":y.source_types[L]==="collateral"?"bg-purple-500":"bg-green-500"}`}),E(M)," (",y.source_types[L],")"]},M))})]}),y.contradicting_sources&&y.contradicting_sources.length>0&&i.jsxs("div",{className:"p-2 bg-red-50 rounded",children:[i.jsx("p",{className:"text-xs font-medium text-red-700 mb-1",children:"Contradicting Sources:"}),y.contradicting_sources.map(M=>i.jsxs("p",{className:"text-sm text-red-600",children:["• ",E(M)]},M))]}),y.notes&&i.jsxs("div",{className:"text-sm text-slate-600 italic",children:["Note: ",y.notes]}),i.jsxs("div",{className:"flex gap-2 pt-2",children:[i.jsx("button",{className:"text-xs text-blue-600 hover:underline",children:"Edit Event"}),i.jsx("button",{className:"text-xs text-purple-600 hover:underline",children:"Add Source"}),i.jsx("button",{className:"text-xs text-slate-500 hover:underline",children:"Add Note"})]})]})]})]},y.id)})})]})}),o==="table"&&i.jsxs("table",{className:"w-full",children:[i.jsx("thead",{className:"bg-slate-50 sticky top-0",children:i.jsxs("tr",{className:"text-left text-xs text-slate-500 uppercase",children:[i.jsx("th",{className:"px-4 py-2",children:"Date"}),i.jsx("th",{className:"px-4 py-2",children:"Event"}),i.jsx("th",{className:"px-4 py-2",children:"Category"}),i.jsx("th",{className:"px-4 py-2",children:"Sources"}),i.jsx("th",{className:"px-4 py-2",children:"Status"})]})}),i.jsx("tbody",{className:"divide-y",children:N.map(y=>{const C=_(y.status),R=Xd.find(S=>S.id===y.category);return i.jsxs("tr",{className:"hover:bg-slate-50",children:[i.jsx("td",{className:"px-4 py-3 text-sm font-medium",children:new Date(y.date).toLocaleDateString()}),i.jsx("td",{className:"px-4 py-3 text-sm",children:y.description}),i.jsx("td",{className:"px-4 py-3 text-sm",children:R&&`${R.icon} ${R.label}`}),i.jsx("td",{className:"px-4 py-3 text-sm",children:y.source_ids.length}),i.jsx("td",{className:"px-4 py-3",children:i.jsxs("span",{className:`text-xs px-2 py-1 rounded ${C.bg} ${C.text}`,children:[C.icon," ",y.status.replace("_"," ")]})})]},y.id)})})]}),o==="conflicts"&&i.jsx("div",{className:"p-4 space-y-3",children:t.length===0?i.jsxs("div",{className:"text-center py-8 text-green-600",children:[i.jsx("p",{className:"font-medium",children:"No timeline conflicts detected"}),i.jsx("p",{className:"text-sm text-slate-500 mt-1",children:"All events are reconciled"})]}):t.map(y=>i.jsxs("div",{className:`p-4 rounded-lg border ${y.resolution_status==="unresolved"?"bg-red-50 border-red-200":"bg-slate-50 border-slate-200"}`,children:[i.jsx("div",{className:"flex items-start justify-between mb-2",children:i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx("span",{className:`text-sm font-medium ${y.resolution_status==="unresolved"?"text-red-700":"text-slate-700"}`,children:y.conflict_type.replace("_"," ").toUpperCase()}),i.jsx("span",{className:`text-xs px-1.5 py-0.5 rounded ${y.resolution_status==="unresolved"?"bg-red-200 text-red-800":"bg-green-200 text-green-800"}`,children:y.resolution_status})]})}),i.jsx("p",{className:"text-sm text-slate-600 mb-2",children:y.description}),i.jsxs("div",{className:"text-xs text-slate-500 mb-3",children:["Sources: ",y.sources_involved.map(C=>E(C)).join(", ")]}),y.resolution_status==="unresolved"&&i.jsxs("div",{className:"flex gap-2",children:[i.jsx("button",{onClick:()=>a==null?void 0:a(y.event_id,"resolved"),className:"text-xs px-2 py-1 bg-green-600 text-white rounded hover:bg-green-700",children:"Mark Resolved"}),i.jsx("button",{onClick:()=>a==null?void 0:a(y.event_id,"documented"),className:"text-xs px-2 py-1 bg-amber-600 text-white rounded hover:bg-amber-700",children:"Document in Report"})]})]},y.event_id))})]}),i.jsx("div",{className:"p-3 border-t bg-slate-50",children:i.jsx("p",{className:"text-xs text-slate-500",children:"Note: Events with multiple independent sources are marked corroborated. Conflicting sources are flagged for resolution."})})]})}function Cb({claims:c,contradictions:e,evidence:t,sections:s,validation:n,referralQuestions:a,onExport:o,onOverride:l}){const d=T.useMemo(()=>{var ie,ue,te,V,le,ye;const g=[],b=c.filter(z=>z.claim_type==="record_fact"),A=b.filter(z=>!z.citations||z.citations.length===0),N=b.filter(z=>{var Se;return((Se=z.citations)==null?void 0:Se.length)>0&&!z.verified});g.push({id:"citation_verification",name:"Citation Verification",description:"Record facts must have verified citation anchors",status:A.length===0&&N.length===0?"pass":A.length>0?"fail":"warn",details:A.length>0?`${A.length} record fact(s) without citations`:N.length>0?`${N.length} citation(s) not verified`:`${b.length} record facts verified`,canOverride:!1});const E=e.filter(z=>z.resolution_status==="unresolved").filter(z=>z.impacts_opinion!==!1),_=s.find(z=>z.section_type==="limitations"||z.title.toLowerCase().includes("limitation")),y=((ie=_==null?void 0:_.content)==null?void 0:ie.toLowerCase().includes("contradict"))||((ue=_==null?void 0:_.content)==null?void 0:ue.toLowerCase().includes("inconsisten"))||((te=_==null?void 0:_.content)==null?void 0:te.toLowerCase().includes("discrepan"));g.push({id:"contradiction_resolution",name:"Contradiction Resolution",description:"Unresolved contradictions affecting opinions must be addressed",status:E.length===0?"pass":y?"warn":"fail",details:E.length===0?`${e.length} contradictions, all resolved or addressed`:y?`${E.length} unresolved, documented in Limitations`:`${E.length} unresolved contradiction(s) affecting opinions`,canOverride:!!y,overrideReason:"Contradictions explicitly addressed in Limitations section"});const C=c.filter(z=>z.claim_type==="self_report"),R=c.filter(z=>z.claim_type==="collateral");g.push({id:"hearsay_labeling",name:"Hearsay Labeling",description:"Hearsay must not be treated as established fact",status:"pass",details:`${C.length} self-report, ${R.length} collateral claims properly typed`,canOverride:!1});const S=(n==null?void 0:n.issues.filter(z=>z.issue_type.includes("validity")||z.issue_type.includes("response_style")||z.issue_type.includes("credibility")))||[],k=((V=_==null?void 0:_.content)==null?void 0:V.toLowerCase().includes("validity"))||((le=_==null?void 0:_.content)==null?void 0:le.toLowerCase().includes("response style"))||((ye=_==null?void 0:_.content)==null?void 0:ye.toLowerCase().includes("impression management"));g.push({id:"validity_concerns",name:"Validity Concerns",description:"Validity concerns must be addressed, not ignored",status:S.length===0||k?"pass":"fail",details:S.length===0?"No validity concerns identified":k?`${S.length} concern(s) addressed in Limitations`:`${S.length} validity concern(s) not addressed`,canOverride:!0,overrideReason:"Validity concerns documented elsewhere in report"});const M=c.filter(z=>z.claim_type==="forensic_opinion"||z.claim_type==="opinion"||z.claim_type==="inference"),L=M.filter(z=>!z.citations||z.citations.length===0);g.push({id:"opinion_basis",name:"Opinion Basis Chain",description:"Opinions must have supporting claims/citations",status:L.length===0?"pass":L.length<=1?"warn":"fail",details:L.length===0?`${M.length} opinion(s) with documented basis`:`${L.length} opinion(s) without supporting citations`,canOverride:!0,overrideReason:"Opinion basis documented narratively in section content"});const O=M.map(z=>(z.claim_text||z.text||"").toLowerCase()).join(" "),$=s.find(z=>z.section_type==="opinions"||z.title.toLowerCase().includes("opinion")),q=(($==null?void 0:$.content)||"").toLowerCase(),F=a.filter(z=>z.toLowerCase().split(" ").filter(he=>he.length>4).some(he=>O.includes(he)||q.includes(he)));g.push({id:"referral_questions",name:"Referral Questions",description:"All referral questions must be addressed with opinions",status:F.length===a.length?"pass":F.length>=a.length*.5?"warn":"fail",details:`${F.length}/${a.length} referral questions addressed`,canOverride:!0,overrideReason:"Question addressed outside formal opinion structure"});const P=s.find(z=>z.section_type==="methods"||z.section_type==="procedures"||z.title.toLowerCase().includes("method")||z.title.toLowerCase().includes("procedure")),I=P&&P.content&&P.content.length>200;g.push({id:"methodology",name:"Methodology Documentation",description:"Methods must be documented for Daubert/Frye defensibility",status:I?"pass":"fail",details:I?"Methodology section present and substantive":"Methodology section missing or insufficient",canOverride:!1});const K=_&&_.content&&_.content.length>100;return g.push({id:"limitations",name:"Limitations Disclosure",description:"Limitations must be explicitly disclosed",status:K?"pass":"fail",details:K?"Limitations section present":"Limitations section missing or insufficient",canOverride:!1}),g},[c,e,t,s,n,a]),h=d.filter(g=>g.status==="fail"&&!g.canOverride),u=d.filter(g=>g.status==="warn"||g.status==="fail"&&g.canOverride),p=d.filter(g=>g.status==="pass"),m=h.length===0,f=h.length===0&&u.length===0;return i.jsxs("div",{className:"bg-white rounded-xl border shadow-sm overflow-hidden",children:[i.jsx("div",{className:`p-4 border-b ${f?"bg-green-50":m?"bg-amber-50":"bg-red-50"}`,children:i.jsxs("div",{className:"flex items-center justify-between",children:[i.jsxs("div",{children:[i.jsx("h2",{className:"font-bold text-slate-800 text-lg flex items-center gap-2",children:"Finalize Gates"}),i.jsx("p",{className:`text-sm ${f?"text-green-700":m?"text-amber-700":"text-red-700"}`,children:f?"All gates passed - ready to export":m?`${u.length} warning(s) - review before export`:`${h.length} gate(s) blocking export`})]}),i.jsx("button",{onClick:o,disabled:!m,className:`px-4 py-2 rounded-lg font-medium ${m?"bg-green-600 text-white hover:bg-green-700":"bg-slate-300 text-slate-500 cursor-not-allowed"}`,children:m?"Export Report":"Export Blocked"})]})}),i.jsx("div",{className:"divide-y",children:d.map(g=>i.jsx("div",{className:`p-4 ${g.status==="fail"?"bg-red-50/50":g.status==="warn"?"bg-amber-50/50":""}`,children:i.jsxs("div",{className:"flex items-start gap-3",children:[i.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center ${g.status==="pass"?"bg-green-500 text-white":g.status==="warn"?"bg-amber-500 text-white":"bg-red-500 text-white"}`,children:g.status==="pass"?"Pass":g.status==="warn"?"Warn":"Fail"}),i.jsxs("div",{className:"flex-1",children:[i.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[i.jsx("span",{className:"font-medium text-slate-700",children:g.name}),i.jsx("span",{className:`text-xs px-1.5 py-0.5 rounded ${g.status==="pass"?"bg-green-100 text-green-700":g.status==="warn"?"bg-amber-100 text-amber-700":"bg-red-100 text-red-700"}`,children:g.status}),g.status==="fail"&&!g.canOverride&&i.jsx("span",{className:"text-xs px-1.5 py-0.5 rounded bg-red-200 text-red-800",children:"BLOCKER"})]}),i.jsx("p",{className:"text-sm text-slate-500 mb-1",children:g.description}),i.jsx("p",{className:`text-sm ${g.status==="pass"?"text-green-600":g.status==="warn"?"text-amber-600":"text-red-600"}`,children:g.details}),g.status==="fail"&&g.canOverride&&i.jsxs("div",{className:"mt-2",children:[i.jsx("button",{onClick:()=>l(g.id,g.overrideReason||""),className:"text-xs text-purple-600 hover:text-purple-800 hover:underline",children:"Override with attestation →"}),i.jsxs("span",{className:"text-xs text-slate-400 ml-2",children:["(",g.overrideReason,")"]})]})]})]})},g.id))}),i.jsx("div",{className:"p-4 border-t bg-slate-50",children:i.jsxs("div",{className:"flex justify-between text-sm",children:[i.jsxs("span",{className:"text-green-600",children:[p.length," passed"]}),i.jsxs("span",{className:"text-amber-600",children:[u.length," warnings"]}),i.jsxs("span",{className:"text-red-600",children:[h.length," blockers"]})]})})]})}function Eb(c){return c.substring(0,12)+"..."+c.substring(c.length-4)}function kb({reportId:c,caseId:e,caseNumber:t,evaluatorName:s,claims:n,evidence:a,contradictions:o,sections:l,limitations:d,onExport:h}){const[u,p]=T.useState(!1),[m,f]=T.useState({evidence_inventory:!0,claim_ledger:!0,citation_index:!0,contradiction_matrix:!0,limitations_register:!0,methodology_appendix:!0,audit_chain:!0}),[g,b]=T.useState(null),A=T.useMemo(()=>{const y=n.filter(M=>["record_fact","test_result","observation"].includes(M.claim_type)),C=y.filter(M=>{var L;return((L=M.citations)==null?void 0:L.length)>0}),R=o.filter(M=>M.resolution_status==="unresolved"&&M.impacts_opinion),S=l.find(M=>M.section_type==="methods"||M.title.toLowerCase().includes("method")),k=l.find(M=>M.section_type==="limitations"||M.title.toLowerCase().includes("limitation"));return{all_facts_cited:y.length===0||C.length===y.length,contradictions_addressed:R.length===0,methodology_complete:!!(S!=null&&S.content)&&S.content.length>200,limitations_disclosed:!!(k!=null&&k.content)&&k.content.length>50}},[n,o,l]),N=Object.values(A).every(Boolean),j=T.useMemo(()=>a.map(y=>({id:y.id,filename:y.filename,type:typeof y.evidence_type=="string"?y.evidence_type:"document",hash:y.file_hash||"pending",date_received:y.date_received||"unknown",relied_upon:y.relied_upon!==!1,authenticity:y.authenticity_status||"unconfirmed",citation_count:n.filter(C=>{var R;return(R=C.citations)==null?void 0:R.some(S=>S.evidence_id===y.id)}).length})),[a,n]),E=T.useMemo(()=>n.map(y=>{var C,R,S;return{id:y.id,type:y.claim_type,text:(y.claim_text||y.text||"").substring(0,100)+"...",section:((C=l.find(k=>k.id===y.section_id))==null?void 0:C.title)||"Unknown",citation_count:((R=y.citations)==null?void 0:R.length)||0,confidence:y.confidence||"standard",vulnerabilities:((S=y.vulnerability_tags)==null?void 0:S.length)||0}}),[n,l]),_=T.useMemo(()=>o.map(y=>{const C=n.find(S=>S.id===y.claim_a_id),R=n.find(S=>S.id===y.claim_b_id);return{id:y.id,type:y.type,claim_a:((C==null?void 0:C.claim_text)||(C==null?void 0:C.text)||"").substring(0,50)+"...",claim_b:((R==null?void 0:R.claim_text)||(R==null?void 0:R.text)||"").substring(0,50)+"...",status:y.resolution_status,impacts_opinion:y.impacts_opinion,resolution:y.resolution_note||"none"}}),[o,n]);return i.jsxs("div",{className:"bg-white rounded-xl border shadow-sm overflow-hidden",children:[i.jsx("div",{className:"p-4 border-b bg-gradient-to-r from-green-50 to-white",children:i.jsxs("div",{className:"flex items-center justify-between mb-2",children:[i.jsxs("div",{children:[i.jsx("h2",{className:"font-bold text-slate-800 text-lg flex items-center gap-2",children:"Reader Pack Export"}),i.jsx("p",{className:"text-sm text-slate-500",children:"Court-grade export with independent verification"})]}),i.jsx("div",{className:`px-3 py-1 rounded-full text-sm font-medium ${N?"bg-green-100 text-green-700":"bg-amber-100 text-amber-700"}`,children:N?"Ready to Export":"Review Issues"})]})}),i.jsxs("div",{className:"p-4 border-b bg-slate-50",children:[i.jsx("h3",{className:"text-sm font-semibold text-slate-700 mb-2",children:"Integrity Verification"}),i.jsx("div",{className:"grid grid-cols-2 gap-2",children:Object.entries(A).map(([y,C])=>i.jsxs("div",{className:`flex items-center gap-2 text-sm ${C?"text-green-600":"text-red-600"}`,children:[i.jsx("span",{children:C?"Pass":"Fail"}),i.jsx("span",{children:y.replace(/_/g," ").replace(/\b\w/g,R=>R.toUpperCase())})]},y))})]}),i.jsxs("div",{className:"p-4 border-b",children:[i.jsx("h3",{className:"text-sm font-semibold text-slate-700 mb-3",children:"Export Components"}),i.jsx("div",{className:"space-y-2",children:[{key:"evidence_inventory",label:"Evidence Inventory",desc:"All sources with file hashes"},{key:"claim_ledger",label:"Claim Ledger",desc:"All claims with types and citations"},{key:"citation_index",label:"Citation Index",desc:"Quote anchors with page/line refs"},{key:"contradiction_matrix",label:"Contradiction Matrix",desc:"All conflicts with resolutions"},{key:"limitations_register",label:"Limitations Register",desc:"Disclosed limitations"},{key:"methodology_appendix",label:"Methodology Appendix",desc:"Methods and error mitigation"},{key:"audit_chain",label:"Audit Chain Digest",desc:"Edit history with timestamps"}].map(({key:y,label:C,desc:R})=>i.jsxs("label",{className:"flex items-start gap-3 p-2 rounded hover:bg-slate-50 cursor-pointer",children:[i.jsx("input",{type:"checkbox",checked:m[y],onChange:S=>f(k=>({...k,[y]:S.target.checked})),className:"mt-0.5"}),i.jsxs("div",{children:[i.jsx("div",{className:"text-sm font-medium text-slate-700",children:C}),i.jsx("div",{className:"text-xs text-slate-500",children:R})]}),i.jsx("button",{onClick:S=>{S.preventDefault(),b(g===y?null:y)},className:"ml-auto text-xs text-blue-600 hover:underline",children:g===y?"Hide":"Preview"})]},y))})]}),g&&i.jsxs("div",{className:"p-4 border-b bg-slate-50",children:[i.jsxs("h3",{className:"text-sm font-semibold text-slate-700 mb-2",children:["Preview: ",g.replace(/_/g," ").replace(/\b\w/g,y=>y.toUpperCase())]}),i.jsxs("div",{className:"bg-white border rounded-lg p-3 max-h-48 overflow-y-auto",children:[g==="evidence_inventory"&&i.jsxs("table",{className:"w-full text-xs",children:[i.jsx("thead",{children:i.jsxs("tr",{className:"text-left text-slate-500",children:[i.jsx("th",{className:"pb-1",children:"File"}),i.jsx("th",{className:"pb-1",children:"Type"}),i.jsx("th",{className:"pb-1",children:"Hash"}),i.jsx("th",{className:"pb-1",children:"Citations"})]})}),i.jsx("tbody",{className:"divide-y",children:j.slice(0,5).map(y=>i.jsxs("tr",{children:[i.jsx("td",{className:"py-1",children:y.filename}),i.jsx("td",{className:"py-1",children:y.type}),i.jsx("td",{className:"py-1 font-mono text-slate-500",children:Eb(y.hash)}),i.jsx("td",{className:"py-1",children:y.citation_count})]},y.id))})]}),g==="claim_ledger"&&i.jsxs("table",{className:"w-full text-xs",children:[i.jsx("thead",{children:i.jsxs("tr",{className:"text-left text-slate-500",children:[i.jsx("th",{className:"pb-1",children:"Type"}),i.jsx("th",{className:"pb-1",children:"Claim"}),i.jsx("th",{className:"pb-1",children:"Cites"})]})}),i.jsx("tbody",{className:"divide-y",children:E.slice(0,5).map(y=>i.jsxs("tr",{children:[i.jsx("td",{className:"py-1",children:i.jsx("span",{className:`px-1 py-0.5 rounded text-xs ${y.type==="record_fact"?"bg-blue-100 text-blue-700":y.type==="forensic_opinion"?"bg-purple-100 text-purple-700":"bg-slate-100 text-slate-700"}`,children:y.type})}),i.jsx("td",{className:"py-1",children:y.text}),i.jsx("td",{className:"py-1",children:y.citation_count})]},y.id))})]}),g==="contradiction_matrix"&&i.jsx("div",{className:"space-y-2",children:_.length===0?i.jsx("p",{className:"text-slate-500",children:"No contradictions recorded"}):_.slice(0,3).map(y=>i.jsxs("div",{className:"p-2 bg-slate-50 rounded",children:[i.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[i.jsx("span",{className:"font-medium",children:y.type}),i.jsx("span",{className:`text-xs px-1 py-0.5 rounded ${y.status==="unresolved"?"bg-red-100 text-red-700":"bg-green-100 text-green-700"}`,children:y.status})]}),i.jsx("p",{className:"text-slate-600",children:y.claim_a}),i.jsxs("p",{className:"text-slate-600",children:["vs. ",y.claim_b]})]},y.id))})]})]}),i.jsxs("div",{className:"p-4 border-b",children:[i.jsx("h3",{className:"text-sm font-semibold text-slate-700 mb-2",children:"Export Summary"}),i.jsxs("div",{className:"grid grid-cols-4 gap-3 text-center",children:[i.jsxs("div",{className:"p-2 bg-slate-50 rounded",children:[i.jsx("div",{className:"text-lg font-bold text-slate-700",children:a.length}),i.jsx("div",{className:"text-xs text-slate-500",children:"Sources"})]}),i.jsxs("div",{className:"p-2 bg-slate-50 rounded",children:[i.jsx("div",{className:"text-lg font-bold text-slate-700",children:n.length}),i.jsx("div",{className:"text-xs text-slate-500",children:"Claims"})]}),i.jsxs("div",{className:"p-2 bg-slate-50 rounded",children:[i.jsx("div",{className:"text-lg font-bold text-slate-700",children:n.reduce((y,C)=>{var R;return y+(((R=C.citations)==null?void 0:R.length)||0)},0)}),i.jsx("div",{className:"text-xs text-slate-500",children:"Citations"})]}),i.jsxs("div",{className:"p-2 bg-slate-50 rounded",children:[i.jsx("div",{className:"text-lg font-bold text-slate-700",children:o.length}),i.jsx("div",{className:"text-xs text-slate-500",children:"Contradictions"})]})]})]}),i.jsxs("div",{className:"p-4 bg-slate-50",children:[i.jsxs("div",{className:"flex gap-3",children:[i.jsx("button",{onClick:()=>h("full"),disabled:!N||u,className:`flex-1 py-2 rounded-lg font-medium ${N&&!u?"bg-green-600 text-white hover:bg-green-700":"bg-slate-300 text-slate-500 cursor-not-allowed"}`,children:"Export Full Reader Pack"}),i.jsx("button",{onClick:()=>h("summary"),className:"px-4 py-2 border rounded-lg text-slate-600 hover:bg-white",children:"Summary Only"}),i.jsx("button",{onClick:()=>h("verifier"),className:"px-4 py-2 border rounded-lg text-slate-600 hover:bg-white",children:"Verifier Tool"})]}),i.jsx("p",{className:"text-xs text-slate-500 mt-3 text-center",children:"Export includes SHA-256 hashes, manifest signature, and independent verifier tool"})]})]})}function Tb({claims:c,evidence:e,selectedOpinionId:t,onSelectOpinion:s}){const[n,a]=T.useState("short"),[o,l]=T.useState(t||null),d=T.useMemo(()=>c.filter(f=>["forensic_opinion","opinion","inference","ultimate_opinion"].includes(f.claim_type)),[c]),u=o?(f=>{var S;const g=c.find(k=>k.id===f);if(!g)return null;const b=g.supporting_claim_ids||((S=g.citations)==null?void 0:S.map(k=>k.evidence_id))||[],A=c.filter(k=>{var M;return b.includes(k.id)||((M=k.citations)==null?void 0:M.some(L=>{var O;return(O=g.citations)==null?void 0:O.some($=>$.evidence_id===L.evidence_id)}))}),N=A.filter(k=>k.claim_type==="inference"),j=A.filter(k=>k.claim_type==="record_fact"),E=A.filter(k=>k.claim_type==="test_result"),_=A.filter(k=>k.claim_type==="observation"),y=[];[...j,...E,..._].forEach(k=>{var M;(M=k.citations)==null||M.forEach(L=>{const O=e.find($=>$.id===L.evidence_id);O&&y.push({claim:k,evidence:O,quote:L.quote,page:L.page})})});const C=[];j.length===0&&E.length===0&&C.push("No factual claims or test results supporting this opinion"),y.length===0&&C.push("No direct evidence anchors in the chain"),N.length>j.length+E.length&&C.push("More inferences than factual support");const R=C.length===0&&y.length>=3?"strong":C.length<=1&&y.length>=1?"moderate":"weak";return{opinion:g,supportingInferences:N,supportingFacts:j,supportingTestResults:E,supportingObservations:_,evidenceAnchors:y,chainStrength:R,gaps:C}})(o):null,p=f=>{const g=f.opinion.claim_text||f.opinion.text||"",b=[];if(b.push(`Opinion: ${g}`),f.supportingTestResults.length>0){const A=f.supportingTestResults.map(N=>(N.claim_text||N.text||"").slice(0,50)).join("; ");b.push(`Based on test findings: ${A}`)}if(f.supportingFacts.length>0){const A=f.supportingFacts.slice(0,2).map(N=>(N.claim_text||N.text||"").slice(0,50)).join("; ");b.push(`Supported by records: ${A}`)}return f.supportingObservations.length>0&&b.push("Consistent with behavioral observations during evaluation"),b.join(`

`)},m=f=>{const g=[],b=f.opinion.claim_text||f.opinion.text||"";return g.push(`## OPINION CHAIN ANALYSIS
`),g.push(`### Opinion Statement
"${b}"
`),g.push(`Confidence: ${f.opinion.confidence||"Not specified"}`),g.push(`Chain Strength: ${f.chainStrength.toUpperCase()}
`),f.gaps.length>0&&(g.push("### Identified Gaps"),f.gaps.forEach(A=>g.push(`- ${A}`)),g.push("")),g.push(`### Supporting Evidence Chain
`),f.supportingTestResults.length>0&&(g.push("#### Test Results"),f.supportingTestResults.forEach((A,N)=>{var j;g.push(`${N+1}. ${A.claim_text||A.text}`),(j=A.citations)!=null&&j.length&&A.citations.forEach(E=>{const _=e.find(y=>y.id===E.evidence_id);_&&(g.push(`   - Source: ${_.filename}${E.page?`, p. ${E.page}`:""}`),E.quote&&g.push(`   - Quote: "${E.quote}"`))})}),g.push("")),f.supportingFacts.length>0&&(g.push("#### Record Facts"),f.supportingFacts.forEach((A,N)=>{var j;g.push(`${N+1}. ${A.claim_text||A.text}`),(j=A.citations)!=null&&j.length&&A.citations.forEach(E=>{const _=e.find(y=>y.id===E.evidence_id);_&&(g.push(`   - Source: ${_.filename}${E.page?`, p. ${E.page}`:""}`),E.quote&&g.push(`   - Quote: "${E.quote}"`))})}),g.push("")),f.supportingObservations.length>0&&(g.push("#### Behavioral Observations"),f.supportingObservations.forEach((A,N)=>{g.push(`${N+1}. ${A.claim_text||A.text}`)}),g.push("")),f.supportingInferences.length>0&&(g.push("#### Clinical Inferences"),f.supportingInferences.forEach((A,N)=>{g.push(`${N+1}. ${A.claim_text||A.text}`)}),g.push("")),g.push(`### Deposition Preparation Notes
`),g.push("If asked about the basis for this opinion:"),g.push("1. Start with the factual/test result foundation"),g.push("2. Explain how observations corroborate"),g.push("3. Describe the inferential reasoning"),g.push("4. Acknowledge any limitations proactively"),g.join(`
`)};return i.jsxs("div",{className:"bg-white rounded-xl border shadow-sm overflow-hidden",children:[i.jsxs("div",{className:"p-4 border-b bg-gradient-to-r from-orange-50 to-white",children:[i.jsx("h2",{className:"font-bold text-slate-800 text-lg flex items-center gap-2",children:"Opinion Chain Explainer"}),i.jsx("p",{className:"text-sm text-slate-500",children:"Trace the reasoning from evidence to opinion"})]}),i.jsxs("div",{className:"p-3 border-b bg-slate-50",children:[i.jsxs("div",{className:"flex items-center justify-between mb-2",children:[i.jsx("label",{className:"text-sm font-medium text-slate-700",children:"Select Opinion:"}),i.jsxs("div",{className:"flex gap-2",children:[i.jsx("button",{onClick:()=>a("short"),className:`px-2 py-1 text-xs rounded ${n==="short"?"bg-orange-600 text-white":"bg-white border"}`,children:"Short (Report)"}),i.jsx("button",{onClick:()=>a("long"),className:`px-2 py-1 text-xs rounded ${n==="long"?"bg-orange-600 text-white":"bg-white border"}`,children:"Long (Deposition)"})]})]}),i.jsxs("select",{value:o||"",onChange:f=>{l(f.target.value||null),s==null||s(f.target.value)},className:"w-full px-3 py-2 border rounded-lg text-sm",children:[i.jsx("option",{value:"",children:"-- Select an opinion --"}),d.map(f=>i.jsxs("option",{value:f.id,children:[(f.claim_text||f.text||"").slice(0,80),"..."]},f.id))]})]}),i.jsx("div",{className:"p-4 max-h-[400px] overflow-y-auto",children:u?i.jsxs("div",{className:"space-y-4",children:[i.jsxs("div",{className:`p-3 rounded-lg ${u.chainStrength==="strong"?"bg-green-50 border border-green-200":u.chainStrength==="moderate"?"bg-amber-50 border border-amber-200":"bg-red-50 border border-red-200"}`,children:[i.jsxs("div",{className:"flex items-center justify-between",children:[i.jsx("span",{className:"font-medium text-slate-700",children:"Chain Strength"}),i.jsx("span",{className:`px-2 py-1 rounded text-sm font-medium ${u.chainStrength==="strong"?"bg-green-200 text-green-800":u.chainStrength==="moderate"?"bg-amber-200 text-amber-800":"bg-red-200 text-red-800"}`,children:u.chainStrength.toUpperCase()})]}),u.gaps.length>0&&i.jsxs("div",{className:"mt-2 text-sm text-red-600",children:[i.jsx("p",{className:"font-medium",children:"Gaps:"}),i.jsx("ul",{className:"list-disc list-inside",children:u.gaps.map((f,g)=>i.jsx("li",{children:f},g))})]})]}),i.jsxs("div",{className:"space-y-3",children:[i.jsxs("div",{className:"p-3 bg-orange-100 border border-orange-300 rounded-lg",children:[i.jsx("div",{className:"text-xs text-orange-600 font-medium mb-1",children:"OPINION"}),i.jsx("p",{className:"text-sm text-slate-700",children:u.opinion.claim_text||u.opinion.text})]}),i.jsx("div",{className:"text-center text-slate-400",children:"↑ supported by"}),u.supportingInferences.length>0&&i.jsxs(i.Fragment,{children:[i.jsx("div",{className:"grid gap-2",children:u.supportingInferences.map(f=>i.jsxs("div",{className:"p-3 bg-purple-50 border border-purple-200 rounded-lg",children:[i.jsx("div",{className:"text-xs text-purple-600 font-medium mb-1",children:"INFERENCE"}),i.jsx("p",{className:"text-sm text-slate-700",children:f.claim_text||f.text})]},f.id))}),i.jsx("div",{className:"text-center text-slate-400",children:"↑ derived from"})]}),i.jsxs("div",{className:"grid gap-2",children:[u.supportingTestResults.map(f=>i.jsxs("div",{className:"p-3 bg-blue-50 border border-blue-200 rounded-lg",children:[i.jsx("div",{className:"text-xs text-blue-600 font-medium mb-1",children:"TEST RESULT"}),i.jsx("p",{className:"text-sm text-slate-700",children:f.claim_text||f.text})]},f.id)),u.supportingFacts.map(f=>i.jsxs("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg",children:[i.jsx("div",{className:"text-xs text-green-600 font-medium mb-1",children:"RECORD FACT"}),i.jsx("p",{className:"text-sm text-slate-700",children:f.claim_text||f.text})]},f.id)),u.supportingObservations.map(f=>i.jsxs("div",{className:"p-3 bg-teal-50 border border-teal-200 rounded-lg",children:[i.jsx("div",{className:"text-xs text-teal-600 font-medium mb-1",children:"OBSERVATION"}),i.jsx("p",{className:"text-sm text-slate-700",children:f.claim_text||f.text})]},f.id))]}),i.jsx("div",{className:"text-center text-slate-400",children:"↑ anchored to"}),i.jsxs("div",{className:"grid gap-2",children:[u.evidenceAnchors.slice(0,5).map((f,g)=>i.jsxs("div",{className:"p-3 bg-slate-100 border border-slate-300 rounded-lg",children:[i.jsx("div",{className:"text-xs text-slate-600 font-medium mb-1",children:"EVIDENCE"}),i.jsxs("p",{className:"text-sm font-medium text-slate-700",children:[f.evidence.filename,f.page&&i.jsxs("span",{className:"text-slate-500",children:[" (p. ",f.page,")"]})]}),f.quote&&i.jsxs("p",{className:"text-xs text-slate-500 mt-1 italic",children:['"',f.quote.slice(0,100),'..."']})]},g)),u.evidenceAnchors.length>5&&i.jsxs("p",{className:"text-xs text-slate-500 text-center",children:["+",u.evidenceAnchors.length-5," more evidence anchors"]})]})]}),i.jsxs("div",{className:"mt-6 p-4 bg-slate-50 rounded-lg",children:[i.jsxs("div",{className:"flex items-center justify-between mb-2",children:[i.jsx("h3",{className:"font-medium text-slate-700",children:n==="short"?"Report Narrative":"Deposition Prep Narrative"}),i.jsx("button",{onClick:()=>{const f=n==="short"?p(u):m(u);navigator.clipboard.writeText(f)},className:"text-xs text-orange-600 hover:text-orange-800",children:"Copy"})]}),i.jsx("pre",{className:"text-sm text-slate-600 whitespace-pre-wrap font-sans",children:n==="short"?p(u):m(u)})]})]}):i.jsx("div",{className:"text-center py-8 text-slate-500",children:i.jsx("p",{children:"Select an opinion to see its supporting chain"})})}),i.jsx("div",{className:"p-3 border-t bg-orange-50",children:i.jsx("p",{className:"text-xs text-orange-700",children:"A strong opinion chain has multiple evidence anchors and more facts than inferences."})})]})}function Rb(){return{id:"CASE-DEMO-001",case_number:"DEMO-2026-001",case_type:"competency",evaluee_pseudonym:"Evaluee A",referral_source:"Court Order (Demo)",referral_date:"2026-01-10",evaluation_date:"2026-01-12"}}function Pb(){return[{id:"EV-001",filename:"Police_Report_Excerpt.pdf",evidence_type:"record",file_hash:"demo_hash_001",date_received:"2026-01-10",relied_upon:!0,authenticity_status:"unverified"},{id:"EV-002",filename:"Collateral_Interview_Notes.txt",evidence_type:"collateral",file_hash:"demo_hash_002",date_received:"2026-01-11",relied_upon:!0,authenticity_status:"unverified"}]}function Mb(){return[{id:"SEC-1",title:"Sources of Information",section_type:"sources"},{id:"SEC-2",title:"Behavioral Observations",section_type:"observations"},{id:"SEC-3",title:"Opinion",section_type:"opinion"},{id:"SEC-4",title:"Limitations",section_type:"limitations"}]}function Ib(){return[{id:"CLM-001",claim_text:"Evaluee A reported difficulty recalling the sequence of events.",claim_type:"self_report",section_id:"SEC-2",citations:[{evidence_id:"EV-002",excerpt:"...difficulty recalling..."}],verified:!1},{id:"CLM-002",claim_text:"Record indicates Evaluee A was oriented to person and place at booking.",claim_type:"record_fact",section_id:"SEC-1",citations:[{evidence_id:"EV-001",excerpt:"...oriented x2..."}],verified:!0},{id:"CLM-OP-001",claim_text:"Based on the above, it is more likely than not that Evaluee A had adequate factual understanding at the time of evaluation.",claim_type:"forensic_opinion",section_id:"SEC-3",citations:[],verified:!0}]}function Lb(){return[{id:"CON-001",claim_a_id:"CLM-001",claim_b_id:"CLM-002",type:"direct",resolution_status:"unresolved",impacts_opinion:!0,severity:"medium"}]}function Db({onBack:c,onHome:e}){var _;const[t,s]=T.useState("overview"),[n]=T.useState(()=>Rb()),[a]=T.useState(()=>Pb()),[o]=T.useState(()=>Mb()),[l,d]=T.useState(()=>Ib()),[h,u]=T.useState(()=>Lb()),[p,m]=T.useState(null),f=T.useMemo(()=>a.find(y=>y.id===p)||null,[a,p]),g=T.useMemo(()=>["Demo limitation: backend persistence not enabled."],[]),b=T.useMemo(()=>({is_valid:!0,issues:[],warnings:[]}),[]),A=T.useMemo(()=>["Competency-related referral question (demo)."],[]),N=T.useMemo(()=>[{id:"overview",label:"Overview",icon:Dt},{id:"evidence",label:"Evidence",icon:Yd},{id:"claims",label:"Claim Ledger",icon:zu},{id:"opinions",label:"Opinion Chain",icon:bp},{id:"contradictions",label:"Contradictions",icon:id},{id:"timeline",label:"Timeline",icon:Ja},{id:"methodology",label:"Methodology",icon:Sp},{id:"gates",label:"Gates",icon:id},{id:"export",label:"Export",icon:oo}],[]),j=`${n.case_number} • ${n.case_type.toUpperCase()} • ${n.evaluee_pseudonym}`,E=(_=e!=null?e:c)!=null?_:()=>{};return i.jsx(Dp,{sidebar:i.jsxs("div",{className:"p-4",children:[i.jsxs("div",{className:"mb-4",children:[i.jsx("div",{className:"text-xs text-slate-400 uppercase tracking-wide",children:"Forensic"}),i.jsx("div",{className:"text-sm font-semibold text-white",children:n.case_number}),i.jsx("div",{className:"text-xs text-slate-400 mt-1",children:n.referral_source})]}),i.jsx("div",{className:"space-y-1",children:N.map(y=>{const C=y.icon;return i.jsx(Op,{icon:i.jsx(C,{className:"w-4 h-4"}),label:y.label,isActive:t===y.id,onClick:()=>s(y.id)},y.id)})}),i.jsx("div",{className:"mt-6",children:i.jsxs(Fs,{padding:"sm",className:"bg-slate-900/50 border border-slate-700",children:[i.jsx("div",{className:"text-xs text-slate-400",children:"Evaluee (pseudonym)"}),i.jsx("div",{className:"text-sm font-semibold text-white",children:n.evaluee_pseudonym}),i.jsx("div",{className:"text-xs text-slate-400 mt-2",children:"Case Type"}),i.jsx("div",{className:"text-sm text-slate-200",children:n.case_type.toUpperCase()}),i.jsx("div",{className:"text-xs text-slate-400 mt-2",children:"Referral Date"}),i.jsx("div",{className:"text-sm text-slate-200",children:n.referral_date})]})})]}),sidebarWidth:"w-72",children:i.jsxs("div",{className:"p-6",children:[i.jsx(Fp,{onHome:E,showBack:!!c,onBack:c,title:"Forensic Workspace",subtitle:j,actions:i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx("button",{onClick:()=>s("gates"),className:"px-3 py-1.5 bg-slate-700/50 hover:bg-slate-700 rounded-lg text-sm text-slate-200 transition-colors",title:"Go to Gates",children:"Gates"}),i.jsx("button",{onClick:()=>s("export"),className:"px-3 py-1.5 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm text-white transition-colors",title:"Go to Export",children:"Export"})]})}),i.jsxs(Fs,{className:"bg-slate-900/60 border border-slate-800",children:[t==="overview"&&i.jsxs("div",{className:"space-y-6",children:[i.jsxs("div",{children:[i.jsx("div",{className:"text-lg font-semibold text-white",children:"Workspace overview"}),i.jsx("p",{className:"text-sm text-slate-400 mt-1",children:"This is a PHI-free demo workspace showing the forensic workflow: evidence → claims → contradictions → gates → export."})]}),i.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[i.jsx(Ro,{icon:i.jsx(Yd,{className:"w-5 h-5 text-blue-400"}),value:String(a.length),label:"Evidence items"}),i.jsx(Ro,{icon:i.jsx(zu,{className:"w-5 h-5 text-purple-400"}),value:String(l.length),label:"Claims"})]}),i.jsxs(Fs,{padding:"sm",className:"bg-slate-950/30 border border-slate-800",children:[i.jsx("div",{className:"text-sm font-semibold text-white mb-2",children:"What this workspace demonstrates"}),i.jsxs("ul",{className:"list-disc pl-5 text-slate-300 space-y-1 text-sm",children:[i.jsx("li",{children:"Claim Ledger + citations as the primary forensic object"}),i.jsx("li",{children:"Contradiction surfacing aligned to cross-examination risk"}),i.jsx("li",{children:"Finalization gates before export"}),i.jsx("li",{children:"Reader-pack export that can be independently verified"})]})]})]}),t==="evidence"&&i.jsxs("div",{className:"space-y-4",children:[i.jsx("div",{className:"text-lg font-semibold text-white",children:"Evidence Inventory (demo)"}),i.jsx("div",{className:"border border-slate-800 rounded-lg overflow-hidden",children:i.jsxs("table",{className:"w-full text-sm",children:[i.jsx("thead",{className:"bg-slate-950/40",children:i.jsxs("tr",{children:[i.jsx("th",{className:"px-3 py-2 text-left",children:"File"}),i.jsx("th",{className:"px-3 py-2 text-left",children:"Type"}),i.jsx("th",{className:"px-3 py-2 text-left",children:"Relied"}),i.jsx("th",{className:"px-3 py-2"})]})}),i.jsx("tbody",{children:a.map(y=>i.jsxs("tr",{className:"border-t border-slate-800",children:[i.jsx("td",{className:"px-3 py-2",children:y.filename}),i.jsx("td",{className:"px-3 py-2",children:typeof y.evidence_type=="string"?y.evidence_type:"object"}),i.jsx("td",{className:"px-3 py-2",children:y.relied_upon?"Yes":"No"}),i.jsx("td",{className:"px-3 py-2 text-right",children:i.jsx("button",{onClick:()=>m(y.id),className:"px-3 py-1 rounded bg-slate-800 hover:bg-slate-700",children:"View"})})]},y.id))})]})}),f&&i.jsx(xb,{evidence:f,pdfData:null,onClose:()=>m(null)})]}),t==="claims"&&i.jsx(bb,{claims:l,evidence:a,sections:o,contradictions:h,onClaimClick:y=>console.log("Claim clicked",y==null?void 0:y.id),onAddCitation:y=>console.log("Add citation",y)}),t==="opinions"&&i.jsx(Tb,{claims:l,evidence:a,onSelectOpinion:y=>console.log("Selected opinion",y)}),t==="contradictions"&&i.jsxs("div",{className:"space-y-6",children:[i.jsx(Ab,{claims:l,evidence:a,contradictions:h,validation:b,sections:o,referralQuestions:A}),i.jsx(vb,{contradictions:h,claims:l,sections:o,onResolveContradiction:(y,C)=>{u(R=>R.map(S=>S.id===y?{...S,resolution_status:"resolved",resolution_note:C}:S))}})]}),t==="timeline"&&i.jsx(Sb,{evidence:a,events:[],conflicts:[],onAddEvent:y=>console.log("Add event",y)}),t==="methodology"&&i.jsx(_b,{evidence:a,evaluationType:n.case_type==="custody"?"child_custody":n.case_type,onGenerate:y=>console.log("Generated methodology appendix",y)}),t==="gates"&&i.jsx(Cb,{claims:l,contradictions:h,evidence:a,sections:o,validation:b,referralQuestions:A,onExport:()=>s("export"),onOverride:(y,C)=>console.log("Override gate",y,C)}),t==="export"&&i.jsx(kb,{reportId:"REPORT-DEMO-001",caseId:n.id,caseNumber:n.case_number,evaluatorName:"Evaluator (Demo)",claims:l,evidence:a,contradictions:h,sections:o,limitations:g,onExport:y=>console.log("Export requested",y)})]})]})})}function Fb(){return{id:"EDU-DEMO-001",case_number:"EDU-2026-001",student_pseudonym:"Student A",school:"Demo Middle School",referral_date:new Date().toISOString().slice(0,10),meeting_date:void 0,case_type:"IEP"}}function Ob(){return[{id:"GATE-EDU-001",title:"Consent / Authority Recorded",status:"warn",message:"Consent date not set. Record parent consent or legal authority before evaluation activities."},{id:"GATE-EDU-002",title:"Timeline Consistency",status:"pass",message:"All key dates appear internally consistent."},{id:"GATE-EDU-003",title:"Recommendations Have Basis Links",status:"fail",message:"2 recommendations lack linked supporting data sources. Add basis links or mark as team decision."}]}function $b({onHome:c,onBack:e}){const[t,s]=T.useState("overview"),[n,a]=T.useState(()=>Fb()),o=T.useMemo(()=>Ob(),[]),l=o.filter(p=>p.status==="pass").length,d=o.filter(p=>p.status==="fail").length,h=o.filter(p=>p.status==="warn").length,u=[{id:"overview",label:"Overview",icon:i.jsx(Rd,{className:"w-4 h-4"})},{id:"intake",label:"Referral / Intake",icon:i.jsx(Ap,{className:"w-4 h-4"})},{id:"data",label:"Data Sources",icon:i.jsx(Dt,{className:"w-4 h-4"})},{id:"report",label:"Report Builder",icon:i.jsx(Dt,{className:"w-4 h-4"})},{id:"gates",label:"Pre-flight Gates",icon:i.jsx(id,{className:"w-4 h-4"})},{id:"export",label:"Freeze & Export",icon:i.jsx(oo,{className:"w-4 h-4"})}];return i.jsx(Dp,{sidebar:i.jsx("div",{className:"space-y-2",children:u.map(p=>i.jsx(Op,{icon:p.icon,label:p.label,isActive:t===p.id,onClick:()=>s(p.id)},p.id))}),children:i.jsxs("div",{className:"space-y-6",children:[i.jsx(Fp,{title:"Evidify EDU",subtitle:"504 / IEP defensibility workspace (beta)",onHome:c!=null?c:()=>{},showBack:!!e,onBack:e,actions:i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx(qu,{variant:d>0?"danger":h>0?"warning":"success",children:d>0?`${d} blocking`:h>0?`${h} advisory`:"Ready"}),i.jsxs(Wu,{variant:"secondary",onClick:()=>{alert("EDU export is UI-only in v0.1. Next sprint will generate a verifier-backed export pack.")},children:[i.jsx(oo,{className:"w-4 h-4"}),"Export"]})]})}),t==="overview"&&i.jsxs("div",{className:"space-y-6",children:[i.jsxs(Fs,{children:[i.jsxs("div",{className:"mb-4",children:[i.jsx("div",{className:"text-sm font-semibold text-slate-100",children:"Case Header"}),i.jsx("div",{className:"text-xs text-slate-400",children:"PHI-free demo case (replace with real persistence later)"})]}),i.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[i.jsxs("div",{children:[i.jsx("label",{className:"block text-xs text-slate-400 mb-1",children:"Case Number"}),i.jsx("input",{value:n.case_number,onChange:p=>a(m=>({...m,case_number:p.target.value})),className:"w-full px-3 py-2 rounded-lg bg-slate-900/60 border border-slate-700 text-sm"})]}),i.jsxs("div",{children:[i.jsx("label",{className:"block text-xs text-slate-400 mb-1",children:"Student Pseudonym"}),i.jsx("input",{value:n.student_pseudonym,onChange:p=>a(m=>({...m,student_pseudonym:p.target.value})),className:"w-full px-3 py-2 rounded-lg bg-slate-900/60 border border-slate-700 text-sm"})]}),i.jsxs("div",{children:[i.jsx("label",{className:"block text-xs text-slate-400 mb-1",children:"School"}),i.jsx("input",{value:n.school,onChange:p=>a(m=>({...m,school:p.target.value})),className:"w-full px-3 py-2 rounded-lg bg-slate-900/60 border border-slate-700 text-sm"})]}),i.jsxs("div",{children:[i.jsx("label",{className:"block text-xs text-slate-400 mb-1",children:"Case Type"}),i.jsxs("select",{value:n.case_type,onChange:p=>a(m=>({...m,case_type:p.target.value})),className:"w-full px-3 py-2 rounded-lg bg-slate-900/60 border border-slate-700 text-sm",children:[i.jsx("option",{value:"IEP",children:"IEP"}),i.jsx("option",{value:"504",children:"504"}),i.jsx("option",{value:"eligibility",children:"Eligibility"}),i.jsx("option",{value:"reeval",children:"Re-evaluation"}),i.jsx("option",{value:"other",children:"Other"})]})]})]})]}),i.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[i.jsx(Ro,{label:"Gates Passing",value:String(l),icon:i.jsx(Zt,{className:"w-4 h-4"})}),i.jsx(Ro,{label:"Advisories",value:String(h),icon:i.jsx(Es,{className:"w-4 h-4"})}),i.jsx(Ro,{label:"Blocking",value:String(d),icon:i.jsx(Es,{className:"w-4 h-4"})})]}),i.jsxs(Fs,{children:[i.jsxs("div",{className:"mb-4",children:[i.jsx("div",{className:"text-sm font-semibold text-slate-100",children:"What Evidify EDU is"}),i.jsx("div",{className:"text-xs text-slate-400",children:"Positioning: not an IEP platform replacement"})]}),i.jsxs("ul",{className:"list-disc pl-6 text-sm text-slate-300 space-y-2",children:[i.jsx("li",{children:"A defensibility wrapper for the documentation that is most likely to be reviewed in due process, OCR complaints, or state audits."}),i.jsx("li",{children:"Offline-first by default: no cloud sync, no student data egress unless you intentionally export."}),i.jsx("li",{children:"Freeze & Export is designed to produce a deterministic, verifier-checkable pack (next sprint integration)."})]})]})]}),t==="intake"&&i.jsx("div",{className:"space-y-6",children:i.jsxs(Fs,{children:[i.jsxs("div",{className:"mb-4",children:[i.jsx("div",{className:"text-sm font-semibold text-slate-100",children:"Referral / Intake"}),i.jsx("div",{className:"text-xs text-slate-400",children:"Dates here feed the timeline gate"})]}),i.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[i.jsxs("div",{children:[i.jsx("label",{className:"block text-xs text-slate-400 mb-1",children:"Referral Date"}),i.jsx("input",{type:"date",value:n.referral_date,onChange:p=>a(m=>({...m,referral_date:p.target.value})),className:"w-full px-3 py-2 rounded-lg bg-slate-900/60 border border-slate-700 text-sm"})]}),i.jsxs("div",{children:[i.jsx("label",{className:"block text-xs text-slate-400 mb-1",children:"Meeting Date (IEP/504)"}),i.jsx("input",{type:"date",value:n.meeting_date||"",onChange:p=>a(m=>({...m,meeting_date:p.target.value||void 0})),className:"w-full px-3 py-2 rounded-lg bg-slate-900/60 border border-slate-700 text-sm"})]})]}),i.jsx("div",{className:"mt-4 text-xs text-slate-400",children:"In v0.1, these are UI-only. In v0.2, they will be validated by the EDU gate engine (GATE-EDU-002)."})]})}),t==="data"&&i.jsxs(Fs,{children:[i.jsxs("div",{className:"mb-4",children:[i.jsx("div",{className:"text-sm font-semibold text-slate-100",children:"Data Sources"}),i.jsx("div",{className:"text-xs text-slate-400",children:"Attach tests, observations, records (UI-only in v0.1)"})]}),i.jsx("div",{className:"text-sm text-slate-300",children:"Planned: structured source types, basis-linking, and per-source reliability scoring."})]}),t==="report"&&i.jsxs(Fs,{children:[i.jsxs("div",{className:"mb-4",children:[i.jsx("div",{className:"text-sm font-semibold text-slate-100",children:"Report Builder"}),i.jsx("div",{className:"text-xs text-slate-400",children:"Draft report sections with basis-linked recommendations"})]}),i.jsx("div",{className:"text-sm text-slate-300",children:"Planned: eligibility-domain scaffolds, language discipline presets, and export-ready report templates."})]}),t==="gates"&&i.jsxs(Fs,{children:[i.jsxs("div",{className:"mb-4",children:[i.jsx("div",{className:"text-sm font-semibold text-slate-100",children:"Pre-flight Gates"}),i.jsx("div",{className:"text-xs text-slate-400",children:"Blocking gates prevent Freeze & Export in later sprints"})]}),i.jsx("div",{className:"space-y-3",children:o.map(p=>i.jsxs("div",{className:"flex items-start gap-3 p-3 rounded-xl border border-slate-700 bg-slate-900/40",children:[i.jsxs("div",{className:"mt-0.5",children:[p.status==="pass"&&i.jsx(Zt,{className:"w-5 h-5 text-green-400"}),p.status==="warn"&&i.jsx(Es,{className:"w-5 h-5 text-amber-400"}),p.status==="fail"&&i.jsx(Es,{className:"w-5 h-5 text-red-400"})]}),i.jsxs("div",{className:"flex-1",children:[i.jsxs("div",{className:"flex items-center justify-between gap-2",children:[i.jsxs("div",{className:"font-semibold text-white text-sm",children:[p.id,": ",p.title]}),i.jsx(qu,{variant:p.status==="pass"?"success":p.status==="warn"?"warning":"danger",children:p.status.toUpperCase()})]}),i.jsx("div",{className:"text-sm text-slate-300 mt-1",children:p.message})]})]},p.id))})]}),t==="export"&&i.jsxs(Fs,{children:[i.jsxs("div",{className:"mb-4",children:[i.jsx("div",{className:"text-sm font-semibold text-slate-100",children:"Freeze & Export"}),i.jsx("div",{className:"text-xs text-slate-400",children:"Deterministic export packs come in v0.2"})]}),i.jsxs("div",{className:"space-y-3 text-sm text-slate-300",children:[i.jsx("p",{children:"The EDU module will reuse the Forensic defensibility architecture: canonicalization → freeze pocket → hash-chained audit → verifier."}),i.jsx("p",{className:"text-slate-400",children:"For now, this tab is a placeholder so we can iterate on the UI/UX without risking the Forensic golden CI assets."}),i.jsxs(Wu,{variant:"primary",onClick:()=>alert("Coming next: Freeze & Export (EDU) →produces export_manifest.json + events.jsonl + ledger.json"),children:[i.jsx(id,{className:"w-4 h-4"}),"Freeze & Export (coming)"]})]})]})]})})}function ke({icon:c,title:e,description:t,badge:s,badgeColor:n="bg-blue-500",demo:a}){const[o,l]=T.useState(!1);return i.jsxs("div",{className:"bg-slate-800/80 rounded-xl p-5 border border-slate-700 hover:border-slate-600 transition-all hover:transform hover:scale-[1.02]",children:[i.jsxs("div",{className:"flex items-start gap-4",children:[i.jsx("div",{className:"p-3 bg-gradient-to-br from-blue-500/20 to-purple-500/20 rounded-xl",children:c}),i.jsxs("div",{className:"flex-1",children:[i.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[i.jsx("h4",{className:"font-semibold text-white",children:e}),s&&i.jsx("span",{className:`px-2 py-0.5 ${n} rounded-full text-xs font-medium`,children:s})]}),i.jsx("p",{className:"text-sm text-slate-400 leading-relaxed",children:t}),a&&i.jsxs("button",{onClick:()=>l(!o),className:"mt-2 text-xs text-blue-400 hover:text-blue-300 flex items-center gap-1",children:[i.jsx(Zf,{className:"w-3 h-3"}),o?"Hide Demo":"See Demo"]})]})]}),a&&o&&i.jsx("div",{className:"mt-4 p-4 bg-slate-900/50 rounded-lg border border-slate-600",children:a})]})}function Hb({onClose:c}){const[e,t]=T.useState("privacy"),[s,n]=T.useState(!1);T.useEffect(()=>{setTimeout(()=>n(!0),50)},[]);const a=[{id:"privacy",label:"Privacy & Security",icon:i.jsx(si,{className:"w-4 h-4"})},{id:"ai",label:"AI Features",icon:i.jsx(Bu,{className:"w-4 h-4"})},{id:"clinical",label:"Clinical Tools",icon:i.jsx(ng,{className:"w-4 h-4"})},{id:"productivity",label:"Productivity",icon:i.jsx(Qf,{className:"w-4 h-4"})}];return i.jsx("div",{className:"fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[100] p-4",children:i.jsxs("div",{className:`bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 rounded-2xl max-w-5xl w-full max-h-[90vh] overflow-hidden border border-slate-700 shadow-2xl transition-all duration-500 ${s?"opacity-100 scale-100":"opacity-0 scale-95"}`,children:[i.jsxs("div",{className:"relative overflow-hidden",children:[i.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-blue-600/20 via-purple-600/20 to-pink-600/20"}),i.jsx("div",{className:"absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PHBhdHRlcm4gaWQ9ImdyaWQiIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgcGF0dGVyblVuaXRzPSJ1c2VyU3BhY2VPblVzZSI+PHBhdGggZD0iTSAwIDEwIEwgNDAgMTAgTSAxMCAwIEwgMTAgNDAgTSAwIDIwIEwgNDAgMjAgTSAyMCAwIEwgMjAgNDAgTSAwIDMwIEwgNDAgMzAgTSAzMCAwIEwgMzAgNDAiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzMzMyIgb3BhY2l0eT0iMC4xIiBzdHJva2Utd2lkdGg9IjEiLz48L3BhdHRlcm4+PC9kZWZzPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InVybCgjZ3JpZCkiLz48L3N2Zz4=')] opacity-30"}),i.jsxs("div",{className:"relative px-8 py-8",children:[i.jsx("button",{onClick:c,className:"absolute top-4 right-4 p-2 text-slate-400 hover:text-white hover:bg-slate-700/50 rounded-lg transition-colors",children:i.jsx(Io,{className:"w-5 h-5"})}),i.jsxs("div",{className:"flex items-center gap-4 mb-4",children:[i.jsx("div",{className:"p-3 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl shadow-lg shadow-blue-500/25",children:i.jsx(Ac,{className:"w-8 h-8 text-white"})}),i.jsxs("div",{children:[i.jsx("h2",{className:"text-3xl font-bold bg-gradient-to-r from-white via-blue-100 to-purple-200 bg-clip-text text-transparent",children:"Welcome to Evidify Beta"}),i.jsx("p",{className:"text-slate-400 mt-1",children:"The future of clinical documentation is local-first, AI-powered, and defensible"})]})]}),i.jsxs("div",{className:"flex gap-6 mt-6",children:[i.jsxs("div",{className:"flex items-center gap-2 px-4 py-2 bg-slate-800/50 rounded-lg border border-slate-700",children:[i.jsx(Ja,{className:"w-4 h-4 text-green-400"}),i.jsxs("span",{className:"text-sm",children:[i.jsx("strong",{className:"text-white",children:"7→3 hrs"})," ",i.jsx("span",{className:"text-slate-400",children:"avg note time"})]})]}),i.jsxs("div",{className:"flex items-center gap-2 px-4 py-2 bg-slate-800/50 rounded-lg border border-slate-700",children:[i.jsx(si,{className:"w-4 h-4 text-blue-400"}),i.jsxs("span",{className:"text-sm",children:[i.jsx("strong",{className:"text-white",children:"100%"})," ",i.jsx("span",{className:"text-slate-400",children:"local data"})]})]}),i.jsxs("div",{className:"flex items-center gap-2 px-4 py-2 bg-slate-800/50 rounded-lg border border-slate-700",children:[i.jsx(tg,{className:"w-4 h-4 text-amber-400"}),i.jsxs("span",{className:"text-sm",children:[i.jsx("strong",{className:"text-white",children:"HIPAA"})," ",i.jsx("span",{className:"text-slate-400",children:"by design"})]})]})]})]})]}),i.jsx("div",{className:"px-8 py-4 border-b border-slate-700 bg-slate-800/50",children:i.jsx("div",{className:"flex gap-2",children:a.map(o=>i.jsxs("button",{onClick:()=>t(o.id),className:`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all ${e===o.id?"bg-blue-600 text-white shadow-lg shadow-blue-600/25":"text-slate-400 hover:text-white hover:bg-slate-700"}`,children:[o.icon,o.label]},o.id))})}),i.jsxs("div",{className:"p-8 overflow-y-auto max-h-[50vh]",children:[e==="privacy"&&i.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[i.jsx(ke,{icon:i.jsx(jp,{className:"w-6 h-6 text-blue-400"}),title:"100% Local Storage",badge:"Zero Cloud",badgeColor:"bg-green-500/80",description:"All patient data stays on YOUR device. No cloud servers, no data centers, no third-party access. Your notes never leave your machine."}),i.jsx(ke,{icon:i.jsx(pu,{className:"w-6 h-6 text-purple-400"}),title:"AES-256 Encryption",badge:"Military Grade",badgeColor:"bg-purple-500/80",description:"SQLCipher encrypts everything at rest. Keys stored in macOS Keychain or Windows Credential Manager. Even if someone steals your laptop, data stays protected."}),i.jsx(ke,{icon:i.jsx(Ep,{className:"w-6 h-6 text-red-400"}),title:"Air-Gap Ready",badge:"Enterprise",badgeColor:"bg-red-500/80",description:"Disconnect from the network entirely. Run Ollama locally for AI. Perfect for high-security environments, VA settings, or maximum paranoia."}),i.jsx(ke,{icon:i.jsx(Sp,{className:"w-6 h-6 text-amber-400"}),title:"Tamper-Proof Audit Trail",badge:"Defensible",badgeColor:"bg-amber-500/80",description:"Every edit, sign, and export is cryptographically logged. Hash chains verify note integrity. Prove exactly what was documented and when."}),i.jsx(ke,{icon:i.jsx(ig,{className:"w-6 h-6 text-cyan-400"}),title:"PHI De-identification",badge:"Safe Harbor",badgeColor:"bg-cyan-500/80",description:"Create consultation drafts with all 18 HIPAA identifiers stripped. AI-assisted detection catches names, dates, locations, and more."}),i.jsx(ke,{icon:i.jsx(_p,{className:"w-6 h-6 text-emerald-400"}),title:"Export Attestation",badge:"Compliance",badgeColor:"bg-emerald-500/80",description:"Before any data leaves the app, you must attest to risk flags and safety items. Creates audit record of clinical review."})]}),e==="ai"&&i.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[i.jsx(ke,{icon:i.jsx(Bu,{className:"w-6 h-6 text-purple-400"}),title:"Local AI Processing",badge:"Ollama",badgeColor:"bg-purple-500/80",description:"Run Llama, Mistral, or Qwen models directly on your Mac. AI assistance without sending PHI anywhere. Works offline too.",demo:i.jsxs("div",{className:"text-xs font-mono text-slate-300 space-y-1",children:[i.jsx("div",{className:"text-slate-500",children:"# Install Ollama, then:"}),i.jsx("div",{children:"ollama pull qwen2.5:7b-instruct"}),i.jsx("div",{className:"text-slate-500",children:"# Evidify auto-detects it!"})]})}),i.jsx(ke,{icon:i.jsx(Ac,{className:"w-6 h-6 text-blue-400"}),title:"AI Note Structuring",badge:"New",badgeColor:"bg-blue-500/80",description:"Turn messy session notes into properly structured SOAP, DAP, or custom formats. One click transforms your raw notes into professional documentation.",demo:i.jsxs("div",{className:"text-xs space-y-2",children:[i.jsx("div",{className:"p-2 bg-slate-800 rounded text-slate-400",children:'"pt anxious, trouble sleeping, did CBT work..."'}),i.jsx("div",{className:"flex justify-center",children:i.jsx(Ac,{className:"w-4 h-4 text-blue-400 animate-pulse"})}),i.jsxs("div",{className:"p-2 bg-slate-800 rounded text-slate-300",children:[i.jsx("div",{className:"font-bold text-blue-400",children:"SUBJECTIVE:"}),i.jsx("div",{children:"Client reports anxiety and sleep difficulties..."})]})]})}),i.jsx(ke,{icon:i.jsx(lo,{className:"w-6 h-6 text-red-400"}),title:"Voice Transcription",badge:"Whisper",badgeColor:"bg-red-500/80",description:"Dictate your notes and get instant transcription. Whisper runs locally—your voice recordings never leave your device."}),i.jsx(ke,{icon:i.jsx(ti,{className:"w-6 h-6 text-green-400"}),title:"RAG Search",badge:"Semantic",badgeColor:"bg-green-500/80",description:"Ask questions about your clinical records in natural language. 'What interventions worked for this client's anxiety?' Find relevant excerpts across all notes."}),i.jsx(ke,{icon:i.jsx(Xf,{className:"w-6 h-6 text-amber-400"}),title:"Treatment Progress Analysis",badge:"New",badgeColor:"bg-amber-500/80",description:"AI analyzes themes across sessions—identifies improving areas, emerging concerns, and treatment patterns. See the big picture of client progress."}),i.jsx(ke,{icon:i.jsx(sd,{className:"w-6 h-6 text-pink-400"}),title:"Smart Risk Detection",badge:"Safety",badgeColor:"bg-pink-500/80",description:"Automatic flagging of safety keywords (SI, HI, abuse). Ensures you document risk assessments when clinical content warrants it."})]}),e==="clinical"&&i.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[i.jsx(ke,{icon:i.jsx(Rd,{className:"w-6 h-6 text-blue-400"}),title:"Mental Status Exam Builder",badge:"New",badgeColor:"bg-blue-500/80",description:"Structured MSE input with all 9 domains: Appearance, Behavior, Speech, Mood, Affect, Thought Process, Thought Content, Cognition, and Insight/Judgment.",demo:i.jsx("div",{className:"grid grid-cols-3 gap-2 text-xs",children:["Appearance","Behavior","Speech","Mood","Affect","Cognition"].map(o=>i.jsxs("div",{className:"p-2 bg-slate-800 rounded text-center",children:[i.jsx("div",{className:"text-slate-500",children:o}),i.jsx("div",{className:"text-green-400 text-xs",children:"WNL"})]},o))})}),i.jsx(ke,{icon:i.jsx(Es,{className:"w-6 h-6 text-red-400"}),title:"Risk Assessment Panel",badge:"New",badgeColor:"bg-red-500/80",description:"Visual risk capture with SI/HI/Self-Harm severity buttons, Safety Plan status, Protective Factors, and Overall Risk Level. One-click attestation.",demo:i.jsxs("div",{className:"flex gap-2 flex-wrap",children:[i.jsx("span",{className:"px-2 py-1 bg-green-500/20 text-green-400 rounded text-xs",children:"SI Denied"}),i.jsx("span",{className:"px-2 py-1 bg-green-500/20 text-green-400 rounded text-xs",children:"HI Denied"}),i.jsx("span",{className:"px-2 py-1 bg-blue-500/20 text-blue-400 rounded text-xs",children:"Safety Plan Active"}),i.jsx("span",{className:"px-2 py-1 bg-slate-600 text-slate-300 rounded text-xs",children:"Low Risk"})]})}),i.jsx(ke,{icon:i.jsx(Dt,{className:"w-6 h-6 text-emerald-400"}),title:"Multiple Note Types",description:"Progress notes, Intake assessments, Crisis documentation, Phone consultations, Group therapy, and Termination summaries—each with appropriate templates."}),i.jsx(ke,{icon:i.jsx(Do,{className:"w-6 h-6 text-purple-400"}),title:"Client Management",description:"Full client profiles with demographics, emergency contacts, insurance info, diagnosis codes, treatment start dates, and referring providers."}),i.jsx(ke,{icon:i.jsx(Lo,{className:"w-6 h-6 text-cyan-400"}),title:"Consultation Drafts",badge:"De-identified",badgeColor:"bg-cyan-500/80",description:"Create shareable consultation requests with PHI automatically stripped. Get peer input on complex cases without privacy concerns."}),i.jsx(ke,{icon:i.jsx(Yd,{className:"w-6 h-6 text-amber-400"}),title:"Document Attachments",description:"Attach PDFs, images, and documents to client records. OCR extracts text for search. Everything encrypted and stored locally."})]}),e==="productivity"&&i.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[i.jsx(ke,{icon:i.jsx(Ja,{className:"w-6 h-6 text-green-400"}),title:"Session Time Tracking",badge:"New",badgeColor:"bg-green-500/80",description:"Live timer during note capture. See exactly how long documentation takes. Track your efficiency gains over time—prove ROI.",demo:i.jsxs("div",{className:"flex items-center gap-4",children:[i.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 bg-slate-800 rounded-lg",children:[i.jsx(Ja,{className:"w-4 h-4 text-green-400"}),i.jsx("span",{className:"font-mono text-lg text-white",children:"12:34"})]}),i.jsx("div",{className:"text-xs text-slate-400",children:"Recording session duration"})]})}),i.jsx(ke,{icon:i.jsx(Yf,{className:"w-6 h-6 text-blue-400"}),title:"Performance Metrics",badge:"ProvenNote",badgeColor:"bg-blue-500/80",description:"Dashboard showing time saved, notes completed, AI acceptance rate, and compliance scores. Real data to justify your investment."}),i.jsx(ke,{icon:i.jsx(ti,{className:"w-6 h-6 text-purple-400"}),title:"Advanced Note Search",badge:"New",badgeColor:"bg-purple-500/80",description:"Filter notes by text content, note type (progress, intake, crisis...), and status (draft, reviewed, signed). Find what you need instantly."}),i.jsx(ke,{icon:i.jsx(fu,{className:"w-6 h-6 text-amber-400"}),title:"Formatted Export",badge:"New",badgeColor:"bg-amber-500/80",description:"One-click export to clipboard with professional formatting—practice name, client info, note content, and clinician signature. Ready to paste into any EHR.",demo:i.jsxs("div",{className:"text-xs font-mono text-slate-400 space-y-1",children:[i.jsx("div",{children:"─────────────────────"}),i.jsx("div",{children:"CLIENT: John D."}),i.jsx("div",{children:"DATE: 01/09/2026"}),i.jsx("div",{children:"─────────────────────"}),i.jsx("div",{className:"text-slate-300",children:"[Note content...]"}),i.jsx("div",{children:"─────────────────────"}),i.jsx("div",{children:"Dr. Smith, PhD, ABPP"})]})}),i.jsx(ke,{icon:i.jsx(hc,{className:"w-6 h-6 text-emerald-400"}),title:"Clinician Profile",badge:"New",badgeColor:"bg-emerald-500/80",description:"Set your name, credentials, license number, practice name, and default note footer. Auto-populated in all exports and signatures."}),i.jsx(ke,{icon:i.jsx(oo,{className:"w-6 h-6 text-cyan-400"}),title:"Flexible Export Options",description:"Export to Markdown, JSON, or plain text. Print-ready formatting with headers and signatures. Future: direct EHR integrations."})]})]}),i.jsx("div",{className:"px-8 py-6 border-t border-slate-700 bg-slate-800/50",children:i.jsxs("div",{className:"flex items-center justify-between",children:[i.jsxs("div",{className:"flex items-center gap-3",children:[i.jsx("div",{className:"flex items-center gap-1",children:[1,2,3,4,5].map(o=>i.jsx(ug,{className:"w-4 h-4 text-amber-400 fill-amber-400"},o))}),i.jsx("span",{className:"text-sm text-slate-400",children:"Help us improve—your feedback shapes the product!"})]}),i.jsx("div",{className:"flex items-center gap-3",children:i.jsxs("button",{onClick:c,className:"px-6 py-2.5 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 rounded-lg font-medium transition-all shadow-lg shadow-blue-600/25 flex items-center gap-2",children:[i.jsx(lg,{className:"w-4 h-4"}),"Start Using Evidify"]})})]})})]})})}function Su({onHome:c,title:e,showBack:t,onBack:s}){return i.jsx("div",{className:"fixed top-0 left-0 right-0 z-50 bg-slate-900/95 backdrop-blur-sm border-b border-slate-700",children:i.jsxs("div",{className:"max-w-6xl mx-auto px-4 py-2 flex items-center justify-between",children:[i.jsxs("div",{className:"flex items-center gap-3",children:[i.jsxs("button",{onClick:c,className:"flex items-center gap-2 px-3 py-1.5 bg-slate-800 hover:bg-slate-700 rounded-lg text-sm font-medium transition-colors",title:"Go to Dashboard",children:[i.jsx(Cp,{className:"w-4 h-4"}),i.jsx("span",{className:"hidden sm:inline",children:"Dashboard"})]}),t&&s&&i.jsxs("button",{onClick:s,className:"flex items-center gap-1 px-3 py-1.5 text-slate-400 hover:text-white rounded-lg text-sm transition-colors",children:[i.jsx(mu,{className:"w-4 h-4"}),"Back"]})]}),e&&i.jsx("div",{className:"text-sm font-medium text-slate-400 truncate max-w-xs",children:e}),i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx("span",{className:"text-xs text-slate-500 hidden sm:inline",children:"Evidify"}),i.jsx(si,{className:"w-4 h-4 text-cyan-500"})]})]})})}function Bb(){const[c,e]=T.useState({screen:"edu",vaultStatus:null,ollamaStatus:null,clients:[],selectedClient:null,clientNotes:[],currentNote:null,ethicsAnalysis:null,error:null,noteStartTime:null}),t=T.useCallback(async()=>{try{const[n,a]=await Promise.all([Vu(),Ig().catch(()=>({available:!1,models:[],error:"Ollama status unavailable"}))]),o=n;if(o.state==="no_vault"){e(d=>({...d,screen:"create-vault",vaultStatus:o,ollamaStatus:a}));return}if(o.state==="stale_keychain"){e(d=>({...d,screen:"stale-keychain",vaultStatus:o,ollamaStatus:a}));return}if(o.state==="keychain_lost"){e(d=>({...d,screen:"keychain-lost",vaultStatus:o,ollamaStatus:a}));return}if(o.state==="ready"){e(d=>({...d,screen:"unlock",vaultStatus:o,ollamaStatus:a}));return}const l=await Cg();e(d=>({...d,screen:"dashboard",vaultStatus:o,ollamaStatus:a,clients:l}))}catch(n){console.error("refresh failed:",n);try{const a=await Vu();a.state==="no_vault"?e(o=>({...o,screen:"create-vault",vaultStatus:a})):a.state==="ready"?e(o=>({...o,screen:"unlock",vaultStatus:a})):a.state==="stale_keychain"?e(o=>({...o,screen:"stale-keychain",vaultStatus:a})):a.state==="keychain_lost"?e(o=>({...o,screen:"keychain-lost",vaultStatus:a})):e(o=>({...o,screen:"unlock",vaultStatus:a,error:String(n)}))}catch(a){e(o=>({...o,screen:"unlock",error:`Failed to check vault status: ${a}`}))}}},[]);T.useEffect(()=>{t()},[t]);async function s(){await t()}switch(c.screen){case"loading":return i.jsx(fp,{});case"create-vault":return i.jsx(zb,{onCreated:s});case"unlock":return i.jsx(Ub,{onUnlocked:s});case"keychain-lost":return i.jsx(Gb,{vaultStatus:c.vaultStatus,onRetry:s,onDeleteDb:async()=>{await Ag(),await s()}});case"stale-keychain":return i.jsx(Vb,{vaultStatus:c.vaultStatus,onRetry:s,onClearKeychain:async()=>{await jg(),await s()}});case"dashboard":return i.jsx(qb,{clients:c.clients,ollamaStatus:c.ollamaStatus,onSelectClient:async n=>{try{const a=await _c(n.id);e(o=>({...o,screen:"client-detail",selectedClient:n,clientNotes:a}))}catch(a){console.error("Failed to load client notes:",a),e(o=>({...o,screen:"client-detail",selectedClient:n,clientNotes:[]}))}},onStartCapture:n=>e(a=>({...a,screen:"capture",selectedClient:n,noteStartTime:new Date().toISOString()})),onRefresh:s,onNoteSelect:async n=>{try{const a=await Kd(n),o=c.clients.find(l=>l.id===a.client_id);if(o)e(l=>({...l,screen:"done",currentNote:a,selectedClient:o}));else{const l=await Sg(a.client_id);e(d=>({...d,screen:"done",currentNote:a,selectedClient:l}))}}catch(a){console.error("Failed to load note:",a),alert("Failed to load note: "+String(a))}},onForensicMode:()=>e(n=>({...n,screen:"forensic"})),onEduMode:()=>e(n=>({...n,screen:"edu"}))});case"client-detail":return i.jsx(Xb,{client:c.selectedClient,notes:c.clientNotes,ollamaStatus:c.ollamaStatus,onBack:()=>e(n=>({...n,screen:"dashboard",selectedClient:null,clientNotes:[]})),onNewNote:()=>e(n=>({...n,screen:"capture",noteStartTime:new Date().toISOString()})),onViewNote:n=>e(a=>({...a,screen:"done",currentNote:n})),onReviewNote:async n=>{try{const a=await Tp(n.content);e(o=>({...o,screen:"review",currentNote:n,ethicsAnalysis:a}))}catch(a){console.error("Failed to analyze note:",a),alert("Failed to analyze note: "+String(a))}},onRefresh:async()=>{if(c.selectedClient){const n=await _c(c.selectedClient.id);e(a=>({...a,clientNotes:n}))}},onClientUpdate:n=>{e(a=>({...a,selectedClient:n,clients:a.clients.map(o=>o.id===n.id?n:o)}))},onNoteSelect:async n=>{try{const a=await Kd(n);e(o=>({...o,screen:"done",currentNote:a}))}catch(a){console.error("Failed to load note:",a),alert("Failed to load note: "+String(a))}}});case"capture":return i.jsx(Yb,{client:c.selectedClient,ollamaStatus:c.ollamaStatus,onComplete:(n,a)=>{a.attest_count>0||a.flag_count>0?e(o=>({...o,screen:"review",currentNote:n,ethicsAnalysis:a})):e(o=>({...o,screen:"done",currentNote:n,ethicsAnalysis:a}))},onCancel:()=>e(n=>({...n,screen:"dashboard",selectedClient:null})),onHome:()=>{s(),e(n=>({...n,screen:"dashboard",currentNote:null,ethicsAnalysis:null,selectedClient:null}))}});case"review":return i.jsx(Kb,{note:c.currentNote,analysis:c.ethicsAnalysis,ollamaStatus:c.ollamaStatus,onComplete:()=>e(n=>({...n,screen:"done"})),onBack:()=>e(n=>({...n,screen:"capture"})),onHome:()=>{s(),e(n=>({...n,screen:"dashboard",currentNote:null,ethicsAnalysis:null,selectedClient:null}))},noteStartTime:c.noteStartTime});case"done":return i.jsx(Jb,{note:c.currentNote,onNewNote:()=>e(n=>({...n,screen:"capture",currentNote:null,ethicsAnalysis:null,noteStartTime:new Date().toISOString()})),onDashboard:()=>{s(),e(n=>({...n,screen:"dashboard",currentNote:null,ethicsAnalysis:null,selectedClient:null}))},onBack:c.selectedClient?()=>{c.selectedClient&&_c(c.selectedClient.id).then(n=>{e(a=>({...a,screen:"client-detail",clientNotes:n,currentNote:null}))}).catch(()=>{e(n=>({...n,screen:"client-detail",currentNote:null}))})}:void 0});case"forensic":return i.jsx(Db,{onHome:()=>{s(),e(n=>({...n,screen:"dashboard",currentNote:null,ethicsAnalysis:null,selectedClient:null}))},onBack:()=>{s(),e(n=>({...n,screen:"dashboard",currentNote:null,ethicsAnalysis:null,selectedClient:null}))}});case"edu":return i.jsx($b,{onHome:()=>{s(),e(n=>({...n,screen:"dashboard",currentNote:null,ethicsAnalysis:null,selectedClient:null}))},onBack:()=>{s(),e(n=>({...n,screen:"dashboard",currentNote:null,ethicsAnalysis:null,selectedClient:null}))}});default:return i.jsx(fp,{})}}function fp(){return i.jsx("div",{className:"min-h-screen flex items-center justify-center",children:i.jsxs("div",{className:"text-center",children:[i.jsx(si,{className:"w-16 h-16 text-blue-500 mx-auto mb-4 animate-pulse"}),i.jsx("h1",{className:"text-2xl font-semibold",children:"Evidify"}),i.jsx("p",{className:"text-slate-400 mt-2",children:"Initializing secure vault..."})]})})}function zb({onCreated:c}){const[e,t]=T.useState(""),[s,n]=T.useState(""),[a,o]=T.useState(!1),[l,d]=T.useState("");async function h(){if(e.length<8){d("Passphrase must be at least 8 characters");return}if(e!==s){d("Passphrases do not match");return}o(!0),d("");try{await bg(e),c()}catch(u){d(String(u)),o(!1)}}return i.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:i.jsxs("div",{className:"max-w-md w-full",children:[i.jsxs("div",{className:"text-center mb-8",children:[i.jsx(si,{className:"w-16 h-16 text-blue-500 mx-auto mb-4"}),i.jsx("h1",{className:"text-3xl font-bold",children:"Create Secure Vault"}),i.jsx("p",{className:"text-slate-400 mt-2",children:"Your data is encrypted with AES-256-GCM and stored locally. Choose a strong passphrase you'll remember."})]}),i.jsxs("div",{className:"bg-slate-800 rounded-lg p-6 space-y-4",children:[i.jsxs("div",{children:[i.jsx("label",{className:"block text-sm font-medium mb-2",children:"Passphrase"}),i.jsx("input",{type:"password",value:e,onChange:u=>t(u.target.value),className:"w-full bg-slate-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"Enter passphrase (min 8 characters)"})]}),i.jsxs("div",{children:[i.jsx("label",{className:"block text-sm font-medium mb-2",children:"Confirm Passphrase"}),i.jsx("input",{type:"password",value:s,onChange:u=>n(u.target.value),className:"w-full bg-slate-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"Confirm passphrase"})]}),l&&i.jsx("div",{className:"bg-red-500/20 text-red-400 px-4 py-2 rounded-lg text-sm",children:l}),i.jsx("button",{onClick:h,disabled:a||!e||!s,className:"w-full bg-blue-600 hover:bg-blue-700 disabled:opacity-50 rounded-lg px-4 py-3 font-medium transition-colors",children:a?"Creating...":"Create Vault"}),i.jsx("p",{className:"text-xs text-slate-500 text-center",children:"There is no password recovery. If you forget your passphrase, your data cannot be recovered."})]})]})})}function Ub({onUnlocked:c}){const[e,t]=T.useState(""),[s,n]=T.useState(!1),[a,o]=T.useState("");async function l(){n(!0),o("");try{await vg(e),c()}catch{o("Invalid passphrase"),n(!1)}}return i.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:i.jsxs("div",{className:"max-w-md w-full",children:[i.jsxs("div",{className:"text-center mb-8",children:[i.jsx(pu,{className:"w-16 h-16 text-blue-500 mx-auto mb-4"}),i.jsx("h1",{className:"text-3xl font-bold",children:"Unlock Vault"}),i.jsx("p",{className:"text-slate-400 mt-2",children:"Enter your passphrase to access your data."})]}),i.jsxs("div",{className:"bg-slate-800 rounded-lg p-6 space-y-4",children:[i.jsxs("div",{children:[i.jsx("label",{className:"block text-sm font-medium mb-2",children:"Passphrase"}),i.jsx("input",{type:"password",value:e,onChange:d=>t(d.target.value),onKeyDown:d=>d.key==="Enter"&&l(),className:"w-full bg-slate-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"Enter passphrase",autoFocus:!0})]}),a&&i.jsx("div",{className:"bg-red-500/20 text-red-400 px-4 py-2 rounded-lg text-sm",children:a}),i.jsx("button",{onClick:l,disabled:s||!e,className:"w-full bg-blue-600 hover:bg-blue-700 disabled:opacity-50 rounded-lg px-4 py-3 font-medium transition-colors",children:s?"Unlocking...":"Unlock"})]})]})})}function Gb({vaultStatus:c,onRetry:e,onDeleteDb:t}){const[s,n]=T.useState(!1);return i.jsx("div",{className:"min-h-screen bg-slate-950 text-slate-100 flex items-center justify-center p-6",children:i.jsxs("div",{className:"w-full max-w-xl space-y-4 rounded-2xl border border-slate-800 bg-slate-900/40 p-6 shadow-xl",children:[i.jsxs("div",{className:"flex items-start gap-3",children:[i.jsx(Es,{className:"w-6 h-6 text-amber-400 mt-0.5"}),i.jsxs("div",{children:[i.jsx("h1",{className:"text-xl font-semibold",children:"Vault key missing from OS keychain"}),i.jsx("p",{className:"mt-1 text-sm text-slate-300",children:"Evidify found an encrypted vault database on disk, but the key material stored in your OS keychain is missing. Without that key, the vault cannot be unlocked and the data is not recoverable by Evidify."})]})]}),i.jsxs("div",{className:"rounded-xl border border-slate-800 bg-slate-950/40 p-4 text-sm text-slate-200 space-y-1",children:[i.jsxs("div",{children:[i.jsx("span",{className:"text-slate-400",children:"State:"})," ",c.state]}),i.jsxs("div",{children:[i.jsx("span",{className:"text-slate-400",children:"DB present:"})," ",String(c.dbExists)]}),i.jsxs("div",{children:[i.jsx("span",{className:"text-slate-400",children:"Keychain present:"})," ",String(c.keychainExists)]}),c.message?i.jsxs("div",{children:[i.jsx("span",{className:"text-slate-400",children:"Message:"})," ",c.message]}):null]}),i.jsxs("div",{className:"text-sm text-slate-300",children:["If you believe your keychain item still exists (for example, restored from backup), click ",i.jsx("span",{className:"font-semibold",children:"Retry"}),". If the key is permanently lost, the only safe remediation is to delete the local vault database and create a new vault."]}),i.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 pt-2",children:[i.jsx("button",{className:"rounded-xl bg-slate-800 hover:bg-slate-700 px-4 py-2 text-sm font-semibold",onClick:()=>e(),disabled:s,children:"Retry"}),i.jsx("button",{className:"rounded-xl bg-rose-600 hover:bg-rose-500 px-4 py-2 text-sm font-semibold",onClick:async()=>{n(!0);try{await t()}finally{n(!1)}},disabled:s,children:s?"Deleting…":"Delete local vault and start over"})]}),i.jsx("div",{className:"text-xs text-slate-500",children:"Note: Evidify is intentionally designed with no vendor recovery. If the OS keychain secret is deleted, the encrypted vault cannot be decrypted."})]})})}function Vb({vaultStatus:c,onRetry:e,onClearKeychain:t}){const[s,n]=T.useState(!1);return i.jsx("div",{className:"min-h-screen bg-slate-950 text-slate-100 flex items-center justify-center p-6",children:i.jsxs("div",{className:"w-full max-w-xl space-y-4 rounded-2xl border border-slate-800 bg-slate-900/40 p-6 shadow-xl",children:[i.jsxs("div",{className:"flex items-start gap-3",children:[i.jsx(uu,{className:"w-6 h-6 text-sky-400 mt-0.5"}),i.jsxs("div",{children:[i.jsx("h1",{className:"text-xl font-semibold",children:"Stale keychain item detected"}),i.jsx("p",{className:"mt-1 text-sm text-slate-300",children:"Evidify found vault key material in the OS keychain, but no vault database exists on disk. This commonly happens if the vault folder was deleted manually."})]})]}),i.jsxs("div",{className:"rounded-xl border border-slate-800 bg-slate-950/40 p-4 text-sm text-slate-200 space-y-1",children:[i.jsxs("div",{children:[i.jsx("span",{className:"text-slate-400",children:"State:"})," ",c.state]}),i.jsxs("div",{children:[i.jsx("span",{className:"text-slate-400",children:"DB present:"})," ",String(c.dbExists)]}),i.jsxs("div",{children:[i.jsx("span",{className:"text-slate-400",children:"Keychain present:"})," ",String(c.keychainExists)]}),c.message?i.jsxs("div",{children:[i.jsx("span",{className:"text-slate-400",children:"Message:"})," ",c.message]}):null]}),i.jsx("div",{className:"text-sm text-slate-300",children:"You can clear the stale keychain item and then create a new vault."}),i.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 pt-2",children:[i.jsx("button",{className:"rounded-xl bg-slate-800 hover:bg-slate-700 px-4 py-2 text-sm font-semibold",onClick:()=>e(),disabled:s,children:"Retry"}),i.jsx("button",{className:"rounded-xl bg-sky-600 hover:bg-sky-500 px-4 py-2 text-sm font-semibold",onClick:async()=>{n(!0);try{await t()}finally{n(!1)}},disabled:s,children:s?"Clearing…":"Clear stale keychain item"})]}),i.jsx("div",{className:"text-xs text-slate-500",children:"Clearing the keychain item does not touch PHI because no vault database was detected."})]})})}function Wb({onClose:c,ollamaStatus:e}){const[t,s]=T.useState(!1),[n,a]=T.useState((e==null?void 0:e.models[0])||""),[o,l]=T.useState(()=>localStorage.getItem("evidify_clinician_name")||""),[d,h]=T.useState(()=>localStorage.getItem("evidify_clinician_credentials")||""),[u,p]=T.useState(()=>localStorage.getItem("evidify_clinician_license")||""),[m,f]=T.useState(()=>localStorage.getItem("evidify_practice_name")||""),[g,b]=T.useState(()=>localStorage.getItem("evidify_note_footer")||""),[A,N]=T.useState(!1),j="~/Library/Application Support/com.evidify.app/evidify.db";function E(){localStorage.setItem("evidify_clinician_name",o),localStorage.setItem("evidify_clinician_credentials",d),localStorage.setItem("evidify_clinician_license",u),localStorage.setItem("evidify_practice_name",m),localStorage.setItem("evidify_note_footer",g),N(!0),setTimeout(()=>N(!1),2e3)}return i.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:i.jsxs("div",{className:"bg-slate-800 rounded-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto",children:[i.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-slate-700",children:[i.jsxs("h2",{className:"text-xl font-semibold flex items-center gap-2",children:[i.jsx(wp,{className:"w-5 h-5"}),"Settings"]}),i.jsx("button",{onClick:c,className:"text-slate-400 hover:text-white",children:i.jsx(Io,{className:"w-5 h-5"})})]}),i.jsxs("div",{className:"p-6 space-y-6",children:[i.jsxs("div",{className:"space-y-4",children:[i.jsxs("h3",{className:"text-lg font-medium flex items-center gap-2",children:[i.jsx(hc,{className:"w-5 h-5 text-emerald-400"}),"Clinician Profile"]}),i.jsxs("div",{className:"bg-slate-700/50 rounded-lg p-4 space-y-4",children:[i.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[i.jsxs("div",{children:[i.jsx("label",{className:"block text-sm font-medium mb-1",children:"Full Name"}),i.jsx("input",{type:"text",value:o,onChange:_=>l(_.target.value),placeholder:"Dr. Jane Smith",className:"w-full bg-slate-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"})]}),i.jsxs("div",{children:[i.jsx("label",{className:"block text-sm font-medium mb-1",children:"Credentials"}),i.jsx("input",{type:"text",value:d,onChange:_=>h(_.target.value),placeholder:"PhD, ABPP",className:"w-full bg-slate-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"})]})]}),i.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[i.jsxs("div",{children:[i.jsx("label",{className:"block text-sm font-medium mb-1",children:"License Number"}),i.jsx("input",{type:"text",value:u,onChange:_=>p(_.target.value),placeholder:"PSY123456",className:"w-full bg-slate-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"})]}),i.jsxs("div",{children:[i.jsx("label",{className:"block text-sm font-medium mb-1",children:"Practice Name"}),i.jsx("input",{type:"text",value:m,onChange:_=>f(_.target.value),placeholder:"Mindful Psychology Associates",className:"w-full bg-slate-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"})]})]}),i.jsxs("div",{children:[i.jsx("label",{className:"block text-sm font-medium mb-1",children:"Default Note Footer"}),i.jsx("textarea",{value:g,onChange:_=>b(_.target.value),placeholder:"This note was completed within 24 hours of service delivery...",rows:2,className:"w-full bg-slate-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"})]}),i.jsxs("div",{className:"flex items-center justify-between",children:[i.jsx("p",{className:"text-xs text-slate-400",children:"Profile info used for note signatures and exports"}),i.jsx("button",{onClick:E,className:`px-4 py-1.5 rounded-lg text-sm font-medium transition-all ${A?"bg-green-500/20 text-green-400":"bg-emerald-600 hover:bg-emerald-700"}`,children:A?"Saved":"Save Profile"})]})]})]}),i.jsxs("div",{className:"space-y-4",children:[i.jsxs("h3",{className:"text-lg font-medium flex items-center gap-2",children:[i.jsx(hg,{className:"w-5 h-5 text-blue-400"}),"AI Configuration"]}),i.jsxs("div",{className:"bg-slate-700/50 rounded-lg p-4 space-y-4",children:[i.jsxs("div",{className:"flex items-center justify-between",children:[i.jsxs("div",{children:[i.jsx("p",{className:"font-medium",children:"AI Status"}),i.jsx("p",{className:"text-sm text-slate-400",children:e!=null&&e.available?"Connected to Ollama":"Running in offline mode"})]}),i.jsx("div",{className:`px-3 py-1 rounded-full text-sm ${e!=null&&e.available?"bg-green-500/20 text-green-400":"bg-yellow-500/20 text-yellow-400"}`,children:e!=null&&e.available?"Connected":"Offline"})]}),(e==null?void 0:e.available)&&e.models.length>0&&i.jsxs("div",{children:[i.jsx("label",{className:"block text-sm font-medium mb-2",children:"Active Model"}),i.jsx("select",{value:n,onChange:_=>a(_.target.value),className:"w-full bg-slate-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",children:e.models.map(_=>i.jsx("option",{value:_,children:_},_))})]})]})]}),i.jsxs("div",{className:"space-y-4",children:[i.jsxs("h3",{className:"text-lg font-medium flex items-center gap-2",children:[t?i.jsx(Ep,{className:"w-5 h-5 text-red-400"}):i.jsx(pg,{className:"w-5 h-5 text-green-400"}),"Network & Air-Gap Mode"]}),i.jsxs("div",{className:"bg-slate-700/50 rounded-lg p-4 space-y-4",children:[i.jsxs("div",{className:"flex items-center justify-between",children:[i.jsxs("div",{children:[i.jsx("p",{className:"font-medium",children:"Air-Gap Mode"}),i.jsx("p",{className:"text-sm text-slate-400",children:"Disable all network requests for maximum security"})]}),i.jsx("button",{onClick:()=>s(!t),className:`relative w-12 h-6 rounded-full transition-colors ${t?"bg-red-500":"bg-slate-600"}`,children:i.jsx("span",{className:`absolute top-1 w-4 h-4 rounded-full bg-white transition-transform ${t?"left-7":"left-1"}`})})]}),i.jsxs("div",{className:"text-sm bg-slate-600/50 rounded-lg p-3",children:[i.jsx("p",{className:"font-medium mb-2",children:"Manual Air-Gap Instructions:"}),i.jsxs("ol",{className:"list-decimal list-inside space-y-1 text-slate-300",children:[i.jsx("li",{children:"Disconnect from network (disable WiFi/Ethernet)"}),i.jsxs("li",{children:["Run Ollama locally: ",i.jsx("code",{className:"bg-slate-700 px-1 rounded",children:"ollama serve"})]}),i.jsxs("li",{children:["Ensure model is downloaded: ",i.jsx("code",{className:"bg-slate-700 px-1 rounded",children:"ollama pull llama3.2"})]}),i.jsx("li",{children:"All AI processing will happen on-device"}),i.jsx("li",{children:"No PHI ever leaves your machine"})]})]})]})]}),i.jsxs("div",{className:"space-y-4",children:[i.jsxs("h3",{className:"text-lg font-medium flex items-center gap-2",children:[i.jsx(sg,{className:"w-5 h-5 text-cyan-400"}),"Data Storage"]}),i.jsxs("div",{className:"bg-slate-700/50 rounded-lg p-4 space-y-4",children:[i.jsxs("div",{children:[i.jsx("p",{className:"text-sm text-slate-400 mb-1",children:"Encrypted Vault Location"}),i.jsx("code",{className:"block bg-slate-600 px-3 py-2 rounded text-sm break-all",children:j})]}),i.jsxs("div",{className:"text-sm text-slate-400",children:[i.jsx("p",{children:"• All data encrypted with AES-256 via SQLCipher"}),i.jsx("p",{children:"• Encryption key stored in macOS Keychain"}),i.jsx("p",{children:"• No cloud sync - 100% local storage"})]})]})]}),i.jsxs("div",{className:"space-y-4",children:[i.jsxs("h3",{className:"text-lg font-medium flex items-center gap-2",children:[i.jsx(Lo,{className:"w-5 h-5 text-purple-400"}),"Consultation Queue"]}),i.jsxs("div",{className:"bg-slate-700/50 rounded-lg p-4",children:[i.jsx("p",{className:"text-sm text-slate-300 mb-3",children:"The consultation queue allows you to create de-identified case consultations that can be safely shared with colleagues for peer review."}),i.jsxs("ol",{className:"list-decimal list-inside space-y-2 text-sm text-slate-400",children:[i.jsx("li",{children:'Open a note and click "Create Consultation Draft"'}),i.jsx("li",{children:"Review the de-identified content (all PHI removed)"}),i.jsx("li",{children:"Add your clinical question and select specialties"}),i.jsx("li",{children:"Export the de-identified case with audit certificate"}),i.jsx("li",{children:"Share via secure channel (the export includes no PHI)"})]})]})]})]}),i.jsx("div",{className:"p-4 border-t border-slate-700 flex justify-end",children:i.jsx("button",{onClick:c,className:"bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded-lg font-medium transition-colors",children:"Done"})})]})})}function qb({clients:c,ollamaStatus:e,onSelectClient:t,onStartCapture:s,onRefresh:n,onNoteSelect:a,onForensicMode:o,onEduMode:l}){const[d,h]=T.useState(!1),[u,p]=T.useState(""),[m,f]=T.useState(!1),[g,b]=T.useState(""),[A,N]=T.useState(!1),[j,E]=T.useState(()=>!localStorage.getItem("evidify_seen_showcase_v427"));function _(){localStorage.setItem("evidify_seen_showcase_v427","true"),E(!1)}async function y(){if(u.trim()){f(!0);try{await _g(u.trim()),p(""),h(!1),n()}catch(C){console.error(C)}f(!1)}}return i.jsx("div",{className:"min-h-screen p-6",children:i.jsxs("div",{className:"max-w-4xl mx-auto",children:[j&&i.jsx(Hb,{onClose:_}),A&&i.jsx(Wb,{onClose:()=>N(!1),ollamaStatus:e}),i.jsxs("div",{className:"flex items-center justify-between mb-8",children:[i.jsxs("div",{className:"flex items-center gap-3",children:[i.jsx(si,{className:"w-8 h-8 text-blue-500"}),i.jsx("h1",{className:"text-2xl font-bold",children:"Evidify"}),i.jsx("span",{className:"bg-amber-500/20 text-amber-400 text-xs px-2 py-1 rounded-full font-medium",children:"BETA"})]}),i.jsxs("div",{className:"flex items-center gap-4",children:[i.jsxs("button",{onClick:()=>E(!0),className:"flex items-center gap-2 px-3 py-1.5 bg-gradient-to-r from-blue-600/20 to-purple-600/20 hover:from-blue-600/30 hover:to-purple-600/30 border border-blue-500/30 rounded-lg text-sm font-medium text-blue-300 transition-all",title:"See all features",children:[i.jsx(Ac,{className:"w-4 h-4"}),"What's New"]}),o&&i.jsxs("button",{onClick:o,className:"flex items-center gap-2 px-3 py-1.5 bg-gradient-to-r from-amber-600/20 to-orange-600/20 hover:from-amber-600/30 hover:to-orange-600/30 border border-amber-500/30 rounded-lg text-sm font-medium text-amber-300 transition-all",title:"Forensic Evaluations",children:[i.jsx(bp,{className:"w-4 h-4"}),"Forensic"]}),l&&i.jsxs("button",{onClick:l,className:"flex items-center gap-2 px-3 py-1.5 bg-gradient-to-r from-emerald-600/20 to-teal-600/20 hover:from-emerald-600/30 hover:to-teal-600/30 border border-emerald-500/30 rounded-lg text-sm font-medium text-emerald-300 transition-all",title:"Educational Assessments (504/IEP)",children:[i.jsx(Rd,{className:"w-4 h-4"}),"EDU"]}),i.jsxs("div",{className:`flex items-center gap-2 px-3 py-1 rounded-full text-sm ${e!=null&&e.available?"bg-green-500/20 text-green-400":"bg-yellow-500/20 text-yellow-400"}`,children:[i.jsx(wn,{className:"w-4 h-4"}),e!=null&&e.available?`AI: ${e.models[0]||"Ready"}`:"AI: Limited"]}),i.jsx("button",{onClick:()=>N(!0),className:"flex items-center gap-2 text-slate-400 hover:text-white transition-colors",title:"Settings",children:i.jsx(wp,{className:"w-4 h-4"})}),i.jsxs("button",{onClick:()=>yg().then(n),className:"flex items-center gap-2 text-slate-400 hover:text-white transition-colors",children:[i.jsx(pu,{className:"w-4 h-4"}),"Lock"]})]})]}),i.jsxs("div",{className:"bg-gradient-to-br from-blue-600 to-blue-800 rounded-xl p-6 mb-8",children:[i.jsx("h2",{className:"text-xl font-semibold mb-2",children:"Quick Capture"}),i.jsx("p",{className:"text-blue-200 mb-4",children:"Start documenting a session"}),i.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[i.jsxs("select",{value:g,onChange:C=>b(C.target.value),className:"bg-white/20 text-white border border-white/30 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-white/50 flex-1",children:[i.jsx("option",{value:"",className:"text-slate-800",children:"Select client..."}),c.map(C=>i.jsx("option",{value:C.id,className:"text-slate-800",children:C.display_name},C.id))]}),i.jsxs("button",{onClick:()=>{const C=c.find(R=>R.id===g);s(C||null)},className:"bg-white text-blue-600 px-6 py-3 rounded-lg font-medium hover:bg-blue-50 transition-colors flex items-center justify-center gap-2",children:[i.jsx(Dt,{className:"w-5 h-5"}),"New Note"]})]})]}),i.jsxs("div",{className:"bg-slate-800 rounded-xl p-6",children:[i.jsxs("div",{className:"flex items-center justify-between mb-4",children:[i.jsxs("h2",{className:"text-lg font-semibold flex items-center gap-2",children:[i.jsx(Do,{className:"w-5 h-5"}),"Clients"]}),i.jsxs("button",{onClick:()=>h(!0),className:"text-blue-400 hover:text-blue-300 flex items-center gap-1 text-sm",children:[i.jsx(Da,{className:"w-4 h-4"}),"Add Client"]})]}),d&&i.jsxs("div",{className:"bg-slate-700 rounded-lg p-4 mb-4 flex gap-2",children:[i.jsx("input",{type:"text",value:u,onChange:C=>p(C.target.value),onKeyDown:C=>C.key==="Enter"&&y(),placeholder:"Client name or pseudonym",className:"flex-1 bg-slate-600 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",autoFocus:!0}),i.jsx("button",{onClick:y,disabled:m||!u.trim(),className:"bg-blue-600 hover:bg-blue-700 disabled:opacity-50 px-4 py-2 rounded font-medium",children:m?"...":"Add"}),i.jsx("button",{onClick:()=>{h(!1),p("")},className:"text-slate-400 hover:text-white px-2",children:"Close"})]}),c.length===0?i.jsx("p",{className:"text-slate-400 text-center py-8",children:"No clients yet. Add a client to get started."}):i.jsx("div",{className:"space-y-2",children:c.map(C=>i.jsxs("div",{className:"flex items-center justify-between p-3 bg-slate-700/50 rounded-lg hover:bg-slate-700 transition-colors cursor-pointer",onClick:()=>t(C),children:[i.jsxs("div",{children:[i.jsx("div",{className:"font-medium",children:C.display_name}),i.jsxs("div",{className:"text-sm text-slate-400",children:[C.session_count," sessions"]})]}),i.jsx(Ct,{className:"w-5 h-5 text-slate-400"})]},C.id))})]}),i.jsx("div",{className:"mt-8",children:i.jsx($f,{model:(e==null?void 0:e.models[0])||"qwen2.5:7b-instruct",onNoteSelect:a})}),i.jsx("div",{className:"mt-8",children:i.jsx(lv,{onClientSelect:C=>t(C)})}),i.jsx("div",{className:"mt-8",children:i.jsx(uv,{})}),i.jsx("div",{className:"mt-8",children:i.jsx(dv,{})}),i.jsx("div",{className:"mt-8",children:i.jsx(hv,{})}),i.jsx("div",{className:"mt-8",children:i.jsx(gv,{supervisorId:"default-supervisor"})}),i.jsx("div",{className:"mt-8",children:i.jsx(Hf,{noteId:"",noteContent:""})})]})})}function Xb({client:c,notes:e,ollamaStatus:t,onBack:s,onNewNote:n,onViewNote:a,onReviewNote:o,onRefresh:l,onClientUpdate:d,onNoteSelect:h}){const[u,p]=T.useState(null),[m,f]=T.useState(!1),[g,b]=T.useState(!1),[A,N]=T.useState(!1),[j,E]=T.useState(""),[_,y]=T.useState("all"),[C,R]=T.useState("all"),S=e.filter(P=>{var I,K;if(j){const ie=j.toLowerCase(),ue=(I=P.content)==null?void 0:I.toLowerCase().includes(ie),te=(K=P.session_date)==null?void 0:K.toLowerCase().includes(ie);if(!ue&&!te)return!1}return!(_!=="all"&&P.note_type!==_||C!=="all"&&P.status!==C)}),[k,M]=T.useState({display_name:c.display_name,date_of_birth:c.date_of_birth||"",phone:c.phone||"",email:c.email||"",emergency_contact:c.emergency_contact||"",insurance_info:c.insurance_info||"",diagnosis_codes:c.diagnosis_codes||"",treatment_start_date:c.treatment_start_date||"",referring_provider:c.referring_provider||"",notes:c.notes||""}),[L,O]=T.useState(!1);async function $(){f(!0),await l(),f(!1)}async function q(){O(!0);try{const P={...c,display_name:k.display_name,date_of_birth:k.date_of_birth||void 0,phone:k.phone||void 0,email:k.email||void 0,emergency_contact:k.emergency_contact||void 0,insurance_info:k.insurance_info||void 0,diagnosis_codes:k.diagnosis_codes||void 0,treatment_start_date:k.treatment_start_date||void 0,referring_provider:k.referring_provider||void 0,notes:k.notes||void 0},I=await Eg(P);d==null||d(I),N(!1)}catch(P){console.error("Failed to save profile:",P)}finally{O(!1)}}function F(){M({display_name:c.display_name,date_of_birth:c.date_of_birth||"",phone:c.phone||"",email:c.email||"",emergency_contact:c.emergency_contact||"",insurance_info:c.insurance_info||"",diagnosis_codes:c.diagnosis_codes||"",treatment_start_date:c.treatment_start_date||"",referring_provider:c.referring_provider||"",notes:c.notes||""}),N(!1)}return i.jsx("div",{className:"min-h-screen p-6",children:i.jsxs("div",{className:"max-w-4xl mx-auto",children:[i.jsxs("div",{className:"flex items-center justify-between mb-8",children:[i.jsxs("div",{className:"flex items-center gap-3",children:[i.jsx("button",{onClick:s,className:"text-slate-400 hover:text-white transition-colors",children:"← Back"}),i.jsx(si,{className:"w-8 h-8 text-blue-500"}),i.jsx("h1",{className:"text-2xl font-bold",children:c.display_name}),i.jsx("span",{className:"bg-amber-500/20 text-amber-400 text-xs px-2 py-1 rounded-full font-medium",children:"BETA"})]}),i.jsxs("div",{className:"flex items-center gap-4",children:[i.jsx("button",{onClick:$,disabled:m,className:"text-slate-400 hover:text-white transition-colors",title:"Refresh notes",children:m?i.jsx(Ne,{className:"w-4 h-4 animate-spin"}):"↻"}),i.jsxs("div",{className:`flex items-center gap-2 px-3 py-1 rounded-full text-sm ${t!=null&&t.available?"bg-green-500/20 text-green-400":"bg-yellow-500/20 text-yellow-400"}`,children:[i.jsx(wn,{className:"w-4 h-4"}),t!=null&&t.available?`AI: ${t.models[0]||"Ready"}`:"AI: Limited"]})]})]}),i.jsxs("div",{className:"bg-slate-800 rounded-xl p-6 mb-8",children:[i.jsxs("div",{className:"flex items-center justify-between mb-4",children:[i.jsxs("h2",{className:"text-lg font-semibold flex items-center gap-2",children:[i.jsx(hc,{className:"w-5 h-5"}),"Client Profile"]}),i.jsx("div",{className:"flex gap-2",children:A?i.jsxs(i.Fragment,{children:[i.jsxs("button",{onClick:F,className:"flex items-center gap-1 text-sm bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded",children:[i.jsx(Io,{className:"w-4 h-4"}),"Cancel"]}),i.jsxs("button",{onClick:q,disabled:L,className:"flex items-center gap-1 text-sm bg-blue-600 hover:bg-blue-700 disabled:opacity-50 px-3 py-1 rounded",children:[L?i.jsx(Ne,{className:"w-4 h-4 animate-spin"}):i.jsx(cg,{className:"w-4 h-4"}),"Save"]})]}):i.jsxs(i.Fragment,{children:[i.jsx("button",{onClick:()=>b(!g),className:"text-sm text-slate-400 hover:text-white",children:g?"Hide":"Show Details"}),i.jsxs("button",{onClick:()=>{b(!0),N(!0)},className:"flex items-center gap-1 text-sm bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded",children:[i.jsx(yp,{className:"w-4 h-4"}),"Edit"]})]})})]}),i.jsxs("div",{className:"flex flex-wrap gap-4 text-sm",children:[c.phone&&i.jsxs("div",{className:"flex items-center gap-1 text-slate-400",children:[i.jsx(og,{className:"w-4 h-4"}),c.phone]}),c.email&&i.jsxs("div",{className:"flex items-center gap-1 text-slate-400",children:[i.jsx(ag,{className:"w-4 h-4"}),c.email]}),c.date_of_birth&&i.jsxs("div",{className:"flex items-center gap-1 text-slate-400",children:[i.jsx(Ap,{className:"w-4 h-4"}),"DOB: ",c.date_of_birth]}),c.treatment_start_date&&i.jsxs("div",{className:"text-slate-400",children:["Treatment started: ",c.treatment_start_date]})]}),g&&i.jsx("div",{className:"mt-4 pt-4 border-t border-slate-700 grid grid-cols-1 md:grid-cols-2 gap-4",children:A?i.jsxs(i.Fragment,{children:[i.jsxs("div",{children:[i.jsx("label",{className:"block text-xs text-slate-400 mb-1",children:"Display Name"}),i.jsx("input",{type:"text",value:k.display_name,onChange:P=>M(I=>({...I,display_name:P.target.value})),className:"w-full bg-slate-700 rounded px-3 py-2 text-sm"})]}),i.jsxs("div",{children:[i.jsx("label",{className:"block text-xs text-slate-400 mb-1",children:"Date of Birth"}),i.jsx("input",{type:"date",value:k.date_of_birth,onChange:P=>M(I=>({...I,date_of_birth:P.target.value})),className:"w-full bg-slate-700 rounded px-3 py-2 text-sm"})]}),i.jsxs("div",{children:[i.jsx("label",{className:"block text-xs text-slate-400 mb-1",children:"Phone"}),i.jsx("input",{type:"tel",value:k.phone,onChange:P=>M(I=>({...I,phone:P.target.value})),placeholder:"(555) 123-4567",className:"w-full bg-slate-700 rounded px-3 py-2 text-sm"})]}),i.jsxs("div",{children:[i.jsx("label",{className:"block text-xs text-slate-400 mb-1",children:"Email"}),i.jsx("input",{type:"email",value:k.email,onChange:P=>M(I=>({...I,email:P.target.value})),placeholder:"client@email.com",className:"w-full bg-slate-700 rounded px-3 py-2 text-sm"})]}),i.jsxs("div",{children:[i.jsx("label",{className:"block text-xs text-slate-400 mb-1",children:"Emergency Contact"}),i.jsx("input",{type:"text",value:k.emergency_contact,onChange:P=>M(I=>({...I,emergency_contact:P.target.value})),placeholder:"Name: (555) 123-4567",className:"w-full bg-slate-700 rounded px-3 py-2 text-sm"})]}),i.jsxs("div",{children:[i.jsx("label",{className:"block text-xs text-slate-400 mb-1",children:"Insurance Info"}),i.jsx("input",{type:"text",value:k.insurance_info,onChange:P=>M(I=>({...I,insurance_info:P.target.value})),placeholder:"Carrier / Member ID",className:"w-full bg-slate-700 rounded px-3 py-2 text-sm"})]}),i.jsxs("div",{children:[i.jsx("label",{className:"block text-xs text-slate-400 mb-1",children:"Diagnosis Codes (ICD-10)"}),i.jsx("input",{type:"text",value:k.diagnosis_codes,onChange:P=>M(I=>({...I,diagnosis_codes:P.target.value})),placeholder:"F32.1, F41.1",className:"w-full bg-slate-700 rounded px-3 py-2 text-sm"})]}),i.jsxs("div",{children:[i.jsx("label",{className:"block text-xs text-slate-400 mb-1",children:"Treatment Start Date"}),i.jsx("input",{type:"date",value:k.treatment_start_date,onChange:P=>M(I=>({...I,treatment_start_date:P.target.value})),className:"w-full bg-slate-700 rounded px-3 py-2 text-sm"})]}),i.jsxs("div",{children:[i.jsx("label",{className:"block text-xs text-slate-400 mb-1",children:"Referring Provider"}),i.jsx("input",{type:"text",value:k.referring_provider,onChange:P=>M(I=>({...I,referring_provider:P.target.value})),placeholder:"Dr. Smith",className:"w-full bg-slate-700 rounded px-3 py-2 text-sm"})]}),i.jsxs("div",{className:"md:col-span-2",children:[i.jsx("label",{className:"block text-xs text-slate-400 mb-1",children:"Notes"}),i.jsx("textarea",{value:k.notes,onChange:P=>M(I=>({...I,notes:P.target.value})),placeholder:"Additional notes about the client...",className:"w-full bg-slate-700 rounded px-3 py-2 text-sm min-h-[80px]"})]})]}):i.jsxs(i.Fragment,{children:[i.jsx(Nc,{label:"Emergency Contact",value:c.emergency_contact}),i.jsx(Nc,{label:"Insurance",value:c.insurance_info}),i.jsx(Nc,{label:"Diagnosis Codes",value:c.diagnosis_codes}),i.jsx(Nc,{label:"Referring Provider",value:c.referring_provider}),c.notes&&i.jsxs("div",{className:"md:col-span-2",children:[i.jsx("div",{className:"text-xs text-slate-400 mb-1",children:"Notes"}),i.jsx("div",{className:"text-sm text-slate-300",children:c.notes})]})]})})]}),i.jsxs("div",{className:"grid grid-cols-3 gap-4 mb-8",children:[i.jsxs("div",{className:"bg-slate-800 rounded-xl p-4 text-center",children:[i.jsx("div",{className:"text-3xl font-bold text-blue-400",children:e.length}),i.jsx("div",{className:"text-sm text-slate-400",children:"Total Notes"})]}),i.jsxs("div",{className:"bg-slate-800 rounded-xl p-4 text-center",children:[i.jsx("div",{className:"text-3xl font-bold text-green-400",children:e.filter(P=>P.status==="signed").length}),i.jsx("div",{className:"text-sm text-slate-400",children:"Signed"})]}),i.jsxs("div",{className:"bg-slate-800 rounded-xl p-4 text-center",children:[i.jsx("div",{className:"text-3xl font-bold text-amber-400",children:e.filter(P=>P.status==="draft").length}),i.jsx("div",{className:"text-sm text-slate-400",children:"Drafts"})]})]}),i.jsx("div",{className:"mb-6",children:i.jsxs("button",{onClick:n,className:"bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg font-medium flex items-center gap-2",children:[i.jsx(Da,{className:"w-5 h-5"}),"New Session Note"]})}),i.jsxs("div",{className:"bg-slate-800 rounded-xl p-6",children:[i.jsx("div",{className:"flex items-center justify-between mb-4",children:i.jsxs("h2",{className:"text-lg font-semibold flex items-center gap-2",children:[i.jsx(Dt,{className:"w-5 h-5"}),"Session Notes",i.jsxs("span",{className:"text-sm font-normal text-slate-400",children:["(",S.length,S.length!==e.length?` of ${e.length}`:"",")"]})]})}),e.length>0&&i.jsxs("div",{className:"flex flex-wrap gap-3 mb-4",children:[i.jsx("div",{className:"flex-1 min-w-[200px]",children:i.jsxs("div",{className:"relative",children:[i.jsx(ti,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"}),i.jsx("input",{type:"text",value:j,onChange:P=>E(P.target.value),placeholder:"Search notes...",className:"w-full bg-slate-700 rounded-lg pl-10 pr-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"})]})}),i.jsxs("select",{value:_,onChange:P=>y(P.target.value),className:"bg-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",children:[i.jsx("option",{value:"all",children:"All Types"}),i.jsx("option",{value:"progress",children:"Progress"}),i.jsx("option",{value:"intake",children:"Intake"}),i.jsx("option",{value:"crisis",children:"Crisis"}),i.jsx("option",{value:"phone",children:"Phone"}),i.jsx("option",{value:"group",children:"Group"}),i.jsx("option",{value:"termination",children:"Termination"})]}),i.jsxs("select",{value:C,onChange:P=>R(P.target.value),className:"bg-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",children:[i.jsx("option",{value:"all",children:"All Status"}),i.jsx("option",{value:"draft",children:"Draft"}),i.jsx("option",{value:"reviewed",children:"Reviewed"}),i.jsx("option",{value:"signed",children:"Signed"})]}),(j||_!=="all"||C!=="all")&&i.jsxs("button",{onClick:()=>{E(""),y("all"),R("all")},className:"text-slate-400 hover:text-white text-sm flex items-center gap-1",children:[i.jsx(Io,{className:"w-4 h-4"}),"Clear"]})]}),S.length===0?i.jsx("p",{className:"text-slate-400 text-center py-8",children:e.length===0?"No notes yet for this client. Create your first session note.":"No notes match your search criteria."}):i.jsx("div",{className:"space-y-3",children:S.map(P=>{var I;return i.jsxs("div",{className:"bg-slate-700/50 rounded-lg overflow-hidden",children:[i.jsxs("div",{className:"flex items-center justify-between p-4 cursor-pointer hover:bg-slate-700 transition-colors",onClick:()=>p(u===P.id?null:P.id),children:[i.jsxs("div",{className:"flex items-center gap-3",children:[i.jsx("div",{className:`w-2 h-2 rounded-full ${P.status==="signed"?"bg-green-400":"bg-amber-400"}`}),i.jsxs("div",{children:[i.jsxs("div",{className:"font-medium",children:[P.session_date||new Date(P.created_at).toLocaleDateString()," • ",new Date(P.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})]}),i.jsxs("div",{className:"text-sm text-slate-400",children:[P.note_type," • ",P.word_count," words • ",P.status]})]})]}),i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsxs("span",{className:"text-xs text-slate-500 font-mono",children:[(I=P.content_hash)==null?void 0:I.substring(0,8),"..."]}),i.jsx(Ct,{className:`w-5 h-5 text-slate-400 transition-transform ${u===P.id?"rotate-90":""}`})]})]}),u===P.id&&i.jsxs("div",{className:"border-t border-slate-600 p-4",children:[i.jsx("div",{className:"bg-slate-800 rounded-lg p-4 mb-4 max-h-64 overflow-y-auto",children:i.jsx("pre",{className:"whitespace-pre-wrap text-sm text-slate-300 font-sans",children:P.content||"Content encrypted"})}),i.jsxs("div",{className:"flex gap-2",children:[i.jsx("button",{onClick:()=>a(P),className:"bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-sm",children:"View Full Note"}),(P.status==="draft"||P.status==="reviewed")&&i.jsx("button",{onClick:()=>o(P),className:"bg-amber-600 hover:bg-amber-700 px-4 py-2 rounded text-sm",children:"Review & Attest"}),i.jsxs("button",{onClick:()=>navigator.clipboard.writeText(P.content||""),className:"bg-slate-600 hover:bg-slate-500 px-4 py-2 rounded text-sm flex items-center gap-1",title:"Copy raw content",children:[i.jsx(fu,{className:"w-4 h-4"}),"Copy"]}),i.jsxs("button",{onClick:()=>{const K=localStorage.getItem("evidify_clinician_name")||"",ie=localStorage.getItem("evidify_clinician_credentials")||"",ue=localStorage.getItem("evidify_clinician_license")||"",te=localStorage.getItem("evidify_practice_name")||"",V=localStorage.getItem("evidify_note_footer")||"",le=[te?`${te}`:"","─".repeat(50),`CLIENT: ${c.display_name}`,`DATE: ${P.session_date||new Date(P.created_at).toLocaleDateString()}`,`TYPE: ${P.note_type.toUpperCase()}`,`STATUS: ${P.status.toUpperCase()}`,"─".repeat(50),"",P.content||"","","─".repeat(50),K?`${K}${ie?`, ${ie}`:""}`:"",ue?`License: ${ue}`:"",V?`
${V}`:"",`
Generated: ${new Date().toLocaleString()}`].filter(ye=>ye!=="").join(`
`);navigator.clipboard.writeText(le)},className:"bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded text-sm flex items-center gap-1",title:"Copy with formatting for EHR",children:[i.jsx(Dt,{className:"w-4 h-4"}),"Export"]})]})]})]},P.id)})})]}),i.jsx("div",{className:"mt-8",children:i.jsx(pv,{clientId:c.id})}),i.jsx("div",{className:"mt-8",children:i.jsx(ov,{clientId:c.id,model:(t==null?void 0:t.models[0])||"qwen2.5:7b-instruct",onNoteSelect:h})}),i.jsx("div",{className:"mt-8",children:i.jsx(cv,{clientId:c.id})}),i.jsx("div",{className:"mt-8",children:i.jsx($f,{clientId:c.id,model:(t==null?void 0:t.models[0])||"qwen2.5:7b-instruct",onNoteSelect:h})})]})})}function Yb({client:c,onComplete:e,onCancel:t,onHome:s,ollamaStatus:n}){const[a,o]=T.useState(""),[l,d]=T.useState(!1),[h,u]=T.useState(!1),[p,m]=T.useState(null),[f,g]=T.useState(!1),[b,A]=T.useState("progress"),[N]=T.useState(()=>new Date().toISOString()),[j,E]=T.useState(0),[_,y]=T.useState(!1);T.useEffect(()=>{const V=setInterval(()=>{const le=new Date(N).getTime(),ye=Date.now();E(Math.floor((ye-le)/1e3))},1e3);return()=>clearInterval(V)},[N]);const[C,R]=T.useState(!1),[S,k]=T.useState(!1),[M,L]=T.useState({appearance:"Not assessed",behavior:"Not assessed",speech:"Not assessed",mood:"Not assessed",affect:"Not assessed",thoughtProcess:"Not assessed",thoughtContent:"Not assessed",cognition:"Not assessed",insightJudgment:"Not assessed"}),[O,$]=T.useState({suicidalIdeation:"not_assessed",suicidalIdeationDetails:"",homicidalIdeation:"not_assessed",homicidalIdeationDetails:"",selfHarm:"not_assessed",selfHarmDetails:"",safetyPlan:"not_assessed",protectiveFactors:[],riskLevel:"not_assessed"}),q=(n==null?void 0:n.models[0])||"qwen2.5:7b-instruct",F=(n==null?void 0:n.available)&&n.models.length>0;async function P(){if(!(!a.trim()||!F)){g(!0);try{const V=await Lg(q,a,b);m(V)}catch(V){console.error("AI structuring error:",V)}finally{g(!1)}}}function I(){let V=a;return Object.values(M).some(z=>z&&z!=="Not assessed")&&(V+=`

`+av(M)),(O.suicidalIdeation!=="not_assessed"||O.homicidalIdeation!=="not_assessed"||O.selfHarm!=="not_assessed")&&(V+=`

`+rv(O)),V}async function K(){if(a.trim()){d(!0);try{const V=I(),le=await Tp(V);let ye=await kg((c==null?void 0:c.id)||"demo",new Date().toISOString().split("T")[0],b,V);p&&(ye=await Tg(ye.id,p));try{const z=new Date().toISOString(),Se=V.split(/\s+/).filter(Boolean).length;await Ip(ye.id,(c==null?void 0:c.id)||"demo",N,z,_?"voice":"typed",Se,p!==null||f)}catch(z){console.warn("Failed to record time metrics:",z)}e(ye,le)}catch(V){console.error(V),d(!1)}}}function ie(V){o(le=>le?le+`

`+V:V),m(null),u(!1),y(!0)}function ue(){p&&(o(p),m(null))}function te(V){const le=Math.floor(V/60),ye=V%60;return`${le}:${ye.toString().padStart(2,"0")}`}return i.jsxs("div",{className:"min-h-screen",children:[i.jsx(Su,{onHome:s,title:c?`New Note: ${c.display_name}`:"New Note"}),i.jsx("div",{className:"pt-14 p-6",children:i.jsxs("div",{className:"max-w-3xl mx-auto",children:[i.jsxs("div",{className:"flex items-center justify-between mb-6",children:[i.jsxs("div",{children:[i.jsx("h1",{className:"text-2xl font-bold",children:"New Note"}),i.jsx("p",{className:"text-slate-400",children:c?c.display_name:"Quick capture"})]}),i.jsxs("div",{className:"flex items-center gap-4",children:[i.jsxs("div",{className:"flex items-center gap-2 px-3 py-1 rounded-full text-xs bg-slate-700 text-slate-300",children:[i.jsx(Ja,{className:"w-3 h-3"}),i.jsx("span",{className:"font-mono",children:te(j)}),_&&i.jsx(lo,{className:"w-3 h-3 text-blue-400"})]}),i.jsxs("div",{className:`flex items-center gap-2 px-3 py-1 rounded-full text-xs ${F?"bg-green-500/20 text-green-400":"bg-yellow-500/20 text-yellow-400"}`,children:[i.jsx(wn,{className:"w-3 h-3"}),F?`AI: ${q.split(":")[0]}`:"AI: Offline"]}),i.jsx("button",{onClick:t,className:"text-slate-400 hover:text-white",children:"Cancel"})]})]}),i.jsx("div",{className:"flex gap-2 mb-4",children:["progress","intake","crisis","phone","group","termination"].map(V=>i.jsx("button",{onClick:()=>A(V),className:`px-3 py-1 rounded-lg text-sm capitalize transition-colors ${b===V?"bg-blue-600 text-white":"bg-slate-700 text-slate-300 hover:bg-slate-600"}`,children:V},V))}),h&&i.jsx("div",{className:"mb-4",children:i.jsx(ev,{onTranscript:ie,model:q})}),i.jsx("div",{className:"bg-slate-800 rounded-xl p-4 mb-4",children:i.jsx("textarea",{value:a,onChange:V=>{o(V.target.value),m(null)},placeholder:`Enter your session notes here. Use natural language - the system will structure it for you.

Example: pt seems more anxious today, talked about work stress. not sleeping well. mentioned having some dark thoughts last week but says she's fine now. did cbt work on catastrophizing, assigned breathing exercises. f/u 2 weeks.`,className:"w-full bg-transparent resize-none focus:outline-none min-h-[300px] text-lg",autoFocus:!0})}),i.jsx("div",{className:"mb-4",children:i.jsx(sv,{value:M,onChange:L,expanded:C,onToggleExpand:()=>R(!C)})}),i.jsx("div",{className:"mb-4",children:i.jsx(nv,{value:O,onChange:$,expanded:S,onToggleExpand:()=>k(!S)})}),p&&i.jsxs("div",{className:"bg-slate-800 rounded-xl p-4 mb-4 border border-blue-500/30",children:[i.jsxs("div",{className:"flex items-center justify-between mb-3",children:[i.jsxs("div",{className:"flex items-center gap-2 text-blue-400",children:[i.jsx(wn,{className:"w-4 h-4"}),i.jsxs("span",{className:"text-sm font-medium",children:["AI Structured (",b.toUpperCase(),")"]})]}),i.jsxs("div",{className:"flex gap-2",children:[i.jsx("button",{onClick:ue,className:"text-xs bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded",children:"Use This"}),i.jsx("button",{onClick:()=>m(null),className:"text-xs bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded",children:"Dismiss"})]})]}),i.jsx("div",{className:"text-sm text-slate-300 whitespace-pre-wrap max-h-48 overflow-y-auto",children:p})]}),i.jsxs("div",{className:"flex items-center justify-between",children:[i.jsxs("div",{className:"text-sm text-slate-400",children:[a.split(/\s+/).filter(Boolean).length," words"]}),i.jsxs("div",{className:"flex gap-3",children:[i.jsxs("button",{onClick:()=>u(!h),className:`flex items-center gap-2 px-4 py-2 rounded-lg transition-colors ${h?"bg-blue-600 hover:bg-blue-700":"bg-slate-700 hover:bg-slate-600"}`,children:[i.jsx(lo,{className:"w-5 h-5"}),h?"Hide Voice":"Voice Scribe"]}),F&&i.jsxs("button",{onClick:P,disabled:f||!a.trim(),className:"flex items-center gap-2 px-4 py-2 bg-purple-600 hover:bg-purple-700 disabled:opacity-50 rounded-lg transition-colors",children:[i.jsx(wn,{className:"w-5 h-5"}),f?"Structuring...":"AI Structure"]}),i.jsxs("button",{onClick:K,disabled:l||!a.trim(),className:"flex items-center gap-2 px-6 py-2 bg-blue-600 hover:bg-blue-700 disabled:opacity-50 rounded-lg font-medium transition-colors",children:[l?"Analyzing...":"Generate",i.jsx(dg,{className:"w-4 h-4"})]})]})]})]})})]})}function Kb({note:c,analysis:e,ollamaStatus:t,onComplete:s,onBack:n,onHome:a,noteStartTime:o}){var O,$,q;const[l,d]=T.useState([]),[h,u]=T.useState(null),[p,m]=T.useState({}),[f,g]=T.useState(!1),[b,A]=T.useState(null),[N,j]=T.useState(!1),E=(t==null?void 0:t.models[0])||"qwen2.5:7b-instruct",_=(t==null?void 0:t.available)&&(($=(O=t.models)==null?void 0:O.length)!=null?$:0)>0,y=Zb(e.detections);T.useEffect(()=>{C()},[l]);async function C(){try{const F=await Bg(e.detections,l);A(F)}catch(F){console.error("Failed to check completion:",F)}}async function R(F,P){var K;if((P==="not_clinically_relevant"||P==="consulted_supervisor")&&!((K=p[F.id])!=null&&K.trim())){u(F.id);return}try{await Hg(F,P,p[F.id]);const ie={detection_id:F.id,detection_type:F.category,evidence:F.evidence,response:P,response_note:p[F.id]||null,attested_at:Date.now()};d(ue=>[...ue.filter(te=>te.detection_id!==F.id),ie])}catch(ie){alert(String(ie))}}async function S(F,P){const I=F.map(K=>{var ie,ue;return{detection_id:K,detection_type:((ie=e.detections.find(te=>te.id===K))==null?void 0:ie.category)||"",evidence:((ue=e.detections.find(te=>te.id===K))==null?void 0:ue.evidence)||"",response:P,response_note:null,attested_at:Date.now()}});d(K=>[...K.filter(ie=>!F.includes(ie.detection_id)),...I])}function k(F){d(P=>P.filter(I=>I.detection_id!==F))}async function M(){if(b!=null&&b.can_sign){g(!0);try{if(await Rg(c.id,JSON.stringify(l)),o){const F=new Date().toISOString(),I=(c.raw_input||"").split(/\s+/).filter(Boolean).length;try{const K=!!c.structured_note||!!c.structuredNote,ie=K?"typed":"manual";await Ip(c.id,c.client_id,o,F,ie,I,K),console.log("Time metrics recorded:",{noteId:c.id,startTime:o,endTime:F,method:ie,wordCount:I})}catch(K){console.warn("Failed to record time metrics (non-fatal):",K)}}s()}catch(F){console.error("Failed to sign:",F),alert("Failed to sign note: "+String(F))}finally{g(!1)}}}const L=new Set(l.map(F=>F.detection_id));return i.jsxs("div",{className:"min-h-screen",children:[i.jsx(Su,{onHome:a,title:"Review & Sign",showBack:!0,onBack:n}),i.jsx("div",{className:"pt-14 p-6",children:i.jsxs("div",{className:"max-w-5xl mx-auto",children:[i.jsxs("div",{className:"flex items-center justify-between mb-6",children:[i.jsxs("div",{children:[i.jsx("h1",{className:"text-2xl font-bold",children:"Review & Attest"}),i.jsxs("p",{className:"text-slate-400",children:[(q=b==null?void 0:b.remaining_count)!=null?q:e.attest_count," items remaining"]})]}),i.jsx("button",{onClick:n,className:"text-slate-400 hover:text-white",children:"← Back to Edit"})]}),i.jsxs("div",{className:"mb-6",children:[i.jsxs("div",{className:"flex items-center justify-between text-sm text-slate-400 mb-2",children:[i.jsx("span",{children:"Attestation Progress"}),i.jsxs("span",{children:[l.length," / ",e.attest_count]})]}),i.jsx("div",{className:"h-2 bg-slate-700 rounded-full overflow-hidden",children:i.jsx("div",{className:"h-full bg-blue-500 transition-all duration-300",style:{width:`${l.length/Math.max(e.attest_count,1)*100}%`}})})]}),i.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[i.jsxs("div",{className:"lg:col-span-2 space-y-4",children:[y.map(F=>i.jsx(Qb,{group:F,attestedIds:L,responseNotes:p,expandedGroup:h,onQuickPick:R,onBatchAttest:S,onUndo:k,onNoteChange:(P,I)=>m(K=>({...K,[P]:I})),onExpand:P=>u(h===P?null:P)},F.key)),e.detections.filter(F=>!F.requires_attestation).length>0&&i.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-4",children:[i.jsxs("h3",{className:"text-sm font-medium text-slate-400 mb-3 flex items-center gap-2",children:[i.jsx(vp,{className:"w-4 h-4"}),"Coaching Suggestions (No Action Required)"]}),i.jsx("div",{className:"space-y-2",children:e.detections.filter(F=>!F.requires_attestation).map(F=>i.jsxs("div",{className:"text-sm text-slate-300",children:["• ",F.suggestion]},F.id))})]})]}),i.jsxs("div",{className:"space-y-4",children:[i.jsxs("div",{className:"bg-slate-800 rounded-lg p-4 sticky top-6",children:[i.jsxs("h2",{className:"font-semibold mb-3 flex items-center gap-2",children:[i.jsx(Dt,{className:"w-4 h-4"}),"Note Preview"]}),i.jsx("pre",{className:"whitespace-pre-wrap text-sm text-slate-300 max-h-64 overflow-y-auto",children:c.content})]}),l.length>0&&i.jsxs("div",{className:"bg-slate-800 rounded-lg p-4",children:[i.jsxs("h3",{className:"font-semibold mb-3 flex items-center gap-2",children:[i.jsx(Zt,{className:"w-4 h-4 text-green-500"}),"Attested (",l.length,")"]}),i.jsx("div",{className:"space-y-2",children:l.map(F=>i.jsxs("div",{className:"flex items-center justify-between text-sm",children:[i.jsx("span",{className:"text-slate-400",children:F.detection_type}),i.jsx("button",{onClick:()=>k(F.detection_id),className:"text-red-400 hover:text-red-300 text-xs",children:"Undo"})]},F.detection_id))})]}),i.jsx(fv,{noteId:c.id,clientName:c.client_id}),_&&i.jsxs("div",{className:"mb-4",children:[i.jsxs("button",{onClick:()=>j(!N),className:"w-full text-left bg-slate-700/50 hover:bg-slate-700 rounded-lg p-3 flex items-center justify-between",children:[i.jsxs("span",{className:"flex items-center gap-2",children:[i.jsx(Zt,{className:"w-4 h-4 text-blue-400"}),"AI Documentation Review"]}),i.jsx(Ct,{className:`w-4 h-4 transition-transform ${N?"rotate-90":""}`})]}),N&&i.jsx("div",{className:"mt-2",children:i.jsx(mv,{noteId:c.id,model:E,onSuggestionApplied:F=>{console.log("Note content updated via suggestion")}})})]}),i.jsx("button",{onClick:M,disabled:!(b!=null&&b.can_sign)||f,className:`w-full flex items-center justify-center gap-2 px-6 py-4 rounded-lg font-medium transition-all ${b!=null&&b.can_sign?"bg-green-600 hover:bg-green-700":"bg-slate-700 opacity-50 cursor-not-allowed"}`,children:f?i.jsx(Ne,{className:"w-5 h-5 animate-spin"}):b!=null&&b.can_sign?i.jsxs(i.Fragment,{children:[i.jsx(Zt,{className:"w-5 h-5"}),"Sign & Complete Note"]}):i.jsxs(i.Fragment,{children:[i.jsx(uu,{className:"w-5 h-5"}),b==null?void 0:b.remaining_count," items remaining"]})})]})]})]})})]})}function Qb({group:c,attestedIds:e,responseNotes:t,expandedGroup:s,onQuickPick:n,onBatchAttest:a,onUndo:o,onNoteChange:l,onExpand:d}){const h=c.detections.every(f=>e.has(f.id)),u=c.detections.filter(f=>!e.has(f.id)),p={attest:"border-red-500 bg-red-500/10",flag:"border-amber-500 bg-amber-500/10",coach:"border-blue-500 bg-blue-500/10"},m={attest:i.jsx(Es,{className:"w-5 h-5 text-red-500"}),flag:i.jsx(uu,{className:"w-5 h-5 text-amber-500"}),coach:i.jsx(vp,{className:"w-5 h-5 text-blue-500"})};return i.jsxs("div",{className:`rounded-lg border-l-4 p-4 ${p[c.severity]||p.coach}`,children:[i.jsxs("div",{className:"flex items-center justify-between mb-3",children:[i.jsxs("div",{className:"flex items-center gap-3",children:[m[c.severity]||m.coach,i.jsxs("div",{children:[i.jsx("div",{className:"font-medium",children:c.category}),i.jsxs("div",{className:"text-sm text-slate-400",children:[c.detections.length," item",c.detections.length>1?"s":"",h&&i.jsx("span",{className:"text-green-400 ml-2",children:"All attested"})]})]})]}),!h&&c.detections.length>1&&i.jsx("div",{className:"flex gap-2",children:i.jsx("button",{onClick:()=>a(u.map(f=>f.id),"addressed_in_note"),className:"text-xs bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded",children:"Attest All as Addressed"})})]}),i.jsx("div",{className:"space-y-3",children:c.detections.map(f=>{var A,N;const g=e.has(f.id),b=s===f.id;return i.jsxs("div",{className:`bg-slate-800/50 rounded-lg p-3 transition-all ${g?"opacity-60":""}`,children:[i.jsxs("div",{className:"flex items-start justify-between gap-3",children:[i.jsxs("div",{className:"flex-1",children:[i.jsx("div",{className:"font-medium text-sm",children:f.title}),i.jsx("div",{className:"text-xs text-slate-400 mt-1",children:f.description}),i.jsxs("div",{className:"text-xs bg-slate-700/50 px-2 py-1 rounded mt-2 italic",children:['"',f.evidence,'"']})]}),g?i.jsx("button",{onClick:()=>o(f.id),className:"text-xs text-slate-400 hover:text-red-400",children:"Undo"}):null]}),!g&&f.requires_attestation&&i.jsxs("div",{className:"mt-3",children:[i.jsxs("div",{className:"flex flex-wrap gap-2",children:[i.jsx(wc,{label:"Addressed",onClick:()=>n(f,"addressed_in_note")}),i.jsx(wc,{label:"Next Session",onClick:()=>n(f,"will_address_next_session")}),i.jsx(wc,{label:"Not Relevant",onClick:()=>d(f.id),requiresNote:!0}),i.jsx(wc,{label:"Supervisor",onClick:()=>d(f.id),requiresNote:!0})]}),b&&i.jsxs("div",{className:"mt-3 space-y-2",children:[i.jsx("textarea",{value:t[f.id]||"",onChange:j=>l(f.id,j.target.value),placeholder:"Required: explain your response...",className:"w-full bg-slate-700 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 min-h-[60px]"}),i.jsxs("div",{className:"flex gap-2",children:[i.jsx("button",{onClick:()=>n(f,"not_clinically_relevant"),disabled:!((A=t[f.id])!=null&&A.trim()),className:"text-xs bg-slate-600 hover:bg-slate-500 disabled:opacity-50 px-3 py-1 rounded",children:"Confirm Not Relevant"}),i.jsx("button",{onClick:()=>n(f,"consulted_supervisor"),disabled:!((N=t[f.id])!=null&&N.trim()),className:"text-xs bg-slate-600 hover:bg-slate-500 disabled:opacity-50 px-3 py-1 rounded",children:"Confirm Supervisor"})]})]})]})]},f.id)})})]})}function wc({label:c,onClick:e,requiresNote:t=!1}){return i.jsxs("button",{onClick:e,className:`text-xs px-3 py-1.5 rounded transition-colors ${t?"bg-slate-700 hover:bg-slate-600 text-slate-300":"bg-blue-600/20 hover:bg-blue-600/30 text-blue-300 border border-blue-500/30"}`,children:[c,t&&i.jsx("span",{className:"text-slate-500 ml-1",children:"*"})]})}function Zb(c){const e={};for(const s of c){if(!s.requires_attestation)continue;const n=`${s.category}-${s.severity}`;e[n]||(e[n]={key:n,category:s.category,severity:s.severity,detections:[]}),e[n].detections.push(s)}const t={attest:0,flag:1,coach:2};return Object.values(e).sort((s,n)=>(t[s.severity]||3)-(t[n.severity]||3))}function Jb({note:c,onNewNote:e,onDashboard:t,onBack:s}){const[n,a]=T.useState(!1),[o,l]=T.useState(!1),[d,h]=T.useState(c.content),[u,p]=T.useState(!1),[m,f]=T.useState(c),[g,b]=T.useState(!1),[A,N]=T.useState(""),[j,E]=T.useState("");async function _(){try{const k=await Pg(m.id,"text");await navigator.clipboard.writeText(k),a(!0),setTimeout(()=>a(!1),2e3)}catch(k){console.error(k)}}async function y(){if(d.trim()){p(!0);try{const k=await Mp(m.id,d);f(k),l(!1)}catch(k){console.error("Failed to save:",k),alert("Failed to save changes: "+String(k))}finally{p(!1)}}}async function C(){if(!(!A.trim()||!j.trim())){p(!0);try{const k=await Vg(m.id,A,j);f(k),b(!1),N(""),E("")}catch(k){console.error("Failed to save amendment:",k),alert("Failed to save amendment: "+String(k))}finally{p(!1)}}}function R(){h(m.content),l(!1)}function S(){N(""),E(""),b(!1)}return i.jsxs("div",{className:"min-h-screen",children:[i.jsx(Su,{onHome:t,title:"Note Saved",showBack:!!s,onBack:s}),i.jsx("div",{className:"pt-14 p-6",children:i.jsxs("div",{className:"max-w-2xl mx-auto text-center",children:[i.jsxs("div",{className:"mb-8",children:[i.jsx(Zt,{className:"w-20 h-20 text-green-500 mx-auto mb-4"}),i.jsx("h1",{className:"text-3xl font-bold",children:"Note Saved"}),i.jsx("p",{className:"text-slate-400 mt-2",children:"Your note has been encrypted and stored securely."})]}),i.jsxs("div",{className:"bg-slate-800 rounded-xl p-6 mb-8 text-left",children:[i.jsxs("div",{className:"flex items-center justify-between mb-4",children:[i.jsxs("div",{className:"text-sm text-slate-400",children:[m.word_count," words • Hash: ",m.content_hash.slice(0,12),"..."]}),m.status==="draft"&&!o&&i.jsxs("button",{onClick:()=>l(!0),className:"text-sm text-blue-400 hover:text-blue-300 flex items-center gap-1",children:[i.jsx(Dt,{className:"w-4 h-4"}),"Edit"]}),(m.status==="signed"||m.status==="amended")&&!g&&i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx("span",{className:`text-xs px-2 py-1 rounded ${m.status==="amended"?"text-amber-400 bg-amber-500/20":"text-green-400 bg-green-500/20"}`,children:m.status==="amended"?"Amended":"Signed"}),i.jsxs("button",{onClick:()=>b(!0),className:"text-sm text-amber-400 hover:text-amber-300 flex items-center gap-1",children:[i.jsx(Da,{className:"w-4 h-4"}),"Add Amendment"]})]})]}),g?i.jsxs("div",{className:"space-y-4",children:[i.jsxs("div",{children:[i.jsx("label",{className:"block text-sm text-slate-400 mb-1",children:"Amendment Reason *"}),i.jsx("input",{type:"text",value:j,onChange:k=>E(k.target.value),placeholder:"e.g., Additional clinical information, Correction of error...",className:"w-full bg-slate-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-amber-500 text-sm"})]}),i.jsxs("div",{children:[i.jsx("label",{className:"block text-sm text-slate-400 mb-1",children:"Amendment Text *"}),i.jsx("textarea",{value:A,onChange:k=>N(k.target.value),placeholder:"Enter the content to append to this note...",className:"w-full bg-slate-700 rounded-lg p-4 min-h-[150px] focus:outline-none focus:ring-2 focus:ring-amber-500 text-sm"})]}),i.jsxs("div",{className:"bg-amber-500/10 border border-amber-500/30 rounded-lg p-3 text-sm text-amber-300",children:[i.jsx("strong",{children:"Note:"})," Amendments are appended to the original note with a timestamp and reason. The original content is preserved."]}),i.jsxs("div",{className:"flex justify-end gap-2",children:[i.jsx("button",{onClick:S,disabled:u,className:"px-4 py-2 bg-slate-600 hover:bg-slate-500 rounded-lg text-sm",children:"Cancel"}),i.jsxs("button",{onClick:C,disabled:u||!A.trim()||!j.trim(),className:"px-4 py-2 bg-amber-600 hover:bg-amber-700 disabled:opacity-50 rounded-lg text-sm flex items-center gap-2",children:[u&&i.jsx(Ne,{className:"w-4 h-4 animate-spin"}),"Save Amendment"]})]})]}):o?i.jsxs("div",{className:"space-y-4",children:[i.jsx("textarea",{value:d,onChange:k=>h(k.target.value),className:"w-full bg-slate-700 rounded-lg p-4 min-h-[200px] focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"}),i.jsxs("div",{className:"flex justify-end gap-2",children:[i.jsx("button",{onClick:R,disabled:u,className:"px-4 py-2 bg-slate-600 hover:bg-slate-500 rounded-lg text-sm",children:"Cancel"}),i.jsxs("button",{onClick:y,disabled:u||!d.trim(),className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:opacity-50 rounded-lg text-sm flex items-center gap-2",children:[u&&i.jsx(Ne,{className:"w-4 h-4 animate-spin"}),"Save Changes"]})]})]}):i.jsx("pre",{className:"whitespace-pre-wrap text-sm text-slate-300 max-h-64 overflow-y-auto",children:m.content})]}),i.jsx("div",{className:"mb-8 text-left",children:i.jsx(xv,{noteId:m.id,noteContent:m.content,clientName:m.client_id})}),i.jsx("div",{className:"mb-8 text-left",children:i.jsx(Hf,{noteId:m.id,noteContent:m.content})}),i.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 justify-center",children:[s&&i.jsxs("button",{onClick:s,className:"flex items-center justify-center gap-2 px-6 py-3 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium transition-colors",children:[i.jsx(mu,{className:"w-5 h-5"}),"Back"]}),i.jsxs("button",{onClick:_,className:"flex items-center justify-center gap-2 px-6 py-3 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium transition-colors",children:[n?i.jsx(Zt,{className:"w-5 h-5"}):i.jsx(fu,{className:"w-5 h-5"}),n?"Copied!":"Copy to Clipboard"]}),i.jsxs("button",{onClick:e,className:"flex items-center justify-center gap-2 px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-medium transition-colors",children:[i.jsx(Da,{className:"w-5 h-5"}),"New Note"]}),i.jsx("button",{onClick:t,className:"flex items-center justify-center gap-2 px-6 py-3 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium transition-colors",children:"Dashboard"})]})]})})]})}function ev({onTranscript:c,model:e}){const[t,s]=T.useState(!1),[n,a]=T.useState(""),[o,l]=T.useState(!1),[d,h]=T.useState(null),[u,p]=T.useState(null),[m,f]=T.useState(0),[g,b]=T.useState(0),A=zi.useRef(null),N=zi.useRef([]),j=zi.useRef(null),E=zi.useRef(null),_=zi.useRef(null),y=zi.useRef(null);T.useEffect(()=>()=>{j.current&&j.current.getTracks().forEach($=>$.stop()),_.current&&cancelAnimationFrame(_.current),y.current&&clearInterval(y.current)},[]);const C=T.useCallback(()=>{if(E.current&&t){const $=new Uint8Array(E.current.frequencyBinCount);E.current.getByteFrequencyData($);const q=$.reduce((F,P)=>F+P)/$.length;b(q/255),_.current=requestAnimationFrame(C)}},[t]);async function R(){h(null),p(null),f(0),N.current=[];try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){h("Microphone access is not available in this environment. Voice recording requires the app to be run with proper entitlements. For now, please use text input instead.");return}const $=await navigator.mediaDevices.getUserMedia({audio:{channelCount:1,sampleRate:16e3,echoCancellation:!0,noiseSuppression:!0}});j.current=$;const q=new AudioContext,F=q.createMediaStreamSource($),P=q.createAnalyser();P.fftSize=256,F.connect(P),E.current=P;const I=new MediaRecorder($,{mimeType:"audio/webm;codecs=opus"});A.current=I,I.ondataavailable=K=>{K.data.size>0&&N.current.push(K.data)},I.onstop=async()=>{await k()},I.start(1e3),s(!0),y.current=setInterval(()=>{f(K=>K+1)},1e3),C()}catch($){console.error("Microphone access error:",$),$ instanceof DOMException&&$.name==="NotAllowedError"?h("Microphone access denied. Please allow microphone access to use voice recording."):h(`Failed to start recording: ${$}`)}}async function S(){y.current&&(clearInterval(y.current),y.current=null),_.current&&(cancelAnimationFrame(_.current),_.current=null),A.current&&A.current.state!=="inactive"&&A.current.stop(),j.current&&(j.current.getTracks().forEach($=>$.stop()),j.current=null),s(!1),b(0)}async function k(){l(!0);try{const q=await new Blob(N.current,{type:"audio/webm"}).arrayBuffer(),I=(await new AudioContext({sampleRate:16e3}).decodeAudioData(q)).getChannelData(0),K=Array.from(I),ie=await Dg(K,16e3),ue=ie.map(V=>V.text).join(" ").trim(),te=ie.find(V=>V.risk_detected);te!=null&&te.risk_detected&&p(te.risk_detected),ue&&!ue.includes("[placeholder]")&&!ue.includes("[Audio transcription")?a(ue):h("Whisper model not loaded. Install a Whisper model or type notes manually.")}catch($){console.error("Transcription error:",$),h(`Transcription failed: ${$}`)}finally{l(!1)}}async function M(){if(n.trim()){l(!0);try{const $=await Fg(n,"progress",e);c($),a("")}catch($){h(String($))}finally{l(!1)}}}function L(){n.trim()&&(c(n),a(""))}function O($){const q=Math.floor($/60),F=$%60;return`${q}:${F.toString().padStart(2,"0")}`}return i.jsxs("div",{className:"bg-slate-800 rounded-xl p-6",children:[i.jsxs("div",{className:"flex items-center justify-between mb-4",children:[i.jsxs("h3",{className:"text-lg font-semibold flex items-center gap-2",children:[i.jsx(lo,{className:"w-5 h-5"}),"Voice Scribe"]}),i.jsx("span",{className:"text-xs text-slate-500",children:"Local Whisper • PHI-Safe"})]}),u&&i.jsxs("div",{className:"bg-red-500/20 border border-red-500/50 rounded-lg p-3 mb-4 flex items-center gap-2",children:[i.jsx(Es,{className:"w-5 h-5 text-red-400 flex-shrink-0"}),i.jsxs("span",{className:"text-sm text-red-200",children:["Risk phrase detected: ",i.jsx("strong",{children:u})]})]}),i.jsxs("div",{className:"flex items-center gap-4 mb-4",children:[i.jsx("button",{onClick:t?S:R,disabled:o,className:`flex items-center justify-center w-16 h-16 rounded-full transition-all ${t?"bg-red-500 hover:bg-red-600":"bg-blue-600 hover:bg-blue-700"} disabled:opacity-50`,style:t?{boxShadow:`0 0 ${20+g*30}px ${g*15}px rgba(239, 68, 68, ${.3+g*.4})`}:void 0,children:o?i.jsx(Ne,{className:"w-8 h-8 animate-spin"}):t?i.jsx(rg,{className:"w-8 h-8"}):i.jsx(lo,{className:"w-8 h-8"})}),i.jsxs("div",{className:"flex-1",children:[i.jsx("div",{className:"text-sm text-slate-400",children:t?`Recording... ${O(m)}`:o?"Transcribing with Whisper...":"Click to start voice capture"}),t&&i.jsx("div",{className:"h-2 bg-slate-700 rounded-full mt-2 overflow-hidden",children:i.jsx("div",{className:"h-full bg-gradient-to-r from-green-500 via-yellow-500 to-red-500 transition-all duration-75",style:{width:`${Math.min(g*150,100)}%`}})})]})]}),n&&i.jsxs("div",{className:"mb-4",children:[i.jsx("div",{className:"text-sm text-slate-400 mb-2",children:"Transcript:"}),i.jsx("div",{className:"bg-slate-700 rounded-lg p-3 text-sm max-h-32 overflow-y-auto",children:n})]}),n&&i.jsxs("div",{className:"flex gap-2",children:[i.jsxs("button",{onClick:L,className:"flex-1 bg-slate-700 hover:bg-slate-600 py-2 rounded-lg font-medium flex items-center justify-center gap-2",children:[i.jsx(Dt,{className:"w-4 h-4"}),"Use Raw"]}),i.jsxs("button",{onClick:M,disabled:o,className:"flex-1 bg-blue-600 hover:bg-blue-700 disabled:opacity-50 py-2 rounded-lg font-medium flex items-center justify-center gap-2",children:[i.jsx(wn,{className:"w-4 h-4"}),"AI Structure"]}),i.jsx("button",{onClick:()=>a(""),className:"px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg",children:"Clear"})]}),d&&i.jsx("div",{className:"mt-4 text-sm text-red-400 bg-red-500/10 rounded-lg p-3",children:d})]})}const tv=[{key:"appearance",label:"Appearance",options:["Well-groomed","Disheveled","Appropriate","Bizarre","Not assessed"]},{key:"behavior",label:"Behavior",options:["Cooperative","Agitated","Withdrawn","Guarded","Appropriate","Not assessed"]},{key:"speech",label:"Speech",options:["Normal rate/volume","Pressured","Soft","Loud","Slurred","Not assessed"]},{key:"mood",label:"Mood (reported)",options:["Euthymic","Depressed","Anxious","Irritable","Euphoric","Not assessed"]},{key:"affect",label:"Affect (observed)",options:["Congruent","Flat","Blunted","Labile","Incongruent","Not assessed"]},{key:"thoughtProcess",label:"Thought Process",options:["Linear","Tangential","Circumstantial","Disorganized","Not assessed"]},{key:"thoughtContent",label:"Thought Content",options:["Appropriate","Preoccupied","Paranoid","Delusional","Not assessed"]},{key:"cognition",label:"Cognition",options:["Intact","Impaired attention","Memory deficits","Disoriented","Not assessed"]},{key:"insightJudgment",label:"Insight/Judgment",options:["Good","Fair","Poor","Impaired","Not assessed"]}];function sv({value:c,onChange:e,expanded:t,onToggleExpand:s}){const n=Object.values(c).filter(a=>a&&a!=="Not assessed").length;return i.jsxs("div",{className:"bg-slate-800 rounded-xl overflow-hidden",children:[i.jsxs("button",{onClick:s,className:"w-full flex items-center justify-between p-4 hover:bg-slate-700/50 transition-colors",children:[i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx(hc,{className:"w-5 h-5 text-purple-400"}),i.jsx("span",{className:"font-medium",children:"Mental Status Exam"}),i.jsxs("span",{className:"text-xs bg-purple-500/20 text-purple-400 px-2 py-0.5 rounded-full",children:[n,"/9 assessed"]})]}),i.jsx(Ct,{className:`w-5 h-5 text-slate-400 transition-transform ${t?"rotate-90":""}`})]}),t&&i.jsxs("div",{className:"border-t border-slate-700 p-4 space-y-3",children:[tv.map(a=>i.jsxs("div",{className:"flex items-center gap-3",children:[i.jsx("label",{className:"w-32 text-sm text-slate-400 flex-shrink-0",children:a.label}),i.jsx("select",{value:c[a.key]||"Not assessed",onChange:o=>e({...c,[a.key]:o.target.value}),className:"flex-1 bg-slate-700 border border-slate-600 rounded px-3 py-1.5 text-sm focus:outline-none focus:border-purple-500",children:a.options.map(o=>i.jsx("option",{value:o,children:o},o))}),i.jsx("input",{type:"text",placeholder:"Notes...",className:"w-40 bg-slate-700/50 border border-slate-600 rounded px-2 py-1.5 text-xs focus:outline-none focus:border-purple-500"})]},a.key)),i.jsx("div",{className:"pt-2 text-xs text-slate-500",children:'Select "Not assessed" for domains not evaluated this session'})]})]})}const iv=["Family support","Social connections","Treatment engagement","Future orientation","Religious/spiritual beliefs","Children/pets","Employment","No access to means"];function nv({value:c,onChange:e,expanded:t,onToggleExpand:s}){const n=c.suicidalIdeation!=="denied"&&c.suicidalIdeation!=="not_assessed";return i.jsxs("div",{className:`bg-slate-800 rounded-xl overflow-hidden ${n?"ring-2 ring-red-500/50":""}`,children:[i.jsxs("button",{onClick:s,className:"w-full flex items-center justify-between p-4 hover:bg-slate-700/50 transition-colors",children:[i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx(Es,{className:`w-5 h-5 ${n?"text-red-400":"text-amber-400"}`}),i.jsx("span",{className:"font-medium",children:"Risk Assessment"}),n&&i.jsx("span",{className:"text-xs bg-red-500/20 text-red-400 px-2 py-0.5 rounded-full animate-pulse",children:"Risk Identified"})]}),i.jsx(Ct,{className:`w-5 h-5 text-slate-400 transition-transform ${t?"rotate-90":""}`})]}),t&&i.jsxs("div",{className:"border-t border-slate-700 p-4 space-y-4",children:[i.jsxs("div",{className:"space-y-2",children:[i.jsx("label",{className:"text-sm font-medium text-slate-300",children:"Suicidal Ideation"}),i.jsx("div",{className:"flex flex-wrap gap-2",children:[{value:"denied",label:"Denied",color:"bg-green-500/20 text-green-400 border-green-500/30"},{value:"passive",label:"Passive",color:"bg-amber-500/20 text-amber-400 border-amber-500/30"},{value:"active",label:"Active (no plan)",color:"bg-orange-500/20 text-orange-400 border-orange-500/30"},{value:"active_with_plan",label:"Active with plan",color:"bg-red-500/20 text-red-400 border-red-500/30"},{value:"not_assessed",label:"Not assessed",color:"bg-slate-600 text-slate-400 border-slate-500/30"}].map(a=>i.jsx("button",{type:"button",onClick:()=>e({...c,suicidalIdeation:a.value}),className:`px-3 py-1.5 rounded-lg text-xs border transition-all ${c.suicidalIdeation===a.value?`${a.color} border-2`:"bg-slate-700 text-slate-400 border-slate-600 hover:bg-slate-600"}`,children:a.label},a.value))}),c.suicidalIdeation!=="denied"&&c.suicidalIdeation!=="not_assessed"&&i.jsx("textarea",{value:c.suicidalIdeationDetails,onChange:a=>e({...c,suicidalIdeationDetails:a.target.value}),placeholder:"Document details: frequency, plan specificity, intent, means access...",className:"w-full bg-slate-700/50 border border-red-500/30 rounded px-3 py-2 text-sm focus:outline-none focus:border-red-500 mt-2",rows:2})]}),i.jsxs("div",{className:"space-y-2",children:[i.jsx("label",{className:"text-sm font-medium text-slate-300",children:"Homicidal Ideation"}),i.jsx("div",{className:"flex gap-2",children:[{value:"denied",label:"Denied",color:"bg-green-500/20 text-green-400 border-green-500/30"},{value:"present",label:"Present",color:"bg-red-500/20 text-red-400 border-red-500/30"},{value:"not_assessed",label:"Not assessed",color:"bg-slate-600 text-slate-400 border-slate-500/30"}].map(a=>i.jsx("button",{type:"button",onClick:()=>e({...c,homicidalIdeation:a.value}),className:`px-3 py-1.5 rounded-lg text-xs border transition-all ${c.homicidalIdeation===a.value?`${a.color} border-2`:"bg-slate-700 text-slate-400 border-slate-600 hover:bg-slate-600"}`,children:a.label},a.value))})]}),i.jsxs("div",{className:"space-y-2",children:[i.jsx("label",{className:"text-sm font-medium text-slate-300",children:"Self-Harm"}),i.jsx("div",{className:"flex gap-2",children:[{value:"denied",label:"Denied"},{value:"history",label:"History (not current)"},{value:"current",label:"Current"},{value:"not_assessed",label:"Not assessed"}].map(a=>i.jsx("button",{type:"button",onClick:()=>e({...c,selfHarm:a.value}),className:`px-3 py-1.5 rounded-lg text-xs border transition-all ${c.selfHarm===a.value?"bg-purple-500/20 text-purple-400 border-purple-500/30 border-2":"bg-slate-700 text-slate-400 border-slate-600 hover:bg-slate-600"}`,children:a.label},a.value))})]}),i.jsxs("div",{className:"space-y-2",children:[i.jsx("label",{className:"text-sm font-medium text-slate-300",children:"Safety Plan"}),i.jsx("div",{className:"flex flex-wrap gap-2",children:[{value:"in_place",label:"In place"},{value:"updated",label:"Updated this session"},{value:"developed",label:"Developed this session"},{value:"not_applicable",label:"Not applicable"},{value:"not_assessed",label:"Not assessed"}].map(a=>i.jsx("button",{type:"button",onClick:()=>e({...c,safetyPlan:a.value}),className:`px-3 py-1.5 rounded-lg text-xs border transition-all ${c.safetyPlan===a.value?"bg-cyan-500/20 text-cyan-400 border-cyan-500/30 border-2":"bg-slate-700 text-slate-400 border-slate-600 hover:bg-slate-600"}`,children:a.label},a.value))})]}),i.jsxs("div",{className:"space-y-2",children:[i.jsx("label",{className:"text-sm font-medium text-slate-300",children:"Protective Factors"}),i.jsx("div",{className:"flex flex-wrap gap-2",children:iv.map(a=>i.jsx("button",{type:"button",onClick:()=>{const o=c.protectiveFactors||[];o.includes(a)?e({...c,protectiveFactors:o.filter(l=>l!==a)}):e({...c,protectiveFactors:[...o,a]})},className:`px-3 py-1.5 rounded-lg text-xs border transition-all ${(c.protectiveFactors||[]).includes(a)?"bg-green-500/20 text-green-400 border-green-500/30 border-2":"bg-slate-700 text-slate-400 border-slate-600 hover:bg-slate-600"}`,children:a},a))})]}),i.jsxs("div",{className:"pt-2 border-t border-slate-700",children:[i.jsx("label",{className:"text-sm font-medium text-slate-300 mb-2 block",children:"Overall Risk Level"}),i.jsx("div",{className:"flex gap-2",children:[{value:"low",label:"Low",color:"bg-green-500/20 text-green-400 border-green-500"},{value:"moderate",label:"Moderate",color:"bg-amber-500/20 text-amber-400 border-amber-500"},{value:"high",label:"High",color:"bg-orange-500/20 text-orange-400 border-orange-500"},{value:"imminent",label:"Imminent",color:"bg-red-500/20 text-red-400 border-red-500"},{value:"not_assessed",label:"Not assessed",color:"bg-slate-600 text-slate-400 border-slate-500"}].map(a=>i.jsx("button",{type:"button",onClick:()=>e({...c,riskLevel:a.value}),className:`flex-1 px-3 py-2 rounded-lg text-sm border-2 transition-all ${c.riskLevel===a.value?a.color:"bg-slate-700 text-slate-400 border-slate-600 hover:bg-slate-600"}`,children:a.label},a.value))})]})]})]})}function av(c){return["**MENTAL STATUS EXAM:**",`- Appearance: ${c.appearance||"Not assessed"}`,`- Behavior: ${c.behavior||"Not assessed"}`,`- Speech: ${c.speech||"Not assessed"}`,`- Mood (reported): ${c.mood||"Not assessed"}`,`- Affect (observed): ${c.affect||"Not assessed"}`,`- Thought Process: ${c.thoughtProcess||"Not assessed"}`,`- Thought Content: ${c.thoughtContent||"Not assessed"}`,`- Cognition: ${c.cognition||"Not assessed"}`,`- Insight/Judgment: ${c.insightJudgment||"Not assessed"}`].join(`
`)}function rv(c){var s,n,a;const t=["**RISK ASSESSMENT:**",`- Suicidal Ideation: ${{denied:"Denied",passive:"Passive ideation",active:"Active ideation (no plan)",active_with_plan:"Active ideation with plan",not_assessed:"Not assessed"}[c.suicidalIdeation]||"Not assessed"}`];return c.suicidalIdeationDetails&&t.push(`  Details: ${c.suicidalIdeationDetails}`),t.push(`- Homicidal Ideation: ${c.homicidalIdeation==="denied"?"Denied":c.homicidalIdeation==="present"?"Present":"Not assessed"}`),t.push(`- Self-Harm: ${c.selfHarm==="denied"?"Denied":c.selfHarm==="history"?"History (not current)":c.selfHarm==="current"?"Current":"Not assessed"}`),t.push(`- Safety Plan: ${((s=c.safetyPlan)==null?void 0:s.replace(/_/g," "))||"Not assessed"}`),((n=c.protectiveFactors)==null?void 0:n.length)>0&&t.push(`- Protective Factors: ${c.protectiveFactors.join(", ")}`),t.push(`- Overall Risk Level: ${((a=c.riskLevel)==null?void 0:a.replace(/_/g," "))||"Not assessed"}`),t.join(`
`)}function ov({clientId:c,model:e,onNoteSelect:t}){const[s,n]=T.useState([]),[a,o]=T.useState(!1),[l,d]=T.useState(!1),[h,u]=T.useState(null),[p,m]=T.useState(null);async function f(){o(!0),m(null);try{const E=(await _c(c)).slice(0,10);if(E.length<2){m("Need at least 2 notes to analyze treatment themes"),o(!1);return}const y=await Pp("What are the main recurring themes, symptoms, and treatment focuses across these sessions? Identify 3-5 key themes.",e,c),C=g(y.answer),R=[];for(const S of C){const M=(await Rp(S,5,c)).map(O=>({noteId:O.note_id,noteDate:O.note_date||"Unknown date",excerpt:O.chunk_text.slice(0,200)+(O.chunk_text.length>200?"...":""),relevance:O.score})),L=b(M,E);R.push({name:S,status:L,excerpts:M})}n(R)}catch(j){console.error("Theme analysis failed:",j),m(String(j))}finally{o(!1)}}function g(j){const E=j.split(`
`),_=[];for(const y of E){const C=y.match(/^[\d\.\-\*]+\s*(.+?)(?:\s*[-:]|$)/);C&&C[1].length>2&&C[1].length<50&&_.push(C[1].trim())}if(_.length===0){const y=["anxiety","depression","sleep","relationship","work stress","trauma","grief","self-esteem","coping","medication"];for(const C of y)j.toLowerCase().includes(C)&&_.push(C.charAt(0).toUpperCase()+C.slice(1))}return _.slice(0,5)}function b(j,E){if(j.length===0)return"new";const _=new Set(E.slice(0,3).map(S=>S.id)),y=new Set(E.slice(3).map(S=>S.id)),C=j.filter(S=>_.has(S.noteId)).length,R=j.filter(S=>y.has(S.noteId)).length;return C===0&&R>0?"resolved":C>0&&R===0?"new":(C>R,"stable")}const A={improving:"bg-green-500/20 text-green-400 border-green-500/30",stable:"bg-blue-500/20 text-blue-400 border-blue-500/30",declining:"bg-red-500/20 text-red-400 border-red-500/30",new:"bg-purple-500/20 text-purple-400 border-purple-500/30",resolved:"bg-slate-500/20 text-slate-400 border-slate-500/30"},N={improving:"↑",stable:"→",declining:"↓",new:"New",resolved:"Resolved"};return i.jsxs("div",{className:"bg-slate-800 rounded-xl overflow-hidden",children:[i.jsxs("button",{onClick:()=>d(!l),className:"w-full flex items-center justify-between p-4 hover:bg-slate-700/50 transition-colors",children:[i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx(sd,{className:"w-5 h-5 text-emerald-400"}),i.jsx("span",{className:"font-medium",children:"Treatment Progress"}),s.length>0&&i.jsxs("span",{className:"text-xs bg-emerald-500/20 text-emerald-400 px-2 py-0.5 rounded-full",children:[s.length," themes"]})]}),i.jsx(Ct,{className:`w-5 h-5 text-slate-400 transition-transform ${l?"rotate-90":""}`})]}),l&&i.jsxs("div",{className:"border-t border-slate-700 p-4",children:[!s.length&&!a&&i.jsxs("div",{className:"text-center py-6",children:[i.jsx(sd,{className:"w-12 h-12 text-slate-600 mx-auto mb-3"}),i.jsx("p",{className:"text-slate-400 text-sm mb-4",children:"Analyze treatment themes across sessions to track progress"}),i.jsx("button",{onClick:f,disabled:a,className:"bg-emerald-600 hover:bg-emerald-700 disabled:opacity-50 px-4 py-2 rounded-lg text-sm",children:"Analyze Themes"})]}),a&&i.jsxs("div",{className:"text-center py-6",children:[i.jsx(Ne,{className:"w-8 h-8 text-emerald-400 mx-auto mb-2 animate-spin"}),i.jsx("p",{className:"text-slate-400 text-sm",children:"Analyzing treatment themes..."})]}),p&&i.jsx("div",{className:"text-red-400 text-sm bg-red-500/10 rounded-lg p-3 mb-4",children:p}),s.length>0&&i.jsxs("div",{className:"space-y-3",children:[s.map(j=>i.jsxs("div",{className:"bg-slate-700/50 rounded-lg overflow-hidden",children:[i.jsxs("button",{onClick:()=>u(h===j.name?null:j.name),className:"w-full flex items-center justify-between p-3 hover:bg-slate-700/70",children:[i.jsxs("div",{className:"flex items-center gap-3",children:[i.jsx("span",{className:`text-lg ${A[j.status].split(" ")[1]}`,children:N[j.status]}),i.jsx("span",{className:"font-medium",children:j.name}),i.jsx("span",{className:`text-xs px-2 py-0.5 rounded border ${A[j.status]}`,children:j.status})]}),i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsxs("span",{className:"text-xs text-slate-500",children:[j.excerpts.length," mentions"]}),i.jsx(Ct,{className:`w-4 h-4 text-slate-400 transition-transform ${h===j.name?"rotate-90":""}`})]})]}),h===j.name&&i.jsxs("div",{className:"border-t border-slate-600 p-3 space-y-2",children:[i.jsx("div",{className:"text-xs text-slate-400 mb-2",children:"Supporting excerpts (click to view note):"}),j.excerpts.map((E,_)=>i.jsxs("button",{onClick:()=>t==null?void 0:t(E.noteId),className:"w-full text-left bg-slate-800/50 rounded p-2 hover:bg-slate-800 transition-colors",children:[i.jsxs("div",{className:"flex items-center justify-between mb-1",children:[i.jsx("span",{className:"text-xs text-slate-500",children:E.noteDate}),i.jsxs("span",{className:"text-xs text-emerald-400",children:[Math.round(E.relevance*100),"%"]})]}),i.jsxs("p",{className:"text-xs text-slate-300 line-clamp-2",children:['"',E.excerpt,'"']})]},_))]})]},j.name)),i.jsx("button",{onClick:f,className:"w-full text-center text-xs text-slate-400 hover:text-white py-2",children:"↻ Refresh Analysis"})]})]})]})}function $f({clientId:c,model:e,onNoteSelect:t}){const[s,n]=T.useState(""),[a,o]=T.useState([]),[l,d]=T.useState(null),[h,u]=T.useState(!1),[p,m]=T.useState("search"),[f,g]=T.useState(null),[b,A]=T.useState(null),[N,j]=T.useState(!1);T.useEffect(()=>{E()},[]);async function E(){try{const C=await Og();g(C)}catch(C){console.error("Failed to load index stats:",C)}}async function _(){if(s.trim()){u(!0),d(null),o([]),A(null),j(!0);try{if(p==="search"){const C=await Rp(s,10,c);o(C),C.length===0&&A("No matching notes found. Try different search terms or rebuild the index.")}else{const C=await Pp(s,e,c);d(C),o([])}}catch(C){console.error("Search failed:",C),A(`Search failed: ${C instanceof Error?C.message:"Unknown error"}. Make sure notes are indexed.`)}finally{u(!1)}}}async function y(){u(!0),A(null);try{const C=await $g();await E(),A(`Successfully indexed ${C} note chunks.`)}catch(C){console.error("Reindex failed:",C),A(`Reindex failed: ${C instanceof Error?C.message:"Unknown error"}`)}finally{u(!1)}}return i.jsxs("div",{className:"bg-slate-800 rounded-xl p-6",children:[i.jsxs("div",{className:"flex items-center justify-between mb-4",children:[i.jsxs("h3",{className:"text-lg font-semibold flex items-center gap-2",children:[i.jsx(ti,{className:"w-5 h-5"}),"Cross-Note Search"]}),f&&i.jsxs("span",{className:"text-xs text-slate-500",children:[f.indexed_notes,"/",f.total_notes," indexed"]})]}),i.jsxs("div",{className:"flex gap-2 mb-4",children:[i.jsxs("button",{onClick:()=>m("search"),className:`flex-1 py-2 rounded-lg text-sm font-medium transition-colors ${p==="search"?"bg-blue-600 text-white":"bg-slate-700 text-slate-400 hover:bg-slate-600"}`,children:[i.jsx(ti,{className:"w-4 h-4 inline mr-1"}),"Find Similar"]}),i.jsxs("button",{onClick:()=>m("ask"),className:`flex-1 py-2 rounded-lg text-sm font-medium transition-colors ${p==="ask"?"bg-blue-600 text-white":"bg-slate-700 text-slate-400 hover:bg-slate-600"}`,children:[i.jsx(Lo,{className:"w-4 h-4 inline mr-1"}),"Ask Question"]})]}),i.jsxs("div",{className:"flex gap-2 mb-4",children:[i.jsx("input",{type:"text",value:s,onChange:C=>n(C.target.value),onKeyDown:C=>C.key==="Enter"&&_(),placeholder:p==="search"?"Search across all notes...":"Ask a question about past sessions...",className:"flex-1 bg-slate-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"}),i.jsx("button",{onClick:_,disabled:h||!s.trim(),className:"bg-blue-600 hover:bg-blue-700 disabled:opacity-50 px-4 py-2 rounded-lg",children:h?i.jsx(Ne,{className:"w-5 h-5 animate-spin"}):i.jsx(ti,{className:"w-5 h-5"})})]}),h&&i.jsxs("div",{className:"text-center py-8",children:[i.jsx(Ne,{className:"w-8 h-8 text-blue-500 mx-auto mb-3 animate-spin"}),i.jsx("p",{className:"text-slate-400 text-sm",children:p==="search"?"Searching notes...":"Generating answer..."})]}),b&&!h&&i.jsx("div",{className:`mb-4 p-3 rounded-lg text-sm ${b.includes("Successfully")?"bg-green-500/10 border border-green-500/30 text-green-400":"bg-amber-500/10 border border-amber-500/30 text-amber-400"}`,children:b}),l&&!h&&i.jsx("div",{className:"mb-4",children:i.jsxs("div",{className:"bg-blue-500/10 border border-blue-500/30 rounded-lg p-4",children:[i.jsxs("div",{className:"text-sm text-blue-300 mb-2 flex items-center gap-2",children:[i.jsx(Lo,{className:"w-4 h-4"}),"AI Answer"]}),i.jsx("div",{className:"text-sm whitespace-pre-wrap",children:l.answer}),l.sources.length>0&&i.jsxs("div",{className:"mt-3 pt-3 border-t border-blue-500/20",children:[i.jsx("div",{className:"text-xs text-slate-400 mb-1",children:"Sources (click to view):"}),i.jsx("div",{className:"flex flex-wrap gap-2",children:l.sources.map((C,R)=>i.jsxs("button",{onClick:()=>t==null?void 0:t(C.note_id),className:"text-xs bg-slate-700 hover:bg-slate-600 px-2 py-1 rounded cursor-pointer transition-colors",title:"Click to view this note",children:[C.note_date||C.note_id.slice(0,8),i.jsxs("span",{className:"text-slate-500 ml-1",children:["(",Math.round(C.relevance*100),"%)"]})]},R))})]})]})}),a.length>0&&!h&&i.jsx("div",{className:"space-y-2",children:a.map((C,R)=>i.jsxs("button",{onClick:()=>t==null?void 0:t(C.note_id),className:"w-full text-left bg-slate-700/50 rounded-lg p-3 hover:bg-slate-700 transition-colors cursor-pointer",children:[i.jsxs("div",{className:"flex items-center justify-between mb-1",children:[i.jsxs("span",{className:"text-xs text-slate-400",children:[C.note_date," • ",C.note_type]}),i.jsxs("span",{className:"text-xs text-blue-400",children:[Math.round(C.score*100),"% match"]})]}),i.jsx("div",{className:"text-sm line-clamp-2",children:C.chunk_text})]},R))}),!a.length&&!l&&!h&&!N&&i.jsxs("div",{className:"text-center py-8",children:[i.jsx(ti,{className:"w-12 h-12 text-slate-600 mx-auto mb-3"}),i.jsx("p",{className:"text-slate-400 text-sm mb-4",children:p==="search"?"Search semantically across all session notes":"Ask questions and get answers from past documentation"}),i.jsx("button",{onClick:y,className:"text-xs text-blue-400 hover:text-blue-300",children:"Rebuild Search Index"})]})]})}function gp({data:c,color:e="#22c55e",height:t=40,width:s=120}){if(!c||c.length<2)return i.jsx("div",{className:"text-xs text-slate-500 italic",children:"No trend data"});const n=Math.max(...c),a=Math.min(...c),o=n-a||1,l=c.map((d,h)=>{const u=h/(c.length-1)*s,p=t-(d-a)/o*(t-4)-2;return`${u},${p}`}).join(" ");return i.jsxs("svg",{width:s,height:t,className:"overflow-visible",children:[i.jsx("path",{d:`M0,${t} ${c.map((d,h)=>{const u=h/(c.length-1)*s,p=t-(d-a)/o*(t-4)-2;return`L${u},${p}`}).join(" ")} L${s},${t} Z`,fill:e,fillOpacity:.1}),i.jsx("polyline",{points:l,fill:"none",stroke:e,strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"}),i.jsx("circle",{cx:s,cy:t-(c[c.length-1]-a)/o*(t-4)-2,r:3,fill:e})]})}function lv({onClientSelect:c}){const[e,t]=T.useState(""),[s,n]=T.useState([]),[a,o]=T.useState(!1),[l,d]=T.useState(!1);async function h(){if(e.trim()){o(!0),d(!0);try{const u=await Gg(e);n(u)}catch(u){console.error("Search failed:",u)}finally{o(!1)}}}return i.jsxs("div",{className:"bg-slate-800 rounded-xl p-6",children:[i.jsxs("h3",{className:"text-lg font-semibold flex items-center gap-2 mb-4",children:[i.jsx(Do,{className:"w-5 h-5"}),"Cross-Client Search"]}),i.jsx("p",{className:"text-sm text-slate-400 mb-4",children:"Search across all client profiles (name, phone, insurance, diagnosis, etc.)"}),i.jsxs("div",{className:"flex gap-2 mb-4",children:[i.jsx("input",{type:"text",value:e,onChange:u=>t(u.target.value),onKeyDown:u=>u.key==="Enter"&&h(),placeholder:"Search by name, phone, insurance, diagnosis...",className:"flex-1 bg-slate-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"}),i.jsx("button",{onClick:h,disabled:a||!e.trim(),className:"bg-blue-600 hover:bg-blue-700 disabled:opacity-50 px-4 py-2 rounded-lg",children:a?i.jsx(Ne,{className:"w-5 h-5 animate-spin"}):i.jsx(ti,{className:"w-5 h-5"})})]}),l&&!a&&i.jsx("div",{className:"space-y-2",children:s.length===0?i.jsxs("p",{className:"text-slate-400 text-sm",children:['No clients found matching "',e,'"']}):i.jsxs(i.Fragment,{children:[i.jsxs("p",{className:"text-sm text-slate-400 mb-2",children:[s.length," client(s) found"]}),s.map(u=>i.jsxs("div",{className:"bg-slate-700/50 rounded-lg p-3 hover:bg-slate-700 transition-colors cursor-pointer",onClick:()=>c==null?void 0:c(u.client),children:[i.jsxs("div",{className:"flex items-center justify-between",children:[i.jsxs("div",{children:[i.jsx("div",{className:"font-medium",children:u.client.display_name}),i.jsxs("div",{className:"text-sm text-slate-400",children:[u.client.session_count," sessions"]})]}),i.jsx(Ct,{className:"w-5 h-5 text-slate-400"})]}),u.matched_fields.length>0&&i.jsx("div",{className:"mt-2 flex flex-wrap gap-2",children:u.matched_fields.map(([p,m],f)=>i.jsxs("span",{className:"text-xs bg-blue-500/20 text-blue-400 px-2 py-1 rounded",children:[p,": ",m.length>30?m.substring(0,30)+"...":m]},f))})]},u.client.id))]})})]})}function cv({clientId:c}){const[e,t]=T.useState([]),[s,n]=T.useState(!1),[a,o]=T.useState(!1),[l,d]=T.useState(!1),[h,u]=T.useState(null),[p,m]=T.useState(null),[f,g]=T.useState(null),b=zi.useRef(null);async function A(){n(!0);try{const S=await Xg(c);t(S)}catch(S){console.error("Failed to load documents:",S)}finally{n(!1)}}async function N(){try{const S=await ex();g(S)}catch{g(!1)}}T.useEffect(()=>{a&&e.length===0&&(A(),N())},[a]);async function j(S){var L,O;const k=(L=S.target.files)==null?void 0:L[0];if(!k)return;if(!["application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","image/jpeg","image/png","image/gif"].includes(k.type)){alert("Unsupported file type. Please upload PDF, DOCX, JPG, or PNG files.");return}if(k.size>10*1024*1024){alert("File too large. Maximum size is 10MB.");return}d(!0);try{const $=await k.arrayBuffer(),q=Array.from(new Uint8Array($)),F=((O=k.name.split(".").pop())==null?void 0:O.toLowerCase())||"unknown";await qg(c,k.name,F,k.type,q,void 0,new Date().toISOString().split("T")[0]),await A(),b.current&&(b.current.value="")}catch($){console.error("Upload failed:",$),alert("Failed to upload document: "+String($))}finally{d(!1)}}async function E(S){if(confirm("Delete this document? This cannot be undone."))try{await Kg(S),t(k=>k.filter(M=>M.id!==S)),u(null)}catch(k){console.error("Delete failed:",k),alert("Failed to delete document: "+String(k))}}async function _(S){try{const k=await Yg(S.id),M=new Blob([new Uint8Array(k)],{type:S.mime_type}),L=URL.createObjectURL(M),O=document.createElement("a");O.href=L,O.download=S.filename,O.click(),URL.revokeObjectURL(L)}catch(k){console.error("Download failed:",k),alert("Failed to download document: "+String(k))}}async function y(S){m(S);try{const k=await Jg(S);alert(k),await A()}catch(k){console.error("OCR failed:",k),alert("OCR failed: "+String(k))}finally{m(null)}}function C(S){return S<1024?S+" B":S<1024*1024?(S/1024).toFixed(1)+" KB":(S/(1024*1024)).toFixed(1)+" MB"}const R={pdf:"Document",docx:"Document",doc:"Document",jpg:"Image",jpeg:"Image",png:"Image",gif:"Image"};return i.jsxs("div",{className:"bg-slate-800 rounded-xl overflow-hidden",children:[i.jsxs("button",{onClick:()=>o(!a),className:"w-full flex items-center justify-between p-4 hover:bg-slate-700/50 transition-colors",children:[i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx(Dt,{className:"w-5 h-5 text-blue-400"}),i.jsx("span",{className:"font-medium",children:"Documents"}),e.length>0&&i.jsx("span",{className:"text-xs bg-slate-600 px-2 py-0.5 rounded-full",children:e.length})]}),i.jsx(Ct,{className:`w-5 h-5 text-slate-400 transition-transform ${a?"rotate-90":""}`})]}),a&&i.jsxs("div",{className:"border-t border-slate-700 p-4",children:[i.jsxs("div",{className:"mb-4",children:[i.jsx("input",{ref:b,type:"file",accept:".pdf,.docx,.doc,.jpg,.jpeg,.png,.gif",onChange:j,className:"hidden"}),i.jsx("button",{onClick:()=>{var S;return(S=b.current)==null?void 0:S.click()},disabled:l,className:"w-full flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 disabled:opacity-50 px-4 py-3 rounded-lg transition-colors",children:l?i.jsxs(i.Fragment,{children:[i.jsx(Ne,{className:"w-5 h-5 animate-spin"}),"Uploading..."]}):i.jsxs(i.Fragment,{children:[i.jsx(Da,{className:"w-5 h-5"}),"Upload Document"]})}),i.jsx("p",{className:"text-xs text-slate-500 mt-2 text-center",children:"PDF, DOCX, JPG, PNG (max 10MB)"})]}),s?i.jsx("div",{className:"flex items-center justify-center py-8",children:i.jsx(Ne,{className:"w-6 h-6 text-blue-500 animate-spin"})}):e.length>0?i.jsx("div",{className:"space-y-2",children:e.map(S=>i.jsxs("div",{className:"flex items-center justify-between bg-slate-700/30 rounded-lg p-3 hover:bg-slate-700/50 transition-colors",children:[i.jsxs("div",{className:"flex items-center gap-3 flex-1 min-w-0",children:[i.jsx("span",{className:"text-2xl",children:R[S.file_type]||"Attachment"}),i.jsxs("div",{className:"flex-1 min-w-0",children:[i.jsx("div",{className:"font-medium truncate",children:S.filename}),i.jsxs("div",{className:"text-xs text-slate-400",children:[C(S.file_size)," • ",S.document_date||"No date",S.ocr_text&&i.jsx("span",{className:"ml-2 text-green-400",children:"• OCR indexed"})]})]})]}),i.jsxs("div",{className:"flex items-center gap-1 ml-2",children:[f&&!S.ocr_text&&["pdf","jpg","jpeg","png","gif"].includes(S.file_type)&&i.jsx("button",{onClick:()=>y(S.id),disabled:p===S.id,className:"p-2 hover:bg-purple-600/20 text-purple-400 rounded-lg transition-colors disabled:opacity-50",title:"Extract text with OCR",children:p===S.id?i.jsx(Ne,{className:"w-4 h-4 animate-spin"}):i.jsx(ti,{className:"w-4 h-4"})}),i.jsx("button",{onClick:()=>_(S),className:"p-2 hover:bg-slate-600 rounded-lg transition-colors",title:"Download",children:i.jsx(eg,{className:"w-4 h-4"})}),i.jsx("button",{onClick:()=>E(S.id),className:"p-2 hover:bg-red-600/20 text-red-400 rounded-lg transition-colors",title:"Delete",children:i.jsx(Np,{className:"w-4 h-4"})})]})]},S.id))}):i.jsx("p",{className:"text-slate-400 text-center py-4 text-sm",children:"No documents uploaded yet"})]})]})}function dv(){const[c,e]=T.useState(null),[t,s]=T.useState(!1),[n,a]=T.useState(!1),[o,l]=T.useState(!1);async function d(){s(!0);try{const p=await Qg();e(p)}catch(p){console.error("Failed to load storage stats:",p)}finally{s(!1)}}T.useEffect(()=>{o&&!c&&d()},[o]);async function h(){if(confirm("Optimize database? This may take a moment and will compact the database to reclaim space.")){a(!0);try{await Zg(),await d(),alert("Database optimized successfully!")}catch(p){console.error("Optimization failed:",p),alert("Failed to optimize database: "+String(p))}finally{a(!1)}}}function u(p){return p<1024?p+" B":p<1024*1024?(p/1024).toFixed(1)+" KB":p<1024*1024*1024?(p/(1024*1024)).toFixed(1)+" MB":(p/(1024*1024*1024)).toFixed(2)+" GB"}return i.jsxs("div",{className:"bg-slate-800 rounded-xl overflow-hidden",children:[i.jsxs("button",{onClick:()=>l(!o),className:"w-full flex items-center justify-between p-4 hover:bg-slate-700/50 transition-colors",children:[i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx(jp,{className:"w-5 h-5 text-emerald-400"}),i.jsx("span",{className:"font-medium",children:"Storage & Maintenance"})]}),i.jsx(Ct,{className:`w-5 h-5 text-slate-400 transition-transform ${o?"rotate-90":""}`})]}),o&&i.jsx("div",{className:"border-t border-slate-700 p-4",children:t?i.jsx("div",{className:"flex items-center justify-center py-8",children:i.jsx(Ne,{className:"w-6 h-6 text-blue-500 animate-spin"})}):c?i.jsxs("div",{className:"space-y-4",children:[i.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[i.jsxs("div",{className:"bg-slate-700/50 rounded-lg p-3 text-center",children:[i.jsx("div",{className:"text-2xl font-bold",children:u(c.database_size_bytes)}),i.jsx("div",{className:"text-xs text-slate-400",children:"Database Size"})]}),i.jsxs("div",{className:"bg-slate-700/50 rounded-lg p-3 text-center",children:[i.jsx("div",{className:"text-2xl font-bold",children:u(c.document_size_bytes)}),i.jsx("div",{className:"text-xs text-slate-400",children:"Documents"})]})]}),i.jsxs("div",{className:"grid grid-cols-4 gap-2 text-center text-sm",children:[i.jsxs("div",{className:"bg-slate-700/30 rounded-lg p-2",children:[i.jsx("div",{className:"font-bold",children:c.client_count}),i.jsx("div",{className:"text-xs text-slate-400",children:"Clients"})]}),i.jsxs("div",{className:"bg-slate-700/30 rounded-lg p-2",children:[i.jsx("div",{className:"font-bold",children:c.note_count}),i.jsx("div",{className:"text-xs text-slate-400",children:"Notes"})]}),i.jsxs("div",{className:"bg-slate-700/30 rounded-lg p-2",children:[i.jsx("div",{className:"font-bold",children:c.document_count}),i.jsx("div",{className:"text-xs text-slate-400",children:"Docs"})]}),i.jsxs("div",{className:"bg-slate-700/30 rounded-lg p-2",children:[i.jsx("div",{className:"font-bold",children:c.embedding_count}),i.jsx("div",{className:"text-xs text-slate-400",children:"Embeddings"})]})]}),i.jsx("button",{onClick:h,disabled:n,className:"w-full flex items-center justify-center gap-2 bg-emerald-600 hover:bg-emerald-700 disabled:opacity-50 px-4 py-3 rounded-lg transition-colors",children:n?i.jsxs(i.Fragment,{children:[i.jsx(Ne,{className:"w-5 h-5 animate-spin"}),"Optimizing..."]}):i.jsxs(i.Fragment,{children:[i.jsx(Kf,{className:"w-5 h-5"}),"Optimize Database"]})}),i.jsx("p",{className:"text-xs text-slate-500 text-center",children:"Compacts database and reclaims unused space"})]}):i.jsx("p",{className:"text-slate-400 text-center py-4",children:"Unable to load storage stats"})})]})}function hv(){const[c,e]=T.useState(null),[t,s]=T.useState(!1),[n,a]=T.useState(!1),[o,l]=T.useState(null);async function d(){s(!0);try{const p=await Wg();e(p)}catch(p){console.error("Failed to load voice status:",p)}finally{s(!1)}}T.useEffect(()=>{n&&!c&&d()},[n]);async function h(p){l(p);try{const m=await tx(p);alert(m),await d()}catch(m){console.error("Download failed:",m),alert("Download failed: "+String(m))}finally{l(null)}}const u=[{name:"tiny.en",size:"75 MB",desc:"Fastest, English only"},{name:"base.en",size:"142 MB",desc:"Good balance, English only"},{name:"small.en",size:"466 MB",desc:"Better accuracy, English only"},{name:"medium.en",size:"1.5 GB",desc:"High accuracy, English only"}];return i.jsxs("div",{className:"bg-slate-800 rounded-xl overflow-hidden",children:[i.jsxs("button",{onClick:()=>a(!n),className:"w-full flex items-center justify-between p-4 hover:bg-slate-700/50 transition-colors",children:[i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx(lo,{className:"w-5 h-5 text-purple-400"}),i.jsx("span",{className:"font-medium",children:"Voice Scribe Setup"}),c&&i.jsx("span",{className:`text-xs px-2 py-0.5 rounded-full ${c.whisper_installed&&c.models_available.length>0?"bg-green-500/20 text-green-400":"bg-amber-500/20 text-amber-400"}`,children:c.whisper_installed&&c.models_available.length>0?"Ready":"Setup Needed"})]}),i.jsx(Ct,{className:`w-5 h-5 text-slate-400 transition-transform ${n?"rotate-90":""}`})]}),n&&i.jsx("div",{className:"border-t border-slate-700 p-4",children:t?i.jsx("div",{className:"flex items-center justify-center py-8",children:i.jsx(Ne,{className:"w-6 h-6 text-blue-500 animate-spin"})}):c?i.jsxs("div",{className:"space-y-4",children:[i.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[i.jsxs("div",{className:`rounded-lg p-3 ${c.whisper_installed?"bg-green-500/10":"bg-red-500/10"}`,children:[i.jsx("div",{className:`text-sm font-medium ${c.whisper_installed?"text-green-400":"text-red-400"}`,children:c.whisper_installed?"Whisper Installed":"Whisper Not Found"}),!c.whisper_installed&&i.jsxs("div",{className:"text-xs text-slate-400 mt-1",children:["Run: ",i.jsx("code",{className:"bg-slate-700 px-1 rounded",children:"brew install whisper-cpp"})]})]}),i.jsxs("div",{className:`rounded-lg p-3 ${c.ffmpeg_installed?"bg-green-500/10":"bg-amber-500/10"}`,children:[i.jsx("div",{className:`text-sm font-medium ${c.ffmpeg_installed?"text-green-400":"text-amber-400"}`,children:c.ffmpeg_installed?"FFmpeg Installed":"FFmpeg Not Found"}),!c.ffmpeg_installed&&i.jsxs("div",{className:"text-xs text-slate-400 mt-1",children:["Run: ",i.jsx("code",{className:"bg-slate-700 px-1 rounded",children:"brew install ffmpeg"})]})]})]}),c.models_available.length>0&&i.jsxs("div",{children:[i.jsx("div",{className:"text-sm font-medium mb-2",children:"Installed Models"}),i.jsx("div",{className:"flex flex-wrap gap-2",children:c.models_available.map(p=>i.jsx("span",{className:"text-xs bg-green-500/20 text-green-400 px-2 py-1 rounded",children:p},p))})]}),i.jsxs("div",{children:[i.jsx("div",{className:"text-sm font-medium mb-2",children:"Download Model"}),i.jsx("div",{className:"space-y-2",children:u.map(p=>{const m=c.models_available.includes(`ggml-${p.name}.bin`);return i.jsxs("div",{className:"flex items-center justify-between bg-slate-700/30 rounded-lg p-2",children:[i.jsxs("div",{children:[i.jsx("div",{className:"text-sm font-medium",children:p.name}),i.jsxs("div",{className:"text-xs text-slate-400",children:[p.size," • ",p.desc]})]}),m?i.jsx("span",{className:"text-xs text-green-400 px-2",children:"Installed"}):i.jsx("button",{onClick:()=>h(p.name),disabled:o!==null,className:"text-xs bg-purple-600 hover:bg-purple-700 disabled:opacity-50 px-3 py-1 rounded transition-colors",children:o===p.name?i.jsx(Ne,{className:"w-4 h-4 animate-spin"}):"Download"})]},p.name)})})]}),i.jsx("button",{onClick:d,className:"w-full text-sm text-slate-400 hover:text-white py-2",children:"Refresh Status"})]}):i.jsx("p",{className:"text-slate-400 text-center py-4",children:"Unable to load voice status"})})]})}function uv(){var p,m;const[c,e]=T.useState(null),[t,s]=T.useState(null),[n,a]=T.useState(30),[o,l]=T.useState(!1);T.useEffect(()=>{d()},[n]);async function d(){l(!0);try{const[f,g]=await Promise.all([zg(n),Ug(n)]);e(f),s(g)}catch(f){console.error("Failed to load metrics:",f)}finally{l(!1)}}if(o&&!c)return i.jsx("div",{className:"bg-slate-800 rounded-xl p-6",children:i.jsx("div",{className:"flex items-center justify-center py-8",children:i.jsx(Ne,{className:"w-8 h-8 animate-spin text-slate-400"})})});const h=((p=c==null?void 0:c.time_trend)==null?void 0:p.map(f=>f.value/6e4))||[],u=((m=c==null?void 0:c.volume_trend)==null?void 0:m.map(f=>f.value))||[];return i.jsxs("div",{className:"bg-slate-800 rounded-xl p-6",children:[i.jsxs("div",{className:"flex items-center justify-between mb-6",children:[i.jsxs("h3",{className:"text-lg font-semibold flex items-center gap-2",children:[i.jsx(wn,{className:"w-5 h-5"}),"Performance Metrics"]}),i.jsxs("select",{value:n,onChange:f=>a(Number(f.target.value)),className:"bg-slate-700 rounded px-3 py-1 text-sm",children:[i.jsx("option",{value:7,children:"Last 7 days"}),i.jsx("option",{value:30,children:"Last 30 days"}),i.jsx("option",{value:90,children:"Last 90 days"})]})]}),t&&i.jsxs(i.Fragment,{children:[i.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mb-6",children:[i.jsx(jc,{label:"Time Saved",value:`${t.headline.time_saved_hours.toFixed(1)}h`,subtext:`${t.headline.time_saved_percentage.toFixed(0)}% efficiency`,positive:!0}),i.jsx(jc,{label:"Notes Completed",value:t.headline.notes_completed.toString(),subtext:`${c==null?void 0:c.notes_per_day.toFixed(1)}/day`}),i.jsx(jc,{label:"AI Acceptance",value:`${t.ai_analysis.ai_acceptance_rate.toFixed(0)}%`,subtext:"AI text kept as-is",positive:t.ai_analysis.ai_acceptance_rate>=80}),i.jsx(jc,{label:"Compliance",value:`${t.headline.compliance_rate.toFixed(0)}%`,subtext:t.defensibility_analysis.zero_incidents?"Zero incidents":"",positive:t.headline.compliance_rate>=100})]}),i.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-6",children:[i.jsxs("div",{className:"bg-slate-700/50 rounded-lg p-4",children:[i.jsxs("div",{className:"flex items-center justify-between mb-3",children:[i.jsxs("div",{children:[i.jsx("div",{className:"text-sm text-slate-400",children:"Time per Note"}),i.jsxs("div",{className:"text-xl font-bold",children:[t.time_analysis.avg_note_minutes.toFixed(1)," min"]})]}),i.jsx(gp,{data:h,color:h.length>1&&h[h.length-1]<h[0]?"#22c55e":"#f59e0b"})]}),i.jsx("div",{className:"text-xs text-slate-500",children:h.length>1&&i.jsx(i.Fragment,{children:h[h.length-1]<h[0]?`↓ ${((1-h[h.length-1]/h[0])*100).toFixed(0)}% improvement`:`↑ ${((h[h.length-1]/h[0]-1)*100).toFixed(0)}% increase`})})]}),i.jsxs("div",{className:"bg-slate-700/50 rounded-lg p-4",children:[i.jsxs("div",{className:"flex items-center justify-between mb-3",children:[i.jsxs("div",{children:[i.jsx("div",{className:"text-sm text-slate-400",children:"Daily Volume"}),i.jsxs("div",{className:"text-xl font-bold",children:[c==null?void 0:c.notes_per_day.toFixed(1)," notes/day"]})]}),i.jsx(gp,{data:u,color:"#3b82f6"})]}),i.jsx("div",{className:"text-xs text-slate-500",children:u.length>1&&u[u.length-1]>0&&i.jsxs(i.Fragment,{children:["Total: ",t.headline.notes_completed," notes"]})})]})]}),i.jsxs("div",{className:"mb-6",children:[i.jsx("h4",{className:"text-sm font-medium text-slate-400 mb-3",children:"Time Analysis"}),i.jsxs("div",{className:"bg-slate-700/50 rounded-lg p-4",children:[i.jsxs("div",{className:"flex items-center justify-between mb-2",children:[i.jsx("span",{className:"text-sm",children:"Average note time"}),i.jsxs("span",{className:"font-medium",children:[t.time_analysis.avg_note_minutes.toFixed(1)," min"]})]}),i.jsxs("div",{className:"flex items-center justify-between mb-2",children:[i.jsx("span",{className:"text-sm text-slate-400",children:"Industry baseline"}),i.jsxs("span",{className:"text-slate-400",children:[t.time_analysis.baseline_minutes.toFixed(0)," min"]})]}),i.jsx("div",{className:"h-2 bg-slate-600 rounded-full overflow-hidden mb-2",children:i.jsx("div",{className:"h-full bg-green-500 transition-all",style:{width:`${Math.min(100,t.time_analysis.avg_note_minutes/t.time_analysis.baseline_minutes*100)}%`}})}),i.jsxs("div",{className:"text-xs text-green-400 text-right",children:[t.time_analysis.time_saved_per_note_minutes.toFixed(1)," min saved per note"]})]})]}),i.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-6",children:[i.jsxs("div",{className:"bg-slate-700/50 rounded-lg p-4",children:[i.jsx("div",{className:"text-sm text-slate-400 mb-2",children:"AI Assist Rate"}),i.jsxs("div",{className:"text-2xl font-bold",children:[t.ai_analysis.ai_assist_rate.toFixed(0),"%"]}),i.jsx("div",{className:"h-1 bg-slate-600 rounded-full mt-2 overflow-hidden",children:i.jsx("div",{className:"h-full bg-purple-500",style:{width:`${t.ai_analysis.ai_assist_rate}%`}})}),i.jsx("div",{className:"text-xs text-slate-500 mt-1",children:"of notes use AI structuring"})]}),i.jsxs("div",{className:"bg-slate-700/50 rounded-lg p-4",children:[i.jsx("div",{className:"text-sm text-slate-400 mb-2",children:"Voice Capture"}),i.jsxs("div",{className:"text-2xl font-bold",children:[t.ai_analysis.voice_capture_rate.toFixed(0),"%"]}),i.jsx("div",{className:"h-1 bg-slate-600 rounded-full mt-2 overflow-hidden",children:i.jsx("div",{className:"h-full bg-blue-500",style:{width:`${t.ai_analysis.voice_capture_rate}%`}})}),i.jsx("div",{className:"text-xs text-slate-500 mt-1",children:"of notes use voice scribe"})]})]}),i.jsxs("div",{children:[i.jsx("h4",{className:"text-sm font-medium text-slate-400 mb-3",children:"Defensibility Score"}),i.jsx("div",{className:"bg-slate-700/50 rounded-lg p-4",children:i.jsxs("div",{className:"flex items-center gap-4",children:[i.jsx("div",{className:`w-16 h-16 rounded-full flex items-center justify-center text-2xl font-bold ${t.defensibility_analysis.zero_incidents?"bg-green-500/20 text-green-400":"bg-yellow-500/20 text-yellow-400"}`,children:t.defensibility_analysis.zero_incidents?"Zero incidents":"Attention"}),i.jsxs("div",{className:"flex-1",children:[i.jsx("div",{className:"font-medium",children:t.defensibility_analysis.zero_incidents?"Excellent - All critical items addressed":"Review needed - Some items unresolved"}),i.jsxs("div",{className:"text-sm text-slate-400",children:[t.defensibility_analysis.detections_per_note.toFixed(1)," detections/note •",t.defensibility_analysis.attestation_compliance.toFixed(0),"% attested"]}),i.jsx("div",{className:"flex gap-2 mt-2",children:i.jsxs("div",{className:"text-xs bg-slate-600 px-2 py-1 rounded",children:[t.defensibility_analysis.critical_addressed.toFixed(0),"% critical resolved"]})})]})]})})]})]}),!t&&!o&&i.jsxs("div",{className:"text-center py-8 text-slate-400",children:[i.jsx(wn,{className:"w-12 h-12 mx-auto mb-3 opacity-50"}),i.jsx("p",{children:"No metrics data yet. Complete some notes to see your stats!"})]})]})}function Nc({label:c,value:e}){return e?i.jsxs("div",{children:[i.jsx("div",{className:"text-xs text-slate-400 mb-1",children:c}),i.jsx("div",{className:"text-sm text-slate-300",children:e})]}):null}function jc({label:c,value:e,subtext:t,positive:s}){return i.jsxs("div",{className:"bg-slate-700/50 rounded-lg p-4",children:[i.jsx("div",{className:"text-xs text-slate-400 mb-1",children:c}),i.jsx("div",{className:`text-2xl font-bold ${s?"text-green-400":""}`,children:e}),t&&i.jsx("div",{className:"text-xs text-slate-500 mt-1",children:t})]})}function pv({clientId:c}){const[e,t]=T.useState(null),[s,n]=T.useState(!1),[a,o]=T.useState(!1),[l,d]=T.useState(null);async function h(){n(!0),d(null);try{const m=await sx(c);t(m)}catch(m){console.error("Failed to generate prep sheet:",m),d(String(m))}finally{n(!1)}}T.useEffect(()=>{a&&!e&&h()},[a]);const u={high:"bg-red-500/20 text-red-400 border-red-500/50",moderate:"bg-amber-500/20 text-amber-400 border-amber-500/50",low:"bg-blue-500/20 text-blue-400 border-blue-500/50"},p={improving:"Improving",stable:"Stable",worsening:"Worsening",resolved:"Resolved"};return i.jsxs("div",{className:"bg-slate-800 rounded-xl overflow-hidden",children:[i.jsxs("button",{onClick:()=>o(!a),className:"w-full flex items-center justify-between p-4 hover:bg-slate-700/50 transition-colors",children:[i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx(Rd,{className:"w-5 h-5 text-emerald-400"}),i.jsx("span",{className:"font-medium",children:"Pre-Session Prep Sheet"}),i.jsx("span",{className:"text-xs bg-emerald-500/20 text-emerald-400 px-2 py-0.5 rounded-full",children:"Session Prep"})]}),i.jsx(Ct,{className:`w-5 h-5 text-slate-400 transition-transform ${a?"rotate-90":""}`})]}),a&&i.jsx("div",{className:"border-t border-slate-700 p-4",children:s?i.jsxs("div",{className:"flex items-center justify-center py-8",children:[i.jsx(Ne,{className:"w-6 h-6 text-emerald-500 animate-spin"}),i.jsx("span",{className:"ml-2 text-slate-400",children:"Generating prep sheet..."})]}):l?i.jsxs("div",{className:"text-red-400 text-center py-4",children:[l,i.jsx("button",{onClick:h,className:"ml-2 text-blue-400 underline",children:"Retry"})]}):e?i.jsxs("div",{className:"space-y-6",children:[i.jsxs("div",{className:"flex items-center justify-between",children:[i.jsxs("div",{children:[i.jsx("h3",{className:"text-lg font-semibold",children:e.client_name}),i.jsxs("p",{className:"text-xs text-slate-400",children:["Generated: ",e.generated_at]})]}),i.jsx("button",{onClick:h,className:"text-xs bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded",children:"Refresh"})]}),i.jsxs("div",{className:"bg-slate-700/30 rounded-lg p-4",children:[i.jsxs("h4",{className:"text-sm font-medium mb-3 flex items-center gap-2",children:[i.jsx(hc,{className:"w-4 h-4"})," Client Overview"]}),i.jsxs("div",{className:"grid grid-cols-3 gap-4 text-sm",children:[e.demographics.age&&i.jsxs("div",{children:[i.jsx("span",{className:"text-slate-400",children:"Age:"})," ",e.demographics.age]}),i.jsxs("div",{children:[i.jsx("span",{className:"text-slate-400",children:"Sessions:"})," ",e.demographics.total_sessions]}),e.demographics.treatment_duration_days&&i.jsxs("div",{children:[i.jsx("span",{className:"text-slate-400",children:"In Treatment:"})," ",Math.round(e.demographics.treatment_duration_days/30)," months"]}),e.demographics.days_since_last_session&&i.jsxs("div",{children:[i.jsx("span",{className:"text-slate-400",children:"Last Session:"})," ",e.demographics.days_since_last_session," days ago"]}),e.demographics.diagnosis_codes&&i.jsxs("div",{className:"col-span-2",children:[i.jsx("span",{className:"text-slate-400",children:"Dx:"})," ",e.demographics.diagnosis_codes]})]})]}),e.safety_alerts.length>0&&i.jsxs("div",{className:"bg-red-500/10 border border-red-500/30 rounded-lg p-4",children:[i.jsxs("h4",{className:"text-sm font-medium mb-3 flex items-center gap-2 text-red-400",children:[i.jsx(Es,{className:"w-4 h-4"})," Safety Alerts"]}),i.jsx("div",{className:"space-y-2",children:e.safety_alerts.map((m,f)=>i.jsxs("div",{className:`rounded-lg p-3 border ${u[m.severity]}`,children:[i.jsx("div",{className:"font-medium capitalize",children:m.alert_type.replace("_"," ")}),i.jsx("div",{className:"text-xs opacity-80",children:m.details}),i.jsxs("div",{className:"text-xs opacity-60 mt-1",children:["Last flagged: ",m.last_flagged]})]},f))})]}),i.jsxs("div",{className:"bg-blue-500/10 rounded-lg p-4",children:[i.jsxs("h4",{className:"text-sm font-medium mb-3 flex items-center gap-2 text-blue-400",children:[i.jsx(sd,{className:"w-4 h-4"})," Session Focus Suggestions"]}),i.jsx("ul",{className:"space-y-2",children:e.focus_suggestions.map((m,f)=>i.jsxs("li",{className:"text-sm flex items-start gap-2",children:[i.jsx("span",{className:"text-blue-400",children:"•"}),m]},f))})]}),e.active_themes.length>0&&i.jsxs("div",{className:"bg-slate-700/30 rounded-lg p-4",children:[i.jsx("h4",{className:"text-sm font-medium mb-3",children:"Active Treatment Themes"}),i.jsx("div",{className:"flex flex-wrap gap-2",children:e.active_themes.map((m,f)=>i.jsxs("div",{className:"bg-slate-600/50 rounded-lg px-3 py-2 text-sm",children:[i.jsx("span",{className:"mr-2",children:p[m.trend]||"•"}),i.jsx("span",{className:"capitalize",children:m.theme.replace("_"," ")}),i.jsxs("span",{className:"text-xs text-slate-400 ml-2",children:["(",m.trend,")"]})]},f))})]}),e.recent_sessions.length>0&&i.jsxs("div",{className:"bg-slate-700/30 rounded-lg p-4",children:[i.jsx("h4",{className:"text-sm font-medium mb-3",children:"Recent Sessions"}),i.jsx("div",{className:"space-y-3",children:e.recent_sessions.map((m,f)=>i.jsxs("div",{className:"border-l-2 border-slate-600 pl-3",children:[i.jsx("div",{className:"text-sm font-medium",children:m.session_date}),m.key_points.length>0&&i.jsx("ul",{className:"text-xs text-slate-400 mt-1",children:m.key_points.map((g,b)=>i.jsxs("li",{children:["• ",g.slice(0,100),"..."]},b))}),m.mood_indicators.length>0&&i.jsx("div",{className:"flex gap-1 mt-1",children:m.mood_indicators.map((g,b)=>i.jsx("span",{className:"text-xs bg-slate-600 px-2 py-0.5 rounded capitalize",children:g},b))}),m.interventions_used.length>0&&i.jsxs("div",{className:"text-xs text-slate-500 mt-1",children:["Interventions: ",m.interventions_used.join(", ")]})]},f))})]}),e.suggested_assessments.length>0&&i.jsxs("div",{className:"bg-purple-500/10 rounded-lg p-4",children:[i.jsxs("h4",{className:"text-sm font-medium mb-3 flex items-center gap-2 text-purple-400",children:[i.jsx(_p,{className:"w-4 h-4"})," Suggested Assessments"]}),i.jsx("div",{className:"space-y-2",children:e.suggested_assessments.map((m,f)=>i.jsxs("div",{className:"flex items-center justify-between bg-slate-700/30 rounded-lg p-2",children:[i.jsxs("div",{children:[i.jsx("span",{className:"font-medium",children:m.assessment_name}),i.jsx("span",{className:"text-xs text-slate-400 ml-2",children:m.reason})]}),m.last_score&&i.jsxs("span",{className:"text-xs bg-slate-600 px-2 py-1 rounded",children:["Last: ",m.last_score]})]},f))})]})]}):i.jsx("p",{className:"text-slate-400 text-center py-4",children:"Click to generate prep sheet"})})]})}function mv({noteId:c,model:e,onComplete:t,onSuggestionApplied:s}){const[n,a]=T.useState(null),[o,l]=T.useState(!1),[d,h]=T.useState(null),[u,p]=T.useState(new Set),[m,f]=T.useState(new Set),[g,b]=T.useState(null);async function A(){l(!0),h(null),p(new Set),f(new Set);try{const _=await ix(c,e);a(_)}catch(_){console.error("Completion check failed:",_),h(String(_))}finally{l(!1)}}async function N(_,y){if(s){b(_);try{const C=await Kd(c),R=C.raw_input||C.content||"",S=R.replace(y.problematic_text,y.suggestion.replace("Suggestion: ",""));S!==R?(await Mp(c,S),p(k=>new Set(k).add(_)),s(S)):p(k=>new Set(k).add(_))}catch(C){console.error("Failed to apply suggestion:",C),alert("Failed to apply suggestion: "+String(C))}finally{b(null)}}}function j(_){f(y=>new Set(y).add(_))}const E=n?n.overall_score>=.8?"text-green-400":n.overall_score>=.6?"text-amber-400":"text-red-400":"";return i.jsxs("div",{className:"bg-slate-800 rounded-xl p-4",children:[i.jsxs("div",{className:"flex items-center justify-between mb-4",children:[i.jsxs("h4",{className:"font-medium flex items-center gap-2",children:[i.jsx(Zt,{className:"w-5 h-5 text-blue-400"}),"AI Documentation Review"]}),i.jsxs("button",{onClick:A,disabled:o,className:"bg-blue-600 hover:bg-blue-700 disabled:opacity-50 px-4 py-2 rounded-lg text-sm flex items-center gap-2",children:[o?i.jsx(Ne,{className:"w-4 h-4 animate-spin"}):i.jsx(ti,{className:"w-4 h-4"}),o?"Analyzing...":"Run Check"]})]}),d&&i.jsx("div",{className:"text-red-400 text-sm mb-4",children:d}),n&&i.jsxs("div",{className:"space-y-4",children:[i.jsxs("div",{className:"flex items-center justify-between bg-slate-700/50 rounded-lg p-4",children:[i.jsxs("div",{children:[i.jsx("div",{className:"text-sm text-slate-400",children:"Documentation Quality Score"}),i.jsxs("div",{className:`text-3xl font-bold ${E}`,children:[Math.round(n.overall_score*100),"%"]})]}),i.jsx("div",{className:`text-4xl ${n.is_complete?"text-green-400":"text-amber-400"}`,children:n.is_complete?"Complete":"Incomplete"})]}),n.missing_fields.length>0&&i.jsxs("div",{className:"bg-red-500/10 rounded-lg p-4",children:[i.jsx("h5",{className:"text-sm font-medium text-red-400 mb-2",children:"Missing Fields"}),i.jsx("ul",{className:"space-y-2",children:n.missing_fields.map((_,y)=>i.jsxs("li",{className:"text-sm flex items-start gap-2",children:[i.jsx("span",{className:`text-xs px-2 py-0.5 rounded ${_.importance==="required"?"bg-red-500/20 text-red-400":_.importance==="recommended"?"bg-amber-500/20 text-amber-400":"bg-slate-600 text-slate-400"}`,children:_.importance}),i.jsxs("div",{children:[i.jsx("span",{className:"font-medium",children:_.field_name}),i.jsx("span",{className:"text-slate-400 ml-2",children:_.description})]})]},y))})]}),n.vague_sections.length>0&&i.jsxs("div",{className:"bg-amber-500/10 rounded-lg p-4",children:[i.jsxs("h5",{className:"text-sm font-medium text-amber-400 mb-3 flex items-center gap-2",children:[i.jsx(yp,{className:"w-4 h-4"}),"Suggested Improvements"]}),i.jsx("ul",{className:"space-y-4",children:n.vague_sections.map((_,y)=>{const C=u.has(y),R=m.has(y),S=g===y;return R?null:i.jsxs("li",{className:`text-sm bg-slate-800/50 rounded-lg p-3 ${C?"opacity-60":""}`,children:[i.jsx("div",{className:"font-medium text-amber-300 mb-2",children:_.section}),i.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3 mb-3",children:[i.jsxs("div",{className:"bg-red-500/5 border border-red-500/20 rounded p-2",children:[i.jsx("div",{className:"text-xs text-red-400 mb-1",children:"Current:"}),i.jsxs("div",{className:"text-xs text-slate-300 italic line-through",children:['"',_.problematic_text,'"']})]}),i.jsxs("div",{className:"bg-green-500/5 border border-green-500/20 rounded p-2",children:[i.jsx("div",{className:"text-xs text-green-400 mb-1",children:"Suggested:"}),i.jsxs("div",{className:"text-xs text-slate-300",children:['"',_.suggestion.replace("Suggestion: ",""),'"']})]})]}),!C&&i.jsxs("div",{className:"flex gap-2 justify-end",children:[i.jsxs("button",{onClick:()=>j(y),className:"text-xs px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded flex items-center gap-1",children:[i.jsx(Io,{className:"w-3 h-3"}),"Dismiss"]}),s&&i.jsxs("button",{onClick:()=>N(y,_),disabled:S,className:"text-xs px-3 py-1.5 bg-green-600 hover:bg-green-700 disabled:opacity-50 rounded flex items-center gap-1",children:[S?i.jsx(Ne,{className:"w-3 h-3 animate-spin"}):i.jsx(Zt,{className:"w-3 h-3"}),"Apply"]})]}),C&&i.jsxs("div",{className:"text-xs text-green-400 flex items-center gap-1 justify-end",children:[i.jsx(Zt,{className:"w-3 h-3"}),"Applied"]})]},y)})})]}),n.compliance_issues.length>0&&i.jsxs("div",{className:"bg-orange-500/10 rounded-lg p-4",children:[i.jsx("h5",{className:"text-sm font-medium text-orange-400 mb-2",children:"Compliance Issues"}),i.jsx("ul",{className:"space-y-2",children:n.compliance_issues.map((_,y)=>i.jsxs("li",{className:"text-sm flex items-start gap-2",children:[i.jsx("span",{className:`text-xs px-2 py-0.5 rounded ${_.severity==="error"?"bg-red-500/20 text-red-400":"bg-amber-500/20 text-amber-400"}`,children:_.severity}),i.jsx("span",{children:_.description})]},y))})]}),n.suggestions.length>0&&i.jsxs("div",{className:"bg-blue-500/10 rounded-lg p-4",children:[i.jsx("h5",{className:"text-sm font-medium text-blue-400 mb-2",children:"Suggestions"}),i.jsx("ul",{className:"space-y-1",children:n.suggestions.map((_,y)=>i.jsxs("li",{className:"text-sm flex items-start gap-2",children:[i.jsx("span",{className:"text-blue-400",children:"Tip"}),_]},y))})]}),n.is_complete&&i.jsxs("div",{className:"bg-green-500/10 rounded-lg p-4 text-center",children:[i.jsx(Zt,{className:"w-8 h-8 text-green-400 mx-auto mb-2"}),i.jsx("div",{className:"text-green-400 font-medium",children:"Note is ready for signing"})]})]})]})}function fv({noteId:c,clientName:e}){const[t,s]=T.useState(null),[n,a]=T.useState(!0),[o,l]=T.useState(null);async function d(h){s(h),l(null);try{const u=await nx(c,h,n),m=`${e.replace(/[^a-zA-Z0-9]/g,"_")}_note.${h}`;await Lp(u,m,{txt:"Text Files",docx:"Word Documents",pdf:"PDF Documents"}[h],h)&&(l(h.toUpperCase()),setTimeout(()=>l(null),3e3))}catch(u){console.error("Export failed:",u),alert("Export failed: "+String(u))}finally{s(null)}}return i.jsxs("div",{className:"bg-slate-700/30 rounded-lg p-4",children:[i.jsxs("h4",{className:"text-sm font-medium mb-3 flex items-center gap-2",children:[i.jsx(oo,{className:"w-4 h-4"})," Export Note"]}),i.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[i.jsx("input",{type:"checkbox",id:"includeHeader",checked:n,onChange:h=>a(h.target.checked),className:"rounded"}),i.jsx("label",{htmlFor:"includeHeader",className:"text-sm text-slate-400",children:"Include header info"})]}),o&&i.jsxs("div",{className:"mb-3 bg-green-500/20 text-green-400 px-3 py-2 rounded text-sm flex items-center gap-2",children:[i.jsx(Zt,{className:"w-4 h-4"}),o," exported successfully!"]}),i.jsxs("div",{className:"flex gap-2",children:[i.jsxs("button",{onClick:()=>d("txt"),disabled:t!==null,className:"flex-1 bg-slate-600 hover:bg-slate-500 disabled:opacity-50 px-3 py-2 rounded text-sm flex items-center justify-center gap-2",children:[t==="txt"?i.jsx(Ne,{className:"w-4 h-4 animate-spin"}):i.jsx(Dt,{className:"w-4 h-4"}),"TXT"]}),i.jsxs("button",{onClick:()=>d("docx"),disabled:t!==null,className:"flex-1 bg-blue-600 hover:bg-blue-700 disabled:opacity-50 px-3 py-2 rounded text-sm flex items-center justify-center gap-2",children:[t==="docx"?i.jsx(Ne,{className:"w-4 h-4 animate-spin"}):i.jsx(Dt,{className:"w-4 h-4"}),"DOCX"]}),i.jsxs("button",{onClick:()=>d("pdf"),disabled:t!==null,className:"flex-1 bg-red-600 hover:bg-red-700 disabled:opacity-50 px-3 py-2 rounded text-sm flex items-center justify-center gap-2",children:[t==="pdf"?i.jsx(Ne,{className:"w-4 h-4 animate-spin"}):i.jsx(Dt,{className:"w-4 h-4"}),"PDF"]})]})]})}function gv({supervisorId:c}){const[e,t]=T.useState(null),[s,n]=T.useState(!1),[a,o]=T.useState(!1),[l,d]=T.useState(!1),[h,u]=T.useState(""),[p,m]=T.useState(""),[f,g]=T.useState(null);async function b(){n(!0);try{const N=await rx(c);t(N)}catch(N){console.error("Failed to load supervisor dashboard:",N)}finally{n(!1)}}T.useEffect(()=>{a&&!e&&b()},[a]);async function A(){if(h.trim())try{await ax(h,p||null,c),u(""),m(""),d(!1),b()}catch(N){console.error("Failed to add trainee:",N),alert("Failed to add trainee: "+String(N))}}return i.jsxs("div",{className:"bg-slate-800 rounded-xl overflow-hidden",children:[i.jsxs("button",{onClick:()=>o(!a),className:"w-full flex items-center justify-between p-4 hover:bg-slate-700/50 transition-colors",children:[i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx(Do,{className:"w-5 h-5 text-purple-400"}),i.jsx("span",{className:"font-medium",children:"Supervisor Mode"}),e&&e.pending_reviews.length>0&&i.jsxs("span",{className:"text-xs bg-amber-500/20 text-amber-400 px-2 py-0.5 rounded-full",children:[e.pending_reviews.length," pending"]})]}),i.jsx(Ct,{className:`w-5 h-5 text-slate-400 transition-transform ${a?"rotate-90":""}`})]}),a&&i.jsx("div",{className:"border-t border-slate-700 p-4",children:s?i.jsx("div",{className:"flex items-center justify-center py-8",children:i.jsx(Ne,{className:"w-6 h-6 text-purple-500 animate-spin"})}):e?i.jsxs("div",{className:"space-y-6",children:[i.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[i.jsxs("div",{className:"bg-slate-700/50 rounded-lg p-3 text-center",children:[i.jsx("div",{className:"text-2xl font-bold text-purple-400",children:e.trainees.length}),i.jsx("div",{className:"text-xs text-slate-400",children:"Trainees"})]}),i.jsxs("div",{className:"bg-slate-700/50 rounded-lg p-3 text-center",children:[i.jsx("div",{className:"text-2xl font-bold text-amber-400",children:e.pending_reviews.length}),i.jsx("div",{className:"text-xs text-slate-400",children:"Pending Reviews"})]}),i.jsxs("div",{className:"bg-slate-700/50 rounded-lg p-3 text-center",children:[i.jsx("div",{className:"text-2xl font-bold text-green-400",children:e.trainees.reduce((N,j)=>N+j.trainee.notes_approved,0)}),i.jsx("div",{className:"text-xs text-slate-400",children:"Approved"})]})]}),e.pending_reviews.length>0&&i.jsxs("div",{children:[i.jsxs("h4",{className:"text-sm font-medium mb-3 flex items-center gap-2",children:[i.jsx(Ja,{className:"w-4 h-4 text-amber-400"})," Pending Reviews"]}),i.jsx("div",{className:"space-y-2",children:e.pending_reviews.map(N=>i.jsxs("div",{className:"bg-slate-700/30 rounded-lg p-3 flex items-center justify-between",children:[i.jsxs("div",{children:[i.jsx("div",{className:"font-medium",children:N.client_name}),i.jsxs("div",{className:"text-xs text-slate-400",children:["By ",N.trainee_name," • ",N.session_date]})]}),i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsxs("span",{className:`text-xs px-2 py-1 rounded ${N.days_pending>3?"bg-red-500/20 text-red-400":N.days_pending>1?"bg-amber-500/20 text-amber-400":"bg-slate-600 text-slate-400"}`,children:[N.days_pending,"d ago"]}),i.jsx("button",{className:"bg-purple-600 hover:bg-purple-700 px-3 py-1 rounded text-sm",children:"Review"})]})]},N.note_id))})]}),i.jsxs("div",{children:[i.jsxs("div",{className:"flex items-center justify-between mb-3",children:[i.jsxs("h4",{className:"text-sm font-medium flex items-center gap-2",children:[i.jsx(Do,{className:"w-4 h-4"})," Trainees"]}),i.jsxs("button",{onClick:()=>d(!l),className:"text-xs bg-purple-600 hover:bg-purple-700 px-3 py-1 rounded flex items-center gap-1",children:[i.jsx(Da,{className:"w-3 h-3"})," Add Trainee"]})]}),l&&i.jsxs("div",{className:"bg-slate-700/30 rounded-lg p-3 mb-3 space-y-2",children:[i.jsx("input",{type:"text",placeholder:"Trainee name",value:h,onChange:N=>u(N.target.value),className:"w-full bg-slate-700 rounded px-3 py-2 text-sm"}),i.jsx("input",{type:"email",placeholder:"Email (optional)",value:p,onChange:N=>m(N.target.value),className:"w-full bg-slate-700 rounded px-3 py-2 text-sm"}),i.jsxs("div",{className:"flex gap-2",children:[i.jsx("button",{onClick:A,className:"flex-1 bg-purple-600 hover:bg-purple-700 py-2 rounded text-sm",children:"Add"}),i.jsx("button",{onClick:()=>d(!1),className:"flex-1 bg-slate-600 hover:bg-slate-500 py-2 rounded text-sm",children:"Cancel"})]})]}),i.jsxs("div",{className:"space-y-2",children:[e.trainees.map(N=>i.jsxs("div",{className:"bg-slate-700/30 rounded-lg p-3",children:[i.jsxs("div",{className:"flex items-center justify-between",children:[i.jsxs("div",{children:[i.jsx("div",{className:"font-medium",children:N.trainee.name}),i.jsxs("div",{className:"text-xs text-slate-400",children:["Started ",N.trainee.start_date," • ",N.trainee.status]})]}),i.jsxs("div",{className:"text-right",children:[i.jsxs("div",{className:"text-sm",children:[i.jsx("span",{className:"text-green-400",children:N.trainee.notes_approved}),i.jsx("span",{className:"text-slate-500",children:"/"}),i.jsx("span",{className:"text-slate-400",children:N.trainee.notes_submitted})]}),i.jsx("div",{className:"text-xs text-slate-500",children:"approved/submitted"})]})]}),N.pending_notes>0&&i.jsxs("div",{className:"mt-2 flex items-center justify-between",children:[i.jsxs("span",{className:"text-xs text-amber-400",children:[N.pending_notes," notes awaiting review"]}),i.jsx("button",{onClick:async()=>{try{const j=await ux(N.trainee.id);g({trainee:N.trainee,pending_notes:N.pending_notes,recent_activity:[],pendingReviews:j})}catch(j){console.error("Failed to load reviews:",j)}},className:"text-xs bg-amber-600 hover:bg-amber-700 px-2 py-1 rounded",children:"Review Notes"})]})]},N.trainee.id)),e.trainees.length===0&&i.jsx("p",{className:"text-slate-400 text-center py-4 text-sm",children:'No trainees yet. Click "Add Trainee" to get started.'})]})]})]}):i.jsx("p",{className:"text-slate-400 text-center py-4",children:"Unable to load supervisor dashboard"})})]})}function xv({noteId:c,noteContent:e,clientName:t}){const[s,n]=T.useState(null),[a,o]=T.useState(!1),[l,d]=T.useState(!1),[h,u]=T.useState(!0),[p,m]=T.useState(!1),[f,g]=T.useState(null);async function b(){o(!0);try{const j=await ox(c,!1);n(j)}catch(j){console.error("De-identification failed:",j),alert("De-identification failed: "+String(j))}finally{o(!1)}}async function A(j){m(!0),g(null);try{const E=await lx(c,j,!0),_=`deidentified_case.${j}`;await Lp(E,_,{txt:"Text Files",docx:"Word Documents",pdf:"PDF Documents"}[j],j)&&(g(j.toUpperCase()),setTimeout(()=>g(null),3e3))}catch(E){console.error("Export failed:",E),alert("Export failed: "+String(E))}finally{m(!1)}}const N={A:"Names",B:"Geographic",C:"Dates",D:"Phone",E:"Fax",F:"Email",G:"SSN",H:"Medical Record #",I:"Health Plan #",J:"Account #",K:"License #",L:"Vehicle ID",M:"Device ID",N:"URL",O:"IP Address",P:"Biometric",Q:"Photo",R:"Other ID",AI:"AI-Detected"};return i.jsxs("div",{className:"bg-slate-800 rounded-xl overflow-hidden",children:[i.jsxs("button",{onClick:()=>d(!l),className:"w-full flex items-center justify-between p-4 hover:bg-slate-700/50 transition-colors",children:[i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx(si,{className:"w-5 h-5 text-cyan-400"}),i.jsx("span",{className:"font-medium",children:"HIPAA Safe Harbor De-identification"}),i.jsx("span",{className:"text-xs bg-cyan-500/20 text-cyan-400 px-2 py-0.5 rounded-full",children:"45 CFR 164.514(b)"})]}),i.jsx(Ct,{className:`w-5 h-5 text-slate-400 transition-transform ${l?"rotate-90":""}`})]}),l&&i.jsx("div",{className:"border-t border-slate-700 p-4",children:s?i.jsxs("div",{className:"space-y-4",children:[i.jsxs("div",{className:"flex items-center justify-between bg-slate-700/30 rounded-lg p-3",children:[i.jsxs("div",{className:"flex items-center gap-4",children:[i.jsxs("div",{children:[i.jsx("div",{className:"text-2xl font-bold text-cyan-400",children:s.identifiers_found.length}),i.jsx("div",{className:"text-xs text-slate-400",children:"Identifiers Removed"})]}),i.jsxs("div",{children:[i.jsx("div",{className:"text-lg font-medium text-green-400",children:"Compliant"}),i.jsx("div",{className:"text-xs text-slate-400",children:"Safe Harbor"})]}),i.jsxs("div",{children:[i.jsxs("div",{className:"text-lg font-medium",children:[s.processing_time_ms,"ms"]}),i.jsx("div",{className:"text-xs text-slate-400",children:"Processing"})]})]}),i.jsx("button",{onClick:b,className:"text-xs bg-slate-600 hover:bg-slate-500 px-3 py-1 rounded",children:"Re-run"})]}),i.jsxs("div",{className:"bg-slate-700/30 rounded-lg p-3",children:[i.jsx("h4",{className:"text-sm font-medium mb-2",children:"Removed by Category"}),i.jsx("div",{className:"flex flex-wrap gap-2",children:Object.entries(s.category_counts).map(([j,E])=>i.jsxs("span",{className:"text-xs bg-cyan-500/20 text-cyan-400 px-2 py-1 rounded",children:[N[j]||j,": ",E]},j))})]}),i.jsxs("div",{className:"bg-slate-700/30 rounded-lg p-3",children:[i.jsxs("div",{className:"flex items-center justify-between mb-3",children:[i.jsx("h4",{className:"text-sm font-medium",children:"Preview Comparison"}),i.jsxs("div",{className:"flex gap-2",children:[i.jsx("button",{onClick:()=>u(!0),className:`text-xs px-3 py-1 rounded ${h?"bg-cyan-600":"bg-slate-600"}`,children:"Original"}),i.jsx("button",{onClick:()=>u(!1),className:`text-xs px-3 py-1 rounded ${h?"bg-slate-600":"bg-cyan-600"}`,children:"De-identified"})]})]}),i.jsx("div",{className:"bg-slate-800 rounded p-3 max-h-60 overflow-y-auto",children:i.jsx("pre",{className:"text-sm whitespace-pre-wrap font-mono",children:h?e:s.deidentified_text})})]}),s.identifiers_found.length>0&&i.jsxs("div",{className:"bg-slate-700/30 rounded-lg p-3",children:[i.jsxs("h4",{className:"text-sm font-medium mb-2",children:["Identifiers Removed (",s.identifiers_found.length,")"]}),i.jsxs("div",{className:"max-h-40 overflow-y-auto space-y-1",children:[s.identifiers_found.slice(0,20).map((j,E)=>i.jsxs("div",{className:"flex items-center justify-between text-xs bg-slate-800 rounded p-2",children:[i.jsx("span",{className:"text-slate-400",children:N[j.category]||j.category}),i.jsx("span",{className:"text-red-400 line-through",children:j.original_text.slice(0,30)}),i.jsx("span",{className:"text-green-400",children:j.replacement}),i.jsxs("span",{className:"text-slate-500",children:[Math.round(j.confidence*100),"%"]})]},E)),s.identifiers_found.length>20&&i.jsxs("div",{className:"text-xs text-slate-500 text-center py-1",children:["+",s.identifiers_found.length-20," more..."]})]})]}),i.jsxs("div",{className:"bg-cyan-500/10 rounded-lg p-4",children:[i.jsxs("h4",{className:"text-sm font-medium mb-3 flex items-center gap-2 text-cyan-400",children:[i.jsx(oo,{className:"w-4 h-4"})," Export De-identified Case"]}),i.jsx("p",{className:"text-xs text-slate-400 mb-3",children:"Includes de-identification certificate with hash verification for audit trail."}),f&&i.jsxs("div",{className:"mb-3 bg-green-500/20 text-green-400 px-3 py-2 rounded text-sm flex items-center gap-2",children:[i.jsx(Zt,{className:"w-4 h-4"}),f," exported successfully!"]}),i.jsxs("div",{className:"flex gap-2",children:[i.jsx("button",{onClick:()=>A("txt"),disabled:p,className:"flex-1 bg-slate-600 hover:bg-slate-500 disabled:opacity-50 px-3 py-2 rounded text-sm",children:p?"Saving...":"TXT"}),i.jsx("button",{onClick:()=>A("docx"),disabled:p,className:"flex-1 bg-blue-600 hover:bg-blue-700 disabled:opacity-50 px-3 py-2 rounded text-sm",children:p?"Saving...":"DOCX"}),i.jsx("button",{onClick:()=>A("pdf"),disabled:p,className:"flex-1 bg-red-600 hover:bg-red-700 disabled:opacity-50 px-3 py-2 rounded text-sm",children:p?"Saving...":"PDF"})]})]}),i.jsxs("div",{className:"bg-slate-700/30 rounded-lg p-3",children:[i.jsx("h4",{className:"text-sm font-medium mb-2",children:"Audit Trail"}),i.jsxs("div",{className:"grid grid-cols-2 gap-2 text-xs",children:[i.jsxs("div",{children:[i.jsx("span",{className:"text-slate-400",children:"Original Hash:"}),i.jsxs("span",{className:"ml-2 font-mono",children:[s.original_hash.slice(0,12),"..."]})]}),i.jsxs("div",{children:[i.jsx("span",{className:"text-slate-400",children:"De-identified Hash:"}),i.jsxs("span",{className:"ml-2 font-mono",children:[s.deidentified_hash.slice(0,12),"..."]})]}),i.jsxs("div",{children:[i.jsx("span",{className:"text-slate-400",children:"Timestamp:"}),i.jsx("span",{className:"ml-2",children:s.timestamp})]}),i.jsxs("div",{children:[i.jsx("span",{className:"text-slate-400",children:"Method:"}),i.jsx("span",{className:"ml-2",children:"HIPAA Safe Harbor"})]})]})]})]}):i.jsxs("div",{className:"text-center py-6",children:[i.jsx(si,{className:"w-12 h-12 text-cyan-400 mx-auto mb-4"}),i.jsx("h3",{className:"text-lg font-medium mb-2",children:"De-identify for Consultation"}),i.jsx("p",{className:"text-sm text-slate-400 mb-4 max-w-md mx-auto",children:"Remove all 18 HIPAA Safe Harbor identifiers to enable peer consultation and case presentations without transmitting PHI."}),i.jsxs("button",{onClick:b,disabled:a,className:"bg-cyan-600 hover:bg-cyan-700 disabled:opacity-50 px-6 py-3 rounded-lg font-medium flex items-center gap-2 mx-auto",children:[a?i.jsx(Ne,{className:"w-5 h-5 animate-spin"}):i.jsx(si,{className:"w-5 h-5"}),a?"Processing...":"De-identify Note"]})]})})]})}function Hf({noteId:c,noteContent:e}){const[t,s]=T.useState([]),[n,a]=T.useState(!1),[o,l]=T.useState(!1),[d,h]=T.useState(!1),[u,p]=T.useState(!1),[m,f]=T.useState(""),[g,b]=T.useState(""),[A,N]=T.useState([]),[j,E]=T.useState("routine"),_=["Anxiety Disorders","Mood Disorders","Trauma/PTSD","Personality Disorders","Substance Use","Eating Disorders","Child/Adolescent","Geriatric","Neurodevelopmental","Psychosis","OCD","General Psychiatry"];async function y(){a(!0);try{const k=await dx();s(k)}catch(k){console.error("Failed to load drafts:",k)}finally{a(!1)}}T.useEffect(()=>{o&&y()},[o]);async function C(){if(!m.trim()||!g.trim()){alert("Please provide a title and clinical question");return}p(!0);try{await cx(c,m,g,A,j),h(!1),f(""),b(""),N([]),E("routine"),y()}catch(k){console.error("Failed to create draft:",k),alert("Failed to create draft: "+String(k))}finally{p(!1)}}async function R(k){if(confirm("Delete this consultation draft?"))try{await hx(k),y()}catch(M){console.error("Failed to delete draft:",M)}}const S={routine:"bg-slate-600",soon:"bg-amber-600",urgent:"bg-red-600"};return i.jsxs("div",{className:"bg-slate-800 rounded-xl overflow-hidden",children:[i.jsxs("button",{onClick:()=>l(!o),className:"w-full flex items-center justify-between p-4 hover:bg-slate-700/50 transition-colors",children:[i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx(Lo,{className:"w-5 h-5 text-violet-400"}),i.jsx("span",{className:"font-medium",children:"Consultation Draft Queue"}),t.length>0&&i.jsxs("span",{className:"text-xs bg-violet-500/20 text-violet-400 px-2 py-0.5 rounded-full",children:[t.length," drafts"]})]}),i.jsx(Ct,{className:`w-5 h-5 text-slate-400 transition-transform ${o?"rotate-90":""}`})]}),o&&i.jsxs("div",{className:"border-t border-slate-700 p-4",children:[i.jsxs("div",{className:"bg-amber-500/10 border border-amber-500/30 rounded-lg p-3 mb-4",children:[i.jsxs("div",{className:"flex items-center justify-between",children:[i.jsxs("div",{className:"flex items-center gap-2 text-amber-400 text-sm",children:[i.jsx(Es,{className:"w-4 h-4"}),i.jsx("span",{className:"font-medium",children:"Network Mode: OFF"})]}),i.jsx("button",{onClick:()=>alert("Network sharing is coming in v4.3.0. Currently, all drafts are stored locally on your device for maximum privacy."),className:"text-xs bg-slate-600 hover:bg-slate-500 px-3 py-1.5 rounded",children:"Enable"})]}),i.jsx("p",{className:"text-xs text-slate-400 mt-1",children:"Drafts are stored locally. Network mode will enable secure peer-to-peer case sharing."})]}),d?i.jsxs("div",{className:"bg-slate-700/30 rounded-lg p-4 mb-4 space-y-3",children:[i.jsx("h4",{className:"font-medium",children:"New Consultation Request"}),i.jsxs("div",{children:[i.jsx("label",{className:"block text-xs text-slate-400 mb-1",children:"Title"}),i.jsx("input",{type:"text",value:m,onChange:k=>f(k.target.value),placeholder:"Brief case title...",className:"w-full bg-slate-700 rounded px-3 py-2 text-sm"})]}),i.jsxs("div",{children:[i.jsx("label",{className:"block text-xs text-slate-400 mb-1",children:"Clinical Question"}),i.jsx("textarea",{value:g,onChange:k=>b(k.target.value),placeholder:"What specific guidance are you seeking?",className:"w-full bg-slate-700 rounded px-3 py-2 text-sm min-h-[80px]"})]}),i.jsxs("div",{children:[i.jsx("label",{className:"block text-xs text-slate-400 mb-1",children:"Specialties (select relevant)"}),i.jsx("div",{className:"flex flex-wrap gap-2",children:_.map(k=>i.jsx("button",{onClick:()=>N(M=>M.includes(k)?M.filter(L=>L!==k):[...M,k]),className:`text-xs px-2 py-1 rounded ${A.includes(k)?"bg-violet-600":"bg-slate-600"}`,children:k},k))})]}),i.jsxs("div",{children:[i.jsx("label",{className:"block text-xs text-slate-400 mb-1",children:"Urgency"}),i.jsx("div",{className:"flex gap-2",children:["routine","soon","urgent"].map(k=>i.jsx("button",{onClick:()=>E(k),className:`flex-1 text-sm py-2 rounded capitalize ${j===k?S[k]:"bg-slate-600"}`,children:k},k))})]}),i.jsxs("div",{className:"flex gap-2 pt-2",children:[i.jsx("button",{onClick:C,disabled:u,className:"flex-1 bg-violet-600 hover:bg-violet-700 disabled:opacity-50 py-2 rounded font-medium",children:u?"Creating...":"Create Draft"}),i.jsx("button",{onClick:()=>h(!1),className:"flex-1 bg-slate-600 hover:bg-slate-500 py-2 rounded",children:"Cancel"})]})]}):i.jsxs("button",{onClick:()=>h(!0),className:"w-full bg-violet-600 hover:bg-violet-700 py-3 rounded-lg font-medium flex items-center justify-center gap-2 mb-4",children:[i.jsx(Da,{className:"w-5 h-5"}),"Create Consultation Draft"]}),n?i.jsx("div",{className:"flex items-center justify-center py-8",children:i.jsx(Ne,{className:"w-6 h-6 text-violet-500 animate-spin"})}):t.length>0?i.jsxs("div",{className:"space-y-2",children:[i.jsx("h4",{className:"text-sm font-medium text-slate-400",children:"Your Drafts"}),t.map(k=>i.jsx("div",{className:"bg-slate-700/30 rounded-lg p-3",children:i.jsxs("div",{className:"flex items-start justify-between",children:[i.jsxs("div",{className:"flex-1",children:[i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx("span",{className:"font-medium",children:k.title}),i.jsx("span",{className:`text-xs px-2 py-0.5 rounded ${S[k.urgency]}`,children:k.urgency}),i.jsx("span",{className:"text-xs bg-slate-600 px-2 py-0.5 rounded",children:k.status})]}),i.jsx("p",{className:"text-xs text-slate-400 mt-1 line-clamp-2",children:k.clinical_question}),i.jsxs("div",{className:"flex gap-1 mt-2",children:[k.specialties.slice(0,3).map(M=>i.jsx("span",{className:"text-xs bg-violet-500/20 text-violet-400 px-2 py-0.5 rounded",children:M},M)),k.specialties.length>3&&i.jsxs("span",{className:"text-xs text-slate-500",children:["+",k.specialties.length-3]})]})]}),i.jsx("button",{onClick:()=>R(k.id),className:"text-red-400 hover:text-red-300 p-1",children:i.jsx(Np,{className:"w-4 h-4"})})]})},k.id))]}):i.jsx("p",{className:"text-slate-400 text-center py-4 text-sm",children:"No consultation drafts yet. Create one to prepare for peer consultation."})]})]})}Jf.createRoot(document.getElementById("root")).render(i.jsx(zi.StrictMode,{children:i.jsx(Bb,{})}));

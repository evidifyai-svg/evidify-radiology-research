# Evidify Security Scanning Workflow
#
# Runs automated security scans:
# - Rust dependency audit (cargo audit)
# - Node.js dependency audit (npm audit)
# - Static analysis (clippy, eslint)
# - SBOM generation
#
# Triggers:
# - Every push to main
# - Every pull request
# - Daily scheduled scan
# - Manual trigger

name: Security Scan

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC
  workflow_dispatch:  # Manual trigger

env:
  CARGO_TERM_COLOR: always

jobs:
  # ============================================
  # Rust Security Audit
  # ============================================
  rust-audit:
    name: Rust Dependency Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-action@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run cargo audit
        working-directory: src-tauri
        run: |
          cargo audit --json > audit-report.json || true
          cargo audit 2>&1 | tee audit-output.txt
          
          # Check for critical/high vulnerabilities
          if grep -q "RUSTSEC-" audit-output.txt; then
            echo "::warning::Security vulnerabilities detected in Rust dependencies"
          fi

      - name: Upload audit report
        uses: actions/upload-artifact@v4
        with:
          name: rust-audit-report
          path: src-tauri/audit-report.json
          retention-days: 30

      - name: Check for critical vulnerabilities
        working-directory: src-tauri
        run: |
          CRITICAL=$(jq '[.vulnerabilities.list[] | select(.severity == "critical")] | length' audit-report.json 2>/dev/null || echo "0")
          if [ "$CRITICAL" -gt 0 ]; then
            echo "::error::$CRITICAL critical vulnerabilities found!"
            exit 1
          fi

  # ============================================
  # Node.js Security Audit
  # ============================================
  node-audit:
    name: Node.js Dependency Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Run npm audit
        working-directory: frontend
        run: |
          npm audit --json > audit-report.json || true
          npm audit 2>&1 | tee audit-output.txt || true

      - name: Upload audit report
        uses: actions/upload-artifact@v4
        with:
          name: node-audit-report
          path: frontend/audit-report.json
          retention-days: 30

      - name: Check for critical vulnerabilities
        working-directory: frontend
        run: |
          # npm audit returns non-zero for any vulnerabilities
          # We only fail on high/critical
          npm audit --audit-level=high || {
            echo "::error::High or critical vulnerabilities found in Node.js dependencies"
            exit 1
          }

  # ============================================
  # Static Analysis
  # ============================================
  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-action@stable
        with:
          components: clippy

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libsqlcipher-dev libssl-dev

      - name: Run Clippy
        working-directory: src-tauri
        run: |
          cargo clippy --all-targets --all-features -- -D warnings 2>&1 | tee clippy-output.txt || {
            echo "::warning::Clippy warnings detected"
          }

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Run ESLint
        working-directory: frontend
        run: |
          npx eslint src --format json --output-file eslint-report.json || true
          npx eslint src || echo "::warning::ESLint issues detected"

      - name: Upload analysis reports
        uses: actions/upload-artifact@v4
        with:
          name: static-analysis-reports
          path: |
            src-tauri/clippy-output.txt
            frontend/eslint-report.json
          retention-days: 30

  # ============================================
  # SBOM Generation
  # ============================================
  sbom:
    name: Generate SBOM
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-action@stable

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install SBOM tools
        run: |
          cargo install cargo-sbom || true
          npm install -g @cyclonedx/cyclonedx-npm || true

      - name: Generate SBOM
        run: |
          mkdir -p sbom
          
          # Rust SBOM
          cd src-tauri
          cargo metadata --format-version=1 | jq '{
            bomFormat: "CycloneDX",
            specVersion: "1.4",
            components: [.packages[] | {
              type: "library",
              name: .name,
              version: .version,
              purl: "pkg:cargo/\(.name)@\(.version)"
            }]
          }' > ../sbom/sbom-rust.json
          cd ..
          
          # Node SBOM
          cd frontend
          npx @cyclonedx/cyclonedx-npm --output-format json --output-file ../sbom/sbom-node.json || true
          cd ..
          
          # Merge SBOMs
          VERSION=$(grep '^version' src-tauri/Cargo.toml | head -1 | cut -d'"' -f2)
          jq -s '{
            bomFormat: "CycloneDX",
            specVersion: "1.4",
            version: 1,
            metadata: {
              timestamp: (now | strftime("%Y-%m-%dT%H:%M:%SZ")),
              component: {
                type: "application",
                name: "Evidify",
                version: $version
              }
            },
            components: [.[].components[]?] | unique_by(.name)
          }' --arg version "$VERSION" sbom/sbom-rust.json sbom/sbom-node.json > sbom/evidify-sbom.json

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom/evidify-sbom.json
          retention-days: 90

  # ============================================
  # License Compliance
  # ============================================
  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-action@stable

      - name: Install cargo-license
        run: cargo install cargo-license

      - name: Check Rust licenses
        working-directory: src-tauri
        run: |
          cargo license --json > licenses.json
          
          # Check for problematic licenses
          COPYLEFT=$(jq -r '.[] | select(.license | test("GPL|AGPL|SSPL"; "i")) | .name' licenses.json || true)
          
          if [ -n "$COPYLEFT" ]; then
            echo "::warning::Copyleft licenses detected:"
            echo "$COPYLEFT"
          fi

      - name: Check Node.js licenses
        working-directory: frontend
        run: |
          npx license-checker --json > licenses.json || true
          
          # Check for problematic licenses
          COPYLEFT=$(jq -r 'to_entries[] | select(.value.licenses | test("GPL|AGPL|SSPL"; "i")) | .key' licenses.json 2>/dev/null || true)
          
          if [ -n "$COPYLEFT" ]; then
            echo "::warning::Copyleft licenses detected:"
            echo "$COPYLEFT"
          fi

  # ============================================
  # Security Summary
  # ============================================
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [rust-audit, node-audit, static-analysis]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Rust Audit | ${{ needs.rust-audit.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Node Audit | ${{ needs.node-audit.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Static Analysis | ${{ needs.static-analysis.result == 'success' && '✅ Passed' || '⚠️ Warnings' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Scan completed at $(date -u +"%Y-%m-%d %H:%M:%S UTC")_" >> $GITHUB_STEP_SUMMARY
